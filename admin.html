<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
            --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
            --success: #28a745; --danger: #e74c3c; --info: #17a2b8;
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
            --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease; margin: 0; line-height: 1.6;
        }
        .container { max-width: 900px; padding: 20px; }
        header { text-align: center; margin-bottom: 20px; }
        .section {
            background: var(--card); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow); margin-bottom: 20px;
        }
        h1, h2, h4 { color: var(--primary); }
        .nav-tabs .nav-link.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .nav-tabs .nav-link { color: var(--text); }
        .form-control, .btn, .form-select, textarea { border-radius: 8px; background-color: var(--bg); color: var(--text); border: 1px solid var(--border); }
        textarea:focus, .form-control:focus { background-color: var(--card); }
        .btn-primary { background-color: var(--primary); border-color: var(--primary); }
        .btn-success { background-color: var(--success); border-color: var(--success); }
        .btn-danger { background-color: var(--danger); border-color: var(--danger); }
        .btn-info { background-color: var(--info); border-color: var(--info); } /* Added for info toasts */

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid var(--border); text-align: left; vertical-align: middle; }
        th { background-color: var(--primary); color: white; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8em; }
        .status-pending, .status-menunggu-verifikasi, .status-pending-upload { background-color: #ffc107; color: #343a40; }
        .status-disetujui, .status-selesai, .status-approved { background-color: #28a745; color: white; }
        .status-ditolak, .status-dibatalkan, .status-rejected { background-color: #dc3545; color: white; }
        .status-belum-bayar, .status-diproses { background-color: #007bff; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .logout-btn { position: absolute; top: 20px; right: 20px; }
        .table-responsive-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        /* Style for preformatted code blocks within custom features */
        pre {
            white-space: pre-wrap; /* Allows text to wrap */
            word-wrap: break-word; /* Breaks long words */
            max-width: 100%; /* Ensures it doesn't overflow its container */
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header>
            <h1 class="mb-3">Admin Dashboard</h1>
            <button id="logout-btn" class="btn btn-danger logout-btn">Logout</button>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Produk</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="active-resellers-tab" data-bs-toggle="tab" data-bs-target="#active-resellers" type="button" role="tab">Reseller Aktif</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="verification-tab" data-bs-toggle="tab" data-bs-target="#verification" type="button" role="tab">Verifikasi <span id="verification-count" class="badge bg-danger ms-1" style="display: none;"></span></button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="topup-tab" data-bs-toggle="tab" data-bs-target="#topup" type="button" role="tab">Top Up</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">Pesanan</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="testimonials-tab" data-bs-toggle="tab" data-bs-target="#testimonials" type="button" role="tab">Testimoni</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq" type="button" role="tab">FAQ</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">Pembayaran</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="promo-management-tab" data-bs-toggle="tab" data-bs-target="#promo-management" type="button" role="tab">Manajemen Promo</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="gift-claims-tab" data-bs-toggle="tab" data-bs-target="#gift-claims" type="button" role="tab">Klaim Hadiah Buyer</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="banners-tab" data-bs-toggle="tab" data-bs-target="#banners" type="button" role="tab">Banner</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="custom-code-tab" data-bs-toggle="tab" data-bs-target="#custom-code" type="button" role="tab">Kode Kustom</button></li>
            </ul>
        </header>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="products" role="tabpanel">
                <div class="section">
                    <h2>Daftar Produk</h2>
                    <div class="table-responsive-container">
                        <table id="products-table" class="table table-striped">
                            <thead><tr><th>Nama Produk</th><th>Kategori</th><th>Harga Umum</th><th>Harga Reseller</th><th>Stok</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <hr>
                    <h2>Tambah/Edit Produk</h2>
                    <form id="product-form">
                        <input type="hidden" id="productId" />
                        <div class="mb-3"><label for="nama_produk">Nama Produk</label><input type="text" id="nama_produk" class="form-control" required></div>
                        <div class="mb-3"><label for="kategori">Kategori</label><input type="text" id="kategori" class="form-control" required></div>
                        <div class="mb-3"><label for="deskripsi">Deskripsi</label><textarea id="deskripsi" class="form-control" rows="3"></textarea></div>
                        <div class="mb-3"><label for="harga_umum">Harga Umum</label><input type="number" id="harga_umum" class="form-control" required></div>
                        <div class="mb-3"><label for="harga_reseller">Harga Reseller</label><input type="number" id="harga_reseller" class="form-control" required></div>
                        <div class="mb-3"><label for="stok">Stok</label><input type="number" id="stok" class="form-control" required></div>
                        <div class="mb-3"><label for="urutan">Urutan Tampilan</label><input type="number" id="urutan" class="form-control" value="0"></div>
                        <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="promo-checkbox"><label class="form-check-label" for="promo-checkbox">Aktifkan Promo</label></div>
                        <div id="promo-options" style="display:none;">
                            <div class="mb-3"><label for="promo-jenis">Jenis Promo</label><select id="promo-jenis" class="form-select"><option value="nominal">Nominal (Rp)</option><option value="persen">Persen (%)</option></select></div>
                            <div class="mb-3"><label for="promo-nilai">Nilai Promo</label><input type="number" id="promo-nilai" class="form-control"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Simpan Produk</button>
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary w-100 mt-2" style="display:none;">Batal Edit</button>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="active-resellers" role="tabpanel">
                <div class="section">
                    <h2>Daftar Reseller Aktif</h2>
                    <div class="table-responsive-container">
                        <table id="resellers-table" class="table table-striped">
                            <thead><tr><th>Email</th><th>Saldo</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="verification" role="tabpanel">
                <div class="section">
                    <h2>Verifikasi Pendaftaran Reseller</h2>
                    <div class="table-responsive-container">
                        <table class="table table-hover">
                            <thead><tr><th>Email</th><th>Paket</th><th>Deposit</th><th>Bukti</th><th>Aksi</th></tr></thead>
                            <tbody id="verification-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="topup" role="tabpanel">
                <div class="section">
                    <h2>Konfirmasi Top Up Masuk</h2>
                    <div class="table-responsive-container">
                        <table id="topup-table" class="table table-striped">
                            <thead><tr><th>ID</th><th>Email Reseller</th><th>Nominal</th><th>Bukti</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div class="section">
                    <h2>Semua Pesanan</h2>
                    <select id="order-filter" class="form-select mb-3"><option value="all">Semua Pesanan</option><option value="umum">Pesanan Pembeli Biasa</option><option value="reseller">Pesanan Reseller</option></select>
                    <div class="table-responsive-container">
                        <table id="orders-table" class="table table-striped">
                            <thead><tr><th>ID</th><th>Produk</th><th>Pelanggan</th><th>Harga</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="orders-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="testimonials" role="tabpanel">
                <div class="section">
                    <h2>Daftar Testimoni</h2>
                    <div class="table-responsive-container">
                        <table id="testimonials-table" class="table table-striped">
                            <thead><tr><th>Nama</th><th>Pesan</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <hr>
                    <h2>Tambah/Edit Testimoni</h2>
                    <form id="testimonial-form">
                        <input type="hidden" id="testimonialId" />
                        <div class="mb-3"><label for="testimonial-nama">Nama</label><input type="text" id="testimonial-nama" class="form-control" required></div>
                        <div class="mb-3"><label for="testimonial-isi">Pesan</label><textarea id="testimonial-isi" class="form-control" rows="3" required></textarea></div>
                        <button type="submit" id="submit-testimonial-btn" class="btn btn-primary w-100">Simpan Testimoni</button>
                        <button type="button" id="cancel-testimonial-edit-btn" class="btn btn-secondary w-100 mt-2" style="display:none;">Batal Edit</button>
                    </form>
                </div>
            </div>
            
            <div class="tab-pane fade" id="faq" role="tabpanel">
                <div class="section">
                    <h2>Manajemen FAQ</h2>
                    <form id="faq-form"><input type="hidden" id="faqId" /><div class="mb-3"><label for="faq_q">Pertanyaan</label><input type="text" id="faq_q" class="form-control" required></div><div class="mb-3"><label for="faq_a">Jawaban</label><textarea id="faq_a" class="form-control" rows="3" required></textarea></div><button type="submit" class="btn btn-primary w-100">Simpan FAQ</button></form>
                    <hr>
                    <h3>Daftar FAQ</h3>
                    <div class="table-responsive-container">
                        <table id="faq-table" class="table table-striped">
                            <thead><tr><th>Pertanyaan</th><th>Jawaban</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="payments" role="tabpanel">
                <div class="section">
                    <h2>Info Pembayaran</h2>
                    <form id="payment-form"><input type="hidden" id="paymentId" /><div class="mb-3"><label for="payment_metode">Metode</label><input type="text" id="payment_metode" class="form-control" required></div><div class="mb-3"><label for="payment_nomor">Nomor Rekening/Akun</label><input type="text" id="payment_nomor" class="form-control" required></div><div class="mb-3"><label for="payment_an">Atas Nama</label><input type="text" id="payment_an" class="form-control" required></div><button type="submit" class="btn btn-primary w-100">Simpan Info</button></form>
                    <hr>
                    <h3>Daftar Info Pembayaran</h3>
                    <div class="table-responsive-container">
                        <table id="payments-table" class="table table-striped">
                            <thead><tr><th>Metode</th><th>Nomor</th><th>A.N</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="promo-management" role="tabpanel">
                <div class="section">
                    <h2>Berikan Diskon Promosi (Rp 5.000)</h2>
                    <p>Masukkan nomor WhatsApp atau email pelanggan yang telah mempromosikan toko. Sistem akan otomatis memberikan hak diskon pada pesanan mereka selanjutnya.</p>
                    
                    <div class="p-3 border rounded mb-4">
                        <h4>Untuk Reseller</h4>
                        <form id="grant-reseller-promo-form">
                            <div class="mb-3">
                                <label for="reseller-promo-email" class="form-label">Email Reseller</label>
                                <input type="email" id="reseller-promo-email" class="form-control" placeholder="contoh@reseller.com" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Beri Diskon ke Reseller</button>
                        </form>
                    </div>

                    <div class="p-3 border rounded">
                        <h4>Untuk Pembeli Biasa</h4>
                        <form id="grant-buyer-promo-form">
                            <div class="mb-3">
                                <label for="buyer-promo-whatsapp" class="form-label">Nomor WhatsApp Pembeli Biasa</label>
                                <input type="tel" id="buyer-promo-whatsapp" class="form-control" placeholder="Cth: 081234567890" pattern="^08[0-9]{8,15}$" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Beri Diskon ke Pembeli</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="gift-claims" role="tabpanel">
                <div class="section">
                    <h2>Klaim Hadiah Pembeli</h2>
                    <div class="table-responsive-container">
                        <table id="gift-claims-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Email Pembeli</th>
                                    <th>Waktu Klaim</th>
                                    <th>Status</th>
                                    <th>Bukti</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="banners" role="tabpanel">
                <div class="section">
                    <h2>Daftar Banner</h2>
                    <div class="table-responsive-container">
                        <table id="banners-table" class="table table-striped">
                            <thead><tr><th>Urutan</th><th>URL Gambar</th><th>Tautan</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <hr>
                    <h2>Tambah/Edit Banner</h2>
                    <form id="banner-form"><input type="hidden" id="bannerId" /><div class="mb-3"><label for="banner_url">URL Gambar</label><input type="text" id="banner_url" class="form-control" required></div><div class="mb-3"><label for="banner_link">Tautan (opsional)</label><input type="text" id="banner_link" class="form-control"></div><div class="mb-3"><label for="banner_urutan">Urutan Tampilan</label><input type="number" id="banner_urutan" class="form-control" value="0"></div><button type="submit" class="btn btn-primary w-100">Simpan Banner</button><button type="button" id="cancel-banner-edit-btn" class="btn btn-secondary w-100 mt-2" style="display:none;">Batal Edit</button></form>
                </div>
            </div>

            <div class="tab-pane fade" id="custom-code" role="tabpanel">
                <div class="section">
                    <h2>Manajemen Fitur Kustom</h2>
                    <p>Tambah atau hapus fitur HTML/CSS/JS yang akan dimuat di halaman publik.</p>
                    <div class="p-3 border rounded mb-4" style="background-color: var(--bg);">
                        <h4>Tambah Fitur Baru</h4>
                        <form id="add-feature-form">
                            <div class="mb-3">
                                <label for="feature-name" class="form-label">Nama Fitur (Contoh: Banner Promo Lebaran)</label>
                                <input type="text" id="feature-name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="feature-html" class="form-label">Kode HTML</label>
                                <textarea id="feature-html" class="form-control" rows="5"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="feature-css" class="form-label">Kode CSS</label>
                                <textarea id="feature-css" class="form-control" rows="5"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="feature-js" class="form-label">Kode JavaScript</label>
                                <textarea id="feature-js" class="form-control" rows="5"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Tambah Fitur</button>
                        </form>
                    </div>
                    <h4>Daftar Fitur Aktif</h4>
                    <div id="custom-features-list">
                        <p>Memuat fitur...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex"><div class="toast-body"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // ==========================================================
        //  KONFIGURASI FIREBASE DAN FUNGSI UMUM
        // ==========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // Ganti dengan API Key Firebase Anda
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
          storageBucket: "asdarstoredigitalll-d89c4.appspot.com" // Pastikan ada jika menggunakan Firebase Storage
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();
        const storage = firebase.storage(); // Inisialisasi Firebase Storage

        // Redirect jika belum login
        auth.onAuthStateChanged(user => { if (!user) { window.location.href = "loginadmin.html"; } });
        // Fungsi logout
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut().then(() => { window.location.href = "loginadmin.html"; }); });
        
        // Fungsi format Rupiah
        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
        
        // Fungsi copy to clipboard
        function copyToClipboard(text, element) {
            if (!navigator.clipboard) { alert("Browser Anda tidak mendukung fitur salin."); return; }
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.innerHTML;
                element.innerHTML = 'Disalin!'; element.disabled = true;
                setTimeout(() => { element.innerHTML = originalText; element.disabled = false; }, 1500);
            }).catch(err => { console.error('Gagal menyalin: ', err); alert('Gagal menyalin ID.'); });
        }
        
        // Fungsi menampilkan Toast Notifikasi
        function showToast(message, type = 'success') {
            const toastElement = document.getElementById('liveToast');
            const toastBody = toastElement.querySelector('.toast-body');
            const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastElement);
            toastElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
            toastElement.classList.add(type === 'danger' ? 'bg-danger' : `bg-${type}`);
            toastBody.textContent = message;
            toastBootstrap.show();
        }

        // Fungsi loading button
        function setButtonLoading(button, isLoading) {
            if(!button) return;
            if (isLoading) {
                if (!button.dataset.originalText) { button.dataset.originalText = button.innerHTML; }
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memuat...';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }
        }

        // ====================================== NOTIFIKASI REAL-TIME ======================================
        // Objek untuk menyimpan ID item yang sudah dinotifikasi, agar tidak menotifikasi berulang dalam sesi yang sama
        const notifiedItems = {
            orders: new Set(),
            topups: new Set(),
            verifications: new Set(),
            giftClaims: new Set()
        };

        function setupRealtimeListeners() {
            // 1. Dengar Pesanan Baru (status 'pending')
            dbFS.collection('orders')
                .where('status', '==', 'pending') 
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const order = change.doc.data();
                        const orderId = change.doc.id;
                        if ((change.type === 'added' || (change.type === 'modified' && order.status === 'pending')) && !notifiedItems.orders.has(orderId)) {
                            showToast(`Pesanan Baru: ${order.productName} dari ${order.customerEmail || order.customerWhatsapp}!`, 'info');
                            notifiedItems.orders.add(orderId);
                            if (document.getElementById('orders-tab').classList.contains('active')) {
                                loadOrders(); // Perbarui daftar jika admin sedang di tab ini
                            }
                        }
                    });
                }, error => {
                    console.error("Error listening to new orders: ", error);
                    showToast('Gagal mendengarkan pesanan baru secara real-time.', 'danger');
                });

            // 2. Dengar Konfirmasi Top Up Baru (status 'pending')
            dbFS.collection('topups')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const topup = change.doc.data();
                        const topupId = change.doc.id;
                        if ((change.type === 'added' || (change.type === 'modified' && topup.status === 'pending')) && !notifiedItems.topups.has(topupId)) {
                            showToast(`Top Up Baru: ${formatRupiah(topup.amount)} dari ${topup.resellerEmail}!`, 'info');
                            notifiedItems.topups.add(topupId);
                            if (document.getElementById('topup-tab').classList.contains('active')) {
                                loadTopupConfirmations();
                            }
                        }
                    });
                }, error => {
                    console.error("Error listening to new topups: ", error);
                    showToast('Gagal mendengarkan top up baru secara real-time.', 'danger');
                });

            // 3. Dengar Verifikasi Reseller Baru (status 'pending')
            dbFS.collection('resellers')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const reseller = change.doc.data();
                        const resellerId = change.doc.id;
                        if ((change.type === 'added' || (change.type === 'modified' && reseller.status === 'pending')) && !notifiedItems.verifications.has(resellerId)) {
                            showToast(`Verifikasi Reseller Baru: ${reseller.email} butuh persetujuan!`, 'info');
                            notifiedItems.verifications.add(resellerId);
                            if (document.getElementById('verification-tab').classList.contains('active')) {
                                loadPendingResellers();
                            }
                        }
                    });
                    // Pastikan badge count diperbarui secara real-time
                    updateVerificationCount(snapshot.size);
                }, error => {
                    console.error("Error listening to new reseller verifications: ", error);
                    showToast('Gagal mendengarkan verifikasi reseller baru secara real-time.', 'danger');
                });

            // 4. Dengar Klaim Hadiah Baru (status 'pending')
            dbFS.collection('giftClaims')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const claim = change.doc.data();
                        const claimId = change.doc.id;
                        if ((change.type === 'added' || (change.type === 'modified' && claim.status === 'pending')) && !notifiedItems.giftClaims.has(claimId)) {
                            showToast(`Klaim Hadiah Baru: Dari ${claim.buyerEmail}!`, 'info');
                            notifiedItems.giftClaims.add(claimId);
                            if (document.getElementById('gift-claims-tab').classList.contains('active')) {
                                loadGiftClaims();
                            }
                        }
                    });
                }, error => {
                    console.error("Error listening to new gift claims: ", error);
                    showToast('Gagal mendengarkan klaim hadiah baru secara real-time.', 'danger');
                });
        }


        // ====================================== MANAJEMEN TABS & PEMUATAN DATA AWAL ======================================
        document.addEventListener('DOMContentLoaded', () => {
            // Muat data untuk semua tab saat halaman dimuat
            loadProducts();
            loadResellers();
            loadTopupConfirmations();
            loadOrders();
            loadTestimonials();
            loadFaq();
            loadPaymentMethods();
            loadBanners();
            loadPendingResellers(); 
            loadCustomFeatures();
            loadGiftClaims();

            // Setup event listeners untuk form baru
            setupPromoManagementForms();

            // Panggil setup notifikasi real-time
            setupRealtimeListeners();
        });

        // Event listeners untuk setiap tab (agar data di-refresh setiap kali tab diklik)
        document.getElementById('products-tab').addEventListener('click', loadProducts);
        document.getElementById('active-resellers-tab').addEventListener('click', loadResellers);
        document.getElementById('verification-tab').addEventListener('click', loadPendingResellers);
        document.getElementById('topup-tab').addEventListener('click', loadTopupConfirmations);
        document.getElementById('orders-tab').addEventListener('click', loadOrders);
        document.getElementById('testimonials-tab').addEventListener('click', loadTestimonials);
        document.getElementById('faq-tab').addEventListener('click', loadFaq);
        document.getElementById('payments-tab').addEventListener('click', loadPaymentMethods);
        document.getElementById('promo-management-tab').addEventListener('click', setupPromoManagementForms); // Memanggil ulang setup form jika perlu
        document.getElementById('gift-claims-tab').addEventListener('click', loadGiftClaims);
        document.getElementById('banners-tab').addEventListener('click', loadBanners);
        document.getElementById('custom-code-tab').addEventListener('click', loadCustomFeatures);

        // =================================== MANAJEMEN PROMO MANUAL (FITUR BARU) ===================================
        function setupPromoManagementForms() {
            const resellerPromoForm = document.getElementById('grant-reseller-promo-form');
            const buyerPromoForm = document.getElementById('grant-buyer-promo-form');

            if (resellerPromoForm) {
                resellerPromoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('reseller-promo-email').value;
                    const button = e.target.querySelector('[type=submit]');
                    setButtonLoading(button, true);

                    try {
                        const resellerQuery = await dbFS.collection('resellers').where('email', '==', email).limit(1).get();
                        if (resellerQuery.empty) {
                            throw new Error('Reseller dengan email tersebut tidak ditemukan.');
                        }
                        const resellerDoc = resellerQuery.docs[0];
                        await dbFS.collection('resellers').doc(resellerDoc.id).update({
                            punyaHakDiskon: true // Memberikan hak diskon kepada reseller
                        });
                        showToast(`Hak diskon berhasil diberikan kepada reseller: ${email}`, 'success');
                        resellerPromoForm.reset();
                    } catch (error) {
                        showToast('Gagal: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                });
            }

            if (buyerPromoForm) {
                buyerPromoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const whatsappNumberInput = document.getElementById('buyer-promo-whatsapp');
                    const rawWhatsappNumber = whatsappNumberInput.value.trim();
                    const button = e.target.querySelector('[type=submit]');
                    setButtonLoading(button, true);

                    const normalizePhone = (num) => {
                        let n = String(num).trim().replace(/[^0-9]/g, '');
                        if (n.startsWith('0')) return '62' + n.slice(1);
                        if (n.startsWith('62')) return n;
                        return num;
                    };

                    const normalizedWhatsappNumber = normalizePhone(rawWhatsappNumber);

                    if (!normalizedWhatsappNumber || normalizedWhatsappNumber.length < 10) {
                        showToast('Nomor WhatsApp tidak valid. Masukkan nomor yang benar (diawali 08...).', 'danger');
                        setButtonLoading(button, false);
                        return;
                    }

                    try {
                        await dbRT.ref('hakDiskon/' + normalizedWhatsappNumber).set(true);

                        showToast(`Hak diskon berhasil diberikan kepada pembeli: ${rawWhatsappNumber}`, 'success');
                        buyerPromoForm.reset();
                    } catch (error) {
                        showToast('Gagal memberikan diskon: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                });
            }
        }


        // =================================== PRODUK (Firestore) ===================================
        const productForm = document.getElementById('product-form');
        const productsTableBody = document.querySelector('#products-table tbody');
        const promoCheckbox = document.getElementById('promo-checkbox');
        const promoOptions = document.getElementById('promo-options');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        let currentProductId = null;

        promoCheckbox.addEventListener('change', () => {
            promoOptions.style.display = promoCheckbox.checked ? 'block' : 'none';
        });

        // Load Products
        async function loadProducts() {
            productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Memuat produk...</td></tr>';
            try {
                const snapshot = await dbFS.collection('products').orderBy('urutan', 'asc').get();
                productsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada produk.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const row = productsTableBody.insertRow();
                    row.insertCell(0).textContent = product.nama_produk;
                    row.insertCell(1).textContent = product.kategori;
                    row.insertCell(2).textContent = formatRupiah(product.harga_umum);
                    row.insertCell(3).textContent = formatRupiah(product.harga_reseller);
                    row.insertCell(4).textContent = product.stok;
                    
                    const actionsCell = row.insertCell(5);
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editProduct(doc.id, product);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteProduct(doc.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading products: ", error);
                productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat produk.</td></tr>';
                showToast('Gagal memuat daftar produk.', 'danger');
            }
        }

        // Add/Edit Product
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const productData = {
                nama_produk: document.getElementById('nama_produk').value,
                kategori: document.getElementById('kategori').value,
                deskripsi: document.getElementById('deskripsi').value,
                harga_umum: parseFloat(document.getElementById('harga_umum').value),
                harga_reseller: parseFloat(document.getElementById('harga_reseller').value),
                stok: parseInt(document.getElementById('stok').value),
                urutan: parseInt(document.getElementById('urutan').value) || 0,
                promo: promoCheckbox.checked ? {
                    jenis: document.getElementById('promo-jenis').value,
                    nilai: parseFloat(document.getElementById('promo-nilai').value)
                } : null
            };

            try {
                if (currentProductId) {
                    await dbFS.collection('products').doc(currentProductId).update(productData);
                    showToast('Produk berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('products').add(productData);
                    showToast('Produk berhasil ditambahkan!', 'success');
                }
                productForm.reset();
                promoOptions.style.display = 'none';
                currentProductId = null;
                cancelEditBtn.style.display = 'none';
                button.textContent = 'Simpan Produk';
                loadProducts();
            } catch (error) {
                console.error("Error saving product: ", error);
                showToast('Gagal menyimpan produk: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Edit Product (populate form)
        function editProduct(id, product) {
            currentProductId = id;
            document.getElementById('nama_produk').value = product.nama_produk;
            document.getElementById('kategori').value = product.kategori;
            document.getElementById('deskripsi').value = product.deskripsi;
            document.getElementById('harga_umum').value = product.harga_umum;
            document.getElementById('harga_reseller').value = product.harga_reseller;
            document.getElementById('stok').value = product.stok;
            document.getElementById('urutan').value = product.urutan || 0;

            if (product.promo) {
                promoCheckbox.checked = true;
                promoOptions.style.display = 'block';
                document.getElementById('promo-jenis').value = product.promo.jenis;
                document.getElementById('promo-nilai').value = product.promo.nilai;
            } else {
                promoCheckbox.checked = false;
                promoOptions.style.display = 'none';
            }

            productForm.querySelector('[type=submit]').textContent = 'Update Produk';
            cancelEditBtn.style.display = 'block';
        }

        // Cancel Edit
        cancelEditBtn.addEventListener('click', () => {
            productForm.reset();
            promoOptions.style.display = 'none';
            currentProductId = null;
            cancelEditBtn.style.display = 'none';
            productForm.querySelector('[type=submit]').textContent = 'Simpan Produk';
        });

        // Delete Product
        async function deleteProduct(id) {
            if (confirm('Yakin ingin menghapus produk ini?')) {
                try {
                    await dbFS.collection('products').doc(id).delete();
                    showToast('Produk berhasil dihapus!', 'success');
                    loadProducts();
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showToast('Gagal menghapus produk: ' + error.message, 'danger');
                }
            }
        }

        // =================================== RESELLER AKTIF (Firestore) ===================================
        const resellersTableBody = document.querySelector('#resellers-table tbody');

        async function loadResellers() {
            resellersTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Memuat reseller...</td></tr>';
            try {
                const snapshot = await dbFS.collection('resellers').where('status', '==', 'approved').get();
                resellersTableBody.innerHTML = '';
                if (snapshot.empty) {
                    resellersTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada reseller aktif.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const reseller = doc.data();
                    const row = resellersTableBody.insertRow();
                    row.insertCell(0).textContent = reseller.email;
                    row.insertCell(1).textContent = formatRupiah(reseller.saldo || 0);
                    
                    const actionsCell = row.insertCell(2);
                    const resetBalanceBtn = document.createElement('button');
                    resetBalanceBtn.className = 'btn btn-sm btn-warning me-2';
                    resetBalanceBtn.innerHTML = '<i class="fas fa-redo"></i> Reset Saldo';
                    resetBalanceBtn.onclick = () => resetResellerBalance(doc.id, reseller.email);
                    actionsCell.appendChild(resetBalanceBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                    deleteBtn.onclick = () => deleteReseller(doc.id, reseller.email);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading resellers: ", error);
                resellersTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat reseller.</td></tr>';
                showToast('Gagal memuat daftar reseller.', 'danger');
            }
        }

        async function resetResellerBalance(id, email) {
            if (confirm(`Yakin ingin mereset saldo reseller ${email} menjadi Rp0?`)) {
                try {
                    await dbFS.collection('resellers').doc(id).update({ saldo: 0 });
                    showToast(`Saldo reseller ${email} berhasil direset!`, 'success');
                    loadResellers();
                } catch (error) {
                    console.error("Error resetting reseller balance: ", error);
                    showToast('Gagal mereset saldo reseller: ' + error.message, 'danger');
                }
            }
        }

        async function deleteReseller(id, email) {
            if (confirm(`Yakin ingin menghapus reseller ${email}? Tindakan ini tidak dapat dibatalkan.`)) {
                try {
                    // Hapus dari Firestore
                    await dbFS.collection('resellers').doc(id).delete();
                    
                    // Hapus user dari Firebase Authentication (jika ada) - ini memerlukan fungsi admin di backend
                    // Karena ini frontend, kita hanya menghapus datanya. Jika ada user terkait,
                    // perlu penanganan manual di Firebase Auth Console atau fungsi cloud.
                    showToast(`Reseller ${email} berhasil dihapus! (Harap hapus juga akun otentikasi jika ada)`, 'success');
                    loadResellers();
                } catch (error) {
                    console.error("Error deleting reseller: ", error);
                    showToast('Gagal menghapus reseller: ' + error.message, 'danger');
                }
            }
        }

        // =================================== VERIFIKASI RESELLER (Firestore) ===================================
        const verificationTableBody = document.getElementById('verification-table-body');
        const verificationCountBadge = document.getElementById('verification-count');

        async function loadPendingResellers() {
            verificationTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat permintaan verifikasi...</td></tr>';
            try {
                const snapshot = await dbFS.collection('resellers').where('status', '==', 'pending').get();
                verificationTableBody.innerHTML = '';
                let pendingCount = 0;

                if (snapshot.empty) {
                    verificationTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada permintaan verifikasi.</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        pendingCount++;
                        const reseller = doc.data();
                        const row = verificationTableBody.insertRow();
                        row.insertCell(0).textContent = reseller.email;
                        row.insertCell(1).textContent = reseller.paket || 'N/A';
                        row.insertCell(2).textContent = formatRupiah(reseller.deposit_amount || 0);
                        
                        const buktiCell = row.insertCell(3);
                        if (reseller.deposit_proof_url) {
                            const link = document.createElement('a');
                            link.href = reseller.deposit_proof_url;
                            link.target = '_blank';
                            link.textContent = 'Lihat Bukti';
                            buktiCell.appendChild(link);
                        } else {
                            buktiCell.textContent = 'Tidak Ada';
                        }
                        
                        const actionsCell = row.insertCell(4);
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i>';
                        approveBtn.onclick = () => updateResellerStatus(doc.id, 'approved', reseller.email, reseller.paket);
                        actionsCell.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-sm btn-danger';
                        rejectBtn.innerHTML = '<i class="fas fa-times"></i>';
                        rejectBtn.onclick = () => updateResellerStatus(doc.id, 'rejected', reseller.email);
                        actionsCell.appendChild(rejectBtn);
                    });
                }
                updateVerificationCount(pendingCount); // Pastikan ini terpanggil untuk mengupdate badge

            } catch (error) {
                console.error("Error loading pending resellers: ", error);
                verificationTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat verifikasi.</td></tr>';
                showToast('Gagal memuat permintaan verifikasi.', 'danger');
                updateVerificationCount(0);
            }
        }

        function updateVerificationCount(count) {
            if (count > 0) {
                verificationCountBadge.textContent = count;
                verificationCountBadge.style.display = 'inline-block';
            } else {
                verificationCountBadge.style.display = 'none';
            }
        }

        async function updateResellerStatus(id, status, email, paket = null) {
            if (!confirm(`Yakin ingin ${status === 'approved' ? 'menyetujui' : 'menolak'} pendaftaran reseller ${email}?`)) {
                return;
            }

            try {
                const batch = dbFS.batch();
                const resellerRef = dbFS.collection('resellers').doc(id);

                batch.update(resellerRef, { status: status });

                if (status === 'approved') {
                    // Update saldo reseller berdasarkan paket
                    let initialBalance = 0;
                    if (paket === 'paket_bronze') {
                        initialBalance = 25000;
                    } else if (paket === 'paket_silver') {
                        initialBalance = 50000;
                    } else if (paket === 'paket_gold') {
                        initialBalance = 100000;
                    }
                    batch.update(resellerRef, { saldo: initialBalance, joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showToast(`Pendaftaran reseller ${email} berhasil disetujui! Saldo awal Rp${initialBalance.toLocaleString('id-ID')}.`, 'success');
                } else {
                    showToast(`Pendaftaran reseller ${email} berhasil ditolak.`, 'info');
                }
                
                await batch.commit();
                loadPendingResellers(); // Refresh list
                if (status === 'approved') loadResellers(); // Refresh active resellers list too
            } catch (error) {
                console.error("Error updating reseller status: ", error);
                showToast(`Gagal ${status === 'approved' ? 'menyetujui' : 'menolak'} reseller: ` + error.message, 'danger');
            }
        }


        // =================================== KONFIRMASI TOP UP (Firestore) ===================================
        const topupTableBody = document.getElementById('topup-table').getElementsByTagName('tbody')[0];

        async function loadTopupConfirmations() {
            topupTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Memuat konfirmasi top up...</td></tr>';
            try {
                const snapshot = await dbFS.collection('topups').orderBy('timestamp', 'desc').get();
                topupTableBody.innerHTML = '';
                if (snapshot.empty) {
                    topupTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada konfirmasi top up.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const topup = doc.data();
                    const row = topupTableBody.insertRow();
                    row.insertCell(0).textContent = doc.id.substring(0, 8); // Shorten ID
                    row.insertCell(1).textContent = topup.resellerEmail || 'N/A';
                    row.insertCell(2).textContent = formatRupiah(topup.amount || 0);
                    
                    const buktiCell = row.insertCell(3);
                    if (topup.proofUrl) {
                        const link = document.createElement('a');
                        link.href = topup.proofUrl;
                        link.target = '_blank';
                        link.textContent = 'Lihat Bukti';
                        buktiCell.appendChild(link);
                    } else {
                        buktiCell.textContent = 'Tidak Ada';
                    }

                    const statusCell = row.insertCell(4);
                    statusCell.innerHTML = `<span class="status-badge status-${topup.status}">${topup.status.replace(/_/g, ' ')}</span>`;
                    
                    const actionsCell = row.insertCell(5);
                    if (topup.status === 'pending') {
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i> Setujui';
                        approveBtn.onclick = () => updateTopupStatus(doc.id, 'approved', topup.resellerEmail, topup.amount);
                        actionsCell.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-sm btn-danger';
                        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Tolak';
                        rejectBtn.onclick = () => updateTopupStatus(doc.id, 'rejected', topup.resellerEmail);
                        actionsCell.appendChild(rejectBtn);
                    } else {
                        actionsCell.textContent = 'Selesai';
                    }
                });
            } catch (error) {
                console.error("Error loading top up confirmations: ", error);
                topupTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat konfirmasi top up.</td></tr>';
                showToast('Gagal memuat konfirmasi top up.', 'danger');
            }
        }

        async function updateTopupStatus(topupId, status, resellerEmail, amount = 0) {
            if (!confirm(`Yakin ingin ${status === 'approved' ? 'menyetujui' : 'menolak'} top up ini?`)) {
                return;
            }

            try {
                const batch = dbFS.batch();
                const topupRef = dbFS.collection('topups').doc(topupId);
                batch.update(topupRef, { status: status });

                if (status === 'approved') {
                    const resellerQuery = await dbFS.collection('resellers').where('email', '==', resellerEmail).limit(1).get();
                    if (resellerQuery.empty) {
                        throw new Error('Reseller tidak ditemukan.');
                    }
                    const resellerRef = resellerQuery.docs[0].ref;
                    batch.update(resellerRef, { saldo: firebase.firestore.FieldValue.increment(amount) });
                    showToast(`Top up sebesar ${formatRupiah(amount)} untuk ${resellerEmail} berhasil disetujui!`, 'success');
                } else {
                    showToast(`Top up untuk ${resellerEmail} berhasil ditolak.`, 'info');
                }
                
                await batch.commit();
                loadTopupConfirmations(); // Refresh list
                if (status === 'approved') loadResellers(); // Refresh reseller saldo
            } catch (error) {
                console.error("Error updating topup status: ", error);
                showToast(`Gagal ${status === 'approved' ? 'menyetujui' : 'menolak'} top up: ` + error.message, 'danger');
            }
        }


        // =================================== PESANAN (Firestore) ===================================
        const ordersTableBody = document.getElementById('orders-table-body');
        const orderFilter = document.getElementById('order-filter');

        orderFilter.addEventListener('change', loadOrders); // Reload orders when filter changes

        async function loadOrders() {
            ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Memuat pesanan...</td></tr>';
            const filter = orderFilter.value;
            let query = dbFS.collection('orders').orderBy('timestamp', 'desc');

            if (filter === 'umum') {
                query = query.where('customerType', '==', 'umum');
            } else if (filter === 'reseller') {
                query = query.where('customerType', '==', 'reseller');
            }

            try {
                const snapshot = await query.get();
                ordersTableBody.innerHTML = '';
                if (snapshot.empty) {
                    ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada pesanan.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const row = ordersTableBody.insertRow();
                    row.insertCell(0).textContent = doc.id.substring(0, 8); // Shorten ID
                    row.insertCell(1).textContent = order.productName || 'N/A';
                    row.insertCell(2).textContent = order.customerEmail || order.customerWhatsapp || 'N/A';
                    row.insertCell(3).textContent = formatRupiah(order.totalPrice || 0);

                    const statusCell = row.insertCell(4);
                    statusCell.innerHTML = `<span class="status-badge status-${order.status}">${order.status.replace(/_/g, ' ')}</span>`;
                    
                    const actionsCell = row.insertCell(5);
                    if (order.status === 'pending') {
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i> Proses';
                        approveBtn.onclick = () => updateOrderStatus(doc.id, 'diproses', order.customerEmail || order.customerWhatsapp);
                        actionsCell.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-sm btn-danger';
                        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Batalkan';
                        rejectBtn.onclick = () => updateOrderStatus(doc.id, 'dibatalkan', order.customerEmail || order.customerWhatsapp);
                        actionsCell.appendChild(rejectBtn);
                    } else if (order.status === 'diproses') {
                        const completeBtn = document.createElement('button');
                        completeBtn.className = 'btn btn-sm btn-primary me-2';
                        completeBtn.innerHTML = '<i class="fas fa-check-double"></i> Selesai';
                        completeBtn.onclick = () => updateOrderStatus(doc.id, 'selesai', order.customerEmail || order.customerWhatsapp);
                        actionsCell.appendChild(completeBtn);
                    } else {
                        actionsCell.textContent = 'Selesai'; // Or show nothing
                    }
                });
            } catch (error) {
                console.error("Error loading orders: ", error);
                ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat pesanan.</td></tr>';
                showToast('Gagal memuat daftar pesanan.', 'danger');
            }
        }

        async function updateOrderStatus(orderId, status, customerIdentifier) {
            if (!confirm(`Yakin ingin mengubah status pesanan ${orderId.substring(0,8)} menjadi '${status}'?`)) {
                return;
            }

            try {
                await dbFS.collection('orders').doc(orderId).update({ status: status });
                showToast(`Status pesanan ${orderId.substring(0,8)} berhasil diperbarui menjadi ${status}!`, 'success');
                loadOrders(); // Refresh list
            } catch (error) {
                console.error("Error updating order status: ", error);
                showToast(`Gagal memperbarui status pesanan: ` + error.message, 'danger');
            }
        }

        // =================================== TESTIMONI (Firestore) ===================================
        const testimonialForm = document.getElementById('testimonial-form');
        const testimonialsTableBody = document.querySelector('#testimonials-table tbody');
        const cancelTestimonialEditBtn = document.getElementById('cancel-testimonial-edit-btn');
        let currentTestimonialId = null;

        // Load Testimonials
        async function loadTestimonials() {
            testimonialsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat testimoni...</td></tr>';
            try {
                const snapshot = await dbFS.collection('testimonials').orderBy('timestamp', 'desc').get();
                testimonialsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    testimonialsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada testimoni.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const testimonial = doc.data();
                    const row = testimonialsTableBody.insertRow();
                    row.insertCell(0).textContent = testimonial.nama;
                    row.insertCell(1).textContent = testimonial.isi;
                    
                    const statusCell = row.insertCell(2);
                    statusCell.innerHTML = `<span class="status-badge status-${testimonial.status}">${testimonial.status.replace(/_/g, ' ')}</span>`;

                    const actionsCell = row.insertCell(3);
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editTestimonial(doc.id, testimonial);
                    actionsCell.appendChild(editBtn);

                    if (testimonial.status === 'pending') {
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i>';
                        approveBtn.onclick = () => updateTestimonialStatus(doc.id, 'approved');
                        actionsCell.appendChild(approveBtn);
                    } else if (testimonial.status === 'approved') {
                        const hideBtn = document.createElement('button');
                        hideBtn.className = 'btn btn-sm btn-warning me-2';
                        hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        hideBtn.onclick = () => updateTestimonialStatus(doc.id, 'pending');
                        actionsCell.appendChild(hideBtn);
                    }

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteTestimonial(doc.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading testimonials: ", error);
                testimonialsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat testimoni.</td></tr>';
                showToast('Gagal memuat daftar testimoni.', 'danger');
            }
        }

        // Add/Edit Testimonial
        testimonialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const testimonialData = {
                nama: document.getElementById('testimonial-nama').value,
                isi: document.getElementById('testimonial-isi').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'approved' // Admin menambahkan/mengedit, otomatis disetujui
            };

            try {
                if (currentTestimonialId) {
                    await dbFS.collection('testimonials').doc(currentTestimonialId).update(testimonialData);
                    showToast('Testimoni berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('testimonials').add(testimonialData);
                    showToast('Testimoni berhasil ditambahkan!', 'success');
                }
                testimonialForm.reset();
                currentTestimonialId = null;
                cancelTestimonialEditBtn.style.display = 'none';
                button.textContent = 'Simpan Testimoni';
                loadTestimonials();
            } catch (error) {
                console.error("Error saving testimonial: ", error);
                showToast('Gagal menyimpan testimoni: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Edit Testimonial (populate form)
        function editTestimonial(id, testimonial) {
            currentTestimonialId = id;
            document.getElementById('testimonial-nama').value = testimonial.nama;
            document.getElementById('testimonial-isi').value = testimonial.isi;
            testimonialForm.querySelector('[type=submit]').textContent = 'Update Testimoni';
            cancelTestimonialEditBtn.style.display = 'block';
        }

        // Cancel Testimonial Edit
        cancelTestimonialEditBtn.addEventListener('click', () => {
            testimonialForm.reset();
            currentTestimonialId = null;
            cancelTestimonialEditBtn.style.display = 'none';
            testimonialForm.querySelector('[type=submit]').textContent = 'Simpan Testimoni';
        });

        // Update Testimonial Status
        async function updateTestimonialStatus(id, status) {
            try {
                await dbFS.collection('testimonials').doc(id).update({ status: status });
                showToast(`Status testimoni berhasil diperbarui menjadi ${status}!`, 'success');
                loadTestimonials();
            } catch (error) {
                console.error("Error updating testimonial status: ", error);
                showToast('Gagal memperbarui status testimoni: ' + error.message, 'danger');
            }
        }

        // Delete Testimonial
        async function deleteTestimonial(id) {
            if (confirm('Yakin ingin menghapus testimoni ini?')) {
                try {
                    await dbFS.collection('testimonials').doc(id).delete();
                    showToast('Testimoni berhasil dihapus!', 'success');
                    loadTestimonials();
                } catch (error) {
                    console.error("Error deleting testimonial: ", error);
                    showToast('Gagal menghapus testimoni: ' + error.message, 'danger');
                }
            }
        }
        
        // =================================== FAQ (Firestore) ===================================
        const faqForm = document.getElementById('faq-form');
        const faqTableBody = document.querySelector('#faq-table tbody');
        let currentFaqId = null;

        // Load FAQ
        async function loadFaq() {
            faqTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Memuat FAQ...</td></tr>';
            try {
                const snapshot = await dbFS.collection('faq').orderBy('timestamp', 'desc').get();
                faqTableBody.innerHTML = '';
                if (snapshot.empty) {
                    faqTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada FAQ.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const faq = doc.data();
                    const row = faqTableBody.insertRow();
                    row.insertCell(0).textContent = faq.question;
                    row.insertCell(1).textContent = faq.answer;
                    
                    const actionsCell = row.insertCell(2);
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editFaq(doc.id, faq);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteFaq(doc.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading FAQ: ", error);
                faqTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Gagal memuat FAQ.</td></tr>';
                showToast('Gagal memuat daftar FAQ.', 'danger');
            }
        }

        // Add/Edit FAQ
        faqForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const faqData = {
                question: document.getElementById('faq_q').value,
                answer: document.getElementById('faq_a').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentFaqId) {
                    await dbFS.collection('faq').doc(currentFaqId).update(faqData);
                    showToast('FAQ berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('faq').add(faqData);
                    showToast('FAQ berhasil ditambahkan!', 'success');
                }
                faqForm.reset();
                currentFaqId = null;
                button.textContent = 'Simpan FAQ';
                loadFaq();
            } catch (error) {
                console.error("Error saving FAQ: ", error);
                showToast('Gagal menyimpan FAQ: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Edit FAQ (populate form)
        function editFaq(id, faq) {
            currentFaqId = id;
            document.getElementById('faq_q').value = faq.question;
            document.getElementById('faq_a').value = faq.answer;
            faqForm.querySelector('[type=submit]').textContent = 'Update FAQ';
        }

        // Delete FAQ
        async function deleteFaq(id) {
            if (confirm('Yakin ingin menghapus FAQ ini?')) {
                try {
                    await dbFS.collection('faq').doc(id).delete();
                    showToast('FAQ berhasil dihapus!', 'success');
                    loadFaq();
                } catch (error) {
                    console.error("Error deleting FAQ: ", error);
                    showToast('Gagal menghapus FAQ: ' + error.message, 'danger');
                }
            }
        }

        // =================================== PEMBAYARAN (Firestore) ===================================
        const paymentForm = document.getElementById('payment-form');
        const paymentsTableBody = document.querySelector('#payments-table tbody');
        let currentPaymentId = null;

        // Load Payment Methods
        async function loadPaymentMethods() {
            paymentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat info pembayaran...</td></tr>';
            try {
                const snapshot = await dbFS.collection('paymentMethods').orderBy('method', 'asc').get();
                paymentsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    paymentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada info pembayaran.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const payment = doc.data();
                    const row = paymentsTableBody.insertRow();
                    row.insertCell(0).textContent = payment.method;
                    row.insertCell(1).textContent = payment.accountNumber;
                    row.insertCell(2).textContent = payment.accountName;
                    
                    const actionsCell = row.insertCell(3);
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editPaymentMethod(doc.id, payment);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deletePaymentMethod(doc.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading payment methods: ", error);
                paymentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat info pembayaran.</td></tr>';
                showToast('Gagal memuat daftar info pembayaran.', 'danger');
            }
        }

        // Add/Edit Payment Method
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const paymentData = {
                method: document.getElementById('payment_metode').value,
                accountNumber: document.getElementById('payment_nomor').value,
                accountName: document.getElementById('payment_an').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentPaymentId) {
                    await dbFS.collection('paymentMethods').doc(currentPaymentId).update(paymentData);
                    showToast('Info pembayaran berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('paymentMethods').add(paymentData);
                    showToast('Info pembayaran berhasil ditambahkan!', 'success');
                }
                paymentForm.reset();
                currentPaymentId = null;
                button.textContent = 'Simpan Info';
                loadPaymentMethods();
            } catch (error) {
                console.error("Error saving payment method: ", error);
                showToast('Gagal menyimpan info pembayaran: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Edit Payment Method (populate form)
        function editPaymentMethod(id, payment) {
            currentPaymentId = id;
            document.getElementById('payment_metode').value = payment.method;
            document.getElementById('payment_nomor').value = payment.accountNumber;
            document.getElementById('payment_an').value = payment.accountName;
            paymentForm.querySelector('[type=submit]').textContent = 'Update Info';
        }

        // Delete Payment Method
        async function deletePaymentMethod(id) {
            if (confirm('Yakin ingin menghapus info pembayaran ini?')) {
                try {
                    await dbFS.collection('paymentMethods').doc(id).delete();
                    showToast('Info pembayaran berhasil dihapus!', 'success');
                    loadPaymentMethods();
                } catch (error) {
                    console.error("Error deleting payment method: ", error);
                    showToast('Gagal menghapus info pembayaran: ' + error.message, 'danger');
                }
            }
        }

        // =================================== KLAIM HADIAH BUYER (Firestore) ===================================
        const giftClaimsTableBody = document.getElementById('gift-claims-table').getElementsByTagName('tbody')[0];

        async function loadGiftClaims() {
            giftClaimsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat klaim hadiah...</td></tr>';
            try {
                const snapshot = await dbFS.collection('giftClaims').orderBy('claimTime', 'desc').get();
                giftClaimsTableBody.innerHTML = '';
                if (snapshot.empty) {
                    giftClaimsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada klaim hadiah.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const claim = doc.data();
                    const row = giftClaimsTableBody.insertRow();
                    row.insertCell(0).textContent = claim.buyerEmail;
                    row.insertCell(1).textContent = claim.claimTime ? new Date(claim.claimTime.toDate()).toLocaleString() : 'N/A';
                    
                    const statusCell = row.insertCell(2);
                    statusCell.innerHTML = `<span class="status-badge status-${claim.status}">${claim.status.replace(/_/g, ' ')}</span>`;
                    
                    const buktiCell = row.insertCell(3);
                    if (claim.proofUrl) {
                        const link = document.createElement('a');
                        link.href = claim.proofUrl;
                        link.target = '_blank';
                        link.textContent = 'Lihat Bukti';
                        buktiCell.appendChild(link);
                    } else {
                        buktiCell.textContent = 'Tidak Ada';
                    }

                    const actionsCell = row.insertCell(4);
                    if (claim.status === 'pending') {
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i> Setujui';
                        approveBtn.onclick = () => updateGiftClaimStatus(doc.id, 'approved', claim.buyerEmail);
                        actionsCell.appendChild(approveBtn);

                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-sm btn-danger';
                        rejectBtn.innerHTML = '<i class="fas fa-times"></i> Tolak';
                        rejectBtn.onclick = () => updateGiftClaimStatus(doc.id, 'rejected', claim.buyerEmail);
                        actionsCell.appendChild(rejectBtn);
                    } else {
                        actionsCell.textContent = 'Selesai';
                    }
                });
            } catch (error) {
                console.error("Error loading gift claims: ", error);
                giftClaimsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat klaim hadiah.</td></tr>';
                showToast('Gagal memuat klaim hadiah.', 'danger');
            }
        }

        async function updateGiftClaimStatus(claimId, status, buyerEmail) {
            if (!confirm(`Yakin ingin ${status === 'approved' ? 'menyetujui' : 'menolak'} klaim hadiah dari ${buyerEmail}?`)) {
                return;
            }

            try {
                await dbFS.collection('giftClaims').doc(claimId).update({ status: status });
                showToast(`Klaim hadiah dari ${buyerEmail} berhasil ${status === 'approved' ? 'disetujui' : 'ditolak'}!`, 'success');
                loadGiftClaims(); // Refresh list
            } catch (error) {
                console.error("Error updating gift claim status: ", error);
                showToast(`Gagal memperbarui status klaim hadiah: ` + error.message, 'danger');
            }
        }

        // =================================== BANNER (Firestore) ===================================
        const bannerForm = document.getElementById('banner-form');
        const bannersTableBody = document.querySelector('#banners-table tbody');
        const cancelBannerEditBtn = document.getElementById('cancel-banner-edit-btn');
        let currentBannerId = null;

        // Load Banners
        async function loadBanners() {
            bannersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Memuat banner...</td></tr>';
            try {
                const snapshot = await dbFS.collection('banners').orderBy('urutan', 'asc').get();
                bannersTableBody.innerHTML = '';
                if (snapshot.empty) {
                    bannersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada banner.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const banner = doc.data();
                    const row = bannersTableBody.insertRow();
                    row.insertCell(0).textContent = banner.urutan || 0;
                    row.insertCell(1).innerHTML = banner.imageUrl ? `<a href="${banner.imageUrl}" target="_blank">Lihat Gambar</a>` : 'N/A';
                    row.insertCell(2).innerHTML = banner.link ? `<a href="${banner.link}" target="_blank">${banner.link.substring(0, 30)}...</a>` : 'Tidak ada';
                    
                    const actionsCell = row.insertCell(3);
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editBanner(doc.id, banner);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteBanner(doc.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error("Error loading banners: ", error);
                bannersTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat banner.</td></tr>';
                showToast('Gagal memuat daftar banner.', 'danger');
            }
        }

        // Add/Edit Banner
        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const bannerData = {
                imageUrl: document.getElementById('banner_url').value,
                link: document.getElementById('banner_link').value || null,
                urutan: parseInt(document.getElementById('banner_urutan').value) || 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentBannerId) {
                    await dbFS.collection('banners').doc(currentBannerId).update(bannerData);
                    showToast('Banner berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('banners').add(bannerData);
                    showToast('Banner berhasil ditambahkan!', 'success');
                }
                bannerForm.reset();
                currentBannerId = null;
                cancelBannerEditBtn.style.display = 'none';
                button.textContent = 'Simpan Banner';
                loadBanners();
            } catch (error) {
                console.error("Error saving banner: ", error);
                showToast('Gagal menyimpan banner: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Edit Banner (populate form)
        function editBanner(id, banner) {
            currentBannerId = id;
            document.getElementById('banner_url').value = banner.imageUrl;
            document.getElementById('banner_link').value = banner.link || '';
            document.getElementById('banner_urutan').value = banner.urutan || 0;
            bannerForm.querySelector('[type=submit]').textContent = 'Update Banner';
            cancelBannerEditBtn.style.display = 'block';
        }

        // Cancel Banner Edit
        cancelBannerEditBtn.addEventListener('click', () => {
            bannerForm.reset();
            currentBannerId = null;
            cancelBannerEditBtn.style.display = 'none';
            bannerForm.querySelector('[type=submit]').textContent = 'Simpan Banner';
        });

        // Delete Banner
        async function deleteBanner(id) {
            if (confirm('Yakin ingin menghapus banner ini?')) {
                try {
                    await dbFS.collection('banners').doc(id).delete();
                    showToast('Banner berhasil dihapus!', 'success');
                    loadBanners();
                } catch (error) {
                    console.error("Error deleting banner: ", error);
                    showToast('Gagal menghapus banner: ' + error.message, 'danger');
                }
            }
        }

        // =================================== CUSTOM CODE/FEATURES (Realtime Database) ===================================
        const addFeatureForm = document.getElementById('add-feature-form');
        const customFeaturesList = document.getElementById('custom-features-list');

        // Load Custom Features
        async function loadCustomFeatures() {
            customFeaturesList.innerHTML = '<p>Memuat fitur kustom...</p>';
            try {
                const snapshot = await dbRT.ref('customFeatures').once('value');
                const features = snapshot.val();
                customFeaturesList.innerHTML = '';
                if (!features) {
                    customFeaturesList.innerHTML = '<p>Belum ada fitur kustom aktif.</p>';
                    return;
                }

                Object.entries(features).forEach(([id, feature]) => {
                    const featureCard = document.createElement('div');
                    featureCard.className = 'p-3 border rounded mb-3';
                    featureCard.style.backgroundColor = 'var(--card)';
                    featureCard.innerHTML = `
                        <h5>${feature.name}</h5>
                        ${feature.html ? `<h6>HTML:</h6><pre style="max-height: 150px; overflow-y: auto; background: var(--bg); padding: 10px; border-radius: 5px;"><code>${escapeHtml(feature.html)}</code></pre>` : ''}
                        ${feature.css ? `<h6>CSS:</h6><pre style="max-height: 150px; overflow-y: auto; background: var(--bg); padding: 10px; border-radius: 5px;"><code>${escapeHtml(feature.css)}</code></pre>` : ''}
                        ${feature.js ? `<h6>JavaScript:</h6><pre style="max-height: 150px; overflow-y: auto; background: var(--bg); padding: 10px; border-radius: 5px;"><code>${escapeHtml(feature.js)}</code></pre>` : ''}
                        <button class="btn btn-sm btn-danger mt-2" onclick="deleteCustomFeature('${id}', '${escapeHtml(feature.name)}')"><i class="fas fa-trash"></i> Hapus Fitur</button>
                    `;
                    customFeaturesList.appendChild(featureCard);
                });

            } catch (error) {
                console.error("Error loading custom features: ", error);
                customFeaturesList.innerHTML = '<p class="text-danger">Gagal memuat fitur kustom.</p>';
                showToast('Gagal memuat fitur kustom.', 'danger');
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Add Custom Feature
        addFeatureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('[type=submit]');
            setButtonLoading(button, true);

            const featureData = {
                name: document.getElementById('feature-name').value,
                html: document.getElementById('feature-html').value,
                css: document.getElementById('feature-css').value,
                js: document.getElementById('feature-js').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                await dbRT.ref('customFeatures').push(featureData);
                showToast('Fitur kustom berhasil ditambahkan!', 'success');
                addFeatureForm.reset();
                loadCustomFeatures();
            } catch (error) {
                console.error("Error adding custom feature: ", error);
                showToast('Gagal menambahkan fitur kustom: ' + error.message, 'danger');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // Delete Custom Feature
        async function deleteCustomFeature(id, name) {
            if (confirm(`Yakin ingin menghapus fitur kustom "${name}"? Tindakan ini tidak dapat dibatalkan.`)) {
                try {
                    await dbRT.ref('customFeatures/' + id).remove();
                    showToast(`Fitur kustom "${name}" berhasil dihapus!`, 'success');
                    loadCustomFeatures();
                } catch (error) {
                    console.error("Error deleting custom feature: ", error);
                    showToast('Gagal menghapus fitur kustom: ' + error.message, 'danger');
                }
            }
        }

    </script>
</body>
    </html>
