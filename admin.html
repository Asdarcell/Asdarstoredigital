<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545;
      --warning-color: #ffc107; --light-gray: #f8f9fa; --border-color: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .container { max-width: 1200px; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .nav-tabs .nav-link.active { color: var(--primary-color); }
    .order-card { border-left: 5px solid var(--primary-color); transition: box-shadow 0.3s ease; }
    .order-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .product-list .list-group-item { cursor: grab; }
    .product-list .list-group-item:active { cursor: grabbing; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
    .toast-container { z-index: 9999; }
    #global-refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
    #pesananList, #product-container { max-height: 65vh; overflow-y: auto; }
    .testimoni-item { border-left-width: 5px; }
    .status-pending { border-left-color: var(--warning-color); }
    .status-disetujui { border-left-color: var(--success-color); }
    .status-ditolak { border-left-color: var(--danger-color); }
  </style>
</head>
<body>

<button id="global-refresh-btn" class="btn btn-primary shadow-lg rounded-circle" style="width: 50px; height: 50px;" title="Refresh Halaman"><i class="fas fa-sync-alt"></i></button>

<div class="toast-container position-fixed top-0 end-0 p-3"></div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p id="confirmModalBody"></p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="confirmModalOk">Ya</button></div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="text-center mb-4"><h1>Dashboard Admin</h1><p class="text-muted">Asdar Store Digital</p></div>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#orders-pane"><i class="fas fa-receipt me-2"></i>Pesanan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#products-pane"><i class="fas fa-box-open me-2"></i>Produk & Promo</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#moderasi-pane"><i class="fas fa-check-double me-2"></i>Moderasi</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content-pane"><i class="fas fa-code me-2"></i>Editor Konten</button></li>
  </ul>

  <div class="tab-content pt-3" id="adminTabContent">
    <div class="tab-pane fade show active" id="orders-pane">
        <div class="card"><div class="card-body"><h3>Manajemen Pesanan</h3><div class="row mb-3 g-2 align-items-center"><div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">Semua Status</option><option value="Belum Bayar">Belum Bayar</option><option value="Sudah Bayar">Sudah Bayar</option><option value="Diproses">Diproses</option><option value="Selesai">Selesai</option></select></div><div class="col-md-5"><input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama/Nomor..." /></div><div class="col-md-2"><button class="btn btn-outline-success w-100" id="exportCSVBtn"><i class="fas fa-file-csv me-2"></i>Export</button></div><div class="col-md-2"><button class="btn btn-outline-primary w-100" onclick="renderPesanan()"><i class="fas fa-sync-alt me-2"></i>Refresh</button></div></div><div id="pesananList" class="p-2 border rounded bg-light"><p class="text-center text-muted p-4">Memuat pesanan...</p></div><hr><div class="row align-items-end"><div class="col-md-6"><h4>Kirim Bukti Admin</h4><div class="input-group mb-2"><input type="file" id="buktiAdmin" class="form-control" accept="image/*"><button id="uploadBuktiBtn" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Kirim & Selesaikan</button></div><small id="selectedOrderIdDisplay" class="text-info d-block">Pilih pesanan untuk mengirim bukti.</small></div><div class="col-md-6 text-end"><button class="btn btn-danger" id="deleteAllOrdersBtn"><i class="fas fa-trash-alt me-2"></i>Hapus Semua Pesanan</button></div></div></div></div>
    </div>
    <div class="tab-pane fade" id="products-pane">
      <div class="row"><div class="col-lg-7"><div class="card"><div class="card-body"><h3>Tambah/Edit Produk</h3><form id="formProduk" class="row g-3 mb-4 p-3 border rounded bg-light"><div class="col-md-6"><label class="form-label">Kategori</label><input type="text" id="kategori" class="form-control" required></div><div class="col-md-6"><label class="form-label">Varian</label><input type="text" id="varian" class="form-control" required></div><div class="col-md-6"><label class="form-label">Harga</label><input type="number" id="harga" class="form-control" required></div><div class="col-md-6"><label class="form-label">Stok</label><input type="number" id="stok" class="form-control" placeholder="0" required></div><div class="col-12"><label class="form-label">Keterangan</label><textarea id="cara" class="form-control" rows="2" required></textarea></div><div class="col-12"><button type="submit" id="simpanProdukBtn" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Simpan Produk</button></div></form><h4>Daftar Produk (<small class="text-muted">Drag & drop untuk urutkan</small>)</h4><div id="product-container" class="p-2 border rounded bg-light"><p class="text-center p-4">Memuat produk...</p></div></div></div></div><div class="col-lg-5"><div class="card"><div class="card-body"><h3>Banner Promo</h3><form id="formPromo" class="mb-4 p-3 border rounded bg-light"><div class="mb-3"><label class="form-label">Judul Promo</label><input type="text" class="form-control" id="nama-promo" required></div><div class="mb-3"><label class="form-label">Deskripsi Promo</label><input type="text" class="form-control" id="deskripsi-promo" required></div><div class="mb-3"><label class="form-label">Waktu Berakhir</label><input type="datetime-local" id="akhir-promo" class="form-control" required></div><button type="submit" class="btn btn-warning w-100"><i class="fas fa-bolt me-2"></i>Buat Banner Promo</button></form><h4>Promo Aktif</h4><div id="daftar-banner-promo" style="max-height: 40vh; overflow-y: auto;"><p class="text-center p-4">Belum ada promo aktif.</p></div></div></div></div></div>
    </div>
    <div class="tab-pane fade" id="moderasi-pane">
        <div class="card"><div class="card-body"><h3>Peninjauan Testimoni</h3><form id="form-tambah-testimoni" class="row g-3 mb-4 p-3 border rounded bg-light"><div class="col-md-4"><label class="form-label">Nama Pelanggan</label><input type="text" id="testimoni-nama" class="form-control" required></div><div class="col-md-8"><label class="form-label">Isi Testimoni</label><input type="text" id="testimoni-isi" class="form-control" required></div><div class="col-12"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus-circle me-2"></i>Tambah Manual</button></div></form><h4>Daftar Testimoni Masuk</h4><div id="daftar-moderasi-testimoni"><p class="text-center text-muted p-4">Memuat testimoni...</p></div></div></div>
    </div>
    <div class="tab-pane fade" id="content-pane">
        <div class="card"><div class="card-body"><h3>Editor Konten Dinamis</h3><div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><b>Peringatan:</b> Fitur ini mengubah tampilan halaman secara langsung. Gunakan dengan hati-hati.</div><div class="mb-3"><label class="form-label">Pilih Halaman untuk Diedit:</label><select id="halamanDinamis" class="form-select w-auto"><option value="index">index.html</option><option value="status">status.html</option><option value="uplod">uplod.html</option></select></div><div class="mb-3"><label class="form-label">HTML</label><textarea id="editorHTML" rows="8" class="form-control font-monospace"></textarea></div><div class="mb-3"><label class="form-label">CSS</label><textarea id="editorCSS" rows="6" class="form-control font-monospace"></textarea></div><div class="mb-3"><label class="form-label">JavaScript</label><textarea id="editorJS" rows="8" class="form-control font-monospace"></textarea></div><button id="simpanDinamisBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Konten</button><hr><h4 class="mt-4">Konten Tersimpan</h4><div id="saved-dynamic-content-list"><p class="text-muted">Memuat daftar...</p></div></div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    // =================================================================
    // KONFIGURASI KUNCI API (PENTING!)
    // Ganti dengan kredensial dari project Firebase dan akun ImgBB Anda
    // =================================================================
    const firebaseConfig = {
      apiKey: "GANTI_DENGAN_API_KEY_ANDA",
      authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA",
      databaseURL: "GANTI_DENGAN_DATABASE_URL_ANDA",
      projectId: "GANTI_DENGAN_PROJECT_ID_ANDA",
    };
    const IMGBB_API_KEY = "GANTI_DENGAN_KUNCI_API_IMGBB_ANDA";
    
    // Inisialisasi Firebase
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');

    let selectedId = null;
    let allDataPesanan = {};
    let confirmModal;
    let activeTimers = {};

    // Fungsi UI
    const showToast = (message, type = 'success') => {
        const toastId = 'toast-' + Date.now();
        const toastColor = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary' }[type] || 'bg-secondary';
        const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white ${toastColor} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
        document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML);
        const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
        toast.show();
        document.getElementById(toastId).addEventListener('hidden.bs.toast', e => e.target.remove());
    };
    const showConfirm = (title, body) => {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = body;
        confirmModal.show();
        return new Promise(resolve => {
            const okBtn = document.getElementById('confirmModalOk');
            const onOkClick = () => { resolve(true); confirmModal.hide(); };
            okBtn.addEventListener('click', onOkClick, { once: true });
        });
    };
    
    // Fungsi Bantuan
    const formatRupiah = (n) => `Rp${(n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    const toBase64 = file => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => res(reader.result);
        reader.onerror = err => rej(err);
    });

    // Manajemen Pesanan
    window.beriHakDiskon = async (nomorWA, pesananId) => {
        if (!nomorWA || !(await showConfirm('Konfirmasi Diskon', `Beri hak diskon ke ${nomorWA}?`))) return;
        try {
            await db.ref('hakDiskon/' + nomorWA).set(true);
            showToast(`Sukses! ${nomorWA} kini berhak mendapat diskon.`);
            const btn = document.querySelector(`#discount-section-${pesananId} button`);
            if(btn) btn.outerHTML = `<span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Hak Diberikan</span>`;
        } catch (e) { showToast(`Gagal: ${e.message}`, 'error'); }
    };
    const renderPesanan = async () => { /* ... (Implementasi fungsi ini akan sama dengan yang sebelumnya, jadi saya singkat untuk kejelasan) ... */ };
    // (Implementasi lengkap untuk renderPesanan, setSelected, verifikasi, hapusPesanan, dll, sama seperti kode Anda sebelumnya)
    // Singkatnya, semua fungsi manajemen pesanan Anda sudah sangat baik.

    // Manajemen Produk
    // (Implementasi lengkap untuk loadProduk, handleSimpanProduk, editProduk, hapusProduk, ubahStok juga sudah baik)

    // Manajemen Promo
    const handleSimpanPromo = async (e) => {
        e.preventDefault();
        const judul = document.getElementById('nama-promo').value.trim();
        const deskripsi = document.getElementById('deskripsi-promo').value.trim();
        const waktuValue = document.getElementById('akhir-promo').value;
        if (!judul || !deskripsi || !waktuValue) return showToast('Lengkapi semua field promo!', 'error');
        
        await db.ref('bannerPromo').push({ judul, deskripsi, waktuBerakhir: new Date(waktuValue).toISOString() });
        showToast('Banner promo berhasil dibuat!');
        e.target.reset();
    };
    const renderBannerPromo = () => { /* ... (Logika sudah benar) ... */ };
    // (Implementasi lengkap untuk renderBannerPromo, jalankanHitungMundur, hapusPromo sudah baik)

    // Manajemen Testimoni
    // (Implementasi lengkap untuk ubahStatusTestimoni, hapusTestimoni, renderModerasiTestimoni, handleTambahTestimoni sudah baik)

    // Manajemen Konten Dinamis
    const halamanSelect = document.getElementById('halamanDinamis');
    const editorHTML = document.getElementById('editorHTML');
    const editorCSS = document.getElementById('editorCSS');
    const editorJS = document.getElementById('editorJS');

    const loadDinamisEditor = () => {
        const halaman = halamanSelect.value;
        if (!halaman) return;
        db.ref(`dynamicContent/${halaman}`).once('value', s => {
            const k = s.val() || { html: "", css: "", js: "" };
            editorHTML.value = k.html;
            editorCSS.value = k.css;
            editorJS.value = k.js;
        });
    };

    const handleSimpanDinamis = async () => {
        const halaman = halamanSelect.value;
        if (!halaman || !(await showConfirm('Simpan Konten?', `Yakin ingin menyimpan dan menimpa konten untuk halaman ${halaman}.html?`))) return;
        
        const konten = { html: editorHTML.value, css: editorCSS.value, js: editorJS.value };
        await db.ref(`dynamicContent/${halaman}`).set(konten);
        showToast('Konten dinamis berhasil disimpan!');
    };

    const renderSavedDynamicContent = () => {
        db.ref('dynamicContent').on('value', snapshot => {
            const listContainer = document.getElementById('saved-dynamic-content-list');
            const data = snapshot.val();
            if (!data) { listContainer.innerHTML = '<p class="text-muted">Belum ada konten dinamis.</p>'; return; }
            
            let html = '<ul class="list-group">';
            Object.keys(data).forEach(pageName => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center"><code>${pageName}.html</code><button class="btn btn-sm btn-outline-danger" onclick="hapusKontenDinamis('${pageName}')"><i class="fas fa-trash me-2"></i>Hapus</button></li>`;
            });
            listContainer.innerHTML = html + '</ul>';
        });
    };

    window.hapusKontenDinamis = async (pageName) => {
        if (!(await showConfirm('Hapus Konten?', `Yakin ingin menghapus konten untuk ${pageName}.html?`))) return;
        await db.ref(`dynamicContent/${pageName}`).remove();
        showToast(`Konten untuk ${pageName}.html dihapus.`);
    };

    // Inisialisasi Aplikasi
    document.addEventListener('DOMContentLoaded', () => {
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        // Listener untuk semua fungsi utama Anda
        // (contoh: global-refresh, filter, search, forms, dll)
        
        // Memuat data awal
        // renderPesanan();
        // loadProduk();
        // renderBannerPromo();
        // renderModerasiTestimoni();
        loadDinamisEditor();
        renderSavedDynamicContent();
        
        // Listener khusus untuk tab konten dinamis
        document.getElementById('simpanDinamisBtn').addEventListener('click', handleSimpanDinamis);
        halamanSelect.addEventListener('change', loadDinamisEditor);
    });

    // NOTE: Kode lengkap untuk fungsi-fungsi yang tidak berubah (renderPesanan, loadProduk, dll.)
    // tidak disertakan ulang di sini untuk keringkasan, karena logika di kode asli Anda sudah benar.
    // Anda bisa menyalinnya dari file asli Anda.
</script>
</body>
</html>
