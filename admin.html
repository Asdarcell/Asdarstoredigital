<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1, h4 { color: #333; }
    .card { margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    img { max-width: 100px; border-radius: 6px; border: 1px solid #ddd; }
    textarea { font-family: Consolas, monospace; resize: vertical; }
    .nav-tabs .nav-link.active { color: #007bff; border-color: #dee2e6 #dee2e6 #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Admin - Asdar Store</h1>

    <!-- Navigasi Tab -->
    <ul class="nav nav-tabs" id="adminTab" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#orders">Pesanan</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content">Konten</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#test">Uji Notifikasi</button></li>
    </ul>

    <!-- Konten Tab -->
    <div class="tab-content mt-3">
      <!-- Tab Pesanan -->
      <div class="tab-pane fade show active" id="orders">
        <div class="mb-2 d-flex">
          <select id="filterStatus" class="form-select me-2" style="width:auto">
            <option value="">Semua</option>
            <option value="Menunggu">Menunggu</option>
            <option value="Diproses">Diproses</option>
            <option value="Selesai">Selesai</option>
          </select>
          <input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama">
        </div>
        <div id="pesananList"></div>
        <hr>
        <h4>Upload Bukti (Admin)</h4>
        <div id="selectedOrderIdDisplay">Pesanan Dipilih: <i>Belum ada</i></div>
        <input type="file" id="buktiAdmin" class="form-control my-2" accept="image/*">
        <button class="btn btn-success" id="uploadBuktiBtn">Upload & Tandai Selesai</button>
      </div>

      <!-- Tab Konten -->
      <div class="tab-pane fade" id="content">
        <div class="mt-2">
          <select id="halamanDinamis" class="form-select mb-2" style="width:auto;">
            <option value="index">index.html</option>
            <option value="produk">produk.html</option>
            <option value="status">status.html</option>
          </select>
          <label>HTML</label>
          <textarea id="editorHTML" class="form-control mb-2" rows="4"></textarea>
          <label>CSS</label>
          <textarea id="editorCSS" class="form-control mb-2" rows="3"></textarea>
          <label>JS</label>
          <textarea id="editorJS" class="form-control mb-2" rows="3"></textarea>
          <button class="btn btn-primary" id="simpanDinamisBtn">Simpan Konten</button>
        </div>
      </div>

      <!-- Tab Uji -->
      <div class="tab-pane fade" id="test">
        <form id="formUjiNotif" class="mt-3">
          <input type="text" id="namaBuyerTest" class="form-control mb-2" placeholder="Nama Buyer" required>
          <input type="text" id="nomorBuyerTest" class="form-control mb-2" placeholder="Nomor WA 628xxx" required>
          <input type="text" id="produkDipilihTest" class="form-control mb-2" placeholder="Produk" required>
          <button class="btn btn-primary">Kirim Uji Notifikasi</button>
        </form>
        <div id="statusNotif" class="mt-2 text-success" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Script Firebase, Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
    const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
    const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
    const ADMIN_WA_NUMBER = "6281803004607";
    const BASE_URL = window.location.origin + "/";

    let selectedId = null;
    let allDataPesanan = {};

    const filterStatus = document.getElementById('filterStatus');
    const searchId = document.getElementById('searchId');
    const pesananList = document.getElementById('pesananList');
    const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');

    function formatRupiah(nom) {
      return nom.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function renderPesanan() {
      const filter = filterStatus.value;
      const search = searchId.value.toLowerCase();
      let html = '';
      const ids = Object.keys(allDataPesanan).sort((a,b) => new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu));
      for (const id of ids) {
        const p = allDataPesanan[id];
        if ((filter && p.status !== filter) || (search && !id.toLowerCase().includes(search) && !(p.nama || '').toLowerCase().includes(search))) continue;
        html += `<div class="card"><div class="card-body">
          <b>ID:</b> ${id}<br>
          <b>Nama:</b> ${p.nama}<br>
          <b>WA:</b> ${p.wa_aktif}<br>
          <b>Produk:</b> ${p.produk}<br>
          <b>Status:</b> ${p.status}<br>
          <b>Waktu:</b> ${new Date(p.waktu).toLocaleString('id-ID')}<br>
          ${p.buktiBayar ? `<a href="${p.buktiBayar}" target="_blank">Lihat Bukti</a><br>` : ''}
          ${p.buktiAdmin ? `<a href="${p.buktiAdmin}" target="_blank">Lihat Bukti Admin</a><br>` : ''}
          <button class="btn btn-sm btn-info me-1" onclick="setSelected('${id}')">Pilih</button>
          <button class="btn btn-sm btn-success me-1" onclick="verifikasi('${id}')">Proses</button>
          <button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')">Hapus</button>
        </div></div>`;
      }
      pesananList.innerHTML = html;
    }

    window.setSelected = id => {
      selectedId = id;
      selectedOrderIdDisplay.innerHTML = `Pesanan Dipilih: ${id}`;
    }

    window.verifikasi = async id => {
      await db.ref(`pesanan/${id}`).update({ status: "Diproses" });
      const p = allDataPesanan[id];
      if (p.wa_aktif) sendWhatsApp(p.wa_aktif, `Pesanan Anda (ID: ${id}) sedang diproses.`);
    }

    window.hapusPesanan = async id => {
      if (confirm(`Hapus pesanan ${id}?`)) await db.ref(`pesanan/${id}`).remove();
    }

    document.getElementById('uploadBuktiBtn').onclick = async () => {
      const file = document.getElementById('buktiAdmin').files[0];
      if (!file || !selectedId) return alert("Pilih pesanan dan file!");
      const base64 = await toBase64(file);
      const fd = new FormData();
      fd.append("key", IMGBB_API_KEY);
      fd.append("image", base64.split(',')[1]);
      const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: fd });
      const json = await res.json();
      if (!json.success) return alert("Gagal upload gambar");
      const url = json.data.url;
      await db.ref(`pesanan/${selectedId}`).update({ buktiAdmin: url, status: "Selesai" });
      const p = allDataPesanan[selectedId];
      const link = `${BASE_URL}status.html?id=${selectedId}`;
      if (p.wa_aktif) sendWhatsApp(p.wa_aktif, `Pesanan Anda selesai!\nCek bukti: ${link}`);
      alert("Bukti berhasil dikirim!");
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function sendWhatsApp(to, msg) {
      const fd = new FormData();
      fd.append("appkey", NGIRIMWA_APPKEY);
      fd.append("authkey", NGIRIMWA_AUTHKEY);
      fd.append("to", to);
      fd.append("message", msg);
      const res = await fetch("https://ngirimwa.com/api/send-message", {
        method: "POST",
        body: fd
      });
    }

    // Dinamis Konten
    const halamanSelect = document.getElementById('halamanDinamis');
    const editorHTML = document.getElementById('editorHTML');
    const editorCSS = document.getElementById('editorCSS');
    const editorJS = document.getElementById('editorJS');
    document.getElementById('simpanDinamisBtn').onclick = () => {
      const halaman = halamanSelect.value;
      db.ref(`dynamicContent/${halaman}`).set({
        html: editorHTML.value,
        css: editorCSS.value,
        js: editorJS.value
      }).then(() => alert("Konten disimpan!"));
    };
    halamanSelect.onchange = () => {
      db.ref(`dynamicContent/${halamanSelect.value}`).once('value').then(s => {
        const v = s.val() || { html: "", css: "", js: "" };
        editorHTML.value = v.html;
        editorCSS.value = v.css;
        editorJS.value = v.js;
      });
    };

    // Uji Notifikasi
    document.getElementById('formUjiNotif').onsubmit = async e => {
      e.preventDefault();
      const nama = document.getElementById('namaBuyerTest').value;
      const nomor = document.getElementById('nomorBuyerTest').value;
      const produk = document.getElementById('produkDipilihTest').value;
      const text = `🔔 *UJI NOTIFIKASI* 🔔\nNama: ${nama}\nWA: ${nomor}\nProduk: ${produk}`;
      await sendWhatsApp(ADMIN_WA_NUMBER, text);
      document.getElementById('statusNotif').innerText = "✅ Notifikasi dikirim!";
      document.getElementById('statusNotif').style.display = "block";
    }

    // Onload
    document.addEventListener('DOMContentLoaded', () => {
      db.ref('pesanan').on('value', snap => {
        allDataPesanan = snap.val() || {};
        renderPesanan();
      });
      halamanSelect.onchange();
    });
  </script>
</body>
</html>
