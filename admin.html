<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1, h3, h4 { color: #333; }
    .card { margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
    #galeri img:hover { transform: scale(1.05); }
    textarea { font-family: 'Consolas', 'Monaco', monospace; resize: vertical; }
    .nav-tabs .nav-link.active { color: #007bff; border-color: #dee2e6 #dee2e6 #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Admin - Asdar Store</h1>

    <!-- Navigasi Tab -->
    <ul class="nav nav-tabs" id="adminTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-tab-pane" type="button" role="tab">Pesanan</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-tab-pane" type="button" role="tab">Produk</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-tab-pane" type="button" role="tab">Konten</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="test-notif-tab" data-bs-toggle="tab" data-bs-target="#test-notif-tab-pane" type="button" role="tab">Uji Notifikasi</button>
      </li>
    </ul>

    <!-- Konten Tab -->
    <div class="tab-content" id="adminTabContent">
      <!-- Tab Pesanan -->
      <div class="tab-pane fade show active" id="orders-tab-pane" role="tabpanel">
        <!-- konten tab pesanan -->
      </div>

      <!-- Tab Produk -->
      <div class="tab-pane fade" id="products-tab-pane" role="tabpanel">
        <!-- konten tab produk -->
      </div>

      <!-- Tab Konten Dinamis -->
      <div class="tab-pane fade" id="content-tab-pane" role="tabpanel">
        <!-- konten tab konten -->
      </div>

      <!-- Tab Uji Notifikasi -->
      <div class="tab-pane fade" id="test-notif-tab-pane" role="tabpanel">
        <!-- konten tab notifikasi -->
      </div>
    </div>
  </div>

  <!-- Script Firebase, Bootstrap, dan Logika JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // 🔧 Konfigurasi Firebase & API
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
    const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
    const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
    const ADMIN_WA_NUMBER = "6281803004607";
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');
    
  let selectedId = null;
  let allDataPesanan = {};

  // Fungsi bantu
  function showAlert(msg) { alert(msg); }
  function formatRupiah(angka) {
    return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  async function sendWhatsApp(to, message) {
    const formData = new FormData();
    formData.append('appkey', NGIRIMWA_APPKEY);
    formData.append('authkey', NGIRIMWA_AUTHKEY);
    formData.append('to', to);
    formData.append('message', message);
    try {
      const res = await fetch('https://ngirimwa.com/api/send-message', {
        method: 'POST',
        body: formData
      });
      const json = await res.json();
      if (json.status !== 'success') throw new Error(json.message || "Gagal kirim WA");
      return json;
    } catch (err) {
      console.error("WA Send Error:", err);
      throw err;
    }
  }

  // Load dan Simpan Konten Dinamis
  const halamanSelect = document.getElementById('halamanDinamis');
  const editorHTML = document.getElementById('editorHTML');
  const editorCSS = document.getElementById('editorCSS');
  const editorJS = document.getElementById('editorJS');
  const simpanDinamisBtn = document.getElementById('simpanDinamisBtn');

  function loadDinamis() {
    const halaman = halamanSelect.value;
    db.ref(`dynamicContent/${halaman}`).once('value').then(s => {
      const k = s.val() || {html:"",css:"",js:""};
      editorHTML.value = k.html;
      editorCSS.value = k.css;
      editorJS.value = k.js;
    });
  }

  simpanDinamisBtn.addEventListener('click', () => {
    const halaman = halamanSelect.value;
    db.ref(`dynamicContent/${halaman}`).set({
      html: editorHTML.value,
      css: editorCSS.value,
      js: editorJS.value
    }).then(() => showAlert("Konten dinamis disimpan!"));
  });

  halamanSelect.addEventListener('change', loadDinamis);

  // ====================
  // === PESANAN ===
  const filterStatus = document.getElementById('filterStatus');
  const searchId = document.getElementById('searchId');
  const pesananList = document.getElementById('pesananList');
  const uploadBuktiBtn = document.getElementById('uploadBuktiBtn');
  const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');

  function renderPesanan() {
    const filter = filterStatus.value;
    const search = searchId.value.toLowerCase();
    let html = '';
    const sortedIds = Object.keys(allDataPesanan).sort((a, b) =>
      new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu));
    for (const id of sortedIds) {
      const p = allDataPesanan[id];
      if ((filter && p.status !== filter) || (search && !id.toLowerCase().includes(search) && !(p.nama || '').toLowerCase().includes(search))) continue;
      html += `<div class="card"><div class="card-body">
      <b>ID:</b> ${id}<br/>
      <b>Nama:</b> ${p.nama}<br/>
      <b>WA:</b> ${p.wa_aktif}<br/>
      <b>Produk:</b> ${p.produk}<br/>
      <b>Status:</b> ${p.status}<br/>
      <b>Waktu:</b> ${new Date(p.waktu).toLocaleString('id-ID')}<br/>
      ${p.buktiBayar ? `<a href="${p.buktiBayar}" target="_blank">Lihat Bukti</a><br/>` : ''}
      ${p.buktiAdmin ? `<a href="${p.buktiAdmin}" target="_blank">Lihat Bukti Admin</a><br/>` : ''}
      <div class="mt-2">
        <button class="btn btn-sm btn-info me-1" onclick="setSelected('${id}')">Pilih</button>
        <button class="btn btn-sm btn-success me-1" onclick="verifikasi('${id}')">Proses</button>
        <button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')">Hapus</button>
      </div>
      </div></div>`;
    }
    pesananList.innerHTML = html;
  }

  window.setSelected = (id) => {
    selectedId = id;
    selectedOrderIdDisplay.textContent = `Pesanan Dipilih: ${id}`;
    showAlert(`Pesanan ${id} dipilih.`);
  };

  window.verifikasi = async (id) => {
    if (!confirm(`Ubah status pesanan ${id} menjadi "Diproses"?`)) return;
    await db.ref(`pesanan/${id}`).update({ status: "Diproses" });
    const pesanan = allDataPesanan[id];
    if (pesanan.wa_aktif) sendWhatsApp(pesanan.wa_aktif, `Hai ${pesanan.nama}, pesanan Anda (ID: *${id}*) sedang kami *PROSES*.`);
    showAlert(`Pesanan ${id} diproses.`);
  };

  window.hapusPesanan = async (id) => {
    if (confirm(`Hapus pesanan ID ${id}?`)) await db.ref(`pesanan/${id}`).remove();
  };

  window.hapusSemuaPesanan = async () => {
    if (confirm('Hapus semua pesanan?')) await db.ref('pesanan').remove();
  };

  // Upload bukti oleh admin
  uploadBuktiBtn.addEventListener('click', async () => {
    const file = document.getElementById('buktiAdmin').files[0];
    if (!file || !selectedId) return showAlert("Pilih pesanan dan file bukti!");
    const formData = new FormData();
    formData.append("key", IMGBB_API_KEY);
    formData.append("image", await toBase64(file).then(r=>r.split(',')[1]));
    try {
      const res = await fetch(`https://api.imgbb.com/1/upload`, { method: "POST", body: formData });
      const json = await res.json();
      if (!json.success) throw new Error(json.error.message);
      const imageUrl = json.data.url;
      await db.ref(`pesanan/${selectedId}`).update({
        buktiAdmin: imageUrl,
        status: "Selesai"
      });
      const pesanan = allDataPesanan[selectedId];
      const linkStatus = `${BASE_URL}status.html?id=${selectedId}`;
      const pesanUser = `Hai ${pesanan.nama}, pesanan Anda (ID: *${selectedId}*) telah *SELESAI*. Lihat bukti di:\n${linkStatus}`;
      if (pesanan.wa_aktif) sendWhatsApp(pesanan.wa_aktif, pesanUser);
      showAlert("Bukti berhasil dikirim!");
    } catch (err) {
      showAlert(`Gagal: ${err.message}`);
    }
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ================
  // === Uji Notif ===
  document.getElementById('formUjiNotif').addEventListener('submit', async (e) => {
    e.preventDefault();
    const nama = document.getElementById('namaBuyerTest').value;
    const nomor = document.getElementById('nomorBuyerTest').value;
    const produk = document.getElementById('produkDipilihTest').value;
    const statusDiv = document.getElementById('statusNotif');
    statusDiv.style.display = 'block';
    statusDiv.textContent = 'Mengirim notifikasi uji coba...';
    try {
      await sendWhatsApp(ADMIN_WA_NUMBER, `🔔 *UJI NOTIFIKASI* 🔔\nNama: ${nama}\nWA: ${nomor}\nProduk: ${produk}`);
      statusDiv.textContent = '✅ Notifikasi berhasil dikirim!';
    } catch (err) {
      statusDiv.textContent = '❌ Gagal kirim: ' + err.message;
    }
  });

  // Load awal saat halaman dibuka
  document.addEventListener('DOMContentLoaded', () => {
    loadDinamis();
    db.ref('pesanan').on('value', s => {
      allDataPesanan = s.val() || {};
      renderPesanan();
    });
    filterStatus.addEventListener('change', renderPesanan);
    searchId.addEventListener('input', renderPesanan);
  });
</script>
</html>
