<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 15px; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; }
    textarea { font-family: monospace; }
  </style>
</head>
<body>
<div class="container"> 
 <h1>Dashboard Admin - Asdar Store</h1>

  <!-- Pilih halaman dinamis -->
  <div class="mb-3">
    <label for="halamanDinamis" class="form-label"><b>Pilih Halaman untuk Edit Konten Dinamis:</b></label>
    <select id="halamanDinamis" class="form-select w-auto">
      <option value="index">index.html</option>
      <option value="admin">admin.html</option>
      <option value="status">status.html</option>
      <option value="upload">upload.html</option>
    </select>
  </div>

 <!-- Ace Editor CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>

<script>
  const editorHTML = ace.edit("editorHTML", { mode: "ace/mode/html", theme: "ace/theme/monokai" });
  const editorCSS  = ace.edit("editorCSS",  { mode: "ace/mode/css",  theme: "ace/theme/monokai" });
  const editorJS   = ace.edit("editorJS",   { mode: "ace/mode/javascript", theme: "ace/theme/monokai" });

  document.getElementById("formFiturDinamis").addEventListener("submit", function(e) {
    e.preventDefault();
    const halaman = document.getElementById("halamanFitur").value.trim();
    const html = editorHTML.getValue();
    const css = editorCSS.getValue();
    const js = editorJS.getValue();

    if (!halaman) return alert("âš ï¸ Nama halaman kosong!");

    firebase.database().ref("fiturDinamis/" + halaman).set({ html, css, js })
      .then(() => {
        alert("âœ… Fitur disimpan!");
        tampilkanPreview(html, css, js);
      });
  });

  function tampilkanPreview(html, css, js) {
    const output = document.getElementById("previewDinamis");
    output.innerHTML = html;

    const styleTag = document.createElement("style");
    styleTag.innerHTML = css;
    output.appendChild(styleTag);

    const scriptTag = document.createElement("script");
    scriptTag.innerHTML = js;
    output.appendChild(scriptTag);
  }

  function hapusFiturDinamis() {
    const halaman = document.getElementById("halamanFitur").value.trim();
    if (!halaman) return alert("â— Masukkan nama halaman!");

    if (confirm("Yakin hapus fitur dinamis ini?")) {
      firebase.database().ref("fiturDinamis/" + halaman).remove()
        .then(() => {
          alert("âœ… Fitur dihapus.");
          editorHTML.setValue(""); editorCSS.setValue(""); editorJS.setValue("");
          document.getElementById("previewDinamis").innerHTML = "";
        });
    }
  }
</script>

<script>
  const currentHalaman = location.pathname.split("/").pop(); // contoh: index.html
  firebase.database().ref("fiturDinamis/" + currentHalaman).once("value").then(snap => {
    const fitur = snap.val();
    if (!fitur) return;

    if (fitur.html) document.body.insertAdjacentHTML("beforeend", fitur.html);
    if (fitur.css) {
      const styleTag = document.createElement("style");
      styleTag.innerHTML = fitur.css;
      document.head.appendChild(styleTag);
    }
    if (fitur.js) {
      const scriptTag = document.createElement("script");
      scriptTag.innerHTML = fitur.js;
      document.body.appendChild(scriptTag);
    }
  });
</script>

  <!-- Filter & Pencarian Pesanan -->
  <div class="row mb-3">
    <div class="col-md-3">
      <select id="filterStatus" class="form-select">
        <tiontion value="">Filter Semua Status</option>
        <option value="Belum Bayar">Belum Bayar</option>
        <option value="Sudah Bayar">Sudah Bayar</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan" />
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button>
    </div>
    <div class="col-md-3">
      <button class="btn btn-warning w-100" id="refreshDataBtn">Refresh Data</button>
    </div>
  </div>

  <!-- Daftar Pesanan -->
  <div id="pesananList"></div>

  <!-- Upload Bukti Admin -->
  <h3>Upload Bukti Admin ke Pembeli</h3>
  <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*" />
  <button id="uploadBuktiBtn" class="btn btn-primary mb-4">Kirim Bukti & Selesaikan</button>

  <hr>

  <!-- Form Produk -->
  <h3>Tambah / Edit Produk</h3>
  <form id="formProduk" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required />
    </div>
    <div class="col-md-3">
      <input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required />
    </div>
    <div class="col-md-2">
      <input type="text" id="harga" class="form-control" placeholder="Harga (contoh Rp 30.000)" required />
    </div>
    <div class="col-md-4">
      <input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required />
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-success">Simpan / Edit Produk</button>
    </div>
  </form>

 <!-- Daftar Produk -->
  <h4>Daftar Produk</h4>
  <ul id="daftarProduk" class="list-group mb-5"></ul>
  
  //form fitur dinamis
<h4>ğŸ§© Editor Fitur Dinamis</h4>
<form id="formFiturDinamis" class="mb-4">
  <input class="form-control mb-2" id="halamanFitur" placeholder="Contoh: index.html" required />

  <label>HTML</label>
  <div id="editorHTML" style="height: 150px; width: 100%;" class="mb-2"></div>

  <label>CSS</label>
  <div id="editorCSS" style="height: 100px; width: 100%;" class="mb-2"></div>

  <label>JS</label>
  <div id="editorJS" style="height: 100px; width: 100%;" class="mb-2"></div>

  <button type="submit" class="btn btn-success">ğŸ’¾ Simpan Fitur</button>
  <button type="button" class="btn btn-danger" onclick="hapusFiturDinamis()">ğŸ—‘ï¸ Hapus</button>
</form>

<h5>ğŸ“º Preview Langsung</h5>
<div id="previewDinamis" class="border p-3 bg-light rounded"></div>

  <!-- Galeri Bukti Bayar -->
  <h4>Galeri Bukti Transfer</h4>
  <div id="galeri" class="d-flex flex-wrap"></div>

  <hr/>
  <h3>Hapus Semua Data</h3>
  <div class="d-grid gap-2 d-md-block mb-5">
    <button class="btn btn-danger mb-2" onclick="hapusSemuaPesanan()">ğŸ§¹ Hapus Semua Pesanan</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaProduk()">ğŸ§¹ Hapus Semua Produk</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaGaleri()">ğŸ§¹ Hapus Semua Bukti Transfer</button>
    <button class="btn btn-dark" onclick="hapusSemuaData()">ğŸ”¥ Hapus SEMUA DATA</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
  authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
  databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
  projectId: "asdarstoredigitalll-d89c4",
  storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
  messagingSenderId: "220670500351",
  appId: "1:220670500351:web:5737ae5958a6f5a67d5bca",
  measurementId: "G-CMRW37J19G"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

function kirimNotifWA(nomor, pesan) {
  fetch("https://api.ngirimwa.com/sendText", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      appkey: "ab3727c5-e0be-40f9-bb3f-25d93b029f7a",
      authkey: "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq",
      to: nomor,
      message: pesan
    })
  });
}

const notifAPI = {
  appkey: "ab3727c5-e0be-40f9-bb3f-25d93b029f7a",
  authkey: "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq",
  nomorAdmin: "6281803004607"
};

let selectedId = null;
let allDataPesanan = {};
let allDataDinamis = {};

// ====== Fitur Dinamis ======
const halamanSelect = document.getElementById('halamanDinamis');
const editorHTML = document.getElementById('editorHTML');
const editorCSS = document.getElementById('editorCSS');
const editorJS = document.getElementById('editorJS');
const simpanDinamisBtn = document.getElementById('simpanDinamisBtn');

function loadDinamis() {
  const halaman = halamanSelect.value;
  db.ref(`dinamis/${halaman}`).once('value').then(snapshot => {
    const konten = snapshot.val() || {html: "", css: "", js: ""};
    editorHTML.value = konten.html;
    editorCSS.value = konten.css;
    editorJS.value = konten.js;
  });
}

halamanSelect.addEventListener('change', loadDinamis);

simpanDinamisBtn.addEventListener('click', () => {
  const halaman = halamanSelect.value;
  const data = {
    html: editorHTML.value,
    css: editorCSS.value,
    js: editorJS.value
  };
  db.ref(`dinamis/${halaman}`).set(data)
    .then(() => alert(`âœ… Konten dinamis ${halaman} berhasil disimpan.`))
    .catch(err => alert(`âŒ Gagal simpan konten: ${err.message}`));
});

// ====== Tampilkan Pesanan ======
function tampilkanPesanan() {
  db.ref('pesanan').once('value').then(snapshot => {
    allDataPesanan = snapshot.val() || {};
    const filter = document.getElementById('filterStatus').value;
    const search = document.getElementById('searchId').value.toLowerCase();
    let html = '';
    for (let id in allDataPesanan) {
      const p = allDataPesanan[id];
      if (filter && p.status !== filter) continue;
      if (search && !id.toLowerCase().includes(search)) continue;

      html += `
      <div class="card">
        <div class="card-body">
          <b>ID:</b> ${id}<br/>
          <b>Nama:</b> ${p.nama}<br/>
          <b>WA Aktif:</b> ${p.wa_aktif || '-'}<br/>
          <b>Nomor HP (Buyer):</b> ${p.nomor || '-'}<br/>
          <b>Kategori:</b> ${p.kategori}<br/>
          <b>Produk:</b> ${p.produk}<br/>
          <b>Status:</b> ${p.status}<br/>
          ${p.buktiBayar ? `<b>Bukti Bayar:</b><br/><img src="${p.buktiBayar}" alt="Bukti Bayar" class="img-thumbnail mb-2" />` : ''}
          ${p.buktiAdmin ? `<b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" alt="Bukti Admin" class="img-thumbnail mb-2" />` : ''}
          <br/>
          <button class="btn btn-sm btn-warning" onclick="setSelected('${id}')">ğŸ“¤ Pilih Pesanan</button>
          <button class="btn btn-sm btn-success" onclick="verifikasi('${id}')">âœ… Proses</button>
          <button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')">ğŸ—‘ï¸ Hapus</button>
        </div>
      </div>`;
    }
    document.getElementById('pesananList').innerHTML = html;
  });
}

function setSelected(id) {
  selectedId = id;
  alert("Pesanan dipilih: " + id);
}

function verifikasi(id) {
  db.ref('pesanan/' + id).update({ status: "Diproses" }).then(() => {
    kirimNotifWA(`âœ… Pesanan ${id} sedang diproses.`);
    tampilkanPesanan();
  });
}

// ====== Upload Bukti Admin + Kirim Bukti via WA aktif ======
async function uploadBukti() {
  const fileInput = document.getElementById('buktiAdmin');
  const file = fileInput.files[0];
  if (!file) return alert("â— Pilih gambar terlebih dahulu!");
  if (!selectedId) return alert("â— Pilih pesanan dulu!");

  const pesanan = allDataPesanan[selectedId];
  if (!pesanan) return alert("â— Pesanan tidak ditemukan!");

  // Ambil data pesanan dari Firebase
  const snapshot = await db.ref("pesanan/" + selectedId).once("value");
  const data = snapshot.val();

  let nomorWA = data.wa_aktif || "";
  if (!nomorWA) return alert("âŒ WA Aktif tidak tersedia di pemesan ini.");
  if (nomorWA.startsWith("0")) {
    nomorWA = "62" + nomorWA.slice(1); // ubah 08... jadi 628...
  }

  // Upload gambar ke imgbb
  const formData = new FormData();
  formData.append("image", file);
  const imgbbApiKey = "4bb65566f2b6bad0aef16ac5ae6b2fbc";

  try {
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method: "POST",
      body: formData
    });
    const json = await res.json();
    if (!json.success) throw new Error("Upload gagal");

    const imageUrl = json.data.url;

    // Simpan ke Firebase
    await db.ref('pesanan/' + selectedId).update({
      buktiAdmin: imageUrl,
      status: "Selesai"
    });

    // Kirim link status ke pembeli via WhatsApp
    const linkStatus = `https://asdarcell.github.io/Asdarstoredigital/status.html?id=${selectedId}`;
    const pesanUser = `âœ… Pesanan kamu dengan ID: ${selectedId} telah *SELESAI*.\n\nğŸ“„ Cek status & bukti transaksi:\n${linkStatus}\n\nTerima kasih telah berbelanja di Asdar Store! ğŸ˜Š`;
    window.open(`https://wa.me/${nomorWA}?text=${encodeURIComponent(pesanUser)}`, '_blank');

    // Kirim notifikasi ke admin via API NgirimWA
    const pesanAdmin = `ğŸ“¦ Admin telah upload bukti untuk pesanan ID: ${selectedId}`;
    await kirimNotifWA("6281803004607", pesanAdmin); // Nomor admin

    alert("âœ… Bukti berhasil dikirim ke pembeli dan status diupdate.");
    selectedId = null;
    fileInput.value = "";
    tampilkanPesanan();
  } catch (err) {
    alert("âŒ Upload Gagal: " + err.message);
  }
}
// ====== Export CSV Pesanan ======
function exportCSV() {
  let csv = "ID,Nama,Nomor WA Aktif,Nomor HP,Kategori,Produk,Status,Waktu\n";
  for (let id in allDataPesanan) {
    const p = allDataPesanan[id];
    csv += `"${id}","${p.nama}","${p.nomorWAaktif || ''}","${p.nomor || ''}","${p.kategori}","${p.produk}","${p.status}","${p.waktu || ''}"\n`;
  }
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pesanan.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
}
  
function formatRupiah(angka) {
  return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
  
// ====== Produk ======
function tampilkanProduk() {
  db.ref('produk').once('value').then(snapshot => {
    const produk = snapshot.val() || {};
    const list = document.getElementById('daftarProduk');
    list.innerHTML = "";
    for (const kategori in produk) {
      for (const varian in produk[kategori]) {
        const p = produk[kategori][varian];
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <b>${kategori} > ${varian}</b><br/>
           Harga: Rp${formatRupiah(p.harga)}<br/>
            ${p.cara}
          </div>
          <button class="btn btn-sm btn-danger" onclick="hapusProduk('${kategori}','${varian}')">ğŸ—‘ï¸ Hapus</button>`;
        list.appendChild(li);
      }
    }
  });
}

function hapusProduk(kategori, varian) {
  if (confirm(`Hapus produk ${varian} dari kategori ${kategori}?`)) {
    db.ref(`produk/${kategori}/${varian}`).remove().then(() => {
      alert("âœ… Produk dihapus.");
      tampilkanProduk();
    });
  }
}

document.getElementById('formProduk').addEventListener('submit', function(e) {
  e.preventDefault();

  const kategori = document.getElementById('kategori').value.trim();
  const varian = document.getElementById('varian').value.trim();
  let harga = document.getElementById('harga').value;
  harga = harga.replace(/\D/g, ""); // Hapus titik
  harga = parseInt(harga);
  const cara = document.getElementById('cara').value.trim();

  if (!kategori || !varian || !harga || !cara) {
    return alert("â— Semua field wajib diisi.");
  }

  db.ref(`produk/${kategori}/${varian}`).set({ harga, cara }).then(() => {
    alert("âœ… Produk berhasil ditambahkan.");
    this.reset();
    tampilkanProduk();
  });
});

// ====== Galeri Bukti Bayar ======
function tampilkanGaleri() {
  db.ref('pesanan').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const galeri = document.getElementById('galeri');
    galeri.innerHTML = "";
    for (const id in data) {
      if (data[id].buktiBayar) {
        const img = document.createElement('img');
        img.src = data[id].buktiBayar;
        img.alt = "Bukti Bayar " + id;
        galeri.appendChild(img);
      }
    }
  });
}

// ====== Hapus Semua Data ======
function hapusSemuaPesanan() {
  if (confirm("Yakin ingin menghapus SEMUA pesanan?")) {
    db.ref('pesanan').remove().then(() => {
      alert("âœ… Semua pesanan dihapus.");
      tampilkanPesanan();
      tampilkanGaleri();
    });
  }
}

function hapusSemuaProduk() {
  if (confirm("Yakin ingin menghapus SEMUA produk?")) {
    db.ref('produk').remove().then(() => {
      alert("âœ… Semua produk dihapus.");
      tampilkanProduk();
    });
  }
}

function hapusSemuaGaleri() {
  if (confirm("Yakin ingin menghapus SEMUA bukti transfer dari galeri?")) {
    db.ref('pesanan').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const promises = [];
      for (const id in data) {
        promises.push(db.ref(`pesanan/${id}/buktiBayar`).remove());
      }
      Promise.all(promises).then(() => {
        alert("âœ… Semua bukti transfer dihapus.");
        tampilkanGaleri();
      });
    });
  }
}

function hapusSemuaData() {
  if (confirm("Yakin HAPUS SEMUA DATA PESANAN + PRODUK + BUKTI?")) {
    db.ref().remove().then(() => {
      alert("ğŸ”¥ SEMUA DATA telah dihapus.");
      tampilkanPesanan();
      tampilkanProduk();
      tampilkanGaleri();
    });
  }
}

// ====== Event Listener ======
document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
document.getElementById('searchId').addEventListener('input', tampilkanPesanan);
document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
document.getElementById('uploadBuktiBtn').addEventListener('click', uploadBukti);

// Inisialisasi tampilan awal
tampilkanPesanan();
tampilkanProduk();
tampilkanGaleri();
loadDinamis();

// ====== Fungsi Load Konten Dinamis ======
function loadDinamis() {
  // Contoh load dinamis produk (bisa dikembangkan sesuai kebutuhan)
  db.ref('dinamis/admin').once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data) return;

    if (data.html) {
      // Contoh render ke elemen tertentu, misal ke div #dinamisAdminHTML (textarea)
      const elHtml = document.getElementById('dinamisAdminHTML');
      if (elHtml) elHtml.value = data.html;
    }
    if (data.css) {
      const elCss = document.getElementById('dinamisAdminCSS');
      if (elCss) elCss.value = data.css;
    }
    if (data.js) {
      const elJs = document.getElementById('dinamisAdminJS');
      if (elJs) elJs.value = data.js;
    }
  });
}

// Pastikan juga fungsi render preview konten dinamis ada,
// seperti pada kode yang saya kirim sebelumnya.

// Jika kamu belum menambahkan preview dinamis,
// bisa menggunakan fungsi seperti ini:

function renderDinamisPreview() {
  db.ref('dinamis/admin').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const preview = document.getElementById('previewDinamisAdmin');
    if (!preview) return;

    if (!data.html && !data.css && !data.js) {
      preview.innerHTML = "<i>Tidak ada konten dinamis.</i>";
      return;
    }

    const styleTag = `<style>${data.css || ''}</style>`;
    const htmlContent = data.html || '';

    // Gunakan iframe untuk isolasi script
    const iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = '300px';
    preview.innerHTML = '';
    preview.appendChild(iframe);

    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open();
    doc.write(`
      <!DOCTYPE html>
      <html><head>${styleTag}</head>
      <body>${htmlContent}
      <script>${data.js || ''}<\/script>
      </body></html>
    `);
    doc.close();
  });
}

// Panggil preview setelah load dinamis selesai
loadDinamis();
renderDinamisPreview();
</script>
</body>
</html>
