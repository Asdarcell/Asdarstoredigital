<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Admin Lengkap - Asdar Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 20px; background: #f4f4f4; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    textarea, input[type=text], input[type=number] { width: 100%; }
    .section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .btn-sm { padding: .25rem .5rem; font-size: .75rem; }
    .overflow-auto { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
<div class="container">
  <h1>Dashboard Admin Lengkap - Asdar Store</h1>

  <!-- PENGATURAN UMUM -->
  <div class="section">
    <h4>Pengaturan Umum</h4>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="fiturStatus" />
      <label class="form-check-label" for="fiturStatus">Tampilkan Cek Status Pesanan</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="fiturTesti" />
      <label class="form-check-label" for="fiturTesti">Tampilkan Testimoni Pelanggan</label>
    </div>
    <label class="mt-3">Banner Promo:</label>
    <textarea id="banner" placeholder="Contoh: Promo Diskon 20% sampai 10 Juli!"></textarea>
    <button class="btn btn-success mt-2" onclick="simpanPengaturan()">Simpan Pengaturan</button>
  </div>

  <!-- PRODUK -->
  <div class="section">
    <h4>Tambah / Edit Produk</h4>
    <form id="formProduk" class="row g-3 mb-3">
      <div class="col-md-3"><input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required /></div>
      <div class="col-md-3"><input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required /></div>
      <div class="col-md-2"><input type="number" id="harga" class="form-control" placeholder="Harga (Rp)" required /></div>
      <div class="col-md-4"><input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required /></div>
      <div class="col-12"><button type="submit" class="btn btn-primary">Simpan / Edit Produk</button></div>
    </form>
    <ul class="list-group overflow-auto" id="daftarProduk"></ul>
  </div>

  <!-- FITUR BEBAS -->
  <div class="section">
    <h4>Fitur Bebas (Custom Section)</h4>
    <div class="input-group mb-2">
      <input type="text" class="form-control" id="judulFitur" placeholder="Judul Fitur (misal: Cara Bayar)" />
    </div>
    <div class="mb-2">
      <textarea id="isiFitur" placeholder="Isi HTML fitur bebas di sini"></textarea>
    </div>
    <button class="btn btn-secondary" onclick="tambahFitur()">Tambah / Perbarui Fitur</button>
    <ul class="list-group mt-3 overflow-auto" id="daftarFitur"></ul>
  </div>

  <!-- DAFTAR PESANAN -->
  <div class="section">
    <h4>Daftar Pesanan</h4>
    <ul class="list-group overflow-auto" id="daftarPesanan"></ul>
  </div>

  <!-- UPLOAD BUKTI TRANSAKSI -->
  <div class="section">
    <h4>Upload Bukti Transaksi Selesai</h4>
    <form id="formBukti">
      <div class="mb-3">
        <label for="noHpBukti" class="form-label">Nomor HP Pembeli</label>
        <input type="text" id="noHpBukti" class="form-control" placeholder="Masukkan nomor HP pembeli" required />
      </div>
      <div class="mb-3">
        <label for="fileBukti" class="form-label">Pilih File Bukti Transfer</label>
        <input type="file" id="fileBukti" class="form-control" accept="image/*" required />
      </div>
      <button type="submit" class="btn btn-success">Upload Bukti</button>
    </form>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  // Firebase config & init
  const firebaseConfig = {
    apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
    authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
    databaseURL: "https://asdarstoredigitalll-default-rtdb.firebaseio.com",
    projectId: "asdarstoredigitalll-d89c4",
    storageBucket: "asdarstoredigitalll.appspot.com",
    messagingSenderId: "220670500351",
    appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // === PENGATURAN UMUM ===
  function simpanPengaturan() {
    const data = {
      fiturStatus: document.getElementById("fiturStatus").checked,
      fiturTesti: document.getElementById("fiturTesti").checked,
      banner: document.getElementById("banner").value.trim()
    };
    db.ref("pengaturan").set(data).then(() => alert("✅ Pengaturan disimpan!"));
  }
  db.ref("pengaturan").once("value").then(snap => {
    const data = snap.val() || {};
    document.getElementById("fiturStatus").checked = data.fiturStatus || false;
    document.getElementById("fiturTesti").checked = data.fiturTesti || false;
    document.getElementById("banner").value = data.banner || "";
  });

  // === PRODUK ===
  document.getElementById("formProduk").addEventListener("submit", e => {
    e.preventDefault();
    const kategori = document.getElementById("kategori").value.trim();
    const varian = document.getElementById("varian").value.trim();
    const harga = document.getElementById("harga").value.trim();
    const cara = document.getElementById("cara").value.trim();
    if (!kategori || !varian || !harga || !cara) return alert("❗ Semua kolom wajib diisi!");
    db.ref("produk/" + kategori + "/" + varian).set({ harga, cara }).then(() => {
      alert("✅ Produk disimpan!");
      tampilkanProduk();
      e.target.reset();
    });
  });
  function tampilkanProduk() {
    db.ref("produk").once("value").then(snap => {
      const data = snap.val() || {};
      const list = document.getElementById("daftarProduk");
      list.innerHTML = "";
      for (let kat in data) {
        for (let varian in data[kat]) {
          const item = data[kat][varian];
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<div><b>${kat}</b> - ${varian}<br><small>Rp${item.harga} • ${item.cara}</small></div>
            <button class="btn btn-sm btn-danger" onclick="hapusProduk('${kat}', '${varian}')">Hapus</button>`;
          list.appendChild(li);
        }
      }
    });
  }
  function hapusProduk(kat, varian) {
    if (confirm("Yakin hapus produk ini?")) {
      db.ref("produk/" + kat + "/" + varian).remove().then(() => {
        alert("🗑️ Produk dihapus!");
        tampilkanProduk();
      });
    }
  }
  tampilkanProduk();

  // === FITUR BEBAS ===
  function tambahFitur() {
    const judul = document.getElementById("judulFitur").value.trim();
    const isi = document.getElementById("isiFitur").value.trim();
    if (!judul || !isi) return alert("❗ Judul dan isi wajib diisi");
    db.ref("fiturCustom/" + judul).set(isi).then(() => {
      alert("✅ Fitur ditambahkan");
      tampilkanFitur();
      document.getElementById("judulFitur").value = "";
      document.getElementById("isiFitur").value = "";
    });
  }
  function hapusFitur(judul) {
    if (confirm("Hapus fitur " + judul + "?")) {
      db.ref("fiturCustom/" + judul).remove().then(() => {
        alert("✅ Fitur dihapus");
        tampilkanFitur();
      });
    }
  }
  function tampilkanFitur() {
    db.ref("fiturCustom").once("value").then(snap => {
      const list = document.getElementById("daftarFitur");
      list.innerHTML = "";
      const data = snap.val() || {};
      for (let j in data) {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between";
        li.innerHTML = `<div><b>${j}</b></div><button class='btn btn-danger btn-sm' onclick="hapusFitur('${j}')">Hapus</button>`;
        list.appendChild(li);
      }
    });
  }
  tampilkanFitur();

  // === DAFTAR PESANAN ===
  function tampilkanPesanan() {
    db.ref("pesanan").once("value").then(snap => {
      const data = snap.val() || {};
      const list = document.getElementById("daftarPesanan");
      list.innerHTML = "";
      if (Object.keys(data).length === 0) {
        list.innerHTML = "<li class='list-group-item'>Belum ada pesanan.</li>";
        return;
      }
      for (const id in data) {
        const p = data[id];
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
          <div><b>ID Pesanan:</b> ${id}</div>
          <div><b>Nama:</b> ${p.nama || '-'} | <b>HP:</b> ${p.hp || '-'}</div>
          <div><b>Produk:</b> ${p.produk || '-'}</div>
          <div><b>Status:</b> ${p.status || 'Menunggu'}</div>
          <div><b>Bukti Bayar:</b> ${p.buktiUrl ? `<a href="${p.buktiUrl}" target="_blank">Lihat Bukti</a>` : '-'}</div>
          <button class="btn btn-sm btn-danger mt-2" onclick="hapusPesanan('${id}')">Hapus Pesanan</button>
        `;
        list.appendChild(li);
      }
    });
  }
  function hapusPesanan(id) {
    if(confirm("Yakin hapus pesanan ini?")) {
      db.ref("pesanan/" + id).remove().then(() => {
        alert("Pesanan dihapus.");
        tampilkanPesanan();
      });
    }
  }
  tampilkanPesanan();

  // === UPLOAD BUKTI TRANSAKSI ===
  document.getElementById("formBukti").addEventListener("submit", e => {
    e.preventDefault();
    const noHp = document.getElementById("noHpBukti").value.trim();
    const file = document.getElementById("fileBukti").files[0];
    if (!noHp || !file) return alert("Nomor HP dan file bukti wajib diisi");

    const fileName = `bukti/${noHp}_${Date.now()}_${file.name}`;
    const storageRef = storage.ref(fileName);

    const uploadTask = storageRef.put(file);
    uploadTask.on('state_changed', 
      (snapshot) => { /* bisa buat progress bar kalau mau */ },
      (error) => alert("Upload gagal: " + error.message),
      () => {
        uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
          // Simpan url bukti ke pesanan yg sesuai nomor HP
          db.ref("pesanan").orderByChild("hp").equalTo(noHp).once("value").then(snap => {
            if (snap.exists()) {
              const pesananKey = Object.keys(snap.val())[0];
              db.ref("pesanan/" + pesananKey).update({
                buktiUrl: downloadURL,
                status: "Selesai"
              }).then(() => {
                alert("✅ Bukti berhasil diupload dan status pesanan diubah jadi Selesai!");
                tampilkanPesanan();
                e.target.reset();

                // TODO: Tambahkan panggilan API notifikasi WA di sini kalau perlu
                // contoh: kirimNotifWA(noHp, "Pesanan Anda sudah selesai dan bukti telah diterima.");
              });
            } else {
              alert("Nomor HP tidak ditemukan pada data pesanan.");
            }
          });
        });
      });
  });

  // (Optional) Fungsi placeholder kirim notifikasi WA, implementasi sesuai API kamu
  function kirimNotifWA(noHp, pesan) {
    console.log(`Kirim WA ke ${noHp}: ${pesan}`);
    // Contoh fetch ke API notifikasi WA kamu
  }

</script>
</body>
</html>
