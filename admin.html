<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1, h3, h4 { color: #333; }
    .card { margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: none; }
    .card-body { padding: 1.25rem; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
    #galeri img:hover { transform: scale(1.05); }
    textarea { font-family: 'Consolas', 'Monaco', monospace; resize: vertical; }
    .nav-tabs .nav-link { border-top-left-radius: .5rem; border-top-right-radius: .5rem; }
    .nav-tabs .nav-link.active { color: #007bff; background-color: #fff; border-color: #dee2e6 #dee2e6 #fff; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Dashboard Admin - Asdar Store</h1>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button">Pesanan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button">Produk</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button">Konten</button></li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <!-- Tab Pesanan -->
    <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
      <div class="card mt-3"><div class="card-body">
        <h3>Manajemen Pesanan</h3>
        <div class="row mb-3 g-2">
          <div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">Filter Semua Status</option><option value="Belum Bayar">Belum Bayar</option><option value="Sudah Bayar">Sudah Bayar</option><option value="Diproses">Diproses</option><option value="Selesai">Selesai</option></select></div>
          <div class="col-md-3"><input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama..." /></div>
          <div class="col-md-3"><button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button></div>
          <div class="col-md-3"><button class="btn btn-warning w-100" onclick="tampilkanPesanan()">ðŸ”„ Refresh</button></div>
        </div>
        <div id="pesananList" class="mb-4"></div>
        <hr>
        <h3>Kirim Bukti Admin</h3>
        <div class="input-group mb-2">
          <input type="file" id="buktiAdmin" class="form-control" accept="image/*" />
          <button id="uploadBuktiBtn" class="btn btn-primary">ðŸ“¤ Kirim Bukti & Selesaikan</button>
        </div>
        <small id="selectedOrderIdDisplay" class="text-info mb-3 d-block"></small>
        <div class="mt-4 d-flex justify-content-end">
          <button class="btn btn-danger" onclick="hapusSemuaPesanan()"><i class="fas fa-trash-alt"></i> Hapus Semua Pesanan</button>
        </div>
      </div></div>
    </div>

    <!-- Tab Produk -->
    <div class="tab-pane fade" id="products-pane" role="tabpanel">
      <div class="card mt-3"><div class="card-body">
        <h3>Tambah / Edit Produk</h3>
        <form id="formProduk" class="row g-3 mb-4">
          <div class="col-md-3"><input type="text" id="kategori" class="form-control" placeholder="Kategori" required /></div>
          <div class="col-md-3"><input type="text" id="varian" class="form-control" placeholder="Varian" required /></div>
          <div class="col-md-2"><input type="text" id="harga" class="form-control" placeholder="Harga" required pattern="[0-9]*" /></div>
          <div class="col-md-4"><input type="text" id="cara" class="form-control" placeholder="Keterangan" required /></div>
          <div class="col-12"><button type="submit" class="btn btn-success">âœ… Simpan Produk</button></div>
        </form>
        <h4>Daftar Produk</h4>
        <ul id="daftarProduk" class="list-group mb-5"></ul>
        <div class="mt-4 d-flex justify-content-end">
            <button class="btn btn-danger" onclick="hapusSemuaProduk()">ðŸ§¹ Hapus Semua Produk</button>
        </div>
      </div></div>
    </div>

    <!-- Tab Konten -->
    <div class="tab-pane fade" id="content-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h4>Manajemen Konten Dinamis</h4>
            <div class="mb-3"><select id="halamanDinamis" class="form-select w-auto"><option value="index">index.html</option><option value="admin">admin.html</option><option value="status">status.html</option><option value="uplod">uplod.html</option></select></div>
            <textarea id="editorHTML" rows="8" class="form-control mb-2" placeholder="HTML..."></textarea>
            <textarea id="editorCSS" rows="6" class="form-control mb-2" placeholder="CSS..."></textarea>
            <textarea id="editorJS" rows="8" class="form-control mb-4" placeholder="JS..."></textarea>
            <button id="simpanDinamisBtn" class="btn btn-primary mb-4">ðŸ’¾ Simpan Konten</button>
        </div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
    const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
    const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');

    let selectedId = null;
    let allDataPesanan = {};

    const halamanSelect = document.getElementById('halamanDinamis');
    const editorHTML = document.getElementById('editorHTML');
    const editorCSS = document.getElementById('editorCSS');
    const editorJS = document.getElementById('editorJS');
    const simpanDinamisBtn = document.getElementById('simpanDinamisBtn');
    const filterStatus = document.getElementById('filterStatus');
    const searchId = document.getElementById('searchId');
    const pesananList = document.getElementById('pesananList');
    const uploadBuktiBtn = document.getElementById('uploadBuktiBtn');
    const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');
    const formProduk = document.getElementById('formProduk');
    const daftarProduk = document.getElementById('daftarProduk');

    function showAlert(message) { alert(message); }
    function formatRupiah(angka) { return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }

    async function sendWhatsApp(to, message) {
        const formData = new FormData();
        formData.append('appkey', NGIRIMWA_APPKEY);
        formData.append('authkey', NGIRIMWA_AUTHKEY);
        formData.append('to', to);
        formData.append('message', message);
        try {
            const response = await fetch('https://ngirimwa.com/api/send-message', { method: 'POST', body: formData });
            if (!response.ok) console.error('WA API Error:', await response.text());
        } catch (error) {
            console.error('WA Send Error:', error);
            alert("Gagal mengirim notifikasi WA. Cek koneksi internet dan console.");
        }
    }

    function loadDinamis() {
      const halaman = halamanSelect.value;
      db.ref(`dynamicContent/${halaman}`).once('value').then(s => {
        const k = s.val() || {html:"",css:"",js:""};
        editorHTML.value=k.html; editorCSS.value=k.css; editorJS.value=k.js;
      });
    }
    simpanDinamisBtn.addEventListener('click', () => {
      const halaman = halamanSelect.value;
      db.ref(`dynamicContent/${halaman}`).set({
        html: editorHTML.value, css: editorCSS.value, js: editorJS.value
      }).then(() => showAlert('Konten dinamis disimpan!'));
    });

    function renderPesanan() {
        const filter = filterStatus.value;
        const search = searchId.value.toLowerCase();
        let html = '';
        const sortedIds = Object.keys(allDataPesanan).sort((a, b) => new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu));
        for (const id of sortedIds) {
            const p = allDataPesanan[id];
            if ((filter && p.status !== filter) || (search && !id.toLowerCase().includes(search) && !(p.nama || '').toLowerCase().includes(search))) continue;
            html += `<div class="card"><div class="card-body"><b>ID:</b> ${id}<br/><b>Nama:</b> ${p.nama}<br/><b>WA:</b> ${p.wa_aktif}<br/><b>Produk:</b> ${p.produk}<br/><b>Status:</b> <span class="status-badge status-${p.status.toLowerCase().replace(/\s+/g, '-')}">${p.status}</span><br/><b>Waktu:</b> ${new Date(p.waktu).toLocaleString('id-ID')}<br/>${p.buktiBayar ? `<a href="${p.buktiBayar}" target="_blank">Lihat Bukti</a>` : ''}${p.buktiAdmin ? `<br/><a href="${p.buktiAdmin}" target="_blank">Lihat Bukti Admin</a>` : ''}<div class="mt-2"><button class="btn btn-sm btn-info me-1" onclick="setSelected('${id}')">Pilih</button><button class="btn btn-sm btn-success me-1" onclick="verifikasi('${id}')">Proses</button><button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')">Hapus</button></div></div></div>`;
        }
        pesananList.innerHTML = html;
    }
    window.setSelected = (id) => { selectedId = id; selectedOrderIdDisplay.textContent = `Pesanan Dipilih: ${id}`; showAlert(`Pesanan ${id} dipilih.`); };
    window.verifikasi = async (id) => {
        if (!confirm(`Yakin ubah status pesanan ${id} menjadi "Diproses"?`)) return;
        await db.ref(`pesanan/${id}`).update({ status: "Diproses" });
        const pesanan = allDataPesanan[id];
        if (pesanan.wa_aktif) sendWhatsApp(pesanan.wa_aktif, `Hai ${pesanan.nama}, pesanan Anda (ID: *${id}*) sedang kami *PROSES*.`);
        showAlert(`Pesanan ${id} diproses.`);
    };
    window.hapusPesanan = async (id) => { if (confirm(`Yakin hapus pesanan ID ${id}?`)) await db.ref(`pesanan/${id}`).remove(); };
    window.deleteAllOrders = async () => { if (confirm('ANDA YAKIN INGIN MENGHAPUS SEMUA PESANAN?')) await db.ref('pesanan').remove(); };

    uploadBuktiBtn.addEventListener('click', async () => {
        const file = document.getElementById('buktiAdmin').files[0];
        if (!file || !selectedId) return showAlert("Pilih pesanan dan file bukti!");
        showAlert("Mengunggah...");
        const formData = new FormData();
        formData.append("key", IMGBB_API_KEY);
        formData.append("image", await toBase64(file).then(r=>r.split(',')[1]));
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload`, { method: "POST", body: formData });
            const json = await res.json();
            if (!json.success) throw new Error(json.error.message);
            const imageUrl = json.data.url;
            await db.ref(`pesanan/${selectedId}`).update({ buktiAdmin: imageUrl, status: "Selesai" });
            const pesanan = allDataPesanan[selectedId];
            const linkStatus = `${BASE_URL}status.html?id=${selectedId}`;
            const pesanUser = `Hai ${pesanan.nama}, pesanan Anda (ID: *${selectedId}*) telah *SELESAI*. Cek bukti di:\n${linkStatus}`;
            if (pesanan.wa_aktif) sendWhatsApp(pesanan.wa_aktif, pesanUser);
            showAlert("Bukti berhasil dikirim!");
        } catch (err) { showAlert(`Gagal: ${err.message}`); }
    });

    function loadProduk() {
        db.ref('produk').on('value', snap => {
            const produk = snap.val() || {};
            daftarProduk.innerHTML = "";
            for (const kategori in produk) {
                for (const varian in produk[kategori]) {
                    const p = produk[kategori][varian];
                    daftarProduk.innerHTML += `<li class="list-group-item d-flex justify-content-between"><div><b>${kategori}</b> &gt; ${varian} (Rp${formatRupiah(p.harga)})</div><div><button class="btn btn-sm btn-info" onclick="editProduk('${kategori}','${varian}',${p.harga},'${p.cara}')">Edit</button><button class="btn btn-sm btn-danger ms-2" onclick="hapusProduk('${kategori}','${varian}')">Hapus</button></div></li>`;
                }
            }
        });
    }
    formProduk.addEventListener('submit', async e => {
        e.preventDefault();
        const data = {
            harga: Number(document.getElementById('harga').value),
            cara: document.getElementById('cara').value
        };
        const kategori = document.getElementById('kategori').value.trim();
        const varian = document.getElementById('varian').value.trim();
        if (!kategori || !varian || !data.harga || !data.cara) return alert("Lengkapi semua field produk!");
        await db.ref(`produk/${kategori}/${varian}`).set(data);
        showAlert("Produk disimpan!");
        formProduk.reset();
    });
    window.editProduk = (k,v,h,c) => {
        document.getElementById('kategori').value=k;
        document.getElementById('varian').value=v;
        document.getElementById('harga').value=h;
        document.getElementById('cara').value=c;
    };
    window.hapusProduk = async (k,v) => { if(confirm(`Hapus ${v}?`)) await db.ref(`produk/${k}/${v}`).remove(); };
    window.hapusSemuaProduk = async () => { if(confirm('HAPUS SEMUA PRODUK?')) await db.ref('produk').remove(); };

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDinamis();
        halamanSelect.addEventListener('change', loadDinamis);
        db.ref('pesanan').on('value', s => { allDataPesanan = s.val() || {}; renderPesanan(); });
        filterStatus.addEventListener('change', renderPesanan);
        searchId.addEventListener('input', renderPesanan);
        loadProduk();
    });
</script>
</body>
</html>
