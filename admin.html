<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd;
      --success-color: #198754;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --border-color: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .container { max-width: 1200px; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .nav-tabs .nav-link { font-weight: 500; }
    .nav-tabs .nav-link.active { color: var(--primary-color); background-color: #fff; border-color: var(--border-color) var(--border-color) #fff; }
    
    .order-card { background: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s ease; }
    .order-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .order-card p { margin: 0.25rem 0; font-size: 0.9rem; }
    .order-card p strong { min-width: 110px; display: inline-block; color: #555; }
    .order-card .badge { font-size: 0.8rem; padding: 0.4em 0.7em; }
    
    .product-category h4 { padding: 10px; background-color: var(--light-gray); border-radius: 8px; margin-top: 20px; }
    .product-list .list-group-item { cursor: grab; background-color: #fff; }
    .product-list .list-group-item:active { cursor: grabbing; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .toast.show { display: block; }
    
    .modal-backdrop.show { opacity: 0.5; }
  </style>
</head>
<body>

<div class="toast-container"></div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p id="confirmModalBody"></p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" id="confirmModalCancel">Batal</button><button type="button" class="btn btn-primary" id="confirmModalOk">Ya, Lanjutkan</button></div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold">Dashboard Admin</h1>
    <p class="text-muted">Asdar Store Digital</p>
  </div>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button"><i class="fas fa-receipt me-2"></i>Pesanan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button"><i class="fas fa-box-open me-2"></i>Produk</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="moderasi-tab" data-bs-toggle="tab" data-bs-target="#moderasi-pane" type="button"><i class="fas fa-comment-check me-2"></i>Moderasi Testimoni</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button"><i class="fas fa-file-code me-2"></i>Konten Dinamis</button></li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Manajemen Pesanan</h3>
            <div class="row mb-3 g-2 align-items-center">
                <div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">Filter Semua Status</option><option value="Belum Bayar">Belum Bayar</option><option value="Sudah Bayar">Sudah Bayar</option><option value="Diproses">Diproses</option><option value="Selesai">Selesai</option></select></div>
                <div class="col-md-5"><input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama/Nomor..." /></div>
                <div class="col-md-2"><button class="btn btn-outline-success w-100" id="exportCSVBtn"><i class="fas fa-file-csv me-2"></i>Export</button></div>
                <div class="col-md-2"><button class="btn btn-outline-primary w-100" onclick="renderPesanan()"><i class="fas fa-sync-alt me-2"></i>Refresh</button></div>
            </div>
            <div id="pesananList" class="mb-4"><p class="text-center text-muted p-4">Memuat pesanan...</p></div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h4>Kirim Bukti Admin</h4>
                    <div class="input-group mb-2">
                        <input type="file" id="buktiAdmin" class="form-control" accept="image/*" />
                        <button id="uploadBuktiBtn" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Kirim & Selesaikan</button>
                    </div>
                    <small id="selectedOrderIdDisplay" class="text-info mb-3 d-block">Pilih pesanan dari daftar untuk mengirim bukti.</small>
                </div>
                <div class="col-md-6 text-end align-self-end">
                    <button class="btn btn-danger" id="deleteAllOrdersBtn"><i class="fas fa-trash-alt me-2"></i>Hapus Semua Pesanan</button>
                </div>
            </div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="products-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3>Tambah / Edit Produk</h3>
            <form id="formProduk" class="row g-3 mb-4 p-3 border rounded-3 bg-light">
                <div class="col-md-3"><label class="form-label">Kategori</label><input type="text" id="kategori" class="form-control" required /></div>
                <div class="col-md-3"><label class="form-label">Varian</label><input type="text" id="varian" class="form-control" required /></div>
                <div class="col-md-2"><label class="form-label">Harga</label><input type="number" id="harga" class="form-control" required /></div>
                <div class="col-md-4"><label class="form-label">Keterangan</label><textarea id="cara" class="form-control" rows="3" required></textarea></div>
                <div class="col-12"><button type="submit" id="simpanProdukBtn" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Simpan Produk</button></div>
            </form>
            <h4>Daftar Produk (<small class="text-muted">Drag & drop varian untuk mengurutkan</small>)</h4>
            <div id="product-container"></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="moderasi-pane" role="tabpanel">
        <div class="card mt-3">
          <div class="card-body">
            <div id="dynamic-content-area-admin"></div>
          </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="content-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Editor Konten Dinamis</h3>
            <div class="mb-3">
                <label for="halamanDinamis" class="form-label">Pilih Halaman untuk Diedit:</label>
                <select id="halamanDinamis" class="form-select w-auto"><option value="index">index.html</option><option value="admin">admin.html</option><option value="status">status.html</option><option value="uplod">uplod.html</option></select>
            </div>
            <div class="mb-3">
                <label for="editorHTML" class="form-label">HTML</label>
                <textarea id="editorHTML" rows="8" class="form-control font-monospace" placeholder=""></textarea>
            </div>
            <div class="mb-3">
                <label for="editorCSS" class="form-label">CSS</label>
                <textarea id="editorCSS" rows="6" class="form-control font-monospace" placeholder="/* Kode CSS Anda di sini */"></textarea>
            </div>
            <div class="mb-3">
                <label for="editorJS" class="form-label">JavaScript</label>
                <textarea id="editorJS" rows="8" class="form-control font-monospace" placeholder="// Kode JavaScript Anda di sini"></textarea>
            </div>
            <button id="simpanDinamisBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Konten Dinamis</button>
            <hr class="my-4">
            <h3 class="mb-3">Konten yang Tersimpan</h3>
            <div id="saved-dynamic-content-list">
                <p class="text-muted">Memuat daftar...</p>
            </div>
        </div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    // === Firebase & Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');

    // === Global State ===
    let selectedId = null;
    let allDataPesanan = {};
    let confirmModal;

    // === UI Elements ===
    const filterStatus = document.getElementById('filterStatus');
    const searchId = document.getElementById('searchId');
    const pesananList = document.getElementById('pesananList');
    const uploadBuktiBtn = document.getElementById('uploadBuktiBtn');
    const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');
    const formProduk = document.getElementById('formProduk');
    const deleteAllOrdersBtn = document.getElementById('deleteAllOrdersBtn');

    // === Modern UI Functions ===
    function showToast(message, type = 'info') {
      const toastId = 'toast-' + Date.now();
      const toastColor = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary' }[type];
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${toastColor} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>`;
      document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML);
      const toastEl = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }
    
    function showConfirm(title, body) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalBody').textContent = body;
      confirmModal.show();
      return new Promise(resolve => {
        const okBtn = document.getElementById('confirmModalOk');
        const cancelBtn = document.getElementById('confirmModalCancel');
        const onOk = () => { resolve(true); confirmModal.hide(); cleanup(); };
        const onCancel = () => { resolve(false); confirmModal.hide(); cleanup(); };
        function cleanup() {
            okBtn.removeEventListener('click', onOk);
            cancelBtn.removeEventListener('click', onCancel);
        }
        okBtn.addEventListener('click', onOk, { once: true });
        cancelBtn.addEventListener('click', onCancel, { once: true });
        document.querySelector('#confirmModal .btn-close').addEventListener('click', onCancel, { once: true });
      });
    }

    // === Helper Functions ===
    const formatRupiah = (angka) => (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // === Order Management (Fungsi tidak berubah) ===
    function renderPesanan() {
        const filter = filterStatus.value;
        const search = searchId.value.toLowerCase();
        if (!allDataPesanan) {
            pesananList.innerHTML = '<div class="text-center p-5"><p class="text-muted">Tidak ada pesanan.</p></div>';
            return;
        }
        const sortedIds = Object.keys(allDataPesanan).sort((a, b) => new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu));
        let html = '';
        sortedIds.forEach(id => {
            const p = allDataPesanan[id];
            const searchMatch = search === '' || id.toLowerCase().includes(search) || (p.nama || '').toLowerCase().includes(search) || (p.nomor || '').includes(search);
            const statusMatch = filter === '' || p.status === filter;
            if (statusMatch && searchMatch) {
                let statusClass = 'secondary';
                if (p.status === 'Selesai') statusClass = 'success';
                if (p.status === 'Sudah Bayar') statusClass = 'warning';
                if (p.status === 'Diproses') statusClass = 'info';
                html += `
                <div class="order-card" id="order-${id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div><p><strong>ID Pesanan:</strong> ${id}</p><p><strong>Waktu:</strong> ${new Date(p.waktu).toLocaleString('id-ID')}</p></div>
                        <span class="badge bg-${statusClass}">${p.status || '-'}</span>
                    </div><hr class="my-2">
                    <p><strong>Nama:</strong> ${p.nama || '-'}</p><p><strong>WA Aktif:</strong> ${p.wa_aktif || '-'}</p><p><strong>ID Game/HP:</strong> ${p.nomor || '-'}</p>
                    <p><strong>Produk:</strong> ${p.produk || '-'}</p><p><strong>Harga:</strong> Rp${formatRupiah(p.harga)}</p>
                    ${p.buktiBayar ? `<p><strong>Bukti Bayar:</strong> <a href="${p.buktiBayar}" target="_blank" class="text-primary">Lihat Bukti</a></p>` : ''}
                    ${p.buktiAdmin ? `<p><strong>Bukti Admin:</strong> <a href="${p.buktiAdmin}" target="_blank" class="text-success">Lihat Bukti</a></p>` : ''}
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-primary" onclick="setSelected('${id}')"><i class="fas fa-check me-1"></i>Pilih untuk Kirim Bukti</button>
                        <button class="btn btn-sm btn-info" onclick="verifikasi('${id}')"><i class="fas fa-cogs me-1"></i>Proses</button>
                        <button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')"><i class="fas fa-trash me-1"></i>Hapus</button>
                    </div>
                </div>`;
            }
        });
        pesananList.innerHTML = html || '<div class="text-center p-5"><p class="text-muted">Tidak ada pesanan yang cocok dengan filter Anda.</p></div>';
    }
    window.setSelected = (id) => {
        selectedId = id;
        selectedOrderIdDisplay.textContent = `Pesanan Dipilih: ${id}`;
        showToast(`Pesanan ${id} dipilih.`, 'info');
        document.getElementById(`order-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
    window.verifikasi = async (id) => {
        if (!await showConfirm('Konfirmasi Proses', `Yakin ubah status pesanan ${id} menjadi "Diproses"?`)) return;
        await db.ref(`pesanan/${id}`).update({ status: "Diproses" });
        const pesanan = allDataPesanan[id];
        if (pesanan.wa_aktif) window.open(`https://wa.me/${pesanan.wa_aktif}?text=${encodeURIComponent(`Hai ${pesanan.nama}, pesanan Anda (ID: *${id}*) sedang kami *PROSES*. Mohon tunggu sebentar ya.`)}`, '_blank');
        showToast(`Pesanan ${id} diproses.`, 'success');
    };
    window.hapusPesanan = async (id) => {
        if (await showConfirm('Konfirmasi Hapus', `Yakin ingin menghapus permanen pesanan ID ${id}?`)) {
            await db.ref(`pesanan/${id}`).remove();
            showToast("Pesanan berhasil dihapus.", 'success');
        }
    };
    async function deleteAllOrders() {
        if (await showConfirm('PERINGATAN KERAS!', 'Anda yakin ingin MENGHAPUS SEMUA data pesanan? Tindakan ini tidak dapat dibatalkan.')) {
            await db.ref('pesanan').remove();
            showToast("Semua pesanan telah dihapus.", 'danger');
        }
    };
    async function handleUploadBukti() {
        const file = document.getElementById('buktiAdmin').files[0];
        if (!file || !selectedId) return showToast("Pilih pesanan dan file bukti terlebih dahulu!", 'error');
        uploadBuktiBtn.disabled = true; uploadBuktiBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengirim...';
        try {
            const base64Image = await toBase64(file).then(r => r.split(',')[1]);
            const formData = new FormData();
            formData.append("key", IMGBB_API_KEY); formData.append("image", base64Image);
            const res = await fetch(`https://api.imgbb.com/1/upload`, { method: "POST", body: formData });
            const json = await res.json();
            if (!json.success) throw new Error(json.error.message);
            const imageUrl = json.data.url;
            await db.ref(`pesanan/${selectedId}`).update({ buktiAdmin: imageUrl, status: "Selesai" });
            const pesanan = allDataPesanan[selectedId];
            const linkStatus = `${BASE_URL}status.html?id=${selectedId}`;
            const pesanUser = `Hai ${pesanan.nama}, pesanan Anda (ID: *${selectedId}*) telah *SELESAI*. Terima kasih telah berbelanja! Cek detailnya di:\n${linkStatus}`;
            if (pesanan.wa_aktif) window.open(`https://wa.me/${pesanan.wa_aktif}?text=${encodeURIComponent(pesanUser)}`, '_blank');
            showToast("Bukti berhasil dikirim dan pesanan diselesaikan!", 'success');
            selectedId = null; selectedOrderIdDisplay.textContent = 'Pilih pesanan dari daftar untuk mengirim bukti.'; document.getElementById('buktiAdmin').value = '';
        } catch (err) { showToast(`Gagal: ${err.message}`, 'error');
        } finally { uploadBuktiBtn.disabled = false; uploadBuktiBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Kirim & Selesaikan'; }
    }
    
    // === Product Management (Fungsi tidak berubah) ===
    function loadProduk() {
        db.ref('produk').on('value', snap => {
            const produkPerKategori = snap.val() || {};
            const productContainer = document.getElementById('product-container');
            productContainer.innerHTML = "";
            for (const kategori in produkPerKategori) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'product-category mb-4';
                categoryDiv.innerHTML = `<h4>${kategori}</h4>`;
                const productListUl = document.createElement('ul');
                productListUl.id = `list-group-${kategori.replace(/\s+/g, '-')}`;
                productListUl.className = 'list-group product-list';
                const varianArr = Object.entries(produkPerKategori[kategori]).map(([varian, data]) => ({ varian, ...data }));
                varianArr.sort((a,b) => (a.urutan || 0) - (b.urutan || 0));
                varianArr.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.dataset.id = `${kategori}/${p.varian}`;
                    li.innerHTML = `<div><i class="fas fa-grip-vertical me-3 text-muted"></i><strong>${p.varian}</strong><span class="text-muted ms-2">(Rp${formatRupiah(p.harga)})</span></div><div><button class="btn btn-sm btn-outline-info" onclick="editProduk('${kategori}','${p.varian}',${p.harga},'${p.cara.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger ms-2" onclick="hapusProduk('${kategori}','${p.varian}')"><i class="fas fa-trash"></i></button></div>`;
                    productListUl.appendChild(li);
                });
                categoryDiv.appendChild(productListUl);
                productContainer.appendChild(categoryDiv);
                new Sortable(productListUl, { animation: 150, ghostClass: 'sortable-ghost', onEnd: function (evt) { const items = evt.to.children; let updates = {}; for(let i = 0; i < items.length; i++) { const id = items[i].dataset.id; updates[`${id}/urutan`] = i; } db.ref('produk').update(updates); } });
            }
        });
    }
    async function handleSimpanProduk(e) {
        e.preventDefault();
        const kategori = document.getElementById('kategori').value.trim();
        const varian = document.getElementById('varian').value.trim();
        const data = { harga: Number(document.getElementById('harga').value), cara: document.getElementById('cara').value, };
        if (!kategori || !varian || !data.harga || !data.cara) return showToast("Lengkapi semua field produk!", 'error');
        const existingProd = await db.ref(`produk/${kategori}/${varian}`).once('value');
        if (!existingProd.exists()) data.urutan = Date.now();
        await db.ref(`produk/${kategori}/${varian}`).update(data);
        showToast("Produk berhasil disimpan!", 'success');
        formProduk.reset();
    }
    window.editProduk = (k,v,h,c) => { document.getElementById('kategori').value=k; document.getElementById('varian').value=v; document.getElementById('harga').value=h; document.getElementById('cara').value=c; document.getElementById('kategori').focus(); };
    window.hapusProduk = async (k,v) => { if(await showConfirm('Hapus Produk', `Yakin ingin menghapus produk ${v}?`)) { await db.ref(`produk/${k}/${v}`).remove(); showToast('Produk dihapus', 'success'); } };

    // === Dynamic Content Management (FUNGSI DIPERBARUI) ===
    const halamanSelect = document.getElementById('halamanDinamis');
    const editorHTML = document.getElementById('editorHTML');
    const editorCSS = document.getElementById('editorCSS');
    const editorJS = document.getElementById('editorJS');
    const simpanDinamisBtn = document.getElementById('simpanDinamisBtn');
    const savedContentList = document.getElementById('saved-dynamic-content-list');

    function loadDinamisEditor() {
      const halaman = halamanSelect.value;
      if (!halaman) return;
      db.ref(`dynamicContent/${halaman}`).once('value').then(s => {
        const k = s.val() || {html:"",css:"",js:""};
        editorHTML.value = k.html; editorCSS.value = k.css; editorJS.value = k.js;
      });
    }

    function handleSimpanDinamis() {
      const halaman = halamanSelect.value;
      if (!halaman) return showToast('Pilih halaman terlebih dahulu!', 'error');
      db.ref(`dynamicContent/${halaman}`).set({
        html: editorHTML.value, css: editorCSS.value, js: editorJS.value
      }).then(() => showToast('Konten dinamis berhasil disimpan!', 'success'));
    }

    function renderSavedDynamicContent() {
        db.ref('dynamicContent').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) {
                savedContentList.innerHTML = '<p class="text-muted">Belum ada konten dinamis yang tersimpan.</p>';
                return;
            }
            let html = '<ul class="list-group">';
            for (const pageName in data) {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <code>${pageName}.html</code>
                        <button class="btn btn-sm btn-outline-danger" onclick="hapusKontenDinamis('${pageName}')">
                            <i class="fas fa-trash-alt me-2"></i>Hapus
                        </button>
                    </li>
                `;
            }
            html += '</ul>';
            savedContentList.innerHTML = html;
        });
    }

    window.hapusKontenDinamis = async (pageName) => {
        const confirmed = await showConfirm(
            'Konfirmasi Hapus',
            `Yakin ingin menghapus konten dinamis untuk halaman ${pageName}.html?`
        );
        if (confirmed) {
            db.ref(`dynamicContent/${pageName}`).remove()
                .then(() => showToast(`Konten untuk ${pageName}.html berhasil dihapus.`, 'success'))
                .catch(err => showToast(`Error: ${err.message}`, 'error'));
        }
    };

    function loadDynamicContentForAdminPage() {
        const container = document.getElementById('dynamic-content-area-admin');
        if (!container) return;

        db.ref('dynamicContent/admin').once('value').then(snapshot => {
            const content = snapshot.val();
            if (!content) {
                container.innerHTML = '<p class="text-center text-muted">Belum ada konten moderasi yang ditambahkan. Silakan tambahkan melalui tab "Konten Dinamis".</p>';
                return;
            }
            if (content.html) container.innerHTML = content.html;
            if (content.css) {
                const style = document.createElement('style');
                style.textContent = content.css;
                document.head.appendChild(style);
            }
            if (content.js) {
                // Cara aman untuk menjalankan JS dengan akses ke variabel global seperti 'db'
                try {
                    // Membuat fungsi baru yang bisa menerima 'db' sebagai argumen
                    const dynamicFunction = new Function('db', content.js);
                    dynamicFunction(db);
                } catch (e) {
                    console.error("Error saat menjalankan JS dinamis:", e);
                    container.innerHTML += `<div class="alert alert-danger mt-3">Error pada skrip moderasi: ${e.message}</div>`;
                }
            }
        });
    }

    // === App Initialization ===
    document.addEventListener('DOMContentLoaded', () => {
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        // Daftarkan event listener
        filterStatus.addEventListener('change', renderPesanan);
        searchId.addEventListener('input', renderPesanan);
        deleteAllOrdersBtn.addEventListener('click', deleteAllOrders);
        uploadBuktiBtn.addEventListener('click', handleUploadBukti);
        formProduk.addEventListener('submit', handleSimpanProduk);
        simpanDinamisBtn.addEventListener('click', handleSimpanDinamis);
        halamanSelect.addEventListener('change', loadDinamisEditor);

        // Muat data awal
        db.ref('pesanan').on('value', s => { allDataPesanan = s.val(); renderPesanan(); });
        loadProduk();
        loadDinamisEditor();
        renderSavedDynamicContent();
        loadDynamicContentForAdminPage();
    });
</script>
</body>
</html>
