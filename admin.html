<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Toko Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-body: #f4f7f6;
            --bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #343a40;
            --header-bg: #e9ecef;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-color);
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: white;
            padding-top: 20px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.75);
            padding: 15px 20px;
            display: block;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-left: 5px solid var(--success-color);
        }

        .sidebar .nav-link i {
            margin-right: 10px;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
        }

        .header {
            background-color: var(--header-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .section {
            background-color: var(--bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .form-control, .form-select {
            border-radius: 5px;
            border-color: var(--border-color);
        }

        .btn {
            border-radius: 5px;
            padding: 10px 20px;
        }

        .table {
            margin-top: 20px;
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .badge {
            padding: 0.6em 0.9em;
            font-size: 0.85em;
            border-radius: 15px;
        }

        .product-image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .loading-button {
            position: relative;
        }

        .loading-button .spinner-border {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }

        .loading-button.btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .loading-button.btn-loading .spinner-border {
            display: inline-block;
        }

        .loading-button:not(.btn-loading) .spinner-border {
            display: none;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <nav class="sidebar">
            <h3 class="text-center my-4">Admin Panel</h3>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="products-tab" data-bs-toggle="tab" href="#products" role="tab" aria-controls="products" aria-selected="false">
                        <i class="fas fa-box-open"></i> Manajemen Produk
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                        <i class="fas fa-shopping-cart"></i> Manajemen Pesanan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="resellers-tab" data-bs-toggle="tab" href="#resellers" role="tab" aria-controls="resellers" aria-selected="false">
                        <i class="fas fa-users"></i> Manajemen Reseller
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="promo-management-tab" data-bs-toggle="tab" href="#promo-management" role="tab" aria-controls="promo-management" aria-selected="false">
                        <i class="fas fa-tags"></i> Manajemen Promo & Hadiah
                    </a>
                </li>
            </ul>
        </nav>

        <div class="main-content">
            <div class="header">
                <h1>Selamat Datang di Panel Admin!</h1>
                <p class="text-muted">Kelola produk, pesanan, reseller, dan promosi toko Anda dengan mudah.</p>
            </div>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="section">
                        <h2>Ringkasan</h2>
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="card p-3 shadow-sm">
                                    <h4>Total Produk</h4>
                                    <p id="total-products" class="fs-2 text-primary">0</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card p-3 shadow-sm">
                                    <h4>Pesanan Baru</h4>
                                    <p id="new-orders" class="fs-2 text-warning">0</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card p-3 shadow-sm">
                                    <h4>Total Reseller</h4>
                                    <p id="total-resellers" class="fs-2 text-success">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="products" role="tabpanel">
                    <div class="section">
                        <h2>Tambah / Edit Produk</h2>
                        <form id="product-form">
                            <input type="hidden" id="product-id">
                            <div class="mb-3">
                                <label for="product-name" class="form-label">Nama Produk</label>
                                <input type="text" class="form-control" id="product-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="product-price" class="form-label">Harga Produk (Rp)</label>
                                <input type="number" class="form-control" id="product-price" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="product-stock" class="form-label">Stok Produk</label>
                                <input type="number" class="form-control" id="product-stock" min="0" required>
                            </div>
                            <div class="mb-3">
                                <label for="product-image" class="form-label">Gambar Produk</label>
                                <input type="file" class="form-control" id="product-image" accept="image/*">
                                <img id="image-preview" src="#" alt="Pratinjau Gambar" class="product-image-preview mt-2" style="display:none;">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Simpan Produk</button>
                            <button type="button" class="btn btn-secondary w-100 mt-2" id="cancel-edit-btn" style="display:none;">Batal Edit</button>
                        </form>
                    </div>

                    <div class="section mt-4">
                        <h2>Daftar Produk</h2>
                        <input type="text" id="search-product" class="form-control mb-3" placeholder="Cari produk...">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Gambar</th>
                                        <th>Nama</th>
                                        <th>Harga</th>
                                        <th>Stok</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="products-list">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="orders" role="tabpanel">
                    <div class="section">
                        <h2>Daftar Pesanan</h2>
                        <input type="text" id="search-order" class="form-control mb-3" placeholder="Cari pesanan berdasarkan nama pembeli / WA...">
                        <div class="mb-3">
                            <label for="order-status-filter" class="form-label">Filter Status:</label>
                            <select id="order-status-filter" class="form-select">
                                <option value="">Semua</option>
                                <option value="Pending">Pending</option>
                                <option value="Diproses">Diproses</option>
                                <option value="Dikirim">Dikirim</option>
                                <option value="Selesai">Selesai</option>
                                <option value="Dibatalkan">Dibatalkan</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Pembeli</th>
                                        <th>WA</th>
                                        <th>Produk</th>
                                        <th>Jumlah</th>
                                        <th>Status</th>
                                        <th>Tanggal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-list">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="resellers" role="tabpanel">
                    <div class="section">
                        <h2>Manajemen Reseller</h2>
                        <p class="text-muted">Tambahkan, hapus, atau kelola hak diskon reseller.</p>
                        
                        <div class="p-3 border rounded mb-4" style="background-color: var(--bg);">
                            <h4 class="mb-3">Tambah Reseller Baru</h4>
                            <form id="add-reseller-form">
                                <div class="mb-3">
                                    <label for="reseller-name" class="form-label">Nama Reseller</label>
                                    <input type="text" id="reseller-name" class="form-control" placeholder="Nama Lengkap" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reseller-email" class="form-label">Email Reseller</label>
                                    <input type="email" id="reseller-email" class="form-control" placeholder="contoh@reseller.com" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reseller-whatsapp" class="form-label">Nomor WhatsApp</label>
                                    <input type="tel" id="reseller-whatsapp" class="form-control" placeholder="081234567890" required>
                                
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" value="" id="reseller-has-discount-check" checked>
                                        <label class="form-check-label" for="reseller-has-discount-check">
                                            Berikan hak diskon Rp 5.000 (otomatis aktif)
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success w-100">Tambah Reseller</button>
                            </form>
                        </div>

                        <div class="section mt-4">
                            <h2>Daftar Reseller</h2>
                            <input type="text" id="search-reseller" class="form-control mb-3" placeholder="Cari reseller berdasarkan nama / email / WA...">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nama</th>
                                            <th>Email</th>
                                            <th>WhatsApp</th>
                                            <th>Hak Diskon</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resellers-list">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="promo-management" role="tabpanel">
                    <div class="section">
                        <h2>Berikan Diskon Promosi Reseller (Rp 5.000)</h2>
                        <p class="text-muted">Masukkan email reseller. Sistem akan otomatis memberikan hak diskon sebesar Rp 5.000 pada pesanan mereka selanjutnya.</p>
                        
                        <div class="p-3 border rounded mb-4" style="background-color: var(--bg);">
                            <h4 class="mb-3">Untuk Reseller</h4>
                            <form id="grant-reseller-promo-form">
                                <div class="mb-3">
                                    <label for="reseller-promo-email" class="form-label">Email Reseller</label>
                                    <input type="email" id="reseller-promo-email" class="form-control" placeholder="contoh@reseller.com" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Beri Diskon ke Reseller</button>
                            </form>
                        </div>

                        <hr class="my-4">

                        <h2>Manajemen Hadiah Khusus (Banner "Sebuah Kejutan Manis")</h2>
                        <p class="text-muted">Aktifkan atau nonaktifkan banner hadiah khusus untuk **pembeli biasa atau reseller** berdasarkan **nomor WhatsApp aktif** mereka. Jika aktif, banner akan muncul di halaman publik.</p>
                        
                        <div class="p-3 border rounded" style="background-color: var(--bg);">
                            <h4 class="mb-3">Atur Status Hadiah Pengguna</h4>
                            <form id="manage-gift-eligibility-form">
                                <div class="mb-3">
                                    <label for="user-type" class="form-label">Tipe Pengguna</label>
                                    <select id="user-type" class="form-select">
                                        <option value="umum">Pembeli Biasa</option>
                                        <option value="reseller">Reseller</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="user-whatsapp-value" class="form-label">Nomor WhatsApp</label>
                                    <input type="tel" id="user-whatsapp-value" class="form-control" placeholder="contoh: 081234567890 atau 6281234567890" required>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" id="activate-gift-btn" class="btn btn-success">Aktifkan Hadiah</button>
                                    <button type="button" id="deactivate-gift-btn" class="btn btn-danger">Nonaktifkan Hadiah</button>
                                    <button type="button" id="check-gift-status-btn" class="btn btn-info">Cek Status</button>
                                </div>
                            </form>
                            <div id="gift-status-result" class="mt-3 alert alert-info" style="display:none;"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notifikasi</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body">
                Pesan notifikasi.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const dbFS = firebase.firestore();
        const storage = firebase.storage();

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            const toastBody = document.getElementById('toast-body');
            const toastTitle = document.getElementById('toast-title');

            toastBody.textContent = message;
            toastTitle.textContent = 'Notifikasi'; // Reset title

            document.getElementById('liveToast').className = 'toast'; // Reset classes
            if (type === 'success') {
                document.getElementById('liveToast').classList.add('bg-success', 'text-white');
                toastTitle.textContent = 'Berhasil';
            } else if (type === 'danger') {
                document.getElementById('liveToast').classList.add('bg-danger', 'text-white');
                toastTitle.textContent = 'Error';
            } else if (type === 'warning') {
                document.getElementById('liveToast').classList.add('bg-warning', 'text-dark');
                toastTitle.textContent = 'Peringatan';
            } else {
                document.getElementById('liveToast').classList.add('bg-info', 'text-white');
            }
            toast.show();
        }

        function setButtonLoading(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.classList.add('btn-loading');
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                button.setAttribute('disabled', 'true');
            } else {
                button.classList.remove('btn-loading');
                // Restore original button text based on its ID or a data attribute
                if (button.id === 'add-product-btn' || button.id === 'edit-product-btn' || button.type === 'submit') { // For submit buttons in general
                     button.innerHTML = button.dataset.originalText || 'Simpan'; // Use a data-original-text if set
                     if (button.id === 'product-form' && !document.getElementById('product-id').value) {
                        button.textContent = 'Simpan Produk';
                     } else if (button.id === 'product-form' && document.getElementById('product-id').value) {
                         button.textContent = 'Update Produk';
                     } else if (button.id === 'grant-reseller-promo-form' && button.type === 'submit') {
                         button.textContent = 'Beri Diskon ke Reseller';
                     } else if (button.id === 'add-reseller-form' && button.type === 'submit') {
                         button.textContent = 'Tambah Reseller';
                     }
                } else if (button.id === 'activate-gift-btn') {
                    button.textContent = 'Aktifkan Hadiah';
                } else if (button.id === 'deactivate-gift-btn') {
                    button.textContent = 'Nonaktifkan Hadiah';
                } else if (button.id === 'check-gift-status-btn') {
                    button.textContent = 'Cek Status';
                }
                button.removeAttribute('disabled');
            }
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function normalizePhoneNumber(phoneNumber) {
            // Remove any non-digit characters
            let normalized = phoneNumber.replace(/\D/g, '');

            // If it starts with '0', replace with '62'
            if (normalized.startsWith('0')) {
                normalized = '62' + normalized.substring(1);
            }
            // If it doesn't start with '62', assume it's missing and add it
            else if (!normalized.startsWith('62')) {
                normalized = '62' + normalized;
            }
            return normalized;
        }

        // =================================== DASHBOARD ===================================
        function loadDashboardSummary() {
            dbFS.collection('products').get().then(snapshot => {
                document.getElementById('total-products').textContent = snapshot.size;
            });

            dbFS.collection('orders').where('status', '==', 'Pending').get().then(snapshot => {
                document.getElementById('new-orders').textContent = snapshot.size;
            });

            dbFS.collection('resellers').get().then(snapshot => {
                document.getElementById('total-resellers').textContent = snapshot.size;
            });
        }

        // =================================== PRODUCT MANAGEMENT ===================================
        function setupProductForms() {
            const productForm = document.getElementById('product-form');
            const productIdInput = document.getElementById('product-id');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const productStockInput = document.getElementById('product-stock');
            const productImageInput = document.getElementById('product-image');
            const imagePreview = document.getElementById('image-preview');
            const productsList = document.getElementById('products-list');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const searchProductInput = document.getElementById('search-product');

            let currentImageUrl = ''; // To store current image URL when editing

            productImageInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.style.display = 'none';
                    imagePreview.src = '#';
                }
            };

            productForm.onsubmit = async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('[type=submit]');
                setButtonLoading(button, true);

                const id = productIdInput.value;
                const name = productNameInput.value;
                const price = parseFloat(productPriceInput.value);
                const stock = parseInt(productStockInput.value);
                const imageFile = productImageInput.files[0];

                try {
                    let imageUrl = currentImageUrl; // Default to existing image URL

                    if (imageFile) {
                        const storageRef = storage.ref(`product_images/${imageFile.name}`);
                        const snapshot = await storageRef.put(imageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                        showToast('Gambar berhasil diunggah!', 'success');
                    } else if (!id && !currentImageUrl) { // If adding new product and no image selected
                        showToast('Harap pilih gambar produk.', 'warning');
                        setButtonLoading(button, false);
                        return;
                    }

                    const productData = {
                        name,
                        price,
                        stock,
                        imageUrl
                    };

                    if (id) {
                        await dbFS.collection('products').doc(id).update(productData);
                        showToast('Produk berhasil diupdate!', 'success');
                    } else {
                        await dbFS.collection('products').add(productData);
                        showToast('Produk berhasil ditambahkan!', 'success');
                    }

                    productForm.reset();
                    productIdInput.value = '';
                    imagePreview.style.display = 'none';
                    imagePreview.src = '#';
                    currentImageUrl = '';
                    cancelEditBtn.style.display = 'none';
                    button.textContent = 'Simpan Produk'; // Reset button text
                    loadProducts(); // Reload product list
                    loadDashboardSummary(); // Update dashboard
                } catch (error) {
                    showToast('Gagal menyimpan produk: ' + error.message, 'danger');
                    console.error("Error saving product:", error);
                } finally {
                    setButtonLoading(button, false);
                }
            };

            cancelEditBtn.onclick = () => {
                productForm.reset();
                productIdInput.value = '';
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                currentImageUrl = '';
                cancelEditBtn.style.display = 'none';
                productForm.querySelector('[type=submit]').textContent = 'Simpan Produk'; // Reset button text
            };

            // Load products
            const loadProducts = () => {
                dbFS.collection('products').orderBy('name').onSnapshot(snapshot => {
                    productsList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const row = productsList.insertRow();
                        row.insertCell(0).innerHTML = `<img src="${product.imageUrl}" alt="${product.name}" class="product-image-preview">`;
                        row.insertCell(1).textContent = product.name;
                        row.insertCell(2).textContent = formatRupiah(product.price);
                        row.insertCell(3).textContent = product.stock;
                        const actionsCell = row.insertCell(4);
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-warning edit-btn me-2" data-id="${doc.id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${doc.id}" data-image-url="${product.imageUrl}">Hapus</button>
                        `;
                    });

                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.onclick = async (e) => {
                            const id = e.target.dataset.id;
                            const doc = await dbFS.collection('products').doc(id).get();
                            if (doc.exists) {
                                const product = doc.data();
                                productIdInput.value = doc.id;
                                productNameInput.value = product.name;
                                productPriceInput.value = product.price;
                                productStockInput.value = product.stock;
                                imagePreview.src = product.imageUrl;
                                imagePreview.style.display = 'block';
                                currentImageUrl = product.imageUrl; // Set current image URL
                                cancelEditBtn.style.display = 'inline-block';
                                productForm.querySelector('[type=submit]').textContent = 'Update Produk'; // Change button text
                                window.scrollTo(0, 0); // Scroll to top to see the form
                            }
                        };
                    });

                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.onclick = async (e) => {
                            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                                const id = e.target.dataset.id;
                                const imageUrl = e.target.dataset.imageUrl;
                                try {
                                    if (imageUrl) {
                                        const imageRef = storage.refFromURL(imageUrl);
                                        await imageRef.delete();
                                    }
                                    await dbFS.collection('products').doc(id).delete();
                                    showToast('Produk berhasil dihapus!', 'success');
                                    loadDashboardSummary(); // Update dashboard
                                } catch (error) {
                                    showToast('Gagal menghapus produk: ' + error.message, 'danger');
                                    console.error("Error deleting product:", error);
                                }
                            }
                        };
                    });
                });
            };

            // Search product
            searchProductInput.onkeyup = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = productsList.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    const nameCell = rows[i].cells[1]; // Product name is in the second column
                    if (nameCell) {
                        const name = nameCell.textContent.toLowerCase();
                        if (name.includes(searchTerm)) {
                            rows[i].style.display = '';
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            };

            loadProducts(); // Initial load
        }

        // =================================== ORDER MANAGEMENT ===================================
        function setupOrderManagement() {
            const ordersList = document.getElementById('orders-list');
            const searchOrderInput = document.getElementById('search-order');
            const orderStatusFilter = document.getElementById('order-status-filter');

            const loadOrders = (filterStatus = '', searchTerm = '') => {
                let query = dbFS.collection('orders').orderBy('timestamp', 'desc');

                if (filterStatus) {
                    query = query.where('status', '==', filterStatus);
                }

                query.onSnapshot(snapshot => {
                    ordersList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const buyerName = order.customerName.toLowerCase();
                        const buyerWhatsapp = normalizePhoneNumber(order.customerWhatsapp).toLowerCase();
                        
                        if (searchTerm && !(buyerName.includes(searchTerm) || buyerWhatsapp.includes(searchTerm))) {
                            return; // Skip if no match found for search term
                        }

                        const row = ordersList.insertRow();
                        row.insertCell(0).textContent = orderId.substring(0, 8); // Shorten ID
                        row.insertCell(1).textContent = order.customerName;
                        row.insertCell(2).textContent = order.customerWhatsapp;
                        
                        const productsCell = row.insertCell(3);
                        productsCell.innerHTML = order.items.map(item => `${item.name} (${item.quantity})`).join('<br>');
                        
                        row.insertCell(4).textContent = formatRupiah(order.totalAmount);
                        
                        const statusCell = row.insertCell(5);
                        const statusBadge = document.createElement('span');
                        statusBadge.classList.add('badge');
                        switch (order.status) {
                            case 'Pending':
                                statusBadge.classList.add('bg-warning', 'text-dark');
                                break;
                            case 'Diproses':
                                statusBadge.classList.add('bg-info');
                                break;
                            case 'Dikirim':
                                statusBadge.classList.add('bg-primary');
                                break;
                            case 'Selesai':
                                statusBadge.classList.add('bg-success');
                                break;
                            case 'Dibatalkan':
                                statusBadge.classList.add('bg-danger');
                                break;
                            default:
                                statusBadge.classList.add('bg-secondary');
                        }
                        statusBadge.textContent = order.status;
                        statusCell.appendChild(statusBadge);

                        row.insertCell(6).textContent = new Date(order.timestamp.toDate()).toLocaleString();

                        const actionsCell = row.insertCell(7);
                        actionsCell.innerHTML = `
                            <select class="form-select form-select-sm order-status-select" data-id="${orderId}">
                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Diproses" ${order.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                <option value="Dikirim" ${order.status === 'Dikirim' ? 'selected' : ''}>Dikirim</option>
                                <option value="Selesai" ${order.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                <option value="Dibatalkan" ${order.status === 'Dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                            </select>
                            <button class="btn btn-sm btn-info mt-2 view-order-details-btn" data-id="${orderId}">Detail</button>
                        `;
                    });

                    document.querySelectorAll('.order-status-select').forEach(select => {
                        select.onchange = async (e) => {
                            const id = e.target.dataset.id;
                            const newStatus = e.target.value;
                            try {
                                await dbFS.collection('orders').doc(id).update({ status: newStatus });
                                showToast(`Status pesanan ${id.substring(0, 8)} diubah menjadi ${newStatus}`, 'success');
                                loadDashboardSummary(); // Update dashboard
                            } catch (error) {
                                showToast('Gagal mengubah status pesanan: ' + error.message, 'danger');
                            }
                        };
                    });
                });
            };

            searchOrderInput.onkeyup = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const currentStatus = orderStatusFilter.value;
                loadOrders(currentStatus, searchTerm);
            };

            orderStatusFilter.onchange = (e) => {
                const filterStatus = e.target.value;
                const currentSearchTerm = searchOrderInput.value.toLowerCase();
                loadOrders(filterStatus, currentSearchTerm);
            };

            loadOrders(); // Initial load
        }

        // =================================== RESELLER MANAGEMENT ===================================
        function setupResellerManagement() {
            const addResellerForm = document.getElementById('add-reseller-form');
            const resellerNameInput = document.getElementById('reseller-name');
            const resellerEmailInput = document.getElementById('reseller-email');
            const resellerWhatsappInput = document.getElementById('reseller-whatsapp');
            const resellerHasDiscountCheck = document.getElementById('reseller-has-discount-check');
            const resellersList = document.getElementById('resellers-list');
            const searchResellerInput = document.getElementById('search-reseller');

            addResellerForm.onsubmit = async (e) => {
                e.preventDefault();
                const button = e.target.querySelector('[type=submit]');
                setButtonLoading(button, true);

                const name = resellerNameInput.value;
                const email = resellerEmailInput.value;
                const whatsapp = normalizePhoneNumber(resellerWhatsappInput.value);
                const punyaHakDiskon = resellerHasDiscountCheck.checked;

                try {
                    // Check if email or WhatsApp already exists
                    const existingReseller = await dbFS.collection('resellers')
                        .where('email', '==', email)
                        .get();
                    
                    const existingWhatsapp = await dbFS.collection('resellers')
                        .where('whatsapp', '==', whatsapp)
                        .get();

                    if (!existingReseller.empty) {
                        showToast('Reseller dengan email ini sudah terdaftar!', 'warning');
                        setButtonLoading(button, false);
                        return;
                    }
                    if (!existingWhatsapp.empty) {
                        showToast('Reseller dengan nomor WhatsApp ini sudah terdaftar!', 'warning');
                        setButtonLoading(button, false);
                        return;
                    }

                    await dbFS.collection('resellers').add({
                        name,
                        email,
                        whatsapp,
                        punyaHakDiskon,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Reseller berhasil ditambahkan!', 'success');
                    addResellerForm.reset();
                    loadDashboardSummary(); // Update dashboard
                } catch (error) {
                    showToast('Gagal menambahkan reseller: ' + error.message, 'danger');
                } finally {
                    setButtonLoading(button, false);
                }
            };

            const loadResellers = (searchTerm = '') => {
                dbFS.collection('resellers').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    resellersList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const reseller = doc.data();
                        const resellerId = doc.id;
                        const nameLower = reseller.name.toLowerCase();
                        const emailLower = reseller.email.toLowerCase();
                        const whatsappLower = normalizePhoneNumber(reseller.whatsapp).toLowerCase();
                        
                        if (searchTerm && !(nameLower.includes(searchTerm) || emailLower.includes(searchTerm) || whatsappLower.includes(searchTerm))) {
                            return; // Skip if no match found for search term
                        }

                        const row = resellersList.insertRow();
                        row.insertCell(0).textContent = reseller.name;
                        row.insertCell(1).textContent = reseller.email;
                        row.insertCell(2).textContent = reseller.whatsapp;
                        
                        const discountStatusCell = row.insertCell(3);
                        discountStatusCell.innerHTML = `<span class="badge ${reseller.punyaHakDiskon ? 'bg-success' : 'bg-secondary'}">${reseller.punyaHakDiskon ? 'Aktif' : 'Tidak Aktif'}</span>`;
                        
                        const actionsCell = row.insertCell(4);
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm ${reseller.punyaHakDiskon ? 'btn-secondary' : 'btn-success'} toggle-discount-btn me-2" data-id="${resellerId}" data-status="${reseller.punyaHakDiskon}">
                                ${reseller.punyaHakDiskon ? 'Nonaktifkan Diskon' : 'Aktifkan Diskon'}
                            </button>
                            <button class="btn btn-sm btn-danger delete-reseller-btn" data-id="${resellerId}">Hapus</button>
                        `;
                    });

                    document.querySelectorAll('.toggle-discount-btn').forEach(button => {
                        button.onclick = async (e) => {
                            const id = e.target.dataset.id;
                            const currentStatus = e.target.dataset.status === 'true';
                            const newStatus = !currentStatus;
                            try {
                                await dbFS.collection('resellers').doc(id).update({ punyaHakDiskon: newStatus });
                                showToast(`Hak diskon reseller berhasil di${newStatus ? 'aktifkan' : 'nonaktifkan'}!`, 'success');
                            } catch (error) {
                                showToast('Gagal mengubah hak diskon reseller: ' + error.message, 'danger');
                            }
                        };
                    });

                    document.querySelectorAll('.delete-reseller-btn').forEach(button => {
                        button.onclick = async (e) => {
                            if (confirm('Apakah Anda yakin ingin menghapus reseller ini?')) {
                                const id = e.target.dataset.id;
                                try {
                                    await dbFS.collection('resellers').doc(id).delete();
                                    showToast('Reseller berhasil dihapus!', 'success');
                                    loadDashboardSummary(); // Update dashboard
                                } catch (error) {
                                    showToast('Gagal menghapus reseller: ' + error.message, 'danger');
                                }
                            }
                        };
                    });
                });
            };

            searchResellerInput.onkeyup = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                loadResellers(searchTerm);
            };

            loadResellers(); // Initial load
        }

        // =================================== MANAJEMEN PROMO MANUAL & HADIAH KHUSUS ===================================
        function setupPromoManagementForms() {
            const resellerPromoForm = document.getElementById('grant-reseller-promo-form');
            const manageGiftEligibilityForm = document.getElementById('manage-gift-eligibility-form');
            const userTypeSelect = document.getElementById('user-type');
            const userWhatsappValueInput = document.getElementById('user-whatsapp-value');
            const activateGiftBtn = document.getElementById('activate-gift-btn');
            const deactivateGiftBtn = document.getElementById('deactivate-gift-btn');
            const checkGiftStatusBtn = document.getElementById('check-gift-status-btn');
            const giftStatusResult = document.getElementById('gift-status-result');

            // Form untuk memberikan diskon ke Reseller (ini tetap terpisah untuk diskon Rp 5.000)
            if (resellerPromoForm) {
                resellerPromoForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('reseller-promo-email').value;
                    const button = e.target.querySelector('[type=submit]');
                    setButtonLoading(button, true);

                    try {
                        const resellerQuery = await dbFS.collection('resellers').where('email', '==', email).limit(1).get();
                        if (resellerQuery.empty) {
                            throw new Error('Reseller dengan email tersebut tidak ditemukan.');
                        }
                        const resellerDoc = resellerQuery.docs[0];
                        await dbFS.collection('resellers').doc(resellerDoc.id).update({
                            punyaHakDiskon: true // Memberikan hak diskon kepada reseller
                        });
                        showToast(`Hak diskon berhasil diberikan kepada reseller: ${email}`, 'success');
                        resellerPromoForm.reset();
                    } catch (error) {
                        showToast('Gagal: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                };
            }

            // Form dan tombol untuk manajemen Hadiah Khusus (Banner "Sebuah Kejutan Manis")
            if (manageGiftEligibilityForm) {
                const getIdentifier = () => {
                    const userType = userTypeSelect.value; // 'umum' atau 'reseller'
                    let whatsappValue = normalizePhoneNumber(userWhatsappValueInput.value.trim());
                    return { userType, whatsappValue };
                };

                const updateGiftEligibility = async (isEligible, button) => {
                    const { userType, whatsappValue } = getIdentifier();
                    if (!whatsappValue) {
                        showToast("Harap masukkan Nomor WhatsApp.", 'warning');
                        return;
                    }
                    setButtonLoading(button, true);
                    giftStatusResult.style.display = 'none';

                    try {
                        // Selalu mencari atau membuat dokumen berdasarkan whatsappValue + userType
                        const querySnapshot = await dbFS.collection('promoEligibility')
                            .where('identifier', '==', whatsappValue)
                            .where('userType', '==', userType)
                            .limit(1).get();

                        let docRef;
                        if (!querySnapshot.empty) {
                            docRef = querySnapshot.docs[0].ref; // Dokumen sudah ada, gunakan referensinya
                            await docRef.update({ isGiftEligible: isEligible });
                        } else {
                            // Dokumen belum ada, buat baru
                            docRef = dbFS.collection('promoEligibility').doc(); // Firestore auto-generates ID
                            await docRef.set({
                                identifier: whatsappValue,
                                identifierType: 'whatsapp', // Selalu 'whatsapp' sekarang
                                userType: userType,
                                isGiftEligible: isEligible
                            });
                        }
                        
                        showToast(`Hadiah untuk ${whatsappValue} (${userType}) berhasil di${isEligible ? 'aktifkan' : 'nonaktifkan'}!`, 'success');
                    } catch (error) {
                        showToast('Gagal memperbarui status hadiah: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                };

                activateGiftBtn.onclick = () => updateGiftEligibility(true, activateGiftBtn);
                deactivateGiftBtn.onclick = () => updateGiftEligibility(false, deactivateGiftBtn);

                checkGiftStatusBtn.onclick = async () => {
                    const { userType, whatsappValue } = getIdentifier();
                    if (!whatsappValue) {
                        showToast("Harap masukkan Nomor WhatsApp untuk cek status.", 'warning');
                        return;
                    }
                    setButtonLoading(checkGiftStatusBtn, true);
                    giftStatusResult.style.display = 'none';

                    try {
                        const querySnapshot = await dbFS.collection('promoEligibility')
                            .where('identifier', '==', whatsappValue)
                            .where('userType', '==', userType)
                            .limit(1).get();

                        if (!querySnapshot.empty) {
                            const data = querySnapshot.docs[0].data();
                            const status = data.isGiftEligible ? 'Aktif' : 'Nonaktif';
                            giftStatusResult.className = `mt-3 alert alert-${data.isGiftEligible ? 'success' : 'warning'}`;
                            giftStatusResult.textContent = `Status hadiah untuk ${whatsappValue} (${userType}) adalah: ${status}`;
                        } else {
                            giftStatusResult.className = 'mt-3 alert alert-info';
                            giftStatusResult.textContent = `Status hadiah untuk ${whatsappValue} (${userType}) belum diatur (default: Nonaktif).`;
                        }
                        giftStatusResult.style.display = 'block';
                    } catch (error) {
                        showToast('Gagal cek status hadiah: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(checkGiftStatusBtn, false);
                    }
                };
            }
        }

        // Initialize functions on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardSummary();
            setupProductForms();
            setupOrderManagement();
            setupResellerManagement();
            setupPromoManagementForms();

            // Activate default tab (Dashboard)
            const dashboardTab = new bootstrap.Tab(document.getElementById('dashboard-tab'));
            dashboardTab.show();

            // Event listeners for tab changes to reload data or ensure fresh state
            document.querySelectorAll('.nav-link').forEach(tabLink => {
                tabLink.addEventListener('shown.bs.tab', function (event) {
                    const targetTabId = event.target.getAttribute('href');
                    if (targetTabId === '#dashboard') {
                        loadDashboardSummary();
                    }
                    // For other tabs, the onSnapshot listeners handle live updates.
                    // But if there's any state to reset (e.g., forms), do it here.
                });
            });
        });
    </script>
</body>
</html>
