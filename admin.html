<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
            --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
            --success: #28a745; --danger: #e74c3c;
            --info: #0c5460; --warning: #856404;
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
            --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); transition: background-color 0.3s ease, color 0.3s ease; }
        .container-fluid { margin-top: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); }
        .nav-tabs .nav-link { color: var(--text); border-color: var(--border); }
        .nav-tabs .nav-link.active { background-color: var(--card); border-color: var(--border) var(--border) transparent; color: var(--primary); }
        .tab-content { padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: var(--primary); color: white; }
        tr:hover { background-color: rgba(0,0,0,0.05); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .status-pending, .status-menunggu-verifikasi { background-color: #ffc107; color: black; }
        .status-diproses { background-color: #3498db; color: white; }
        .status-selesai { background-color: #28a745; color: white; }
        .status-dibatalkan, .status-ditolak { background-color: #e74c3c; color: white; }
        .status-belum-bayar { background-color: #007bff; color: white; }
        .text-break-all { word-break: break-all; }
        .img-preview { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 5px; }
        .wa-link { display: inline-block; margin-left: 5px; }
        .wa-active-toggle { cursor: pointer; }
        .wa-active-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        .wa-active-dot.active { background-color: #28a745; } /* Green */
        .wa-active-dot.inactive { background-color: #6c757d; } /* Gray */
    </style>
</head>
<body data-theme="dark">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Dashboard</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <h1 class="mb-4">Selamat Datang, Admin!</h1>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pesanan-tab" data-bs-toggle="tab" data-bs-target="#pesanan" type="button" role="tab" aria-controls="pesanan" aria-selected="true">Pesanan</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="produk-tab" data-bs-toggle="tab" data-bs-target="#produk" type="button" role="tab" aria-controls="produk" aria-selected="false">Produk</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reseller-tab" data-bs-toggle="tab" data-bs-target="#reseller" type="button" role="tab" aria-controls="reseller" aria-selected="false">Reseller</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="topup-tab" data-bs-toggle="tab" data-bs-target="#topup" type="button" role="tab" aria-controls="topup" aria-selected="false">Konfirmasi Top Up</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pembayaran-tab" data-bs-toggle="tab" data-bs-target="#pembayaran" type="button" role="tab" aria-controls="pembayaran" aria-selected="false">Info Pembayaran</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="banner-tab" data-bs-toggle="tab" data-bs-target="#banner" type="button" role="tab" aria-controls="banner" aria-selected="false">Banner</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="testimoni-tab" data-bs-toggle="tab" data-bs-target="#testimoni" type="button" role="tab" aria-controls="testimoni" aria-selected="false">Testimoni</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq" type="button" role="tab" aria-controls="faq" aria-selected="false">FAQ</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="pesanan" role="tabpanel" aria-labelledby="pesanan-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Daftar Pesanan</h3>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="orderFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Filter Pesanan: Semua Pesanan
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="orderFilterDropdown">
                        <li><a class="dropdown-item" href="#" data-filter="all">Semua Pesanan</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="umum">Pesanan Pembeli Biasa (Firestore)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="reseller">Pesanan Reseller (Firestore)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="rtdb">Pesanan Lama (Realtime Database)</a></li>
                    </ul>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Pesanan</th>
                            <th>Pelanggan</th>
                            <th>No. HP</th>
                            <th>WA Aktif</th>
                            <th>ID Game</th>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Status</th>
                            <th>Waktu</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="pesananTableBody">
                        </tbody>
                </table>
            </div>
            <p id="pesananLoading" class="text-center mt-3">Memuat pesanan...</p>
            <p id="noPesananFound" class="text-center mt-3 d-none">Belum ada pesanan.</p>
        </div>

        <div class="tab-pane fade" id="produk" role="tabpanel" aria-labelledby="produk-tab">
            <h3>Produk</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit Produk</h5>
                <div class="mb-3">
                    <label for="produkId" class="form-label">ID Produk (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="produkId" readonly>
                </div>
                <div class="mb-3">
                    <label for="produkNama" class="form-label">Nama Produk</label>
                    <input type="text" class="form-control" id="produkNama" required>
                </div>
                <div class="mb-3">
                    <label for="produkHarga" class="form-label">Harga Produk</label>
                    <input type="number" class="form-control" id="produkHarga" required>
                </div>
                <button class="btn btn-primary" onclick="saveProduk()">Simpan Produk</button>
                <button class="btn btn-secondary mt-2" onclick="resetProdukForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Produk</th>
                            <th>Nama</th>
                            <th>Harga</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="produkTableBody">
                        </tbody>
                </table>
            </div>
            <p id="produkLoading" class="text-center mt-3">Memuat produk...</p>
            <p id="noProdukFound" class="text-center mt-3 d-none">Belum ada produk.</p>
        </div>

        <div class="tab-pane fade" id="reseller" role="tabpanel" aria-labelledby="reseller-tab">
            <h3>Reseller</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit Reseller</h5>
                <div class="mb-3">
                    <label for="resellerId" class="form-label">ID Reseller (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="resellerId" readonly>
                </div>
                <div class="mb-3">
                    <label for="resellerNama" class="form-label">Nama Reseller</label>
                    <input type="text" class="form-control" id="resellerNama" required>
                </div>
                <div class="mb-3">
                    <label for="resellerEmail" class="form-label">Email Reseller</label>
                    <input type="email" class="form-control" id="resellerEmail" required>
                </div>
                <div class="mb-3">
                    <label for="resellerSaldo" class="form-label">Saldo Reseller</label>
                    <input type="number" class="form-control" id="resellerSaldo" required>
                </div>
                <button class="btn btn-primary" onclick="saveReseller()">Simpan Reseller</button>
                <button class="btn btn-secondary mt-2" onclick="resetResellerForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Reseller</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>Saldo</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="resellerTableBody">
                        </tbody>
                </table>
            </div>
            <p id="resellerLoading" class="text-center mt-3">Memuat reseller...</p>
            <p id="noResellerFound" class="text-center mt-3 d-none">Belum ada reseller.</p>
        </div>

        <div class="tab-pane fade" id="topup" role="tabpanel" aria-labelledby="topup-tab">
            <h3>Konfirmasi Top Up Reseller</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Top Up</th>
                            <th>Reseller</th>
                            <th>Jumlah</th>
                            <th>Waktu</th>
                            <th>Bukti</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="topupTableBody">
                        </tbody>
                </table>
            </div>
            <p id="topupLoading" class="text-center mt-3">Memuat permintaan top up...</p>
            <p id="noTopupFound" class="text-center mt-3 d-none">Belum ada permintaan top up.</p>
        </div>

        <div class="tab-pane fade" id="pembayaran" role="tabpanel" aria-labelledby="pembayaran-tab">
            <h3>Informasi Pembayaran</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit Info Pembayaran</h5>
                <div class="mb-3">
                    <label for="paymentId" class="form-label">ID Pembayaran (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="paymentId" readonly>
                </div>
                <div class="mb-3">
                    <label for="paymentBank" class="form-label">Nama Bank / Metode Pembayaran</label>
                    <input type="text" class="form-control" id="paymentBank" required>
                </div>
                <div class="mb-3">
                    <label for="paymentNomor" class="form-label">Nomor Rekening / ID</label>
                    <input type="text" class="form-control" id="paymentNomor" required>
                </div>
                <div class="mb-3">
                    <label for="paymentNama" class="form-label">Nama Pemilik</label>
                    <input type="text" class="form-control" id="paymentNama" required>
                </div>
                <button class="btn btn-primary" onclick="savePaymentInfo()">Simpan Info</button>
                <button class="btn btn-secondary mt-2" onclick="resetPaymentForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bank/Metode</th>
                            <th>Nomor</th>
                            <th>Nama Pemilik</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="paymentTableBody">
                        </tbody>
                </table>
            </div>
            <p id="paymentLoading" class="text-center mt-3">Memuat info pembayaran...</p>
            <p id="noPaymentFound" class="text-center mt-3 d-none">Belum ada info pembayaran.</p>
        </div>

        <div class="tab-pane fade" id="banner" role="tabpanel" aria-labelledby="banner-tab">
            <h3>Banner Promosi</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit Banner</h5>
                <div class="mb-3">
                    <label for="bannerId" class="form-label">ID Banner (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="bannerId" readonly>
                </div>
                <div class="mb-3">
                    <label for="bannerImage" class="form-label">Gambar Banner</label>
                    <input type="file" class="form-control" id="bannerImage" accept="image/*">
                    <small class="text-muted">Upload gambar baru untuk mengganti yang lama.</small>
                    <div id="currentBannerImage" class="mt-2"></div>
                </div>
                <button class="btn btn-primary" onclick="saveBanner()">Simpan Banner</button>
                <button class="btn btn-secondary mt-2" onclick="resetBannerForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Gambar</th>
                            <th>URL</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="bannerTableBody">
                        </tbody>
                </table>
            </div>
            <p id="bannerLoading" class="text-center mt-3">Memuat banner...</p>
            <p id="noBannerFound" class="text-center mt-3 d-none">Belum ada banner.</p>
        </div>

        <div class="tab-pane fade" id="testimoni" role="tabpanel" aria-labelledby="testimoni-tab">
            <h3>Testimoni Pelanggan</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit Testimoni</h5>
                <div class="mb-3">
                    <label for="testiId" class="form-label">ID Testimoni (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="testiId" readonly>
                </div>
                <div class="mb-3">
                    <label for="testiNama" class="form-label">Nama Pelanggan</label>
                    <input type="text" class="form-control" id="testiNama" required>
                </div>
                <div class="mb-3">
                    <label for="testiRating" class="form-label">Rating (1-5)</label>
                    <input type="number" class="form-control" id="testiRating" min="1" max="5" required>
                </div>
                <div class="mb-3">
                    <label for="testiIsi" class="form-label">Isi Testimoni</label>
                    <textarea class="form-control" id="testiIsi" rows="3" required></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveTestimoni()">Simpan Testimoni</button>
                <button class="btn btn-secondary mt-2" onclick="resetTestiForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Rating</th>
                            <th>Isi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="testiTableBody">
                        </tbody>
                </table>
            </div>
            <p id="testiLoading" class="text-center mt-3">Memuat testimoni...</p>
            <p id="noTestiFound" class="text-center mt-3 d-none">Belum ada testimoni.</p>
        </div>

        <div class="tab-pane fade" id="faq" role="tabpanel" aria-labelledby="faq-tab">
            <h3>Frequently Asked Questions (FAQ)</h3>
            <div class="card p-3 mb-4">
                <h5>Tambah/Edit FAQ</h5>
                <div class="mb-3">
                    <label for="faqId" class="form-label">ID FAQ (Kosongkan untuk baru)</label>
                    <input type="text" class="form-control" id="faqId" readonly>
                </div>
                <div class="mb-3">
                    <label for="faqQuestion" class="form-label">Pertanyaan</label>
                    <input type="text" class="form-control" id="faqQuestion" required>
                </div>
                <div class="mb-3">
                    <label for="faqAnswer" class="form-label">Jawaban</label>
                    <textarea class="form-control" id="faqAnswer" rows="3" required></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveFaq()">Simpan FAQ</button>
                <button class="btn btn-secondary mt-2" onclick="resetFaqForm()">Batal</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Pertanyaan</th>
                            <th>Jawaban</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="faqTableBody">
                        </tbody>
                </table>
            </div>
            <p id="faqLoading" class="text-center mt-3">Memuat FAQ...</p>
            <p id="noFaqFound" class="text-center mt-3 d-none">Belum ada FAQ.</p>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
    // Konfigurasi Firebase Anda (GANTI DENGAN DATA ASLI PROYEK ANDA)
    const firebaseConfig = {
        apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // GANTI INI
        authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com", // GANTI INI
        databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com", // GANTI INI
        projectId: "asdarstoredigitalll-d89c4", // GANTI INI
        storageBucket: "asdarstoredigitalll-d89c4.appspot.com", // GANTI INI
        appId: "1:842211995874:web:e000000000000000000000" // GANTI INI (jika ada)
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const dbFS = firebase.firestore();
    const dbRT = firebase.database();
    const storage = firebase.storage();

    // --- Autentikasi Admin ---
    auth.onAuthStateChanged(user => {
        if (!user) {
            // Jika belum login, redirect ke halaman login
            window.location.href = 'login.html'; // Sesuaikan dengan nama file login Anda
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => {
            alert('Anda telah berhasil logout!');
            window.location.href = 'login.html'; // Redirect ke halaman login setelah logout
        }).catch((error) => {
            console.error("Error signing out: ", error);
            alert("Terjadi kesalahan saat logout.");
        });
    });

    // --- Helper Functions ---
    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    function cleanPhoneNumber(phone) {
        if (!phone) return '';
        let cleaned = phone.toString().replace(/\D/g, ''); // Hapus semua karakter non-digit
        // Jika dimulai dengan 08, ganti jadi 628
        if (cleaned.startsWith('08')) {
            cleaned = '62' + cleaned.substring(1);
        }
        // Pastikan dimulai dengan 62, jika tidak tambahkan
        if (cleaned.length > 0 && !cleaned.startsWith('62')) {
            cleaned = '62' + cleaned;
        }
        return cleaned;
    }

    // --- Order Management ---
    const pesananTableBody = document.getElementById('pesananTableBody');
    const pesananLoading = document.getElementById('pesananLoading');
    const noPesananFound = document.getElementById('noPesananFound');
    let currentOrderFilter = 'all';

    async function loadOrders() {
        pesananLoading.style.display = 'block';
        pesananTableBody.innerHTML = '';
        noPesananFound.classList.add('d-none');

        let allOrders = [];

        try {
            // Load from Firestore: pesananUmum
            if (currentOrderFilter === 'all' || currentOrderFilter === 'umum') {
                const umumSnapshot = await dbFS.collection('pesananUmum').orderBy('waktu', 'desc').get();
                umumSnapshot.forEach(doc => {
                    const data = doc.data();
                    allOrders.push({
                        id: doc.id,
                        collectionType: 'pesananUmum',
                        // Fleksibilitas membaca field
                        customer_name: data.nama_pelanggan || 'N/A',
                        customer_phone: data.nomor_pelanggan || data.nomor_hp || data.nomor || 'N/A',
                        game_id: data.id_game || data.id || data.username_game || 'N/A',
                        product_name: data.produk || data.product_name || 'N/A',
                        price: data.harga_final || data.harga_beli || data.price || 0,
                        status: data.status || 'Belum Bayar',
                        waktu: data.waktu ? data.waktu.toDate() : null,
                        wa_aktif: data.wa_aktif === true // Pastikan boolean
                    });
                });
            }

            // Load from Firestore: pesananReseller
            if (currentOrderFilter === 'all' || currentOrderFilter === 'reseller') {
                const resellerSnapshot = await dbFS.collection('pesananReseller').orderBy('waktu', 'desc').get();
                resellerSnapshot.forEach(doc => {
                    const data = doc.data();
                    allOrders.push({
                        id: doc.id,
                        collectionType: 'pesananReseller',
                        // Fleksibilitas membaca field
                        customer_name: data.nama_pelanggan || data.nama_reseller || 'N/A', 
                        customer_phone: data.nomor_pelanggan || data.nomor_hp || data.nomor || 'N/A',
                        game_id: data.id_game || data.id || data.username_game || 'N/A',
                        product_name: data.produk || data.product_name || 'N/A',
                        price: data.harga_final || data.harga_beli || data.price || 0,
                        status: data.status || 'Belum Bayar',
                        waktu: data.waktu ? data.waktu.toDate() : null,
                        isResellerOrder: true,
                        wa_aktif: data.wa_aktif === true // Pastikan boolean
                    });
                });
            }

            // Load from Realtime Database: pesanan (lama)
            if (currentOrderFilter === 'all' || currentOrderFilter === 'rtdb') {
                const rtdbSnapshot = await dbRT.ref('pesanan').orderByChild('waktu').once('value');
                rtdbSnapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    let waktuDate = null;
                    if (data.waktu) {
                        try {
                            waktuDate = new Date(data.waktu); // RTDB bisa string ISO atau timestamp number
                            if (isNaN(waktuDate.getTime())) waktuDate = null; 
                        } catch (e) { waktuDate = null; }
                    }
                    
                    allOrders.push({
                        id: childSnapshot.key,
                        collectionType: 'pesananRTDB',
                        // Fleksibilitas membaca field untuk RTDB
                        customer_name: data.nama_pelanggan || data.nama || 'N/A', 
                        customer_phone: data.nomor_hp || data.nomor || 'N/A', 
                        game_id: data.id_game || data.id || data.username_game || 'N/A', 
                        product_name: data.produk || data.item || 'N/A',
                        price: data.harga || 0,
                        status: data.status || 'Belum Bayar',
                        waktu: waktuDate,
                        wa_aktif: data.wa_aktif === true // Pastikan boolean
                    });
                });
            }

            // Sort all orders by time (descending)
            allOrders.sort((a, b) => (b.waktu ? b.waktu.getTime() : 0) - (a.waktu ? a.waktu.getTime() : 0));

            if (allOrders.length === 0) {
                noPesananFound.classList.remove('d-none');
            } else {
                allOrders.forEach(order => {
                    renderOrderRow(order);
                });
            }
        } catch (error) {
            console.error("Error loading orders:", error);
            pesananTableBody.innerHTML = `<tr><td colspan="10" class="text-danger text-center">Terjadi kesalahan saat memuat pesanan.</td></tr>`;
        } finally {
            pesananLoading.style.display = 'none';
        }
    }

    function renderOrderRow(order) {
        let statusClass = `status-${(order.status || 'Belum Bayar').toLowerCase().replace(/ /g, '-')}`;
        const displayTime = order.waktu ? order.waktu.toLocaleString() : 'N/A';
        const displayPrice = formatRupiah(order.price);
        
        // Pastikan nilai default 'N/A' jika data tidak ada
        const displayCustomerName = order.customer_name || 'N/A';
        const rawPhoneNumber = order.customer_phone || 'N/A';
        const cleanedPhone = cleanPhoneNumber(rawPhoneNumber); // Selalu bersihkan untuk link WA
        const displayGameId = order.game_id || 'N/A';
        const displayProduct = order.product_name || 'N/A';
        
        const waActive = order.wa_aktif === true;
        const waActiveDotClass = waActive ? 'active' : 'inactive';
        const waActiveText = waActive ? 'Aktif' : 'Belum Aktif';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><code>${order.id}</code></td>
            <td>${displayCustomerName} ${order.isResellerOrder ? '<span class="badge bg-info">Reseller</span>' : ''}</td>
            <td>
                ${rawPhoneNumber !== 'N/A' ? `${rawPhoneNumber}
                <a href="https://wa.me/${cleanedPhone}" target="_blank" class="wa-link" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a>` : 'N/A'}
            </td>
            <td>
                <span class="wa-active-dot ${waActiveDotClass}"></span>
                <span class="wa-active-text">${waActiveText}</span>
                <button class="btn btn-sm btn-link wa-active-toggle" data-order-id="${order.id}" data-collection-type="${order.collectionType}" data-current-status="${waActive}" onclick="toggleWaActiveFromTable(this)"><i class="fas fa-edit"></i></button>
            </td>
            <td>${displayGameId}</td>
            <td>${displayProduct}</td>
            <td>${displayPrice}</td>
            <td><span class="status-badge ${statusClass}">${order.status}</span></td>
            <td>${displayTime}</td>
            <td>
                <a href="detail-pesanan.html?id=${order.id}&collection=${order.collectionType}" class="btn btn-sm btn-info">Kelola</a>
            </td>
        `;
        pesananTableBody.appendChild(row);
    }

    // Event listener for order filter dropdown
    document.querySelectorAll('#orderFilterDropdown + .dropdown-menu .dropdown-item').forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            currentOrderFilter = this.dataset.filter;
            document.getElementById('orderFilterDropdown').textContent = `Filter Pesanan: ${this.textContent}`;
            loadOrders();
        });
    });

    // Toggle WA Active status from main table
    async function toggleWaActiveFromTable(buttonElement) {
        const orderId = buttonElement.dataset.orderId;
        const collectionType = buttonElement.dataset.collectionType;
        const currentStatus = buttonElement.dataset.currentStatus === 'true';
        const newStatus = !currentStatus;

        try {
            if (collectionType === 'pesananRTDB') {
                await dbRT.ref(`pesanan/${orderId}`).update({ wa_aktif: newStatus });
            } else { // Firestore
                await dbFS.collection(collectionType).doc(orderId).update({ wa_aktif: newStatus });
            }
            alert(`Status WA Aktif untuk pesanan ${orderId} berhasil diubah menjadi ${newStatus ? 'Aktif' : 'Belum Aktif'}.`);
            loadOrders(); // Reload orders to update the table
        } catch (error) {
            console.error("Error updating WA active status from table:", error);
            alert("Gagal mengubah status WA Aktif. Silakan coba lagi.");
        }
    }


    // --- Produk Management (Firestore) ---
    const produkTableBody = document.getElementById('produkTableBody');
    const produkLoading = document.getElementById('produkLoading');
    const noProdukFound = document.getElementById('noProdukFound');
    
    async function loadProduk() {
        produkLoading.style.display = 'block';
        produkTableBody.innerHTML = '';
        noProdukFound.classList.add('d-none');
        try {
            const snapshot = await dbFS.collection('produk').orderBy('nama_produk').get();
            if (snapshot.empty) {
                noProdukFound.classList.remove('d-none');
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${data.nama_produk}</td>
                        <td>${formatRupiah(data.harga)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editProduk('${doc.id}', '${data.nama_produk}', ${data.harga})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduk('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    produkTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading produk:", error);
            produkTableBody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">Terjadi kesalahan saat memuat produk.</td></tr>`;
        } finally {
            produkLoading.style.display = 'none';
        }
    }

    async function saveProduk() {
        const id = document.getElementById('produkId').value;
        const nama = document.getElementById('produkNama').value;
        const harga = parseFloat(document.getElementById('produkHarga').value);

        if (!nama || isNaN(harga)) {
            alert('Nama produk dan Harga harus diisi dengan benar.');
            return;
        }

        try {
            if (id) {
                await dbFS.collection('produk').doc(id).update({ nama_produk: nama, harga: harga });
                alert('Produk berhasil diperbarui!');
            } else {
                await dbFS.collection('produk').add({ nama_produk: nama, harga: harga });
                alert('Produk berhasil ditambahkan!');
            }
            resetProdukForm();
            loadProduk();
        } catch (error) {
            console.error("Error saving produk:", error);
            alert('Gagal menyimpan produk. Silakan coba lagi.');
        }
    }

    function editProduk(id, nama, harga) {
        document.getElementById('produkId').value = id;
        document.getElementById('produkNama').value = nama;
        document.getElementById('produkHarga').value = harga;
    }

    async function deleteProduk(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) return;
        try {
            await dbFS.collection('produk').doc(id).delete();
            alert('Produk berhasil dihapus!');
            loadProduk();
        } catch (error) {
            console.error("Error deleting produk:", error);
            alert('Gagal menghapus produk. Silakan coba lagi.');
        }
    }

    function resetProdukForm() {
        document.getElementById('produkId').value = '';
        document.getElementById('produkNama').value = '';
        document.getElementById('produkHarga').value = '';
    }

    // --- Reseller Management (Firestore) ---
    const resellerTableBody = document.getElementById('resellerTableBody');
    const resellerLoading = document.getElementById('resellerLoading');
    const noResellerFound = document.getElementById('noResellerFound');

    async function loadReseller() {
        resellerLoading.style.display = 'block';
        resellerTableBody.innerHTML = '';
        noResellerFound.classList.add('d-none');
        try {
            const snapshot = await dbFS.collection('resellers').orderBy('nama_reseller').get();
            if (snapshot.empty) {
                noResellerFound.classList.remove('d-none');
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${data.nama_reseller}</td>
                        <td>${data.email}</td>
                        <td>${formatRupiah(data.saldo || 0)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editReseller('${doc.id}', '${data.nama_reseller}', '${data.email}', ${data.saldo || 0})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReseller('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    resellerTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading reseller:", error);
            resellerTableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Terjadi kesalahan saat memuat reseller.</td></tr>`;
        } finally {
            resellerLoading.style.display = 'none';
        }
    }

    async function saveReseller() {
        const id = document.getElementById('resellerId').value;
        const nama = document.getElementById('resellerNama').value;
        const email = document.getElementById('resellerEmail').value;
        const saldo = parseFloat(document.getElementById('resellerSaldo').value);

        if (!nama || !email || isNaN(saldo)) {
            alert('Nama, Email, dan Saldo reseller harus diisi dengan benar.');
            return;
        }

        try {
            if (id) {
                await dbFS.collection('resellers').doc(id).update({ nama_reseller: nama, email: email, saldo: saldo });
                alert('Reseller berhasil diperbarui!');
            } else {
                await dbFS.collection('resellers').add({ nama_reseller: nama, email: email, saldo: saldo });
                alert('Reseller berhasil ditambahkan!');
            }
            resetResellerForm();
            loadReseller();
        } catch (error) {
            console.error("Error saving reseller:", error);
            alert('Gagal menyimpan reseller. Silakan coba lagi.');
        }
    }

    function editReseller(id, nama, email, saldo) {
        document.getElementById('resellerId').value = id;
        document.getElementById('resellerNama').value = nama;
        document.getElementById('resellerEmail').value = email;
        document.getElementById('resellerSaldo').value = saldo;
    }

    async function deleteReseller(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus reseller ini?')) return;
        try {
            await dbFS.collection('resellers').doc(id).delete();
            alert('Reseller berhasil dihapus!');
            loadReseller();
        } catch (error) {
            console.error("Error deleting reseller:", error);
            alert('Gagal menghapus reseller. Silakan coba lagi.');
        }
    }

    function resetResellerForm() {
        document.getElementById('resellerId').value = '';
        document.getElementById('resellerNama').value = '';
        document.getElementById('resellerEmail').value = '';
        document.getElementById('resellerSaldo').value = '';
    }

    // --- Top Up Confirmation Management (Firestore) ---
    const topupTableBody = document.getElementById('topupTableBody');
    const topupLoading = document.getElementById('topupLoading');
    const noTopupFound = document.getElementById('noTopupFound');

    async function loadTopups() {
        topupLoading.style.display = 'block';
        topupTableBody.innerHTML = '';
        noTopupFound.classList.add('d-none');
        try {
            const snapshot = await dbFS.collection('konfirmasiTopup').orderBy('waktu_request', 'desc').get();
            if (snapshot.empty) {
                noTopupFound.classList.remove('d-none');
            } else {
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    let resellerName = 'N/A';
                    if (data.reseller_id) {
                        try {
                            const resellerDoc = await dbFS.collection('resellers').doc(data.reseller_id).get();
                            if (resellerDoc.exists) {
                                resellerName = resellerDoc.data().nama_reseller;
                            }
                        } catch (e) { console.error("Error fetching reseller name:", e); }
                    }
                    
                    const row = document.createElement('tr');
                    let statusClass = '';
                    if (data.status === 'Pending') statusClass = 'status-pending';
                    else if (data.status === 'Diterima') statusClass = 'status-selesai';
                    else if (data.status === 'Ditolak') statusClass = 'status-dibatalkan';

                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${resellerName}</td>
                        <td>${formatRupiah(data.jumlah)}</td>
                        <td>${data.waktu_request ? data.waktu_request.toDate().toLocaleString() : 'N/A'}</td>
                        <td>${data.bukti_transfer_url ? `<a href="${data.bukti_transfer_url}" target="_blank">Lihat Bukti</a>` : 'Tidak Ada'}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td>
                            ${data.status === 'Pending' ? `
                                <button class="btn btn-sm btn-success" onclick="acceptTopup('${doc.id}', '${data.reseller_id}', ${data.jumlah})">Terima</button>
                                <button class="btn btn-sm btn-danger" onclick="rejectTopup('${doc.id}')">Tolak</button>
                            ` : 'Sudah Diproses'}
                        </td>
                    `;
                    topupTableBody.appendChild(row);
                }
            }
        } catch (error) {
            console.error("Error loading top ups:", error);
            topupTableBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">Terjadi kesalahan saat memuat top up.</td></tr>`;
        } finally {
            topupLoading.style.display = 'none';
        }
    }

    async function acceptTopup(topupId, resellerId, amount) {
        if (!confirm('Apakah Anda yakin ingin menerima permintaan top up ini? Saldo reseller akan ditambahkan.')) return;
        try {
            // Update status top up
            await dbFS.collection('konfirmasiTopup').doc(topupId).update({ status: 'Diterima', waktu_update: firebase.firestore.FieldValue.serverTimestamp() });
            
            // Tambah saldo reseller
            const resellerRef = dbFS.collection('resellers').doc(resellerId);
            await dbFS.runTransaction(async (transaction) => {
                const resellerDoc = await transaction.get(resellerRef);
                if (!resellerDoc.exists) {
                    throw "Dokumen reseller tidak ditemukan!";
                }
                const newSaldo = (resellerDoc.data().saldo || 0) + amount;
                transaction.update(resellerRef, { saldo: newSaldo });
            });

            alert('Top up berhasil diterima dan saldo reseller telah ditambahkan!');
            loadTopups();
            loadReseller(); // Refresh reseller table
        } catch (error) {
            console.error("Error accepting top up:", error);
            alert('Gagal menerima top up. Silakan coba lagi. Pastikan ID reseller benar dan aturan keamanan mengizinkan.');
        }
    }

    async function rejectTopup(topupId) {
        if (!confirm('Apakah Anda yakin ingin menolak permintaan top up ini?')) return;
        try {
            await dbFS.collection('konfirmasiTopup').doc(topupId).update({ status: 'Ditolak', waktu_update: firebase.firestore.FieldValue.serverTimestamp() });
            alert('Top up berhasil ditolak.');
            loadTopups();
        } catch (error) {
            console.error("Error rejecting top up:", error);
            alert('Gagal menolak top up. Silakan coba lagi.');
        }
    }

    // --- Payment Info Management (Firestore) ---
    const paymentTableBody = document.getElementById('paymentTableBody');
    const paymentLoading = document.getElementById('paymentLoading');
    const noPaymentFound = document.getElementById('noPaymentFound');

    async function loadPaymentInfo() {
        paymentLoading.style.display = 'block';
        paymentTableBody.innerHTML = '';
        noPaymentFound.classList.add('d-none');
        try {
            const snapshot = await dbFS.collection('infoPembayaran').orderBy('bank_nama').get();
            if (snapshot.empty) {
                noPaymentFound.classList.remove('d-none');
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${data.bank_nama}</td>
                        <td>${data.nomor_rekening}</td>
                        <td>${data.nama_pemilik}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editPaymentInfo('${doc.id}', '${data.bank_nama}', '${data.nomor_rekening}', '${data.nama_pemilik}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deletePaymentInfo('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    paymentTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading payment info:", error);
            paymentTableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Terjadi kesalahan saat memuat info pembayaran.</td></tr>`;
        } finally {
            paymentLoading.style.display = 'none';
        }
    }

    async function savePaymentInfo() {
        const id = document.getElementById('paymentId').value;
        const bank = document.getElementById('paymentBank').value;
        const nomor = document.getElementById('paymentNomor').value;
        const nama = document.getElementById('paymentNama').value;

        if (!bank || !nomor || !nama) {
            alert('Semua field informasi pembayaran harus diisi.');
            return;
        }

        try {
            if (id) {
                await dbFS.collection('infoPembayaran').doc(id).update({ bank_nama: bank, nomor_rekening: nomor, nama_pemilik: nama });
                alert('Informasi pembayaran berhasil diperbarui!');
            } else {
                await dbFS.collection('infoPembayaran').add({ bank_nama: bank, nomor_rekening: nomor, nama_pemilik: nama });
                alert('Informasi pembayaran berhasil ditambahkan!');
            }
            resetPaymentForm();
            loadPaymentInfo();
        } catch (error) {
            console.error("Error saving payment info:", error);
            alert('Gagal menyimpan informasi pembayaran. Silakan coba lagi.');
        }
    }

    function editPaymentInfo(id, bank, nomor, nama) {
        document.getElementById('paymentId').value = id;
        document.getElementById('paymentBank').value = bank;
        document.getElementById('paymentNomor').value = nomor;
        document.getElementById('paymentNama').value = nama;
    }

    async function deletePaymentInfo(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus informasi pembayaran ini?')) return;
        try {
            await dbFS.collection('infoPembayaran').doc(id).delete();
            alert('Informasi pembayaran berhasil dihapus!');
            loadPaymentInfo();
        } catch (error) {
            console.error("Error deleting payment info:", error);
            alert('Gagal menghapus informasi pembayaran. Silakan coba lagi.');
        }
    }

    function resetPaymentForm() {
        document.getElementById('paymentId').value = '';
        document.getElementById('paymentBank').value = '';
        document.getElementById('paymentNomor').value = '';
        document.getElementById('paymentNama').value = '';
    }

    // --- Banner Management (Firestore & Storage) ---
    const bannerTableBody = document.getElementById('bannerTableBody');
    const bannerLoading = document.getElementById('bannerLoading');
    const noBannerFound = document.getElementById('noBannerFound');
    const currentBannerImageDiv = document.getElementById('currentBannerImage');

    async function loadBanners() {
        bannerLoading.style.display = 'block';
        bannerTableBody.innerHTML = '';
        noBannerFound.classList.add('d-none');
        try {
            const snapshot = await dbFS.collection('banners').orderBy('order', 'asc').get();
            if (snapshot.empty) {
                noBannerFound.classList.remove('d-none');
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td><img src="${data.imageUrl}" alt="Banner" class="img-preview"></td>
                        <td class="text-break-all">${data.imageUrl}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editBanner('${doc.id}', '${data.imageUrl || ''}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBanner('${doc.id}', '${data.imageUrl || ''}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    bannerTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading banners:", error);
            bannerTableBody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">Terjadi kesalahan saat memuat banner.</td></tr>`;
        } finally {
            bannerLoading.style.display = 'none';
        }
    }

    async function saveBanner() {
        const id = document.getElementById('bannerId').value;
        const fileInput = document.getElementById('bannerImage');
        const file = fileInput.files[0];

        if (!file && !id) { // Jika baru dan tidak ada file
            alert('Pilih file gambar untuk banner baru.');
            return;
        }

        try {
            let imageUrl = '';
            if (file) { // Ada file baru untuk diupload
                const storageRef = storage.ref(`banners/${Date.now()}-${file.name}`);
                const uploadTask = await storageRef.put(file);
                imageUrl = await uploadTask.ref.getDownloadURL();
            } else if (id && currentBannerImageDiv.querySelector('img')) { // Edit tapi tidak upload file baru, gunakan URL lama
                imageUrl = currentBannerImageDiv.querySelector('img').src;
            }

            if (!imageUrl) {
                alert('Gagal mendapatkan URL gambar. Silakan coba lagi.');
                return;
            }

            if (id) {
                await dbFS.collection('banners').doc(id).update({ imageUrl: imageUrl });
                alert('Banner berhasil diperbarui!');
            } else {
                await dbFS.collection('banners').add({ imageUrl: imageUrl, order: Date.now() }); // Menambahkan order untuk sorting
                alert('Banner berhasil ditambahkan!');
            }
            resetBannerForm();
            loadBanners();
        } catch (error) {
            console.error("Error saving banner:", error);
            alert('Gagal menyimpan banner. Silakan coba lagi.');
        }
    }

    function editBanner(id, imageUrl) {
        document.getElementById('bannerId').value = id;
        currentBannerImageDiv.innerHTML = imageUrl ? `<img src="${imageUrl}" class="img-preview mt-2" alt="Current Banner">` : '';
        document.getElementById('bannerImage').value = ''; // Clear file input
    }

    async function deleteBanner(id, imageUrl) {
        if (!confirm('Apakah Anda yakin ingin menghapus banner ini? Ini juga akan menghapus gambar dari storage.')) return;
        try {
            if (imageUrl) {
                // Hapus gambar dari Storage
                const imageRef = storage.refFromURL(imageUrl);
                await imageRef.delete().catch(e => console.warn("Could not delete image from storage, might not exist:", e));
            }
            // Hapus dokumen dari Firestore
            await dbFS.collection('banners').doc(id).delete();
            alert('Banner berhasil dihapus!');
            loadBanners();
        } catch (error) {
            console.error("Error deleting banner:", error);
            alert('Gagal menghapus banner. Silakan coba lagi.');
        }
    }

    function resetBannerForm() {
        document.getElementById('bannerId').value = '';
        document.getElementById('bannerImage').value = '';
        currentBannerImageDiv.innerHTML = '';
    }

    // --- Testimonial Management (Realtime Database) ---
    const testiTableBody = document.getElementById('testiTableBody');
    const testiLoading = document.getElementById('testiLoading');
    const noTestiFound = document.getElementById('noTestiFound');

    async function loadTestimonials() {
        testiLoading.style.display = 'block';
        testiTableBody.innerHTML = '';
        noTestiFound.classList.add('d-none');
        try {
            const snapshot = await dbRT.ref('testimonials').once('value');
            if (!snapshot.exists() || snapshot.val() === null) {
                noTestiFound.classList.remove('d-none');
            } else {
                const testimonials = [];
                snapshot.forEach(childSnapshot => {
                    testimonials.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                testimonials.reverse(); // Tampilkan yang terbaru duluan jika tidak ada order field
                testimonials.forEach(testi => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${testi.id}</td>
                        <td>${testi.nama}</td>
                        <td>${testi.rating}</td>
                        <td>${testi.isi}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editTestimoni('${testi.id}', '${testi.nama}', ${testi.rating}, \`${testi.isi}\`)"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTestimoni('${testi.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    testiTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading testimonials:", error);
            testiTableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Terjadi kesalahan saat memuat testimoni.</td></tr>`;
        } finally {
            testiLoading.style.display = 'none';
        }
    }

    async function saveTestimoni() {
        const id = document.getElementById('testiId').value;
        const nama = document.getElementById('testiNama').value;
        const rating = parseInt(document.getElementById('testiRating').value);
        const isi = document.getElementById('testiIsi').value;

        if (!nama || isNaN(rating) || rating < 1 || rating > 5 || !isi) {
            alert('Semua field testimoni harus diisi dengan benar.');
            return;
        }

        try {
            if (id) {
                await dbRT.ref(`testimonials/${id}`).update({ nama: nama, rating: rating, isi: isi });
                alert('Testimoni berhasil diperbarui!');
            } else {
                await dbRT.ref('testimonials').push({ nama: nama, rating: rating, isi: isi });
                alert('Testimoni berhasil ditambahkan!');
            }
            resetTestiForm();
            loadTestimonials();
        } catch (error) {
            console.error("Error saving testimoni:", error);
            alert('Gagal menyimpan testimoni. Silakan coba lagi.');
        }
    }

    function editTestimoni(id, nama, rating, isi) {
        document.getElementById('testiId').value = id;
        document.getElementById('testiNama').value = nama;
        document.getElementById('testiRating').value = rating;
        document.getElementById('testiIsi').value = isi;
    }

    async function deleteTestimoni(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus testimoni ini?')) return;
        try {
            await dbRT.ref(`testimonials/${id}`).remove();
            alert('Testimoni berhasil dihapus!');
            loadTestimonials();
        } catch (error) {
            console.error("Error deleting testimoni:", error);
            alert('Gagal menghapus testimoni. Silakan coba lagi.');
        }
    }

    function resetTestiForm() {
        document.getElementById('testiId').value = '';
        document.getElementById('testiNama').value = '';
        document.getElementById('testiRating').value = '';
        document.getElementById('testiIsi').value = '';
    }

    // --- FAQ Management (Realtime Database) ---
    const faqTableBody = document.getElementById('faqTableBody');
    const faqLoading = document.getElementById('faqLoading');
    const noFaqFound = document.getElementById('noFaqFound');

    async function loadFaqs() {
        faqLoading.style.display = 'block';
        faqTableBody.innerHTML = '';
        noFaqFound.classList.add('d-none');
        try {
            const snapshot = await dbRT.ref('faq').once('value');
            if (!snapshot.exists() || snapshot.val() === null) {
                noFaqFound.classList.remove('d-none');
            } else {
                const faqs = [];
                snapshot.forEach(childSnapshot => {
                    faqs.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                faqs.reverse(); // Tampilkan yang terbaru duluan
                faqs.forEach(faq => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${faq.id}</td>
                        <td>${faq.question}</td>
                        <td>${faq.answer}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editFaq('${faq.id}', \`${faq.question}\`, \`${faq.answer}\`)"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFaq('${faq.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    faqTableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error("Error loading FAQs:", error);
            faqTableBody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">Terjadi kesalahan saat memuat FAQ.</td></tr>`;
        } finally {
            faqLoading.style.display = 'none';
        }
    }

    async function saveFaq() {
        const id = document.getElementById('faqId').value;
        const question = document.getElementById('faqQuestion').value;
        const answer = document.getElementById('faqAnswer').value;

        if (!question || !answer) {
            alert('Pertanyaan dan Jawaban FAQ harus diisi.');
            return;
        }

        try {
            if (id) {
                await dbRT.ref(`faq/${id}`).update({ question: question, answer: answer });
                alert('FAQ berhasil diperbarui!');
            } else {
                await dbRT.ref('faq').push({ question: question, answer: answer });
                alert('FAQ berhasil ditambahkan!');
            }
            resetFaqForm();
            loadFaqs();
        } catch (error) {
            console.error("Error saving FAQ:", error);
            alert('Gagal menyimpan FAQ. Silakan coba lagi.');
        }
    }

    function editFaq(id, question, answer) {
        document.getElementById('faqId').value = id;
        document.getElementById('faqQuestion').value = question;
        document.getElementById('faqAnswer').value = answer;
    }

    async function deleteFaq(id) {
        if (!confirm('Apakah Anda yakin ingin menghapus FAQ ini?')) return;
        try {
            await dbRT.ref(`faq/${id}`).remove();
            alert('FAQ berhasil dihapus!');
            loadFaqs();
        } catch (error) {
            console.error("Error deleting FAQ:", error);
            alert('Gagal menghapus FAQ. Silakan coba lagi.');
        }
    }

    function resetFaqForm() {
        document.getElementById('faqId').value = '';
        document.getElementById('faqQuestion').value = '';
        document.getElementById('faqAnswer').value = '';
    }

    // --- Initial Load on Tab Change ---
    document.addEventListener('DOMContentLoaded', () => {
        loadOrders(); // Load orders by default

        var myTabEl = document.querySelector('#myTab');
        myTabEl.addEventListener('shown.bs.tab', event => {
            const activeTabId = event.target.id;
            if (activeTabId === 'pesanan-tab') {
                loadOrders();
            } else if (activeTabId === 'produk-tab') {
                loadProduk();
            } else if (activeTabId === 'reseller-tab') {
                loadReseller();
            } else if (activeTabId === 'topup-tab') {
                loadTopups();
            } else if (activeTabId === 'pembayaran-tab') {
                loadPaymentInfo();
            } else if (activeTabId === 'banner-tab') {
                loadBanners();
            } else if (activeTabId === 'testimoni-tab') {
                loadTestimonials();
            } else if (activeTabId === 'faq-tab') {
                loadFaqs();
            }
        });
    });
</script>

</body>
    </html>
