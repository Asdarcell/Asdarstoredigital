<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd;
      --success-color: #198754;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --border-color: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .container { max-width: 1200px; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .card-header { background-color: #fff; border-bottom: 1px solid var(--border-color); }
    .nav-tabs .nav-link { font-weight: 500; }
    .nav-tabs .nav-link.active { color: var(--primary-color); background-color: #fff; border-color: var(--border-color) var(--border-color) #fff; }
    
    .order-card { background: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s ease; }
    .order-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .order-card p { margin: 0.25rem 0; font-size: 0.9rem; }
    .order-card p strong { min-width: 110px; display: inline-block; color: #555; }
    .order-card .badge { font-size: 0.8rem; padding: 0.4em 0.7em; }
    .discount-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }

    .product-category h4 { padding: 10px; background-color: var(--light-gray); border-radius: 8px; margin-top: 20px; }
    .product-list .list-group-item { cursor: grab; background-color: #fff; }
    .product-list .list-group-item:active { cursor: grabbing; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .toast.show { display: block; }
    
    .modal-backdrop.show { opacity: 0.5; }

    #global-refresh-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; z-index: 1050; display: flex; justify-content: center; align-items: center; }
    
    #pesananList, #product-container { max-height: 65vh; overflow-y: auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; }
    #pesananList .order-card { margin-left: -5px; margin-right: -5px; }
    #pesananList .order-card:last-child { margin-bottom: 0; }

    /* === Style untuk Stok & Promo === */
    .stok-kontrol { display: flex; align-items: center; gap: 8px; }
    .stok-kontrol .btn { padding: 0.1rem 0.5rem; font-size: 0.9rem; }
    .promo-banner-card { border-left: 5px solid var(--warning-color); }
  </style>
</head>
<body>

<button id="global-refresh-btn" class="btn btn-primary shadow-lg" title="Refresh Halaman"><i class="fas fa-sync-alt"></i></button>

<div class="toast-container"></div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p id="confirmModalBody"></p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" id="confirmModalCancel">Batal</button><button type="button" class="btn btn-primary" id="confirmModalOk">Ya, Lanjutkan</button></div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="text-center mb-4"><h1 class="display-5 fw-bold">Dashboard Admin</h1><p class="text-muted">Asdar Store Digital</p></div>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button"><i class="fas fa-receipt me-2"></i>Pesanan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button"><i class="fas fa-box-open me-2"></i>Produk & Promo</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="moderasi-tab" data-bs-toggle="tab" data-bs-target="#moderasi-pane" type="button"><i class="fas fa-comment-check me-2"></i>Moderasi Testimoni</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button"><i class="fas fa-file-code me-2"></i>Konten Dinamis</button></li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Manajemen Pesanan</h3>
            <div class="row mb-3 g-2 align-items-center">
                <div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">Filter Semua Status</option><option value="Belum Bayar">Belum Bayar</option><option value="Sudah Bayar">Sudah Bayar</option><option value="Diproses">Diproses</option><option value="Selesai">Selesai</option></select></div>
                <div class="col-md-5"><input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama/Nomor..." /></div>
                <div class="col-md-2"><button class="btn btn-outline-success w-100" id="exportCSVBtn"><i class="fas fa-file-csv me-2"></i>Export</button></div>
                <div class="col-md-2"><button class="btn btn-outline-primary w-100" onclick="renderPesanan()"><i class="fas fa-sync-alt me-2"></i>Refresh</button></div>
            </div>
            <div id="pesananList" class="mb-4"><p class="text-center text-muted p-4">Memuat pesanan...</p></div><hr>
            <div class="row"><div class="col-md-6"><h4>Kirim Bukti Admin</h4><div class="input-group mb-2"><input type="file" id="buktiAdmin" class="form-control" accept="image/*" /><button id="uploadBuktiBtn" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Kirim & Selesaikan</button></div><small id="selectedOrderIdDisplay" class="text-info mb-3 d-block">Pilih pesanan dari daftar untuk mengirim bukti.</small></div><div class="col-md-6 text-end align-self-end"><button class="btn btn-danger" id="deleteAllOrdersBtn"><i class="fas fa-trash-alt me-2"></i>Hapus Semua Pesanan</button></div></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="products-pane" role="tabpanel">
      <div class="row">
        <div class="col-lg-7">
          <div class="card mt-3">
            <div class="card-body">
              <h3 class="mb-3">Tambah / Edit Produk</h3>
              <form id="formProduk" class="row g-3 mb-4 p-3 border rounded-3 bg-light">
                  <div class="col-md-6"><label class="form-label">Kategori</label><input type="text" id="kategori" class="form-control" required /></div>
                  <div class="col-md-6"><label class="form-label">Varian</label><input type="text" id="varian" class="form-control" required /></div>
                  <div class="col-md-6"><label class="form-label">Harga</label><input type="number" id="harga" class="form-control" required /></div>
                  <div class="col-md-6"><label class="form-label">Stok</label><input type="number" id="stok" class="form-control" placeholder="0" required /></div>
                  <div class="col-12"><label class="form-label">Keterangan</label><textarea id="cara" class="form-control" rows="2" required></textarea></div>
                  <div class="col-12"><button type="submit" id="simpanProdukBtn" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Simpan Produk</button></div>
              </form>
              <h4>Daftar Produk (<small class="text-muted">Drag & drop untuk urutkan</small>)</h4>
              <div id="product-container"><p class="text-center p-4">Memuat produk...</p></div>
            </div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card mt-3">
            <div class="card-body">
                <h3 class="mb-3">Banner Promo</h3>
                <form id="formPromo" class="mb-4 p-3 border rounded-3 bg-light">
                    <div class="mb-3"><label for="nama-promo" class="form-label">Judul Promo</label><input type="text" class="form-control" id="nama-promo" required></div>
                    <div class="mb-3"><label for="produk-promo" class="form-label">Pilih Produk</label><select id="produk-promo" class="form-select" required><option value="">Pilih produk...</option></select></div>
                    <div class="mb-3"><label for="akhir-promo" class="form-label">Waktu Berakhir</label><input type="datetime-local" id="akhir-promo" class="form-control" required></div>
                    <button type="submit" class="btn btn-warning w-100"><i class="fas fa-bolt me-2"></i>Buat Banner Promo</button>
                </form>
                <h4>Promo Aktif</h4>
                <div id="daftar-banner-promo" style="max-height: 40vh; overflow-y: auto;">
                    <p class="text-center p-4">Belum ada promo aktif.</p>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="moderasi-pane" role="tabpanel">
      <div class="card mt-3"><div class="card-header d-flex justify-content-between align-items-center"><h3 class="mb-0 fs-5">Peninjauan Testimoni</h3><button class="btn btn-sm btn-outline-primary" onclick="loadDynamicContentForAdminPage()"><i class="fas fa-sync-alt me-1"></i> Refresh</button></div><div class="card-body"><div id="dynamic-content-area-admin"></div></div></div>
    </div>
    
    <div class="tab-pane fade" id="content-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body"><h3 class="mb-3">Editor Konten Dinamis</h3><div class="mb-3"><label for="halamanDinamis" class="form-label">Pilih Halaman untuk Diedit:</label><select id="halamanDinamis" class="form-select w-auto"><option value="index">index.html</option><option value="admin">admin.html</option><option value="status">status.html</option><option value="uplod">uplod.html</option></select></div><div class="mb-3"><label for="editorHTML" class="form-label">HTML</label><textarea id="editorHTML" rows="8" class="form-control font-monospace" placeholder=""></textarea></div><div class="mb-3"><label for="editorCSS" class="form-label">CSS</label><textarea id="editorCSS" rows="6" class="form-control font-monospace" placeholder="/* Kode CSS Anda di sini */"></textarea></div><div class="mb-3"><label for="editorJS" class="form-label">JavaScript</label><textarea id="editorJS" rows="8" class="form-control font-monospace" placeholder="// Kode JavaScript Anda di sini"></textarea></div><button id="simpanDinamisBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Konten Dinamis</button><hr class="my-4"><h3 class="mb-3">Konten yang Tersimpan</h3><div id="saved-dynamic-content-list"><p class="text-muted">Memuat daftar...</p></div></div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    // === Firebase & Config ===
    const firebaseConfig = { apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com", databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com", projectId: "asdarstoredigitalll-d89c4", storageBucket: "asdarstoredigitalll.appspot.com", messagingSenderId: "220670500351", appId: "1:220670500351:web:5737ae5958a6f5a67d5bca" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
    const BASE_URL = window.location.origin + window.location.pathname.replace('admin.html', '');

    // === Global State ===
    let selectedId = null;
    let allDataPesanan = {};
    let confirmModal;
    let activeTimers = {}; // untuk menyimpan interval promo

    // === UI Elements ===
    const globalRefreshBtn = document.getElementById('global-refresh-btn');
    const filterStatus = document.getElementById('filterStatus');
    const searchId = document.getElementById('searchId');
    const pesananList = document.getElementById('pesananList');
    const uploadBuktiBtn = document.getElementById('uploadBuktiBtn');
    const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');
    const formProduk = document.getElementById('formProduk');
    const deleteAllOrdersBtn = document.getElementById('deleteAllOrdersBtn');
    const formPromo = document.getElementById('formPromo');

    // === Modern UI Functions ===
    function showToast(message, type = 'info') { const toastId = 'toast-' + Date.now(); const toastColor = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary' }[type]; const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white ${toastColor} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`; document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML); const toastEl = document.getElementById(toastId); const toast = new bootstrap.Toast(toastEl, { delay: 3000 }); toast.show(); toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove()); }
    function showConfirm(title, body) { document.getElementById('confirmModalTitle').textContent = title; document.getElementById('confirmModalBody').textContent = body; confirmModal.show(); return new Promise(resolve => { const okBtn = document.getElementById('confirmModalOk'); const cancelBtn = document.getElementById('confirmModalCancel'); const onOk = () => { resolve(true); confirmModal.hide(); cleanup(); }; const onCancel = () => { resolve(false); confirmModal.hide(); cleanup(); }; function cleanup() { okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); } okBtn.addEventListener('click', onOk, { once: true }); cancelBtn.addEventListener('click', onCancel, { once: true }); document.querySelector('#confirmModal .btn-close').addEventListener('click', onCancel, { once: true }); }); }

    // === Helper Functions ===
    const formatRupiah = (angka) => (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
    
    // === Order & Discount Management ===
    window.beriHakDiskon = async (nomorWA, pesananId) => { if (!nomorWA) return showToast('Error: Nomor WhatsApp tidak ditemukan!', 'error'); const confirmed = await showConfirm('Konfirmasi Diskon', `Anda yakin ingin memberi hak diskon ke nomor ${nomorWA}?`); if (!confirmed) return; try { await db.ref('hakDiskon/' + nomorWA).set(true); showToast(`Sukses! Pelanggan ${nomorWA} kini berhak mendapat diskon.`, 'success'); const discountSection = document.getElementById(`discount-section-${pesananId}`); if (discountSection) { discountSection.innerHTML = `<p class="mb-1"><strong>Status Diskon:</strong> <span class="text-success">Telah Berhak</span></p><button class="btn btn-sm btn-secondary" disabled><i class="fas fa-check-circle me-1"></i>Hak Diberikan</button>`; } } catch (error) { showToast(`Gagal memberi hak diskon: ${error.message}`, 'error'); } };
    async function renderPesanan() { const filter = filterStatus.value; const search = searchId.value.toLowerCase(); const hakDiskonSnapshot = await db.ref('hakDiskon').once('value'); const hakDiskonData = hakDiskonSnapshot.val() || {}; if (!allDataPesanan || Object.keys(allDataPesanan).length === 0) { pesananList.innerHTML = '<div class="text-center p-5"><p class="text-muted">Tidak ada pesanan.</p></div>'; return; } const sortedIds = Object.keys(allDataPesanan).sort((a, b) => new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu)); let html = ''; sortedIds.forEach(id => { const p = allDataPesanan[id]; const searchMatch = search === '' || id.toLowerCase().includes(search) || (p.nama || '').toLowerCase().includes(search) || (p.wa_aktif || '').includes(search); const statusMatch = filter === '' || p.status === filter; if (statusMatch && searchMatch) { let statusClass = 'secondary'; if (p.status === 'Selesai') statusClass = 'success'; if (p.status === 'Sudah Bayar') statusClass = 'warning'; if (p.status === 'Diproses') statusClass = 'info'; const pelangganSudahBerhak = hakDiskonData[p.wa_aktif] === true; let discountSectionHTML = ''; if (pelangganSudahBerhak) { discountSectionHTML = `<p class="mb-1"><strong>Status Diskon:</strong> <span class="text-success">Telah Berhak</span></p><button class="btn btn-sm btn-secondary" disabled><i class="fas fa-check-circle me-1"></i>Hak Diberikan</button>`; } else { discountSectionHTML = `<p class="mb-1"><strong>Status Diskon:</strong> <span class="text-muted">Belum Dapat</span></p><button class="btn btn-sm btn-success" onclick="beriHakDiskon('${p.wa_aktif}', '${id}')"><i class="fas fa-gift me-1"></i>Beri Hak Diskon</button>`; } html += `<div class="order-card" id="order-${id}"><div class="d-flex justify-content-between align-items-start"><div><p><strong>ID Pesanan:</strong> ${id}</p><p><strong>Waktu:</strong> ${new Date(p.waktu).toLocaleString('id-ID')}</p></div><span class="badge bg-${statusClass}">${p.status || '-'}</span></div><hr class="my-2"><p><strong>Nama:</strong> ${p.nama || '-'}</p><p><strong>WA Aktif:</strong> ${p.wa_aktif || '-'}</p><p><strong>ID Game/HP:</strong> ${p.nomor || '-'}</p><p><strong>Produk:</strong> ${p.produk || '-'}</p><p><strong>Harga:</strong> Rp${formatRupiah(p.harga)} ${p.diskon_digunakan ? '<span class="badge bg-info">Diskon Terpakai</span>' : ''}</p>${p.buktiBayar ? `<p><strong>Bukti Bayar:</strong> <a href="${p.buktiBayar}" target="_blank" class="text-primary">Lihat Bukti</a></p>` : ''}${p.buktiAdmin ? `<p><strong>Bukti Admin:</strong> <a href="${p.buktiAdmin}" target="_blank" class="text-success">Lihat Bukti</a></p>` : ''}<div class="discount-section" id="discount-section-${id}">${discountSectionHTML}</div><div class="mt-3 d-flex gap-2 flex-wrap border-top pt-3"><button class="btn btn-sm btn-outline-primary" onclick="setSelected('${id}')"><i class="fas fa-check me-1"></i>Pilih untuk Kirim Bukti</button><button class="btn btn-sm btn-info" onclick="verifikasi('${id}')"><i class="fas fa-cogs me-1"></i>Proses</button><button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')"><i class="fas fa-trash me-1"></i>Hapus</button></div></div>`; } }); pesananList.innerHTML = html || '<div class="text-center p-5"><p class="text-muted">Tidak ada pesanan yang cocok dengan filter Anda.</p></div>'; }
    window.setSelected = (id) => { selectedId = id; selectedOrderIdDisplay.textContent = `Pesanan Dipilih: ${id}`; showToast(`Pesanan ${id} dipilih.`, 'info'); document.getElementById(`order-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' }); };
    window.verifikasi = async (id) => { if (!await showConfirm('Konfirmasi Proses', `Yakin ubah status pesanan ${id} menjadi "Diproses"?`)) return; await db.ref(`pesanan/${id}`).update({ status: "Diproses" }); const pesanan = allDataPesanan[id]; if (pesanan.wa_aktif) window.open(`https://wa.me/${pesanan.wa_aktif}?text=${encodeURIComponent(`Hai ${pesanan.nama}, pesanan Anda (ID: *${id}*) sedang kami *PROSES*. Mohon tunggu sebentar ya.`)}`, '_blank'); showToast(`Pesanan ${id} diproses.`, 'success'); };
    window.hapusPesanan = async (id) => { if (await showConfirm('Konfirmasi Hapus', `Yakin ingin menghapus permanen pesanan ID ${id}?`)) { await db.ref(`pesanan/${id}`).remove(); showToast("Pesanan berhasil dihapus.", 'success'); } };
    async function deleteAllOrders() { if (await showConfirm('PERINGATAN KERAS!', 'Anda yakin ingin MENGHAPUS SEMUA data pesanan? Tindakan ini tidak dapat dibatalkan.')) { await db.ref('pesanan').remove(); showToast("Semua pesanan telah dihapus.", 'danger'); } };
    async function handleUploadBukti() { const file = document.getElementById('buktiAdmin').files[0]; if (!file || !selectedId) return showToast("Pilih pesanan dan file bukti terlebih dahulu!", 'error'); uploadBuktiBtn.disabled = true; uploadBuktiBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengirim...'; try { const base64Image = await toBase64(file).then(r => r.split(',')[1]); const formData = new FormData(); formData.append("key", IMGBB_API_KEY); formData.append("image", base64Image); const res = await fetch(`https://api.imgbb.com/1/upload`, { method: "POST", body: formData }); const json = await res.json(); if (!json.success) throw new Error(json.error.message); const imageUrl = json.data.url; await db.ref(`pesanan/${selectedId}`).update({ buktiAdmin: imageUrl, status: "Selesai" }); const pesanan = allDataPesanan[selectedId]; const linkStatus = `${BASE_URL}status.html?id=${selectedId}`; const pesanUser = `Hai ${pesanan.nama}, pesanan Anda (ID: *${selectedId}*) telah *SELESAI*. Terima kasih telah berbelanja! Cek detailnya di:\n${linkStatus}`; if (pesanan.wa_aktif) window.open(`https://wa.me/${pesanan.wa_aktif}?text=${encodeURIComponent(pesanUser)}`, '_blank'); showToast("Bukti berhasil dikirim dan pesanan diselesaikan!", 'success'); selectedId = null; selectedOrderIdDisplay.textContent = 'Pilih pesanan dari daftar untuk mengirim bukti.'; document.getElementById('buktiAdmin').value = ''; } catch (err) { showToast(`Gagal: ${err.message}`, 'error'); } finally { uploadBuktiBtn.disabled = false; uploadBuktiBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Kirim & Selesaikan'; } }

    // === Product, Stock & Promo Management ===
    function loadProduk() {
        db.ref('produk').on('value', snap => {
            const produkPerKategori = snap.val() || {};
            const productContainer = document.getElementById('product-container');
            const selectPromo = document.getElementById('produk-promo');
            
            productContainer.innerHTML = "";
            selectPromo.innerHTML = '<option value="">Pilih produk...</option>'; // Reset opsi promo

            for (const kategori in produkPerKategori) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'product-category mb-4';
                categoryDiv.innerHTML = `<h4 class="fs-6">${kategori}</h4>`;
                const productListUl = document.createElement('ul');
                productListUl.id = `list-group-${kategori.replace(/\s+/g, '-')}`;
                productListUl.className = 'list-group product-list';
                const varianArr = Object.entries(produkPerKategori[kategori]).map(([varian, data]) => ({ varian, ...data }));
                varianArr.sort((a,b) => (a.urutan || 0) - (b.urutan || 0));
                
                varianArr.forEach(p => {
                    const produkId = `${kategori}/${p.varian}`;
                    // Tampilan Daftar Produk
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';
                    li.dataset.id = produkId;
                    li.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-grip-vertical me-3 text-muted"></i>
                            <div>
                                <strong>${p.varian}</strong>
                                <small class="text-muted d-block">Rp${formatRupiah(p.harga)}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                            <div class="stok-kontrol">
                                <button class="btn btn-outline-secondary btn-sm" onclick="ubahStok('${kategori}','${p.varian}', -1)">-</button>
                                <span class="badge bg-secondary">Stok: ${p.stok || 0}</span>
                                <button class="btn btn-outline-secondary btn-sm" onclick="ubahStok('${kategori}','${p.varian}', 1)">+</button>
                            </div>
                            <button class="btn btn-sm btn-outline-info" onclick="editProduk('${kategori}','${p.varian}',${p.harga},'${(p.stok || 0)}','${p.cara.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="hapusProduk('${kategori}','${p.varian}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    productListUl.appendChild(li);

                    // Tambahkan ke dropdown promo
                    const option = document.createElement('option');
                    option.value = produkId;
                    option.textContent = `${kategori} - ${p.varian}`;
                    selectPromo.appendChild(option);
                });

                categoryDiv.appendChild(productListUl);
                productContainer.appendChild(categoryDiv);
                new Sortable(productListUl, { animation: 150, ghostClass: 'sortable-ghost', onEnd: function (evt) { const items = evt.to.children; let updates = {}; for(let i = 0; i < items.length; i++) { const id = items[i].dataset.id; updates[`produk/${id}/urutan`] = i; } db.ref().update(updates); } });
            }
        });
    }

    async function handleSimpanProduk(e) {
        e.preventDefault();
        const kategori = document.getElementById('kategori').value.trim();
        const varian = document.getElementById('varian').value.trim();
        // Ambil nilai stok dari form
        const data = { harga: Number(document.getElementById('harga').value), stok: Number(document.getElementById('stok').value), cara: document.getElementById('cara').value, };
        if (!kategori || !varian || !data.harga || !data.cara) return showToast("Lengkapi semua field produk!", 'error');
        
        const path = `produk/${kategori}/${varian}`;
        const existingProd = await db.ref(path).once('value');
        if (!existingProd.exists()) { data.urutan = Date.now(); }
        
        await db.ref(path).update(data);
        showToast("Produk berhasil disimpan!", 'success');
        formProduk.reset();
    }

    window.editProduk = (k, v, h, s, c) => { 
        document.getElementById('kategori').value = k; 
        document.getElementById('varian').value = v; 
        document.getElementById('harga').value = h;
        document.getElementById('stok').value = s; // Isi field stok
        document.getElementById('cara').value = c; 
        document.getElementById('kategori').focus(); 
    };
    
    window.hapusProduk = async (k,v) => { if(await showConfirm('Hapus Produk', `Yakin ingin menghapus produk ${v}?`)) { await db.ref(`produk/${k}/${v}`).remove(); showToast('Produk dihapus', 'success'); } };
    
    window.ubahStok = (kategori, varian, jumlah) => {
        const path = `produk/${kategori}/${varian}/stok`;
        db.ref(path).transaction(stokSaatIni => {
            const stokBaru = (stokSaatIni || 0) + jumlah;
            return stokBaru < 0 ? 0 : stokBaru; // Jangan biarkan stok minus
        });
    };
    
    async function handleSimpanPromo(e) {
        e.preventDefault();
        const promo = {
            judul: document.getElementById('nama-promo').value,
            produkId: document.getElementById('produk-promo').value,
            waktuBerakhir: new Date(document.getElementById('akhir-promo').value).toISOString()
        };
        if (!promo.judul || !promo.produkId || !promo.waktuBerakhir) { return showToast('Lengkapi semua field promo!', 'error'); }
        
        const newPromoRef = db.ref('bannerPromo').push();
        await newPromoRef.set(promo);
        showToast('Banner promo berhasil dibuat!', 'success');
        formPromo.reset();
    }

    function renderBannerPromo() {
        db.ref('bannerPromo').on('value', snap => {
            const container = document.getElementById('daftar-banner-promo');
            container.innerHTML = '';
            const promos = snap.val() || {};
            
            Object.values(activeTimers).forEach(clearInterval);
            activeTimers = {};

            if (Object.keys(promos).length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">Belum ada promo aktif.</p>';
                return;
            }

            Object.entries(promos).forEach(([promoId, promo]) => {
                const now = new Date();
                const endTime = new Date(promo.waktuBerakhir);
                if (endTime < now) { 
                    db.ref(`bannerPromo/${promoId}`).remove();
                    return;
                }

                const card = document.createElement('div');
                card.className = 'card promo-banner-card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title fs-6">${promo.judul}</h5>
                            <button class="btn-close" onclick="hapusPromo('${promoId}')"></button>
                        </div>
                        <p class="card-text small text-muted">Untuk: ${promo.produkId}</p>
                        <div class="text-center bg-dark text-white p-2 rounded">
                            <small>Berakhir dalam:</small>
                            <h4 id="timer-${promoId}" class="mb-0"></h4>
                        </div>
                    </div>
                `;
                container.appendChild(card);
                jalankanHitungMundur(promo.waktuBerakhir, `timer-${promoId}`, promoId);
            });
        });
    }

    function jalankanHitungMundur(waktuBerakhir, elemenId, promoId) {
        const timerElement = document.getElementById(elemenId);
        if (!timerElement) return;

        const interval = setInterval(() => {
            const selisih = new Date(waktuBerakhir).getTime() - new Date().getTime();
            if (selisih < 0) {
                clearInterval(interval);
                timerElement.innerHTML = "WAKTU HABIS";
                db.ref(`bannerPromo/${promoId}`).remove();
                return;
            }
            const d = Math.floor(selisih / (1000 * 60 * 60 * 24));
            const h = Math.floor((selisih % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((selisih % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((selisih % (1000 * 60)) / 1000);
            timerElement.innerHTML = `${d}h ${h}j ${m}m ${s}d`;
        }, 1000);
        activeTimers[promoId] = interval;
    }

    window.hapusPromo = async (promoId) => {
        if (await showConfirm('Hapus Promo', 'Yakin ingin menghapus banner promo ini?')) {
            await db.ref(`bannerPromo/${promoId}`).remove();
            clearInterval(activeTimers[promoId]);
            delete activeTimers[promoId];
            showToast('Promo berhasil dihapus', 'success');
        }
    };

    // === Dynamic Content Management ===
    const halamanSelect = document.getElementById('halamanDinamis'); const editorHTML = document.getElementById('editorHTML'); const editorCSS = document.getElementById('editorCSS'); const editorJS = document.getElementById('editorJS'); const simpanDinamisBtn = document.getElementById('simpanDinamisBtn'); const savedContentList = document.getElementById('saved-dynamic-content-list'); function loadDinamisEditor() { const halaman = halamanSelect.value; if (!halaman) return; db.ref(`dynamicContent/${halaman}`).once('value').then(s => { const k = s.val() || {html:"",css:"",js:""}; editorHTML.value = k.html; editorCSS.value = k.css; editorJS.value = k.js; }); }
    function handleSimpanDinamis() { const halaman = halamanSelect.value; if (!halaman) return showToast('Pilih halaman terlebih dahulu!', 'error'); db.ref(`dynamicContent/${halaman}`).set({ html: editorHTML.value, css: editorCSS.value, js: editorJS.value }).then(() => showToast('Konten dinamis berhasil disimpan!', 'success')); }
    function renderSavedDynamicContent() { db.ref('dynamicContent').on('value', snapshot => { const data = snapshot.val(); if (!data) { savedContentList.innerHTML = '<p class="text-muted">Belum ada konten dinamis yang tersimpan.</p>'; return; } let html = '<ul class="list-group">'; for (const pageName in data) { html += `<li class="list-group-item d-flex justify-content-between align-items-center"><code>${pageName}.html</code><button class="btn btn-sm btn-outline-danger" onclick="hapusKontenDinamis('${pageName}')"><i class="fas fa-trash-alt me-2"></i>Hapus</button></li>`; } html += '</ul>'; savedContentList.innerHTML = html; }); }
    window.hapusKontenDinamis = async (pageName) => { const confirmed = await showConfirm('Konfirmasi Hapus', `Yakin ingin menghapus konten dinamis untuk halaman ${pageName}.html?`); if (confirmed) { db.ref(`dynamicContent/${pageName}`).remove().then(() => showToast(`Konten untuk ${pageName}.html berhasil dihapus.`, 'success')).catch(err => showToast(`Error: ${err.message}`, 'error')); } };
    function loadDynamicContentForAdminPage() { const container = document.getElementById('dynamic-content-area-admin'); if (!container) return; container.innerHTML = '<p class="text-center text-muted p-4">Memuat data moderasi...</p>'; db.ref('dynamicContent/admin').once('value').then(snapshot => { const content = snapshot.val(); if (!content || !content.html) { container.innerHTML = '<p class="text-center text-muted">Belum ada konten moderasi yang ditambahkan. Silakan tambahkan melalui tab "Konten Dinamis".</p>'; return; } container.innerHTML = content.html; if (content.css) { const style = document.createElement('style'); style.id = 'dynamic-admin-styles'; if(document.getElementById(style.id)) document.getElementById(style.id).remove(); style.textContent = content.css; document.head.appendChild(style); } if (content.js) { try { const dynamicFunction = new Function('db', 'showToast', 'showConfirm', content.js); dynamicFunction(db, showToast, showConfirm); } catch (e) { console.error("Error saat menjalankan JS dinamis:", e); container.innerHTML += `<div class="alert alert-danger mt-3">Error pada skrip moderasi: ${e.message}</div>`; } } }); }

    // === App Initialization ===
    document.addEventListener('DOMContentLoaded', () => {
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        globalRefreshBtn.addEventListener('click', () => location.reload());
        filterStatus.addEventListener('change', renderPesanan);
        searchId.addEventListener('input', renderPesanan);
        deleteAllOrdersBtn.addEventListener('click', deleteAllOrders);
        uploadBuktiBtn.addEventListener('click', handleUploadBukti);
        formProduk.addEventListener('submit', handleSimpanProduk);
        simpanDinamisBtn.addEventListener('click', handleSimpanDinamis);
        halamanSelect.addEventListener('change', loadDinamisEditor);
        formPromo.addEventListener('submit', handleSimpanPromo);

        db.ref('pesanan').on('value', s => { allDataPesanan = s.val() || {}; renderPesanan(); });
        loadProduk();
        renderBannerPromo();
        loadDinamisEditor();
        renderSavedDynamicContent();
        loadDynamicContentForAdminPage();
    });
</script>
</body>
</html>
