<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545;
      --warning-color: #ffc107; --info-color: #0dcaf0; --light-gray: #f8f9fa;
      --dark-gray: #343a40; --border-color: #dee2e6; --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .container { max-width: 1200px; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .card-header { background-color: #fff; border-bottom: 1px solid var(--border-color); }
    .nav-tabs .nav-link { font-weight: 500; }
    .nav-tabs .nav-link.active { color: var(--primary-color); background-color: #fff; border-color: var(--border-color) var(--border-color) #fff; }
    #pesananList, #product-container, #voucher-list {
        max-height: 65vh; overflow-y: auto; padding: 15px;
        border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff;
    }
    .order-card, .list-group-item { margin-bottom: 15px; }
    #pesananList .order-card { margin-left: -5px; margin-right: -5px; }
    .stat-card { text-align: center; }
    .stat-card .display-4 { font-weight: 600; color: var(--primary-color); }
    #global-refresh-btn {
        position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
        border-radius: 50%; font-size: 20px; z-index: 1050;
        display: flex; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

<button id="global-refresh-btn" class="btn btn-primary shadow-lg" title="Refresh Halaman"><i class="fas fa-sync-alt"></i></button>
<div class="toast-container position-fixed top-0 end-0 p-3"></div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p id="confirmModalBody"></p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" id="confirmModalCancel">Batal</button><button type="button" class="btn btn-primary" id="confirmModalOk">Ya, Lanjutkan</button></div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold">Dashboard Admin</h1>
    <p class="text-muted">Asdar Store Digital</p>
  </div>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button"><i class="fas fa-receipt me-2"></i>Pesanan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button"><i class="fas fa-box-open me-2"></i>Produk</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="vouchers-tab" data-bs-toggle="tab" data-bs-target="#vouchers-pane" type="button"><i class="fas fa-tags me-2"></i>Manajemen Voucher</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button"><i class="fas fa-chart-line me-2"></i>Statistik</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="moderasi-tab" data-bs-toggle="tab" data-bs-target="#moderasi-pane" type="button"><i class="fas fa-comment-check me-2"></i>Moderasi</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button"><i class="fas fa-file-code me-2"></i>Konten Dinamis</button></li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Manajemen Pesanan</h3>
            <div id="pesananList" class="mb-4"><p class="text-center text-muted p-4">Memuat pesanan...</p></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="products-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3>Tambah / Edit Produk</h3>
            <form id="formProduk" class="row g-3 mb-4 p-3 border rounded-3 bg-light">
                <div class="col-md-3"><label class="form-label">Kategori</label><input type="text" id="kategori" class="form-control" required /></div>
                <div class="col-md-3"><label class="form-label">Varian</label><input type="text" id="varian" class="form-control" required /></div>
                <div class="col-md-2"><label class="form-label">Harga</label><input type="number" id="harga" class="form-control" required /></div>
                <div class="col-md-2"><label class="form-label">Stok</label><input type="number" id="stok" class="form-control" placeholder="Kosongi untuk ‚àû" /></div>
                <div class="col-md-2"><label class="form-label">&nbsp;</label><button type="submit" id="simpanProdukBtn" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Simpan</button></div>
            </form>
            <h4>Daftar Produk (<small class="text-muted">Drag & drop untuk urutkan</small>)</h4>
            <div id="product-container"></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="vouchers-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3>Manajemen Voucher Promo</h3>
            <form id="formVoucher" class="row g-3 mb-4 p-3 border rounded-3 bg-light">
                <div class="col-md-3"><label class="form-label">Kode Voucher</label><input type="text" id="voucherKode" class="form-control text-uppercase" required /></div>
                <div class="col-md-2"><label class="form-label">Tipe</label><select id="voucherTipe" class="form-select" required><option value="persen">Persen (%)</option><option value="nominal">Nominal (Rp)</option></select></div>
                <div class="col-md-2"><label class="form-label">Nilai</label><input type="number" id="voucherNilai" class="form-control" required /></div>
                <div class="col-md-5"><label class="form-label">Deskripsi</label><input type="text" id="voucherDeskripsi" class="form-control" required placeholder="Cth: Diskon Spesial Lebaran"/></div>
                <div class="col-12"><button type="submit" class="btn btn-success w-100"><i class="fas fa-plus-circle me-2"></i>Tambah Voucher</button></div>
            </form>
            <h4>Daftar Voucher Promo Aktif</h4>
            <div id="voucher-list"></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="stats-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-4">Statistik Penjualan</h3>
            <div class="row g-4">
                <div class="col-md-4"><div class="card stat-card p-3"><h5 class="text-muted">Total Pendapatan (Selesai)</h5><p class="display-4" id="stats-pendapatan">Rp 0</p></div></div>
                <div class="col-md-4"><div class="card stat-card p-3"><h5 class="text-muted">Total Pesanan (Selesai)</h5><p class="display-4" id="stats-pesanan-selesai">0</p></div></div>
                <div class="col-md-4"><div class="card stat-card p-3"><h5 class="text-muted">Total Semua Pesanan</h5><p class="display-4" id="stats-pesanan-total">0</p></div></div>
            </div>
            <hr class="my-4">
            <h4>Produk Terlaris</h4>
            <div id="stats-produk-laris"></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="moderasi-pane" role="tabpanel">...</div>
    <div class="tab-pane fade" id="content-pane" role="tabpanel">...</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    // === Firebase & Config ===
    // ... Sama seperti sebelumnya ...
    
    // === Global State ===
    let allDataPesanan = {}, allVouchers = {}, allDiskonDiterima = {};
    // ... State lain sama seperti sebelumnya ...

    // === UI Functions & Helpers ===
    // ... Sama seperti sebelumnya ...

    // === MANAJEMEN PESANAN (DIPERBARUI) ===
    function renderPesanan() {
        // ... Logika filter & search sama ...
        
        // Di dalam loop `sortedIds.forEach(id => { ... })`
        const p = allDataPesanan[id];
        
        // Cek status diskon/hadiah
        const hadiahDiberikan = p.hadiahDiberikan; // Cek jika hadiah sudah diberikan untuk order INI
        const berhakDiskon = allDiskonDiterima[p.wa_aktif] && allDiskonDiterima[p.wa_aktif].berhak;

        let diskonHtml = `
            <button class="btn btn-sm btn-success mt-1" onclick="beriVoucherHadiah('${id}')">
                üéÅ Beri Voucher Hadiah
            </button>`;
        if (hadiahDiberikan) {
            diskonHtml = `<p class="mt-1 mb-0"><small class="text-success">Voucher Hadiah Diberikan: <code>${hadiahDiberikan}</code></small></p>`;
        } else if (berhakDiskon) {
            // Ini bisa digunakan untuk penanda jika user pernah dapat hadiah di order lain
            // Untuk sekarang, kita fokus pada pemberian per-order
        }

        // Template HTML untuk kartu pesanan
        html += `
            <div class="order-card" id="order-${id}">
                <p><strong>Harga Akhir:</strong> Rp${formatRupiah(p.hargaAkhir || p.harga)}</p>
                ${p.voucherDigunakan ? `<p><strong>Voucher:</strong> <code>${p.voucherDigunakan}</code></p>`: ''}
                
                <div class="mt-2 pt-2 border-top">
                    ${diskonHtml}
                </div>
                
                <div class="mt-3 pt-3 border-top d-flex gap-2 flex-wrap">
                    </div>
            </div>`;
        // ...
    }
    
    // === MANAJEMEN PRODUK (DIPERBARUI) ===
    function loadProduk() {
        db.ref('produk').on('value', snap => {
            // ... Logika awal sama ...
            
            // Di dalam loop `varianArr.forEach(p => { ... })`
            const stok = p.stok !== undefined ? p.stok : '‚àû';
            li.innerHTML = `
                <div>
                    <span class="badge bg-info ms-2">Stok: ${stok}</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editStok('${kategori}','${p.varian}', ${p.stok || 0})"><i class="fas fa-edit"></i> Stok</button>
                    </div>`;
            // ...
        });
    }

    window.editStok = async (kategori, varian, stokLama) => {
        const stokBaru = prompt(`Masukkan jumlah stok baru untuk ${varian}:`, stokLama);
        if (stokBaru !== null && !isNaN(stokBaru) && stokBaru >= 0) {
            await db.ref(`produk/${kategori}/${varian}/stok`).set(Number(stokBaru));
            showToast('Stok berhasil diperbarui!', 'success');
        } else if (stokBaru !== null) {
            showToast('Harap masukkan angka yang valid.', 'error');
        }
    };
    
    // === MANAJEMEN VOUCHER (BARU) ===
    const formVoucher = document.getElementById('formVoucher');
    const voucherListDiv = document.getElementById('voucher-list');

    function renderVouchers() {
        if (!allVouchers) {
            voucherListDiv.innerHTML = '<p class="text-muted">Belum ada voucher promo.</p>';
            return;
        }
        let html = '<ul class="list-group">';
        for (const kode in allVouchers) {
            const v = allVouchers[kode];
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-primary">${kode}</strong>
                        <small class="d-block text-muted">${v.deskripsi}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="hapusVoucher('${kode}')"><i class="fas fa-trash"></i></button>
                </li>`;
        }
        html += '</ul>';
        voucherListDiv.innerHTML = html;
    }

    async function handleSimpanVoucher(e) {
        e.preventDefault();
        const kode = document.getElementById('voucherKode').value.trim().toUpperCase();
        const data = {
            tipe: document.getElementById('voucherTipe').value,
            nilai: Number(document.getElementById('voucherNilai').value),
            deskripsi: document.getElementById('voucherDeskripsi').value,
        };
        if (!kode || !data.tipe || !data.nilai || !data.deskripsi) return showToast('Lengkapi semua field!', 'error');
        
        await db.ref(`vouchers/${kode}`).set(data);
        showToast(`Voucher ${kode} berhasil disimpan!`, 'success');
        formVoucher.reset();
    }

    window.hapusVoucher = async (kode) => {
        if (await showConfirm('Hapus Voucher', `Yakin ingin menghapus voucher ${kode}?`)) {
            await db.ref(`vouchers/${kode}`).remove();
            showToast(`Voucher ${kode} dihapus.`, 'success');
        }
    };
    
    // === VOUCHER HADIAH (BARU) ===
    window.beriVoucherHadiah = async (orderId) => {
        const pesanan = allDataPesanan[orderId];
        if (!pesanan) return showToast('Pesanan tidak ditemukan!', 'error');

        const confirmed = await showConfirm('Beri Voucher Hadiah?', `Ini akan membuat kode voucher unik untuk ${pesanan.nama}. Lanjutkan?`);
        if (!confirmed) return;

        const kodeUnik = 'SHARE-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        const dataVoucher = {
            deskripsi: `Hadiah Share untuk pesanan ${orderId}`,
            nilai: 5000, // Contoh potongan 5rb
            tipe: 'nominal',
            status: 'unik', // Penanda ini voucher sekali pakai
            digunakan: false,
        };

        await db.ref(`vouchers/${kodeUnik}`).set(dataVoucher);
        await db.ref(`pesanan/${orderId}/hadiahDiberikan`).set(kodeUnik);
        
        prompt('Voucher Hadiah Berhasil Dibuat! Salin kode ini dan kirim ke pembeli:', kodeUnik);
    };
    
    // === STATISTIK (BARU) ===
    function generateStats() {
        if (!allDataPesanan) return;
        
        let totalPendapatan = 0;
        let pesananSelesai = 0;
        let produkLaris = {};

        Object.values(allDataPesanan).forEach(p => {
            if (p.status === 'Selesai') {
                totalPendapatan += p.hargaAkhir || p.harga;
                pesananSelesai++;
                if(p.produk) {
                    produkLaris[p.produk] = (produkLaris[p.produk] || 0) + 1;
                }
            }
        });
        
        document.getElementById('stats-pendapatan').textContent = `Rp${formatRupiah(totalPendapatan)}`;
        document.getElementById('stats-pesanan-selesai').textContent = pesananSelesai;
        document.getElementById('stats-pesanan-total').textContent = Object.keys(allDataPesanan).length;

        const sortedProduk = Object.entries(produkLaris).sort(([,a],[,b]) => b-a).slice(0, 5);
        let produkHtml = '<ul class="list-group">';
        sortedProduk.forEach(([nama, jumlah]) => {
            produkHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">${nama} <span class="badge bg-primary rounded-pill">${jumlah}x</span></li>`;
        });
        produkHtml += '</ul>';
        document.getElementById('stats-produk-laris').innerHTML = produkHtml || '<p class="text-muted">Belum ada data produk terjual.</p>';
    }

    // === App Initialization (DIPERBARUI) ===
    document.addEventListener('DOMContentLoaded', () => {
        // ... Inisialisasi modal ...
        confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        
        // Daftarkan semua event listener
        // ... Listener lama ...
        formVoucher.addEventListener('submit', handleSimpanVoucher); // Listener baru

        // Muat semua data awal saat halaman siap
        db.ref('pesanan').on('value', s => { allDataPesanan = s.val() || {}; renderPesanan(); generateStats(); });
        db.ref('vouchers').on('value', s => { allVouchers = s.val() || {}; renderVouchers(); });
        db.ref('diskon_diterima').on('value', s => { allDiskonDiterima = s.val() || {}; renderPesanan(); }); // Untuk render status diskon
        
        loadProduk();
        // ... fungsi load lainnya ...
    });
</script>
</body>
</html>
