<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        #sidebar {
            min-width: 250px;
            max-width: 250px;
            background: #343a40;
            color: #fff;
            transition: all 0.3s;
            padding-top: 20px;
        }
        #sidebar.active {
            margin-left: -250px;
        }
        #content {
            flex-grow: 1;
            padding: 20px;
        }
        .sidebar-header {
            padding-bottom: 20px;
            border-bottom: 1px solid #474b50;
            text-align: center;
        }
        .sidebar-header h3 {
            color: #fff;
            margin-bottom: 0;
        }
        .components ul li a {
            padding: 10px 20px;
            display: block;
            color: #dee2e6;
            text-decoration: none;
            transition: all 0.3s;
        }
        .components ul li a:hover {
            background: #495057;
            color: #fff;
        }
        .components ul li.active > a {
            background: #007bff;
            color: #fff;
        }
        .card {
            margin-bottom: 20px;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .status-badge {
            padding: .35em .65em;
            border-radius: .25rem;
            font-size: .75em;
            font-weight: 700;
            color: #fff;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-diproses { background-color: #007bff; }
        .status-selesai { background-color: #28a745; }
        .status-dibatalkan { background-color: #dc3545; }
        .status-gagal { background-color: #6c757d; }
    </style>
</head>
<body>
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>Admin Panel</h3>
        </div>
        <ul class="list-unstyled components">
            <li class="active" data-target="dashboard-section">
                <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li data-target="product-management-section">
                <a href="#"><i class="fas fa-box"></i> Manajemen Produk</a>
            </li>
            <li data-target="reseller-management-section">
                <a href="#"><i class="fas fa-users"></i> Manajemen Reseller</a>
            </li>
            <li data-target="order-management-section">
                <a href="#"><i class="fas fa-shopping-cart"></i> Manajemen Pesanan</a>
            </li>
            <li data-target="verification-section">
                <a href="#"><i class="fas fa-check-circle"></i> Verifikasi Reseller</a>
            </li>
            <li>
                <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </ul>
    </nav>

    <div id="content">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-info">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="nav-link" id="user-email"></span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <section id="dashboard-section" class="tab-pane active">
            <h2>Dashboard</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-header">Total Produk</div>
                        <div class="card-body">
                            <h5 class="card-title" id="total-products">0</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-header">Total Reseller</div>
                        <div class="card-body">
                            <h5 class="card-title" id="total-resellers">0</h5>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-header">Pesanan Menunggu</div>
                        <div class="card-body">
                            <h5 class="card-title" id="pending-orders">0</h5>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="product-management-section" class="tab-pane">
            <h2>Manajemen Produk</h2>
            <div class="card mb-4">
                <div class="card-header">
                    Form Produk
                </div>
                <div class="card-body">
                    <form id="product-form">
                        <div class="mb-3">
                            <label for="product-name" class="form-label">Nama Produk</label>
                            <input type="text" class="form-control" id="product-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="product-category" class="form-label">Kategori</label>
                            <input type="text" class="form-control" id="product-category" required>
                        </div>
                        <div class="mb-3">
                            <label for="product-description" class="form-label">Deskripsi</label>
                            <textarea class="form-control" id="product-description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="product-price-umum" class="form-label">Harga Umum</label>
                            <input type="number" class="form-control" id="product-price-umum" required>
                        </div>
                        <div class="mb-3">
                            <label for="product-price-reseller" class="form-label">Harga Reseller</label>
                            <input type="number" class="form-control" id="product-price-reseller" required>
                        </div>
                        <div class="mb-3">
                            <label for="product-stock" class="form-label">Stok</label>
                            <input type="number" class="form-control" id="product-stock" required>
                        </div>
                        <div class="mb-3">
                            <label for="product-image" class="form-label">Gambar Produk</label>
                            <input type="file" class="form-control" id="product-image" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary" id="save-product-btn">Tambah Produk</button>
                        <button type="button" class="btn btn-secondary" id="cancel-edit-product-btn" style="display:none;">Batal Edit</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    Daftar Produk
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="product-search" placeholder="Cari Produk...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Gambar</th>
                                    <th>Nama Produk</th>
                                    <th>Kategori</th>
                                    <th>Harga Umum</th>
                                    <th>Harga Reseller</th>
                                    <th>Stok</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="reseller-management-section" class="tab-pane">
            <h2>Manajemen Reseller</h2>
            <div class="card">
                <div class="card-header">
                    Daftar Reseller
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="reseller-search" placeholder="Cari Reseller...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Telepon</th>
                                    <th>Alamat</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="resellers-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="order-management-section" class="tab-pane">
            <h2>Manajemen Pesanan</h2>
            <div class="card">
                <div class="card-header">
                    Daftar Pesanan
                </div>
                <div class="card-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control w-50 me-2" id="order-search" placeholder="Cari Pesanan...">
                        <select class="form-select w-25" id="order-filter">
                            <option value="all">Semua Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Diproses">Diproses</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Dibatalkan">Dibatalkan</option>
                            <option value="Gagal">Gagal</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID Pesanan</th>
                                    <th>Produk</th>
                                    <th>Pelanggan</th>
                                    <th>Harga</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="verification-section" class="tab-pane">
            <h2>Verifikasi Reseller Baru</h2>
            <div class="card">
                <div class="card-header">
                    Permintaan Verifikasi
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Telepon</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="verification-requests-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Konfigurasi Firebase Anda (GANTI DENGAN KONSOL FIREBASE ANDA)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFS = firebase.firestore(); // Firestore
        const storage = firebase.storage(); // Cloud Storage

        // =================================== AUTHENTICATION ===================================
        // Cek status autentikasi admin
        auth.onAuthStateChanged(user => {
            if (user) {
                // Pengguna masuk
                document.getElementById('user-email').textContent = `Admin: ${user.email}`;
                loadDashboardData();
                loadProducts();
                loadResellers();
                loadOrders(); // Muat pesanan saat admin masuk
                loadVerificationRequests();

                // Aktifkan tab pertama secara default
                document.querySelector('.components li.active').click();

            } else {
                // Pengguna keluar, arahkan ke halaman login (misalnya)
                window.location.href = "login.html"; // Ganti dengan halaman login Anda
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                alert('Anda telah keluar.');
                window.location.href = "login.html"; // Redirect ke halaman login
            }).catch(error => {
                console.error("Error signing out: ", error);
                alert('Gagal keluar: ' + error.message);
            });
        });

        // =================================== Sidebar and Tab Switching ===================================
        const sidebarCollapse = document.getElementById('sidebarCollapse');
        const sidebar = document.getElementById('sidebar');
        const sections = document.querySelectorAll('.tab-pane');
        const sidebarLinks = document.querySelectorAll('#sidebar .components li');

        sidebarCollapse.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                // Hapus kelas 'active' dari semua link dan section
                sidebarLinks.forEach(item => item.classList.remove('active'));
                sections.forEach(sec => sec.classList.remove('active'));

                // Tambahkan kelas 'active' ke link yang diklik
                this.classList.add('active');

                // Tampilkan section yang sesuai
                const targetId = this.dataset.target;
                document.getElementById(targetId).classList.add('active');
            });
        });

        // =================================== Dashboard Data ===================================
        async function loadDashboardData() {
            try {
                // Total Produk
                const productsSnapshot = await dbFS.collection('products').get();
                document.getElementById('total-products').textContent = productsSnapshot.size;

                // Total Reseller (yang sudah disetujui)
                const resellersSnapshot = await dbFS.collection('resellers').where('status', '==', 'approved').get();
                document.getElementById('total-resellers').textContent = resellersSnapshot.size;

                // Pesanan Menunggu (contoh: status 'Pending')
                const pendingOrdersUmumSnapshot = await dbFS.collection('pesananUmum').where('status', '==', 'Pending').get();
                const pendingOrdersResellerSnapshot = await dbFS.collection('pesananReseller').where('status', '==', 'Pending').get();
                const totalPendingOrders = pendingOrdersUmumSnapshot.size + pendingOrdersResellerSnapshot.size;
                document.getElementById('pending-orders').textContent = totalPendingOrders;

            } catch (error) {
                console.error("Error loading dashboard data: ", error);
            }
        }


        // =================================== PRODUCT MANAGEMENT (Firestore) ===================================
        const productForm = document.getElementById('product-form');
        const productsTableBody = document.getElementById('products-table-body');
        const productNameInput = document.getElementById('product-name');
        const productCategoryInput = document.getElementById('product-category');
        const productDescriptionInput = document.getElementById('product-description');
        const productPriceUmumInput = document.getElementById('product-price-umum');
        const productPriceResellerInput = document.getElementById('product-price-reseller');
        const productStockInput = document.getElementById('product-stock');
        const productImageInput = document.getElementById('product-image');
        const saveProductBtn = document.getElementById('save-product-btn');
        const cancelEditProductBtn = document.getElementById('cancel-edit-product-btn');
        const productSearchInput = document.getElementById('product-search');

        let editingProductId = null;
        let allProductsData = []; // Untuk menyimpan semua data produk untuk pencarian lokal

        // Fungsi untuk memformat harga ke Rupiah
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // Muat produk
        async function loadProducts() {
            try {
                const snapshot = await dbFS.collection('products').orderBy('name').get();
                allProductsData = [];
                snapshot.forEach(doc => {
                    allProductsData.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(allProductsData);
            } catch (error) {
                console.error("Error loading products: ", error);
                productsTableBody.innerHTML = `<tr><td colspan="7" class="text-danger">Gagal memuat produk: ${error.message}</td></tr>`;
            }
        }

        // Render produk ke tabel
        function renderProducts(productsToRender) {
            productsTableBody.innerHTML = '';
            if (productsToRender.length === 0) {
                productsTableBody.innerHTML = `<tr><td colspan="7" class="text-center">Tidak ada produk ditemukan.</td></tr>`;
                return;
            }
            productsToRender.forEach(product => {
                const row = productsTableBody.insertRow();
                row.innerHTML = `
                    <td><img src="${product.imageUrl || 'https://via.placeholder.com/50'}" alt="${product.name}" width="50"></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${formatRupiah(product.priceUmum)}</td>
                    <td>${formatRupiah(product.priceReseller)}</td>
                    <td>${product.stock}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}', '${product.imageUrl || ''}')">Hapus</button>
                    </td>
                `;
            });
        }

        // Pencarian produk
        productSearchInput.addEventListener('input', () => {
            const searchTerm = productSearchInput.value.toLowerCase();
            const filteredProducts = allProductsData.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            renderProducts(filteredProducts);
        });

        // Tambah/Edit Produk
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = productNameInput.value;
            const category = productCategoryInput.value;
            const description = productDescriptionInput.value;
            const priceUmum = parseFloat(productPriceUmumInput.value);
            const priceReseller = parseFloat(productPriceResellerInput.value);
            const stock = parseInt(productStockInput.value);
            const imageFile = productImageInput.files[0];

            saveProductBtn.disabled = true;
            saveProductBtn.textContent = editingProductId ? 'Mengupdate...' : 'Menambahkan...';

            try {
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = storage.ref(`product_images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await storageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                if (editingProductId) {
                    // Update produk
                    const productRef = dbFS.collection('products').doc(editingProductId);
                    const currentProduct = await productRef.get();
                    const currentImageUrl = currentProduct.data().imageUrl;

                    const updateData = {
                        name, category, description, priceUmum, priceReseller, stock,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (imageUrl) {
                        updateData.imageUrl = imageUrl;
                        // Hapus gambar lama jika ada gambar baru
                        if (currentImageUrl) {
                            await storage.refFromURL(currentImageUrl).delete().catch(error => console.warn("Error deleting old image: ", error.message));
                        }
                    }
                    await productRef.update(updateData);
                    alert('Produk berhasil diupdate!');
                } else {
                    // Tambah produk
                    await dbFS.collection('products').add({
                        name, category, description, priceUmum, priceReseller, stock,
                        imageUrl,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Produk berhasil ditambahkan!');
                }

                productForm.reset();
                editingProductId = null;
                saveProductBtn.textContent = 'Tambah Produk';
                cancelEditProductBtn.style.display = 'none';
                productImageInput.required = false; // Gambar tidak wajib saat edit
                loadProducts(); // Muat ulang daftar produk
                loadDashboardData(); // Update dashboard
            } catch (error) {
                console.error("Error saving product: ", error);
                alert('Gagal menyimpan produk: ' + error.message);
            } finally {
                saveProductBtn.disabled = false;
            }
        });

        // Edit produk (memuat data ke form)
        async function editProduct(id) {
            try {
                const doc = await dbFS.collection('products').doc(id).get();
                if (doc.exists) {
                    const product = doc.data();
                    productNameInput.value = product.name;
                    productCategoryInput.value = product.category;
                    productDescriptionInput.value = product.description;
                    productPriceUmumInput.value = product.priceUmum;
                    productPriceResellerInput.value = product.priceReseller;
                    productStockInput.value = product.stock;
                    productImageInput.value = ''; // Kosongkan input file
                    productImageInput.required = false; // Gambar tidak wajib saat edit

                    editingProductId = id;
                    saveProductBtn.textContent = 'Update Produk';
                    cancelEditProductBtn.style.display = 'inline-block';
                    // Scroll ke atas form
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error fetching product for edit: ", error);
                alert('Gagal memuat data produk untuk edit: ' + error.message);
            }
        }

        // Batal edit
        cancelEditProductBtn.addEventListener('click', () => {
            productForm.reset();
            editingProductId = null;
            saveProductBtn.textContent = 'Tambah Produk';
            cancelEditProductBtn.style.display = 'none';
            productImageInput.required = true; // Gambar wajib lagi saat tambah baru
        });

        // Hapus produk
        async function deleteProduct(id, imageUrl) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                try {
                    await dbFS.collection('products').doc(id).delete();
                    if (imageUrl) {
                        await storage.refFromURL(imageUrl).delete().catch(error => console.warn("Error deleting product image: ", error.message));
                    }
                    alert('Produk berhasil dihapus!');
                    loadProducts();
                    loadDashboardData();
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    alert('Gagal menghapus produk: ' + error.message);
                }
            }
        }

        // =================================== RESELLER MANAGEMENT (Firestore) ===================================
        const resellersTableBody = document.getElementById('resellers-table-body');
        const resellerSearchInput = document.getElementById('reseller-search');
        let allResellersData = []; // Untuk pencarian lokal

        async function loadResellers() {
            try {
                // Hanya memuat reseller yang sudah disetujui untuk manajemen
                const snapshot = await dbFS.collection('resellers').where('status', '==', 'approved').get();
                allResellersData = [];
                snapshot.forEach(doc => {
                    allResellersData.push({ id: doc.id, ...doc.data() });
                });
                renderResellers(allResellersData);
            } catch (error) {
                console.error("Error loading resellers: ", error);
                resellersTableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Gagal memuat reseller: ${error.message}</td></tr>`;
            }
        }

        function renderResellers(resellersToRender) {
            resellersTableBody.innerHTML = '';
            if (resellersToRender.length === 0) {
                resellersTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Tidak ada reseller ditemukan.</td></tr>`;
                return;
            }
            resellersToRender.forEach(reseller => {
                const row = resellersTableBody.insertRow();
                row.innerHTML = `
                    <td>${reseller.nama || 'N/A'}</td>
                    <td>${reseller.email}</td>
                    <td>${reseller.telepon || 'N/A'}</td>
                    <td>${reseller.alamat || 'N/A'}</td>
                    <td><span class="badge bg-success">${reseller.status}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteReseller('${reseller.id}', '${reseller.email}')">Hapus</button>
                    </td>
                `;
            });
        }

        resellerSearchInput.addEventListener('input', () => {
            const searchTerm = resellerSearchInput.value.toLowerCase();
            const filteredResellers = allResellersData.filter(reseller =>
                (reseller.nama || '').toLowerCase().includes(searchTerm) ||
                reseller.email.toLowerCase().includes(searchTerm) ||
                (reseller.telepon || '').toLowerCase().includes(searchTerm)
            );
            renderResellers(filteredResellers);
        });

        async function deleteReseller(id, email) {
            if (confirm(`Apakah Anda yakin ingin menghapus reseller ${email}? Ini juga akan menghapus akun Firebase mereka.`)) {
                try {
                    // Hapus dari Firestore
                    await dbFS.collection('resellers').doc(id).delete();

                    // Hapus akun pengguna Firebase (Ini memerlukan Cloud Function atau admin SDK di server)
                    // Jika Anda tidak memiliki Cloud Function, bagian ini tidak akan berfungsi dari sisi klien.
                    // Anda mungkin perlu membangun Cloud Function untuk menghapus user dari Authentication.
                    // Untuk sementara, jika akun tidak terhapus, reseller tidak bisa login tapi datanya di firestore sudah hilang.

                    alert('Reseller berhasil dihapus!');
                    loadResellers();
                    loadDashboardData();
                } catch (error) {
                    console.error("Error deleting reseller: ", error);
                    alert('Gagal menghapus reseller: ' + error.message + '\n(Catatan: Penghapusan akun Firebase mungkin memerlukan Cloud Function)');
                }
            }
        }


        // =================================== PESANAN (Firestore) ===================================
        const ordersTableBody = document.querySelector('#orders-table-body');
        const orderFilter = document.getElementById('order-filter');
        const orderSearchInput = document.getElementById('order-search');
        let allOrdersData = []; // Menyimpan semua data pesanan untuk filtering lokal

        // Fungsi untuk menyalin ID ke clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Disalin!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Gagal menyalin: ', err);
            });
        }


        // FUNGSI LOADORDERS() DENGAN PERBAIKAN UNTUK NAMA RESELLER
        async function loadOrders() { // PASTIKAN ADA 'async' DI SINI
            try {
                const [umumSnapshot, resellerSnapshot] = await Promise.all([
                    dbFS.collection('pesananUmum').orderBy('waktu', 'desc').get(),
                    dbFS.collection('pesananReseller').orderBy('waktu', 'desc').get()
                ]);

                let combinedOrders = [];
                umumSnapshot.forEach(doc => combinedOrders.push({ id: doc.id, ...doc.data(), type: 'umum' }));

                const resellerPromises = resellerSnapshot.docs.map(async doc => {
                    const orderData = doc.data();
                    const resellerId = orderData.resellerId;

                    let namaReseller = 'N/A';
                    if (resellerId) {
                        const resellerDoc = await dbFS.collection('resellers').doc(resellerId).get();
                        if (resellerDoc.exists) {
                            namaReseller = resellerDoc.data().nama || resellerDoc.data().email || 'N/A (Nama/Email tidak ada)';
                        } else {
                            namaReseller = 'N/A (Reseller tidak ditemukan)';
                        }
                    } else {
                        namaReseller = 'N/A (ID Reseller tidak ada)';
                    }

                    return { id: doc.id, ...orderData, nama_reseller: namaReseller, type: 'reseller' };
                });

                const resellerOrdersWithNames = await Promise.all(resellerPromises);
                combinedOrders = combinedOrders.concat(resellerOrdersWithNames);

                allOrdersData = combinedOrders.sort((a, b) => {
                    const timeA = a.waktu ? (a.waktu.toDate ? a.waktu.toDate().getTime() : a.waktu.getTime()) : 0;
                    const timeB = b.waktu ? (b.waktu.toDate ? b.waktu.toDate().getTime() : b.waktu.getTime()) : 0;
                    return timeB - timeA;
                });
                renderOrders(allOrdersData);
            } catch (e) {
                console.error("Error loading orders: ", e);
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Gagal memuat pesanan: ${e.message}</td></tr>`;
            }
        }

        function renderOrders(orders) {
            ordersTableBody.innerHTML = '';
            const filterStatus = orderFilter.value;
            const searchTerm = orderSearchInput.value.toLowerCase();

            const filteredOrders = orders.filter(order => {
                const matchesStatus = filterStatus === 'all' || (order.status && order.status.toLowerCase() === filterStatus.toLowerCase());
                const matchesSearch = searchTerm === '' ||
                                      order.id.toLowerCase().includes(searchTerm) ||
                                      (order.produk && order.produk.toLowerCase().includes(searchTerm)) ||
                                      (order.nama_reseller && order.nama_reseller.toLowerCase().includes(searchTerm)) || // Cari berdasarkan nama reseller
                                      (order.nama && order.nama.toLowerCase().includes(searchTerm)) || // Cari berdasarkan nama umum
                                      (order.email && order.email.toLowerCase().includes(searchTerm)); // Cari berdasarkan email
                return matchesStatus && matchesSearch;
            });

            if (filteredOrders.length === 0) {
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center">Tidak ada pesanan ditemukan.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const isResellerOrder = order.type === 'reseller';
                const statusClass = `status-${(order.status || '').toLowerCase().replace(/ /g, '-')}`;

                // BARIS INI ADALAH PERBAIKANNYA: Ambil nama_reseller yang sudah kita sediakan, atau fallback ke email/nama umum
                const customerName = isResellerOrder ? (order.nama_reseller || order.email || 'N/A') : (order.nama || 'N/A');

                const price = isResellerOrder ? (order.harga_beli || 0) : (order.harga_final || 0);

                const row = ordersTableBody.insertRow();
                row.innerHTML = `
                    <td>
                        <code>${order.id}</code>
                        <button class="btn btn-secondary btn-sm py-0 px-1" onclick="copyToClipboard('${order.id}', this)">Salin</button>
                    </td>
                    <td>${order.produk || 'N/A'}</td>
                    <td>
                        ${isResellerOrder ? `<span class="badge bg-primary">R</span>` : `<span class="badge bg-secondary">U</span>`}
                        ${customerName}
                    </td>
                    <td>${formatRupiah(price)}</td>
                    <td><span class="status-badge ${statusClass}">${order.status || 'N/A'}</span></td>
                    <td>
                        <a href="detail-pesanan.html?id=${order.id}&type=${order.type}" class="btn btn-sm btn-primary">Kelola</a>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}', '${order.type}', this)">Hapus</button>
                    </td>
                `;
            });
        }

        orderFilter.addEventListener('change', () => renderOrders(allOrdersData));
        orderSearchInput.addEventListener('input', () => renderOrders(allOrdersData));

        async function deleteOrder(id, type, button) {
            if (confirm(`Apakah Anda yakin ingin menghapus pesanan ${id} (${type}) ini?`)) {
                try {
                    button.disabled = true;
                    await dbFS.collection(`pesanan${type === 'umum' ? 'Umum' : 'Reseller'}`).doc(id).delete();
                    alert('Pesanan berhasil dihapus!');
                    loadOrders(); // Muat ulang daftar pesanan
                    loadDashboardData(); // Update dashboard
                } catch (error) {
                    console.error("Error deleting order: ", error);
                    alert('Gagal menghapus pesanan: ' + error.message);
                } finally {
                    button.disabled = false;
                }
            }
        }

        // =================================== VERIFICATION (Firestore) ===================================
        const verificationRequestsTableBody = document.getElementById('verification-requests-table-body');
        let allVerificationRequests = []; // Untuk filtering/pencarian jika diperlukan

        async function loadVerificationRequests() {
            try {
                const snapshot = await dbFS.collection('resellers').where('status', '==', 'pending_approval').get();
                allVerificationRequests = [];
                snapshot.forEach(doc => {
                    allVerificationRequests.push({ id: doc.id, ...doc.data() });
                });
                renderVerificationRequests(allVerificationRequests);
            } catch (error) {
                console.error("Error loading verification requests: ", error);
                verificationRequestsTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Gagal memuat permintaan verifikasi: ${error.message}</td></tr>`;
            }
        }

        function renderVerificationRequests(requestsToRender) {
            verificationRequestsTableBody.innerHTML = '';
            if (requestsToRender.length === 0) {
                verificationRequestsTableBody.innerHTML = `<tr><td colspan="4" class="text-center">Tidak ada permintaan verifikasi.</td></tr>`;
                return;
            }
            requestsToRender.forEach(request => {
                const row = verificationRequestsTableBody.insertRow();
                row.innerHTML = `
                    <td>${request.nama || 'N/A'}</td>
                    <td>${request.email}</td>
                    <td>${request.telepon || 'N/A'}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="approveReseller('${request.id}')">Setujui</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectReseller('${request.id}')">Tolak</button>
                    </td>
                `;
            });
        }

        async function approveReseller(id) {
            if (confirm('Apakah Anda yakin ingin menyetujui reseller ini?')) {
                try {
                    await dbFS.collection('resellers').doc(id).update({
                        status: 'approved',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Reseller berhasil disetujui!');
                    loadVerificationRequests();
                    loadResellers(); // Muat ulang daftar reseller yang disetujui
                    loadDashboardData(); // Update dashboard
                } catch (error) {
                    console.error("Error approving reseller: ", error);
                    alert('Gagal menyetujui reseller: ' + error.message);
                }
            }
        }

        async function rejectReseller(id) {
            if (confirm('Apakah Anda yakin ingin menolak reseller ini? Akun mereka akan dihapus.')) {
                try {
                    // Hapus dari Firestore
                    await dbFS.collection('resellers').doc(id).delete();
                    // Catatan: Penghapusan akun Firebase Auth perlu Cloud Function jika dilakukan dari sisi klien.
                    alert('Reseller berhasil ditolak dan dihapus!');
                    loadVerificationRequests();
                    loadDashboardData();
                } catch (error) {
                    console.error("Error rejecting reseller: ", error);
                    alert('Gagal menolak reseller: ' + error.message + '\n(Catatan: Penghapusan akun Firebase mungkin memerlukan Cloud Function)');
                }
            }
        }

    </script>
</body>
</html>
