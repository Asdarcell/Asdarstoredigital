<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545;
      --warning-color: #ffc107; --light-gray: #f8f9fa; --border-color: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .container { max-width: 1200px; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .nav-tabs .nav-link { font-weight: 500; }
    .nav-tabs .nav-link.active { color: var(--primary-color); background-color: #fff; }
    .order-card { background: #fff; border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .order-card p { margin: 0.25rem 0; font-size: 0.9rem; }
    .order-card p strong { min-width: 110px; display: inline-block; }
    .discount-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
    .product-list .list-group-item { cursor: grab; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    #pesananList, #product-container, #testimoni-pending-container { max-height: 65vh; overflow-y: auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; }
  </style>
</head>
<body>

<div class="toast-container"></div>
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmModalTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><p id="confirmModalBody"></p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="confirmModalOk">Ya</button></div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold">Dashboard Admin</h1>
    <p class="text-muted">Asdar Store Digital</p>
  </div>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-pane" type="button"><i class="fas fa-receipt me-2"></i>Pesanan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-pane" type="button"><i class="fas fa-box-open me-2"></i>Produk</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="promo-banner-tab" data-bs-toggle="tab" data-bs-target="#promo-banner-pane" type="button"><i class="fas fa-bullhorn me-2"></i>Banner Promo</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="moderasi-tab" data-bs-toggle="tab" data-bs-target="#moderasi-pane" type="button"><i class="fas fa-comment-dots me-2"></i>Moderasi Testimoni</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button"><i class="fas fa-file-code me-2"></i>Konten Dinamis</button></li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <div class="tab-pane fade show active" id="orders-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Manajemen Pesanan</h3>
            <div class="row mb-3 g-2 align-items-center">
                <div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">Filter Semua Status</option><option value="Belum Bayar">Belum Bayar</option><option value="Sudah Bayar">Sudah Bayar</option><option value="Diproses">Diproses</option><option value="Selesai">Selesai</option></select></div>
                <div class="col-md-4"><input type="text" id="searchId" class="form-control" placeholder="Cari ID/Nama/Nomor..." /></div>
                <div class="col-md-2"><button class="btn btn-sm btn-outline-success w-100" id="exportCSVBtn"><i class="fas fa-file-csv me-1"></i>Export</button></div>
                <div class="col-md-3"><button class="btn btn-sm btn-outline-danger w-100" id="deleteAllOrdersBtn"><i class="fas fa-trash-alt me-1"></i>Hapus Semua</button></div>
            </div>
            <div id="pesananList" class="mb-4"><p class="text-center text-muted p-4">Memuat pesanan...</p></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="products-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3>Tambah / Edit Produk</h3>
            <form id="formProduk" class="row g-3 mb-4 p-3 border rounded-3 bg-light">
                <div class="col-md-4"><label class="form-label">Kategori</label><input type="text" id="kategori" class="form-control" required /></div>
                <div class="col-md-4"><label class="form-label">Varian</label><input type="text" id="varian" class="form-control" required /></div>
                <div class="col-md-2"><label class="form-label">Harga</label><input type="number" id="harga" class="form-control" required /></div>
                <div class="col-md-2"><label class="form-label">Stok</label><input type="number" id="stok" class="form-control" placeholder="Kosongi = ∞" /></div>
                <div class="col-12"><label class="form-label">Keterangan</label><textarea id="cara" class="form-control" rows="2" required></textarea></div>
                <div class="col-12"><hr class="my-2"><h5 class="mt-2">Promo Produk (Opsional)</h5></div>
                <div class="col-md-6"><label class="form-label">Jenis Promo</label><select id="promoJenis" class="form-select"><option value="">Tidak Ada Promo</option><option value="nominal">Potongan Harga (Rp)</option><option value="persen">Diskon Persen (%)</option></select></div>
                <div class="col-md-6"><label class="form-label">Nilai Promo</label><input type="number" id="promoNilai" class="form-control" placeholder="Cth: 5000 atau 10" /></div>
                <div class="col-12 mt-4"><button type="submit" class="btn btn-success w-100"><i class="fas fa-save me-2"></i>Simpan Produk</button></div>
            </form>
            <h4>Daftar Produk (<small class="text-muted">Drag & drop untuk urutkan</small>)</h4>
            <div id="product-container"></div>
        </div></div>
    </div>
    
    <div class="tab-pane fade" id="promo-banner-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Manajemen Banner Promo</h3>
            <p class="text-muted">Buat satu promo unggulan yang akan tampil sebagai banner dengan hitung mundur di halaman utama.</p>
            <div class="card bg-light p-3 mb-4">
                <h5 class="mb-3">Promo Aktif Saat Ini:</h5>
                <div id="active-promo-display"><p class="text-muted">Tidak ada promo aktif.</p></div>
            </div>
            <form id="formPromoBanner">
                <div class="mb-3"><label for="promoJudul" class="form-label">Judul Banner</label><input type="text" id="promoJudul" class="form-control" required></div>
                <div class="mb-3"><label for="promoDeskripsi" class="form-label">Deskripsi Singkat</label><input type="text" id="promoDeskripsi" class="form-control" required></div>
                <div class="mb-3"><label for="promoTanggalAkhir" class="form-label">Waktu Berakhir Promo</label><input type="datetime-local" id="promoTanggalAkhir" class="form-control" required></div>
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-save me-2"></i>Simpan & Aktifkan Banner</button>
            </form>
        </div></div>
    </div>
    
    <div class="tab-pane fade" id="moderasi-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Moderasi Testimoni</h3>
            <div id="testimoni-pending-container"><p class="text-muted">Memuat testimoni...</p></div>
        </div></div>
    </div>

    <div class="tab-pane fade" id="content-pane" role="tabpanel">
        <div class="card mt-3"><div class="card-body">
            <h3 class="mb-3">Editor Konten Dinamis</h3>
            <div class="mb-3">
                <label for="halamanDinamis" class="form-label">Pilih Halaman:</label>
                <select id="halamanDinamis" class="form-select w-auto"><option value="index">index.html</option><option value="admin">admin.html</option><option value="status">status.html</option></select>
            </div>
            <div class="mb-3"><label for="editorHTML" class="form-label">HTML</label><textarea id="editorHTML" rows="8" class="form-control font-monospace"></textarea></div>
            <div class="mb-3"><label for="editorCSS" class="form-label">CSS</label><textarea id="editorCSS" rows="6" class="form-control font-monospace"></textarea></div>
            <div class="mb-3"><label for="editorJS" class="form-label">JavaScript</label><textarea id="editorJS" rows="8" class="form-control font-monospace"></textarea></div>
            <button id="simpanDinamisBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Konten</button>
        </div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let allDataPesanan = {};
    let confirmModal;

    const formatRupiah = (angka) => (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const toastColor = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary' }[type];
        const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white ${toastColor} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
        document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML);
        new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 }).show();
    }
    
    function showConfirm(title, body) {
        return new Promise(resolve => {
            const okBtn = document.getElementById('confirmModalOk');
            const onOk = () => { cleanup(); resolve(true); };
            const onCancel = () => { cleanup(); resolve(false); };
            const cleanup = () => { okBtn.removeEventListener('click', onOk); modal.hide(); };
            const modalEl = document.getElementById('confirmModal');
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = body;
            okBtn.addEventListener('click', onOk, { once: true });
            modalEl.addEventListener('hidden.bs.modal', onCancel, { once: true });
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        });
    }

    async function renderPesanan() {
        const hakDiskonSnapshot = await db.ref('hakDiskon').once('value');
        const hakDiskonData = hakDiskonSnapshot.val() || {};
        const container = document.getElementById('pesananList');
        const sortedIds = Object.keys(allDataPesanan).sort((a, b) => new Date(allDataPesanan[b].waktu) - new Date(allDataPesanan[a].waktu));
        
        container.innerHTML = '';
        if (sortedIds.length === 0) {
            container.innerHTML = '<p class="text-center text-muted p-4">Tidak ada pesanan.</p>'; return;
        }

        sortedIds.forEach(id => {
            const p = allDataPesanan[id];
            const pelangganSudahBerhak = hakDiskonData[p.wa_aktif] === true;
            let discountSectionHTML = pelangganSudahBerhak
                ? `<p class="mb-1"><strong>Status Diskon:</strong> <span class="text-success">Telah Berhak</span></p><button class="btn btn-sm btn-secondary" disabled><i class="fas fa-check-circle me-1"></i>Hak Diberikan</button>`
                : `<p class="mb-1"><strong>Status Diskon:</strong> <span class="text-muted">Belum Dapat</span></p><button class="btn btn-sm btn-success" onclick="beriHakDiskon('${p.wa_aktif}', '${id}')"><i class="fas fa-gift me-1"></i>Beri Hak Diskon</button>`;
            let hargaInfo = `<p><strong>Total:</strong> Rp${formatRupiah(p.harga_final)}</p>`;
            if (p.promo_digunakan || p.diskon_share) {
                hargaInfo = `<p><strong>Total:</strong> Rp${formatRupiah(p.harga_final)} <span class="badge bg-success">Diskon</span></p><p><small class="text-muted">Harga Asli: Rp${formatRupiah(p.harga_asli)}</small></p>`;
            }
            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `<p><strong>ID:</strong> ${id}</p><p><strong>Nama:</strong> ${p.nama}</p><p><strong>Produk:</strong> ${p.produk}</p>${hargaInfo}<div class="discount-section" id="discount-section-${id}">${discountSectionHTML}</div>`;
            container.appendChild(card);
        });
    }

    window.beriHakDiskon = async (nomorWA, pesananId) => {
        if (!await showConfirm('Konfirmasi', `Beri hak diskon ke ${nomorWA}?`)) return;
        await db.ref('hakDiskon/' + nomorWA).set(true);
        showToast('Hak diskon diberikan!', 'success');
    };
    
    function loadProduk() {
        db.ref('produk').on('value', snap => {
            const produkPerKategori = snap.val() || {};
            const productContainer = document.getElementById('product-container');
            productContainer.innerHTML = "";
            for (const kategori in produkPerKategori) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'product-category mb-4';
                categoryDiv.innerHTML = `<h4>${kategori}</h4>`;
                const productListUl = document.createElement('ul');
                productListUl.id = `list-group-${kategori.replace(/\s+/g, '-')}`;
                productListUl.className = 'list-group product-list';
                const varianArr = Object.entries(produkPerKategori[kategori]).map(([varian, data]) => ({ varian, ...data }));
                varianArr.sort((a,b) => (a.urutan || 0) - (b.urutan || 0));
                
                varianArr.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.dataset.id = `${kategori}/${p.varian}`;
                    const promoBadge = (p.promo && p.promo.jenis) ? ' <span class="badge bg-info">🏷️ Promo</span>' : '';
                    li.innerHTML = `<div><i class="fas fa-grip-vertical me-3 text-muted"></i><strong>${p.varian}</strong>${promoBadge}<span class="text-muted ms-2">(Rp${formatRupiah(p.harga)})</span><span class="badge bg-secondary ms-2">Stok: ${typeof p.stok === 'number' ? p.stok : '∞'}</span></div><div><button class="btn btn-sm btn-outline-info" onclick="editProduk(event, '${kategori}','${p.varian}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger ms-2" onclick="hapusProduk('${kategori}','${p.varian}')"><i class="fas fa-trash"></i></button></div>`;
                    productListUl.appendChild(li);
                });
                categoryDiv.appendChild(productListUl);
                new Sortable(productListUl, { animation: 150, ghostClass: 'sortable-ghost', onEnd: function (evt) { const items = evt.to.children; let updates = {}; for(let i = 0; i < items.length; i++) { const id = items[i].dataset.id; updates[`${id}/urutan`] = i; } db.ref('produk').update(updates); } });
            }
        });
    }
    
    async function handleSimpanProduk(e) {
        e.preventDefault();
        const kategori = document.getElementById('kategori').value.trim();
        const varian = document.getElementById('varian').value.trim();
        const data = {
            harga: Number(document.getElementById('harga').value),
            cara: document.getElementById('cara').value,
            stok: document.getElementById('stok').value !== '' ? Number(document.getElementById('stok').value) : null
        };
        const promoJenis = document.getElementById('promoJenis').value;
        const promoNilai = Number(document.getElementById('promoNilai').value);
        data.promo = (promoJenis && promoNilai > 0) ? { jenis: promoJenis, nilai: promoNilai } : null;
        if (!kategori || !varian || !data.harga) return showToast("Lengkapi Kategori, Varian, dan Harga!", 'error');
        const existingProd = await db.ref(`produk/${kategori}/${varian}`).once('value');
        if (!existingProd.exists()) data.urutan = Date.now();
        await db.ref(`produk/${kategori}/${varian}`).update(data);
        showToast("Produk berhasil disimpan!", 'success');
        document.getElementById('formProduk').reset();
    }
    
    window.editProduk = async (event, k, v) => {
        event.stopPropagation();
        const snap = await db.ref(`produk/${k}/${v}`).once('value');
        const data = snap.val();
        if (!data) return;
        document.getElementById('kategori').value = k;
        document.getElementById('varian').value = v;
        document.getElementById('harga').value = data.harga;
        document.getElementById('cara').value = data.cara || '';
        document.getElementById('stok').value = typeof data.stok === 'number' ? data.stok : '';
        if (data.promo) {
            document.getElementById('promoJenis').value = data.promo.jenis || '';
            document.getElementById('promoNilai').value = data.promo.nilai || '';
        } else {
            document.getElementById('promoJenis').value = '';
            document.getElementById('promoNilai').value = '';
        }
        document.getElementById('kategori').focus();
    };

    window.hapusProduk = async (k,v) => { if(await showConfirm('Hapus Produk', `Yakin ingin menghapus produk ${v}?`)) { await db.ref(`produk/${k}/${v}`).remove(); showToast('Produk dihapus', 'success'); } };

    function handleSimpanPromoBanner(e) {
        e.preventDefault();
        const judul = document.getElementById('promoJudul').value;
        const deskripsi = document.getElementById('promoDeskripsi').value;
        const tanggalAkhir = document.getElementById('promoTanggalAkhir').value;
        if (!judul || !deskripsi || !tanggalAkhir) return showToast('Harap lengkapi semua field!', 'error');
        db.ref('featuredPromo').set({ judul, deskripsi, tanggalAkhir })
            .then(() => { showToast('Banner promo berhasil diaktifkan!', 'success'); })
            .catch(err => showToast(`Error: ${err.message}`, 'error'));
    }

    function loadActivePromo() {
        const display = document.getElementById('active-promo-display');
        db.ref('featuredPromo').on('value', snap => {
            const promo = snap.val();
            if (promo) {
                const endDate = new Date(promo.tanggalAkhir);
                display.innerHTML = `<h5>${promo.judul}</h5><p>${promo.deskripsi}</p><p class="text-muted">Berakhir: ${endDate.toLocaleString('id-ID')}</p><button class="btn btn-sm btn-danger mt-2" onclick="hapusPromoBanner()">Hapus Promo</button>`;
            } else {
                display.innerHTML = '<p class="text-muted">Tidak ada promo aktif.</p>';
            }
        });
    }

    window.hapusPromoBanner = async () => {
        if (await showConfirm('Hapus Promo', 'Yakin ingin menghentikan banner promo ini?')) {
            await db.ref('featuredPromo').remove();
            showToast('Banner promo telah dihapus.', 'success');
        }
    }
    
    function loadTestimoniPending() {
        const container = document.getElementById('testimoni-pending-container');
        db.ref('testimoni_pending').on('value', snap => {
            container.innerHTML = '';
            const data = snap.val();
            if (!data) { container.innerHTML = '<p class="text-muted p-3">Tidak ada testimoni yang perlu direview.</p>'; return; }
            for(const key in data) {
                const testi = data[key];
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `<div class="card-body"><p class="card-text">"${testi.pesan}"</p><footer class="blockquote-footer">${testi.nama}</footer><button class="btn btn-sm btn-success" onclick="setujuiTesti('${key}')">Setujui</button> <button class="btn btn-sm btn-danger ms-2" onclick="tolakTesti('${key}')">Tolak</button></div>`;
                container.appendChild(card);
            }
        });
    }
    
    window.setujuiTesti = async (key) => {
        const snap = await db.ref(`testimoni_pending/${key}`).once('value');
        const data = snap.val();
        if(data) {
            await db.ref('testimoni').push(data);
            await db.ref(`testimoni_pending/${key}`).remove();
            showToast('Testimoni disetujui.', 'success');
        }
    };
    window.tolakTesti = async (key) => {
        if(await showConfirm('Tolak Testimoni', 'Yakin ingin menolak dan menghapus testimoni ini?')){
            await db.ref(`testimoni_pending/${key}`).remove();
            showToast('Testimoni ditolak.', 'info');
        }
    };
    
    function handleSimpanDinamis() {
        const halaman = document.getElementById('halamanDinamis').value;
        if (!halaman) return showToast('Pilih halaman!', 'error');
        const data = {
            html: document.getElementById('editorHTML').value,
            css: document.getElementById('editorCSS').value,
            js: document.getElementById('editorJS').value,
        };
        db.ref('dynamicContent/' + halaman).set(data).then(() => showToast('Konten dinamis disimpan!', 'success'));
    }

    function loadDinamisEditor() {
        const halaman = document.getElementById('halamanDinamis').value;
        if (!halaman) return;
        db.ref(`dynamicContent/${halaman}`).once('value').then(s => {
            const k = s.val() || {html:"", css:"", js:""};
            document.getElementById('editorHTML').value = k.html;
            document.getElementById('editorCSS').value = k.css;
            document.getElementById('editorJS').value = k.js;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        confirmModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('confirmModal'));
        db.ref('pesanan').on('value', s => { allDataPesanan = s.val() || {}; renderPesanan(); });
        document.getElementById('formProduk').addEventListener('submit', handleSimpanProduk);
        loadProduk();
        document.getElementById('formPromoBanner').addEventListener('submit', handleSimpanPromoBanner);
        loadActivePromo();
        loadTestimoniPending();
        document.getElementById('simpanDinamisBtn').addEventListener('click', handleSimpanDinamis);
        document.getElementById('halamanDinamis').addEventListener('change', loadDinamisEditor);
        loadDinamisEditor();
    });
</script>
</body>
</html>
