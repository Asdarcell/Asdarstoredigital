<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Asdar Store Digital</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #1a1a2e;
            --text: #e0e0e0;
            --primary: #1abc9c; /* Hijau tosca */
            --secondary: #3498db; /* Biru */
            --card: #2c2c40;
            --border: #444;
            --shadow: rgba(0, 0, 0, 0.15);
            --success: #28a745;
            --danger: #e74c3c;
            --warning: #ffc107;
            --info: #17a2b8;
            --muted-text: #8a93a2;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.6;
        }

        header {
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 5px var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--primary);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 65px); /* Header height approx 65px */
        }

        .sidebar {
            width: 250px;
            background: var(--card);
            padding: 20px;
            border-right: 1px solid var(--border);
            box-shadow: 2px 0 5px var(--shadow);
            flex-shrink: 0;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text);
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background-color: var(--primary);
            color: white;
        }

        .sidebar nav ul li a .fas {
            margin-right: 10px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
        }

        .section-container {
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow);
            margin-bottom: 20px;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            font-weight: 600;
            margin-top: 15px;
            display: block;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--bg);
            color: var(--text);
        }

        button {
            width: auto; /* Changed from 100% to auto */
            padding: 10px 20px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        button.btn-danger { background-color: var(--danger); }
        button.btn-success { background-color: var(--success); }
        button.btn-warning { background-color: var(--warning); color: #212529; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .form-group { margin-bottom: 15px; }

        .notification {
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }
        .notification.success { background-color: #d4edda; color: #155724; }
        .notification.error { background-color: #f8d7da; color: #721c24; }
        .notification.info { background-color: #d1ecf1; color: #0c5460; }
        .notification.warning { background-color: #fff3cd; color: #664d03; }

        .table-responsive { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid var(--border);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            color: var(--text);
        }
        th {
            background-color: var(--primary);
            color: white;
        }
        tr:nth-child(even) {
            background-color: var(--bg);
        }

        .badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.7em;
            margin-left: 8px;
            display: inline-block;
            min-width: 22px; /* Ensure round shape */
            text-align: center;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                box-shadow: 0 2px 5px var(--shadow);
            }
            .sidebar nav ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            .sidebar nav ul li {
                margin-bottom: 0;
            }
            .sidebar nav ul li a {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            .content {
                padding: 15px;
            }
            header h1 {
                font-size: 20px;
            }
            .logout-btn {
                padding: 6px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Admin Dashboard</h1>
        <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#produk" class="nav-link active" data-target="produk"><i class="fas fa-box"></i> Produk</a></li>
                    <li><a href="#reseller-aktif" class="nav-link" data-target="reseller-aktif"><i class="fas fa-users"></i> Reseller Aktif</a></li>
                    <li><a href="#verifikasi" class="nav-link" data-target="verifikasi"><i class="fas fa-user-check"></i> Verifikasi <span id="verifikasi-badge" class="badge" style="display:none;"></span></a></li>
                    <li><a href="#top-up" class="nav-link" data-target="top-up"><i class="fas fa-wallet"></i> Top Up <span id="topup-badge" class="badge" style="display:none;"></span></a></li>
                    <li><a href="#pesanan" class="nav-link" data-target="pesanan"><i class="fas fa-receipt"></i> Pesanan <span id="pesanan-badge" class="badge" style="display:none;"></span></a></li>
                    <li><a href="#testimoni" class="nav-link" data-target="testimoni"><i class="fas fa-comment"></i> Testimoni <span id="testimoni-badge" class="badge" style="display:none;"></span></a></li>
                    <li><a href="#faq" class="nav-link" data-target="faq"><i class="fas fa-question-circle"></i> FAQ</a></li>
                    <li><a href="#pembayaran" class="nav-link" data-target="pembayaran"><i class="fas fa-credit-card"></i> Pembayaran</a></li>
                    <li><a href="#manajemen-promo" class="nav-link" data-target="manajemen-promo"><i class="fas fa-tags"></i> Manajemen Promo</a></li>
                    <li><a href="#manajemen-banner" class="nav-link" data-target="manajemen-banner"><i class="fas fa-bullhorn"></i> Manajemen Banner</a></li> <li><a href="#kode-kustom" class="nav-link" data-target="kode-kustom"><i class="fas fa-code"></i> Kode Kustom</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content">
            <section id="produk" class="admin-section">
                <h2>Manajemen Produk</h2>
                <div class="section-container">
                    <form id="product-form">
                        <div id="product-notification" class="notification"></div>
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-name">Nama Produk:</label>
                            <input type="text" id="product-name" required>
                        </div>
                        <div class="form-group">
                            <label for="product-category">Kategori:</label>
                            <input type="text" id="product-category" required>
                        </div>
                        <div class="form-group">
                            <label for="product-desc">Deskripsi:</label>
                            <textarea id="product-desc" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="product-price-reseller">Harga Reseller:</label>
                            <input type="number" id="product-price-reseller" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-price-umum">Harga Umum:</label>
                            <input type="number" id="product-price-umum" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Stok:</label>
                            <input type="number" id="product-stock" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-order">Urutan Tampil (Opsional):</label>
                            <input type="number" id="product-order" min="0" placeholder="Semakin kecil angka, semakin atas">
                        </div>
                        <div class="form-group">
                            <label>Promo Produk (Opsional):</label>
                            <select id="promo-type">
                                <option value="">Tidak Ada Promo</option>
                                <option value="nominal">Diskon Nominal (Rp)</option>
                                <option value="percentage">Diskon Persentase (%)</option>
                            </select>
                        </div>
                        <div class="form-group" id="promo-value-group" style="display:none;">
                            <label for="promo-value">Nilai Promo:</label>
                            <input type="number" id="promo-value" min="0">
                        </div>
                        <button type="submit" id="add-product-btn">Tambah Produk</button>
                        <button type="button" id="cancel-edit-product-btn" style="display:none;" class="btn-warning">Batal Edit</button>
                    </form>
                </div>
                <div class="section-container">
                    <h3>Daftar Produk</h3>
                    <div class="table-responsive">
                        <table id="product-list">
                            <thead>
                                <tr>
                                    <th>Nama Produk</th>
                                    <th>Kategori</th>
                                    <th>Harga Reseller</th>
                                    <th>Harga Umum</th>
                                    <th>Stok</th>
                                    <th>Promo</th>
                                    <th>Urutan</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reseller-aktif" class="admin-section" style="display:none;">
                <h2>Reseller Aktif</h2>
                <div class="section-container">
                    <h3>Daftar Reseller</h3>
                    <div class="table-responsive">
                        <table id="active-resellers-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Saldo</th>
                                    <th>Hak Diskon</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="verifikasi" class="admin-section" style="display:none;">
                <h2>Verifikasi Reseller</h2>
                <div class="section-container">
                    <h3>Permintaan Verifikasi Pending</h3>
                    <div id="pending-verifications-list">
                        <p>Tidak ada permintaan verifikasi pending.</p>
                    </div>
                </div>
            </section>

            <section id="top-up" class="admin-section" style="display:none;">
                <h2>Konfirmasi Top Up</h2>
                <div class="section-container">
                    <h3>Permintaan Top Up Pending</h3>
                    <div id="pending-topups-list">
                        <p>Tidak ada permintaan top up pending.</p>
                    </div>
                </div>
            </section>

            <section id="pesanan" class="admin-section" style="display:none;">
                <h2>Manajemen Pesanan</h2>
                <div class="section-container">
                    <h3>Daftar Pesanan Terakhir</h3>
                    <div class="table-responsive">
                        <table id="orders-list">
                            <thead>
                                <tr>
                                    <th>ID Pesanan</th>
                                    <th>Reseller Email</th>
                                    <th>Pelanggan</th>
                                    <th>Produk</th>
                                    <th>Harga Beli</th>
                                    <th>Promo/Diskon</th>
                                    <th>Waktu</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="testimoni" class="admin-section" style="display:none;">
                <h2>Manajemen Testimoni</h2>
                <div class="section-container">
                    <h3>Daftar Testimoni Pending</h3>
                    <div id="pending-testimonials-list">
                        <p>Tidak ada testimoni pending.</p>
                    </div>
                </div>
                <div class="section-container">
                    <h3>Daftar Testimoni Disetujui</h3>
                    <div id="approved-testimonials-list">
                        <p>Tidak ada testimoni disetujui.</p>
                    </div>
                </div>
            </section>

            <section id="faq" class="admin-section" style="display:none;">
                <h2>Manajemen FAQ</h2>
                <div class="section-container">
                    <form id="faq-form">
                        <div id="faq-notification" class="notification"></div>
                        <input type="hidden" id="faq-id">
                        <div class="form-group">
                            <label for="faq-question">Pertanyaan:</label>
                            <input type="text" id="faq-question" required>
                        </div>
                        <div class="form-group">
                            <label for="faq-answer">Jawaban:</label>
                            <textarea id="faq-answer" rows="3" required></textarea>
                        </div>
                        <button type="submit" id="add-faq-btn">Tambah FAQ</button>
                        <button type="button" id="cancel-edit-faq-btn" style="display:none;" class="btn-warning">Batal Edit</button>
                    </form>
                </div>
                <div class="section-container">
                    <h3>Daftar FAQ</h3>
                    <div id="faq-list">
                        <p>Tidak ada FAQ.</p>
                    </div>
                </div>
            </section>

            <section id="pembayaran" class="admin-section" style="display:none;">
                <h2>Manajemen Metode Pembayaran</h2>
                <div class="section-container">
                    <form id="payment-method-form">
                        <div id="payment-notification" class="notification"></div>
                        <input type="hidden" id="payment-id">
                        <div class="form-group">
                            <label for="payment-method-name">Metode Pembayaran (Cth: Bank BCA, Dana):</label>
                            <input type="text" id="payment-method-name" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-method-number">Nomor Rekening/Telepon:</label>
                            <input type="text" id="payment-method-number" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-method-an">Atas Nama:</label>
                            <input type="text" id="payment-method-an" required>
                        </div>
                        <button type="submit" id="add-payment-btn">Tambah Metode</button>
                        <button type="button" id="cancel-edit-payment-btn" style="display:none;" class="btn-warning">Batal Edit</button>
                    </form>
                </div>
                <div class="section-container">
                    <h3>Daftar Metode Pembayaran</h3>
                    <div id="payment-methods-list">
                        <p>Tidak ada metode pembayaran.</p>
                    </div>
                </div>
            </section>
            
            <section id="manajemen-promo" class="admin-section" style="display:none;">
                <h2>Manajemen Promo Produk Umum</h2>
                <div class="section-container">
                    <p class="notification info">Fitur promo produk sekarang diatur langsung di bagian "Manajemen Produk" untuk setiap produk individual.</p>
                    <p class="notification info">Untuk memberikan diskon Rp 5.000 (diskon promosi) kepada reseller atau pembeli biasa, silakan gunakan menu "Kode Kustom".</p>
                </div>
            </section>

            <section id="manajemen-banner" class="admin-section" style="display:none;">
                <h2>Manajemen Banner Promosi</h2>
                <div class="section-container">
                    <h3>Tambah/Edit Banner</h3>
                    <form id="banner-form">
                        <div id="banner-notification" class="notification"></div>
                        <input type="hidden" id="banner-id">
                        <div class="form-group">
                            <label for="banner-title">Judul Banner:</label>
                            <input type="text" id="banner-title" required>
                        </div>
                        <div class="form-group">
                            <label for="banner-description">Deskripsi Banner:</label>
                            <textarea id="banner-description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="banner-button-text">Teks Tombol:</label>
                            <input type="text" id="banner-button-text" placeholder="Cth: Bagikan Cerita" required>
                        </div>
                        <div class="form-group">
                            <label for="banner-type">Tipe Banner:</label>
                            <select id="banner-type" required>
                                <option value="status_page_promo">Halaman Status Pesanan</option>
                                <option value="homepage_promo">Halaman Utama (Umum)</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="banner-target-emails">Email Target (Pisahkan dengan koma jika lebih dari satu. Biarkan kosong untuk semua.):</label>
                            <input type="text" id="banner-target-emails" placeholder="Cth: user1@example.com, user2@example.com">
                        </div>
                        <button type="submit" id="add-banner-btn">Tambah Banner</button>
                        <button type="button" id="cancel-edit-banner-btn" style="display:none;" class="btn-warning">Batal Edit</button>
                    </form>
                </div>
                <div class="section-container">
                    <h3>Daftar Banner</h3>
                    <div class="table-responsive">
                        <table id="banner-list-table">
                            <thead>
                                <tr>
                                    <th>Judul</th>
                                    <th>Tipe</th>
                                    <th>Target Email</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <section id="kode-kustom" class="admin-section" style="display:none;">
                <h2>Kode Kustom & Diskon Promosi</h2>
                <div class="section-container">
                    <h3>Berikan Diskon Promosi (Rp 5.000)</h3>
                    <p>Masukkan email pelanggan yang telah mempromosikan toko. Sistem akan otomatis memberikan hak diskon pada pesanan mereka selanjutnya.</p>
                    <form id="discount-reseller-form">
                        <h4>Untuk Reseller</h4>
                        <div id="discount-reseller-notification" class="notification"></div>
                        <div class="form-group">
                            <label for="reseller-email-discount">Email Reseller</label>
                            <input type="email" id="reseller-email-discount" placeholder="contoh@reseller.com" required>
                        </div>
                        <button type="submit" id="give-reseller-discount-btn">Beri Diskon ke Reseller</button>
                    </form>
                    <hr>
                    <form id="discount-buyer-form">
                        <h4>Untuk Pembeli Biasa</h4>
                        <div id="discount-buyer-notification" class="notification"></div>
                        <div class="form-group">
                            <label for="buyer-email-discount">Nomor WhatsApp Pembeli Biasa</label>
                            <input type="text" id="buyer-wa-discount" placeholder="628123xxxxxx" required>
                        </div>
                        <button type="submit" id="give-buyer-discount-btn">Beri Diskon ke Pembeli</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Firebase Konfigurasi (GANTI DENGAN KONFIGURASI PROYEK ANDA)
        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // GANTI INI
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
        };
        firebase.initializeApp(firebaseConfig);
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();
        const auth = firebase.auth();

        let currentProduct = null; // For product editing
        let currentFAQ = null; // For FAQ editing
        let currentPayment = null; // For Payment Method editing
        let currentBanner = null; // For Banner editing

        const showNotification = (elementId, message, type = 'error', displayTime = 3000) => {
            const notificationEl = document.getElementById(elementId);
            notificationEl.textContent = message;
            notificationEl.className = `notification ${type}`;
            notificationEl.style.display = 'block';
            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, displayTime);
        };

        const setButtonLoading = (button, isLoading, originalText) => {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memuat...';
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        };

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // Check if user is admin (optional, but recommended)
                // You might have a 'admins' collection in Firestore
                dbFS.collection('admins').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        console.log("Admin logged in:", user.email);
                        // Load all data and setup listeners after successful login
                        loadAllDataAndSetupListeners();
                    } else {
                        alert("Akses ditolak. Anda bukan admin.");
                        auth.signOut();
                    }
                }).catch(error => {
                    console.error("Error checking admin role:", error);
                    alert("Terjadi kesalahan saat memeriksa peran admin.");
                    auth.signOut();
                });
            } else {
                window.location.href = 'login.html'; // Redirect to admin login page
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Error signing out:", error);
                alert("Gagal logout.");
            });
        });

        // --- NAVIGATION & SECTION DISPLAY ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.style.display = 'none';
                });
                document.querySelectorAll('.nav-link').forEach(nav => {
                    nav.classList.remove('active');
                });

                const targetId = link.dataset.target;
                document.getElementById(targetId).style.display = 'block';
                link.classList.add('active');
            });
        });

        // --- NOTIFICATIONS (BADGES) ---
        function setupAdminNotifications() {
            // Verifikasi Reseller (pending)
            dbFS.collection('resellers').where('status', '==', 'pending').onSnapshot(snapshot => {
                const count = snapshot.size;
                const badge = document.getElementById('verifikasi-badge');
                if (badge) {
                    badge.textContent = count > 0 ? count : '';
                    badge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, err => console.error("Error getting pending verifications:", err));

            // Konfirmasi Top Up (pending)
            dbFS.collection('konfirmasiTopup').where('status', '==', 'pending').onSnapshot(snapshot => {
                const count = snapshot.size;
                const badge = document.getElementById('topup-badge');
                if (badge) {
                    badge.textContent = count > 0 ? count : '';
                    badge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, err => console.error("Error getting pending top-ups:", err));

            // Pesanan (pending/baru - sesuaikan status Anda)
            // Contoh: hitung semua pesanan yang statusnya 'Pending' atau 'Baru'
            dbFS.collection('pesananReseller').where('status', '==', 'Pending').onSnapshot(snapshot => { // Atau status lain yang menandakan perlu diproses
                const count = snapshot.size;
                const badge = document.getElementById('pesanan-badge');
                if (badge) {
                    badge.textContent = count > 0 ? count : '';
                    badge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, err => console.error("Error getting new orders:", err));

            // Testimoni (pending) - dari Realtime Database
            dbRT.ref('testimonials').orderByChild('status').equalTo('pending').on('value', snapshot => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                const badge = document.getElementById('testimoni-badge');
                if (badge) {
                    badge.textContent = count > 0 ? count : '';
                    badge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }, err => console.error("Error getting pending testimonials:", err));
        }

        // --- GENERAL LOAD FUNCTION ---
        function loadAllDataAndSetupListeners() {
            setupAdminNotifications(); // Panggil fungsi notifikasi
            loadProducts();
            loadActiveResellers();
            loadPendingVerifications();
            loadPendingTopups();
            loadOrders();
            loadTestimonials();
            loadFAQs();
            loadPaymentMethods();
            loadBanners(); // Load banners for admin panel
        }

        // --- PRODUK MANAGEMENT ---
        const productForm = document.getElementById('product-form');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCategoryInput = document.getElementById('product-category');
        const productDescInput = document.getElementById('product-desc');
        const productPriceResellerInput = document.getElementById('product-price-reseller');
        const productPriceUmumInput = document.getElementById('product-price-umum');
        const productStockInput = document.getElementById('product-stock');
        const productOrderInput = document.getElementById('product-order');
        const promoTypeSelect = document.getElementById('promo-type');
        const promoValueGroup = document.getElementById('promo-value-group');
        const promoValueInput = document.getElementById('promo-value');
        const addProductBtn = document.getElementById('add-product-btn');
        const cancelEditProductBtn = document.getElementById('cancel-edit-product-btn');
        const productListTableBody = document.querySelector('#product-list tbody');

        promoTypeSelect.addEventListener('change', () => {
            if (promoTypeSelect.value) {
                promoValueGroup.style.display = 'block';
                promoValueInput.required = true;
            } else {
                promoValueGroup.style.display = 'none';
                promoValueInput.required = false;
                promoValueInput.value = '';
            }
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(addProductBtn, true, addProductBtn.textContent);

            const productId = productIdInput.value;
            const productData = {
                nama_produk: productNameInput.value,
                kategori: productCategoryInput.value,
                deskripsi: productDescInput.value,
                harga_reseller: parseInt(productPriceResellerInput.value),
                harga_umum: parseInt(productPriceUmumInput.value),
                stok: parseInt(productStockInput.value),
                urutan: productOrderInput.value ? parseInt(productOrderInput.value) : 999 // Default tinggi jika kosong
            };

            if (promoTypeSelect.value) {
                productData.promo = {
                    jenis: promoTypeSelect.value,
                    nilai: parseInt(promoValueInput.value)
                };
            } else {
                productData.promo = null;
            }

            try {
                if (productId) {
                    await dbFS.collection('produk').doc(productId).update(productData);
                    showNotification('product-notification', 'Produk berhasil diupdate!', 'success');
                    addProductBtn.textContent = 'Tambah Produk';
                    cancelEditProductBtn.style.display = 'none';
                } else {
                    await dbFS.collection('produk').add(productData);
                    showNotification('product-notification', 'Produk berhasil ditambahkan!', 'success');
                }
                productForm.reset();
                promoValueGroup.style.display = 'none'; // Hide promo value field
                promoValueInput.required = false;
            } catch (error) {
                console.error("Error saving product:", error);
                showNotification('product-notification', `Gagal menyimpan produk: ${error.message}`, 'error');
            } finally {
                setButtonLoading(addProductBtn, false, addProductBtn.textContent);
                loadProducts();
            }
        });

        cancelEditProductBtn.addEventListener('click', () => {
            productForm.reset();
            productIdInput.value = '';
            currentProduct = null;
            addProductBtn.textContent = 'Tambah Produk';
            cancelEditProductBtn.style.display = 'none';
            promoTypeSelect.value = '';
            promoValueGroup.style.display = 'none';
            promoValueInput.required = false;
        });

        async function loadProducts() {
            productListTableBody.innerHTML = '<tr><td colspan="8">Memuat produk...</td></tr>';
            try {
                const snapshot = await dbFS.collection('produk').orderBy('urutan').get();
                productListTableBody.innerHTML = '';
                if (snapshot.empty) {
                    productListTableBody.innerHTML = '<tr><td colspan="8">Tidak ada produk.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = productListTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.nama_produk}</td>
                        <td>${data.kategori}</td>
                        <td>${data.harga_reseller.toLocaleString('id-ID')}</td>
                        <td>${data.harga_umum.toLocaleString('id-ID')}</td>
                        <td>${data.stok}</td>
                        <td>${data.promo ? `${data.promo.nilai} ${data.promo.jenis === 'nominal' ? 'Rp' : '%'}` : 'Tidak Ada'}</td>
                        <td>${data.urutan || '-'}</td>
                        <td>
                            <button class="btn-warning btn-sm" onclick="editProduct('${doc.id}')">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteProduct('${doc.id}')">Hapus</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error loading products:", error);
                productListTableBody.innerHTML = `<tr><td colspan="8" class="text-danger">Gagal memuat produk: ${error.message}</td></tr>`;
            }
        }

        async function editProduct(id) {
            try {
                const doc = await dbFS.collection('produk').doc(id).get();
                if (doc.exists) {
                    currentProduct = { id: doc.id, ...doc.data() };
                    productIdInput.value = currentProduct.id;
                    productNameInput.value = currentProduct.nama_produk;
                    productCategoryInput.value = currentProduct.kategori;
                    productDescInput.value = currentProduct.deskripsi;
                    productPriceResellerInput.value = currentProduct.harga_reseller;
                    productPriceUmumInput.value = currentProduct.harga_umum;
                    productStockInput.value = currentProduct.stok;
                    productOrderInput.value = currentProduct.urutan || '';

                    if (currentProduct.promo) {
                        promoTypeSelect.value = currentProduct.promo.jenis;
                        promoValueInput.value = currentProduct.promo.nilai;
                        promoValueGroup.style.display = 'block';
                        promoValueInput.required = true;
                    } else {
                        promoTypeSelect.value = '';
                        promoValueInput.value = '';
                        promoValueGroup.style.display = 'none';
                        promoValueInput.required = false;
                    }

                    addProductBtn.textContent = 'Update Produk';
                    cancelEditProductBtn.style.display = 'inline-block';
                    document.getElementById('produk').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing product:", error);
                showNotification('product-notification', `Gagal memuat data produk untuk diedit: ${error.message}`, 'error');
            }
        }

        async function deleteProduct(id) {
            if (confirm("Apakah Anda yakin ingin menghapus produk ini?")) {
                try {
                    await dbFS.collection('produk').doc(id).delete();
                    showNotification('product-notification', 'Produk berhasil dihapus!', 'success');
                    loadProducts();
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showNotification('product-notification', `Gagal menghapus produk: ${error.message}`, 'error');
                }
            }
        }

        // --- RESELLER MANAGEMENT ---
        const activeResellersTableBody = document.querySelector('#active-resellers-table tbody');
        async function loadActiveResellers() {
            activeResellersTableBody.innerHTML = '<tr><td colspan="4">Memuat reseller aktif...</td></tr>';
            try {
                const snapshot = await dbFS.collection('resellers').get();
                activeResellersTableBody.innerHTML = '';
                if (snapshot.empty) {
                    activeResellersTableBody.innerHTML = '<tr><td colspan="4">Tidak ada reseller aktif.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = activeResellersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.email}</td>
                        <td>Rp${(data.saldo || 0).toLocaleString('id-ID')}</td>
                        <td>${data.punyaHakDiskon ? 'Ya' : 'Tidak'}</td>
                        <td>
                            <button class="btn-success btn-sm" onclick="showTopupModal('${doc.id}', '${data.email}')">Tambah Saldo</button>
                            <button class="btn-danger btn-sm" onclick="deleteReseller('${doc.id}')">Hapus</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error loading active resellers:", error);
                activeResellersTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Gagal memuat reseller: ${error.message}</td></tr>`;
            }
        }

        async function deleteReseller(uid) {
            if (confirm("Apakah Anda yakin ingin menghapus reseller ini? Semua data terkait juga akan dihapus (akun, saldo, pesanan)? Ini tidak bisa dibatalkan!")) {
                try {
                    // Hapus dari Firestore 'resellers'
                    await dbFS.collection('resellers').doc(uid).delete();
                    
                    // Anda mungkin juga perlu menghapus akun AUTH Firebase-nya (ini perlu fungsi Cloud Functions)
                    // Jika tidak ada Cloud Functions, akun Auth akan tetap ada, hanya data di Firestore yang hilang.
                    // Untuk menghapus akun Auth dari sisi klien, Anda butuh kredensial admin atau Cloud Function.
                    // Karena ini admin panel, disarankan melalui Cloud Function untuk keamanan.

                    showNotification('reseller-aktif-notification', 'Reseller berhasil dihapus!', 'success'); // Tambahkan div notifikasi ini di HTML jika belum ada
                    loadActiveResellers();
                    loadPendingVerifications(); // Mungkin ada verifikasi pending untuk reseller yang dihapus
                } catch (error) {
                    console.error("Error deleting reseller:", error);
                    showNotification('reseller-aktif-notification', `Gagal menghapus reseller: ${error.message}`, 'error');
                }
            }
        }

        // --- Tambah Saldo (MODAL/FORM) - Anda perlu membuat modal/form ini di HTML admin.html
        // Contoh sederhana untuk demo
        function showTopupModal(uid, email) {
            const nominal = prompt(`Masukkan nominal saldo untuk ${email}:`);
            if (nominal && !isNaN(nominal) && parseInt(nominal) > 0) {
                const amount = parseInt(nominal);
                addSaldoToReseller(uid, amount);
            } else if (nominal !== null) {
                alert("Nominal tidak valid.");
            }
        }

        async function addSaldoToReseller(uid, amount) {
            try {
                const resellerRef = dbFS.collection('resellers').doc(uid);
                await dbFS.runTransaction(async (transaction) => {
                    const doc = await transaction.get(resellerRef);
                    if (!doc.exists) {
                        throw "Reseller tidak ditemukan!";
                    }
                    const newSaldo = (doc.data().saldo || 0) + amount;
                    transaction.update(resellerRef, { saldo: newSaldo });
                });
                alert(`Saldo berhasil ditambahkan ${amount.toLocaleString('id-ID')} ke reseller!`);
                loadActiveResellers(); // Refresh list
            } catch (error) {
                console.error("Error adding saldo:", error);
                alert(`Gagal menambahkan saldo: ${error.message}`);
            }
        }

        // --- VERIFIKASI RESELLER ---
        const pendingVerificationsList = document.getElementById('pending-verifications-list');
        async function loadPendingVerifications() {
            pendingVerificationsList.innerHTML = '<p>Memuat permintaan verifikasi...</p>';
            try {
                const snapshot = await dbFS.collection('resellers').where('status', '==', 'pending').get();
                if (snapshot.empty) {
                    pendingVerificationsList.innerHTML = '<p>Tidak ada permintaan verifikasi pending.</p>';
                    return;
                }
                pendingVerificationsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    item.innerHTML = `
                        <p><b>Email:</b> ${data.email}</p>
                        <p><b>Nama Lengkap:</b> ${data.namaLengkap || '-'}</p>
                        <p><b>No. HP:</b> ${data.noHp || '-'}</p>
                        <p><b>Waktu Daftar:</b> ${data.createdAt ? data.createdAt.toDate().toLocaleString() : 'N/A'}</p>
                        <button class="btn-success btn-sm" onclick="approveReseller('${doc.id}')">Setujui</button>
                        <button class="btn-danger btn-sm" onclick="rejectReseller('${doc.id}')">Tolak</button>
                    `;
                    pendingVerificationsList.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading pending verifications:", error);
                pendingVerificationsList.innerHTML = `<p class="text-danger">Gagal memuat permintaan: ${error.message}</p>`;
            }
        }

        async function approveReseller(uid) {
            if (confirm("Apakah Anda yakin ingin menyetujui reseller ini?")) {
                try {
                    await dbFS.collection('resellers').doc(uid).update({ status: 'approved' });
                    showNotification('verifikasi-notification', 'Reseller berhasil disetujui!', 'success'); // Tambahkan div notifikasi di HTML jika belum ada
                    loadPendingVerifications();
                    loadActiveResellers();
                } catch (error) {
                    console.error("Error approving reseller:", error);
                    showNotification('verifikasi-notification', `Gagal menyetujui: ${error.message}`, 'error');
                }
            }
        }

        async function rejectReseller(uid) {
            if (confirm("Apakah Anda yakin ingin menolak reseller ini?")) {
                try {
                    await dbFS.collection('resellers').doc(uid).update({ status: 'rejected' }); // Atau Anda bisa menghapus docnya
                    showNotification('verifikasi-notification', 'Reseller berhasil ditolak!', 'success');
                    loadPendingVerifications();
                } catch (error) {
                    console.error("Error rejecting reseller:", error);
                    showNotification('verifikasi-notification', `Gagal menolak: ${error.message}`, 'error');
                }
            }
        }

        // --- KONFIRMASI TOP UP ---
        const pendingTopupsList = document.getElementById('pending-topups-list');
        async function loadPendingTopups() {
            pendingTopupsList.innerHTML = '<p>Memuat konfirmasi top up...</p>';
            try {
                const snapshot = await dbFS.collection('konfirmasiTopup').where('status', '==', 'pending').orderBy('created_at', 'desc').get();
                if (snapshot.empty) {
                    pendingTopupsList.innerHTML = '<p>Tidak ada permintaan top up pending.</p>';
                    return;
                }
                pendingTopupsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    const createdAt = data.created_at ? data.created_at.toDate().toLocaleString() : 'N/A';
                    item.innerHTML = `
                        <p><b>ID Konfirmasi:</b> ${data.id}</p>
                        <p><b>Reseller:</b> ${data.reseller_email}</p>
                        <p><b>Nominal:</b> Rp${data.nominal.toLocaleString('id-ID')}</p>
                        <p><b>Metode:</b> ${data.metode_pembayaran}</p>
                        <p><b>Pengirim:</b> ${data.nama_pengirim}</p>
                        <p><b>Bukti:</b> <a href="${data.bukti_url}" target="_blank">Lihat Gambar</a></p>
                        <p><b>Waktu:</b> ${createdAt}</p>
                        <button class="btn-success btn-sm" onclick="approveTopup('${doc.id}', '${data.reseller_uid}', ${data.nominal})">Setujui & Tambah Saldo</button>
                        <button class="btn-danger btn-sm" onclick="rejectTopup('${doc.id}')">Tolak</button>
                    `;
                    pendingTopupsList.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading pending top-ups:", error);
                pendingTopupsList.innerHTML = `<p class="text-danger">Gagal memuat konfirmasi: ${error.message}</p>`;
            }
        }

        async function approveTopup(topupId, resellerUid, amount) {
            if (confirm("Apakah Anda yakin ingin menyetujui top up ini dan menambahkan saldo?")) {
                try {
                    await dbFS.runTransaction(async (transaction) => {
                        const topupRef = dbFS.collection('konfirmasiTopup').doc(topupId);
                        const resellerRef = dbFS.collection('resellers').doc(resellerUid);

                        const topupDoc = await transaction.get(topupRef);
                        if (!topupDoc.exists || topupDoc.data().status !== 'pending') {
                            throw new Error("Konfirmasi top up tidak ditemukan atau sudah diproses.");
                        }

                        const resellerDoc = await transaction.get(resellerRef);
                        if (!resellerDoc.exists) {
                            throw new Error("Reseller tidak ditemukan.");
                        }

                        const newSaldo = (resellerDoc.data().saldo || 0) + amount;
                        transaction.update(resellerRef, { saldo: newSaldo });
                        transaction.update(topupRef, { status: 'approved' });
                    });
                    showNotification('topup-notification', `Top Up berhasil disetujui & saldo ditambahkan ke reseller!`, 'success'); // Add notification div
                    loadPendingTopups();
                    loadActiveResellers(); // Update saldo display
                } catch (error) {
                    console.error("Error approving topup:", error);
                    showNotification('topup-notification', `Gagal menyetujui top up: ${error.message}`, 'error');
                }
            }
        }

        async function rejectTopup(topupId) {
            if (confirm("Apakah Anda yakin ingin menolak konfirmasi top up ini?")) {
                try {
                    await dbFS.collection('konfirmasiTopup').doc(topupId).update({ status: 'rejected' });
                    showNotification('topup-notification', 'Konfirmasi Top Up berhasil ditolak.', 'success');
                    loadPendingTopups();
                } catch (error) {
                    console.error("Error rejecting topup:", error);
                    showNotification('topup-notification', `Gagal menolak top up: ${error.message}`, 'error');
                }
            }
        }

        // --- MANAJEMEN PESANAN ---
        const ordersListTableBody = document.querySelector('#orders-list tbody');
        async function loadOrders() {
            ordersListTableBody.innerHTML = '<tr><td colspan="9">Memuat pesanan...</td></tr>';
            try {
                const snapshot = await dbFS.collection('pesananReseller').orderBy('waktu', 'desc').limit(50).get();
                ordersListTableBody.innerHTML = '';
                if (snapshot.empty) {
                    ordersListTableBody.innerHTML = '<tr><td colspan="9">Tidak ada pesanan.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const waktu = data.waktu ? data.waktu.toDate().toLocaleString() : 'N/A';
                    let promoInfo = '';
                    if (data.promo_digunakan) {
                        promoInfo = `Promo: ${data.promo_digunakan.nilai} ${data.promo_digunakan.jenis === 'nominal' ? 'Rp' : '%'}`;
                    } else if (data.diskon_share) {
                        promoInfo = 'Diskon Share: Rp5.000';
                    } else if (data.diskon_reseller_promo) { // BARU
                        promoInfo = 'Diskon Reseller: Rp5.000';
                    }

                    const row = ordersListTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.id}</td>
                        <td>${data.reseller_email || 'N/A'}</td>
                        <td>${data.nama_pelanggan || 'N/A'} (${data.nomor_pelanggan || 'N/A'})</td>
                        <td>${data.produk || 'N/A'}</td>
                        <td>Rp${(data.harga_beli || 0).toLocaleString('id-ID')}</td>
                        <td>${promoInfo || '-'}</td>
                        <td>${waktu}</td>
                        <td>${data.status || 'N/A'}</td>
                        <td>
                            <select onchange="updateOrderStatus('${doc.id}', this.value)">
                                <option value="Selesai" ${data.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                <option value="Diproses" ${data.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                <option value="Pending" ${data.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Dibatalkan" ${data.status === 'Dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                            </select>
                            <button class="btn-danger btn-sm mt-1" onclick="deleteOrder('${doc.id}')">Hapus</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error loading orders:", error);
                ordersListTableBody.innerHTML = `<tr><td colspan="9" class="text-danger">Gagal memuat pesanan: ${error.message}</td></tr>`;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await dbFS.collection('pesananReseller').doc(orderId).update({ status: newStatus });
                showNotification('orders-notification', 'Status pesanan berhasil diupdate!', 'success'); // Tambahkan div notifikasi
                loadOrders(); // Reload orders to reflect changes
            } catch (error) {
                console.error("Error updating order status:", error);
                showNotification('orders-notification', `Gagal mengupdate status: ${error.message}`, 'error');
            }
        }

        async function deleteOrder(orderId) {
            if (confirm("Apakah Anda yakin ingin menghapus pesanan ini?")) {
                try {
                    await dbFS.collection('pesananReseller').doc(orderId).delete();
                    showNotification('orders-notification', 'Pesanan berhasil dihapus!', 'success');
                    loadOrders();
                } catch (error) {
                    console.error("Error deleting order:", error);
                    showNotification('orders-notification', `Gagal menghapus pesanan: ${error.message}`, 'error');
                }
            }
        }

        // --- TESTIMONI MANAGEMENT --- (Realtime Database)
        const pendingTestimonialsList = document.getElementById('pending-testimonials-list');
        const approvedTestimonialsList = document.getElementById('approved-testimonials-list');

        function loadTestimonials() {
            // Pending testimonials
            pendingTestimonialsList.innerHTML = '<p>Memuat testimoni pending...</p>';
            dbRT.ref('testimonials').orderByChild('status').equalTo('pending').on('value', snapshot => {
                if (!snapshot.exists()) {
                    pendingTestimonialsList.innerHTML = '<p>Tidak ada testimoni pending.</p>';
                    return;
                }
                pendingTestimonialsList.innerHTML = '';
                snapshot.forEach(childSnap => {
                    const key = childSnap.key;
                    const data = childSnap.val();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    const createdAt = data.createdAt ? new Date(data.createdAt).toLocaleString() : 'N/A';
                    item.innerHTML = `
                        <p><b>Nama:</b> ${data.nama}</p>
                        <p><b>Isi:</b> ${data.isi}</p>
                        <p><b>Waktu:</b> ${createdAt}</p>
                        <button class="btn-success btn-sm" onclick="approveTestimonial('${key}')">Setujui</button>
                        <button class="btn-danger btn-sm" onclick="deleteTestimonial('${key}')">Hapus</button>
                    `;
                    pendingTestimonialsList.appendChild(item);
                });
            }, err => console.error("Error loading pending testimonials:", err));

            // Approved testimonials
            approvedTestimonialsList.innerHTML = '<p>Memuat testimoni disetujui...</p>';
            dbRT.ref('testimonials').orderByChild('status').equalTo('disetujui').on('value', snapshot => {
                if (!snapshot.exists()) {
                    approvedTestimonialsList.innerHTML = '<p>Tidak ada testimoni disetujui.</p>';
                    return;
                }
                approvedTestimonialsList.innerHTML = '';
                snapshot.forEach(childSnap => {
                    const key = childSnap.key;
                    const data = childSnap.val();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    const createdAt = data.createdAt ? new Date(data.createdAt).toLocaleString() : 'N/A';
                    item.innerHTML = `
                        <p><b>Nama:</b> ${data.nama}</p>
                        <p><b>Isi:</b> ${data.isi}</p>
                        <p><b>Waktu:</b> ${createdAt}</p>
                        <button class="btn-warning btn-sm" onclick="setPendingTestimonial('${key}')">Set Pending</button>
                        <button class="btn-danger btn-sm" onclick="deleteTestimonial('${key}')">Hapus</button>
                    `;
                    approvedTestimonialsList.appendChild(item);
                });
            }, err => console.error("Error loading approved testimonials:", err));
        }

        async function approveTestimonial(key) {
            if (confirm("Apakah Anda yakin ingin menyetujui testimoni ini?")) {
                try {
                    await dbRT.ref('testimonials').child(key).update({ status: 'disetujui' });
                    showNotification('testimoni-notification', 'Testimoni berhasil disetujui!', 'success');
                } catch (error) {
                    console.error("Error approving testimonial:", error);
                    showNotification('testimoni-notification', `Gagal menyetujui testimoni: ${error.message}`, 'error');
                }
            }
        }

        async function setPendingTestimonial(key) {
            if (confirm("Apakah Anda yakin ingin mengubah status testimoni ini menjadi pending?")) {
                try {
                    await dbRT.ref('testimonials').child(key).update({ status: 'pending' });
                    showNotification('testimoni-notification', 'Testimoni berhasil diubah menjadi pending!', 'success');
                } catch (error) {
                    console.error("Error setting testimonial to pending:", error);
                    showNotification('testimoni-notification', `Gagal mengubah status testimoni: ${error.message}`, 'error');
                }
            }
        }

        async function deleteTestimonial(key) {
            if (confirm("Apakah Anda yakin ingin menghapus testimoni ini?")) {
                try {
                    await dbRT.ref('testimonials').child(key).remove();
                    showNotification('testimoni-notification', 'Testimoni berhasil dihapus!', 'success');
                } catch (error) {
                    console.error("Error deleting testimonial:", error);
                    showNotification('testimoni-notification', `Gagal menghapus testimoni: ${error.message}`, 'error');
                }
            }
        }

        // --- FAQ MANAGEMENT --- (Realtime Database)
        const faqForm = document.getElementById('faq-form');
        const faqIdInput = document.getElementById('faq-id');
        const faqQuestionInput = document.getElementById('faq-question');
        const faqAnswerInput = document.getElementById('faq-answer');
        const addFaqBtn = document.getElementById('add-faq-btn');
        const cancelEditFaqBtn = document.getElementById('cancel-edit-faq-btn');
        const faqListDiv = document.getElementById('faq-list');

        faqForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(addFaqBtn, true, addFaqBtn.textContent);

            const faqData = {
                q: faqQuestionInput.value,
                a: faqAnswerInput.value
            };

            try {
                if (faqIdInput.value) {
                    await dbRT.ref('faq').child(faqIdInput.value).set(faqData);
                    showNotification('faq-notification', 'FAQ berhasil diupdate!', 'success');
                    addFaqBtn.textContent = 'Tambah FAQ';
                    cancelEditFaqBtn.style.display = 'none';
                } else {
                    await dbRT.ref('faq').push(faqData);
                    showNotification('faq-notification', 'FAQ berhasil ditambahkan!', 'success');
                }
                faqForm.reset();
                faqIdInput.value = '';
                currentFAQ = null;
            } catch (error) {
                console.error("Error saving FAQ:", error);
                showNotification('faq-notification', `Gagal menyimpan FAQ: ${error.message}`, 'error');
            } finally {
                setButtonLoading(addFaqBtn, false, addFaqBtn.textContent);
            }
        });

        cancelEditFaqBtn.addEventListener('click', () => {
            faqForm.reset();
            faqIdInput.value = '';
            currentFAQ = null;
            addFaqBtn.textContent = 'Tambah FAQ';
            cancelEditFaqBtn.style.display = 'none';
        });

        function loadFAQs() {
            faqListDiv.innerHTML = '<p>Memuat FAQ...</p>';
            dbRT.ref('faq').on('value', snapshot => {
                if (!snapshot.exists()) {
                    faqListDiv.innerHTML = '<p>Tidak ada FAQ.</p>';
                    return;
                }
                faqListDiv.innerHTML = '';
                snapshot.forEach(childSnap => {
                    const key = childSnap.key;
                    const data = childSnap.val();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    item.innerHTML = `
                        <p><b>Q:</b> ${data.q}</p>
                        <p><b>A:</b> ${data.a}</p>
                        <button class="btn-warning btn-sm" onclick="editFAQ('${key}')">Edit</button>
                        <button class="btn-danger btn-sm" onclick="deleteFAQ('${key}')">Hapus</button>
                    `;
                    faqListDiv.appendChild(item);
                });
            }, err => console.error("Error loading FAQs:", err));
        }

        async function editFAQ(key) {
            try {
                const snapshot = await dbRT.ref('faq').child(key).once('value');
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    faqIdInput.value = key;
                    faqQuestionInput.value = data.q;
                    faqAnswerInput.value = data.a;
                    addFaqBtn.textContent = 'Update FAQ';
                    cancelEditFaqBtn.style.display = 'inline-block';
                    document.getElementById('faq').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing FAQ:", error);
                showNotification('faq-notification', `Gagal memuat data FAQ untuk diedit: ${error.message}`, 'error');
            }
        }

        async function deleteFAQ(key) {
            if (confirm("Apakah Anda yakin ingin menghapus FAQ ini?")) {
                try {
                    await dbRT.ref('faq').child(key).remove();
                    showNotification('faq-notification', 'FAQ berhasil dihapus!', 'success');
                } catch (error) {
                    console.error("Error deleting FAQ:", error);
                    showNotification('faq-notification', `Gagal menghapus FAQ: ${error.message}`, 'error');
                }
            }
        }

        // --- PAYMENT METHODS MANAGEMENT ---
        const paymentMethodForm = document.getElementById('payment-method-form');
        const paymentIdInput = document.getElementById('payment-id');
        const paymentMethodNameInput = document.getElementById('payment-method-name');
        const paymentMethodNumberInput = document.getElementById('payment-method-number');
        const paymentMethodAnInput = document.getElementById('payment-method-an');
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const cancelEditPaymentBtn = document.getElementById('cancel-edit-payment-btn');
        const paymentMethodsListDiv = document.getElementById('payment-methods-list');

        paymentMethodForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(addPaymentBtn, true, addPaymentBtn.textContent);

            const paymentData = {
                metode: paymentMethodNameInput.value,
                nomor: paymentMethodNumberInput.value,
                atas_nama: paymentMethodAnInput.value
            };

            try {
                if (paymentIdInput.value) {
                    await dbFS.collection('infoPembayaran').doc(paymentIdInput.value).update(paymentData);
                    showNotification('payment-notification', 'Metode pembayaran berhasil diupdate!', 'success');
                    addPaymentBtn.textContent = 'Tambah Metode';
                    cancelEditPaymentBtn.style.display = 'none';
                } else {
                    await dbFS.collection('infoPembayaran').add(paymentData);
                    showNotification('payment-notification', 'Metode pembayaran berhasil ditambahkan!', 'success');
                }
                paymentMethodForm.reset();
                paymentIdInput.value = '';
                currentPayment = null;
            } catch (error) {
                console.error("Error saving payment method:", error);
                showNotification('payment-notification', `Gagal menyimpan metode pembayaran: ${error.message}`, 'error');
            } finally {
                setButtonLoading(addPaymentBtn, false, addPaymentBtn.textContent);
                loadPaymentMethods();
            }
        });

        cancelEditPaymentBtn.addEventListener('click', () => {
            paymentMethodForm.reset();
            paymentIdInput.value = '';
            currentPayment = null;
            addPaymentBtn.textContent = 'Tambah Metode';
            cancelEditPaymentBtn.style.display = 'none';
        });

        async function loadPaymentMethods() {
            paymentMethodsListDiv.innerHTML = '<p>Memuat metode pembayaran...</p>';
            try {
                const snapshot = await dbFS.collection('infoPembayaran').get();
                paymentMethodsListDiv.innerHTML = '';
                if (snapshot.empty) {
                    paymentMethodsListDiv.innerHTML = '<p>Tidak ada metode pembayaran.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'info mb-3';
                    item.innerHTML = `
                        <p><b>Metode:</b> ${data.metode}</p>
                        <p><b>Nomor:</b> ${data.nomor}</p>
                        <p><b>Atas Nama:</b> ${data.atas_nama}</p>
                        <button class="btn-warning btn-sm" onclick="editPaymentMethod('${doc.id}')">Edit</button>
                        <button class="btn-danger btn-sm" onclick="deletePaymentMethod('${doc.id}')">Hapus</button>
                    `;
                    paymentMethodsListDiv.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading payment methods:", error);
                paymentMethodsListDiv.innerHTML = `<p class="text-danger">Gagal memuat metode pembayaran: ${error.message}</p>`;
            }
        }

        async function editPaymentMethod(id) {
            try {
                const doc = await dbFS.collection('infoPembayaran').doc(id).get();
                if (doc.exists) {
                    currentPayment = { id: doc.id, ...doc.data() };
                    paymentIdInput.value = currentPayment.id;
                    paymentMethodNameInput.value = currentPayment.metode;
                    paymentMethodNumberInput.value = currentPayment.nomor;
                    paymentMethodAnInput.value = currentPayment.atas_nama;
                    addPaymentBtn.textContent = 'Update Metode';
                    cancelEditPaymentBtn.style.display = 'inline-block';
                    document.getElementById('pembayaran').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing payment method:", error);
                showNotification('payment-notification', `Gagal memuat data metode pembayaran untuk diedit: ${error.message}`, 'error');
            }
        }

        async function deletePaymentMethod(id) {
            if (confirm("Apakah Anda yakin ingin menghapus metode pembayaran ini?")) {
                try {
                    await dbFS.collection('infoPembayaran').doc(id).delete();
                    showNotification('payment-notification', 'Metode pembayaran berhasil dihapus!', 'success');
                    loadPaymentMethods();
                } catch (error) {
                    console.error("Error deleting payment method:", error);
                    showNotification('payment-notification', `Gagal menghapus metode pembayaran: ${error.message}`, 'error');
                }
            }
        }

        // --- MANAJEMEN BANNER (BARU) ---
        const bannerForm = document.getElementById('banner-form');
        const bannerIdInput = document.getElementById('banner-id');
        const bannerTitleInput = document.getElementById('banner-title');
        const bannerDescriptionInput = document.getElementById('banner-description');
        const bannerButtonTextInput = document.getElementById('banner-button-text');
        const bannerTypeSelect = document.getElementById('banner-type');
        const bannerTargetEmailsInput = document.getElementById('banner-target-emails');
        const addBannerBtn = document.getElementById('add-banner-btn');
        const cancelEditBannerBtn = document.getElementById('cancel-edit-banner-btn');
        const bannerListTableBody = document.querySelector('#banner-list-table tbody');

        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(addBannerBtn, true, addBannerBtn.textContent);

            const targetEmailsArray = bannerTargetEmailsInput.value.split(',').map(email => email.trim()).filter(email => email !== '');

            const bannerData = {
                title: bannerTitleInput.value,
                description: bannerDescriptionInput.value,
                buttonText: bannerButtonTextInput.value,
                type: bannerTypeSelect.value,
                targetEmails: targetEmailsArray,
                isActive: true // Default to active when added/updated
            };

            try {
                if (bannerIdInput.value) {
                    await dbFS.collection('banners').doc(bannerIdInput.value).update(bannerData);
                    showNotification('banner-notification', 'Banner berhasil diupdate!', 'success');
                    addBannerBtn.textContent = 'Tambah Banner';
                    cancelEditBannerBtn.style.display = 'none';
                } else {
                    await dbFS.collection('banners').add(bannerData);
                    showNotification('banner-notification', 'Banner berhasil ditambahkan!', 'success');
                }
                bannerForm.reset();
                bannerIdInput.value = '';
                currentBanner = null;
            } catch (error) {
                console.error("Error saving banner:", error);
                showNotification('banner-notification', `Gagal menyimpan banner: ${error.message}`, 'error');
            } finally {
                setButtonLoading(addBannerBtn, false, addBannerBtn.textContent);
                loadBanners();
            }
        });

        cancelEditBannerBtn.addEventListener('click', () => {
            bannerForm.reset();
            bannerIdInput.value = '';
            currentBanner = null;
            addBannerBtn.textContent = 'Tambah Banner';
            cancelEditBannerBtn.style.display = 'none';
        });

        async function loadBanners() {
            bannerListTableBody.innerHTML = '<tr><td colspan="5">Memuat banner...</td></tr>';
            try {
                const snapshot = await dbFS.collection('banners').get();
                bannerListTableBody.innerHTML = '';
                if (snapshot.empty) {
                    bannerListTableBody.innerHTML = '<tr><td colspan="5">Tidak ada banner.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = bannerListTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.title}</td>
                        <td>${data.type}</td>
                        <td>${data.targetEmails && data.targetEmails.length > 0 ? data.targetEmails.join(', ') : 'Semua'}</td>
                        <td><span style="color: ${data.isActive ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${data.isActive ? 'Aktif' : 'Non-aktif'}</span></td>
                        <td>
                            <button class="btn-warning btn-sm" onclick="editBanner('${doc.id}')">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteBanner('${doc.id}')">Hapus</button>
                            <button class="btn-${data.isActive ? 'danger' : 'success'} btn-sm" onclick="toggleBannerStatus('${doc.id}', ${data.isActive})">
                                ${data.isActive ? 'Non-aktifkan' : 'Aktifkan'}
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error("Error loading banners:", error);
                bannerListTableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Gagal memuat banner: ${error.message}</td></tr>`;
            }
        }

        async function editBanner(id) {
            try {
                const doc = await dbFS.collection('banners').doc(id).get();
                if (doc.exists) {
                    currentBanner = { id: doc.id, ...doc.data() };
                    bannerIdInput.value = currentBanner.id;
                    bannerTitleInput.value = currentBanner.title;
                    bannerDescriptionInput.value = currentBanner.description;
                    bannerButtonTextInput.value = currentBanner.buttonText;
                    bannerTypeSelect.value = currentBanner.type;
                    bannerTargetEmailsInput.value = currentBanner.targetEmails ? currentBanner.targetEmails.join(', ') : '';
                    addBannerBtn.textContent = 'Update Banner';
                    cancelEditBannerBtn.style.display = 'inline-block';
                    document.getElementById('manajemen-banner').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing banner:", error);
                showNotification('banner-notification', `Gagal memuat data banner untuk diedit: ${error.message}`, 'error');
            }
        }

        async function deleteBanner(id) {
            if (confirm("Apakah Anda yakin ingin menghapus banner ini?")) {
                try {
                    await dbFS.collection('banners').doc(id).delete();
                    showNotification('banner-notification', 'Banner berhasil dihapus!', 'success');
                    loadBanners();
                } catch (error) {
                    console.error("Error deleting banner:", error);
                    showNotification('banner-notification', `Gagal menghapus banner: ${error.message}`, 'error');
                }
            }
        }

        async function toggleBannerStatus(id, currentStatus) {
            try {
                await dbFS.collection('banners').doc(id).update({ isActive: !currentStatus });
                showNotification('banner-notification', `Banner berhasil ${!currentStatus ? 'diaktifkan' : 'dinonaktifkan'}!`, 'success');
                loadBanners();
            } catch (error) {
                console.error("Error toggling banner status:", error);
                showNotification('banner-notification', `Gagal mengubah status banner: ${error.message}`, 'error');
            }
        }

        // --- KODE KUSTOM (DISKON PROMOSI) ---
        const discountResellerForm = document.getElementById('discount-reseller-form');
        const resellerEmailDiscountInput = document.getElementById('reseller-email-discount');
        const giveResellerDiscountBtn = document.getElementById('give-reseller-discount-btn');

        discountResellerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(giveResellerDiscountBtn, true, 'Beri Diskon ke Reseller');
            const email = resellerEmailDiscountInput.value;

            try {
                const resellerSnapshot = await dbFS.collection('resellers').where('email', '==', email).limit(1).get();
                if (resellerSnapshot.empty) {
                    throw new Error("Reseller dengan email tersebut tidak ditemukan.");
                }

                const resellerDoc = resellerSnapshot.docs[0];
                await resellerDoc.ref.update({ punyaHakDiskon: true });
                showNotification('discount-reseller-notification', `Diskon berhasil diberikan kepada reseller ${email}!`, 'success');
                resellerEmailDiscountInput.value = '';
                loadActiveResellers(); // Refresh untuk melihat status 'punyaHakDiskon'
            } catch (error) {
                console.error("Error giving reseller discount:", error);
                showNotification('discount-reseller-notification', `Gagal memberikan diskon: ${error.message}`, 'error');
            } finally {
                setButtonLoading(giveResellerDiscountBtn, false, 'Beri Diskon ke Reseller');
            }
        });

        const discountBuyerForm = document.getElementById('discount-buyer-form');
        const buyerWaDiscountInput = document.getElementById('buyer-wa-discount');
        const giveBuyerDiscountBtn = document.getElementById('give-buyer-discount-btn');

        discountBuyerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(giveBuyerDiscountBtn, true, 'Beri Diskon ke Pembeli');
            const waNumber = normalizePhoneNumber(buyerWaDiscountInput.value);

            try {
                await dbRT.ref('hakDiskon/' + waNumber).set(true);
                showNotification('discount-buyer-notification', `Hak diskon berhasil diberikan kepada pembeli ${waNumber}!`, 'success');
                buyerWaDiscountInput.value = '';
            } catch (error) {
                console.error("Error giving buyer discount:", error);
                showNotification('discount-buyer-notification', `Gagal memberikan diskon: ${error.message}`, 'error');
            } finally {
                setButtonLoading(giveBuyerDiscountBtn, false, 'Beri Diskon ke Pembeli');
            }
        });

        function normalizePhoneNumber(num) {
            let n = String(num).trim().replace(/[^0-9]/g, '');
            if (n.startsWith('0')) return '62' + n.slice(1);
            if (n.startsWith('62')) return n;
            return num; // Mengembalikan apa adanya jika tidak diawali 0 atau 62 (mungkin ada kasus lain)
        }
    </script>
</body>
    </html>
