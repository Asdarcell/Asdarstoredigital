<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #007bff; /* Primary color */
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .nav-link.active {
            background-color: #0056b3 !important; /* Darker primary for active tab */
        }
        .sidebar {
            background-color: #343a40; /* Dark sidebar */
            color: white;
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #adb5bd;
        }
        .sidebar .nav-link.active {
            color: white;
            background-color: #495057;
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #218838; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; border-color: #c82333; }
        .btn-warning { background-color: #ffc107; border-color: #ffc107; color: #212529;}
        .btn-warning:hover { background-color: #e0a800; border-color: #e0a800; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; border-color: #138496; }
        .btn-outline-danger { border-color: #dc3545; color: #dc3545; }
        .btn-outline-danger:hover { background-color: #dc3545; color: white; }

        /* Custom Status Badges */
        .status-badge {
            display: inline-block;
            padding: .25em .4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
            color: white; /* Default text color for badges */
        }

        .status-pending, .status-menunggu-verifikasi { background-color: #ffc107; color: #212529; } /* Warning */
        .status-active, .status-disetujui, .status-completed, .status-selesai, .status-diproses { background-color: #28a745; } /* Success */
        .status-rejected, .status-ditolak, .status-dibatalkan { background-color: #dc3545; } /* Danger */
        .status-belum-bayar { background-color: #007bff; } /* Primary */
        /* Tambahkan status lain jika ada */

        #promo-options { display: none; }
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <div class="bg-dark border-right sidebar" id="sidebar-wrapper">
            <div class="sidebar-heading text-white p-3">Admin Dashboard</div>
            <div class="list-group list-group-flush">
                <a href="#products" class="list-group-item list-group-item-action bg-dark text-white active" data-bs-toggle="pill" data-bs-target="#products" id="products-tab" type="button" role="tab" aria-controls="products" aria-selected="true">Produk</a>
                <a href="#active-resellers" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#active-resellers" id="active-resellers-tab" type="button" role="tab" aria-controls="active-resellers" aria-selected="false">Reseller Aktif</a>
                <a href="#verification" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#verification" id="verification-tab" type="button" role="tab" aria-controls="verification" aria-selected="false">Verifikasi Reseller <span class="badge bg-danger ms-2" id="verification-count" style="display:none;"></span></a>
                <a href="#topup-confirmations" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#topup-confirmations" id="topup-tab" type="button" role="tab" aria-controls="topup-confirmations" aria-selected="false">Konfirmasi Top Up</a>
                <a href="#orders" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#orders" id="orders-tab" type="button" role="tab" aria-controls="orders" aria-selected="false">Pesanan</a>
                <a href="#testimonials" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#testimonials" id="testimonials-tab" type="button" role="tab" aria-controls="testimonials" aria-selected="false">Testimoni</a>
                <a href="#faq" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#faq" id="faq-tab" type="button" role="tab" aria-controls="faq" aria-selected="false">FAQ</a>
                <a href="#payment-methods" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#payment-methods" id="payments-tab" type="button" role="tab" aria-controls="payment-methods" aria-selected="false">Metode Pembayaran</a>
                <a href="#promo-management" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#promo-management" id="promo-management-tab" type="button" role="tab" aria-controls="promo-management" aria-selected="false">Manajemen Promo</a>
                <a href="#gift-claims" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#gift-claims" id="gift-claims-tab" type="button" role="tab" aria-controls="gift-claims" aria-selected="false">Klaim Hadiah Pembeli</a>
                <a href="#banners" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#banners" id="banners-tab" type="button" role="tab" aria-controls="banners" aria-selected="false">Banner</a>
                <a href="#custom-code" class="list-group-item list-group-item-action bg-dark text-white" data-bs-toggle="pill" data-bs-target="#custom-code" id="custom-code-tab" type="button" role="tab" aria-controls="custom-code" aria-selected="false">Kode Kustom</a>
            </div>
        </div>
        <div id="page-content-wrapper" class="flex-grow-1">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="userEmailDisplay">admin@example.com</a>
                            </li>
                            <li class="nav-item">
                                <button class="btn btn-outline-light ms-2" id="logout-btn">Logout</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="container-fluid py-4">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="products" role="tabpanel" aria-labelledby="products-tab">
                        <h2>Manajemen Produk</h2>
                        <div class="card p-4 mb-4">
                            <form id="product-form">
                                <div class="mb-3">
                                    <label for="nama_produk" class="form-label">Nama Produk</label>
                                    <input type="text" class="form-control" id="nama_produk" required>
                                </div>
                                <div class="mb-3">
                                    <label for="kategori" class="form-label">Kategori</label>
                                    <input type="text" class="form-control" id="kategori" required>
                                </div>
                                <div class="mb-3">
                                    <label for="deskripsi" class="form-label">Deskripsi</label>
                                    <textarea class="form-control" id="deskripsi" rows="3" required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="harga_umum" class="form-label">Harga Umum</label>
                                        <input type="number" class="form-control" id="harga_umum" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="harga_reseller" class="form-label">Harga Reseller</label>
                                        <input type="number" class="form-control" id="harga_reseller" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="stok" class="form-label">Stok</label>
                                        <input type="number" class="form-control" id="stok" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="urutan" class="form-label">Urutan Tampil</label>
                                        <input type="number" class="form-control" id="urutan" value="0" required>
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="promo-checkbox">
                                    <label class="form-check-label" for="promo-checkbox">
                                        Aktifkan Promo
                                    </label>
                                </div>
                                <div id="promo-options" class="mb-3 p-3 border rounded bg-light">
                                    <div class="mb-3">
                                        <label for="promo-jenis" class="form-label">Jenis Promo</label>
                                        <select class="form-select" id="promo-jenis">
                                            <option value="persen">Persentase (%)</option>
                                            <option value="nominal">Potongan Nominal (Rp)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="promo-nilai" class="form-label">Nilai Promo</label>
                                        <input type="number" class="form-control" id="promo-nilai">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Simpan Produk</button>
                                <button type="button" class="btn btn-secondary ms-2" id="cancel-edit-btn" style="display: none;">Batal Edit</button>
                            </form>
                        </div>
                        <h3>Daftar Produk</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nama Produk</th>
                                        <th>Kategori</th>
                                        <th>Harga Umum</th>
                                        <th>Harga Reseller</th>
                                        <th>Stok</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="active-resellers" role="tabpanel" aria-labelledby="active-resellers-tab">
                        <h2>Reseller Aktif</h2>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Email Reseller</th>
                                        <th>Saldo</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="resellers-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="verification" role="tabpanel" aria-labelledby="verification-tab">
                        <h2>Verifikasi Pendaftaran Reseller</h2>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Paket</th>
                                        <th>Deposit</th>
                                        <th>Bukti</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="verification-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="topup-confirmations" role="tabpanel" aria-labelledby="topup-tab">
                        <h2>Konfirmasi Top Up</h2>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID Transaksi</th>
                                        <th>Email Reseller</th>
                                        <th>Jumlah</th>
                                        <th>Bukti Transfer</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="topup-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                        <h2>Daftar Pesanan</h2>
                        <div class="mb-3">
                            <label for="order-filter" class="form-label">Filter Pesanan:</label>
                            <select class="form-select" id="order-filter">
                                <option value="all">Semua Pesanan</option>
                                <option value="umum">Pesanan Umum</option>
                                <option value="reseller">Pesanan Reseller</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Produk</th>
                                        <th>Info Pembeli</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="testimonials" role="tabpanel" aria-labelledby="testimonials-tab">
                        <h2>Manajemen Testimoni</h2>
                        <div class="card p-4 mb-4">
                            <form id="testimonial-form">
                                <div class="mb-3">
                                    <label for="testimonial-nama" class="form-label">Nama</label>
                                    <input type="text" class="form-control" id="testimonial-nama" required>
                                </div>
                                <div class="mb-3">
                                    <label for="testimonial-isi" class="form-label">Isi Testimoni</label>
                                    <textarea class="form-control" id="testimonial-isi" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Simpan Testimoni</button>
                                <button type="button" class="btn btn-secondary ms-2" id="cancel-testimonial-edit-btn" style="display: none;">Batal Edit</button>
                            </form>
                        </div>
                        <h3>Daftar Testimoni</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Pesan</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="testimonials-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="faq" role="tabpanel" aria-labelledby="faq-tab">
                        <h2>Manajemen FAQ</h2>
                        <div class="card p-4 mb-4">
                            <form id="faq-form">
                                <div class="mb-3">
                                    <label for="faq_q" class="form-label">Pertanyaan</label>
                                    <input type="text" class="form-control" id="faq_q" required>
                                </div>
                                <div class="mb-3">
                                    <label for="faq_a" class="form-label">Jawaban</label>
                                    <textarea class="form-control" id="faq_a" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Simpan FAQ</button>
                            </form>
                        </div>
                        <h3>Daftar FAQ</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Pertanyaan</th>
                                        <th>Jawaban</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="faq-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="payment-methods" role="tabpanel" aria-labelledby="payments-tab">
                        <h2>Manajemen Metode Pembayaran</h2>
                        <div class="card p-4 mb-4">
                            <form id="payment-form">
                                <div class="mb-3">
                                    <label for="payment_metode" class="form-label">Metode Pembayaran</label>
                                    <input type="text" class="form-control" id="payment_metode" placeholder="Contoh: Bank BCA / Dana" required>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_nomor" class="form-label">Nomor Rekening/Telepon</label>
                                    <input type="text" class="form-control" id="payment_nomor" placeholder="Contoh: 1234567890" required>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_an" class="form-label">Atas Nama</label>
                                    <input type="text" class="form-control" id="payment_an" placeholder="Contoh: Nama Pemilik Akun" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Simpan Metode Pembayaran</button>
                            </form>
                        </div>
                        <h3>Daftar Metode Pembayaran</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Metode</th>
                                        <th>Nomor</th>
                                        <th>Atas Nama</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="promo-management" role="tabpanel" aria-labelledby="promo-management-tab">
                        <h2>Manajemen Promo Manual</h2>
                        <p class="text-muted">Gunakan bagian ini untuk memberikan hak diskon secara manual.</p>

                        <div class="card p-4 mb-4">
                            <h4>Berikan Hak Diskon Reseller</h4>
                            <form id="grant-reseller-promo-form">
                                <div class="mb-3">
                                    <label for="reseller-promo-email" class="form-label">Email Reseller</label>
                                    <input type="email" class="form-control" id="reseller-promo-email" required placeholder="email@reseller.com">
                                    <small class="form-text text-muted">Akan memberikan hak diskon khusus reseller.</small>
                                </div>
                                <button type="submit" class="btn btn-primary">Berikan Diskon Reseller</button>
                            </form>
                        </div>

                        <div class="card p-4">
                            <h4>Berikan Hak Diskon Pembeli Biasa</h4>
                            <form id="grant-buyer-promo-form">
                                <div class="mb-3">
                                    <label for="buyer-promo-email" class="form-label">Email Pembeli Biasa</label>
                                    <input type="email" class="form-control" id="buyer-promo-email" required placeholder="email@pembeli.com">
                                    <small class="form-text text-muted">Akan memberikan diskon otomatis sebesar Rp5.000 pada pembelian berikutnya.</small>
                                </div>
                                <button type="submit" class="btn btn-primary">Berikan Diskon Pembeli</button>
                            </form>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="gift-claims" role="tabpanel" aria-labelledby="gift-claims-tab">
                        <h2>Klaim Hadiah Pembeli</h2>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Email/UserID Pembeli</th>
                                        <th>Waktu Klaim</th>
                                        <th>Status</th>
                                        <th>Bukti</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="gift-claims-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="banners" role="tabpanel" aria-labelledby="banners-tab">
                        <h2>Manajemen Banner</h2>
                        <div class="card p-4 mb-4">
                            <form id="banner-form">
                                <div class="mb-3">
                                    <label for="banner_url" class="form-label">URL Gambar Banner</label>
                                    <input type="url" class="form-control" id="banner_url" placeholder="https://example.com/banner.jpg" required>
                                </div>
                                <div class="mb-3">
                                    <label for="banner_link" class="form-label">Tautan (Link)</label>
                                    <input type="url" class="form-control" id="banner_link" placeholder="https://example.com/promo-page (Opsional)">
                                </div>
                                <div class="mb-3">
                                    <label for="banner_urutan" class="form-label">Urutan Tampil</label>
                                    <input type="number" class="form-control" id="banner_urutan" value="0" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Simpan Banner</button>
                                <button type="button" class="btn btn-secondary ms-2" id="cancel-banner-edit-btn" style="display: none;">Batal Edit</button>
                            </form>
                        </div>
                        <h3>Daftar Banner</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Urutan</th>
                                        <th>Gambar</th>
                                        <th>Tautan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="banners-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="custom-code" role="tabpanel" aria-labelledby="custom-code-tab">
                        <h2>Manajemen Kode Kustom</h2>
                        <p class="text-muted">Tambahkan atau kelola kode HTML, CSS, atau JavaScript kustom untuk disuntikkan ke halaman utama.</p>
                        <div class="card p-4 mb-4">
                            <h4>Tambah Fitur Kustom Baru</h4>
                            <form id="add-feature-form">
                                <div class="mb-3">
                                    <label for="feature-name" class="form-label">Nama Fitur</label>
                                    <input type="text" class="form-control" id="feature-name" placeholder="Contoh: Popup Hari Raya" required>
                                </div>
                                <div class="mb-3">
                                    <label for="feature-html" class="form-label">Kode HTML (Opsional)</label>
                                    <textarea class="form-control" id="feature-html" rows="5" placeholder=""></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="feature-css" class="form-label">Kode CSS (Opsional)</label>
                                    <textarea class="form-control" id="feature-css" rows="5" placeholder="/* Kode CSS di sini */"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="feature-js" class="form-label">Kode JavaScript (Opsional)</label>
                                    <textarea class="form-control" id="feature-js" rows="5" placeholder="// Kode JavaScript di sini"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Tambah Fitur</button>
                            </form>
                        </div>
                        <h3>Daftar Fitur Kustom Aktif</h3>
                        <div id="custom-features-list">
                            </div>
                    </div>

                </div>
            </div>
        </div>
        </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto text-dark">Notifikasi</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Pesan notifikasi
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // ==========================================================
        //  KONFIGURASI FIREBASE DAN FUNGSI UMUM
        // ==========================================================
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY", // Ganti dengan API Key Firebase Anda
          authDomain: "YOUR_AUTH_DOMAIN",
          databaseURL: "YOUR_DATABASE_URL",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET"
        };
        // Inisialisasi Firebase hanya jika belum diinisialisasi
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();
        const storage = firebase.storage();

        // Redirect jika belum login dan tampilkan email admin
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = "loginadmin.html";
            } else {
                document.getElementById('userEmailDisplay').textContent = user.email;
            }
        });

        // Fungsi logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = "loginadmin.html";
            }).catch(error => {
                console.error("Error logging out:", error);
                showToast("Gagal logout: " + error.message, 'danger');
            });
        });

        // Toggle Sidebar
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('toggled');
        });

        // Fungsi format Rupiah
        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

        // Fungsi copy to clipboard
        function copyToClipboard(text, element) {
            if (!navigator.clipboard) { alert("Browser Anda tidak mendukung fitur salin."); return; }
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.innerHTML;
                element.innerHTML = 'Disalin!'; element.disabled = true;
                setTimeout(() => { element.innerHTML = originalText; element.disabled = false; }, 1500);
            }).catch(err => { console.error('Gagal menyalin: ', err); alert('Gagal menyalin ID.'); });
        }

        // Fungsi menampilkan Toast Notifikasi
        function showToast(message, type = 'success') {
            const toastElement = document.getElementById('liveToast');
            const toastBody = toastElement.querySelector('.toast-body');
            const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastElement);

            // Reset classes
            toastElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
            toastElement.classList.add(type === 'danger' ? 'bg-danger' : `bg-${type}`);
            toastBody.textContent = message;
            toastBootstrap.show();
        }

        // Fungsi loading button
        function setButtonLoading(button, isLoading) {
            if(!button) return; // Pastikan tombol ada
            if (isLoading) {
                if (!button.dataset.originalText) { button.dataset.originalText = button.innerHTML; }
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memuat...';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }
        }

        // ====================================== MANAJEMEN TABS & PEMUATAN DATA AWAL ======================================
        document.addEventListener('DOMContentLoaded', () => {
            // Muat data untuk semua tab saat halaman dimuat
            loadProducts();
            loadResellers();
            loadTopupConfirmations();
            loadOrders();
            loadTestimonials();
            loadFaq();
            loadPaymentMethods();
            loadBanners();
            loadPendingResellers();
            loadCustomFeatures();
            loadGiftClaims(); // Panggil fungsi untuk memuat klaim hadiah

            // Setup event listeners untuk form manajemen promo
            setupPromoManagementForms();
        });

        // Event listeners untuk setiap tab (agar data di-refresh setiap kali tab diklik)
        document.getElementById('products-tab').addEventListener('click', loadProducts);
        document.getElementById('active-resellers-tab').addEventListener('click', loadResellers);
        document.getElementById('verification-tab').addEventListener('click', loadPendingResellers);
        document.getElementById('topup-tab').addEventListener('click', loadTopupConfirmations);
        document.getElementById('orders-tab').addEventListener('click', loadOrders);
        document.getElementById('testimonials-tab').addEventListener('click', loadTestimonials);
        document.getElementById('faq-tab').addEventListener('click', loadFaq);
        document.getElementById('payments-tab').addEventListener('click', loadPaymentMethods);
        document.getElementById('promo-management-tab').addEventListener('click', setupPromoManagementForms);
        document.getElementById('gift-claims-tab').addEventListener('click', loadGiftClaims);
        document.getElementById('banners-tab').addEventListener('click', loadBanners);
        document.getElementById('custom-code-tab').addEventListener('click', loadCustomFeatures);

        // =================================== MANAJEMEN PROMO MANUAL (FITUR BARU) ===================================
        function setupPromoManagementForms() {
            const resellerPromoForm = document.getElementById('grant-reseller-promo-form');
            const buyerPromoForm = document.getElementById('grant-buyer-promo-form');

            // Hapus listener lama jika ada (untuk mencegah duplikasi saat tab diklik ulang)
            // Ini adalah cara yang lebih aman daripada onsubmit = async (e) => { ... }
            // yang akan menimpa listener jika dipanggil berkali-kali.
            const clonedResellerForm = resellerPromoForm.cloneNode(true);
            resellerPromoForm.parentNode.replaceChild(clonedResellerForm, resellerPromoForm);
            const finalResellerPromoForm = clonedResellerForm;

            const clonedBuyerForm = buyerPromoForm.cloneNode(true);
            buyerPromoForm.parentNode.replaceChild(clonedBuyerForm, buyerPromoForm);
            const finalBuyerPromoForm = clonedBuyerForm;


            if (finalResellerPromoForm) {
                finalResellerPromoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('reseller-promo-email').value;
                    const button = e.target.querySelector('[type=submit]');
                    setButtonLoading(button, true);

                    try {
                        const resellerQuery = await dbFS.collection('resellers').where('email', '==', email).limit(1).get();
                        if (resellerQuery.empty) {
                            throw new Error('Reseller dengan email tersebut tidak ditemukan.');
                        }
                        const resellerDoc = resellerQuery.docs[0];
                        await dbFS.collection('resellers').doc(resellerDoc.id).update({
                            punyaHakDiskon: true, // Memberikan hak diskon kepada reseller
                            waktuDiskonDiberikan: firebase.firestore.FieldValue.serverTimestamp() // Catat waktu pemberian
                        });
                        showToast(`Hak diskon berhasil diberikan kepada reseller: ${email}`, 'success');
                        finalResellerPromoForm.reset();
                    } catch (error) {
                        showToast('Gagal: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                });
            }

            if (finalBuyerPromoForm) {
                finalBuyerPromoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('buyer-promo-email').value;
                    const button = e.target.querySelector('[type=submit]');
                    setButtonLoading(button, true);

                    try {
                        // Kita gunakan email sebagai ID dokumen agar mudah dicari dan tidak duplikat
                        // Dokumen ini akan menandakan bahwa pembeli biasa dengan email ini berhak mendapatkan diskon
                        await dbFS.collection('hakDiskonOtomatis').doc(email).set({
                            email: email,
                            diberikanPada: firebase.firestore.FieldValue.serverTimestamp(), // Timestamp pemberian hak diskon
                            isUsed: false // Status awal: belum digunakan
                        }, { merge: true }); // Merge true agar tidak menimpa data jika sudah ada

                        showToast(`Hak diskon berhasil diberikan kepada pembeli: ${email}`, 'success');
                        finalBuyerPromoForm.reset();
                    } catch (error) {
                        showToast('Gagal: ' + error.message, 'danger');
                    } finally {
                        setButtonLoading(button, false);
                    }
                });
            }
        }


        // =================================== PRODUK (Firestore) ===================================
        const productForm = document.getElementById('product-form');
        const productsTableBody = document.querySelector('#products-table-body');
        const promoCheckbox = document.getElementById('promo-checkbox');
        const promoOptions = document.getElementById('promo-options');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        let currentProductId = null;

        promoCheckbox.addEventListener('change', () => { promoOptions.style.display = promoCheckbox.checked ? 'block' : 'none'; });

        function loadProducts() {
            dbFS.collection('produk').orderBy('urutan').onSnapshot(s => { // Menggunakan onSnapshot untuk real-time update
                productsTableBody.innerHTML = '';
                if (s.empty) {
                    productsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada produk.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    const r = productsTableBody.insertRow();
                    r.innerHTML = `
                        <td>${p.nama_produk}</td>
                        <td>${p.kategori}</td>
                        <td>${formatRupiah(p.harga_umum)}</td>
                        <td>${formatRupiah(p.harga_reseller)}</td>
                        <td>${p.stok}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editProduct('${p.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                productsTableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Gagal memuat produk: ${e.message}</td></tr>`;
            });
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const productData = {
                nama_produk: document.getElementById('nama_produk').value,
                kategori: document.getElementById('kategori').value,
                deskripsi: document.getElementById('deskripsi').value,
                harga_umum: parseInt(document.getElementById('harga_umum').value),
                harga_reseller: parseInt(document.getElementById('harga_reseller').value),
                stok: parseInt(document.getElementById('stok').value),
                urutan: parseInt(document.getElementById('urutan').value),
                promo: promoCheckbox.checked ? {
                    jenis: document.getElementById('promo-jenis').value,
                    nilai: parseInt(document.getElementById('promo-nilai').value)
                } : null
            };

            try {
                if (currentProductId) {
                    await dbFS.collection('produk').doc(currentProductId).update(productData);
                    showToast('Produk berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('produk').add(productData);
                    showToast('Produk berhasil ditambahkan!', 'success');
                }
                productForm.reset();
                cancelEditBtn.style.display = 'none';
                promoOptions.style.display = 'none';
                currentProductId = null;
                // loadProducts() otomatis ter-refresh karena onSnapshot
            } catch (err) {
                showToast('Gagal menyimpan produk: ' + err.message, 'danger');
            } finally {
                setButtonLoading(btn, false);
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            productForm.reset();
            cancelEditBtn.style.display = 'none';
            promoOptions.style.display = 'none';
            currentProductId = null;
        });

        async function editProduct(id) {
            const doc = await dbFS.collection('produk').doc(id).get();
            if (doc.exists) {
                const product = doc.data();
                currentProductId = id;
                document.getElementById('nama_produk').value = product.nama_produk;
                document.getElementById('kategori').value = product.kategori;
                document.getElementById('deskripsi').value = product.deskripsi;
                document.getElementById('harga_umum').value = product.harga_umum;
                document.getElementById('harga_reseller').value = product.harga_reseller;
                document.getElementById('stok').value = product.stok;
                document.getElementById('urutan').value = product.urutan || 0;

                promoCheckbox.checked = !!product.promo;
                promoOptions.style.display = product.promo ? 'block' : 'none';
                if (product.promo) {
                    document.getElementById('promo-jenis').value = product.promo.jenis;
                    document.getElementById('promo-nilai').value = product.promo.nilai;
                }
                cancelEditBtn.style.display = 'block';
                productForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteProduct(id) {
            if (confirm('Anda yakin ingin menghapus produk ini secara permanen?')) {
                try {
                    await dbFS.collection('produk').doc(id).delete();
                    // loadProducts() otomatis ter-refresh karena onSnapshot
                    showToast('Produk berhasil dihapus!', 'warning');
                } catch (e) {
                    showToast('Gagal menghapus produk: ' + e.message, 'danger');
                }
            }
        }

        // =================================== RESELLER (Firestore) ===================================
        const resellersTableBody = document.querySelector('#resellers-table-body');
        function loadResellers() {
            dbFS.collection('resellers').where('status', '==', 'active').onSnapshot(s => { // Menggunakan onSnapshot
                resellersTableBody.innerHTML = '';
                if (s.empty) {
                    resellersTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada reseller aktif.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const r = { id: d.id, ...d.data() };
                    const row = resellersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${r.email}</td>
                        <td>${formatRupiah(r.saldo || 0)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="addSaldo('${r.id}', ${r.saldo || 0}, this)">+ Saldo</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReseller('${r.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                resellersTableBody.innerHTML = `<tr><td colspan="3" class="text-danger">Gagal memuat reseller: ${e.message}</td></tr>`;
            });
        }
        async function addSaldo(id, saldo, btn) {
            const nominalStr = prompt("Masukkan nominal saldo yang akan ditambahkan:");
            if (nominalStr !== null) {
                const nominal = parseInt(nominalStr);
                if (!isNaN(nominal) && nominal > 0) {
                    setButtonLoading(btn, true);
                    try {
                        await dbFS.collection('resellers').doc(id).update({ saldo: firebase.firestore.FieldValue.increment(nominal) }); // Menggunakan increment
                        showToast(`Saldo ${formatRupiah(nominal)} berhasil ditambahkan!`, 'success');
                        // loadResellers() otomatis ter-refresh
                    } catch (e) {
                        showToast('Gagal menambah saldo: ' + e.message, 'danger');
                    } finally {
                        setButtonLoading(btn, false);
                    }
                } else {
                    showToast("Input nominal tidak valid. Masukkan angka positif.", 'warning');
                }
            }
        }
        async function deleteReseller(id, btn) {
            if (confirm('Anda yakin ingin menghapus reseller ini secara permanen? Ini tidak dapat dibatalkan.')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('resellers').doc(id).delete();
                    showToast('Reseller berhasil dihapus.', 'warning');
                    // loadResellers() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menghapus reseller: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== VERIFIKASI RESELLER (Firestore) ===================================
        const verificationTableBody = document.getElementById('verification-table-body');
        const verificationCountBadge = document.getElementById('verification-count');

        function loadPendingResellers() {
            dbFS.collection('resellers').where('status', '==', 'pending-approval').onSnapshot(s => {
                verificationTableBody.innerHTML = '';
                if (s.empty) {
                    verificationTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Tidak ada pendaftar yang menunggu verifikasi.</td></tr>`;
                    verificationCountBadge.style.display = 'none';
                    return;
                }
                verificationCountBadge.textContent = s.size;
                verificationCountBadge.style.display = 'inline';
                s.forEach(d => {
                    const r = d.data();
                    const uid = d.id; // UID reseller adalah ID dokumen
                    const row = `
                        <tr>
                            <td>${r.email}</td>
                            <td>Paket ${r.paket || 'N/A'}</td>
                            <td>${formatRupiah(r.depositAmount)}</td>
                            <td><a href="${r.depositProofURL}" target="_blank" class="btn btn-sm btn-info">Lihat Bukti</a></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="approveReseller('${uid}', this)">Setujui</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectReseller('${uid}', this)">Tolak</button>
                            </td>
                        </tr>
                    `;
                    verificationTableBody.innerHTML += row;
                });
            }, e => {
                verificationTableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Gagal memuat verifikasi: ${e.message}</td></tr>`;
            });
        }

        async function approveReseller(uid, btn) {
            if (confirm('Setujui pendaftaran reseller ini?')) {
                setButtonLoading(btn, true);
                try {
                    const resellerDoc = await dbFS.collection('resellers').doc(uid).get();
                    if (!resellerDoc.exists) throw new Error('Reseller tidak ditemukan.');
                    const { depositAmount } = resellerDoc.data();

                    await dbFS.collection('resellers').doc(uid).update({
                        status: 'active',
                        saldo: firebase.firestore.FieldValue.increment(depositAmount), // Tambahkan deposit ke saldo
                        waktuAktif: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Pendaftaran reseller disetujui!', 'success');
                    // loadPendingResellers() otomatis ter-refresh
                    // loadResellers() juga akan ter-refresh karena onSnapshot
                } catch (e) {
                    showToast('Gagal menyetujui reseller: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function rejectReseller(uid, btn) {
            if (confirm('Tolak pendaftaran reseller ini?')) {
                const reason = prompt("Alasan penolakan (opsional):");
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('resellers').doc(uid).update({
                        status: 'rejected',
                        alasanDitolak: reason || null,
                        waktuDitolak: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Pendaftaran reseller ditolak.', 'warning');
                    // loadPendingResellers() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menolak reseller: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== KONFIRMASI TOP UP (Firestore) ===================================
        const topupTableBody = document.querySelector('#topup-table-body');
        function loadTopupConfirmations() {
            dbFS.collection('topupTransactions').where('status', '==', 'pending').onSnapshot(s => { // Menggunakan onSnapshot
                topupTableBody.innerHTML = '';
                if (s.empty) {
                    topupTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada permintaan Top Up yang menunggu konfirmasi.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() };
                    const r = topupTableBody.insertRow();
                    r.innerHTML = `
                        <td>${t.id}</td>
                        <td>${t.resellerEmail}</td>
                        <td>${formatRupiah(t.amount)}</td>
                        <td><a href="${t.proofURL}" target="_blank" class="btn btn-sm btn-info">Lihat Bukti</a></td>
                        <td><span class="status-badge status-pending">Pending</span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="confirmTopup('${t.id}', '${t.resellerId}', ${t.amount}, this)">Konfirmasi</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectTopup('${t.id}', this)">Tolak</button>
                        </td>
                    `;
                });
            }, e => {
                topupTableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Gagal memuat top up: ${e.message}</td></tr>`;
            });
        }

        async function confirmTopup(topupId, resellerId, amount, btn) {
            if (confirm('Konfirmasi Top Up ini? Saldo reseller akan ditambahkan.')) {
                setButtonLoading(btn, true);
                try {
                    // Update status transaksi topup
                    await dbFS.collection('topupTransactions').doc(topupId).update({
                        status: 'completed',
                        waktuKonfirmasi: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Tambahkan saldo ke reseller
                    await dbFS.collection('resellers').doc(resellerId).update({
                        saldo: firebase.firestore.FieldValue.increment(amount)
                    });

                    showToast('Top Up berhasil dikonfirmasi!', 'success');
                    // loadTopupConfirmations() dan loadResellers() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal mengkonfirmasi Top Up: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function rejectTopup(topupId, btn) {
            if (confirm('Tolak permintaan Top Up ini?')) {
                const reason = prompt("Alasan penolakan (opsional):");
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('topupTransactions').doc(topupId).update({
                        status: 'rejected',
                        alasanDitolak: reason || null,
                        waktuDitolak: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Top Up ditolak.', 'warning');
                    // loadTopupConfirmations() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menolak Top Up: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== PESANAN (Firestore) ===================================
        const ordersTableBody = document.getElementById('orders-table-body');
        const orderFilter = document.getElementById('order-filter');

        orderFilter.addEventListener('change', loadOrders); // Muat ulang pesanan saat filter berubah

        function loadOrders() {
            let query = dbFS.collection('orders').orderBy('timestamp', 'desc');

            const filterValue = orderFilter.value;
            if (filterValue === 'all') {
                // Do nothing, query is already for all orders
            } else if (filterValue === 'umum') {
                query = query.where('isResellerOrder', '==', false);
            } else if (filterValue === 'reseller') {
                query = query.where('isResellerOrder', '==', true);
            }

            query.onSnapshot(s => { // Menggunakan onSnapshot
                ordersTableBody.innerHTML = '';
                if (s.empty) {
                    ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada pesanan.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const order = { id: d.id, ...d.data() };
                    const customerInfo = order.customerName || order.customerEmail || order.resellerEmail || 'N/A';
                    const productName = Array.isArray(order.items) ? order.items.map(item => `${item.nama_produk} (${item.quantity})`).join(', ') : order.productName || 'N/A';
                    const statusClass = `status-${(order.status || '').toLowerCase().replace(/ /g, '-')}`;

                    const row = `
                        <tr>
                            <td><button class="btn btn-link btn-sm" onclick="copyToClipboard('${order.id}', this)">${order.id.substring(0, 6)}...</button></td>
                            <td>${productName}</td>
                            <td>${customerInfo}</td>
                            <td>${formatRupiah(order.totalAmount)}</td>
                            <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                            <td>
                                ${order.status === 'belum-bayar' ? `<button class="btn btn-primary btn-sm" onclick="markOrderPaid('${order.id}', this)">Bayar</button>` : ''}
                                ${order.status === 'diproses' ? `<button class="btn btn-success btn-sm" onclick="markOrderCompleted('${order.id}', this)">Selesai</button>` : ''}
                                ${order.status !== 'dibatalkan' && order.status !== 'selesai' ? `<button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.id}', this)">Batal</button>` : ''}
                            </td>
                        </tr>
                    `;
                    ordersTableBody.innerHTML += row;
                });
            }, e => {
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Gagal memuat pesanan: ${e.message}</td></tr>`;
            });
        }

        async function markOrderPaid(orderId, btn) {
            if (confirm('Tandai pesanan ini sebagai sudah dibayar?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('orders').doc(orderId).update({
                        status: 'diproses',
                        waktuPembayaran: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Pesanan berhasil ditandai sebagai sudah dibayar!', 'success');
                } catch (e) {
                    showToast('Gagal menandai pesanan: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function markOrderCompleted(orderId, btn) {
            if (confirm('Tandai pesanan ini sebagai selesai?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('orders').doc(orderId).update({
                        status: 'selesai',
                        waktuSelesai: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Pesanan berhasil ditandai sebagai selesai!', 'success');
                } catch (e) {
                    showToast('Gagal menandai pesanan: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function cancelOrder(orderId, btn) {
            if (confirm('Batalkan pesanan ini?')) {
                const reason = prompt("Alasan pembatalan (opsional):");
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('orders').doc(orderId).update({
                        status: 'dibatalkan',
                        alasanPembatalan: reason || null,
                        waktuDibatalkan: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Pesanan berhasil dibatalkan.', 'warning');
                } catch (e) {
                    showToast('Gagal membatalkan pesanan: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== TESTIMONI (Firestore) ===================================
        const testimonialForm = document.getElementById('testimonial-form');
        const testimonialsTableBody = document.querySelector('#testimonials-table-body');
        const cancelTestimonialEditBtn = document.getElementById('cancel-testimonial-edit-btn');
        let currentTestimonialId = null;

        function loadTestimonials() {
            dbFS.collection('testimonials').orderBy('createdAt', 'desc').onSnapshot(s => { // Menggunakan onSnapshot
                testimonialsTableBody.innerHTML = '';
                if (s.empty) {
                    testimonialsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada testimoni.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const t = { id: d.id, ...d.data() };
                    const row = testimonialsTableBody.insertRow();
                    const statusClass = `status-${(t.status || 'pending').toLowerCase().replace(/ /g, '-')}`;
                    row.innerHTML = `
                        <td>${t.nama}</td>
                        <td>${t.pesan}</td>
                        <td><span class="status-badge ${statusClass}">${t.status || 'Pending'}</span></td>
                        <td>
                            ${t.status === 'pending' || t.status === 'ditolak' ? // Bisa disetujui ulang jika ditolak
                                `<button class="btn btn-success btn-sm" onclick="approveTestimonial('${t.id}', this)">Setujui</button>`
                                : ''
                            }
                            ${t.status === 'pending' || t.status === 'disetujui' ? // Bisa ditolak jika pending/disetujui
                                `<button class="btn btn-danger btn-sm ${t.status === 'disetujui' ? 'ms-1' : ''}" onclick="rejectTestimonial('${t.id}', this)">Tolak</button>`
                                : ''
                            }
                            <button class="btn btn-warning btn-sm ${t.status !== 'pending' ? 'ms-1' : ''}" onclick="editTestimonial('${t.id}')">Edit</button>
                            <button class="btn btn-outline-danger btn-sm ms-1" onclick="deleteTestimonial('${t.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                testimonialsTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Gagal memuat testimoni: ${e.message}</td></tr>`;
            });
        }

        testimonialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const testimonialData = {
                nama: document.getElementById('testimonial-nama').value,
                pesan: document.getElementById('testimonial-isi').value,
                status: 'pending', // Default status for new testimonials
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentTestimonialId) {
                    await dbFS.collection('testimonials').doc(currentTestimonialId).update(testimonialData);
                    showToast('Testimoni berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('testimonials').add(testimonialData);
                    showToast('Testimoni berhasil ditambahkan!', 'success');
                }
                testimonialForm.reset();
                cancelTestimonialEditBtn.style.display = 'none';
                currentTestimonialId = null;
                // loadTestimonials() otomatis ter-refresh
            } catch (err) {
                showToast('Gagal menyimpan testimoni: ' + err.message, 'danger');
            } finally {
                setButtonLoading(btn, false);
            }
        });

        cancelTestimonialEditBtn.addEventListener('click', () => {
            testimonialForm.reset();
            cancelTestimonialEditBtn.style.display = 'none';
            currentTestimonialId = null;
        });

        async function editTestimonial(id) {
            const doc = await dbFS.collection('testimonials').doc(id).get();
            if (doc.exists) {
                const testimonial = doc.data();
                currentTestimonialId = id;
                document.getElementById('testimonial-nama').value = testimonial.nama;
                document.getElementById('testimonial-isi').value = testimonial.pesan;
                cancelTestimonialEditBtn.style.display = 'block';
                testimonialForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function approveTestimonial(id, btn) {
            if (confirm('Setujui testimoni ini agar ditampilkan di halaman publik?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('testimonials').doc(id).update({
                        status: 'disetujui',
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rejectedReason: null, // Clear rejection reason if approved
                        rejectedAt: null
                    });
                    showToast('Testimoni disetujui!', 'success');
                } catch (e) {
                    showToast('Gagal menyetujui testimoni: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function rejectTestimonial(id, btn) {
            if (confirm('Tolak testimoni ini?')) {
                const reason = prompt("Alasan penolakan (opsional):");
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('testimonials').doc(id).update({
                        status: 'ditolak',
                        rejectedReason: reason || null,
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approvedAt: null // Clear approval timestamp if rejected
                    });
                    showToast('Testimoni ditolak.', 'warning');
                } catch (e) {
                    showToast('Gagal menolak testimoni: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function deleteTestimonial(id, btn) {
            if (confirm('Anda yakin ingin menghapus testimoni ini secara permanen?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('testimonials').doc(id).delete();
                    showToast('Testimoni berhasil dihapus!', 'warning');
                } catch (e) {
                    showToast('Gagal menghapus testimoni: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== FAQ (Firestore) ===================================
        const faqForm = document.getElementById('faq-form');
        const faqTableBody = document.querySelector('#faq-table-body');
        let currentFaqId = null;

        function loadFaq() {
            dbFS.collection('faq').orderBy('order', 'asc').onSnapshot(s => { // Menggunakan onSnapshot
                faqTableBody.innerHTML = '';
                if (s.empty) {
                    faqTableBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada FAQ.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const f = { id: d.id, ...d.data() };
                    const r = faqTableBody.insertRow();
                    r.innerHTML = `
                        <td>${f.question}</td>
                        <td>${f.answer}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editFaq('${f.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFaq('${f.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                faqTableBody.innerHTML = `<tr><td colspan="3" class="text-danger">Gagal memuat FAQ: ${e.message}</td></tr>`;
            });
        }

        faqForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const faqData = {
                question: document.getElementById('faq_q').value,
                answer: document.getElementById('faq_a').value,
                order: parseInt(document.getElementById('faq_order')?.value || 0) // Tambahkan input untuk urutan jika ada
            };

            try {
                if (currentFaqId) {
                    await dbFS.collection('faq').doc(currentFaqId).update(faqData);
                    showToast('FAQ berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('faq').add(faqData);
                    showToast('FAQ berhasil ditambahkan!', 'success');
                }
                faqForm.reset();
                currentFaqId = null;
                // loadFaq() otomatis ter-refresh
            } catch (err) {
                showToast('Gagal menyimpan FAQ: ' + err.message, 'danger');
            } finally {
                setButtonLoading(btn, false);
            }
        });

        async function editFaq(id) {
            const doc = await dbFS.collection('faq').doc(id).get();
            if (doc.exists) {
                const faq = doc.data();
                currentFaqId = id;
                document.getElementById('faq_q').value = faq.question;
                document.getElementById('faq_a').value = faq.answer;
                // document.getElementById('faq_order').value = faq.order || 0; // Jika ada input order
                faqForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteFaq(id, btn) {
            if (confirm('Anda yakin ingin menghapus FAQ ini secara permanen?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('faq').doc(id).delete();
                    showToast('FAQ berhasil dihapus!', 'warning');
                    // loadFaq() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menghapus FAQ: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== INFO PEMBAYARAN (Firestore) ===================================
        const paymentForm = document.getElementById('payment-form');
        const paymentsTableBody = document.querySelector('#payments-table-body');
        let currentPaymentId = null;

        function loadPaymentMethods() {
            dbFS.collection('infoPembayaran').onSnapshot(s => { // Menggunakan onSnapshot
                paymentsTableBody.innerHTML = '';
                if (s.empty) {
                    paymentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada info pembayaran.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    const r = paymentsTableBody.insertRow();
                    r.innerHTML = `
                        <td>${p.metode}</td>
                        <td>${p.nomor}</td>
                        <td>${p.atas_nama}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPayment('${p.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayment('${p.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                paymentsTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Gagal memuat info pembayaran: ${e.message}</td></tr>`;
            });
        }

        paymentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const data = {
                metode: document.getElementById('payment_metode').value,
                nomor: document.getElementById('payment_nomor').value,
                atas_nama: document.getElementById('payment_an').value,
            };

            const promise = currentPaymentId
                ? dbFS.collection('infoPembayaran').doc(currentPaymentId).update(data)
                : dbFS.collection('infoPembayaran').add(data);

            promise.then(() => {
                showToast('Info pembayaran berhasil disimpan!', 'success');
                paymentForm.reset();
                currentPaymentId = null;
                // loadPaymentMethods() otomatis ter-refresh
            }).catch(err => {
                showToast('Gagal menyimpan info pembayaran: ' + err.message, 'danger');
            }).finally(() => {
                setButtonLoading(btn, false);
            });
        });

        function editPayment(id) {
            dbFS.collection('infoPembayaran').doc(id).get()
                .then(d => {
                    if (d.exists) {
                        const p = d.data();
                        document.getElementById('payment_metode').value = p.metode;
                        document.getElementById('payment_nomor').value = p.nomor;
                        document.getElementById('payment_an').value = p.atas_nama;
                        currentPaymentId = id;
                        paymentForm.scrollIntoView({ behavior: 'smooth' });
                    }
                });
        }

        async function deletePayment(id, btn) {
            if (confirm('Anda yakin ingin menghapus info pembayaran ini secara permanen?')) {
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('infoPembayaran').doc(id).delete();
                    showToast('Info pembayaran berhasil dihapus!', 'warning');
                    // loadPaymentMethods() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menghapus info pembayaran: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== KLAIM HADIAH BUYER (Firestore) ===================================
        const giftClaimsTableBody = document.querySelector('#gift-claims-table-body'); // Pastikan ini menunjuk ke tbody yang benar

        function loadGiftClaims() {
            dbFS.collection('klaimHadiahBuyer').orderBy('waktuKlaim', 'desc').onSnapshot(s => {
                giftClaimsTableBody.innerHTML = '';
                if (s.empty) {
                    giftClaimsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada klaim hadiah dari pembeli.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const claim = { id: d.id, ...d.data() };
                    // Pastikan waktuKlaim adalah objek Timestamp sebelum memanggil .toDate()
                    const waktuKlaim = claim.waktuKlaim && typeof claim.waktuKlaim.toDate === 'function' ? new Date(claim.waktuKlaim.toDate()).toLocaleString() : 'N/A';
                    const statusClass = `status-${(claim.status || '').toLowerCase().replace(/ /g, '-')}`;

                    row = giftClaimsTableBody.insertRow(); // Menggunakan insertRow
                    row.innerHTML = `
                        <td>${claim.email || claim.userId || 'N/A'}</td>
                        <td>${waktuKlaim}</td>
                        <td><span class="status-badge ${statusClass}">${claim.status || 'N/A'}</span></td>
                        <td>
                            ${claim.buktiUrl ? `<a href="${claim.buktiUrl}" target="_blank" class="btn btn-sm btn-info">Lihat Bukti</a>` : 'Belum Unggah'}
                        </td>
                        <td>
                            ${(claim.status === 'menunggu-verifikasi' || claim.status === 'pending') ? // Tambahkan 'pending' jika ada status ini
                                `<button class="btn btn-success btn-sm" onclick="approveGiftClaim('${claim.id}', this)">Setujui</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectGiftClaim('${claim.id}', this)">Tolak</button>`
                                : ''
                            }
                            <button class="btn btn-outline-danger btn-sm ms-1" onclick="deleteGiftClaim('${claim.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                giftClaimsTableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Gagal memuat klaim hadiah: ${e.message}</td></tr>`;
            });
        }

        async function approveGiftClaim(id, btn) {
            if (confirm('Setujui klaim hadiah ini? Ini akan memberikan hak diskon otomatis kepada pembeli.')) {
                setButtonLoading(btn, true);
                try {
                    // Ambil detail klaim untuk mendapatkan email pembeli
                    const claimDoc = await dbFS.collection('klaimHadiahBuyer').doc(id).get();
                    if (!claimDoc.exists) {
                        throw new Error('Klaim tidak ditemukan.');
                    }
                    const claimData = claimDoc.data();
                    const buyerEmail = claimData.email || claimData.userId; // Ambil email atau userId pembeli

                    // 1. Update status klaim hadiah
                    await dbFS.collection('klaimHadiahBuyer').doc(id).update({
                        status: 'disetujui',
                        waktuDisetujui: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 2. Berikan hak diskon otomatis kepada pembeli
                    // Gunakan logika yang sama dengan `grant-buyer-promo-form`
                    await dbFS.collection('hakDiskonOtomatis').doc(buyerEmail).set({
                        email: buyerEmail,
                        diberikanPada: firebase.firestore.FieldValue.serverTimestamp(), // Timestamp pemberian hak diskon
                        isUsed: false // Set status awal belum digunakan
                    }, { merge: true }); // Penting: Gunakan merge true agar tidak menimpa data lain jika dokumen sudah ada

                    showToast(`Klaim hadiah disetujui dan hak diskon diberikan kepada ${buyerEmail}!`, 'success');
                    // loadGiftClaims() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menyetujui klaim: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function rejectGiftClaim(id, btn) {
            if (confirm('Tolak klaim hadiah ini?')) {
                const reason = prompt("Alasan penolakan (opsional):");
                setButtonLoading(btn, true);
                try {
                    await dbFS.collection('klaimHadiahBuyer').doc(id).update({
                        status: 'ditolak',
                        alasanDitolak: reason || null,
                        waktuDitolak: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Klaim hadiah ditolak.', 'warning');
                    // loadGiftClaims() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menolak klaim: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        async function deleteGiftClaim(id, btn) {
            if (confirm('Hapus klaim hadiah ini secara permanen?')) {
                setButtonLoading(btn, true);
                try {
                    // Optional: Delete the proof from storage if it exists
                    const claimDoc = await dbFS.collection('klaimHadiahBuyer').doc(id).get();
                    if (claimDoc.exists && claimDoc.data().buktiUrl) {
                        try {
                            const storageRef = storage.refFromURL(claimDoc.data().buktiUrl);
                            await storageRef.delete();
                            console.log("Bukti dihapus dari Storage.");
                        } catch (storageError) {
                            console.warn("Gagal menghapus bukti dari Storage (mungkin sudah tidak ada atau bukan dari Storage):", storageError.message);
                        }
                    }
                    await dbFS.collection('klaimHadiahBuyer').doc(id).delete();
                    showToast('Klaim hadiah dihapus.', 'warning');
                    // loadGiftClaims() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menghapus klaim: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== BANNER (Firestore) ===================================
        const bannerForm = document.getElementById('banner-form');
        const bannersTableBody = document.querySelector('#banners-table-body');
        const cancelBannerEditBtn = document.getElementById('cancel-banner-edit-btn');
        let currentBannerId = null;

        function loadBanners() {
            dbFS.collection('banners').orderBy('urutan').onSnapshot(s => { // Menggunakan onSnapshot
                bannersTableBody.innerHTML = '';
                if (s.empty) {
                    bannersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada banner.</td></tr>';
                    return;
                }
                s.forEach(d => {
                    const b = { id: d.id, ...d.data() };
                    const r = bannersTableBody.insertRow();
                    r.innerHTML = `
                        <td>${b.urutan}</td>
                        <td><a href="${b.url}" target="_blank">Lihat Gambar</a></td>
                        <td>${b.link || '-'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editBanner('${b.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBanner('${b.id}', this)">Hapus</button>
                        </td>
                    `;
                });
            }, e => {
                bannersTableBody.innerHTML = `<tr><td colspan="4" class="text-danger">Gagal memuat banner: ${e.message}</td></tr>`;
            });
        }

        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const data = {
                url: document.getElementById('banner_url').value,
                link: document.getElementById('banner_link').value,
                urutan: parseInt(document.getElementById('banner_urutan').value) || 0,
            };

            try {
                if (currentBannerId) {
                    await dbFS.collection('banners').doc(currentBannerId).update(data);
                    showToast('Banner berhasil diperbarui!', 'success');
                } else {
                    await dbFS.collection('banners').add(data);
                    showToast('Banner berhasil ditambahkan!', 'success');
                }
                bannerForm.reset();
                cancelBannerEditBtn.style.display = 'none';
                currentBannerId = null;
                // loadBanners() otomatis ter-refresh
            } catch (err) {
                showToast('Gagal menyimpan banner: ' + err.message, 'danger');
            } finally {
                setButtonLoading(btn, false);
            }
        });

        cancelBannerEditBtn.addEventListener('click', () => {
            bannerForm.reset();
            cancelBannerEditBtn.style.display = 'none';
            currentBannerId = null;
        });

        async function editBanner(id) {
            const doc = await dbFS.collection('banners').doc(id).get();
            if (doc.exists) {
                const b = doc.data();
                currentBannerId = id;
                document.getElementById('banner_url').value = b.url;
                document.getElementById('banner_link').value = b.link || '';
                document.getElementById('banner_urutan').value = b.urutan || 0;
                cancelBannerEditBtn.style.display = 'block';
                bannerForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function deleteBanner(id, btn) {
            if (confirm('Anda yakin ingin menghapus banner ini secara permanen?')) {
                setButtonLoading(btn, true);
                try {
                    // Opsional: Hapus gambar dari Storage jika URL-nya menunjuk ke Firebase Storage
                    // const bannerDoc = await dbFS.collection('banners').doc(id).get();
                    // if (bannerDoc.exists && bannerDoc.data().url) {
                    //     // Cek apakah URL adalah URL Storage Firebase
                    //     if (bannerDoc.data().url.startsWith('gs://') || bannerDoc.data().url.includes('firebasestorage.googleapis.com')) {
                    //         try {
                    //             const storageRef = storage.refFromURL(bannerDoc.data().url);
                    //             await storageRef.delete();
                    //             console.log("Gambar banner dihapus dari Storage.");
                    //         } catch (storageError) {
                    //             console.warn("Gagal menghapus gambar banner dari Storage (mungkin bukan dari Storage atau sudah tidak ada):", storageError.message);
                    //         }
                    //     }
                    // }

                    await dbFS.collection('banners').doc(id).delete();
                    showToast('Banner berhasil dihapus!', 'warning');
                    // loadBanners() otomatis ter-refresh
                } catch (e) {
                    showToast('Gagal menghapus banner: ' + e.message, 'danger');
                } finally {
                    setButtonLoading(btn, false);
                }
            }
        }

        // =================================== KODE KUSTOM v2 (Manajemen Fitur) ===================================
        const addFeatureForm = document.getElementById('add-feature-form');
        const customFeaturesListContainer = document.getElementById('custom-features-list');

        function renderCustomFeatures(features) {
            customFeaturesListContainer.innerHTML = '';
            if (!features || Object.keys(features).length === 0) {
                customFeaturesListContainer.innerHTML = '<p class="text-muted">Belum ada fitur kustom yang ditambahkan.</p>';
                return;
            }
            Object.keys(features).forEach(featureId => {
                const feature = features[featureId];
                const featureCard = document.createElement('div');
                featureCard.className = 'd-flex justify-content-between align-items-center p-3 mb-2 border rounded';
                featureCard.innerHTML = `
                    <div>
                        <strong style="color: var(--primary);">${feature.name}</strong>
                        <small class="d-block text-muted">HTML: ${feature.htmlCode ? '✓' : '✗'} | CSS: ${feature.cssCode ? '✓' : '✗'} | JS: ${feature.jsCode ? '✓' : '✗'}</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteCustomFeature('${featureId}')">Hapus</button>
                `;
                customFeaturesListContainer.appendChild(featureCard);
            });
        }

        function loadCustomFeatures() {
            dbRT.ref('customFeatures').on('value', snapshot => {
                renderCustomFeatures(snapshot.val());
            }, error => {
                console.error("Gagal memuat fitur kustom:", error);
                customFeaturesListContainer.innerHTML = '<p class="text-danger">Gagal memuat data fitur kustom.</p>';
            });
        }

        addFeatureForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('[type=submit]');
            setButtonLoading(btn, true);

            const featureName = document.getElementById('feature-name').value;
            const newFeatureData = {
                name: featureName,
                htmlCode: document.getElementById('feature-html').value,
                cssCode: document.getElementById('feature-css').value,
                jsCode: document.getElementById('feature-js').value,
                createdAt: firebase.database.ServerValue.TIMESTAMP // Tambahkan timestamp untuk Realtime DB
            };
            dbRT.ref('customFeatures').push(newFeatureData)
                .then(() => {
                    showToast(`Fitur "${featureName}" berhasil ditambahkan!`, 'success');
                    addFeatureForm.reset();
                })
                .catch(error => {
                    showToast('Gagal menambahkan fitur: ' + error.message, 'danger');
                })
                .finally(() => {
                    setButtonLoading(btn, false);
                });
        });

        window.deleteCustomFeature = async function(featureId) { // Menggunakan async
            if (confirm('Yakin ingin menghapus fitur ini secara permanen?')) {
                // Tidak perlu tombol loading di sini karena fungsi dipanggil global
                try {
                    await dbRT.ref('customFeatures/' + featureId).remove();
                    showToast('Fitur berhasil dihapus.', 'warning');
                } catch (error) {
                    showToast('Gagal menghapus fitur: ' + error.message, 'danger');
                }
            }
        }
    </script>
</body>
    </html>
