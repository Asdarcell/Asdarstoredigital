<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Asdar Store Digital</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 20px;
      background: #f9f9f9;
      color: #2c3e50;
    }
    h1 {
      margin-bottom: 20px;
    }
    section {
      background: #fff;
      padding: 15px 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ddd;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      margin-top: 12px;
      background: #3498db;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      padding: 8px 10px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #3498db;
      color: white;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-edit {
      background: #1abc9c;
      color: white;
      border: none;
    }
    .btn-delete {
      background: #e74c3c;
      color: white;
      border: none;
    }
    .btn-save {
      background: #27ae60;
      color: white;
      border: none;
      margin-top: 6px;
    }
    .status-select {
      width: 100%;
      padding: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard - Asdar Store Digital</h1>

  <!-- Kategori dan Produk -->
  <section>
    <h2>Kelola Kategori & Produk</h2>

    <div style="display:flex; gap:20px; flex-wrap: wrap;">
      <div style="flex:1; min-width: 250px;">
        <h3>Tambah Kategori Baru</h3>
        <input type="text" id="inputKategoriBaru" placeholder="Nama kategori baru" />
        <button id="btnTambahKategori">Tambah Kategori</button>
      </div>

      <div style="flex:2; min-width: 300px;">
        <h3>Daftar Kategori</h3>
        <table id="tableKategori">
          <thead>
            <tr><th>Nama Kategori</th><th>Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <hr style="margin: 20px 0;" />

    <div style="display:flex; gap:20px; flex-wrap: wrap;">
      <div style="flex:1; min-width: 250px;">
        <h3>Tambah Produk Baru</h3>
        <select id="selectKategoriProduk">
          <option value="">Pilih kategori</option>
        </select>
        <input type="text" id="inputNamaProduk" placeholder="Nama produk" />
        <input type="number" id="inputHargaProduk" placeholder="Harga (Rp)" />
        <textarea id="inputDeskripsiProduk" rows="3" placeholder="Deskripsi / Cara beli"></textarea>
        <button id="btnTambahProduk">Tambah Produk</button>
      </div>

      <div style="flex:3; min-width: 350px;">
        <h3>Daftar Produk</h3>
        <table id="tableProduk">
          <thead>
            <tr>
              <th>Kategori</th><th>Nama Produk</th><th>Harga</th><th>Deskripsi</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Pesanan -->
  <section>
    <h2>Daftar Pesanan</h2>
    <table id="tablePesanan">
      <thead>
        <tr>
          <th>ID Pesanan</th><th>Nama</th><th>Nomor HP/ID SN</th><th>Kategori</th><th>Produk</th><th>Harga</th><th>Waktu</th><th>Status</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Kategori =====
    const inputKategoriBaru = document.getElementById('inputKategoriBaru');
    const btnTambahKategori = document.getElementById('btnTambahKategori');
    const tableKategoriBody = document.querySelector('#tableKategori tbody');
    const selectKategoriProduk = document.getElementById('selectKategoriProduk');

    function refreshKategoriUI(kategoriData) {
      // Clear tabel kategori
      tableKategoriBody.innerHTML = '';
      selectKategoriProduk.innerHTML = '<option value="">Pilih kategori</option>';

      for (const kategori in kategoriData) {
        // Tabel
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td contenteditable="true" data-kategori="${kategori}">${kategori}</td>
          <td>
            <button class="btn-save btn-small" data-kategori="${kategori}">Simpan</button>
            <button class="btn-delete btn-small" data-kategori="${kategori}">Hapus</button>
          </td>
        `;
        tableKategoriBody.appendChild(tr);

        // Dropdown kategori produk
        const option = document.createElement('option');
        option.value = kategori;
        option.textContent = kategori;
        selectKategoriProduk.appendChild(option);
      }
    }

    btnTambahKategori.addEventListener('click', () => {
      const namaBaru = inputKategoriBaru.value.trim();
      if (!namaBaru) return alert('Nama kategori tidak boleh kosong.');
      // Cek apakah kategori sudah ada
      db.ref('produk/' + namaBaru).get().then(snapshot => {
        if (snapshot.exists()) return alert('Kategori sudah ada.');
        // Tambah kategori dengan data kosong (produk kosong)
        db.ref('produk/' + namaBaru).set({}).then(() => {
          inputKategoriBaru.value = '';
          alert('Kategori berhasil ditambahkan.');
        });
      });
    });

    // Handle simpan edit kategori (ganti nama kategori)
    tableKategoriBody.addEventListener('click', e => {
      if (!e.target.classList.contains('btn-save') && !e.target.classList.contains('btn-delete')) return;
      const kategoriLama = e.target.dataset.kategori;
      if (e.target.classList.contains('btn-save')) {
        // Simpan perubahan nama kategori
        const td = e.target.closest('tr').querySelector('td[contenteditable]');
        const kategoriBaru = td.textContent.trim();
        if (!kategoriBaru) return alert('Nama kategori tidak boleh kosong.');
        if (kategoriBaru === kategoriLama) return alert('Tidak ada perubahan nama.');
        // Check if new kategori exists
        db.ref('produk/' + kategoriBaru).get().then(snap => {
          if (snap.exists()) return alert('Kategori baru sudah ada.');
          // Pindahkan data produk dari kategori lama ke baru
          db.ref('produk/' + kategoriLama).once('value').then(dataSnap => {
            const produkData = dataSnap.val() || {};
            // Set data ke kategori baru
            db.ref('produk/' + kategoriBaru).set(produkData).then(() => {
              // Hapus kategori lama
              db.ref('produk/' + kategoriLama).remove().then(() => {
                alert('Kategori berhasil diubah.');
              });
            });
          });
        });
      } else if (e.target.classList.contains('btn-delete')) {
        // Hapus kategori beserta produk di dalamnya
        if (!confirm(`Yakin hapus kategori "${kategoriLama}" beserta semua produk di dalamnya?`)) return;
        db.ref('produk/' + kategoriLama).remove().then(() => {
          alert('Kategori berhasil dihapus.');
        });
      }
    });

    // ===== Produk =====
    const inputNamaProduk = document.getElementById('inputNamaProduk');
    const inputHargaProduk = document.getElementById('inputHargaProduk');
    const inputDeskripsiProduk = document.getElementById('inputDeskripsiProduk');
    const btnTambahProduk = document.getElementById('btnTambahProduk');
    const tableProdukBody = document.querySelector('#tableProduk tbody');

    function refreshProdukUI(kategoriData) {
      tableProdukBody.innerHTML = '';
      for (const kategori in kategoriData) {
        const produkList = kategoriData[kategori] || {};
        for (const produk in produkList) {
          const p = produkList[produk];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${kategori}</td>
            <td contenteditable="true" data-kategori="${kategori}" data-produk="${produk}" data-field="nama">${produk}</td>
            <td contenteditable="true" data-kategori="${kategori}" data-produk="${produk}" data-field="harga">${p.harga || 0}</td>
            <td contenteditable="true" data-kategori="${kategori}" data-produk="${produk}" data-field="deskripsi">${p.deskripsi || ''}</td>
            <td>
              <button class="btn-save btn-small" data-kategori="${kategori}" data-produk="${produk}">Simpan</button>
              <button class="btn-delete btn-small" data-kategori="${kategori}" data-produk="${produk}">Hapus</button>
            </td>
          `;
          tableProdukBody.appendChild(tr);
        }
      }
    }

    btnTambahProduk.addEventListener('click', () => {
      const kategori = selectKategoriProduk.value;
      const namaProduk = inputNamaProduk.value.trim();
      const hargaProduk = parseInt(inputHargaProduk.value);
      const deskripsiProduk = inputDeskripsiProduk.value.trim();
      if (!kategori) return alert('Pilih kategori produk.');
      if (!namaProduk) return alert('Nama produk tidak boleh kosong.');
      if (isNaN(hargaProduk) || hargaProduk < 0) return alert('Harga produk tidak valid.');
      // Cek produk sudah ada?
      db.ref(`produk/${kategori}/${namaProduk}`).get().then(snap => {
        if (snap.exists()) return alert('Produk sudah ada di kategori ini.');
        // Simpan produk baru
        db.ref(`produk/${kategori}/${namaProduk}`).set({ harga: hargaProduk, deskripsi: deskripsiProduk }).then(() => {
          alert('Produk berhasil ditambahkan.');
          inputNamaProduk.value = '';
          inputHargaProduk.value = '';
          inputDeskripsiProduk.value = '';
        });
      });
    });

    // Handle simpan edit produk dan hapus produk
    tableProdukBody.addEventListener('click', e => {
      if (!e.target.classList.contains('btn-save') && !e.target.classList.contains('btn-delete')) return;
      const kategori = e.target.dataset.kategori;
      const produk = e.target.dataset.produk;
      if (e.target.classList.contains('btn-save')) {
        // Ambil data dari kolom yang contenteditable
        const tr = e.target.closest('tr');
        const namaBaru = tr.querySelector('td[data-field="nama"]').textContent.trim();
        const hargaBaru = parseInt(tr.querySelector('td[data-field="harga"]').textContent.trim());
        const deskripsiBaru = tr.querySelector('td[data-field="deskripsi"]').textContent.trim();
        if (!namaBaru) return alert('Nama produk tidak boleh kosong.');
        if (isNaN(hargaBaru) || hargaBaru < 0) return alert('Harga produk tidak valid.');

        if (namaBaru !== produk) {
          // Nama produk berubah, pindahkan data
          db.ref(`produk/${kategori}/${namaBaru}`).get().then(snap => {
            if (snap.exists()) return alert('Nama produk baru sudah ada.');
            // Simpan data baru
            db.ref(`produk/${kategori}/${namaBaru}`).set({ harga: hargaBaru, deskripsi: deskripsiBaru }).then(() => {
              // Hapus data lama
              db.ref(`produk/${kategori}/${produk}`).remove().then(() => {
                alert('Produk berhasil diperbarui.');
              });
            });
          });
        } else {
          // Nama produk tidak berubah, update langsung
          db.ref(`produk/${kategori}/${produk}`).update({ harga: hargaBaru, deskripsi: deskripsiBaru }).then(() => {
            alert('Produk berhasil diperbarui.');
          });
        }
      } else if (e.target.classList.contains('btn-delete')) {
        if (!confirm(`Yakin hapus produk "${produk}" dari kategori "${kategori}"?`)) return;
        db.ref(`produk/${kategori}/${produk}`).remove().then(() => {
          alert('Produk berhasil dihapus.');
        });
      }
    });

    // ===== Pesanan =====
    const tablePesananBody = document.querySelector('#tablePesanan tbody');

    function refreshPesananUI(pesananData) {
      tablePesananBody.innerHTML = '';
      for (const id in pesananData) {
        const p = pesananData[id];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${id}</td>
          <td>${p.nama}</td>
          <td>${p.nomor}</td>
          <td>${p.kategori}</td>
          <td>${p.produk}</td>
          <td>Rp${(p.harga || 0).toLocaleString()}</td>
          <td>${new Date(p.waktu).toLocaleString()}</td>
          <td>
            <select class="status-select" data-id="${id}">
              <option value="Belum Bayar" ${p.status === 'Belum Bayar' ? 'selected' : ''}>Belum Bayar</option>
              <option value="Sudah Bayar" ${p.status === 'Sudah Bayar' ? 'selected' : ''}>Sudah Bayar</option>
              <option value="Selesai" ${p.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
              <option value="Batal" ${p.status === 'Batal' ? 'selected' : ''}>Batal</option>
            </select>
          </td>
          <td><button class="btn-delete btn-small" data-id="${id}">Hapus</button></td>
        `;
        tablePesananBody.appendChild(tr);
      }
    }

    // Listen perubahan data realtime
    db.ref('produk').on('value', snapshot => {
      refreshKategoriUI(snapshot.val() || {});
      refreshProdukUI(snapshot.val() || {});
    });
    db.ref('pesanan').on('value', snapshot => {
      refreshPesananUI(snapshot.val() || {});
    });

    // Handle update status pesanan
    tablePesananBody.addEventListener('change', e => {
      if (!e.target.classList.contains('status-select')) return;
      const id = e.target.dataset.id;
      const statusBaru = e.target.value;
      db.ref('pesanan/' + id).update({ status: statusBaru });
    });

    // Handle hapus pesanan
    tablePesananBody.addEventListener('click', e => {
      if (!e.target.classList.contains('btn-delete')) return;
      const id = e.target.dataset.id;
      if (!confirm(`Yakin hapus pesanan dengan ID ${id}?`)) return;
      db.ref('pesanan/' + id).remove();
    });
  </script>
</body>
</html>
