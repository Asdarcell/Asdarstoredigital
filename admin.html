<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome untuk ikon (misal: panah accordion, ikon pengguna) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Variabel Tema */
    :root {
        --bg: #f9f9f9;
        --text: #2c3e50;
        --primary: #3498db;
        --card: #ffffff;
        --border: #ddd;
        --primary-rgb: 52, 152, 219; /* RGB for primary color */
    }
    [data-theme="dark"] {
        --bg: #1a1a2e;
        --text: #e0e0e0;
        --primary: #1abc9c;
        --card: #2c2c40;
        --border: #444;
        --primary-rgb: 26, 188, 156; /* RGB for dark primary color */
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: var(--bg);
        color: var(--text);
        transition: all 0.3s ease;
        padding: 20px;
    }
    h1 {
        @apply text-3xl font-bold mb-6 text-blue-600;
    }
    [data-theme="dark"] h1 {
        @apply text-teal-400;
    }
    h3, h4 {
        @apply text-xl font-semibold mt-8 mb-4;
        color: var(--primary);
    }
    .card {
        @apply bg-white p-4 rounded-lg shadow-md mb-4;
        border: 1px solid var(--border);
    }
    [data-theme="dark"] .card {
        @apply bg-gray-800;
    }
    img {
        @apply max-w-[100px] mt-2 rounded-md border border-gray-300;
    }
    [data-theme="dark"] img {
        @apply border-gray-600;
    }
    #galeri img {
        @apply max-w-[120px] m-1 rounded-md cursor-pointer transition-transform duration-200;
    }
    #galeri img:hover {
        @apply scale-105;
    }
    textarea {
        font-family: 'Consolas', 'Monaco', monospace;
        resize: vertical;
        @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300;
    }
    [data-theme="dark"] textarea {
        @apply bg-gray-700 border-gray-600 text-gray-100;
    }
    .btn {
        @apply px-4 py-2 rounded-lg font-semibold transition-all duration-300;
    }
    .btn-primary {
        @apply bg-blue-600 text-white hover:bg-blue-700;
    }
    .btn-danger {
        @apply bg-red-600 text-white hover:bg-red-700;
    }
    .btn-warning {
        @apply bg-yellow-500 text-gray-900 hover:bg-yellow-600;
    }
    .btn-success {
        @apply bg-green-600 text-white hover:bg-green-700;
    }
    .btn-info {
        @apply bg-blue-400 text-white hover:bg-blue-500;
    }
    .btn-dark {
        @apply bg-gray-700 text-white hover:bg-gray-800;
    }
    .form-control, .form-select {
        @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300;
    }
    [data-theme="dark"] .form-control, [data-theme="dark"] .form-select {
        @apply bg-gray-700 border-gray-600 text-gray-100;
    }
    hr {
        @apply my-10 border-t-2 border-gray-200;
    }
    [data-theme="dark"] hr {
        @apply border-gray-700;
    }

    /* Collapsible Section Styles */
    .collapsible-header {
        @apply flex justify-between items-center p-4 cursor-pointer font-semibold text-lg bg-gray-100 rounded-lg shadow-sm mb-2;
        border: 1px solid var(--border);
        color: var(--text);
    }
    [data-theme="dark"] .collapsible-header {
        @apply bg-gray-700;
    }
    .collapsible-header:hover {
        @apply bg-gray-200;
    }
    [data-theme="dark"] .collapsible-header:hover {
        @apply bg-gray-600;
    }
    .collapsible-content {
        @apply p-4 bg-white rounded-lg shadow-md mb-4 hidden;
        border: 1px solid var(--border);
    }
    [data-theme="dark"] .collapsible-content {
        @apply bg-gray-800;
    }
    .collapsible-header .fa-chevron-down {
        transition: transform 0.3s ease;
    }
    .collapsible-header.active .fa-chevron-down {
        transform: rotate(180deg);
    }

    /* Dynamic Content Editor Styles */
    .dynamic-block-item {
        @apply bg-gray-50 p-3 rounded-md mb-2 flex justify-between items-center;
        border: 1px solid var(--border);
    }
    [data-theme="dark"] .dynamic-block-item {
        @apply bg-gray-700;
    }
    .dynamic-block-item .block-actions button {
        @apply text-sm px-2 py-1;
    }
    .block-editor-area {
        @apply bg-white p-4 rounded-lg shadow-md mb-4;
        border: 1px solid var(--border);
    }
    [data-theme="dark"] .block-editor-area {
        @apply bg-gray-800;
    }

    /* Custom Modal Styling */
    .custom-modal {
        @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] hidden;
    }
    .custom-modal-content {
        @apply bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center;
    }
    [data-theme="dark"] .custom-modal-content {
        @apply bg-gray-800 text-gray-200;
    }
    .custom-modal-content button {
        @apply bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mt-4;
        width: auto;
    }
  </style>
</head>
<body data-theme="light">
<div class="container mx-auto p-4">
  <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-blue-600">Dashboard Admin</h1>
      <div class="flex items-center space-x-4">
          <span id="user-info" class="text-sm">Memuat...</span>
          <button class="theme-btn" onclick="toggleTheme()" id="themeToggle">üåô</button>
          <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors duration-300">Logout</button>
      </div>
  </header>

  <!-- Section: Dynamic Content Management -->
  <div class="collapsible-section">
    <div class="collapsible-header">
      <span>‚öôÔ∏è Manajemen Konten Dinamis</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="collapsible-content">
      <div class="mb-3">
        <label for="halamanDinamis" class="block text-sm font-medium mb-1"><b>Pilih Halaman untuk Edit Konten Dinamis:</b></label>
        <select id="halamanDinamis" class="form-select w-auto">
          <option value="index">index.html</option>
          <option value="admin">admin.html</option>
          <option value="status">status.html</option>
          <option value="upload">upload.html</option>
        </select>
      </div>

      <h4 class="text-lg font-semibold mt-4 mb-2">Daftar Blok Konten</h4>
      <div id="dynamic-blocks-list" class="mb-4">
        <p class="text-gray-500">Memuat blok konten...</p>
      </div>

      <button id="addNewBlockBtn" class="btn btn-success mb-4">‚ûï Tambah Blok Baru</button>

      <div id="block-editor-area" class="block-editor-area hidden">
        <h4 class="text-lg font-semibold mb-2" id="editor-title">Edit Blok Konten</h4>
        <input type="hidden" id="currentBlockId">
        <label for="blockOrder" class="block text-sm font-medium mb-1">Urutan (Angka)</label>
        <input type="number" id="blockOrder" class="form-control mb-2" placeholder="Urutan tampilan blok (contoh: 1, 2, 3)" />

        <label for="editorHTML" class="block text-sm font-medium mb-1">HTML</label>
        <textarea id="editorHTML" rows="8" class="form-control mb-2" placeholder="Masukkan kode HTML di sini..."></textarea>

        <label for="editorCSS" class="block text-sm font-medium mb-1">CSS</label>
        <textarea id="editorCSS" rows="6" class="form-control mb-2" placeholder="Masukkan kode CSS di sini..."></textarea>

        <label for="editorJS" class="block text-sm font-medium mb-1">JavaScript</label>
        <textarea id="editorJS" rows="8" class="form-control mb-4" placeholder="Masukkan kode JavaScript di sini..."></textarea>

        <button id="saveBlockBtn" class="btn btn-primary mr-2">üíæ Simpan Blok</button>
        <button id="cancelEditBlockBtn" class="btn btn-warning">‚ùå Batal</button>
      </div>
    </div>
  </div>

  <hr>

  <!-- Section: Order Management -->
  <div class="collapsible-section">
    <div class="collapsible-header">
      <span>üì¶ Manajemen Pesanan</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="collapsible-content">
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-3">
        <div>
          <select id="filterStatus" class="form-select">
            <option value="">Filter Semua Status</option>
            <option value="Belum Bayar">Belum Bayar</option>
            <option value="Sudah Bayar">Sudah Bayar</option>
            <option value="Diproses">Diproses</option>
            <option value="Selesai">Selesai</option>
          </select>
        </div>
        <div>
          <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan..." />
        </div>
        <button class="btn btn-success" id="exportCSVBtn">Export CSV</button>
        <button class="btn btn-warning" id="refreshDataBtn">üîÑ Refresh Data</button>
      </div>

      <div id="pesananList" class="mb-4"></div>

      <h4 class="text-lg font-semibold mt-6 mb-2">Kirim Bukti Admin ke Pembeli</h4>
      <p class="text-gray-600 text-sm mb-3">Pilih pesanan terlebih dahulu, lalu unggah bukti dan kirim notifikasi WhatsApp.</p>
      <div class="flex flex-col md:flex-row gap-2 items-center mb-2">
        <input type="file" id="buktiAdmin" class="form-control flex-grow" accept="image/*" />
        <button id="uploadBuktiBtn" class="btn btn-primary w-full md:w-auto">üì§ Kirim Bukti & Selesaikan</button>
      </div>
      <small id="selectedOrderIdDisplay" class="text-blue-600 mb-3 block"></small>
    </div>
  </div>

  <hr>

  <!-- Section: Product Management -->
  <div class="collapsible-section">
    <div class="collapsible-header">
      <span>üõí Tambah / Edit Produk</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="collapsible-content">
      <form id="formProduk" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
        <div>
          <input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required />
        </div>
        <div>
          <input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required />
        </div>
        <div>
          <input type="text" id="harga" class="form-control" placeholder="Harga (contoh 30000)" required pattern="[0-9]*" title="Hanya angka diperbolehkan" />
        </div>
        <div>
          <input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required />
        </div>
        <div class="col-span-full">
          <button type="submit" class="btn btn-success w-full">‚úÖ Simpan / Edit Produk</button>
        </div>
      </form>

      <h4 class="text-lg font-semibold mt-6 mb-2">Daftar Produk Saat Ini</h4>
      <ul id="daftarProduk" class="list-none p-0 mb-5"></ul>
    </div>
  </div>

  <hr>

  <!-- Section: Gallery of Buyer Proofs -->
  <div class="collapsible-section">
    <div class="collapsible-header">
      <span>üñºÔ∏è Galeri Bukti Transfer Pembeli</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="collapsible-content">
      <p class="text-gray-600 text-sm mb-3">Klik gambar untuk melihat lebih besar.</p>
      <div id="galeri" class="flex flex-wrap justify-start"></div>
      <!-- Image Modal -->
      <div id="imageModal" class="custom-modal">
        <div class="custom-modal-content max-w-2xl">
          <h5 class="text-xl font-bold mb-3" id="imageModalLabel">Detail Gambar</h5>
          <img src="" class="max-w-full h-auto rounded-lg" id="modalImage" alt="Bukti Transfer">
          <p id="modalImageInfo" class="mt-3 text-sm text-gray-600"></p>
          <button id="closeImageModalBtn">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <!-- Section: Mass Data Deletion Options -->
  <div class="collapsible-section">
    <div class="collapsible-header">
      <span>‚ö†Ô∏è Opsi Hapus Data Massal</span>
      <i class="fas fa-chevron-down"></i>
    </div>
    <div class="collapsible-content">
      <p class="text-red-600 font-semibold mb-4">PERHATIAN: Tindakan ini tidak bisa dibatalkan!</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-5">
        <button class="btn btn-danger" onclick="hapusSemuaPesanan()">üßπ Hapus Semua Pesanan</button>
        <button class="btn btn-danger" onclick="hapusSemuaProduk()">üßπ Hapus Semua Produk</button>
        <button class="btn btn-danger" onclick="hapusSemuaGaleri()">üßπ Hapus Semua Bukti Transfer</button>
        <button class="btn btn-dark" onclick="hapusSemuaData()">üî• Hapus SEMUA DATA</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Modal for Alerts -->
<div id="custom-alert-modal" class="custom-modal">
    <div class="custom-modal-content">
        <p id="alert-modal-message" class="text-lg font-medium mb-4"></p>
        <button id="alert-modal-close-btn">OK</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
// --- Theme Toggle ---
function toggleTheme() {
    const body = document.body;
    const btn = document.getElementById('themeToggle');
    const currentTheme = body.getAttribute('data-theme');
    const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
    body.setAttribute('data-theme', nextTheme);
    btn.textContent = nextTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', nextTheme);
}
// Set initial theme on load
if (localStorage.getItem('theme')) {
    document.body.setAttribute('data-theme', localStorage.getItem('theme'));
    document.getElementById('themeToggle').textContent = localStorage.getItem('theme') === 'light' ? 'üåô' : '‚òÄÔ∏è';
} else {
    document.body.setAttribute('data-theme', 'light');
    document.getElementById('themeToggle').textContent = 'üåô';
}

// --- Custom Alert Modal ---
const customAlertModal = document.getElementById('custom-alert-modal');
const alertModalMessage = document.getElementById('alert-modal-message');
const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

function showCustomAlert(message, type = 'info') {
    alertModalMessage.textContent = message;
    // You can add styling based on type (success, danger, info) here if needed
    customAlertModal.classList.remove('hidden');
}

alertModalCloseBtn.addEventListener('click', () => {
    customAlertModal.classList.add('hidden');
});

// --- Firebase Config & Init ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
  authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
  databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
  projectId: "asdarstoredigitalll-d89c4",
  storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
  messagingSenderId: "220670500351",
  appId: "1:220670500351:web:5737ae5958a6f5a67d5bca",
  measurementId: "G-CMRW37J19G" // If you have one
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage(); // Dipertahankan jika nanti ada kebutuhan untuk Firebase Storage

// Konfigurasi API NgirimWA Anda
const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a"; // Ganti dengan appkey NgirimWA Anda
const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq"; // Ganti dengan authkey NgirimWA Anda
const ADMIN_WA_NUMBER = "6281803004607"; // Nomor WA Admin untuk notifikasi internal

// API Key ImgBB (untuk upload bukti admin)
const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc"; // Ganti dengan API key ImgBB Anda

let selectedId = null;
let allDataPesanan = {};
let currentEditingBlock = null; // To store the ID of the block being edited

// DOM Elements
const userInfoSpan = document.getElementById('user-info');
const logoutBtn = document.getElementById('logout-btn');

const halamanSelect = document.getElementById('halamanDinamis');
const dynamicBlocksList = document.getElementById('dynamic-blocks-list');
const addNewBlockBtn = document.getElementById('addNewBlockBtn');
const blockEditorArea = document.getElementById('block-editor-area');
const editorTitle = document.getElementById('editor-title');
const currentBlockIdInput = document.getElementById('currentBlockId');
const blockOrderInput = document.getElementById('blockOrder');
const editorHTML = document.getElementById('editorHTML');
const editorCSS = document.getElementById('editorCSS');
const editorJS = document.getElementById('editorJS');
const saveBlockBtn = document.getElementById('saveBlockBtn');
const cancelEditBlockBtn = document.getElementById('cancelEditBlockBtn');

const filterStatus = document.getElementById('filterStatus');
const searchId = document.getElementById('searchId');
const pesananList = document.getElementById('pesananList');
const buktiAdminInput = document.getElementById('buktiAdmin');
const uploadBuktiBtn = document.getElementById('uploadBuktiBtn');
const selectedOrderIdDisplay = document.getElementById('selectedOrderIdDisplay');
const formProduk = document.getElementById('formProduk');
const daftarProduk = document.getElementById('daftarProduk');
const galeriDiv = document.getElementById('galeri');
const imageModal = document.getElementById('imageModal'); // Get the modal element
const modalImage = document.getElementById('modalImage');
const modalImageInfo = document.getElementById('modalImageInfo');
const closeImageModalBtn = document.getElementById('closeImageModalBtn');


// --- Firebase Auth State Listener & Admin Role Check ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        userInfoSpan.textContent = `Login sebagai: ${user.email}`;
        // Check user role
        const userRef = db.ref('users/' + user.uid);
        userRef.once('value').then(snapshot => {
            const userData = snapshot.val();
            if (userData && userData.role === 'admin') {
                // User is admin, proceed to load dashboard
                showCustomAlert('Selamat datang, Admin!', 'success');
                // Initial data loads
                loadDinamisBlocks();
                tampilkanPesanan();
                tampilkanProduk();
                tampilkanGaleri();
            } else {
                // User is not admin, redirect or show error
                showCustomAlert('Akses ditolak. Anda bukan admin.', 'danger');
                auth.signOut(); // Force logout non-admin
                setTimeout(() => { window.location.replace('./auth.html'); }, 2000);
            }
        }).catch(error => {
            console.error("Error checking user role:", error);
            showCustomAlert('Gagal memverifikasi peran pengguna. Silakan coba lagi.', 'danger');
            auth.signOut();
            setTimeout(() => { window.location.replace('./auth.html'); }, 2000);
        });
    } else {
        // No user logged in, redirect to auth page
        showCustomAlert('Anda harus login sebagai admin untuk mengakses halaman ini.', 'warning');
        setTimeout(() => { window.location.replace('./auth.html'); }, 2000);
    }
});

logoutBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        showCustomAlert('Anda telah logout. Mengarahkan ke halaman login.', 'info');
        setTimeout(() => { window.location.replace('./auth.html'); }, 1500);
    } catch (error) {
        console.error("Logout Error:", error);
        showCustomAlert('Gagal logout. Silakan coba lagi.', 'danger');
    }
});


// --- Helper Functions ---
function formatRupiah(angka) {
  return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function normalizePhoneNumber(number) {
  if (!number) return "";
  number = number.replace(/[^0-9]/g, ''); // Hapus karakter non-angka
  if (number.startsWith("0")) {
    return "62" + number.slice(1);
  }
  return number;
}

// --- Collapsible Sections Init ---
function initCollapsibles() {
    document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling; // The content div is the next sibling
            const icon = header.querySelector('.fa-chevron-down');

            header.classList.toggle('active');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                content.style.maxHeight = content.scrollHeight + 'px'; // For smooth transition if needed
            } else {
                content.style.maxHeight = null;
                content.classList.add('hidden');
            }
        });
    });
}


// ====== Fitur Dinamis ======
async function loadDinamisBlocks() {
  const halaman = halamanSelect.value;
  dynamicBlocksList.innerHTML = '<p class="text-gray-500">Memuat blok konten...</p>';
  try {
    const snapshot = await db.ref(`dinamis/${halaman}`).once('value');
    const blocks = snapshot.val() || {};
    let html = '';
    const sortedBlocks = Object.keys(blocks).map(key => ({ id: key, ...blocks[key] }))
                                    .sort((a, b) => (a.order || 0) - (b.order || 0));

    if (sortedBlocks.length === 0) {
      dynamicBlocksList.innerHTML = '<p class="text-gray-500">Belum ada blok konten untuk halaman ini.</p>';
      return;
    }

    sortedBlocks.forEach(block => {
      html += `
        <div class="dynamic-block-item">
          <span><b>ID:</b> ${block.id} (Order: ${block.order || 0})</span>
          <div class="block-actions">
            <button class="btn btn-info btn-sm mr-1" onclick="editBlock('${halaman}', '${block.id}')">‚úçÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteBlock('${halaman}', '${block.id}')">üóëÔ∏è Hapus</button>
          </div>
        </div>
      `;
    });
    dynamicBlocksList.innerHTML = html;
  } catch (err) {
    showCustomAlert(`Gagal memuat blok dinamis: ${err.message}`, 'danger');
    console.error("Error loading dynamic blocks:", err);
    dynamicBlocksList.innerHTML = '<p class="text-red-500">Gagal memuat blok konten.</p>';
  }
  hideBlockEditor(); // Hide editor after loading blocks
}

addNewBlockBtn.addEventListener('click', () => {
  currentEditingBlock = null; // No block is being edited, it's a new one
  editorTitle.textContent = 'Tambah Blok Konten Baru';
  currentBlockIdInput.value = '';
  blockOrderInput.value = '';
  editorHTML.value = '';
  editorCSS.value = '';
  editorJS.value = '';
  blockEditorArea.classList.remove('hidden');
  blockEditorArea.scrollIntoView({ behavior: 'smooth' });
});

async function editBlock(halaman, blockId) {
  currentEditingBlock = blockId;
  editorTitle.textContent = `Edit Blok Konten: ${blockId}`;
  currentBlockIdInput.value = blockId; // Display the ID but don't allow editing it
  blockEditorArea.classList.remove('hidden');
  blockEditorArea.scrollIntoView({ behavior: 'smooth' });

  try {
    const snapshot = await db.ref(`dinamis/${halaman}/${blockId}`).once('value');
    const blockData = snapshot.val();
    if (blockData) {
      blockOrderInput.value = blockData.order || '';
      editorHTML.value = blockData.html || '';
      editorCSS.value = blockData.css || '';
      editorJS.value = blockData.js || '';
    } else {
      showCustomAlert('Blok tidak ditemukan.', 'warning');
      hideBlockEditor();
    }
  } catch (err) {
    showCustomAlert(`Gagal memuat data blok untuk diedit: ${err.message}`, 'danger');
    console.error("Error loading block for edit:", err);
    hideBlockEditor();
  }
}

saveBlockBtn.addEventListener('click', async () => {
  const halaman = halamanSelect.value;
  let blockId = currentEditingBlock;
  const order = parseInt(blockOrderInput.value) || 0;
  const htmlContent = editorHTML.value;
  const cssContent = editorCSS.value;
  const jsContent = editorJS.value;

  if (!blockId) { // If adding a new block, generate a new ID
    blockId = 'block_' + Date.now();
  }

  const data = {
    order: order,
    html: htmlContent,
    css: cssContent,
    js: jsContent
  };

  try {
    await db.ref(`dinamis/${halaman}/${blockId}`).set(data);
    showCustomAlert(`‚úÖ Blok konten ${blockId} berhasil disimpan.`, 'success');
    hideBlockEditor();
    loadDinamisBlocks(); // Reload list of blocks
  } catch (err) {
    showCustomAlert(`‚ùå Gagal simpan blok: ${err.message}`, 'danger');
    console.error("Error saving block:", err);
  }
});

cancelEditBlockBtn.addEventListener('click', hideBlockEditor);

function hideBlockEditor() {
  blockEditorArea.classList.add('hidden');
  currentEditingBlock = null;
}

async function deleteBlock(halaman, blockId) {
  if (confirm(`Yakin ingin menghapus blok konten ID ${blockId} dari halaman ${halaman}?`)) {
    try {
      await db.ref(`dinamis/${halaman}/${blockId}`).remove();
      showCustomAlert(`‚úÖ Blok konten ${blockId} berhasil dihapus.`, 'success');
      loadDinamisBlocks(); // Reload list of blocks
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus blok: ${err.message}`, 'danger');
      console.error("Error deleting block:", err);
    }
  }
}

// ====== Tampilkan Pesanan ======
async function tampilkanPesanan() {
  try {
    const snapshot = await db.ref('pesanan').once('value');
    allDataPesanan = snapshot.val() || {};
    const filter = filterStatus.value;
    const search = searchId.value.toLowerCase();
    let html = '';

    const sortedPesananIds = Object.keys(allDataPesanan).sort((a, b) => {
      const timeA = allDataPesanan[a].waktu ? new Date(allDataPesanan[a].waktu).getTime() : 0;
      const timeB = allDataPesanan[b].waktu ? new Date(allDataPesanan[b].waktu).getTime() : 0;
      return timeB - timeA; // Urutkan terbaru dulu
    });

    if (sortedPesananIds.length === 0) {
      pesananList.innerHTML = '<p class="text-gray-500">Belum ada pesanan.</p>';
      return;
    }

    for (const id of sortedPesananIds) {
      const p = allDataPesanan[id];
      if (filter && p.status !== filter) continue;
      if (search && !id.toLowerCase().includes(search) && !p.nama.toLowerCase().includes(search)) continue;

      html += `
      <div class="card">
        <div class="card-body">
          <b>ID:</b> ${id}<br/>
          <b>Nama:</b> ${p.nama || '-'}<br/>
          <b>WA Aktif:</b> ${p.wa_aktif || '-'}<br/>
          <b>Nomor HP (Buyer):</b> ${p.nomor || '-'}<br/>
          <b>Kategori:</b> ${p.kategori || '-'}<br/>
          <b>Produk:</b> ${p.produk || '-'}<br/>
          <b>Harga:</b> Rp${formatRupiah(p.harga || 0)}<br/>
          <b>Status:</b> <b class="text-blue-600">${p.status || '-'}</b><br/>
          <b>Waktu:</b> ${p.waktu ? new Date(p.waktu).toLocaleString('id-ID') : '-'}<br/>
          ${p.buktiBayar ? `<br/><b>Bukti Bayar:</b><br/><img src="${p.buktiBayar}" alt="Bukti Bayar" class="cursor-pointer" onclick="showImageModal('${p.buktiBayar}', 'Bukti Bayar ID: ${id}')" />` : ''}
          ${p.buktiAdmin ? `<br/><b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" alt="Bukti Admin" class="cursor-pointer" onclick="showImageModal('${p.buktiAdmin}', 'Bukti Admin ID: ${id}')" />` : ''}
          <div class="mt-4 flex flex-wrap gap-2">
            <button class="btn btn-info btn-sm" onclick="setSelected('${id}')">üëÜ Pilih</button>
            <button class="btn btn-success btn-sm" onclick="verifikasi('${id}')">‚úÖ Proses</button>
            <button class="btn btn-danger btn-sm" onclick="hapusPesanan('${id}')">üóëÔ∏è Hapus</button>
          </div>
        </div>
      </div>`;
    }
    pesananList.innerHTML = html;
  } catch (err) {
    showCustomAlert(`Gagal memuat pesanan: ${err.message}`, 'danger');
    console.error("Error loading orders:", err);
  }
}

function setSelected(id) {
  selectedId = id;
  selectedOrderIdDisplay.textContent = `Pesanan yang dipilih: ${id}`;
  showCustomAlert("Pesanan dipilih: " + id);
}

async function verifikasi(id) {
  if (!confirm(`Yakin ingin mengubah status pesanan ID ${id} menjadi "Diproses"?`)) return;
  try {
    await db.ref('pesanan/' + id).update({ status: "Diproses" });
    const pesanan = allDataPesanan[id];
    const nomorWA = normalizePhoneNumber(pesanan.wa_aktif || pesanan.nomor);
    if (nomorWA) {
        const pesanUser = `‚úÖ Hai ${pesanan.nama},\n\nPesanan kamu dengan ID: *${id}* sedang *DIPROSES* oleh admin kami. Mohon tunggu sebentar ya.\n\nTerima kasih atas kesabaranmu! üòä`;
        await kirimNotifWA(nomorWA, pesanUser);
    }
    await kirimNotifWA(ADMIN_WA_NUMBER, `‚úÖ Pesanan ${id} telah diubah status menjadi *Diproses*.`);
    showCustomAlert(`‚úÖ Pesanan ${id} berhasil diproses.`);
    tampilkanPesanan();
  } catch (err) {
    showCustomAlert(`‚ùå Gagal memproses pesanan: ${err.message}`, 'danger');
    console.error("Error processing order:", err);
  }
}

async function hapusPesanan(id) {
  if (confirm(`Yakin ingin menghapus pesanan ID ${id}?`)) {
    try {
      await db.ref('pesanan/' + id).remove();
      showCustomAlert("‚úÖ Pesanan dihapus.");
      tampilkanPesanan();
      tampilkanGaleri(); // Perbarui galeri jika bukti bayar ikut terhapus
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus pesanan: ${err.message}`, 'danger');
      console.error("Error deleting order:", err);
    }
  }
}

// ====== Upload Bukti Admin + Kirim Bukti via WA aktif ======
async function uploadBukti() {
  const file = buktiAdminInput.files[0];
  if (!file) return showCustomAlert("‚ùó Pilih gambar terlebih dahulu!");
  if (!selectedId) return showCustomAlert("‚ùó Pilih pesanan yang akan diselesaikan terlebih dahulu!");

  const pesanan = allDataPesanan[selectedId];
  if (!pesanan) return showCustomAlert("‚ùó Pesanan tidak ditemukan!");

  let nomorWA = normalizePhoneNumber(pesanan.wa_aktif || pesanan.nomor);
  if (!nomorWA) return showCustomAlert("‚ùå Nomor WhatsApp aktif pembeli tidak tersedia di pesanan ini.");

  showCustomAlert("Sedang mengunggah bukti dan mengirim notifikasi...", 'info');
  uploadBuktiBtn.disabled = true; // Disable tombol untuk menghindari double click

  try {
    // Upload gambar ke imgbb
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
      method: "POST",
      body: formData
    });
    const json = await res.json();
    if (!json.success) throw new Error(`Upload gagal: ${json.error.message || 'Unknown error'}`);

    const imageUrl = json.data.url;

    // Simpan ke Firebase
    await db.ref('pesanan/' + selectedId).update({
      buktiAdmin: imageUrl,
      status: "Selesai"
    });

    // Kirim link status ke pembeli via WhatsApp
    const linkStatus = `https://asdarcell.github.io/Asdarstoredigital/status.html?id=${selectedId}`; // Pastikan link ini benar
    const pesanUser = `‚úÖ Hai ${pesanan.nama},\n\nPesanan kamu dengan ID: *${selectedId}* telah *SELESAI*.\n\nüìÑ Bukti transaksi dan detail pesanan bisa dicek di sini:\n${linkStatus}\n\nTerima kasih telah berbelanja di Asdar Store! üòä`;

    // Menggunakan window.open untuk membuka WhatsApp Web/App
    // Ini lebih baik daripada fetch karena NgirimWA tidak mendukung pengiriman gambar/file secara langsung.
    // Pengguna admin akan diminta konfirmasi untuk membuka WhatsApp.
    window.open(`https://wa.me/${nomorWA}?text=${encodeURIComponent(pesanUser)}`, '_blank');

    // Kirim notifikasi ke admin via API NgirimWA
    const pesanAdminNotif = `üì¶ Admin telah upload bukti untuk pesanan ID: *${selectedId}* dan status diubah menjadi Selesai.`;
    await kirimNotifWA(ADMIN_WA_NUMBER, pesanAdminNotif);

    showCustomAlert("‚úÖ Bukti berhasil dikirim ke pembeli dan status diupdate. Silakan cek jendela WhatsApp yang terbuka.", 'success');
    selectedId = null;
    selectedOrderIdDisplay.textContent = "";
    buktiAdminInput.value = "";
    tampilkanPesanan();
  } catch (err) {
    showCustomAlert(`‚ùå Upload Gagal atau Notifikasi WA gagal: ${err.message}`, 'danger');
    console.error("Upload/WA error:", err);
  } finally {
    uploadBuktiBtn.disabled = false; // Aktifkan kembali tombol
  }
}

// ====== Export CSV Pesanan ======
function exportCSV() {
  let csv = "ID,Nama,WA Aktif,Nomor HP,Kategori,Produk,Status,Waktu,Bukti Bayar,Bukti Admin\n";
  for (let id in allDataPesanan) {
    const p = allDataPesanan[id];
    const waktuFormatted = p.waktu ? new Date(p.waktu).toLocaleString('id-ID') : '';
    csv += `"${id}","${p.nama || ''}","${p.wa_aktif || ''}","${p.nomor || ''}","${p.kategori || ''}","${p.produk || ''}","${p.status || ''}","${waktuFormatted}","${p.buktiBayar || ''}","${p.buktiAdmin || ''}"\n`;
  }
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `pesanan_asdar_store_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url); // Bersihkan URL objek
  showCustomAlert("‚úÖ Data pesanan berhasil diekspor ke CSV.", 'success');
}

// ====== Produk ======
async function tampilkanProduk() {
  try {
    const snapshot = await db.ref('produk').once('value');
    const produk = snapshot.val() || {};
    daftarProduk.innerHTML = "";
    let productCount = 0;
    for (const kategori in produk) {
      for (const varian in produk[kategori]) {
        const p = produk[kategori][varian];
        const li = document.createElement('li');
        li.className = "card flex justify-between items-center p-3 mb-2"; // Use card styling for list items
        li.innerHTML = `
          <div>
            <b>${kategori}</b> &gt; ${varian}<br/>
            Harga: Rp${formatRupiah(p.harga)}<br/>
            ${p.cara}
          </div>
          <div class="flex gap-2">
            <button class="btn btn-info btn-sm" onclick="editProduk('${kategori}','${varian}', ${p.harga}, '${p.cara.replace(/'/g, "\\'")}')">‚úçÔ∏è Edit</button>
            <button class="btn btn-danger btn-sm" onclick="hapusProduk('${kategori}','${varian}')">üóëÔ∏è Hapus</button>
          </div>`;
        daftarProduk.appendChild(li);
        productCount++;
      }
    }
    if (productCount === 0) {
      daftarProduk.innerHTML = '<p class="text-gray-500">Belum ada produk.</p>';
    }
  } catch (err) {
    showCustomAlert(`Gagal memuat produk: ${err.message}`, 'danger');
    console.error("Error loading products:", err);
  }
}

async function hapusProduk(kategori, varian) {
  if (confirm(`Yakin ingin menghapus produk "${varian}" dari kategori "${kategori}"?`)) {
    try {
      await db.ref(`produk/${kategori}/${varian}`).remove();
      showCustomAlert("‚úÖ Produk dihapus.");
      tampilkanProduk();
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus produk: ${err.message}`, 'danger');
      console.error("Error deleting product:", err);
    }
  }
}

function editProduk(kategori, varian, harga, cara) {
  document.getElementById('kategori').value = kategori;
  document.getElementById('varian').value = varian;
  document.getElementById('harga').value = harga;
  document.getElementById('cara').value = cara;
  showCustomAlert(`Anda sedang mengedit produk: ${kategori} > ${varian}`, 'info');
  document.getElementById('formProduk').scrollIntoView({ behavior: 'smooth' });
}

// ====== Galeri Bukti Bayar ======
async function tampilkanGaleri() {
  try {
    const snapshot = await db.ref('pesanan').once('value');
    const pesanan = snapshot.val() || {};
    galeriDiv.innerHTML = "";
    let galleryCount = 0;
    for (const id in pesanan) {
      const p = pesanan[id];
      if (p.buktiBayar) {
        const img = document.createElement('img');
        img.src = p.buktiBayar;
        img.alt = `Bukti Bayar ID ${id}`;
        img.title = `ID: ${id}\nNama: ${p.nama || '-'}\nStatus: ${p.status || '-'}\nWaktu: ${p.waktu ? new Date(p.waktu).toLocaleString('id-ID') : '-'}`;
        img.onclick = () => showImageModal(p.buktiBayar, `Bukti Bayar ID: ${id}<br>Nama: ${p.nama || '-'} (${p.status || '-'})`);
        galeriDiv.appendChild(img);
        galleryCount++;
      }
    }
    if (galleryCount === 0) {
      galeriDiv.innerHTML = '<p class="text-gray-500">Belum ada bukti transfer yang diunggah.</p>';
    }
  } catch (err) {
    showCustomAlert(`Gagal memuat galeri: ${err.message}`, 'danger');
    console.error("Error loading gallery:", err);
  }
}

function showImageModal(imageUrl, infoText) {
  modalImage.src = imageUrl;
  modalImageInfo.innerHTML = infoText;
  imageModal.classList.remove('hidden'); // Show the modal
}

closeImageModalBtn.addEventListener('click', () => {
  imageModal.classList.add('hidden'); // Hide the modal
});


// ====== Hapus Semua Data ======
async function hapusSemuaPesanan() {
  if (confirm("ANDA YAKIN ingin menghapus SEMUA data pesanan? Tindakan ini tidak bisa dibatalkan!")) {
    try {
      await db.ref('pesanan').remove();
      showCustomAlert("‚úÖ Semua pesanan berhasil dihapus.", 'success');
      tampilkanPesanan();
      tampilkanGaleri();
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus semua pesanan: ${err.message}`, 'danger');
      console.error("Error deleting all orders:", err);
    }
  }
}

async function hapusSemuaProduk() {
  if (confirm("ANDA YAKIN ingin menghapus SEMUA data produk? Tindakan ini tidak bisa dibatalkan!")) {
    try {
      await db.ref('produk').remove();
      showCustomAlert("‚úÖ Semua produk berhasil dihapus.", 'success');
      tampilkanProduk();
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus semua produk: ${err.message}`, 'danger');
      console.error("Error deleting all products:", err);
    }
  }
}

async function hapusSemuaGaleri() {
  if (confirm("ANDA YAKIN ingin menghapus SEMUA bukti transfer (gambar)? Data pesanan akan tetap ada, hanya link gambar yang dihapus.")) {
    try {
      const snapshot = await db.ref('pesanan').once('value');
      const pesanan = snapshot.val() || {};
      const updates = {};
      for (const id in pesanan) {
        if (pesanan[id].buktiBayar) {
          updates[`${id}/buktiBayar`] = null; // Setel ke null, tidak hapus pesanan
        }
      }
      await db.ref('pesanan').update(updates); // Gunakan update untuk batch
      showCustomAlert("‚úÖ Semua bukti transfer berhasil dihapus.", 'success');
      tampilkanPesanan();
      tampilkanGaleri();
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus semua bukti transfer: ${err.message}`, 'danger');
      console.error("Error deleting all gallery items:", err);
    }
  }
}

async function hapusSemuaData() {
  if (confirm("INI ADALAH TINDAKAN BERBAHAYA! Yakin ingin menghapus SEMUA DATA (pesanan, produk, bukti transfer)? Tindakan ini tidak bisa dibatalkan!")) {
    try {
      await Promise.all([
        db.ref('pesanan').remove(),
        db.ref('produk').remove(),
        db.ref('dinamis').remove(), // Also delete dynamic content
        db.ref('testimoni').remove(), // Also delete testimonials
        db.ref('users').remove() // Also delete user roles (be careful with this one)
      ]);
      showCustomAlert("üî• Semua data (pesanan, produk, bukti transfer, dinamis, testimoni, users) berhasil dihapus.", 'success');
      tampilkanPesanan();
      tampilkanProduk();
      tampilkanGaleri();
      loadDinamisBlocks(); // Refresh dynamic blocks list
    } catch (err) {
      showCustomAlert(`‚ùå Gagal menghapus SEMUA DATA: ${err.message}`, 'danger');
      console.error("Error deleting all data:", err);
    }
  }
}

// --- NgirimWA API Integration ---
async function kirimNotifWA(nomor, pesan) {
  if (!nomor || !pesan) {
    console.warn("Nomor atau pesan kosong, tidak bisa kirim notifikasi WA.");
    return;
  }
  nomor = normalizePhoneNumber(nomor);
  if (!nomor) {
      console.warn("Nomor WA tidak valid setelah normalisasi.");
      return;
  }

  try {
    // Using the /sendText endpoint as before, if it supports form-urlencoded
    const response = await fetch("https://api.ngirimwa.com/sendText", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        appkey: NGIRIMWA_APPKEY,
        authkey: NGIRIMWA_AUTHKEY,
        to: nomor,
        message: pesan
      })
    });
    const result = await response.json();
    if (!response.ok || result.status !== "success") {
      throw new Error(`NgirimWA API error: ${result.message || 'Unknown error'}`);
    }
    console.log(`Notifikasi WA berhasil dikirim ke ${nomor}:`, result);
  } catch (err) {
    console.error(`Gagal mengirim notifikasi WA ke ${nomor}: ${err.message}`);
    // showCustomAlert(`Gagal kirim notifikasi WA ke ${nomor}: ${err.message}`, 'warning'); // Tidak perlu selalu muncul alert ke admin
  }
}

// --- Event Listeners ---
halamanSelect.addEventListener('change', loadDinamisBlocks);

filterStatus.addEventListener('change', tampilkanPesanan);
searchId.addEventListener('input', tampilkanPesanan);
document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
document.getElementById('refreshDataBtn').addEventListener('click', () => {
  showCustomAlert("üîÑ Merefresh data...", 'info');
  tampilkanPesanan();
  tampilkanProduk();
  tampilkanGaleri();
  loadDinamisBlocks();
});
uploadBuktiBtn.addEventListener('click', uploadBukti);

formProduk.addEventListener('submit', async function(e) {
  e.preventDefault();

  const kategoriInput = document.getElementById('kategori');
  const varianInput = document.getElementById('varian');
  const hargaInput = document.getElementById('harga');
  const caraInput = document.getElementById('cara');

  const kategori = kategoriInput.value.trim();
  const varian = varianInput.value.trim();
  let harga = hargaInput.value.replace(/\D/g, ""); // Hapus non-digit
  harga = parseInt(harga);
  const cara = caraInput.value.trim();

  if (!kategori || !varian || isNaN(harga) || !cara) {
    return showCustomAlert("‚ùó Semua field produk (kategori, varian, harga, cara beli) wajib diisi dan harga harus berupa angka.");
  }

  try {
    await db.ref(`produk/${kategori}/${varian}`).set({
      harga: harga,
      cara: cara
    });
    showCustomAlert("‚úÖ Produk berhasil disimpan/diedit.", 'success');
    formProduk.reset();
    tampilkanProduk();
  } catch (err) {
    showCustomAlert(`‚ùå Gagal simpan produk: ${err.message}`, 'danger');
    console.error("Error saving product:", err);
  }
});

// --- Initial Load ---
document.addEventListener('DOMContentLoaded', () => {
    initCollapsibles(); // Initialize collapsible sections
    // Data loading is now triggered after successful admin authentication
});
</script>
</body>
</html>
