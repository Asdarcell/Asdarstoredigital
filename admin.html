<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 15px; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Dashboard Admin - Asdar Store</h1>
  
  <!-- Statistik Pesanan -->
  <div class="row text-center mb-3">
    <div class="col"><div class="card p-2 bg-info text-white">Total Pesanan<br/><b id="statPesanan"></b></div></div>
    <div class="col"><div class="card p-2 bg-success text-white">Selesai<br/><b id="statSelesai"></b></div></div>
    <div class="col"><div class="card p-2 bg-warning text-white">Diproses<br/><b id="statProses"></b></div></div>
  </div>
  
  <!-- Filter Pesanan -->
  <div class="row mb-3">
    <div class="col-md-4">
      <select id="filterStatus" class="form-select">
        <option value="">Filter Semua Status</option>
        <option value="Belum Bayar">Belum Bayar</option>
        <option value="Sudah Bayar">Sudah Bayar</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="col-md-4">
      <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan" />
    </div>
    <div class="col-md-4">
      <button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button>
    </div>
  </div>

  <!-- List Pesanan -->
  <div id="pesananList"></div>

  <!-- Upload Bukti Admin -->
  <h3>Upload Bukti Admin ke Pembeli</h3>
  <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*" />
  <button id="uploadBuktiBtn" class="btn btn-primary mb-4">Kirim Bukti & Selesaikan</button>
  <hr>

  <!-- Manage Produk -->
  <h3>Tambah / Edit Produk</h3>
  <form id="formProduk" class="row g-3 mb-4">
    <div class="col-md-3"><input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required /></div>
    <div class="col-md-3"><input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required /></div>
    <div class="col-md-2"><input type="number" id="harga" class="form-control" placeholder="Harga (Rp)" required /></div>
    <div class="col-md-4"><input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required /></div>
    <div class="col-12"><button type="submit" class="btn btn-success">Simpan / Edit Produk</button></div>
  </form>
  <h4>Daftar Produk</h4>
  <ul id="daftarProduk" class="list-group mb-5"></ul>

  <!-- Galeri Bukti Transfer -->
  <h4>Galeri Bukti Transfer</h4>
  <div id="galeri" class="d-flex flex-wrap"></div>

  <hr/>

  <!-- Hapus Data -->
  <h3>Hapus Semua Data</h3>
  <div class="d-grid gap-2 d-md-block mb-5">
    <button class="btn btn-danger mb-2" onclick="hapusSemuaPesanan()">üßπ Hapus Semua Pesanan</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaProduk()">üßπ Hapus Semua Produk</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaGaleri()">üßπ Hapus Semua Bukti Transfer</button>
    <button class="btn btn-dark mb-2" onclick="hapusSemuaData()">üî• Hapus SEMUA DATA</button>
    <button class="btn btn-warning mb-2" onclick="hapusPerKategoriStatus()">üóÉÔ∏è Hapus Per Kategori Status</button>
  </div>

  <!-- Fitur Dinamis -->
  <h3>Fitur Dinamis di Halaman Admin</h3>
  <div id="fiturDinamisAdmin" class="mb-4"></div>

  <!-- Form tambah fitur dinamis -->
  <h3>Tambah Fitur Dinamis</h3>
  <form id="formFiturDinamis" class="row g-3 mb-4">
    <div class="col-md-3">
      <select id="lokasiFitur" class="form-select" required>
        <option value="">Pilih Lokasi</option>
        <option value="index">Halaman Index</option>
        <option value="status">Halaman Status</option>
        <option value="admin">Dashboard Admin</option>
      </select>
    </div>
    <div class="col-md-9">
      <textarea id="htmlFitur" class="form-control" placeholder="Masukkan HTML fitur (bisa tombol, label, dll)" rows="4" required></textarea>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-secondary">üíæ Simpan Fitur</button>
    </div>
  </form>

  <ul id="listFiturDinamis" class="list-group mb-5"></ul>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
    authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
    databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
    projectId: "asdarstoredigitalll-d89c4",
    storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
    messagingSenderId: "220670500351",
    appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
  };
  firebase.initializeApp(firebaseConfig);

  const db = firebase.database();
  const fiturRef = db.ref('fitur_dinamis');

  // Nomor WA Admin (ganti sesuai)
  const nomorAdmin = "6281803004607";

  let selectedId = null;
  let allDataPesanan = {};

  // --- Statistik Pesanan ---
  function tampilkanStatistik() {
    db.ref('pesanan').once('value').then(snap => {
      const data = snap.val() || {};
      let total = 0, selesai = 0, diproses = 0;
      for (let id in data) {
        total++;
        if (data[id].status === 'Selesai') selesai++;
        if (data[id].status === 'Diproses') diproses++;
      }
      document.getElementById('statPesanan').innerText = total;
      document.getElementById('statSelesai').innerText = selesai;
      document.getElementById('statProses').innerText = diproses;
    });
  }

  // --- Tampilkan Pesanan ---
  function tampilkanPesanan() {
    db.ref('pesanan').once('value').then(snapshot => {
      allDataPesanan = snapshot.val() || {};
      const filter = document.getElementById('filterStatus').value;
      const search = document.getElementById('searchId').value.toLowerCase();
      let html = '';
      for (let id in allDataPesanan) {
        const p = allDataPesanan[id];
        if (filter && p.status !== filter) continue;
        if (search && !id.toLowerCase().includes(search)) continue;
        html += `<div class="card"><div class="card-body">
          <b>ID:</b> ${id}<br/>
          <b>Nama:</b> ${p.nama || '-'}<br/>
          <b>Nomor HP / ID SN:</b> ${p.nomor || '-'}<br/>
          <b>Kategori:</b> ${p.kategori || '-'}<br/>
          <b>Produk:</b> ${p.produk || '-'}<br/>
          <b>Status:</b> ${p.status || '-'}<br/>
          <b>Waktu:</b> ${p.waktu || '-'}<br/>
          ${p.buktiBayar ? `<b>Bukti Pembeli:</b><br/><img src="${p.buktiBayar}" alt="Bukti Bayar" />` : ''}
          ${p.buktiAdmin ? `<br/><b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" alt="Bukti Admin" />` : ''}
          <br/>
          <button class="btn btn-warning btn-sm" onclick="setSelected('${id}')">üì§ Pilih Pesanan</button>
          <button class="btn btn-info btn-sm" onclick="updateStatus('${id}','Diproses')">‚úÖ Proses</button>
          <button class="btn btn-danger btn-sm" onclick="hapusPesanan('${id}')">üóëÔ∏è Hapus</button>
        </div></div>`;
      }
      document.getElementById('pesananList').innerHTML = html;
      tampilkanStatistik();
      tampilkanGaleri();
      tampilkanProduk();
      tampilkanFiturDinamisAdmin();
    });
  }

  // --- Pilih Pesanan untuk Upload Bukti ---
  function setSelected(id) {
    selectedId = id;
    alert("Pesanan dipilih: " + id);
  }

  // --- Update Status Pesanan ---
  function updateStatus(id, status) {
    db.ref('pesanan/' + id).update({ status }).then(() => {
      kirimNotifWA(`‚úÖ Pesanan ${id} status diubah ke ${status}.`);
      tampilkanPesanan();
    });
  }

  // --- Hapus Pesanan ---
  function hapusPesanan(id) {
    if (!confirm("Yakin hapus pesanan " + id + "?")) return;
    db.ref('pesanan/' + id).remove().then(() => {
      alert("Pesanan dihapus");
      tampilkanPesanan();
    });
  }

  // --- Fungsi Kirim Notifikasi WA via API ngirimwa.vercel.app ---
  async function kirimNotifWA(message, nomor = nomorAdmin) {
    try {
      await fetch("https://ngirimwa.vercel.app/api/send-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nomor, pesan: message })
      });
    } catch (err) {
      console.error("Gagal kirim WA:", err);
    }
  }

  // --- Upload Bukti Admin & Kirim Notif WA ---
  async function uploadBukti() {
    const fileInput = document.getElementById('buktiAdmin');
    const file = fileInput.files[0];
    if (!file) return alert("‚ùó Pilih gambar bukti dulu!");
    if (!selectedId) return alert("‚ùó Pilih pesanan terlebih dahulu!");

    const formData = new FormData();
    formData.append("image", file);

    const imgbbApiKey = "f71ccc1a662c9f8656766990018d3a33"; // Ganti kalau perlu
    try {
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      if (!json.success) throw new Error("Upload gagal");

      const imageUrl = json.data.url;
      await db.ref('pesanan/' + selectedId).update({ buktiAdmin: imageUrl, status: 'Selesai' });

      // Kirim notifikasi WA ke pembeli
      const pesanan = allDataPesanan[selectedId];
      if (pesanan && pesanan.nomor) {
        const waMessageBuyer = `‚úÖ Pesanan Anda (${selectedId}) sudah selesai.\nCek status di: ${window.location.origin}/status.html?nomor=${encodeURIComponent(pesanan.nomor)}`;
        await kirimNotifWA(waMessageBuyer, pesanan.nomor);
      }
      // Kirim notif ke admin juga
      await kirimNotifWA(`‚úÖ Pesanan ${selectedId} telah selesai dan bukti admin sudah dikirim.`);

      alert("Bukti berhasil dikirim dan status diubah menjadi Selesai!");
      fileInput.value = "";
      selectedId = null;
      tampilkanPesanan();

    } catch (error) {
      alert("Gagal upload bukti: " + error.message);
    }
  }

  // --- Export CSV Pesanan ---
  function exportCSV() {
    let csv = 'ID,Nama,Nomor,Kategori,Produk,Status,Waktu\n';
    for (let id in allDataPesanan) {
      const p = allDataPesanan[id];
      csv += `"${id}","${p.nama || ''}","${p.nomor || ''}","${p.kategori || ''}","${p.produk || ''}","${p.status || ''}","${p.waktu || ''}"\n`;
    }
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pesanan_asdar_store.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // --- Produk ---
  function tampilkanProduk() {
    db.ref('produk').once('value').then(snap => {
      const produk = snap.val() || {};
      let html = '';
      for (let id in produk) {
        const p = produk[id];
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
          <div><b>${p.kategori}</b> - ${p.varian} - Rp${p.harga.toLocaleString()}<br/>${p.cara}</div>
          <button class="btn btn-danger btn-sm" onclick="hapusProduk('${id}')">üóëÔ∏è</button>
        </li>`;
      }
      document.getElementById('daftarProduk').innerHTML = html;
    });
  }

  // --- Tambah / Edit Produk ---
  document.getElementById('formProduk').addEventListener('submit', e => {
    e.preventDefault();
    const kategori = document.getElementById('kategori').value.trim();
    const varian = document.getElementById('varian').value.trim();
    const harga = parseInt(document.getElementById('harga').value);
    const cara = document.getElementById('cara').value.trim();
    if (!kategori || !varian || !harga || !cara) return alert("Semua field wajib diisi!");

    const produkBaru = { kategori, varian, harga, cara };
    // Simpan ke Firebase produk
    db.ref('produk').push(produkBaru).then(() => {
      alert("Produk berhasil ditambahkan!");
      document.getElementById('formProduk').reset();
      tampilkanProduk();
    });
  });

  // --- Hapus Produk ---
  function hapusProduk(id) {
    if (!confirm("Yakin hapus produk ini?")) return;
    db.ref('produk/' + id).remove().then(() => {
      alert("Produk dihapus");
      tampilkanProduk();
    });
  }

  // --- Galeri Bukti Transfer ---
  function tampilkanGaleri() {
    db.ref('galeri_bukti').once('value').then(snap => {
      const galeri = snap.val() || {};
      let html = '';
      for (let id in galeri) {
        const url = galeri[id].url;
        html += `<img src="${url}" alt="Bukti Transfer" />`;
      }
      document.getElementById('galeri').innerHTML = html;
    });
  }

  // --- Hapus Semua Data ---
  function hapusSemuaPesanan() {
    if (!confirm("Yakin hapus semua pesanan?")) return;
    db.ref('pesanan').remove().then(() => {
      alert("Semua pesanan dihapus!");
      tampilkanPesanan();
    });
  }
  function hapusSemuaProduk() {
    if (!confirm("Yakin hapus semua produk?")) return;
    db.ref('produk').remove().then(() => {
      alert("Semua produk dihapus!");
      tampilkanProduk();
    });
  }
  function hapusSemuaGaleri() {
    if (!confirm("Yakin hapus semua galeri bukti transfer?")) return;
    db.ref('galeri_bukti').remove().then(() => {
      alert("Semua galeri dihapus!");
      tampilkanGaleri();
    });
  }
  function hapusSemuaData() {
    if (!confirm("Yakin hapus SEMUA DATA (pesanan, produk, galeri, fitur)?")) return;
    db.ref().remove().then(() => {
      alert("SEMUA DATA dihapus!");
      tampilkanPesanan();
      tampilkanProduk();
      tampilkanGaleri();
      tampilkanFiturDinamisAdmin();
    });
  }
  // ...lanjutan hapusPerKategoriStatus
function hapusPerKategoriStatus() {
  const kategori = prompt("Masukkan Kategori produk untuk dihapus (kosongkan untuk semua):");
  const status = prompt("Masukkan Status pesanan untuk dihapus (Belum Bayar, Sudah Bayar, Diproses, Selesai atau kosong untuk semua):");

  if (!confirm(`Yakin hapus pesanan dengan kategori: "${kategori || 'SEMUA'}" dan status: "${status || 'SEMUA'}"?`)) return;

  db.ref('pesanan').once('value').then(snap => {
    const pesanan = snap.val() || {};
    for (let id in pesanan) {
      const p = pesanan[id];
      const cocokKategori = kategori ? p.kategori === kategori : true;
      const cocokStatus = status ? p.status === status : true;
      if (cocokKategori && cocokStatus) {
        db.ref('pesanan/' + id).remove();
      }
    }
    alert('Data pesanan yang sesuai telah dihapus.');
    tampilkanPesanan();
  });
}

// --- Fitur Dinamis ---
// Simpan fitur baru ke Firebase
document.getElementById('formFiturDinamis').addEventListener('submit', e => {
  e.preventDefault();
  const lokasi = document.getElementById('lokasiFitur').value;
  const html = document.getElementById('htmlFitur').value.trim();

  if (!lokasi || !html) return alert('Semua field wajib diisi.');

  fiturRef.push({ lokasi, html, waktu: new Date().toLocaleString('id-ID') }).then(() => {
    alert("‚úÖ Fitur disimpan!");
    e.target.reset();
    tampilkanFiturDinamisAdmin();
  });
});

// Tampilkan list fitur dinamis di admin (dengan tombol hapus)
function tampilkanFiturDinamisAdmin() {
  fiturRef.once('value').then(snap => {
    const data = snap.val() || {};
    let list = "";
    let fiturHTML = "";
    for (let id in data) {
      const f = data[id];
      list += `<li class="list-group-item d-flex justify-content-between align-items-start">
        <div><b>${f.lokasi}</b> - ${f.waktu}<br/>${f.html}</div>
        <button class="btn btn-sm btn-danger" onclick="hapusFitur('${id}')">üóëÔ∏è</button>
      </li>`;
      // Render fitur yang lokasi = 'admin' di dashboard admin ini
      if (f.lokasi === 'admin') {
        fiturHTML += f.html;
      }
    }
    document.getElementById('listFiturDinamis').innerHTML = list;
    document.getElementById('fiturDinamisAdmin').innerHTML = fiturHTML;
  });
}

// Hapus fitur dinamis berdasarkan ID
function hapusFitur(id) {
  if (confirm("Hapus fitur ini?")) {
    fiturRef.child(id).remove().then(tampilkanFiturDinamisAdmin);
  }
}

// --- Event Listeners ---
document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
document.getElementById('searchId').addEventListener('input', tampilkanPesanan);
document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
document.getElementById('uploadBuktiBtn').addEventListener('click', uploadBukti);

// --- Inisialisasi ---
tampilkanPesanan();

</script>
</body>
</html>
