<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Admin</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
            --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
            --success: #28a745; --danger: #e74c3c; --warning: #f39c12;
            --info: #3498db; --muted-text: #6c757d;
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
            --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
            --success: #27ae60; --danger: #c0392b; --warning: #f1c40f;
            --info: #3498db; --muted-text: #8a93a2;
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
            line-height: 1.6;
        }
        header {
            position: sticky; top: 0; background: var(--card); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); z-index: 999;
        }
        header h1 { margin: 0; font-size: 24px; color: var(--primary); }
        .logout-btn { background: none; border: none; color: var(--primary); font-weight: 600; cursor: pointer; }
        main { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .section-container {
            background: var(--card); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow); margin-top: 20px;
        }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; }
        .table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
        }
        .table th, .table td {
            padding: 12px; text-align: left; border-bottom: 1px solid var(--border);
        }
        .table th { background: var(--bg); font-weight: bold; }
        .btn-action { margin-right: 5px; }
        .btn-success { background-color: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 5px; }
        .btn-danger { background-color: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; }
        .btn-info { background-color: var(--info); color: white; border: none; padding: 6px 12px; border-radius: 5px; }
        .badge {
            padding: 4px 8px; border-radius: 12px; font-weight: bold;
        }
        .badge-pending { background-color: var(--warning); color: black; }
        .badge-selesai { background-color: var(--success); color: white; }
        .badge-dibatalkan { background-color: var(--danger); color: white; }
        .badge-disetujui { background-color: var(--success); color: white; }
        .badge-ditolak { background-color: var(--danger); color: white; }
        .info {
            background: var(--bg); padding: 15px; border-left: 5px solid var(--primary); border-radius: 8px; margin-bottom: 15px;
        }
        form label, form input, form button { display: block; width: 100%; margin-bottom: 10px; }
        .form-control { border-radius: 8px; border: 1px solid var(--border); background-color: var(--card); color: var(--text); padding: 10px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) {
            .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="dark">
    <header>
        <h1>Dasbor Admin</h1>
        <button id="logoutBtn" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Keluar
        </button>
    </header>

    <main>
        <div class="section-container">
            <h2>Ringkasan</h2>
            <div class="grid-3">
                <div class="info text-center">
                    <h5>Pesanan Buyer</h5>
                    <h3 id="countPesananBuyer">0</h3>
                </div>
                <div class="info text-center">
                    <h5>Pesanan Reseller</h5>
                    <h3 id="countPesananReseller">0</h3>
                </div>
                <div class="info text-center">
                    <h5>Top Up Pending</h5>
                    <h3 id="countTopupPending">0</h3>
                </div>
            </div>
        </div>

        <div class="section-container">
            <h2>Konfirmasi Top Up Reseller</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email Reseller</th>
                            <th>Nominal</th>
                            <th>Metode</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="topupTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section-container">
            <h2>Pesanan Buyer</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Pelanggan</th>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="buyerOrderTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section-container">
            <h2>Pesanan Reseller</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email Reseller</th>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="resellerOrderTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section-container">
            <h2>Manajemen Produk</h2>
            <div class="info">
                <p>Tambah/Ubah produk pada koleksi `produk` di Firestore.</p>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <label>ID Produk (Untuk Hapus)</label>
                <input type="text" id="deleteProductId" placeholder="Isi ID produk untuk dihapus">
                <button type="button" id="deleteProductBtn" class="btn-danger"><i class="fas fa-trash"></i> Hapus Produk</button>
                <hr>
                <label>Nama Produk</label>
                <input type="text" id="productNama" class="form-control" placeholder="Nama Produk" required>
                <label>Harga Umum</label>
                <input type="number" id="productHargaUmum" class="form-control" placeholder="Harga untuk pembeli" required>
                <label>Harga Reseller</label>
                <input type="number" id="productHargaReseller" class="form-control" placeholder="Harga untuk reseller" required>
                <label>Kategori</label>
                <input type="text" id="productKategori" class="form-control" placeholder="Kategori Produk" required>
                <label>Deskripsi</label>
                <textarea id="productDeskripsi" class="form-control" placeholder="Deskripsi produk" rows="3"></textarea>
                <label>Stok</label>
                <input type="number" id="productStok" class="form-control" placeholder="Jumlah stok" required>
                <button type="submit" class="btn-success">Simpan/Update Produk</button>
            </form>
        </div>
        
        <div class="section-container">
            <h2>Manajemen Testimoni</h2>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Pesan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="testimonialTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section-container">
            <h2>Manajemen FAQ</h2>
            <form id="faqForm">
                <label>Pertanyaan</label>
                <input type="text" id="faqQuestion" class="form-control" required>
                <label>Jawaban</label>
                <textarea id="faqAnswer" class="form-control" required></textarea>
                <button type="submit" class="btn-success">Tambah/Simpan FAQ</button>
            </form>
            <div class="table-responsive mt-4">
                <table class="table">
                    <thead>
                        <tr><th>Pertanyaan</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="faqTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="section-container">
            <h2>Manajemen Hak Diskon</h2>
            <form id="diskonForm">
                <label>Nomor WhatsApp (+62)</label>
                <input type="tel" id="diskonWa" class="form-control" placeholder="Cth: 6281234567890" required>
                <button type="submit" class="btn-success">Tambah Hak Diskon</button>
            </form>
        </div>

    </main>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // PASTIKAN MENGGANTI firebaseConfig DENGAN KODE PUNYAMU!
        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();

        // --- Cek Autentikasi Admin ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'loginadmin.html';
            } else {
                // Di sini Anda bisa menambahkan cek apakah user adalah admin
                // Misalnya: dbFS.collection('admins').doc(user.uid).get().then(doc => { ... })
                // Untuk saat ini, kita asumsikan yang login adalah admin.
                console.log("Admin berhasil login.");
                loadAllData();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'loginadmin.html';
            });
        });

        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

        const getStatusBadge = (status) => {
            let className = '';
            if (status.toLowerCase().includes('pending') || status.toLowerCase().includes('menunggu')) className = 'badge-pending';
            else if (status.toLowerCase().includes('selesai') || status.toLowerCase().includes('disetujui')) className = 'badge-selesai';
            else if (status.toLowerCase().includes('batal') || status.toLowerCase().includes('ditolak')) className = 'badge-dibatalkan';
            return `<span class="badge ${className}">${status}</span>`;
        };

        const loadAllData = () => {
            loadTopupConfirmations();
            loadBuyerOrders();
            loadResellerOrders();
            loadTestimonials();
            loadFaqs();
        };

        // --- Manajemen Top Up Reseller (Firestore) ---
        const loadTopupConfirmations = () => {
            dbFS.collection('konfirmasiTopup').where('status', '==', 'pending').onSnapshot(snapshot => {
                const tableBody = document.getElementById('topupTableBody');
                tableBody.innerHTML = '';
                document.getElementById('countTopupPending').textContent = snapshot.size;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.id}</td>
                        <td>${data.reseller_email}</td>
                        <td>${formatRupiah(data.nominal)}</td>
                        <td>${data.metode_pembayaran}</td>
                        <td>${getStatusBadge(data.status)}</td>
                        <td>
                            <a href="${data.bukti_url}" target="_blank" class="btn-info btn-action">Bukti</a>
                            <button class="btn-success btn-action" onclick="setujuTopUp('${doc.id}', '${data.reseller_uid}', ${data.nominal})">Setuju</button>
                            <button class="btn-danger btn-action" onclick="tolakTopUp('${doc.id}')">Tolak</button>
                        </td>
                    `;
                });
            });
        };
        window.setujuTopUp = async (konfirmasiId, resellerUid, nominal) => {
            await dbFS.runTransaction(async (transaction) => {
                const konfirmasiRef = dbFS.collection('konfirmasiTopup').doc(konfirmasiId);
                const resellerRef = dbFS.collection('resellers').doc(resellerUid);
                const konfirmasiDoc = await transaction.get(konfirmasiRef);
                const resellerDoc = await transaction.get(resellerRef);
                const currentSaldo = resellerDoc.data().saldo || 0;
                transaction.update(resellerRef, { saldo: currentSaldo + nominal });
                transaction.update(konfirmasiRef, { status: 'disetujui' });
            });
            alert('Top Up berhasil disetujui!');
        };
        window.tolakTopUp = async (konfirmasiId) => {
            await dbFS.collection('konfirmasiTopup').doc(konfirmasiId).update({ status: 'ditolak' });
            alert('Top Up berhasil ditolak!');
        };

        // --- Manajemen Pesanan Buyer (Realtime Database) ---
        const loadBuyerOrders = () => {
            dbRT.ref('pesananBuyer').on('value', snapshot => {
                const tableBody = document.getElementById('buyerOrderTableBody');
                tableBody.innerHTML = '';
                let count = 0;
                snapshot.forEach(childSnap => {
                    count++;
                    const data = childSnap.val();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.id}</td>
                        <td>${data.nama_pelanggan}</td>
                        <td>${data.produk}</td>
                        <td>${formatRupiah(data.harga)}</td>
                        <td>${getStatusBadge(data.status)}</td>
                        <td>
                            <button class="btn-success btn-action" onclick="ubahStatusPesananRT('${data.id}', 'Selesai')">Selesai</button>
                            <button class="btn-danger btn-action" onclick="ubahStatusPesananRT('${data.id}', 'Dibatalkan')">Batal</button>
                        </td>
                    `;
                });
                document.getElementById('countPesananBuyer').textContent = count;
            });
        };
        window.ubahStatusPesananRT = async (id, status) => {
            await dbRT.ref('pesananBuyer/' + id).update({ status: status });
            alert(`Status pesanan ${id} diubah menjadi ${status}`);
        };

        // --- Manajemen Pesanan Reseller (Firestore) ---
        const loadResellerOrders = () => {
            dbFS.collection('pesananReseller').onSnapshot(snapshot => {
                const tableBody = document.getElementById('resellerOrderTableBody');
                tableBody.innerHTML = '';
                document.getElementById('countPesananReseller').textContent = snapshot.size;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.id}</td>
                        <td>${data.reseller_email}</td>
                        <td>${data.produk}</td>
                        <td>${formatRupiah(data.harga_beli)}</td>
                        <td>${getStatusBadge(data.status)}</td>
                        <td>
                            <button class="btn-success btn-action" onclick="ubahStatusPesananFS('${doc.id}', 'Selesai')">Selesai</button>
                            <button class="btn-danger btn-action" onclick="ubahStatusPesananFS('${doc.id}', 'Dibatalkan')">Batal</button>
                        </td>
                    `;
                });
            });
        };
        window.ubahStatusPesananFS = async (id, status) => {
            await dbFS.collection('pesananReseller').doc(id).update({ status: status });
            alert(`Status pesanan ${id} diubah menjadi ${status}`);
        };

        // --- Manajemen Produk (Firestore) ---
        const productForm = document.getElementById('productForm');
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value || 'P' + Date.now();
            const data = {
                nama_produk: document.getElementById('productNama').value,
                harga_umum: parseInt(document.getElementById('productHargaUmum').value),
                harga_reseller: parseInt(document.getElementById('productHargaReseller').value),
                kategori: document.getElementById('productKategori').value,
                deskripsi: document.getElementById('productDeskripsi').value,
                stok: parseInt(document.getElementById('productStok').value)
            };
            await dbFS.collection('produk').doc(id).set(data, { merge: true });
            alert('Produk berhasil disimpan!');
            productForm.reset();
        });
        document.getElementById('deleteProductBtn').addEventListener('click', async () => {
            const id = document.getElementById('deleteProductId').value.trim();
            if (confirm(`Yakin ingin menghapus produk dengan ID ${id}?`)) {
                await dbFS.collection('produk').doc(id).delete();
                alert('Produk berhasil dihapus!');
                document.getElementById('deleteProductId').value = '';
            }
        });

        // --- Manajemen Testimoni (Realtime Database) ---
        const loadTestimonials = () => {
            dbRT.ref('testimonials').on('value', snapshot => {
                const tableBody = document.getElementById('testimonialTableBody');
                tableBody.innerHTML = '';
                snapshot.forEach(childSnap => {
                    const data = childSnap.val();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.nama}</td>
                        <td>${data.isi}</td>
                        <td>${getStatusBadge(data.status)}</td>
                        <td>
                            <button class="btn-success btn-action" onclick="setujuTesti('${childSnap.key}')">Setuju</button>
                            <button class="btn-danger btn-action" onclick="tolakTesti('${childSnap.key}')">Tolak</button>
                        </td>
                    `;
                });
            });
        };
        window.setujuTesti = async (key) => {
            await dbRT.ref('testimonials/' + key).update({ status: 'disetujui' });
            alert('Testimoni berhasil disetujui!');
        };
        window.tolakTesti = async (key) => {
            await dbRT.ref('testimonials/' + key).update({ status: 'ditolak' });
            alert('Testimoni berhasil ditolak!');
        };

        // --- Manajemen FAQ (Realtime Database) ---
        const faqForm = document.getElementById('faqForm');
        faqForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = document.getElementById('faqQuestion').value;
            const a = document.getElementById('faqAnswer').value;
            await dbRT.ref('faq').push({ q, a });
            alert('FAQ berhasil ditambahkan!');
            faqForm.reset();
        });
        const loadFaqs = () => {
            dbRT.ref('faq').on('value', snapshot => {
                const tableBody = document.getElementById('faqTableBody');
                tableBody.innerHTML = '';
                snapshot.forEach(childSnap => {
                    const data = childSnap.val();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.q}</td>
                        <td><button class="btn-danger" onclick="hapusFaq('${childSnap.key}')">Hapus</button></td>
                    `;
                });
            });
        };
        window.hapusFaq = async (key) => {
            if (confirm('Yakin ingin menghapus FAQ ini?')) {
                await dbRT.ref('faq/' + key).remove();
                alert('FAQ berhasil dihapus!');
            }
        };

        // --- Manajemen Hak Diskon (Realtime Database) ---
        const diskonForm = document.getElementById('diskonForm');
        diskonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const wa = document.getElementById('diskonWa').value.trim();
            if (wa) {
                await dbRT.ref('hakDiskon/' + wa).set(true);
                alert('Hak diskon berhasil diberikan!');
                diskonForm.reset();
            }
        });
    </script>
</body>
</html>
