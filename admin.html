<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 15px; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; }
    #testimoniList { max-height: 200px; overflow-y: auto; margin-bottom: 20px; }
    .testimoni-card { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgb(0 0 0 / 0.1); }
  </style>
</head>
<body>
<div class="container">
  <h1>Dashboard Admin - Asdar Store</h1>

  <!-- Filter & Pencarian -->
  <div class="row mb-3">
    <div class="col-md-3">
      <select id="filterStatus" class="form-select">
        <option value="">Filter Semua Status</option>
        <option value="Belum Bayar">Belum Bayar</option>
        <option value="Sudah Bayar">Sudah Bayar</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="filterKategori" class="form-select">
        <option value="">Filter Semua Kategori</option>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan" />
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button>
    </div>
  </div>

  <!-- Daftar Pesanan -->
  <div id="pesananList"></div>

  <!-- Upload Bukti Admin -->
  <h3>Upload Bukti Admin ke Pembeli</h3>
  <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*" />
  <button id="uploadBuktiBtn" class="btn btn-primary mb-4">Kirim Bukti & Selesaikan</button>

  <hr>

  <!-- Form Produk -->
  <h3>Tambah / Edit Produk</h3>
  <form id="formProduk" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required />
    </div>
    <div class="col-md-3">
      <input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required />
    </div>
    <div class="col-md-2">
      <input type="number" id="harga" class="form-control" placeholder="Harga (Rp)" required />
    </div>
    <div class="col-md-4">
      <input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required />
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-success">Simpan / Edit Produk</button>
    </div>
  </form>

  <!-- Daftar Produk -->
  <h4>Daftar Produk</h4>
  <ul id="daftarProduk" class="list-group mb-5"></ul>

  <!-- Galeri Bukti Bayar -->
  <h4>Galeri Bukti Transfer</h4>
  <div id="galeri" class="d-flex flex-wrap"></div>

  <hr/>
  <h3>Form Testimoni Pelanggan</h3>
  <form id="formTestimoni" class="mb-3">
    <div class="mb-2">
      <input type="text" id="namaTesti" class="form-control" placeholder="Nama" required />
    </div>
    <div class="mb-2">
      <textarea id="isiTesti" class="form-control" rows="3" placeholder="Isi Testimoni" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Kirim Testimoni</button>
  </form>

  <h4>Daftar Testimoni</h4>
  <div id="testimoniList"></div>

  <hr/>
  <h3>Hapus Semua Data</h3>
  <div class="d-grid gap-2 d-md-block mb-5">
    <button class="btn btn-danger mb-2" onclick="hapusSemuaPesanan()">üßπ Hapus Semua Pesanan</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaProduk()">üßπ Hapus Semua Produk</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaGaleri()">üßπ Hapus Semua Bukti Transfer</button>
    <button class="btn btn-danger mb-2" onclick="hapusSemuaTestimoni()">üßπ Hapus Semua Testimoni</button>
    <button class="btn btn-dark" onclick="hapusSemuaData()">üî• Hapus SEMUA DATA</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
    authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
    databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
    projectId: "asdarstoredigitalll-d89c4",
    storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
    messagingSenderId: "220670500351",
    appId: "1:220670500351:web:5737ae5958a6f5a67d5bca",
    measurementId: "G-CMRW37J19G"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  const notifAPI = {
    appkey: "ab3727c5-e0be-40f9-bb3f-25d93b029f7a",
    authkey: "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq",
    nomorAdmin: "6281803004607"
  };

  let selectedId = null;
  let allDataPesanan = {};
  let allDataProduk = {};

  // Tampilkan daftar pesanan dengan filter status, kategori, dan search
  function tampilkanPesanan() {
    db.ref('pesanan').once('value').then(snapshot => {
      allDataPesanan = snapshot.val() || {};
      const filterStatus = document.getElementById('filterStatus').value;
      const filterKategori = document.getElementById('filterKategori').value;
      const search = document.getElementById('searchId').value.toLowerCase();
      let html = '';
      for (let id in allDataPesanan) {
        const p = allDataPesanan[id];
        if (filterStatus && p.status !== filterStatus) continue;
        if (filterKategori && p.kategori !== filterKategori) continue;
        if (search && !id.toLowerCase().includes(search)) continue;

        html += `
        <div class="card">
          <div class="card-body">
            <b>ID:</b> ${id}<br/>
            <b>Nama:</b> ${p.nama}<br/>
            <b>Nomor:</b> ${p.nomor || '-'}<br/>
            <b>Kategori:</b> ${p.kategori}<br/>
            <b>Produk:</b> ${p.produk}<br/>
            <b>Status:</b> ${p.status}<br/>
            ${p.buktiBayar ? `<b>Bukti Bayar:</b><br/><img src="${p.buktiBayar}" alt="Bukti Bayar" class="img-thumbnail mb-2" />` : ''}
            ${p.buktiAdmin ? `<b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" alt="Bukti Admin" class="img-thumbnail mb-2" />` : ''}
            <br/>
            <button class="btn btn-sm btn-warning" onclick="setSelected('${id}')">üì§ Kirim Bukti</button>
            <button class="btn btn-sm btn-success" onclick="verifikasi('${id}')">‚úÖ Proses</button>
            <button class="btn btn-sm btn-danger" onclick="hapusPesanan('${id}')">üóëÔ∏è Hapus</button>
          </div>
        </div>`;
      }
      document.getElementById('pesananList').innerHTML = html;
    });
  }

  // Set pesanan terpilih untuk upload bukti
  function setSelected(id) {
    selectedId = id;
    alert("Pesanan dipilih: " + id);
  }

  // Ubah status pesanan jadi Diproses & notif WA admin
  function verifikasi(id) {
    db.ref('pesanan/' + id).update({ status: "Diproses" }).then(() => {
      kirimNotifWA(`‚úÖ Pesanan ${id} sedang diproses.`);
      tampilkanPesanan();
    });
  }

  // Upload bukti admin ke imgbb lalu simpan URL & ubah status selesai
  async function uploadBukti() {
    const fileInput = document.getElementById('buktiAdmin');
    const file = fileInput.files[0];
    if (!file) return alert("‚ùó Pilih gambar terlebih dahulu!");
    if (!selectedId) return alert("‚ùó Pilih pesanan dulu!");

    const formData = new FormData();
    formData.append("image", file);
    const imgbbApiKey = "f71ccc1a662c9f8656766990018d3a33";

    try {
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
        method: "POST", body: formData
      });
      const json = await res.json();
      if (!json.success) throw new Error("Upload gagal");

      const imageUrl = json.data.url;
      await db.ref('pesanan/' + selectedId).update({ buktiAdmin: imageUrl, status: "Selesai" });

      kirimNotifWA(`‚úÖ Pesanan ${selectedId} selesai. Bukti terkirim ke pembeli.`);
      alert("‚úÖ Bukti berhasil dikirim.");
      selectedId = null;
      fileInput.value = "";
      tampilkanPesanan();
    } catch (err) {
      alert("‚ùå Upload Gagal: " + err.message);
    }
  }

  // Kirim notifikasi WA ke admin pakai apikey ngirimwa
  function kirimNotifWA(pesan) {
    fetch("https://starsender.online/api/sendText", {
      method: "POST",
      body: new URLSearchParams({
        appkey: notifAPI.appkey,
        authkey: notifAPI.authkey,
        to: notifAPI.nomorAdmin,
        message: pesan
      })
    });
  }

  // Export data pesanan ke CSV
  function exportCSV() {
    let csv = "ID,Nama,Nomor,Kategori,Produk,Status,Waktu\n";
    for (let id in allDataPesanan) {
      const p = allDataPesanan[id];
      csv += `"${id}","${p.nama}","${p.nomor || ''}","${p.kategori}","${p.produk}","${p.status}","${p.waktu || ''}"\n`;
    }
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pesanan.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Tampilkan daftar produk
  function tampilkanProduk() {
    db.ref('produk').once('value').then(snapshot => {
      allDataProduk = snapshot.val() || {};
      const list = document.getElementById('daftarProduk');
      list.innerHTML = "";
      for (const kategori in allDataProduk) {
        for (const varian in allDataProduk[kategori]) {
          const p = allDataProduk[kategori][varian];
          const li = document.createElement('li');
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            <div>
              <b>${kategori} > ${varian}</b><br/>
              Harga: Rp${p.harga}<br/>
              ${p.cara}
            </div>
            <button class="btn btn-sm btn-danger" onclick="hapusProduk('${kategori}','${varian}')">üóëÔ∏è Hapus</button>
          `;
          list.appendChild(li);
        }
      }
      // Update filter kategori produk di dropdown filterKategori
      updateFilterKategori();
    });
  }

  // Hapus produk berdasarkan kategori dan varian
  function hapusProduk(kategori, varian) {
    if (confirm(`Hapus produk ${varian} dari kategori ${kategori}?`)) {
      db.ref(`produk/${kategori}/${varian}`).remove().then(() => {
        alert("‚úÖ Produk dihapus.");
        tampilkanProduk();
      });
    }
  }

  // Update dropdown filter kategori produk berdasarkan produk yg ada
  function updateFilterKategori() {
    const filterKategori = document.getElementById('filterKategori');
    const kategoriSet = new Set();
    for (const kategori in allDataProduk) {
      kategoriSet.add(kategori);
    }
    // Clear existing options kecuali opsi default
    filterKategori.innerHTML = '<option value="">Filter Semua Kategori</option>';
    kategoriSet.forEach(kat => {
      const opt = document.createElement('option');
      opt.value = kat;
      opt.textContent = kat;
      filterKategori.appendChild(opt);
    });
  }

  // Tampilkan galeri bukti transfer dari semua pesanan
  function tampilkanGaleri() {
    db.ref('pesanan').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const galeri = document.getElementById('galeri');
      galeri.innerHTML = "";
      for (const id in data) {
        if (data[id].buktiBayar) {
          const img = document.createElement('img');
          img.src = data[id].buktiBayar;
          img.alt = "Bukti Bayar " + id;
          galeri.appendChild(img);
        }
      }
    });
  }

  // Hapus semua data pesanan
  function hapusSemuaPesanan() {
    if (confirm("Yakin ingin menghapus SEMUA pesanan?")) {
      db.ref('pesanan').remove().then(() => {
        alert("‚úÖ Semua pesanan dihapus.");
        tampilkanPesanan();
        tampilkanGaleri();
        tampilkanTestimoni();
      });
    }
  }

  // Hapus semua produk
  function hapusSemuaProduk() {
    if (confirm("Yakin ingin menghapus SEMUA produk?")) {
      db.ref('produk').remove().then(() => {
        alert("‚úÖ Semua produk dihapus.");
        tampilkanProduk();
        updateFilterKategori();
      });
    }
  }

  // Hapus semua bukti transfer di galeri (hapus field buktiBayar pada pesanan)
  function hapusSemuaGaleri() {
    if (confirm("Yakin ingin menghapus SEMUA bukti transfer dari galeri?")) {
      db.ref('pesanan').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        const promises = [];
        for (const id in data) {
          promises.push(db.ref(`pesanan/${id}/buktiBayar`).remove());
        }
        Promise.all(promises).then(() => {
          alert("‚úÖ Semua bukti transfer dihapus.");
          tampilkanGaleri();
          tampilkanPesanan();
        });
      });
    }
  }

  // Hapus semua testimoni
  function hapusSemuaTestimoni() {
    if (confirm("Yakin ingin menghapus SEMUA testimoni?")) {
      db.ref('testimoni').remove().then(() => {
        alert("‚úÖ Semua testimoni dihapus.");
        tampilkanTestimoni();
      });
    }
  }

  // Hapus semua data (pesanan + produk + bukti + testimoni)
  function hapusSemuaData() {
    if (confirm("Yakin HAPUS SEMUA DATA PESANAN + PRODUK + BUKTI + TESTIMONI?")) {
      db.ref().remove().then(() => {
        alert("üî• SEMUA DATA telah dihapus.");
        tampilkanPesanan();
        tampilkanProduk();
        tampilkanGaleri();
        tampilkanTestimoni();
      });
    }
  }

  // --- Form Produk submit event ---
  document.getElementById('formProduk').addEventListener('submit', function(e) {
    e.preventDefault();
    const kategori = document.getElementById('kategori').value.trim();
    const varian = document.getElementById('varian').value.trim();
    const harga = parseInt(document.getElementById('harga').value);
    const cara = document.getElementById('cara').value.trim();
    if (!kategori || !varian || !harga || !cara) {
      return alert("‚ùó Semua field wajib diisi.");
    }
    db.ref(`produk/${kategori}/${varian}`).set({ harga, cara }).then(() => {
      alert("‚úÖ Produk berhasil ditambahkan.");
      this.reset();
      tampilkanProduk();
    });
  });

  // --- Form Testimoni pelanggan ---
  document.getElementById('formTestimoni').addEventListener('submit', function(e) {
    e.preventDefault();
    const nama = document.getElementById('namaTesti').value.trim();
    const isi = document.getElementById('isiTesti').value.trim();
    if (!nama || !isi) return alert("‚ùó Nama dan isi testimoni wajib diisi.");
    const idTesti = "testi_" + Date.now();
    db.ref(`testimoni/${idTesti}`).set({ nama, isi, waktu: new Date().toISOString() }).then(() => {
      alert("‚úÖ Testimoni berhasil dikirim.");
      this.reset();
      tampilkanTestimoni();
    });
  });

  // Tampilkan testimoni live dari Firebase
  function tampilkanTestimoni() {
    db.ref('testimoni').once('value').then(snapshot => {
      const testiData = snapshot.val() || {};
      const testiList = document.getElementById('testimoniList');
      testiList.innerHTML = "";
      for (const id in testiData) {
        const t = testiData[id];
        const div = document.createElement('div');
        div.className = "testimoni-card";
        div.innerHTML = `<b>${t.nama}</b> <small>${new Date(t.waktu).toLocaleString()}</small><br/>${t.isi}`;
        testiList.appendChild(div);
      }
    });
  }

  // --- Event listeners untuk filter dan search ---
  document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
  document.getElementById('filterKategori').addEventListener('change', tampilkanPesanan);
  document.getElementById('searchId').addEventListener('input', tampilkanPesanan);
  document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
  document.getElementById('uploadBuktiBtn').addEventListener('click', uploadBukti);

  // Inisialisasi halaman
  tampilkanPesanan();
  tampilkanProduk();
  tampilkanGaleri();
  tampilkanTestimoni();

</script>
</body>
</html>
