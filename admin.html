<!DOCTYPE html><html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 15px; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Admin - Asdar Store</h1>
    <div class="row text-center mb-3">
      <div class="col"><div class="card p-2 bg-info text-white">Total Pesanan<br/><b id="statPesanan"></b></div></div>
      <div class="col"><div class="card p-2 bg-success text-white">Selesai<br/><b id="statSelesai"></b></div></div>
      <div class="col"><div class="card p-2 bg-warning text-white">Diproses<br/><b id="statProses"></b></div></div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <select id="filterStatus" class="form-select">
          <option value="">Filter Semua Status</option>
          <option value="Belum Bayar">Belum Bayar</option>
          <option value="Sudah Bayar">Sudah Bayar</option>
          <option value="Diproses">Diproses</option>
          <option value="Selesai">Selesai</option>
        </select>
      </div>
      <div class="col-md-4">
        <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan" />
      </div>
      <div class="col-md-4">
        <button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button>
      </div>
    </div>
    <div id="pesananList"></div>
    <h3>Upload Bukti Admin ke Pembeli</h3>
    <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*" />
    <button id="uploadBuktiBtn" class="btn btn-primary mb-4">Kirim Bukti & Selesaikan</button>
    <hr>
    <h3>Tambah / Edit Produk</h3>
    <form id="formProduk" class="row g-3 mb-4">
      <div class="col-md-3"><input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required /></div>
      <div class="col-md-3"><input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required /></div>
      <div class="col-md-2"><input type="number" id="harga" class="form-control" placeholder="Harga (Rp)" required /></div>
      <div class="col-md-4"><input type="text" id="cara" class="form-control" placeholder="Keterangan / Cara Beli" required /></div>
      <div class="col-12"><button type="submit" class="btn btn-success">Simpan / Edit Produk</button></div>
    </form>
    <h4>Daftar Produk</h4>
    <ul id="daftarProduk" class="list-group mb-5"></ul>
    <h4>Galeri Bukti Transfer</h4>
    <div id="galeri" class="d-flex flex-wrap"></div>
    <hr/>
    <h3>Hapus Semua Data</h3>
    <div class="d-grid gap-2 d-md-block mb-5">
      <button class="btn btn-danger mb-2" onclick="hapusSemuaPesanan()">🧹 Hapus Semua Pesanan</button>
      <button class="btn btn-danger mb-2" onclick="hapusSemuaProduk()">🧹 Hapus Semua Produk</button>
      <button class="btn btn-danger mb-2" onclick="hapusSemuaGaleri()">🧹 Hapus Semua Bukti Transfer</button>
      <button class="btn btn-dark mb-2" onclick="hapusSemuaData()">🔥 Hapus SEMUA DATA</button>
      <button class="btn btn-warning mb-2" onclick="hapusPerKategoriStatus()">🗃️ Hapus Per Kategori Status</button>
    </div>
    <h3>Perintah Buat / Hapus Fitur</h3>
    <textarea id="fiturBaru" class="form-control mb-2" placeholder="Masukkan perintah buat/hapus fitur"></textarea>
    <button class="btn btn-secondary" onclick="tampilkanPerintah()">📌 Simpan & Tampilkan di Web</button>
    <ul id="daftarFitur" class="mt-3 list-group"></ul>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
  authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
  databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
  projectId: "asdarstoredigitalll-d89c4",
  storageBucket: "asdarstoredigitalll.appspot.com",
  messagingSenderId: "220670500351",
  appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ngirimwaAPI = {
  url: "https://ngirimwa.vercel.app/api/send-message",
  nomorAdmin: "6281803004607" // ganti sesuai nomor admin kamu
};

let selectedId = null;
let allDataPesanan = {};

// --- Statistik Pesanan ---
function tampilkanStatistik() {
  db.ref('pesanan').once('value').then(snap => {
    const data = snap.val() || {};
    let total = 0, selesai = 0, diproses = 0;
    for (let id in data) {
      total++;
      if (data[id].status === 'Selesai') selesai++;
      if (data[id].status === 'Diproses') diproses++;
    }
    document.getElementById('statPesanan').innerText = total;
    document.getElementById('statSelesai').innerText = selesai;
    document.getElementById('statProses').innerText = diproses;
  });
}

// --- Tampilkan Pesanan ---
function tampilkanPesanan() {
  db.ref('pesanan').once('value').then(snapshot => {
    allDataPesanan = snapshot.val() || {};
    const filter = document.getElementById('filterStatus').value;
    const search = document.getElementById('searchId').value.toLowerCase();
    let html = '';
    for (let id in allDataPesanan) {
      const p = allDataPesanan[id];
      if (filter && p.status !== filter) continue;
      if (search && !id.toLowerCase().includes(search)) continue;
      html += `<div class="card"><div class="card-body">
        <b>ID:</b> ${id}<br/>
        <b>Nama:</b> ${p.nama || '-'}<br/>
        <b>Nomor HP / ID SN:</b> ${p.nomor || '-'}<br/>
        <b>Kategori:</b> ${p.kategori || '-'}<br/>
        <b>Produk:</b> ${p.produk || '-'}<br/>
        <b>Status:</b> ${p.status || '-'}<br/>
        <b>Waktu:</b> ${p.waktu || '-'}<br/>
        ${p.buktiBayar ? `<b>Bukti Pembeli:</b><br/><img src="${p.buktiBayar}" alt="Bukti Bayar" />` : ''}
        ${p.buktiAdmin ? `<br/><b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" alt="Bukti Admin" />` : ''}
        <br/>
        <button class="btn btn-warning btn-sm" onclick="setSelected('${id}')">📤 Pilih Pesanan</button>
        <button class="btn btn-info btn-sm" onclick="updateStatus('${id}','Diproses')">✅ Proses</button>
        <button class="btn btn-danger btn-sm" onclick="hapusPesanan('${id}')">🗑️ Hapus</button>
      </div></div>`;
    }
    document.getElementById('pesananList').innerHTML = html;
    tampilkanStatistik();
  });
}

// --- Set Pesanan yang dipilih untuk upload bukti admin ---
function setSelected(id) {
  selectedId = id;
  alert("Pesanan dipilih: " + id);
}

// --- Update status pesanan ---
function updateStatus(id, status) {
  db.ref('pesanan/' + id).update({ status }).then(() => {
    kirimNotifWA(`✅ Pesanan ${id} status diubah ke ${status}.`);
    tampilkanPesanan();
  });
}

// --- Upload Bukti Admin dan kirim notif ke pembeli + admin ---
async function uploadBukti() {
  const fileInput = document.getElementById('buktiAdmin');
  const file = fileInput.files[0];
  if (!file) return alert("❗ Pilih gambar bukti dulu!");
  if (!selectedId) return alert("❗ Pilih pesanan terlebih dahulu!");

  const formData = new FormData();
  formData.append("image", file);

  const imgbbApiKey = "f71ccc1a662c9f8656766990018d3a33";
  try {
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
      method: "POST", body: formData
    });
    const json = await res.json();
    if (!json.success) throw new Error("Upload gagal");

    const imageUrl = json.data.url;
    await db.ref('pesanan/' + selectedId).update({ buktiAdmin: imageUrl, status: 'Selesai' });

    // Kirim notifikasi WA ke pembeli dan admin
    const pesanan = allDataPesanan[selectedId];
    if (pesanan && pesanan.nomor) {
      const waMessageBuyer = `✅ Pesanan Anda (${selectedId}) sudah selesai.\nCek status di: ${window.location.origin}/status.html?nomor=${encodeURIComponent(pesanan.nomor)}`;
      await kirimNotifWA(waMessageBuyer, pesanan.nomor);
    }
    const waMessageAdmin = `✅ Pesanan ${selectedId} selesai, bukti admin terkirim.`;
    await kirimNotifWA(waMessageAdmin, ngirimwaAPI.nomorAdmin);

    alert("✅ Bukti berhasil dikirim dan status selesai.");
    selectedId = null;
    fileInput.value = "";
    tampilkanPesanan();
    tampilkanGaleri();
  } catch (e) {
    alert("❌ Upload gambar gagal: " + e.message);
  }
}

// --- Hapus Pesanan ---
function hapusPesanan(id) {
  if (confirm("Yakin ingin menghapus pesanan ini?")) {
    db.ref('pesanan/' + id).remove().then(() => {
      alert("✅ Pesanan dihapus.");
      tampilkanPesanan();
      tampilkanGaleri();
    });
  }
}

// --- Export CSV ---
function exportCSV() {
  let csv = "ID,Nama,Nomor,Kategori,Produk,Status,Waktu\n";
  for (let id in allDataPesanan) {
    const p = allDataPesanan[id];
    csv += `"${id}","${p.nama || ''}","${p.nomor || ''}","${p.kategori || ''}","${p.produk || ''}","${p.status || ''}","${p.waktu || ''}"\n`;
  }
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pesanan.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// --- Tampilkan Produk ---
function tampilkanProduk() {
  db.ref('produk').once('value').then(snapshot => {
    const produk = snapshot.val() || {};
    const list = document.getElementById('daftarProduk');
    list.innerHTML = "";
    for (const kategori in produk) {
      for (const varian in produk[kategori]) {
        const p = produk[kategori][varian];
        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<div><b>${kategori} > ${varian}</b><br/>Harga: Rp${p.harga} - ${p.cara}</div>
          <button class="btn btn-danger btn-sm" onclick="hapusProduk('${kategori}','${varian}')">🗑️ Hapus</button>`;
        list.appendChild(li);
      }
    }
  });
}

// --- Hapus Produk ---
function hapusProduk(kategori, varian) {
  if (confirm("Yakin ingin menghapus produk ini?")) {
    db.ref(`produk/${kategori}/${varian}`).remove().then(() => {
      alert("✅ Produk dihapus.");
      tampilkanProduk();
    });
  }
}

// --- Simpan / Edit Produk ---
document.getElementById('formProduk').addEventListener('submit', function(e) {
  e.preventDefault();
  const kategori = document.getElementById('kategori').value.trim();
  const varian = document.getElementById('varian').value.trim();
  const harga = parseInt(document.getElementById('harga').value);
  const cara = document.getElementById('cara').value.trim();
  if (!kategori || !varian || !harga || !cara) return alert("Semua field wajib diisi.");
  db.ref(`produk/${kategori}/${varian}`).set({ harga, cara }).then(() => {
    alert("✅ Produk disimpan.");
    this.reset();
    tampilkanProduk();
  });
});

// --- Tampilkan Galeri Bukti Bayar ---
function tampilkanGaleri() {
  db.ref('pesanan').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    const galeri = document.getElementById('galeri');
    galeri.innerHTML = "";
    for (const id in data) {
      if (data[id].buktiBayar) {
        const img = document.createElement('img');
        img.src = data[id].buktiBayar;
        img.alt = "Bukti Bayar " + id;
        galeri.appendChild(img);
      }
    }
  });
}

// --- Kirim Notifikasi WA via NgirimWA ---
async function kirimNotifWA(message, nomor) {
  // nomor default ke admin kalau tidak ada nomor pembeli
  const tujuan = nomor || ngirimwaAPI.nomorAdmin;
  try {
    await fetch(ngirimwaAPI.url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nomor: tujuan, pesan: message })
    });
  } catch (e) {
    console.error("Gagal kirim notifikasi WA:", e);
  }
}

// --- Hapus Semua Pesanan ---
function hapusSemuaPesanan() {
  if (confirm("Yakin ingin menghapus SEMUA pesanan?")) {
    db.ref('pesanan').remove().then(() => {
      alert("✅ Semua pesanan dihapus.");
      tampilkanPesanan();
      tampilkanGaleri();
    });
  }
}

// --- Hapus Semua Produk ---
function hapusSemuaProduk() {
  if (confirm("Yakin ingin menghapus SEMUA produk?")) {
    db.ref('produk').remove().then(() => {
      alert("✅ Semua produk dihapus.");
      tampilkanProduk();
    });
  }
}

// --- Hapus Semua Bukti Bayar ---
function hapusSemuaGaleri() {
  if (confirm("Yakin ingin menghapus SEMUA bukti transfer dari galeri?")) {
    db.ref('pesanan').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      let updates = {};
      for (const id in data) {
        updates[`pesanan/${id}/buktiBayar`] = null;
      }
      return db.ref().update(updates);
    }).then(() => {
      alert("✅ Semua bukti transfer dihapus.");
      tampilkanGaleri();
    });
  }
}

// --- Hapus Semua Data ---
function hapusSemuaData() {
  if (confirm("Yakin HAPUS SEMUA DATA PESANAN + PRODUK + BUKTI?")) {
    db.ref().remove().then(() => {
      alert("🔥 SEMUA DATA telah dihapus.");
      tampilkanPesanan();
      tampilkanProduk();
      tampilkanGaleri();
    });
  }
}

// --- Hapus Per Kategori Status (contoh hapus pesanan per status tertentu) ---
function hapusPerKategoriStatus() {
  const status = prompt("Masukkan status pesanan yang ingin dihapus (contoh: Belum Bayar, Sudah Bayar, Diproses, Selesai):");
  if (!status) return alert("❗ Status tidak boleh kosong.");
  if (!confirm(`Yakin ingin menghapus semua pesanan dengan status "${status}"?`)) return;

  db.ref('pesanan').once('value').then(snapshot => {
    const data = snapshot.val() || {};
    let updates = {};
    let count = 0;
    for (const id in data) {
      if (data[id].status === status) {
        updates[id] = null;
        count++;
      }
    }
    if (count === 0) return alert("Tidak ada pesanan dengan status tersebut.");
    return db.ref('pesanan').update(updates).then(() => {
      alert(`✅ ${count} pesanan dengan status "${status}" dihapus.`);
      tampilkanPesanan();
      tampilkanGaleri();
    });
  });
}

// --- Perintah Dinamis Buat / Hapus Fitur ---
function tampilkanPerintah() {
  const perintah = document.getElementById('fiturBaru').value.trim();
  if (!perintah) return alert("Masukkan perintah terlebih dahulu.");
  let daftarFitur = JSON.parse(localStorage.getItem('daftarFiturAsdar') || "[]");

  if (perintah.toLowerCase().startsWith("buat fitur ")) {
    const fitur = perintah.substring(11).trim();
    if (daftarFitur.includes(fitur)) return alert("Fitur sudah ada.");
    daftarFitur.push(fitur);
    alert(`✅ Fitur "${fitur}" berhasil dibuat dan tampil di halaman.`);
  } else if (perintah.toLowerCase().startsWith("hapus fitur ")) {
    const fitur = perintah.substring(12).trim();
    const index = daftarFitur.indexOf(fitur);
    if (index === -1) return alert("Fitur tidak ditemukan.");
    daftarFitur.splice(index, 1);
    alert(`✅ Fitur "${fitur}" berhasil dihapus dari halaman.`);
  } else {
    return alert("Perintah tidak dikenali. Gunakan: buat fitur [nama fitur] atau hapus fitur [nama fitur]");
  }
  localStorage.setItem('daftarFiturAsdar', JSON.stringify(daftarFitur));
  renderDaftarFitur();
  document.getElementById('fiturBaru').value = "";
}

function renderDaftarFitur() {
  let daftarFitur = JSON.parse(localStorage.getItem('daftarFiturAsdar') || "[]");
  const ul = document.getElementById('daftarFitur');
  ul.innerHTML = "";
  daftarFitur.forEach(fitur => {
    const li = document.createElement('li');
    li.className = "list-group-item";
    li.textContent = fitur;
    ul.appendChild(li);
  });
}

// --- Inisialisasi Semua ---
document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
document.getElementById('searchId').addEventListener('input', tampilkanPesanan);
document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
document.getElementById('uploadBuktiBtn').addEventListener('click', uploadBukti);

tampilkanPesanan();
tampilkanProduk();
tampilkanGaleri();
renderDaftarFitur();
</script>
</body>
</html>
