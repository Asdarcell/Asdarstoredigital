<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; background-color: #f5f5f5; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 20px; }
    img { max-width: 100px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard Admin - Asdar Store</h1>

    <!-- LOGIN -->
    <div id="loginSection">
      <input type="password" id="adminPass" class="form-control mb-2" placeholder="Masukkan Password Admin">
      <button onclick="loginAdmin()" class="btn btn-primary">Login</button>
    </div>

    <!-- ADMIN PANEL -->
    <div id="mainSection" style="display:none">
      <!-- FILTER -->
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="filterStatus" class="form-select">
            <option value="">Filter Semua Status</option>
            <option value="Belum Bayar">Belum Bayar</option>
            <option value="Sudah Bayar">Sudah Bayar</option>
            <option value="Diproses">Diproses</option>
            <option value="Selesai">Selesai</option>
          </select>
        </div>
        <div class="col-md-4">
          <input id="searchId" type="text" class="form-control" placeholder="Cari ID Pesanan" />
        </div>
        <div class="col-md-4">
          <button onclick="exportCSV()" class="btn btn-success w-100">Export CSV</button>
        </div>
      </div>

      <!-- PESANAN -->
      <div id="pesananList"></div>

      <!-- UPLOAD BUKTI -->
      <h3>Upload Bukti Admin ke Pembeli</h3>
      <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*">
      <button onclick="uploadBukti()" class="btn btn-primary">Kirim Bukti & Selesaikan</button>

      <hr>

      <!-- TAMBAH PRODUK -->
      <h3>Tambah / Edit Produk</h3>
      <form id="formProduk" class="row g-3">
        <div class="col-md-3">
          <input type="text" id="kategori" class="form-control" placeholder="Kategori Produk" required>
        </div>
        <div class="col-md-3">
          <input type="text" id="varian" class="form-control" placeholder="Varian / Nama Produk" required>
        </div>
        <div class="col-md-2">
          <input type="number" id="harga" class="form-control" placeholder="Harga (Rp)" required>
        </div>
        <div class="col-md-4">
          <input type="text" id="cara" class="form-control" placeholder="Keterangan/Cara Beli" required>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Simpan / Edit Produk</button>
        </div>
      </form>

      <!-- DAFTAR PRODUK -->
      <h4 class="mt-4">Daftar Produk</h4>
      <ul id="daftarProduk" class="list-group"></ul>

      <!-- GALERI -->
      <h4 class="mt-5">Galeri Bukti Transfer</h4>
      <div id="galeri" class="row"></div>
    </div>
  </div>

  <!-- FIREBASE & SCRIPT FINAL -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const adminPassword = "asdar123";
    const imgbbApiKey = "f71ccc1a662c9f8656766990018d3a33";

    let selectedId = null;
    let allData = {};

    function loginAdmin() {
      const pass = document.getElementById('adminPass').value;
      if (pass === adminPassword) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';
        tampilkanPesanan();
        tampilkanProduk();
        tampilkanGaleri();
      } else {
        alert('‚ùå Password salah');
      }
    }

    function tampilkanPesanan() {
      db.ref('pesanan').on('value', snapshot => {
        allData = snapshot.val() || {};
        const filter = document.getElementById('filterStatus').value;
        const search = document.getElementById('searchId').value.toLowerCase();
        let html = '';

        for (let id in allData) {
          const p = allData[id];
          if (filter && p.status !== filter) continue;
          if (search && !id.includes(search)) continue;

          html += `
            <div class="card">
              <div class="card-body">
                <b>ID:</b> ${id}<br>
                <b>Nama:</b> ${p.nama}<br>
                <b>Produk:</b> ${p.produk}<br>
                <b>Status:</b> ${p.status}<br>
                <b>Waktu:</b> ${p.waktu || '-'}<br>
                ${p.buktiBayar ? `<b>Bukti Pembeli:</b><br><img src="${p.buktiBayar}" />` : ''}
                ${p.buktiAdmin ? `<br><b>Bukti Admin:</b><br><img src="${p.buktiAdmin}" />` : ''}
                <br>
                <button class="btn btn-warning btn-sm" onclick="setSelected('${id}')">üì§ Kirim Bukti</button>
                <button class="btn btn-info btn-sm" onclick="verifikasi('${id}')">‚úÖ Proses</button>
                <button class="btn btn-danger btn-sm" onclick="hapusPesanan('${id}')">üóëÔ∏è Hapus</button>
              </div>
            </div>
          `;
        }

        document.getElementById('pesananList').innerHTML = html;
      });
    }

    function setSelected(id) {
      selectedId = id;
      alert("Dipilih: " + id);
    }

    function verifikasi(id) {
      db.ref('pesanan/' + id).update({ status: 'Diproses' });
      simpanRiwayat(id, 'Diproses');
      kirimNotifWA(`‚úÖ Pesanan ${id} sedang diproses.`);
    }

    async function uploadBukti() {
      const file = document.getElementById('buktiAdmin').files[0];
      if (!file || !selectedId) return alert('‚ùó Pilih pesanan & gambar dulu!');

      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      const imageUrl = json.data.url;

      await db.ref('pesanan/' + selectedId).update({
        buktiAdmin: imageUrl,
        status: 'Selesai'
      });

      simpanRiwayat(selectedId, 'Selesai');
      kirimNotifWA(`‚úÖ Pesanan ${selectedId} telah selesai dan bukti telah dikirim.`);
      alert('‚úÖ Bukti terkirim dan status selesai.');
      selectedId = null;
    }

    function exportCSV() {
      let csv = 'ID,Nama,Produk,Status,Waktu\n';
      for (let id in allData) {
        const p = allData[id];
        csv += `${id},${p.nama},${p.produk},${p.status},${p.waktu || ''}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pesanan.csv';
      a.click();
    }

    function hapusPesanan(id) {
      if (confirm('Yakin hapus pesanan ini?')) {
        db.ref('pesanan/' + id).remove();
        alert('‚úÖ Pesanan dihapus.');
      }
    }

    function simpanRiwayat(id, statusBaru) {
      const waktu = new Date().toLocaleString();
      db.ref(`riwayat/${id}`).push({ status: statusBaru, waktu });
    }

    function tampilkanProduk() {
      db.ref('produk').on('value', snap => {
        const data = snap.val() || {};
        const list = document.getElementById('daftarProduk');
        list.innerHTML = '';
        for (let kat in data) {
          for (let varian in data[kat]) {
            const p = data[kat][varian];
            const li = document.createElement('li');
            li.className = "list-group-item";
            li.innerHTML = `
              <b>${kat} > ${varian}</b><br>
              Harga: Rp${p.harga} - ${p.cara}<br>
              <button class="btn btn-sm btn-danger" onclick="hapusProduk('${kat}','${varian}')">üóëÔ∏è Hapus</button>
            `;
            list.appendChild(li);
          }
        }
      });
    }

    function hapusProduk(kat, varian) {
      if (confirm('Hapus produk ini?')) {
        db.ref(`produk/${kat}/${varian}`).remove();
      }
    }

    document.getElementById('formProduk').addEventListener('submit', function (e) {
      e.preventDefault();
      const kategori = document.getElementById('kategori').value;
      const varian = document.getElementById('varian').value;
      const harga = document.getElementById('harga').value;
      const cara = document.getElementById('cara').value;
      db.ref(`produk/${kategori}/${varian}`).set({ harga, cara });
      alert('‚úÖ Produk disimpan.');
      this.reset();
    });

    function tampilkanGaleri() {
      db.ref('pesanan').once('value').then(snap => {
        const data = snap.val() || {};
        const galeri = document.getElementById('galeri');
        galeri.innerHTML = '';
        for (let id in data) {
          if (data[id].buktiBayar) {
            const img = document.createElement('img');
            img.src = data[id].buktiBayar;
            img.className = "col-3 mb-2";
            galeri.appendChild(img);
          }
        }
      });
    }

    function kirimNotifWA(pesan) {
      fetch("https://starsender.online/api/sendText", {
        method: "POST",
        body: new URLSearchParams({
          appkey: "ab3727c5-e0be-40f9-bb3f-25d93b029f7a",
          authkey: "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq",
          to: "6281803004607",
          message: pesan
        })
      });
    }

    document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
    document.getElementById('searchId').addEventListener('input', tampilkanPesanan);
  </script>
</body>
</html>
