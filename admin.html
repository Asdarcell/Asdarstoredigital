<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Asdar Store Digital</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --bg: #f2f4f8; --text: #34495e; --primary: #2980b9;
            --card: #ffffff; --border: #e0e0e0; --shadow: rgba(0, 0, 0, 0.08);
            --success: #27ae60; --danger: #e74c3c; --warning: #f39c12;
            --info: #3498db; --secondary-text: #7f8c8d;
        }
        [data-theme="dark"] {
            --bg: #2c3e50; --text: #ecf0f1; --primary: #3498db;
            --card: #34495e; --border: #4a627d; --shadow: rgba(0, 0, 0, 0.2);
            --success: #2ecc71; --danger: #e74c3c; --warning: #f1c40f;
            --info: #3498db; --secondary-text: #bdc3c7;
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease; margin: 0; line-height: 1.6;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        header {
            background: var(--primary); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        header h1 { margin: 0; font-size: 24px; }
        .logout-btn { background: none; border: none; color: white; font-weight: 600; cursor: pointer; padding: 8px 15px; border-radius: 5px; transition: background-color 0.3s ease; }
        .logout-btn:hover { background-color: rgba(255,255,255,0.2); }

        .container-fluid {
            flex: 1;
            display: flex;
            padding: 20px;
        }
        .sidebar {
            width: 250px;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow);
            margin-right: 20px;
            position: sticky;
            top: 80px; /* Adjust based on header height */
            height: calc(100vh - 100px); /* Fill remaining viewport height */
            overflow-y: auto;
        }
        .sidebar button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            text-align: left;
            background-color: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .sidebar button.active, .sidebar button:hover {
            background-color: var(--primary);
            color: white;
        }
        .sidebar button i { margin-right: 10px; }

        .content {
            flex: 1;
            background: var(--card);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow);
        }
        h2 { color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        label { font-weight: 600; margin-top: 15px; display: block; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 15px;
            border-radius: 8px; border: 1px solid var(--border); background-color: var(--bg); color: var(--text);
        }
        button[type="submit"], .btn-primary {
            padding: 10px 20px; border-radius: 8px; border: none;
            background: var(--primary); color: white; cursor: pointer;
            font-weight: bold; font-size: 16px; transition: all 0.2s ease;
        }
        button[type="submit"]:hover, .btn-primary:hover { opacity: 0.9; }
        button[type="submit"]:disabled, .btn-primary:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid var(--border); text-align: left; vertical-align: middle; }
        .data-table th { background-color: var(--bg); font-weight: 600; }
        .data-table tr:nth-child(even) { background-color: var(--bg); }
        .data-table tr:hover { background-color: rgba(var(--primary), 0.1); }
        .action-buttons button { margin-right: 5px; padding: 6px 12px; font-size: 0.9em; border-radius: 5px; }
        .btn-success { background-color: var(--success); color: white; border: none; }
        .btn-danger { background-color: var(--danger); color: white; border: none; }
        .btn-warning { background-color: var(--warning); color: var(--text); border: none; }
        .btn-info { background-color: var(--info); color: white; border: none; }
        .btn-secondary { background-color: var(--secondary-text); color: white; border: none; }

        .notification {
            padding: 15px; margin-bottom: 15px; border-radius: 8px;
            font-weight: 600; display: none; text-align: center;
        }
        .notification.info { background-color: #d1ecf1; color: #0c5460; }
        .notification.success { background-color: #d4edda; color: #155724; }
        .notification.error { background-color: #f8d7da; color: #721c24; }
        .form-group { margin-bottom: 15px; }
        .flex-container { display: flex; gap: 15px; }
        .flex-item { flex: 1; }

        /* Detail Pesanan Admin */
        .order-detail-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        .order-detail-card p {
            margin-bottom: 8px;
        }
        .order-detail-card strong {
            color: var(--primary);
        }
        .bukti-transfer-img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
    </style>
</head>
<body data-theme="dark">
    <header>
        <h1>Admin Dashboard</h1>
        <button id="logout-btn" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Keluar
        </button>
    </header>

    <div class="container-fluid">
        <aside class="sidebar">
            <button class="nav-btn active" data-target="dashboard-section"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="nav-btn" data-target="product-management-section"><i class="fas fa-box"></i> Manajemen Produk</button>
            <button class="nav-btn" data-target="topup-requests-section"><i class="fas fa-money-bill-transfer"></i> Permintaan Top Up</button>
            <button class="nav-btn" data-target="general-orders-section"><i class="fas fa-shopping-cart"></i> Pesanan Umum</button>
            <button class="nav-btn" data-target="reseller-orders-section"><i class="fas fa-user-tie"></i> Pesanan Reseller</button>
            <button class="nav-btn" data-target="discount-rights-section"><i class="fas fa-tags"></i> Hak Diskon</button>
            <button class="nav-btn" data-target="testimonial-management-section"><i class="fas fa-comment-alt"></i> Testimoni</button>
            <button class="nav-btn" data-target="faq-management-section"><i class="fas fa-question-circle"></i> Manajemen FAQ</button>
            <button class="nav-btn" data-target="payment-info-section"><i class="fas fa-credit-card"></i> Info Pembayaran</button>
        </aside>

        <main class="content">
            <section id="dashboard-section" class="content-section active">
                <h2>Dashboard Admin</h2>
                <div class="notification info" style="display: block;">
                    Selamat datang di Dashboard Admin. Pilih menu di samping untuk mengelola data.
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="info text-center">
                            <h3>Total Produk</h3>
                            <p id="totalProducts">0</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info text-center">
                            <h3>Permintaan Top Up Pending</h3>
                            <p id="pendingTopups">0</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info text-center">
                            <h3>Pesanan Umum Pending</h3>
                            <p id="pendingGeneralOrders">0</p>
                        </div>
                    </div>
                </div>
                <h3 class="mt-4">Statistik Singkat</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info">
                            <h5>Top 5 Produk Terlaris (Berdasarkan Pesanan Umum)</h5>
                            <ul id="topProductsList">
                                <li>Memuat...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info">
                            <h5>5 Reseller dengan Saldo Tertinggi</h5>
                            <ul id="topResellersList">
                                <li>Memuat...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="product-management-section" class="content-section">
                <h2>Manajemen Produk</h2>
                <div id="product-notification" class="notification"></div>
                <form id="product-form">
                    <input type="hidden" id="productId" />
                    <div class="form-group">
                        <label for="productName">Nama Produk</label>
                        <input type="text" id="productName" required />
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Kategori</label>
                        <input type="text" id="productCategory" required />
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Deskripsi</label>
                        <textarea id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="flex-container">
                        <div class="form-group flex-item">
                            <label for="productGeneralPrice">Harga Umum</label>
                            <input type="number" id="productGeneralPrice" required min="0" />
                        </div>
                        <div class="form-group flex-item">
                            <label for="productResellerPrice">Harga Reseller</label>
                            <input type="number" id="productResellerPrice" required min="0" />
                        </div>
                    </div>
                    <div class="flex-container">
                        <div class="form-group flex-item">
                            <label for="productStock">Stok</label>
                            <input type="number" id="productStock" required min="0" />
                        </div>
                        <div class="form-group flex-item">
                            <label for="productOrder">Urutan</label>
                            <input type="number" id="productOrder" value="0" min="0" />
                            <small class="text-muted">Produk dengan urutan lebih kecil akan muncul lebih dulu.</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Promo Produk (Opsional)</label>
                        <select id="promoType" class="form-select">
                            <option value="">Tidak ada Promo</option>
                            <option value="nominal">Potongan Nominal</option>
                            <option value="percentage">Diskon Persentase</option>
                        </select>
                    </div>
                    <div class="form-group" id="promoValueGroup" style="display: none;">
                        <label for="promoValue">Nilai Promo</label>
                        <input type="number" id="promoValue" placeholder="Misal: 5000 (nominal) atau 10 (persen)" min="0" />
                    </div>
                    <button type="submit" class="btn-primary" id="saveProductBtn">Tambah Produk</button>
                    <button type="button" class="btn-secondary" id="cancelEditProductBtn" style="display: none;">Batal Edit</button>
                </form>

                <h3 class="mt-4">Daftar Produk</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nama Produk</th>
                            <th>Kategori</th>
                            <th>Harga Umum</th>
                            <th>Harga Reseller</th>
                            <th>Stok</th>
                            <th>Promo</th>
                            <th>Urutan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <tr><td colspan="8">Memuat produk...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="topup-requests-section" class="content-section">
                <h2>Permintaan Top Up Saldo</h2>
                <div id="topup-request-notification" class="notification"></div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Reseller Email</th>
                            <th>Nominal</th>
                            <th>Metode</th>
                            <th>Pengirim</th>
                            <th>Bukti</th>
                            <th>Waktu</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="topupRequestList">
                        <tr><td colspan="9">Memuat permintaan top up...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="general-orders-section" class="content-section">
                <h2>Pesanan Umum</h2>
                <div id="general-order-notification" class="notification"></div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Pesanan</th>
                            <th>Pelanggan</th>
                            <th>No. HP/ID</th>
                            <th>Produk</th>
                            <th>Harga Final</th>
                            <th>Waktu</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="generalOrderList">
                        <tr><td colspan="8">Memuat pesanan umum...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="reseller-orders-section" class="content-section">
                <h2>Pesanan Reseller</h2>
                <div id="reseller-order-notification" class="notification"></div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Pesanan</th>
                            <th>Reseller Email</th>
                            <th>Pelanggan</th>
                            <th>No. HP/ID</th>
                            <th>Produk</th>
                            <th>Harga Beli</th>
                            <th>Harga Jual</th>
                            <th>Waktu</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="resellerOrderList">
                        <tr><td colspan="9">Memuat pesanan reseller...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="discount-rights-section" class="content-section">
                <h2>Manajemen Hak Diskon Share</h2>
                <div id="discount-notification" class="notification"></div>
                <form id="discount-form">
                    <div class="form-group">
                        <label for="discountPhoneNumber">Nomor WA (Diawali 62)</label>
                        <input type="text" id="discountPhoneNumber" placeholder="Cth: 6281234567890" pattern="^62[0-9]{8,15}$" required />
                    </div>
                    <button type="submit" class="btn-primary">Berikan Hak Diskon</button>
                </form>

                <h3 class="mt-4">Daftar Hak Diskon Aktif</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nomor WA</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="activeDiscountList">
                        <tr><td colspan="2">Memuat hak diskon...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="testimonial-management-section" class="content-section">
                <h2>Manajemen Testimoni</h2>
                <div id="testimonial-notification" class="notification"></div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Isi Testimoni</th>
                            <th>Status</th>
                            <th>Waktu Kirim</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="testimonialList">
                        <tr><td colspan="5">Memuat testimoni...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="faq-management-section" class="content-section">
                <h2>Manajemen FAQ</h2>
                <div id="faq-notification" class="notification"></div>
                <form id="faq-form">
                    <input type="hidden" id="faqId" />
                    <div class="form-group">
                        <label for="faqQuestion">Pertanyaan</label>
                        <input type="text" id="faqQuestion" required />
                    </div>
                    <div class="form-group">
                        <label for="faqAnswer">Jawaban</label>
                        <textarea id="faqAnswer" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary" id="saveFaqBtn">Tambah FAQ</button>
                    <button type="button" class="btn-secondary" id="cancelEditFaqBtn" style="display: none;">Batal Edit</button>
                </form>

                <h3 class="mt-4">Daftar FAQ</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Pertanyaan</th>
                            <th>Jawaban</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="faqList">
                        <tr><td colspan="3">Memuat FAQ...</td></tr>
                    </tbody>
                </table>
            </section>

            <section id="payment-info-section" class="content-section">
                <h2>Informasi Pembayaran</h2>
                <div id="payment-info-notification" class="notification"></div>
                <form id="payment-info-form">
                    <input type="hidden" id="paymentInfoId" />
                    <div class="form-group">
                        <label for="paymentMethod">Metode Pembayaran (Cth: Bank BCA, Dana)</label>
                        <input type="text" id="paymentMethod" required />
                    </div>
                    <div class="form-group">
                        <label for="paymentNumber">Nomor Rekening / Dana</label>
                        <input type="text" id="paymentNumber" required />
                    </div>
                    <div class="form-group">
                        <label for="paymentAccountName">Atas Nama</label>
                        <input type="text" id="paymentAccountName" required />
                    </div>
                    <button type="submit" class="btn-primary" id="savePaymentInfoBtn">Tambah Info Pembayaran</button>
                    <button type="button" class="btn-secondary" id="cancelEditPaymentInfoBtn" style="display: none;">Batal Edit</button>
                </form>

                <h3 class="mt-4">Daftar Informasi Pembayaran</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Metode</th>
                            <th>Nomor</th>
                            <th>Atas Nama</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="paymentInfoList">
                        <tr><td colspan="4">Memuat info pembayaran...</td></tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 800, once: true, offset: 50 });

        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // Ganti dengan API Key Anda
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
          storageBucket: "asdarstoredigitalll-d89c4.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();
        const storage = firebase.storage();

        // Admin UID (GANTI DENGAN UID ADMIN ANDA!)
        const ADMIN_UID = "gTotHPsedOQRC0DUqmkJzUWQBBM2"; // <--- GANTI INI DENGAN UID ADMIN YANG SESUNGGUHNYA DARI FIREBASE AUTH

        // DOM Elements
        const logoutBtn = document.getElementById('logout-btn');
        const navBtns = document.querySelectorAll('.nav-btn');
        const contentSections = document.querySelectorAll('.content-section');

        // General Utility Functions
        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
        const normalizePhone = (num) => {
            let n = String(num).trim().replace(/[^0-9]/g, '');
            if (n.startsWith('0')) return '62' + n.slice(1);
            if (n.startsWith('62')) return n;
            return num;
        };
        
        // Notification function
        const showNotification = (containerId, message, type = 'error', duration = 3000) => {
            const notificationDiv = document.getElementById(containerId);
            notificationDiv.textContent = message;
            notificationDiv.className = `notification ${type}`;
            notificationDiv.style.display = 'block';
            if (duration) {
                setTimeout(() => {
                    notificationDiv.style.display = 'none';
                }, duration);
            }
        };

        const hideNotification = (containerId) => {
            document.getElementById(containerId).style.display = 'none';
        };

        // --- AUTHENTICATION & INITIAL LOAD ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html'; // Redirect to generic login page
            } else if (user.uid !== ADMIN_UID) {
                alert("Anda tidak memiliki akses sebagai admin.");
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            } else {
                console.log("Admin logged in:", user.email);
                loadDashboardData();
                setupListeners();
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Error logging out:", error);
                alert("Failed to log out. Please try again.");
            });
        });

        // --- NAVIGATION ---
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                contentSections.forEach(section => section.classList.remove('active'));
                document.getElementById(btn.dataset.target).classList.add('active');
                
                // Load data specific to the section
                switch(btn.dataset.target) {
                    case 'product-management-section':
                        loadProducts();
                        break;
                    case 'topup-requests-section':
                        loadTopupRequests();
                        break;
                    case 'general-orders-section':
                        loadGeneralOrders();
                        break;
                    case 'reseller-orders-section':
                        loadResellerOrders();
                        break;
                    case 'discount-rights-section':
                        loadActiveDiscounts();
                        break;
                    case 'testimonial-management-section':
                        loadAllTestimonials();
                        break;
                    case 'faq-management-section':
                        loadFaqs();
                        break;
                    case 'payment-info-section':
                        loadPaymentInfos();
                        break;
                    case 'dashboard-section':
                        loadDashboardData();
                        break;
                }
            });
        });

        function setupListeners() {
            // Product Management
            document.getElementById('product-form').addEventListener('submit', handleProductSubmit);
            document.getElementById('cancelEditProductBtn').addEventListener('click', resetProductForm);
            document.getElementById('promoType').addEventListener('change', (e) => {
                const promoValueGroup = document.getElementById('promoValueGroup');
                if (e.target.value === 'nominal' || e.target.value === 'percentage') {
                    promoValueGroup.style.display = 'block';
                    document.getElementById('promoValue').setAttribute('required', 'true');
                } else {
                    promoValueGroup.style.display = 'none';
                    document.getElementById('promoValue').removeAttribute('required');
                }
            });

            // Discount Rights
            document.getElementById('discount-form').addEventListener('submit', handleAddDiscountRight);

            // Testimonial Management (Realtime Listener for 'pending' testimonials)
            dbRT.ref('testimonials').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                loadAllTestimonials(); // Reload all to show status changes
            });

            // FAQ Management
            document.getElementById('faq-form').addEventListener('submit', handleFaqSubmit);
            document.getElementById('cancelEditFaqBtn').addEventListener('click', resetFaqForm);

            // Payment Info Management
            document.getElementById('payment-info-form').addEventListener('submit', handlePaymentInfoSubmit);
            document.getElementById('cancelEditPaymentInfoBtn').addEventListener('click', resetPaymentInfoForm);

            // Real-time listeners for dashboard counts
            dbFS.collection('produk').onSnapshot(snapshot => {
                document.getElementById('totalProducts').textContent = snapshot.size;
            });
            dbFS.collection('konfirmasiTopup').where('status', '==', 'pending').onSnapshot(snapshot => {
                document.getElementById('pendingTopups').textContent = snapshot.size;
            });
            dbFS.collection('pesananUmum').where('status', '==', 'Menunggu Pembayaran').onSnapshot(snapshot => {
                document.getElementById('pendingGeneralOrders').textContent = snapshot.size;
            });

            // Initial load for the active dashboard section
            loadDashboardData();
        }

        // --- DASHBOARD FUNCTIONS ---
        async function loadDashboardData() {
            try {
                // Top Products (based on general orders)
                const generalOrdersSnapshot = await dbFS.collection('pesananUmum').get();
                const productCounts = {};
                generalOrdersSnapshot.forEach(doc => {
                    const product = doc.data().produk;
                    productCounts[product] = (productCounts[product] || 0) + 1;
                });
                const sortedProducts = Object.entries(productCounts).sort(([,a],[,b]) => b - a).slice(0, 5);
                const topProductsList = document.getElementById('topProductsList');
                topProductsList.innerHTML = '';
                if (sortedProducts.length === 0) {
                    topProductsList.innerHTML = '<li>Belum ada data produk terlaris.</li>';
                } else {
                    sortedProducts.forEach(([productName, count]) => {
                        topProductsList.innerHTML += `<li>${productName} (${count} pesanan)</li>`;
                    });
                }

                // Top Resellers (based on balance)
                const resellersSnapshot = await dbFS.collection('resellers').orderBy('saldo', 'desc').limit(5).get();
                const topResellersList = document.getElementById('topResellersList');
                topResellersList.innerHTML = '';
                if (resellersSnapshot.empty) {
                    topResellersList.innerHTML = '<li>Belum ada data reseller.</li>';
                } else {
                    resellersSnapshot.forEach(doc => {
                        const data = doc.data();
                        topResellersList.innerHTML += `<li>${data.email || 'N/A'} - ${formatRupiah(data.saldo || 0)}</li>`;
                    });
                }

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showNotification('dashboard-notification', 'Gagal memuat data dashboard.', 'error');
            }
        }


        // --- PRODUCT MANAGEMENT FUNCTIONS ---
        async function loadProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '<tr><td colspan="8">Memuat produk...</td></tr>';
            try {
                const snapshot = await dbFS.collection('produk').orderBy('urutan', 'asc').get();
                productList.innerHTML = '';
                if (snapshot.empty) {
                    productList.innerHTML = '<tr><td colspan="8">Tidak ada produk.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const promoText = product.promo ? `${product.promo.jenis === 'nominal' ? 'Rp' : ''}${product.promo.nilai}${product.promo.jenis === 'percentage' ? '%' : ''} ${product.promo.jenis}` : '-';
                    productList.innerHTML += `
                        <tr>
                            <td>${product.nama_produk}</td>
                            <td>${product.kategori}</td>
                            <td>${formatRupiah(product.harga_umum)}</td>
                            <td>${formatRupiah(product.harga_reseller)}</td>
                            <td>${product.stok}</td>
                            <td>${promoText}</td>
                            <td>${product.urutan || 0}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editProduct('${doc.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" onclick="deleteProduct('${doc.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading products:", error);
                productList.innerHTML = '<tr><td colspan="8" class="text-danger">Gagal memuat produk.</td></tr>';
                showNotification('product-notification', 'Gagal memuat daftar produk.', 'error');
            }
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const productId = document.getElementById('productId').value;
            const productName = document.getElementById('productName').value;
            const productCategory = document.getElementById('productCategory').value;
            const productDescription = document.getElementById('productDescription').value;
            const productGeneralPrice = parseInt(document.getElementById('productGeneralPrice').value);
            const productResellerPrice = parseInt(document.getElementById('productResellerPrice').value);
            const productStock = parseInt(document.getElementById('productStock').value);
            const productOrder = parseInt(document.getElementById('productOrder').value) || 0;
            const promoType = document.getElementById('promoType').value;
            const promoValue = document.getElementById('promoValue').value ? parseInt(document.getElementById('promoValue').value) : null;

            if (promoType && (promoValue === null || isNaN(promoValue))) {
                showNotification('product-notification', 'Nilai promo harus diisi jika promo dipilih.', 'error');
                return;
            }

            let promoData = null;
            if (promoType) {
                promoData = {
                    jenis: promoType,
                    nilai: promoValue
                };
            }

            const productData = {
                nama_produk: productName,
                kategori: productCategory,
                deskripsi: productDescription,
                harga_umum: productGeneralPrice,
                harga_reseller: productResellerPrice,
                stok: productStock,
                urutan: productOrder,
                promo: promoData
            };

            const saveProductBtn = document.getElementById('saveProductBtn');
            saveProductBtn.disabled = true;
            saveProductBtn.textContent = 'Menyimpan...';

            try {
                if (productId) {
                    await dbFS.collection('produk').doc(productId).update(productData);
                    showNotification('product-notification', 'Produk berhasil diupdate!', 'success');
                } else {
                    await dbFS.collection('produk').add(productData);
                    showNotification('product-notification', 'Produk berhasil ditambahkan!', 'success');
                }
                resetProductForm();
                loadProducts();
            } catch (error) {
                console.error("Error saving product:", error);
                showNotification('product-notification', 'Gagal menyimpan produk: ' + error.message, 'error');
            } finally {
                saveProductBtn.disabled = false;
                saveProductBtn.textContent = productId ? 'Update Produk' : 'Tambah Produk';
            }
        }

        async function editProduct(id) {
            try {
                const doc = await dbFS.collection('produk').doc(id).get();
                if (doc.exists) {
                    const product = doc.data();
                    document.getElementById('productId').value = id;
                    document.getElementById('productName').value = product.nama_produk;
                    document.getElementById('productCategory').value = product.kategori;
                    document.getElementById('productDescription').value = product.deskripsi || '';
                    document.getElementById('productGeneralPrice').value = product.harga_umum;
                    document.getElementById('productResellerPrice').value = product.harga_reseller;
                    document.getElementById('productStock').value = product.stok;
                    document.getElementById('productOrder').value = product.urutan || 0;

                    if (product.promo) {
                        document.getElementById('promoType').value = product.promo.jenis;
                        document.getElementById('promoValueGroup').style.display = 'block';
                        document.getElementById('promoValue').value = product.promo.nilai;
                        document.getElementById('promoValue').setAttribute('required', 'true');
                    } else {
                        document.getElementById('promoType').value = '';
                        document.getElementById('promoValueGroup').style.display = 'none';
                        document.getElementById('promoValue').value = '';
                        document.getElementById('promoValue').removeAttribute('required');
                    }
                    
                    document.getElementById('saveProductBtn').textContent = 'Update Produk';
                    document.getElementById('cancelEditProductBtn').style.display = 'inline-block';
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to form
                }
            } catch (error) {
                console.error("Error editing product:", error);
                showNotification('product-notification', 'Gagal memuat data produk untuk diedit.', 'error');
            }
        }

        async function deleteProduct(id) {
            if (confirm("Apakah Anda yakin ingin menghapus produk ini?")) {
                try {
                    await dbFS.collection('produk').doc(id).delete();
                    showNotification('product-notification', 'Produk berhasil dihapus!', 'success');
                    loadProducts();
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showNotification('product-notification', 'Gagal menghapus produk: ' + error.message, 'error');
                }
            }
        }

        function resetProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('productId').value = '';
            document.getElementById('saveProductBtn').textContent = 'Tambah Produk';
            document.getElementById('cancelEditProductBtn').style.display = 'none';
            document.getElementById('promoType').value = '';
            document.getElementById('promoValueGroup').style.display = 'none';
            document.getElementById('promoValue').value = '';
            document.getElementById('promoValue').removeAttribute('required');
            hideNotification('product-notification');
        }

        // --- TOP UP REQUESTS FUNCTIONS ---
        async function loadTopupRequests() {
            const topupRequestList = document.getElementById('topupRequestList');
            topupRequestList.innerHTML = '<tr><td colspan="9">Memuat permintaan top up...</td></tr>';
            try {
                const snapshot = await dbFS.collection('konfirmasiTopup').orderBy('created_at', 'desc').get();
                topupRequestList.innerHTML = '';
                if (snapshot.empty) {
                    topupRequestList.innerHTML = '<tr><td colspan="9">Tidak ada permintaan top up.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const req = doc.data();
                    const time = req.created_at ? new Date(req.created_at.toDate()).toLocaleString() : 'N/A';
                    let statusBadgeClass = '';
                    if (req.status === 'pending') statusBadgeClass = 'bg-warning text-dark';
                    else if (req.status === 'disetujui') statusBadgeClass = 'bg-success';
                    else if (req.status === 'ditolak') statusBadgeClass = 'bg-danger';

                    topupRequestList.innerHTML += `
                        <tr>
                            <td>${req.id}</td>
                            <td>${req.reseller_email}</td>
                            <td>${formatRupiah(req.nominal)}</td>
                            <td>${req.metode_pembayaran}</td>
                            <td>${req.nama_pengirim}</td>
                            <td><a href="${req.bukti_url}" target="_blank" class="btn btn-info btn-sm"><i class="fas fa-image"></i> Lihat Bukti</a></td>
                            <td>${time}</td>
                            <td><span class="badge ${statusBadgeClass}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span></td>
                            <td class="action-buttons">
                                ${req.status === 'pending' ? `
                                    <button class="btn btn-success" onclick="approveTopup('${doc.id}', ${req.nominal}, '${req.reseller_uid}')"><i class="fas fa-check"></i> Setujui</button>
                                    <button class="btn btn-danger" onclick="rejectTopup('${doc.id}')"><i class="fas fa-times"></i> Tolak</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading topup requests:", error);
                topupRequestList.innerHTML = '<tr><td colspan="9" class="text-danger">Gagal memuat permintaan top up.</td></tr>';
                showNotification('topup-request-notification', 'Gagal memuat daftar permintaan top up.', 'error');
            }
        }

        async function approveTopup(requestId, nominal, resellerUid) {
            if (confirm(`Setujui top up ${formatRupiah(nominal)} untuk reseller ini?`)) {
                try {
                    // Start a Firestore transaction
                    await dbFS.runTransaction(async (transaction) => {
                        const resellerRef = dbFS.collection('resellers').doc(resellerUid);
                        const topupRequestRef = dbFS.collection('konfirmasiTopup').doc(requestId);

                        const resellerDoc = await transaction.get(resellerRef);
                        const topupRequestDoc = await transaction.get(topupRequestRef);

                        if (!resellerDoc.exists) {
                            throw new Error("Reseller not found.");
                        }
                        if (topupRequestDoc.data().status !== 'pending') {
                            throw new Error("Permintaan top up sudah diproses.");
                        }

                        const currentSaldo = resellerDoc.data().saldo || 0;
                        const newSaldo = currentSaldo + nominal;

                        transaction.update(resellerRef, { saldo: newSaldo });
                        transaction.update(topupRequestRef, { status: 'disetujui', processed_at: firebase.firestore.FieldValue.serverTimestamp() });
                    });
                    showNotification('topup-request-notification', `Top up ${formatRupiah(nominal)} berhasil disetujui!`, 'success');
                    loadTopupRequests();
                } catch (error) {
                    console.error("Error approving topup:", error);
                    showNotification('topup-request-notification', 'Gagal menyetujui top up: ' + error.message, 'error');
                }
            }
        }

        async function rejectTopup(requestId) {
            if (confirm("Apakah Anda yakin ingin menolak permintaan top up ini?")) {
                try {
                    await dbFS.collection('konfirmasiTopup').doc(requestId).update({
                        status: 'ditolak',
                        processed_at: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('topup-request-notification', 'Permintaan top up berhasil ditolak.', 'success');
                    loadTopupRequests();
                } catch (error) {
                    console.error("Error rejecting topup:", error);
                    showNotification('topup-request-notification', 'Gagal menolak top up: ' + error.message, 'error');
                }
            }
        }

        // --- GENERAL ORDERS FUNCTIONS ---
        async function loadGeneralOrders() {
            const generalOrderList = document.getElementById('generalOrderList');
            generalOrderList.innerHTML = '<tr><td colspan="8">Memuat pesanan umum...</td></tr>';
            try {
                const snapshot = await dbFS.collection('pesananUmum').orderBy('waktu', 'desc').get();
                generalOrderList.innerHTML = '';
                if (snapshot.empty) {
                    generalOrderList.innerHTML = '<tr><td colspan="8">Tidak ada pesanan umum.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const time = order.waktu ? new Date(order.waktu.toDate()).toLocaleString() : 'N/A';
                    let statusBadgeClass = '';
                    if (order.status === 'Menunggu Pembayaran') statusBadgeClass = 'bg-warning text-dark';
                    else if (order.status === 'Menunggu Diproses') statusBadgeClass = 'bg-info';
                    else if (order.status === 'Selesai') statusBadgeClass = 'bg-success';
                    else if (order.status === 'Dibatalkan') statusBadgeClass = 'bg-danger';

                    generalOrderList.innerHTML += `
                        <tr>
                            <td><a href="detailpesanan.html?id=${doc.id}&type=umum" target="_blank">${order.id}</a></td>
                            <td>${order.nama_pelanggan}</td>
                            <td>${order.nomor_pelanggan}</td>
                            <td>${order.produk}</td>
                            <td>${formatRupiah(order.harga_final)}</td>
                            <td>${time}</td>
                            <td><span class="badge ${statusBadgeClass}">${order.status}</span></td>
                            <td class="action-buttons">
                                <a href="detailpesanan.html?id=${doc.id}&type=umum" class="btn btn-info btn-sm"><i class="fas fa-eye"></i> Detail</a>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading general orders:", error);
                generalOrderList.innerHTML = '<tr><td colspan="8" class="text-danger">Gagal memuat pesanan umum.</td></tr>';
                showNotification('general-order-notification', 'Gagal memuat daftar pesanan umum.', 'error');
            }
        }

        // --- RESELLER ORDERS FUNCTIONS ---
        async function loadResellerOrders() {
            const resellerOrderList = document.getElementById('resellerOrderList');
            resellerOrderList.innerHTML = '<tr><td colspan="9">Memuat pesanan reseller...</td></tr>';
            try {
                const snapshot = await dbFS.collection('pesananReseller').orderBy('waktu', 'desc').get();
                resellerOrderList.innerHTML = '';
                if (snapshot.empty) {
                    resellerOrderList.innerHTML = '<tr><td colspan="9">Tidak ada pesanan reseller.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const time = order.waktu ? new Date(order.waktu.toDate()).toLocaleString() : 'N/A';
                    let statusBadgeClass = '';
                    if (order.status === 'Selesai') statusBadgeClass = 'bg-success';
                    // Reseller orders are usually 'Selesai' directly as they pay by balance
                    
                    resellerOrderList.innerHTML += `
                        <tr>
                            <td><a href="detailpesanan.html?id=${doc.id}&type=reseller" target="_blank">${order.id}</a></td>
                            <td>${order.reseller_email}</td>
                            <td>${order.nama_pelanggan}</td>
                            <td>${order.nomor_pelanggan}</td>
                            <td>${order.produk}</td>
                            <td>${formatRupiah(order.harga_beli)}</td>
                            <td>${formatRupiah(order.harga_jual)}</td>
                            <td>${time}</td>
                            <td><span class="badge ${statusBadgeClass}">${order.status}</span></td>
                            <td class="action-buttons">
                                <a href="detailpesanan.html?id=${doc.id}&type=reseller" class="btn btn-info btn-sm"><i class="fas fa-eye"></i> Detail</a>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading reseller orders:", error);
                resellerOrderList.innerHTML = '<tr><td colspan="9" class="text-danger">Gagal memuat pesanan reseller.</td></tr>';
                showNotification('reseller-order-notification', 'Gagal memuat daftar pesanan reseller.', 'error');
            }
        }

        // --- DISCOUNT RIGHTS FUNCTIONS ---
        async function handleAddDiscountRight(e) {
            e.preventDefault();
            const phoneNumber = normalizePhone(document.getElementById('discountPhoneNumber').value);
            if (!phoneNumber) {
                showNotification('discount-notification', 'Nomor WA tidak boleh kosong.', 'error');
                return;
            }

            const confirmBtn = e.target.querySelector('button[type="submit"]');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Memproses...';

            try {
                await dbRT.ref('hakDiskon/' + phoneNumber).set(true);
                showNotification('discount-notification', `Hak diskon berhasil diberikan kepada ${phoneNumber}!`, 'success');
                document.getElementById('discount-form').reset();
                loadActiveDiscounts();
            } catch (error) {
                console.error("Error adding discount right:", error);
                showNotification('discount-notification', 'Gagal memberikan hak diskon: ' + error.message, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Berikan Hak Diskon';
            }
        }

        async function loadActiveDiscounts() {
            const activeDiscountList = document.getElementById('activeDiscountList');
            activeDiscountList.innerHTML = '<tr><td colspan="2">Memuat hak diskon...</td></tr>';
            try {
                const snapshot = await dbRT.ref('hakDiskon').get();
                activeDiscountList.innerHTML = '';
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    activeDiscountList.innerHTML = '<tr><td colspan="2">Tidak ada hak diskon aktif.</td></tr>';
                    return;
                }
                const discounts = snapshot.val();
                Object.keys(discounts).forEach(phone => {
                    activeDiscountList.innerHTML += `
                        <tr>
                            <td>${phone}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger" onclick="revokeDiscountRight('${phone}')"><i class="fas fa-ban"></i> Cabut</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading active discounts:", error);
                activeDiscountList.innerHTML = '<tr><td colspan="2" class="text-danger">Gagal memuat hak diskon.</td></tr>';
                showNotification('discount-notification', 'Gagal memuat daftar hak diskon.', 'error');
            }
        }

        async function revokeDiscountRight(phoneNumber) {
            if (confirm(`Apakah Anda yakin ingin mencabut hak diskon dari ${phoneNumber}?`)) {
                try {
                    await dbRT.ref('hakDiskon/' + phoneNumber).remove();
                    showNotification('discount-notification', `Hak diskon dari ${phoneNumber} berhasil dicabut!`, 'success');
                    loadActiveDiscounts();
                } catch (error) {
                    console.error("Error revoking discount right:", error);
                    showNotification('discount-notification', 'Gagal mencabut hak diskon: ' + error.message, 'error');
                }
            }
        }

        // --- TESTIMONIAL MANAGEMENT FUNCTIONS ---
        async function loadAllTestimonials() {
            const testimonialList = document.getElementById('testimonialList');
            testimonialList.innerHTML = '<tr><td colspan="5">Memuat testimoni...</td></tr>';
            try {
                const snapshot = await dbRT.ref('testimonials').orderByChild('createdAt').get();
                testimonialList.innerHTML = '';
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    testimonialList.innerHTML = '<tr><td colspan="5">Tidak ada testimoni.</td></tr>';
                    return;
                }
                const testimonials = snapshot.val();
                Object.keys(testimonials).reverse().forEach(key => { // Reverse to show latest first
                    const testi = testimonials[key];
                    let statusBadgeClass = '';
                    if (testi.status === 'pending') statusBadgeClass = 'bg-warning text-dark';
                    else if (testi.status === 'disetujui') statusBadgeClass = 'bg-success';
                    else if (testi.status === 'ditolak') statusBadgeClass = 'bg-danger';

                    const time = testi.createdAt ? new Date(testi.createdAt).toLocaleString() : 'N/A';

                    testimonialList.innerHTML += `
                        <tr>
                            <td>${testi.nama || 'Anonim'}</td>
                            <td>${testi.isi}</td>
                            <td><span class="badge ${statusBadgeClass}">${testi.status.charAt(0).toUpperCase() + testi.status.slice(1)}</span></td>
                            <td>${time}</td>
                            <td class="action-buttons">
                                ${testi.status !== 'disetujui' ? `<button class="btn btn-success" onclick="approveTestimonial('${key}')"><i class="fas fa-check"></i> Setujui</button>` : ''}
                                ${testi.status !== 'ditolak' ? `<button class="btn btn-danger" onclick="rejectTestimonial('${key}')"><i class="fas fa-times"></i> Tolak</button>` : ''}
                                <button class="btn btn-secondary" onclick="deleteTestimonial('${key}')"><i class="fas fa-trash"></i> Hapus</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading testimonials:", error);
                testimonialList.innerHTML = '<tr><td colspan="5" class="text-danger">Gagal memuat testimoni.</td></tr>';
                showNotification('testimonial-notification', 'Gagal memuat daftar testimoni.', 'error');
            }
        }

        async function approveTestimonial(id) {
            if (confirm("Apakah Anda yakin ingin menyetujui testimoni ini?")) {
                try {
                    await dbRT.ref('testimonials/' + id).update({ status: 'disetujui' });
                    showNotification('testimonial-notification', 'Testimoni berhasil disetujui!', 'success');
                    loadAllTestimonials();
                } catch (error) {
                    console.error("Error approving testimonial:", error);
                    showNotification('testimonial-notification', 'Gagal menyetujui testimoni: ' + error.message, 'error');
                }
            }
        }

        async function rejectTestimonial(id) {
            if (confirm("Apakah Anda yakin ingin menolak testimoni ini?")) {
                try {
                    await dbRT.ref('testimonials/' + id).update({ status: 'ditolak' });
                    showNotification('testimonial-notification', 'Testimoni berhasil ditolak!', 'success');
                    loadAllTestimonials();
                } catch (error) {
                    console.error("Error rejecting testimonial:", error);
                    showNotification('testimonial-notification', 'Gagal menolak testimoni: ' + error.message, 'error');
                }
            }
        }

        async function deleteTestimonial(id) {
            if (confirm("Apakah Anda yakin ingin menghapus testimoni ini secara permanen?")) {
                try {
                    await dbRT.ref('testimonials/' + id).remove();
                    showNotification('testimonial-notification', 'Testimoni berhasil dihapus!', 'success');
                    loadAllTestimonials();
                } catch (error) {
                    console.error("Error deleting testimonial:", error);
                    showNotification('testimonial-notification', 'Gagal menghapus testimoni: ' + error.message, 'error');
                }
            }
        }

        // --- FAQ MANAGEMENT FUNCTIONS ---
        async function loadFaqs() {
            const faqList = document.getElementById('faqList');
            faqList.innerHTML = '<tr><td colspan="3">Memuat FAQ...</td></tr>';
            try {
                const snapshot = await dbRT.ref('faq').get();
                faqList.innerHTML = '';
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    faqList.innerHTML = '<tr><td colspan="3">Tidak ada FAQ.</td></tr>';
                    return;
                }
                const faqs = snapshot.val();
                Object.keys(faqs).forEach(key => {
                    const faq = faqs[key];
                    faqList.innerHTML += `
                        <tr>
                            <td>${faq.q}</td>
                            <td>${faq.a}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editFaq('${key}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" onclick="deleteFaq('${key}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading FAQs:", error);
                faqList.innerHTML = '<tr><td colspan="3" class="text-danger">Gagal memuat FAQ.</td></tr>';
                showNotification('faq-notification', 'Gagal memuat daftar FAQ.', 'error');
            }
        }

        async function handleFaqSubmit(e) {
            e.preventDefault();
            const faqId = document.getElementById('faqId').value;
            const faqQuestion = document.getElementById('faqQuestion').value;
            const faqAnswer = document.getElementById('faqAnswer').value;

            const saveFaqBtn = document.getElementById('saveFaqBtn');
            saveFaqBtn.disabled = true;
            saveFaqBtn.textContent = 'Menyimpan...';

            try {
                if (faqId) {
                    await dbRT.ref('faq/' + faqId).update({ q: faqQuestion, a: faqAnswer });
                    showNotification('faq-notification', 'FAQ berhasil diupdate!', 'success');
                } else {
                    await dbRT.ref('faq').push({ q: faqQuestion, a: faqAnswer });
                    showNotification('faq-notification', 'FAQ berhasil ditambahkan!', 'success');
                }
                resetFaqForm();
                loadFaqs();
            } catch (error) {
                console.error("Error saving FAQ:", error);
                showNotification('faq-notification', 'Gagal menyimpan FAQ: ' + error.message, 'error');
            } finally {
                saveFaqBtn.disabled = false;
                saveFaqBtn.textContent = faqId ? 'Update FAQ' : 'Tambah FAQ';
            }
        }

        async function editFaq(id) {
            try {
                const snapshot = await dbRT.ref('faq/' + id).get();
                if (snapshot.exists()) {
                    const faq = snapshot.val();
                    document.getElementById('faqId').value = id;
                    document.getElementById('faqQuestion').value = faq.q;
                    document.getElementById('faqAnswer').value = faq.a;
                    document.getElementById('saveFaqBtn').textContent = 'Update FAQ';
                    document.getElementById('cancelEditFaqBtn').style.display = 'inline-block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing FAQ:", error);
                showNotification('faq-notification', 'Gagal memuat data FAQ untuk diedit.', 'error');
            }
        }

        async function deleteFaq(id) {
            if (confirm("Apakah Anda yakin ingin menghapus FAQ ini?")) {
                try {
                    await dbRT.ref('faq/' + id).remove();
                    showNotification('faq-notification', 'FAQ berhasil dihapus!', 'success');
                    loadFaqs();
                } catch (error) {
                    console.error("Error deleting FAQ:", error);
                    showNotification('faq-notification', 'Gagal menghapus FAQ: ' + error.message, 'error');
                }
            }
        }

        function resetFaqForm() {
            document.getElementById('faq-form').reset();
            document.getElementById('faqId').value = '';
            document.getElementById('saveFaqBtn').textContent = 'Tambah FAQ';
            document.getElementById('cancelEditFaqBtn').style.display = 'none';
            hideNotification('faq-notification');
        }

        // --- PAYMENT INFO FUNCTIONS ---
        async function loadPaymentInfos() {
            const paymentInfoList = document.getElementById('paymentInfoList');
            paymentInfoList.innerHTML = '<tr><td colspan="4">Memuat info pembayaran...</td></tr>';
            try {
                const snapshot = await dbFS.collection('infoPembayaran').get();
                paymentInfoList.innerHTML = '';
                if (snapshot.empty) {
                    paymentInfoList.innerHTML = '<tr><td colspan="4">Tidak ada informasi pembayaran.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const info = doc.data();
                    paymentInfoList.innerHTML += `
                        <tr>
                            <td>${info.metode}</td>
                            <td>${info.nomor}</td>
                            <td>${info.atas_nama}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editPaymentInfo('${doc.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" onclick="deletePaymentInfo('${doc.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error loading payment info:", error);
                paymentInfoList.innerHTML = '<tr><td colspan="4" class="text-danger">Gagal memuat informasi pembayaran.</td></tr>';
                showNotification('payment-info-notification', 'Gagal memuat informasi pembayaran.', 'error');
            }
        }

        async function handlePaymentInfoSubmit(e) {
            e.preventDefault();
            const paymentInfoId = document.getElementById('paymentInfoId').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentNumber = document.getElementById('paymentNumber').value;
            const paymentAccountName = document.getElementById('paymentAccountName').value;

            const paymentData = {
                metode: paymentMethod,
                nomor: paymentNumber,
                atas_nama: paymentAccountName
            };

            const savePaymentInfoBtn = document.getElementById('savePaymentInfoBtn');
            savePaymentInfoBtn.disabled = true;
            savePaymentInfoBtn.textContent = 'Menyimpan...';

            try {
                if (paymentInfoId) {
                    await dbFS.collection('infoPembayaran').doc(paymentInfoId).update(paymentData);
                    showNotification('payment-info-notification', 'Informasi pembayaran berhasil diupdate!', 'success');
                } else {
                    await dbFS.collection('infoPembayaran').add(paymentData);
                    showNotification('payment-info-notification', 'Informasi pembayaran berhasil ditambahkan!', 'success');
                }
                resetPaymentInfoForm();
                loadPaymentInfos();
            } catch (error) {
                console.error("Error saving payment info:", error);
                showNotification('payment-info-notification', 'Gagal menyimpan informasi pembayaran: ' + error.message, 'error');
            } finally {
                savePaymentInfoBtn.disabled = false;
                savePaymentInfoBtn.textContent = paymentInfoId ? 'Update Info Pembayaran' : 'Tambah Info Pembayaran';
            }
        }

        async function editPaymentInfo(id) {
            try {
                const doc = await dbFS.collection('infoPembayaran').doc(id).get();
                if (doc.exists) {
                    const info = doc.data();
                    document.getElementById('paymentInfoId').value = id;
                    document.getElementById('paymentMethod').value = info.metode;
                    document.getElementById('paymentNumber').value = info.nomor;
                    document.getElementById('paymentAccountName').value = info.atas_nama;
                    document.getElementById('savePaymentInfoBtn').textContent = 'Update Info Pembayaran';
                    document.getElementById('cancelEditPaymentInfoBtn').style.display = 'inline-block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Error editing payment info:", error);
                showNotification('payment-info-notification', 'Gagal memuat data informasi pembayaran untuk diedit.', 'error');
            }
        }

        async function deletePaymentInfo(id) {
            if (confirm("Apakah Anda yakin ingin menghapus informasi pembayaran ini?")) {
                try {
                    await dbFS.collection('infoPembayaran').doc(id).delete();
                    showNotification('payment-info-notification', 'Informasi pembayaran berhasil dihapus!', 'success');
                    loadPaymentInfos();
                } catch (error) {
                    console.error("Error deleting payment info:", error);
                    showNotification('payment-info-notification', 'Gagal menghapus informasi pembayaran: ' + error.message, 'error');
                }
            }
        }

        function resetPaymentInfoForm() {
            document.getElementById('payment-info-form').reset();
            document.getElementById('paymentInfoId').value = '';
            document.getElementById('savePaymentInfoBtn').textContent = 'Tambah Info Pembayaran';
            document.getElementById('cancelEditPaymentInfoBtn').style.display = 'none';
            hideNotification('payment-info-notification');
        }

    </script>
</body>
                    </html>
