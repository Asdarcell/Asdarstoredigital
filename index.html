<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asdar Store Digital - Dengan No. WA Aktif</title>
  <style>
    label { font-weight: 600; margin-top: 10px; display: block; }
    input, select, button { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #3498db; color: white; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <main>
    <form id="formPesanan">
      <label for="nama">Nama Lengkap</label>
      <input type="text" id="nama" required />
      <!-- Fitur dinamis No WA Aktif akan disisipkan di sini, tepat setelah input nama -->
      
      <label for="nomor">Nomor HP / ID SN</label>
      <input type="text" id="nomor" required />
      
      <label for="kategori">Kategori Produk</label>
      <select id="kategori" required><option value="">Pilih Kategori</option></select>
      
      <label for="produk">Produk</label>
      <select id="produk" required><option value="">Pilih Produk</option></select>
      
      <div id="infoProduk">Harga dan deskripsi akan muncul di sini...</div>
      
      <button type="submit">Pesan Sekarang</button>
    </form>
    <div id="hasil"></div>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const kategoriSelect = document.getElementById('kategori');
    const produkSelect = document.getElementById('produk');
    const infoProduk = document.getElementById('infoProduk');
    const hasil = document.getElementById('hasil');
    const produkRef = db.ref('produk');
    const fiturRef = db.ref('fitur_dinamis');

    // Load kategori produk
    produkRef.once('value').then(snapshot => {
      const data = snapshot.val() || {};
      for (let kategori in data) {
        kategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
      }
    });

    // Load produk sesuai kategori
    kategoriSelect.addEventListener('change', () => {
      produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
      infoProduk.textContent = 'Harga dan deskripsi akan muncul di sini...';
      const kategori = kategoriSelect.value;
      if (!kategori) return;
      produkRef.child(kategori).once('value').then(snapshot => {
        const data = snapshot.val() || {};
        for (let nama in data) {
          produkSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
        }
      });
    });

    // Tampilkan harga & deskripsi produk
    produkSelect.addEventListener('change', () => {
      const kategori = kategoriSelect.value;
      const produk = produkSelect.value;
      if (!produk) return;
      produkRef.child(`${kategori}/${produk}`).once('value').then(snapshot => {
        const data = snapshot.val();
        infoProduk.innerHTML = `<b>Harga:</b> Rp${data.harga}<br><b>Deskripsi:</b> ${data.deskripsi || data.cara || '-'}`;
      });
    });

    // Render fitur dinamis, khususnya No. WA Aktif di bawah input nama
    function renderFiturDinamis() {
      fiturRef.once('value').then(snap => {
        const fitur = snap.val() || {};
        for (let id in fitur) {
          const f = fitur[id];
          if (f.lokasi === 'index') {
            const targetElem = f.targetId ? document.getElementById(f.targetId) : null;
            if (targetElem) {
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = f.html;
              // Sisipkan langsung setelah elemen target (misal input nama)
              while (tempDiv.firstChild) {
                targetElem.parentNode.insertBefore(tempDiv.firstChild, targetElem.nextSibling);
              }
            }
          }
        }
      });
    }

    renderFiturDinamis();

    // Submit form dengan input no WA
    document.getElementById('formPesanan').addEventListener('submit', e => {
      e.preventDefault();
      const nama = document.getElementById('nama').value.trim();
      const nomor = document.getElementById('nomor').value.trim();
      const wa = document.getElementById('wa') ? document.getElementById('wa').value.trim() : '';
      const kategori = kategoriSelect.value;
      const produk = produkSelect.value;
      const waktu = new Date().toISOString();
      const id = "P" + Date.now();

      if (!nama || !nomor || !kategori || !produk) return alert("Harap lengkapi semua field!");
      if (!wa) return alert("Harap isi No. WA Aktif!");

      produkRef.child(`${kategori}/${produk}`).once('value').then(snap => {
        const data = snap.val();
        const harga = data.harga || 0;

        // Simpan data pesanan termasuk No WA
        db.ref('pesanan/' + id).set({ nama, nomor, wa, kategori, produk, harga, waktu, status: 'Belum Bayar' }).then(() => {
          hasil.innerHTML = `
            âœ… Pesanan berhasil!<br/><b>ID:</b> ${id}<br/>
            <img src="https://asdarcell.github.io/Asdarstoredigital/1751966264423.jpg" alt="QRIS" style="width: 100%; max-width: 300px;" />
            <div>
              ðŸŸ£ <b>PAYMENT</b><br/>
              ShopeePay: <b>081803004607</b><br/>
              Dana: <b>087755432880</b>
            </div>
            <a href="upload.html?id=${id}">ðŸ“¤ Upload Bukti Bayar</a><br/>
            <a href="status.html?id=${id}">ðŸ“„ Cek Status</a><br/>
          `;
          // Reset form dan info produk
          document.getElementById('formPesanan').reset();
          infoProduk.textContent = 'Harga dan deskripsi akan muncul di sini...';

          // Kirim notifikasi WA ke admin dengan data lengkap
          kirimNotifWA(id, nama, produk, wa);
        });
      });
    });

    function kirimNotifWA(id, nama, produk, wa) {
      const pesan = `ðŸ“¦ Pesanan Baru\nðŸ†” ID: ${id}\nðŸ‘¤ Nama: ${nama}\nðŸ“ž No. WA: ${wa}\nðŸ“¦ Produk: ${produk}\n\nðŸ“¤ Admin: https://asdarcell.github.io/Asdarstoredigital/admin.html`;
      const formData = new FormData();
      formData.append("appkey", "ab3727c5-e0be-40f9-bb3f-25d93b029f7a");
      formData.append("authkey", "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq");
      formData.append("to", "6281803004607");
      formData.append("message", pesan);
      fetch("https://app.ngirimwa.com/api/create-message", { method: "POST", body: formData });
    }
  </script>
</body>
</html>
