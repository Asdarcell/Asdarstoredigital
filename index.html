<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; font-family: 'Poppins', sans-serif; background: #f0f0f0; }
    img { max-width: 100px; margin-top: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dashboard Admin - Asdar Store</h2>
    <input type="file" id="buktiAdmin" class="form-control my-3" />
    <button onclick="uploadBukti()" class="btn btn-primary mb-4">Upload Bukti Admin</button>
    <div id="pesananList"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const adminWA = "6281803004607";
    const imgBBKey = "f71ccc1a662c9f8656766990018d3a33";

    let selectedId = null;

    function tampilPesanan() {
      db.ref('pesanan').once('value', snap => {
        const data = snap.val();
        let html = '';
        for (let id in data) {
          const p = data[id];
          html += `
            <div class="card mb-3">
              <div class="card-body">
                <b>ID:</b> ${id}<br/>
                <b>Nama:</b> ${p.nama}<br/>
                <b>Produk:</b> ${p.produk}<br/>
                <b>Nomor/ID:</b> ${p.nomor || '-'}<br/>
                <b>Status:</b> ${p.status}<br/>
                ${p.buktiBayar ? `<b>Bukti Bayar:</b><br/><img src="${p.buktiBayar}" />` : ''}
                ${p.buktiAdmin ? `<br/><b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" />` : ''}
                <br/><br/>
                <button class="btn btn-success btn-sm" onclick="setSelected('${id}')">Pilih</button>
                <button class="btn btn-warning btn-sm" onclick="verifikasi('${id}')">Verifikasi</button>
              </div>
            </div>
          `;
        }
        document.getElementById('pesananList').innerHTML = html;
      });
    }

    function setSelected(id) {
      selectedId = id;
      alert("ID dipilih: " + id);
    }

    async function uploadBukti() {
      if (!selectedId) return alert("Pilih ID pesanan dulu!");
      const file = document.getElementById('buktiAdmin').files[0];
      if (!file) return alert("Pilih gambar dulu!");
      
      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgBBKey}`, {
        method: "POST",
        body: formData
      });

      const json = await res.json();
      const url = json.data.url;

      await db.ref("pesanan/" + selectedId).update({
        buktiAdmin: url,
        status: "Selesai"
      });

      kirimWA(`✅ Pesanan ${selectedId} telah selesai. Bukti dikirim.`);
      alert("Bukti berhasil dikirim!");
      tampilPesanan();
    }

    function verifikasi(id) {
      db.ref("pesanan/" + id).update({ status: "Diproses" });
      kirimWA(`✅ Pesanan ${id} sedang diproses.`);
      tampilPesanan();
    }

    function kirimWA(pesan) {
      fetch("https://starsender.online/api/sendText", {
        method: "POST",
        body: new URLSearchParams({
          appkey: "ab3727c5-e0be-40f9-bb3f-25d93b029f7a",
          authkey: "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq",
          to: adminWA,
          message: pesan
        })
      });
    }

    tampilPesanan();
  </script>
</body>
</html>
