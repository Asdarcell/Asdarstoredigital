<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asdar Store Digital</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f9f9f9;
      --text: #2c3e50;
      --primary: #3498db;
      --card: #ffffff;
      --border: #ddd;
      --shadow: rgba(0,0,0,0.05);
    }
    [data-theme="dark"] {
      --bg: #1a1a2e;
      --text: #e0e0e0;
      --primary: #1abc9c;
      --card: #2c2c40;
      --border: #444;
      --shadow: rgba(0,0,0,0.15);
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
      line-height: 1.6;
      overflow-x: hidden;
    }
    header {
      position: sticky;
      top: 0;
      background: var(--card);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      z-index: 999;
      transition: box-shadow 0.3s ease;
    }
    header.scrolled { box-shadow: 0 4px 12px var(--shadow); }
    header h1 { margin: 0; font-size: 24px; color: var(--primary); }
    .theme-btn { background: transparent; border: none; font-size: 22px; cursor: pointer; color: var(--text); }
    main { max-width: 700px; margin: 20px auto; padding: 0 20px; }
    label { font-weight: 600; margin-top: 15px; display: block; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background-color: var(--card);
      color: var(--text);
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    .info { background: var(--card); padding: 15px; margin-top: 20px; border-left: 5px solid var(--primary); border-radius: 8px; box-shadow: 0 2px 8px var(--shadow); }
    #testimoniContainer { background: var(--card); border-radius: 12px; height: 400px; overflow: hidden; position: relative; box-shadow: 0 4px 12px var(--shadow); border: 1px solid var(--border); padding: 0; display: flex; align-items: center; justify-content: center; }
    #testimoniList { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 20px; animation: scrollUp 40s linear infinite; }
    #testimoniContainer:hover #testimoniList { animation-play-state: paused; }
    @keyframes scrollUp { from { transform: translateY(0%); } to { transform: translateY(-50%); } }
    .testimonial-bubble { background-color: var(--primary); color: white; padding: 10px 15px; border-radius: 20px 20px 20px 5px; margin-bottom: 15px; max-width: 80%; align-self: flex-start; flex-shrink: 0; word-wrap: break-word; }
    .testimonial-bubble b { display: block; font-size: 0.9em; opacity: 0.8; }
    #hasil { margin-top: 30px; background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--shadow); }
    .qr-btn { margin-top: 15px; padding: 12px 20px; text-align: center; border-radius: 8px; text-decoration: none; display: inline-block; width: calc(50% - 10px); font-weight: bold; color: white !important; }
    .qr-btn.upload { background: #28a745; }
    .qr-btn.status { background: #17a2b8; }
    hr { margin: 40px 0; border: 0; border-top: 1px solid var(--border); }
    h2 { color: var(--primary); margin-top: 30px; margin-bottom: 20px; text-align: center; }
    .section-container { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-top: 20px; }
    .faq-item { border-bottom: 1px solid var(--border); padding: 15px 0; }
    .faq-item:last-child { border-bottom: none; }
    .faq-question { cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .faq-question::after { content: 'â–¼'; font-size: 12px; transition: transform 0.3s ease; }
    .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding-top 0.3s ease; padding-top: 0; }
    .faq-item.active .faq-answer { padding-top: 15px; max-height: 200px; }
    .faq-item.active .faq-question::after { transform: rotate(180deg); }
  </style>
</head>
<body data-theme="light">
  <header id="header">
    <h1>Asdar Store Digital</h1>
    <button class="theme-btn" id="themeToggle">ðŸŒ™</button>
  </header>

  <main id="main-content">
    <div data-aos="fade-up" class="section-container">
      <form id="formPesanan">
        <label for="nama">Nama Lengkap</label>
        <input type="text" id="nama" placeholder="Cth: Budi Santoso" required />
        <label for="nomor">Nomor HP / ID Game</label>
        <input type="text" id="nomor" placeholder="Cth: 081234567890 atau ID Game Anda" required />
        <label for="waAktif">Nomor WhatsApp Aktif</label>
        <input type="tel" id="waAktif" placeholder="Cth: 081234567890" pattern="^(08|62)[0-9]{8,15}$" required />
        <label for="kategori">Kategori Produk</label>
        <select id="kategori" required><option value="">Pilih Kategori</option></select>
        <label for="produk">Produk</label>
        <select id="produk" required><option value="">Pilih Produk</option></select>
        <div class="info" id="infoProduk">Harga dan deskripsi akan muncul di sini.</div>
        <button type="submit">Pesan Sekarang</button>
      </form>
    </div>

    <div id="hasil" style="display: none;"></div><hr>
    
    <div data-aos="fade-up">
        <h2>Testimoni Pelanggan Kami</h2>
        <div id="testimoniContainer"><p>Memuat testimoni...</p></div>
    </div>
    
    <div data-aos="fade-up" class="section-container">
        <h2>Beri Kami Testimoni</h2>
        <form id="formTestimoni">
            <label for="testiNama">Nama Anda</label>
            <input type="text" id="testiNama" placeholder="Nama Anda" required>
            <label for="testiPesan">Pesan Anda</label>
            <textarea id="testiPesan" rows="4" placeholder="Bagaimana pengalaman Anda berbelanja di sini?" required></textarea>
            <button type="submit">Kirim Testimoni</button>
            <p id="testiStatus" style="text-align:center; margin-top:10px;"></p>
        </form>
    </div><hr>
    
    <div data-aos="fade-up">
        <h2>Ada Pertanyaan?</h2>
        <div class="section-container" id="faq-container"></div>
    </div><hr>

    <div data-aos="fade-up" class="section-container">
        <h2>Cek Status Pesanan Anda</h2>
        <form id="formCekStatus">
          <label for="idCek">Masukkan ID Pesanan</label>
          <input type="text" id="idCek" placeholder="Cth: P16789..." required />
          <button type="submit">Cek Status</button>
        </form>
    </div>
    
    <div id="dynamic-content-area" style="margin-top: 20px;"></div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        AOS.init({ duration: 800, once: true, offset: 50 });

        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
          storageBucket: "asdarstoredigitalll.appspot.com",
          messagingSenderId: "220670500351",
          appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const functions = firebase.functions();

        const ADMIN_WA_NUMBER = "6281803004607";
        const ADMIN_PANEL_LINK = "https://asdarcell.github.io/Asdarstoredigital/admin.html";

        const formatRupiah = (angka) => String(angka).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        const normalizePhone = (num) => {
            if (!num) return '';
            let n = String(num).replace(/[^0-9]/g, '');
            if (n.startsWith('0')) n = '62' + n.slice(1);
            return n;
        };

        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', currentTheme);
            themeToggle.textContent = currentTheme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', currentTheme);
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            themeToggle.textContent = savedTheme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
        }

        window.addEventListener('scroll', () => {
            document.getElementById('header').classList.toggle('scrolled', window.scrollY > 10);
        });
        
        document.getElementById('formCekStatus').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('idCek').value.trim();
            if (id) window.location.href = `status.html?id=${id}`;
        });

        setupFormPesanan(db, functions, ADMIN_WA_NUMBER, ADMIN_PANEL_LINK, formatRupiah, normalizePhone);
        setupTestimoni(db);
        setupFormTestimoni(db);
        setupFAQ();
        setupKontenDinamis(db);

      } catch (e) {
        console.error("Terjadi error fatal saat inisialisasi:", e);
        document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: sans-serif;"><h1>Oops!</h1><p>Terjadi kesalahan saat memuat halaman. Silakan coba lagi nanti.</p><p><small>Pesan error: ${e.message}</small></p></div>`;
      }
    });

    function setupFormPesanan(db, functions, adminWa, adminLink, formatRupiah, normalizePhone) {
      const form = document.getElementById('formPesanan');
      const kategoriSelect = document.getElementById('kategori');
      const produkSelect = document.getElementById('produk');
      const infoProduk = document.getElementById('infoProduk');
      const hasilDiv = document.getElementById('hasil');

      db.ref('produk').once('value').then(snapshot => {
          const data = snapshot.val() || {};
          for (const kategori in data) {
              kategoriSelect.add(new Option(kategori, kategori));
          }
      }).catch(e => console.error("Gagal memuat kategori:", e));

      kategoriSelect.addEventListener('change', () => {
          produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
          infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini.';
          const kategori = kategoriSelect.value;
          if (!kategori) return;
          db.ref(`produk/${kategori}`).once('value').then(snapshot => {
              const data = snapshot.val() || {};
              for (const nama in data) {
                   produkSelect.add(new Option(nama, nama));
              }
          }).catch(e => console.error("Gagal memuat produk:", e));
      });
   
      produkSelect.addEventListener('change', () => {
          const kategori = kategoriSelect.value;
          const produk = produkSelect.value;
          if (!produk || !kategori) return;
          db.ref(`produk/${kategori}/${produk}`).once('value').then(snapshot => {
              const data = snapshot.val();
              if (data) {
                  infoProduk.innerHTML = `<b>Harga:</b> Rp${formatRupiah(data.harga)}<br><b>Deskripsi:</b> ${data.deskripsi || data.cara || '-'}`;
              }
          }).catch(e => console.error("Gagal memuat detail produk:", e));
      });

      form.addEventListener('submit', async e => {
          e.preventDefault();
          const nama = form.nama.value.trim();
          const nomor = form.nomor.value.trim();
          const waAktif = normalizePhone(form.waAktif.value.trim());
          const kategori = form.kategori.value;
          const produk = form.produk.value;
          const id = "P" + Date.now();

          if (!nama || !nomor || !waAktif || !kategori || !produk) return alert("Harap lengkapi semua field!");

          try {
              const snapProduk = await db.ref(`produk/${kategori}/${produk}`).once('value');
              const dataProduk = snapProduk.val();
              if (!dataProduk) return alert("Produk tidak valid.");
              
              await db.ref('pesanan/' + id).set({
                  nama, nomor, kategori, produk, harga: dataProduk.harga, waktu: new Date().toISOString(), wa_aktif: waAktif, status: 'Belum Bayar'
              });

              hasilDiv.style.display = 'block';
              hasilDiv.innerHTML = `<p class="text-success fw-bold">âœ… Pesanan Anda berhasil dibuat!</p><p><b>ID Pesanan Anda:</b> <code>${id}</code></p><div class="info"><p><strong>Silakan lakukan pembayaran sejumlah Rp${formatRupiah(dataProduk.harga)}</strong> ke salah satu tujuan berikut:</p><ul class="list-unstyled"><li><strong>ShopeePay:</strong> 081803004607</li><li><strong>Dana:</strong> 087755432880</li></ul></div><a class='qr-btn upload' href="uplod.html?id=${id}">ðŸ“¤ Upload Bukti</a><a class='qr-btn status' href="status.html?id=${id}">ðŸ“„ Cek Status</a>`;
              form.reset();
              window.scrollTo({ top: hasilDiv.offsetTop, behavior: 'smooth' });
              
              const pesanAdmin = `ðŸ“¦ Pesanan Baru!\n\nID: *${id}*\nNama: ${nama}\nWA: ${waAktif}\nProduk: ${produk}\nHarga: Rp${formatRupiah(dataProduk.harga)}\n\nCek di Admin Panel:\n${adminLink}`;
              await functions.httpsCallable('sendWaMessage')({ to: adminWa, message: pesanAdmin });
              alert("Pesanan berhasil dibuat!");
          } catch (error) {
              console.error("Error saat memesan:", error);
              alert("Terjadi kesalahan saat memproses pesanan.");
          }
      });
    }

    function setupTestimoni(db) {
      const testimoniContainer = document.getElementById('testimoniContainer');
      db.ref('testimoni').on('value', snap => {
          try {
              const data = snap.val();
              const dataTesti = data && typeof data === 'object' ? Object.values(data) : [];
              
              testimoniContainer.innerHTML = '';

              if (dataTesti.length > 0) {
                  const list = document.createElement('div');
                  list.id = 'testimoniList';

                  let bubbleHTML = '';
                  dataTesti.reverse().forEach(t => {
                      if (t && typeof t === 'object') {
                         const nama = t.nama ? String(t.nama).replace(/</g, "&lt;") : 'Anonim';
                         const pesan = t.pesan ? String(t.pesan).replace(/</g, "&lt;") : '';
                         bubbleHTML += `<div class="testimonial-bubble"><b>${nama}</b>: ${pesan}</div>`;
                      }
                  });

                  if (!bubbleHTML) throw new Error("Data testimoni tidak valid.");

                  list.innerHTML = bubbleHTML + bubbleHTML;
                  testimoniContainer.appendChild(list);

                  let durasi = dataTesti.length * 4.5;
                  if (durasi < 25) durasi = 25;
                  if (durasi > 120) durasi = 120;
                  list.style.animationDuration = `${durasi}s`;

              } else {
                  testimoniContainer.innerHTML = `<p>Belum ada testimoni.</p>`;
              }
          } catch (e) {
              console.error("Error saat memproses testimoni:", e);
              testimoniContainer.innerHTML = `<p>Gagal memuat testimoni.</p>`;
          }
      }, error => {
          console.error("Gagal koneksi ke database testimoni:", error);
          testimoniContainer.innerHTML = `<p>Gagal koneksi ke testimoni.</p>`;
      });
    }

    function setupFormTestimoni(db) {
      const form = document.getElementById('formTestimoni');
      form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const kataKunciNegatif = ['jelek', 'buruk', 'tipu', 'penipu', 'lambat', 'lama', 'mahal', 'kecewa', 'scam', 'bohong', 'anjing', 'babi', 'bangsat', 'tolol', 'goblok'];
          const nama = form.testiNama.value.trim();
          const pesan = form.testiPesan.value.trim();
          const statusEl = document.getElementById('testiStatus');
          
          if (!nama || !pesan) {
              statusEl.textContent = 'Nama dan pesan tidak boleh kosong!';
              statusEl.style.color = 'red';
              return;
          }
          const pesanLower = pesan.toLowerCase();
          if (kataKunciNegatif.some(kata => pesanLower.includes(kata))) {
              statusEl.textContent = 'Mohon gunakan bahasa yang sopan dan relevan.';
              statusEl.style.color = 'red';
              return;
          }
          try {
              await db.ref('testimoni').push({ nama, pesan, waktu: new Date().toISOString() });
              statusEl.textContent = 'Terima kasih! Testimoni Anda telah ditampilkan.';
              statusEl.style.color = 'green';
              form.reset();
          } catch (error) {
              statusEl.textContent = 'Gagal mengirim testimoni. Coba lagi.';
              statusEl.style.color = 'red';
          }
      });
    }

    function setupFAQ() {
      const faqData = [
        { q: "Bagaimana cara memesan?", a: "Pilih kategori dan produk, isi data diri, lalu klik 'Pesan Sekarang'. Lakukan pembayaran sesuai instruksi dan unggah bukti bayar." },
        { q: "Apa saja metode pembayaran yang diterima?", a: "Saat ini kami menerima pembayaran melalui ShopeePay dan Dana. Nomor tujuan akan muncul setelah Anda membuat pesanan." },
        { q: "Berapa lama prosesnya?", a: "Setelah bukti bayar diverifikasi, pesanan akan diproses secepatnya, biasanya dalam 5-15 menit pada jam kerja." },
        { q: "Apakah transaksi di sini aman?", a: "Sangat aman. Kami menjamin kerahasiaan data Anda dan keamanan transaksi. Anda juga bisa mengecek status pesanan kapan saja." }
      ];
      const faqContainer = document.getElementById('faq-container');
      faqData.forEach(item => {
          const faqItem = document.createElement('div');
          faqItem.className = 'faq-item';
          faqItem.innerHTML = `<div class="faq-question">${item.q}</div><div class="faq-answer">${item.a}</div>`;
          faqContainer.appendChild(faqItem);
      });
      document.querySelectorAll('.faq-question').forEach(item => {
          item.addEventListener('click', (e) => {
              const parent = e.currentTarget.parentElement;
              const isActive = parent.classList.contains('active');
              document.querySelectorAll('.faq-item.active').forEach(el => el.classList.remove('active'));
              if (!isActive) parent.classList.add('active');
          });
      });
    }

    function setupKontenDinamis(db) {
      db.ref('dynamicContent/index').once('value').then(snapshot => {
          const konten = snapshot.val() || {};
          if (konten.css) { document.head.insertAdjacentHTML('beforeend', `<style>${konten.css}</style>`); }
          if (konten.html) { document.getElementById('dynamic-content-area').innerHTML = konten.html; }
          if (konten.js) { document.body.insertAdjacentHTML('beforeend', `<script>${konten.js}</script>`); }
      }).catch(e => console.error("Gagal memuat konten dinamis:", e));
    }
  </script>
</body>
</html>
