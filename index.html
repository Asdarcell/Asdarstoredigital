<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asdar Store Digital</title>
    <link rel="icon" href="favicon.png" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome untuk ikon (misal: panah accordion, ikon pengguna) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variabel Tema */
        :root {
            --bg: #f9f9f9;
            --text: #2c3e50;
            --primary: #3498db;
            --card: #ffffff;
            --border: #ddd;
            --primary-rgb: 52, 152, 219; /* RGB for primary color */
        }
        [data-theme="dark"] {
            --bg: #1a1a2e;
            --text: #e0e0e0;
            --primary: #1abc9c;
            --card: #2c2c40;
            --border: #444;
            --primary-rgb: 26, 188, 156; /* RGB for dark primary color */
        }

        /* General Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            margin: 0;
            line-height: 1.6;
        }
        header {
            position: sticky;
            top: 0;
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 999;
        }
        header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--primary);
        }
        .theme-btn {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--text);
            transition: color 0.3s ease;
        }
        .theme-btn:hover {
            color: var(--primary);
        }
        main {
            max-width: 700px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Form & Input Styles (retained for custom elements) */
        label {
            font-weight: 600;
            margin-top: 15px;
            display: block;
            color: var(--text);
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--card);
            color: var(--text);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb, 52, 152, 219), 0.2);
        }
        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }

        /* Info Box */
        .info {
            background: var(--card);
            padding: 15px;
            margin-top: 20px;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--text);
        }

        /* Testimonial Box */
        #testimoniBox {
            background: var(--card);
            padding: 15px;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            min-height: 100px;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #animTestimoni {
            position: absolute;
            width: calc(100% - 30px);
            transition: opacity 0.7s ease-in-out;
            opacity: 0;
        }

        /* Result Section */
        #hasil {
            margin-top: 30px;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .qr-btn {
            margin-top: 15px;
            background: #333;
            color: #fff;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .qr-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .qr-btn:active {
            transform: translateY(0);
        }
        .qr-btn.dana {
            background: #42b72a;
        }
        .qr-btn.shopeepay {
            background: #ee4d2d;
        }

        hr {
            margin: 40px 0;
            border: 0;
            border-top: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Gaya untuk konten dinamis */
        .dynamic-content-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }

        /* Accordion Styles for Products */
        .accordion-item {
            @apply mb-4 bg-white rounded-lg shadow-md overflow-hidden;
            border: 1px solid var(--border);
        }
        [data-theme="dark"] .accordion-item {
            @apply bg-gray-800;
        }
        .accordion-header {
            @apply flex justify-between items-center p-4 cursor-pointer font-semibold text-lg;
            background: var(--card);
            color: var(--text);
        }
        .accordion-header:hover {
            @apply bg-gray-50;
        }
        [data-theme="dark"] .accordion-header:hover {
            @apply bg-gray-700;
        }
        .accordion-content {
            @apply p-4 border-t border-gray-200 hidden;
            background: var(--card);
            color: var(--text);
        }
        [data-theme="dark"] .accordion-content {
            @apply border-gray-700;
        }
        .accordion-header .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .fa-chevron-down {
            transform: rotate(180deg);
        }
        .product-item {
            @apply p-3 border-b border-gray-200 last:border-b-0;
        }
        [data-theme="dark"] .product-item {
            @apply border-gray-700;
        }
        .product-item:hover {
            @apply bg-gray-50;
        }
        [data-theme="dark"] .product-item:hover {
            @apply bg-gray-700;
        }
        .product-item button {
            @apply mt-2 px-4 py-2 text-sm rounded-md;
            width: auto; /* Override global button width */
        }
        .product-item .price {
            @apply font-bold text-blue-600;
        }
        [data-theme="dark"] .product-item .price {
            @apply text-teal-400;
        }

        /* Custom Modal Styling */
        .custom-modal {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] hidden;
        }
        .custom-modal-content {
            @apply bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center;
        }
        [data-theme="dark"] .custom-modal-content {
            @apply bg-gray-800 text-gray-200;
        }
        .custom-modal-content button {
            @apply bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mt-4;
            width: auto;
        }
    </style>
</head>
<body data-theme="light">
    <header id="header">
        <h1>Asdar Store Digital</h1>
        <div class="flex items-center space-x-4">
            <span id="user-status" class="text-sm">Memuat...</span>
            <button class="theme-btn" onclick="toggleTheme()" id="themeToggle">🌙</button>
            <button id="auth-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors duration-300">Login</button>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors duration-300 hidden">Logout</button>
        </div>
    </header>
    <main id="main-content">
        <h2 class="text-2xl font-bold text-center mb-6">Pesan Produk Digital</h2>

        <!-- Product List Section -->
        <h3 class="text-xl font-bold mt-8 mb-4 text-center">Daftar Produk Kami</h3>
        <div id="product-accordion" class="space-y-4">
            <!-- Product categories will be loaded here dynamically -->
            <p class="text-center text-gray-500" id="loading-products">Memuat daftar produk...</p>
        </div>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Formulir Pesanan</h2>
        <form id="formPesanan" class="bg-white p-6 rounded-lg shadow-md">
            <label for="nama" class="block text-sm font-medium mb-1">Nama Lengkap</label>
            <input type="text" id="nama" placeholder="Cth: Budi Santoso" required aria-label="Nama Lengkap" class="input-field" />

            <label for="nomor" class="block text-sm font-medium mb-1">Nomor HP / ID SN (ID Game/Akun)</label>
            <input type="text" id="nomor" placeholder="Cth: 081234567890 atau ID Game Anda" required aria-label="Nomor HP atau ID SN" class="input-field" />

            <label for="waAktif" class="block text-sm font-medium mb-1">Nomor WhatsApp Aktif (untuk notifikasi)</label>
            <input type="tel" id="waAktif" placeholder="Cth: 081234567890" pattern="^(08|62)[0-9]{8,15}$" title="Format nomor WA: 08xxxxxxxxxx atau 62xxxxxxxxxx" required aria-label="Nomor WhatsApp Aktif" class="input-field" />

            <label for="kategori" class="block text-sm font-medium mb-1">Kategori Produk</label>
            <select id="kategori" required aria-label="Kategori Produk" class="input-field">
                <option value="">Pilih Kategori</option>
            </select>

            <label for="produk" class="block text-sm font-medium mb-1">Produk</label>
            <select id="produk" required aria-label="Pilih Produk" class="input-field">
                <option value="">Pilih Produk</option>
            </select>

            <div class="info" id="infoProduk">Harga dan deskripsi produk akan muncul di sini setelah Anda memilih produk.</div>

            <button type="submit" class="btn-primary">Pesan Sekarang</button>
        </form>

        <div id="hasil" class="hidden"></div>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Cek Status Pesanan Anda</h2>
        <form onsubmit="event.preventDefault(); cekStatus();" class="bg-white p-6 rounded-lg shadow-md">
            <label for="idCek" class="block text-sm font-medium mb-1 visually-hidden">Masukkan ID Pesanan</label>
            <input type="text" id="idCek" placeholder="Masukkan ID Pesanan Anda (Cth: P16789...)" required aria-label="ID Pesanan" class="input-field" />
            <button type="submit" class="btn-primary">Cek Status</button>
        </form>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Testimoni Pelanggan Kami</h2>
        <div id="testimoniBox" class="bg-white p-6 rounded-lg shadow-md"><div id="animTestimoni" class="text-gray-500">Memuat testimoni...</div></div>

        <div id="dynamic-content-area"></div>

    </main>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="modal-message" class="text-lg font-medium mb-4"></p>
            <button id="modal-close-btn">OK</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Theme Toggle ---
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggle');
            const currentTheme = body.getAttribute('data-theme');
            const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', nextTheme);
            btn.textContent = nextTheme === 'light' ? '🌙' : '☀️';
            localStorage.setItem('theme', nextTheme);
        }
        // Set initial theme on load
        if (localStorage.getItem('theme')) {
            document.body.setAttribute('data-theme', localStorage.getItem('theme'));
            document.getElementById('themeToggle').textContent = localStorage.getItem('theme') === 'light' ? '🌙' : '☀️';
        } else {
            document.body.setAttribute('data-theme', 'light');
            document.getElementById('themeToggle').textContent = '🌙';
        }

        // --- Custom Alert Modal ---
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showCustomAlert(message) {
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

        // --- Firebase Config & Init ---
        // IMPORTANT: In a Canvas environment, __firebase_config and __initial_auth_token are provided globally.
        // For local testing or non-Canvas deployment, use your actual Firebase config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
            authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
            databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
            projectId: "asdarstoredigitalll-d89c4",
            storageBucket: "asdarstoredigitalll.appspot.com",
            messagingSenderId: "220670500351",
            appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- DOM Elements ---
        const kategoriSelect = document.getElementById('kategori');
        const produkSelect = document.getElementById('produk');
        const infoProduk = document.getElementById('infoProduk');
        const hasilDiv = document.getElementById('hasil');
        const productAccordion = document.getElementById('product-accordion');
        const loadingProducts = document.getElementById('loading-products');

        const produkRef = db.ref('produk');
        const dinamisRef = db.ref('dinamis');
        const testimoniRef = db.ref('testimoni');

        const userStatusSpan = document.getElementById('user-status');
        const authBtn = document.getElementById('auth-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // --- Firebase Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                userStatusSpan.textContent = `Hai, ${user.email || 'Pengguna'}!`;
                authBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                userStatusSpan.textContent = `Anda belum login.`;
                authBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        });

        authBtn.addEventListener('click', () => {
            window.location.href = 'auth.html'; // Redirect to auth page
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showCustomAlert('Anda telah logout.');
            } catch (error) {
                console.error("Logout Error:", error);
                showCustomAlert('Gagal logout. Silakan coba lagi.');
            }
        });

        // --- Helper Functions ---
        function formatRupiah(angka) {
            return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function normalizePhoneNumber(number) {
            if (!number) return '';
            number = number.replace(/[^0-9]/g, '');
            if (number.startsWith('0')) {
                number = '62' + number.slice(1);
            }
            return number;
        }

        // --- Load & Display Products (Accordion) ---
        async function loadProductsForAccordion() {
            try {
                const snapshot = await produkRef.once('value');
                const data = snapshot.val() || {};
                let accordionHtml = '';
                loadingProducts.classList.add('hidden'); // Hide loading text

                if (Object.keys(data).length === 0) {
                    productAccordion.innerHTML = '<p class="text-center text-gray-500">Belum ada produk yang tersedia.</p>';
                    return;
                }

                for (let kategori in data) {
                    accordionHtml += `
                        <div class="accordion-item">
                            <div class="accordion-header" data-target="#collapse-${kategori.replace(/\s/g, '-')}" aria-expanded="false">
                                <span>${kategori}</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="collapse-${kategori.replace(/\s/g, '-')}" class="accordion-content">
                                <ul class="list-none p-0 m-0">
                    `;
                    for (let namaProduk in data[kategori]) {
                        const produk = data[kategori][namaProduk];
                        accordionHtml += `
                            <li class="product-item flex justify-between items-center">
                                <div>
                                    <span class="font-semibold">${namaProduk}</span><br>
                                    <span class="price">Rp${formatRupiah(produk.harga)}</span><br>
                                    <span class="text-sm text-gray-600">${produk.deskripsi || produk.cara || 'Tidak ada deskripsi.'}</span>
                                </div>
                                <button class="btn-primary" onclick="selectProductFromList('${kategori}', '${namaProduk}')">Pesan</button>
                            </li>
                        `;
                    }
                    accordionHtml += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                productAccordion.innerHTML = accordionHtml;
                initAccordions(); // Initialize accordion functionality
            } catch (error) {
                console.error("Error loading products for accordion:", error);
                loadingProducts.classList.remove('hidden');
                loadingProducts.textContent = 'Gagal memuat daftar produk.';
                showCustomAlert("Gagal memuat daftar produk. Silakan coba lagi nanti.");
            }
        }

        function initAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.querySelector(targetId);
                    const icon = header.querySelector('.fa-chevron-down');

                    header.classList.toggle('active');
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        content.style.maxHeight = content.scrollHeight + 'px'; // For smooth transition if needed
                    } else {
                        content.style.maxHeight = null;
                        content.classList.add('hidden');
                    }
                });
            });
        }

        function selectProductFromList(kategori, namaProduk) {
            kategoriSelect.value = kategori;
            kategoriSelect.dispatchEvent(new Event('change')); // Trigger change to load products
            setTimeout(() => { // Give a small delay for products to load
                produkSelect.value = namaProduuk;
                produkSelect.dispatchEvent(new Event('change')); // Trigger change to show info
                showCustomAlert(`Produk "${namaProduk}" dari kategori "${kategori}" telah dipilih di formulir pesanan.`);
                document.getElementById('formPesanan').scrollIntoView({ behavior: 'smooth' }); // Scroll to form
            }, 100);
        }

        // --- Load Data Produk for Form Selects ---
        produkRef.once('value').then(snapshot => {
            const data = snapshot.val() || {};
            kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
            for (let kategori in data) {
                kategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
            }
        }).catch(error => {
            console.error("Error loading categories:", error);
            showCustomAlert("Gagal memuat kategori produk untuk formulir. Silakan coba lagi nanti.");
        });

        kategoriSelect.addEventListener('change', () => {
            produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
            infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
            const kategori = kategoriSelect.value;
            if (!kategori) return;

            produkRef.child(kategori).once('value').then(snapshot => {
                const data = snapshot.val() || {};
                for (let nama in data) {
                    produkSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
                }
            }).catch(error => {
                console.error("Error loading products for category:", error);
                showCustomAlert("Gagal memuat produk untuk kategori ini.");
            });
        });

        produkSelect.addEventListener('change', () => {
            const kategori = kategoriSelect.value;
            const produk = produkSelect.value;
            if (!produk || !kategori) {
                infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
                return;
            }

            produkRef.child(`${kategori}/${produk}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    infoProduk.innerHTML = `<b>Harga:</b> Rp${formatRupiah(data.harga)}<br><b>Deskripsi:</b> ${data.deskripsi || data.cara || '-'}`;
                } else {
                    infoProduk.innerHTML = 'Informasi produk tidak ditemukan.';
                }
            }).catch(error => {
                console.error("Error loading product details:", error);
                infoProduuk.innerHTML = 'Gagal memuat detail produk.';
            });
        });

        // --- Submit Pesanan ---
        document.getElementById('formPesanan').addEventListener('submit', async e => {
            e.preventDefault();

            const nama = document.getElementById('nama').value.trim();
            const nomor = document.getElementById('nomor').value.trim();
            const waAktif = normalizePhoneNumber(document.getElementById('waAktif').value.trim());
            const kategori = kategoriSelect.value;
            const produk = produkSelect.value;
            const waktu = new Date().toISOString();
            const id = "P" + Date.now();

            if (!nama || !nomor || !waAktif || !kategori || !produk) {
                return showCustomAlert("Harap lengkapi semua field yang diperlukan!");
            }

            try {
                const snapProduk = await produkRef.child(`${kategori}/${produk}`).once('value');
                const dataProduk = snapProduk.val();

                if (!dataProduk || typeof dataProduk.harga === 'undefined') {
                    return showCustomAlert("Produk yang dipilih tidak valid atau harga tidak ditemukan.");
                }
                const harga = dataProduk.harga || 0;

                await db.ref('pesanan/' + id).set({
                    nama, nomor, kategori, produk, harga, waktu,
                    wa_aktif: waAktif,
                    status: 'Belum Bayar'
                });

                hasilDiv.classList.remove('hidden');
                hasilDiv.innerHTML = `
                    <p class="text-green-600 font-semibold text-lg">✅ Pesanan Anda berhasil dibuat!</p>
                    <p class="text-gray-700"><b>ID Pesanan Anda:</b> <code class="bg-gray-200 p-1 rounded">${id}</code></p>
                    <div class="info">
                        <p class="font-bold text-lg"><strong>Silakan lakukan pembayaran sejumlah Rp${formatRupiah(harga)}</strong> ke salah satu rekening/ewallet berikut:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li><strong>ShopeePay:</strong> 081803004607</li>
                            <li><strong>Dana:</strong> 087755432880</li>
                            <li><strong>OVO:</strong> 087755432880</li>
                            <li><strong>GoPay:</strong> 087755432880</li>
                        </ul>
                        <p class="mt-3">Mohon transfer sesuai nominal agar pesanan cepat diproses.</p>
                    </div>
                    <a class='qr-btn bg-blue-600 hover:bg-blue-700' href="upload.html?id=${id}">📤 Upload Bukti Bayar Sekarang</a>
                    <a class='qr-btn bg-gray-600 hover:bg-gray-700' href="status.html?id=${id}">📄 Cek Status Pesanan Anda</a>
                    <a class='qr-btn dana' href="https://link.dana.id/qr/d?c=${harga}&qr=EAE79493-21BC-4537-832F-C3D7EF3C1A1D" target="_blank" rel="noopener noreferrer">💸 Bayar via Dana (Klik Langsung)</a>
                    <a class='qr-btn shopeepay' href="https://link.shopeepay.co.id/?amount=${harga}&ref_id=${id}&callback=https://asdarcell.github.io/Asdarstoredigital/status.html?id=${id}" target="_blank" rel="noopener noreferrer">🛒 Bayar via ShopeePay (Klik Langsung)</a>
                `;

                document.getElementById('formPesanan').reset();
                infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
                kategoriSelect.value = '';
                produkSelect.innerHTML = '<option value="">Pilih Produk</option>';

                await kirimNotifWA(id, nama, produk, waAktif, harga);
                showCustomAlert("Pesanan berhasil dibuat! Silakan lakukan pembayaran. ID Pesanan Anda telah ditampilkan.");
                hasilDiv.scrollIntoView({ behavior: 'smooth' }); // Scroll to result

            } catch (error) {
                console.error("Error creating order:", error);
                showCustomAlert("Terjadi kesalahan saat membuat pesanan. Silakan coba lagi.");
            }
        });

        // --- Cek Status Pesanan ---
        function cekStatus() {
            const id = document.getElementById('idCek').value.trim();
            if (id) {
                window.location.href = `status.html?id=${id}`;
            } else {
                showCustomAlert("Mohon masukkan ID Pesanan Anda untuk cek status.");
            }
        }

        // --- Kirim Notifikasi WA ke Admin (NgirimWA API) ---
        const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
        const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
        const ADMIN_WA_NUMBER = "6281803004607"; // Nomor WA Admin

        async function kirimNotifWA(id, nama, produk, waAktif, harga) {
            const pesan = `📦 Pesanan Baru Asdar Store Digital!\n\n` +
                            `🆔 *ID Pesanan:* ${id}\n` +
                            `👤 *Nama Pembeli:* ${nama}\n` +
                            `📞 *WA Aktif Pembeli:* ${waAktif}\n` +
                            `🎮 *Produk Dipesan:* ${produk}\n` +
                            `💰 *Total Harga:* Rp${formatRupiah(harga)}\n\n` +
                            `Segera cek dan proses di dashboard admin:\n` +
                            `https://asdarcell.github.io/Asdarstoredigital/admin.html`; // Pastikan URL admin ini benar

            const formData = new URLSearchParams();
            formData.append("appkey", NGIRIMWA_APPKEY);
            formData.append("authkey", NGIRIMWA_AUTHKEY);
            formData.append("to", ADMIN_WA_NUMBER);
            formData.append("message", pesan);

            try {
                const response = await fetch("https://api.ngirimwa.com/sendText", { // Pastikan endpoint ini benar
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData
                });
                const result = await response.json();
                if (result.status === "success") {
                    console.log("Notifikasi WA ke admin berhasil dikirim:", result);
                } else {
                    console.warn("Gagal mengirim notifikasi WA ke admin:", result);
                }
            } catch (error) {
                console.error("Error saat mengirim notifikasi WA ke admin:", error);
            }
        }

        // --- Testimoni Berjalan ---
        let dataTesti = [];
        let testiIndex = 0;
        const animTestimoniDiv = document.getElementById('animTestimoni');

        function tampilkanSatuTesti() {
            if (!dataTesti.length) {
                animTestimoniDiv.innerHTML = "Belum ada testimoni.";
                animTestimoniDiv.style.opacity = '1';
                return;
            }

            const t = dataTesti[testiIndex];
            animTestimoniDiv.style.opacity = '0';
            setTimeout(() => {
                animTestimoniDiv.innerHTML = `⭐️⭐️⭐️⭐️⭐️<br/><b>${t.nama || 'Anonim'}</b>: ${t.pesan || ''}`;
                animTestimoniDiv.style.opacity = '1';
                testiIndex = (testiIndex + 1) % dataTesti.length;
                setTimeout(tampilkanSatuTesti, 5000);
            }, 700);
        }

        testimoniRef.on('value', snap => {
            const data = snap.val() || {};
            dataTesti = Object.values(data).reverse();
            tampilkanSatuTesti();
        }, error => {
            console.error("Error loading testimonials:", error);
            animTestimoniDiv.innerHTML = "Gagal memuat testimoni.";
            animTestimoniDiv.style.opacity = '1';
        });

        // --- Render Konten Dinamis dari Admin ---
        // New structure for dynamic content: dinamis/{pageName}/{blockId}
        async function renderDynamicContent() {
            try {
                const snapshot = await dinamisRef.child('index').once('value');
                const dynamicContentArea = document.getElementById('dynamic-content-area');
                dynamicContentArea.innerHTML = ''; // Clear previous content

                const blocks = snapshot.val() || {};
                // Convert object to array and sort by 'order' property if it exists
                const sortedBlocks = Object.keys(blocks).map(key => ({ id: key, ...blocks[key] }))
                                        .sort((a, b) => (a.order || 0) - (b.order || 0));

                let combinedCss = '';
                let combinedJs = '';

                sortedBlocks.forEach(block => {
                    if (block.html) {
                        const section = document.createElement('div');
                        section.className = 'dynamic-content-section'; // Apply basic styling
                        section.innerHTML = block.html;
                        dynamicContentArea.appendChild(section);

                        // Re-execute scripts within dynamic HTML
                        section.querySelectorAll('script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }
                    if (block.css) {
                        combinedCss += block.css + '\n';
                    }
                    if (block.js) {
                        combinedJs += block.js + '\n';
                    }
                });

                // Apply combined CSS
                let styleTag = document.getElementById('dynamic-css-index');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'dynamic-css-index';
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = combinedCss;

                // Execute combined JS
                let scriptTag = document.getElementById('dynamic-js-index');
                if (scriptTag) {
                    scriptTag.remove(); // Remove old script to re-execute
                }
                scriptTag = document.createElement('script');
                scriptTag.id = 'dynamic-js-index';
                scriptTag.textContent = combinedJs;
                document.body.appendChild(scriptTag);

                console.log("Konten dinamis untuk index.html berhasil dimuat.");
            } catch (error) {
                console.error("Gagal memuat konten dinamis untuk index.html:", error);
            }
        }

        // Panggil fungsi render konten dinamis dan produk saat DOM siap
        document.addEventListener('DOMContentLoaded', () => {
            loadProductsForAccordion();
            renderDynamicContent();
        });
    </script>
</body>
</html>
