<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Asdar Store Digital - Jual Produk Game Murah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
      --danger-color: #dc3545; --info-color: #0dcaf0; --warning-color: #ffc107;
      --light-gray: #f8f9fa; --border-color: #dee2e6;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; }
    .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
    .product-list .list-group-item { cursor: pointer; transition: transform 0.2s; }
    .product-list .list-group-item:hover { transform: translateY(-3px); }
    .product-list .list-group-item.active { border-left: 4px solid var(--primary-color); background-color: #e9f5ff; font-weight: 500; }
    .whatsapp-btn { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .testimonial-card { border-left: 4px solid var(--primary-color); }
    .price-promo { font-size: 0.9em; color: var(--danger-color); text-decoration: line-through; margin-right: 5px; }
  </style>
</head>
<body>

  <div class="toast-container"></div>
  <a href="https://wa.me/628124567890?text=Halo%20Asdar%20Store" class="btn btn-success rounded-circle whatsapp-btn" target="_blank">
    <i class="fab fa-whatsapp fa-2x"></i>
  </a>
  <div class="container py-4">
    <div class="text-center mb-4">
      <h1 class="display-5 fw-bold">Asdar Store Digital</h1>
      <p class="text-muted">Jual produk game, aplikasi, dan pulsa termurah!</p>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">Pesan Produk</h3>
        <form id="formPesan" class="row g-3">
          <div class="col-12">
            <label class="form-label">Nama Anda</label>
            <input type="text" class="form-control" id="nama" placeholder="Cth: Budi" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Nomor WhatsApp Aktif</label>
            <input type="tel" class="form-control" id="wa_aktif" placeholder="Cth: 08123456789" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" id="nomorLabel">ID/Nomor (Sesuai Produk)</label>
            <input type="text" class="form-control" id="nomor" placeholder="Cth: 12345678" required />
          </div>
          <div class="col-12">
            <label class="form-label">Kategori & Produk</label>
            <div id="produkList" class="row g-2">
              <div class="col-12"><p class="text-center text-muted p-4">Memuat produk...</p></div>
            </div>
            <input type="hidden" id="produkPilihan" required />
          </div>
          <div class="col-12">
            <label class="form-label">Informasi Tambahan (Opsional)</label>
            <textarea class="form-control" id="catatan" rows="2" placeholder="Cth: Kirim bukti ke WA saya"></textarea>
          </div>
          <div class="col-12">
            <div id="infoProduk" class="card p-3 d-none">
              <div class="card-body p-0">
                <h5 class="card-title" id="infoProdukTitle"></h5>
                <p class="card-text mb-2">Harga: <strong id="infoHarga"></strong></p>
                <div id="promoInfo" class="mb-2 d-none"><p class="mb-0 text-success fw-bold"><i class="fas fa-tags me-1"></i> Promo berlaku! Harga setelah diskon: <span id="hargaPromoFinal"></span></p></div>
                <p class="card-text mb-0">Cara Pesan:</p>
                <p class="card-text small text-muted" id="infoCara"></p>
              </div>
            </div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Pesan Sekarang</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h3 class="card-title text-center">Metode Pembayaran</h3>
        <div id="payment-methods" class="text-center">Memuat info pembayaran...</div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h3 class="card-title text-center">Testimoni</h3>
        <form id="formTestimoni" class="mb-4">
            <div class="row g-3">
                <div class="col-md-6"><input type="text" class="form-control" id="testiNama" placeholder="Nama Anda" required></div>
                <div class="col-md-6"><input type="text" class="form-control" id="testiIsi" placeholder="Isi testimoni Anda..." required></div>
            </div>
            <button type="submit" class="btn btn-success mt-2">Kirim Testimoni</button>
        </form>
        <div id="testimoniList" class="list-group">
            <p class="text-center text-muted p-4">Memuat testimoni...</p>
        </div>
      </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h3 class="card-title text-center">FAQ (Pertanyaan Umum)</h3>
            <div class="accordion" id="faqAccordion">
                <p class="text-center text-muted p-4">Memuat FAQ...</p>
            </div>
        </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
        authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
        databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
        projectId: "asdarstoredigitalll-d89c4",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let produkDipilih = null;
    let hakDiskonPelanggan = false;
    let resellerUID = null;

    // --- FUNGSI BARU UNTUK RESELLER ---
    const getUrlParams = () => new URLSearchParams(window.location.search);
    const checkResellerReferral = () => {
        const params = getUrlParams();
        if (params.has('r')) {
            const uid = params.get('r');
            sessionStorage.setItem('reseller_uid', uid);
            resellerUID = uid;
            console.log(`Referral dari reseller UID: ${resellerUID}`);
        } else if (sessionStorage.getItem('reseller_uid')) {
            resellerUID = sessionStorage.getItem('reseller_uid');
            console.log(`Referral dari sesi sebelumnya, UID: ${resellerUID}`);
        }
    };
    
    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    const showToast = (message, type = 'info') => {
      const toastId = 'toast-' + Date.now();
      const toastBG = { success: 'bg-success', error: 'bg-danger', info: 'bg-primary' }[type] || 'bg-secondary';
      const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white ${toastBG} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
      document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHTML);
      const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
      toast.show();
      document.getElementById(toastId).addEventListener('hidden.bs.toast', e => e.target.remove());
    };

    const loadProduk = () => {
        db.ref('produk').once('value').then(snapshot => {
            const produkListDiv = document.getElementById('produkList');
            if (!snapshot.exists()) {
                produkListDiv.innerHTML = '<p class="text-center text-muted p-4">Produk belum tersedia saat ini.</p>';
                return;
            }
            const produkByKategori = snapshot.val();
            let html = '';
            for (const kategori in produkByKategori) {
                html += `<div class="col-12"><h5 class="mt-2">${kategori}</h5></div>`;
                const varianList = Object.entries(produkByKategori[kategori]).map(([varian, data]) => ({ varian, ...data }));
                varianList.sort((a,b) => (a.urutan || 0) - (b.urutan || 0));
                varianList.forEach(item => {
                    const hargaNormal = item.harga;
                    let hargaTampil = hargaNormal;
                    let hargaPromoHTML = '';
                    if (item.promo) {
                        hargaTampil = item.promo.jenis === 'persen' ? hargaNormal - (hargaNormal * item.promo.nilai / 100) : hargaNormal - item.promo.nilai;
                        hargaPromoHTML = `<span class="price-promo">${formatRupiah(hargaNormal)}</span>`;
                    }
                    html += `
                        <div class="col-md-6 col-lg-4">
                            <div class="card p-3 mb-2 product-list-item" data-kategori="${kategori}" data-varian="${item.varian}" data-harga="${hargaTampil}" data-harganormal="${hargaNormal}" data-cara="${item.cara}" data-promo='${JSON.stringify(item.promo || {})}' onclick="pilihProduk(this)">
                                <h6 class="mb-1">${item.varian}</h6>
                                <p class="mb-0 small text-muted">${hargaPromoHTML}<strong>${formatRupiah(hargaTampil)}</strong></p>
                            </div>
                        </div>`;
                });
            }
            produkListDiv.innerHTML = html;
        }).catch(err => {
            document.getElementById('produkList').innerHTML = `<p class="text-center text-danger p-4">Gagal memuat produk: ${err.message}</p>`;
        });
    };

    window.pilihProduk = (el) => {
        document.querySelectorAll('.product-list-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        
        produkDipilih = {
            kategori: el.dataset.kategori,
            varian: el.dataset.varian,
            harga_final: parseFloat(el.dataset.harga),
            harga_asli: parseFloat(el.dataset.harganormal),
            cara: el.dataset.cara,
            promo: JSON.parse(el.dataset.promo)
        };
        
        document.getElementById('produkPilihan').value = `${produkDipilih.kategori} - ${produkDipilih.varian}`;
        
        const infoProdukDiv = document.getElementById('infoProduk');
        document.getElementById('infoProdukTitle').textContent = `${produkDipilih.kategori} - ${produkDipilih.varian}`;
        document.getElementById('infoHarga').textContent = formatRupiah(produkDipilih.harga_asli);
        document.getElementById('infoCara').textContent = produkDipilih.cara;
        
        const promoInfoDiv = document.getElementById('promoInfo');
        if (produkDipilih.promo && Object.keys(produkDipilih.promo).length > 0) {
            promoInfoDiv.classList.remove('d-none');
            document.getElementById('hargaPromoFinal').textContent = formatRupiah(produkDipilih.harga_final);
        } else {
            promoInfoDiv.classList.add('d-none');
        }

        infoProdukDiv.classList.remove('d-none');
        document.getElementById('nomorLabel').textContent = `ID/Nomor (${produkDipilih.kategori})`;
    };
    
    const submitOrder = async (e) => {
      e.preventDefault();
      if (!produkDipilih) {
        showToast("Pilih produk terlebih dahulu!", "error");
        return;
      }
      
      const nama = document.getElementById('nama').value;
      const wa_aktif = document.getElementById('wa_aktif').value.replace(/\D/g, '');
      const nomor = document.getElementById('nomor').value;
      const catatan = document.getElementById('catatan').value;

      document.getElementById('submitBtn').disabled = true;

      const orderData = {
        nama, wa_aktif, nomor, catatan,
        kategori: produkDipilih.kategori,
        produk: produkDipilih.varian,
        harga_asli: produkDipilih.harga_asli,
        harga_final: produkDipilih.harga_final,
        promo_digunakan: produkDipilih.promo.jenis ? true : false,
        waktu: new Date().toISOString(),
        status: 'Belum Bayar',
        
        // --- DATA BARU UNTUK RESELLER ---
        reseller_uid: resellerUID || null
      };

      const newOrderRef = db.ref('pesanan').push();
      await newOrderRef.set(orderData);
      const orderId = newOrderRef.key;

      const pesanWhatsApp = `
Halo admin Asdar Store, saya ingin memesan:
- Produk: ${orderData.kategori} - ${orderData.produk}
- ID/Nomor: ${orderData.nomor}
- Nama: ${orderData.nama}
- Harga: ${formatRupiah(orderData.harga_final)}
- Catatan: ${orderData.catatan || '-'}
ID Pesanan: ${orderId}

Saya sudah transfer. Mohon diproses.
      `;
      window.open(`https://wa.me/628124567890?text=${encodeURIComponent(pesanWhatsApp)}`, '_blank');
      
      showToast("Pesanan berhasil dibuat! Silakan hubungi admin di WhatsApp.", "success");
      document.getElementById('formPesan').reset();
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('infoProduk').classList.add('d-none');
      produkDipilih = null;
    };

    const loadTestimoni = () => {
        db.ref('testimonials').orderByChild('status').equalTo('disetujui').limitToLast(5).on('value', snap => {
            const testimoniList = document.getElementById('testimoniList');
            if(!snap.exists()) { testimoniList.innerHTML = '<p class="text-center text-muted p-4">Belum ada testimoni.</p>'; return; }
            let html = '';
            snap.forEach(child => {
                const testi = child.val();
                html = `<div class="card p-3 mb-2 testimonial-card"><h6 class="mb-1">${testi.nama}</h6><p class="mb-0 small text-muted">"${testi.isi}"</p></div>` + html;
            });
            testimoniList.innerHTML = html;
        });
    };

    const submitTestimoni = async (e) => {
        e.preventDefault();
        const nama = document.getElementById('testiNama').value;
        const isi = document.getElementById('testiIsi').value;
        if (nama && isi) {
            await db.ref('testimonials').push({ nama, isi, status: 'pending', createdAt: new Date().toISOString() });
            showToast("Terima kasih! Testimoni Anda akan dimoderasi.", "success");
            document.getElementById('formTestimoni').reset();
        }
    };
    
    const loadPaymentMethods = () => {
        db.ref('infoPembayaran').once('value', s => {
            const container = document.getElementById('payment-methods');
            const data = s.val() || {};
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<p>Info pembayaran belum diatur.</p>';
                return;
            }
            let html = '<div class="row justify-content-center">';
            for(const key in data) {
                const method = data[key];
                html += `
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card p-3 h-100">
                            <h5 class="card-title text-center">${key}</h5>
                            <p class="card-text text-center mb-1">Nomor: <strong>${method.nomor}</strong></p>
                            <p class="card-text text-center mb-0">A.N: ${method.nama}</p>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        });
    };
    
    const loadFaq = () => {
        db.ref('faq').once('value', s => {
            const container = document.getElementById('faqAccordion');
            const faqs = s.val();
            if (!faqs || faqs.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">Belum ada FAQ.</p>';
                return;
            }
            
            let html = '';
            faqs.forEach((faq, index) => {
                const id = `faq-${index}`;
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${id}-heading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}-collapse" aria-expanded="false" aria-controls="${id}-collapse">
                                ${faq.q}
                            </button>
                        </h2>
                        <div id="${id}-collapse" class="accordion-collapse collapse" aria-labelledby="${id}-heading" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                ${faq.a}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        });
    };

    document.addEventListener('DOMContentLoaded', () => {
        checkResellerReferral();
        loadProduk();
        loadTestimoni();
        loadPaymentMethods();
        loadFaq();
        
        document.getElementById('formPesan').addEventListener('submit', submitOrder);
        document.getElementById('formTestimoni').addEventListener('submit', submitTestimoni);

        // Cek apakah nomor WA sudah pernah berhak diskon
        const wa_input = document.getElementById('wa_aktif');
        if (wa_input) {
            wa_input.addEventListener('blur', () => {
                const nomorWA = wa_input.value.replace(/\D/g, '');
                if (nomorWA.length > 8) {
                    db.ref('hakDiskon/' + nomorWA).once('value').then(snapshot => {
                        hakDiskonPelanggan = snapshot.val() === true;
                        if (hakDiskonPelanggan) {
                            showToast("Selamat! Anda berhak mendapatkan diskon khusus!", "info");
                        }
                    });
                }
            });
        }
    });
  </script>
</body>
</html>
