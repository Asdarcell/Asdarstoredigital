<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Toko Asdar Store Digital</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; }
  h1 { text-align: center; margin-bottom: 30px; }
  .produk-list { display: grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap: 20px; }
  .produk-item { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .produk-item h3 { margin-top: 0; }
  .produk-item button {
    margin-top: 10px;
    background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;
    font-weight: 600;
  }
  form.order-form { margin-top: 40px; max-width: 400px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
  form.order-form label { display: block; margin-top: 12px; font-weight: 600; }
  form.order-form input, form.order-form select {
    width: 100%; padding: 8px 10px; margin-top: 6px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;
  }
  form.order-form button {
    margin-top: 20px; background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 700;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>Asdar Store Digital - Produk</h1>

<div class="produk-list" id="produkList">
  <!-- Produk akan muncul di sini -->
</div>

<form class="order-form" id="orderForm" onsubmit="return pesanProduk()">
  <h2>Pesan Produk</h2>
  <label for="namaPemesan">Nama Anda</label>
  <input type="text" id="namaPemesan" required placeholder="Masukkan nama lengkap" />

  <label for="produkDipilih">Pilih Produk</label>
  <select id="produkDipilih" required>
    <option value="">-- Pilih produk --</option>
  </select>

  <label for="idPelanggan">ID Pelanggan / Nomor</label>
  <input type="text" id="idPelanggan" required placeholder="Misal: 1234567890" />

  <button type="submit">Kirim Pesanan</button>
</form>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Config Firebase sama dengan admin
  const firebaseConfig = {
    apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
    authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
    databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
    projectId: "asdarstoredigitalll-d89c4",
    storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
    messagingSenderId: "220670500351",
    appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Fungsi load produk untuk tampil di daftar dan select
  function loadProduk() {
    const produkListEl = document.getElementById('produkList');
    const produkSelectEl = document.getElementById('produkDipilih');
    produkListEl.innerHTML = 'Memuat produk...';
    produkSelectEl.innerHTML = '<option value="">-- Pilih produk --</option>';

    db.ref('produk').on('value', snapshot => {
      produkListEl.innerHTML = '';
      produkSelectEl.innerHTML = '<option value="">-- Pilih produk --</option>';

      if (!snapshot.exists()) {
        produkListEl.innerHTML = '<p>Tidak ada produk tersedia.</p>';
        return;
      }

      snapshot.forEach(childSnap => {
        const data = childSnap.val();
        const id = childSnap.key;

        // Tampilkan produk di list
        produkListEl.innerHTML += `
          <div class="produk-item">
            <h3>${data.nama}</h3>
            <p>Kategori: ${data.kategori}</p>
            <p>Harga: Rp${data.harga.toLocaleString()}</p>
          </div>
        `;

        // Tambah ke pilihan select
        produkSelectEl.innerHTML += `<option value="${data.nama}">${data.nama} - Rp${data.harga.toLocaleString()}</option>`;
      });
    });
  }

  // Fungsi submit pesan produk
  function pesanProduk() {
    const nama = document.getElementById('namaPemesan').value.trim();
    const produk = document.getElementById('produkDipilih').value;
    const idpel = document.getElementById('idPelanggan').value.trim();

    if (!nama || !produk || !idpel) {
      alert('Mohon lengkapi semua data.');
      return false;
    }

    const newOrderRef = db.ref('transaksi').push();
    newOrderRef.set({
      nama: nama,
      produkNama: produk,
      idpel: idpel,
      harga: 0,  // Harga bisa diisi jika kamu mau ambil dari produk (bisa dikembangkan)
      status: 'Pending',
      buktiBayarUrl: ''
    }).then(() => {
      alert('Pesanan berhasil dikirim. Terima kasih!');
      document.getElementById('orderForm').reset();
    }).catch(err => {
      alert('Gagal mengirim pesanan: ' + err.message);
    });

    return false; // agar tidak reload page
  }

  loadProduk();
</script>

</body>
</html>

<!-- Tambah input harga & upload bukti bayar di form -->
<label for="hargaProduk">Harga (Rp)</label>
<input type="number" id="hargaProduk" readonly />

<label for="buktiBayar">Upload Bukti Bayar</label>
<input type="file" id="buktiBayar" accept="image/*" />

<!-- Update button pesan -->
<button type="submit">Kirim Pesanan + Bukti Bayar</button>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script>
  const storage = firebase.storage();

  // Saat pilih produk, update harga otomatis
  document.getElementById('produkDipilih').addEventListener('change', function() {
    const produkTerpilih = this.value;
    if (!produkTerpilih) {
      document.getElementById('hargaProduk').value = '';
      return;
    }
    // Cari harga produk dari Firebase
    db.ref('produk').orderByChild('nama').equalTo(produkTerpilih).once('value', snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(childSnap => {
          const harga = childSnap.val().harga;
          document.getElementById('hargaProduk').value = harga;
        });
      }
    });
  });

  async function pesanProduk() {
    const nama = document.getElementById('namaPemesan').value.trim();
    const produk = document.getElementById('produkDipilih').value;
    const idpel = document.getElementById('idPelanggan').value.trim();
    const harga = parseInt(document.getElementById('hargaProduk').value);
    const fileBukti = document.getElementById('buktiBayar').files[0];

    if (!nama || !produk || !idpel || isNaN(harga)) {
      alert('Mohon lengkapi semua data.');
      return false;
    }

    // Upload bukti bayar dulu jika ada
    let urlBuktiBayar = '';
    if (fileBukti) {
      const namaFile = `buktiBayar/${Date.now()}_${fileBukti.name}`;
      const storageRef = storage.ref(namaFile);
      try {
        const snapshot = await storageRef.put(fileBukti);
        urlBuktiBayar = await snapshot.ref.getDownloadURL();
      } catch (err) {
        alert('Gagal upload bukti bayar: ' + err.message);
        return false;
      }
    }

    // Simpan transaksi ke database
    const newOrderRef = db.ref('transaksi').push();
    newOrderRef.set({
      nama: nama,
      produkNama: produk,
      idpel: idpel,
      harga: harga,
      status: 'Pending',
      buktiBayarUrl: urlBuktiBayar
    }).then(() => {
      alert('Pesanan berhasil dikirim. Terima kasih!');

      // Kirim notifikasi WA ke admin (ganti nomor admin sesuai)
      const nomorAdmin = "6281803004607"; // contoh nomor admin (format internasional tanpa +)
      const pesanWA = encodeURIComponent(
        `Pesanan baru dari *${nama}*\nProduk: *${produk}*\nID Pelanggan: *${idpel}*\nHarga: *Rp${harga.toLocaleString()}*\nStatus: *Pending*`
      );
      window.open(`https://wa.me/${nomorAdmin}?text=${pesanWA}`, '_blank');

      document.getElementById('orderForm').reset();
      document.getElementById('hargaProduk').value = '';
    }).catch(err => {
      alert('Gagal mengirim pesanan: ' + err.message);
    });

    return false; // agar tidak reload halaman
  }
</script>
