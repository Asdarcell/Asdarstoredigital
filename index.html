<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asdar Store Digital</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db; --card: #ffffff;
      --border: #ddd; --shadow: rgba(0,0,0,0.05); --success: #28a745; --danger: #dc3545;
    }
    [data-theme="dark"] {
      --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c; --card: #2c2c40;
      --border: #444; --shadow: rgba(0,0,0,0.15); --success: #2ecc71; --danger: #e74c3c;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); transition: all 0.3s ease; margin: 0; line-height: 1.6; }
    header { position: sticky; top: 0; background: var(--card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 999; }
    main { max-width: 700px; margin: 20px auto; padding: 0 20px; }
    label { font-weight: 600; margin-top: 15px; display: block; }
    input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid var(--border); background-color: var(--card); color: var(--text); }
    button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; font-size: 16px; }
    .info { background: var(--card); padding: 15px; margin-top: 20px; border-left: 5px solid var(--primary); border-radius: 8px; }
    #hasil { margin-top: 30px; background: var(--card); padding: 20px; border-radius: 8px; }
    hr { margin: 40px 0; border: 0; border-top: 1px solid var(--border); }
    h2 { color: var(--primary); text-align: center; }
    .section-container { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-top: 20px; }
    
    /* Style untuk Fitur Baru */
    .search-box { margin-bottom: 15px; }
    .voucher-section .input-group { margin-top: 8px; }
    .voucher-section .input-group .form-control { margin-bottom: 0; }
    .voucher-section .input-group button { border-radius: 0 8px 8px 0; width: auto; margin: 0; }
    #voucherStatus { font-size: 0.9em; font-weight: 500; height: 1.2em; margin-top: 5px; }
    .text-success { color: var(--success) !important; }
    .text-danger { color: var(--danger) !important; }
    .original-price-striked { text-decoration: line-through; opacity: 0.6; font-size: 0.9em; }
    .discount-offer { border: 2px dashed var(--success); background-color: hsla(145, 63%, 49%, 0.1); padding: 20px; margin-top: 25px; border-radius: 12px; text-align: center; }
    .discount-offer h4 { color: var(--success); font-weight: 600; }
    .discount-offer .btn-share { background-color: var(--success); }
    select option:disabled { color: #aaa; background: #eee; }
    [data-theme="dark"] select option:disabled { background: #2c2c40; color: #666; }

    /* Style lain yang sudah ada tidak diubah */
  </style>
</head>
<body data-theme="light">
  <header id="header">
    <h1>Asdar Store Digital</h1>
    <div class="d-flex align-items-center">
      <button class="theme-btn me-2" onclick="toggleTheme()" id="themeToggle">üåô</button>
    </div>
  </header>

  <main id="main-content">
    <div data-aos="fade-up" class="section-container">
      <form id="formPesanan">
        <label for="nama">Nama Lengkap</label>
        <input type="text" id="nama" placeholder="Cth: Budi Santoso" required />
        <label for="nomor">Nomor HP / ID Game</label>
        <input type="text" id="nomor" placeholder="Cth: 081234567890 atau ID Game Anda" required />
        <label for="waAktif">Nomor WhatsApp Aktif</label>
        <input type="tel" id="waAktif" placeholder="Cth: 081234567890" pattern="^(08|62)[0-9]{8,15}$" required />
        
        <hr>
        
        <div class="search-box">
            <label for="searchProduk">Cari Produk</label>
            <input type="search" id="searchProduk" class="form-control" placeholder="Ketik nama produk...">
        </div>
        
        <label for="kategori">Kategori Produk</label>
        <select id="kategori" required><option value="">Pilih Kategori</option></select>
        
        <label for="produk">Produk</label>
        <select id="produk" required><option value="">Pilih Produk</option></select>
        
        <div class="info" id="infoProduk">Harga dan deskripsi akan muncul di sini.</div>

        <div class="voucher-section mt-3">
          <label for="voucherCode">Kode Voucher (Jika ada)</label>
          <div class="input-group">
            <input type="text" id="voucherCode" class="form-control" placeholder="Masukkan kode voucher">
            <button class="btn btn-outline-secondary" type="button" id="applyVoucherBtn">Gunakan</button>
          </div>
          <div id="voucherStatus"></div>
        </div>
        
        <button type="submit" id="submitBtn">Pesan Sekarang</button>
      </form>
    </div>

    <div id="hasil" style="display: none;"></div>
    
    <hr>
    <div data-aos="fade-up"> <h2>Testimoni Pelanggan Kami</h2> <div id="testimoniContainer">...</div> </div>
    <hr>
    <div data-aos="fade-up"> <h2>Ada Pertanyaan?</h2> <div class="section-container" id="faq-container">...</div> </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });
    
    // === Firebase Config & Inisialisasi ===
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com", projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll.appspot.com", messagingSenderId: "220670500351", appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ADMIN_WA_NUMBER = "6281803004607";

    // === UI Elements & Global State ===
    const searchProdukInput = document.getElementById('searchProduk');
    const kategoriSelect = document.getElementById('kategori');
    const produkSelect = document.getElementById('produk');
    const infoProduk = document.getElementById('infoProduk');
    const hasilDiv = document.getElementById('hasil');
    const applyVoucherBtn = document.getElementById('applyVoucherBtn');
    const voucherCodeInput = document.getElementById('voucherCode');
    const voucherStatus = document.getElementById('voucherStatus');
    const submitBtn = document.getElementById('submitBtn');

    let allProductsData = {};
    let currentProductPrice = 0;
    let finalPrice = 0;
    let appliedVoucher = null;

    // === Helper Functions (Tidak Diubah) ===
    const formatRupiah = (angka) => (angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    const normalizePhone = (num) => { if (!num) return ''; let n = String(num).replace(/[^0-9]/g, ''); if (n.startsWith('0')) n = '62' + n.slice(1); return n; };
    window.toggleTheme = () => { const theme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'; document.body.setAttribute('data-theme', theme); document.getElementById('themeToggle').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è'; localStorage.setItem('theme', theme); };
    if (localStorage.getItem('theme')) { document.body.setAttribute('data-theme', localStorage.getItem('theme')); document.getElementById('themeToggle').textContent = localStorage.getItem('theme') === 'light' ? 'üåô' : '‚òÄÔ∏è'; }
    
    // === Logika Baru untuk Produk, Stok, dan Pencarian ===
    function renderKategori(filter = '') {
        kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
        for (const kategori in allProductsData) {
            let hasMatchingProduct = false;
            if (filter) {
                for (const produk in allProductsData[kategori]) {
                    if (produk.toLowerCase().includes(filter)) {
                        hasMatchingProduct = true;
                        break;
                    }
                }
            } else {
                hasMatchingProduct = true;
            }
            if (hasMatchingProduct) {
                kategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
            }
        }
    }

    function renderProduk() {
        const kategori = kategoriSelect.value;
        const filter = searchProdukInput.value.toLowerCase();
        produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
        if (!kategori) return;

        const produkData = allProductsData[kategori];
        const sortedProduk = Object.keys(produkData).sort((a,b) => (produkData[a].urutan || 0) - (produkData[b].urutan || 0));
        
        sortedProduk.forEach(namaProduk => {
            if (filter && !namaProduk.toLowerCase().includes(filter)) return;
            const produk = produkData[namaProduk];
            const stok = produk.stok !== undefined ? produk.stok : Infinity; // Anggap stok tak terbatas jika tidak di-set
            const stokText = stok === Infinity ? '' : `(Stok: ${stok})`;
            const isDisabled = stok <= 0;
            produkSelect.innerHTML += `<option value="${namaProduk}" ${isDisabled ? 'disabled' : ''}>${namaProduk} ${stokText}</option>`;
        });
    }

    function handleSearch() {
        const filter = searchProdukInput.value.toLowerCase();
        renderKategori(filter);
        renderProduk();
        resetVoucherAndPrice();
    }

    // === Logika untuk Voucher & Harga (BARU) ===
    function updatePriceDisplay() {
        if (currentProductPrice === 0) {
            infoProduk.innerHTML = 'Pilih produk untuk melihat harga.';
            submitBtn.innerHTML = 'Pesan Sekarang';
            finalPrice = 0;
            return;
        }
        let discountAmount = 0;
        let discountText = '';
        finalPrice = currentProductPrice;
        if (appliedVoucher) {
            if (appliedVoucher.tipe === 'persen') {
                discountAmount = Math.floor(currentProductPrice * (appliedVoucher.nilai / 100));
                discountText = `(Diskon ${appliedVoucher.nilai}%)`;
            } else if (appliedVoucher.tipe === 'nominal') {
                discountAmount = appliedVoucher.nilai;
                discountText = `(Diskon Rp${formatRupiah(appliedVoucher.nilai)})`;
            }
            finalPrice = currentProductPrice - discountAmount;
        }
        infoProduk.innerHTML = `
            <b>Deskripsi:</b> ${infoProduk.dataset.deskripsi || '-'}<br>
            <b>Harga:</b> <span class="${appliedVoucher ? 'original-price-striked' : ''}">Rp${formatRupiah(currentProductPrice)}</span>
            ${appliedVoucher ? `<br><b>Harga Akhir:</b> <span class="text-success">Rp${formatRupiah(finalPrice)}</span> ${discountText}` : ''}
        `;
        submitBtn.innerHTML = `Pesan Sekarang (Rp${formatRupiah(finalPrice)})`;
    }

    function resetVoucherAndPrice() {
        appliedVoucher = null;
        voucherCodeInput.value = '';
        voucherStatus.innerHTML = '';
        voucherCodeInput.disabled = false;
        applyVoucherBtn.disabled = false;
        currentProductPrice = 0;
        infoProduk.dataset.deskripsi = '';
        updatePriceDisplay();
    }

    async function applyVoucher() {
        const code = voucherCodeInput.value.trim().toUpperCase();
        if (!code) return;
        if (currentProductPrice <= 0) {
            voucherStatus.className = 'text-danger';
            voucherStatus.textContent = 'Pilih produk terlebih dahulu!';
            return;
        }
        voucherStatus.className = 'text-muted';
        voucherStatus.textContent = 'Mengecek voucher...';
        applyVoucherBtn.disabled = true;
        const voucherSnap = await db.ref(`vouchers/${code}`).once('value');
        if (!voucherSnap.exists()) {
            voucherStatus.className = 'text-danger';
            voucherStatus.textContent = 'Kode voucher tidak ditemukan.';
            applyVoucherBtn.disabled = false;
            return;
        }
        appliedVoucher = { code, ...voucherSnap.val() };
        voucherStatus.className = 'text-success';
        voucherStatus.textContent = `‚úì ${appliedVoucher.deskripsi}`;
        voucherCodeInput.disabled = true;
        updatePriceDisplay();
    }

    // === Logika Submit Form (DIPERBARUI) ===
    document.getElementById('formPesanan').addEventListener('submit', async e => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Memproses...';
        
        const nama = document.getElementById('nama').value.trim();
        const nomor = document.getElementById('nomor').value.trim();
        const waAktif = normalizePhone(document.getElementById('waAktif').value.trim());
        const kategori = kategoriSelect.value;
        const produk = produkSelect.value;
        const id = "P" + Date.now();
        if (finalPrice <= 0) {
            alert("Silakan pilih produk terlebih dahulu.");
            submitBtn.disabled = false; updatePriceDisplay();
            return;
        }

        const dataPesanan = {
            nama, nomor, kategori, produk, 
            hargaAsli: currentProductPrice,
            hargaAkhir: finalPrice,
            voucherDigunakan: appliedVoucher ? appliedVoucher.code : null,
            wa_aktif: waAktif, 
            waktu: new Date().toISOString(), 
            status: 'Belum Bayar'
        };

        await db.ref('pesanan/' + id).set(dataPesanan);
        
        // Mengurangi stok jika ada
        const stokSaatIni = allProductsData[kategori][produk].stok;
        if (stokSaatIni !== undefined && stokSaatIni !== Infinity) {
            await db.ref(`produk/${kategori}/${produk}/stok`).set(stokSaatIni - 1);
        }
        
        const pesanPromo = `Promo spesial dari Asdar Store Digital! Proses cepat dan harga murah. Cek sekarang di ${window.location.origin + window.location.pathname}`;
        const linkBagikan = `https://wa.me/?text=${encodeURIComponent(pesanPromo)}`;
        
        hasilDiv.style.display = 'block';
        hasilDiv.innerHTML = `
            <p class="text-success fw-bold">‚úÖ Pesanan Anda berhasil dibuat!</p>
            <p><b>ID Pesanan Anda:</b> <code>${id}</code></p>
            <div class="info">
                <p><strong>Silakan lakukan pembayaran sejumlah Rp${formatRupiah(finalPrice)}</strong> ke salah satu tujuan berikut:</p>
                <ul><li><strong>ShopeePay:</strong> 081803004607</li><li><strong>Dana:</strong> 087755432880</li></ul>
            </div>
            <a href="uplod.html?id=${id}" style="text-decoration:none; display:block; margin: 15px 0;"><button type="button">üì§ Upload Bukti Pembayaran</button></a>
            <div class="discount-offer">
                <h4>Mau Diskon di Pesanan Berikutnya?</h4>
                <p>Caranya mudah! Bagikan pesan promo kami ke 2 grup/teman WhatsApp, lalu kirim screenshot-nya ke WA Admin di nomor ${ADMIN_WA_NUMBER}.</p>
                <a href="${linkBagikan}" target="_blank"><button type="button" class="btn-share">Bagikan Promo Sekarang</button></a>
            </div>
        `;
        document.getElementById('formPesanan').reset();
        resetVoucherAndPrice();
        submitBtn.disabled = false;
        window.scrollTo({ top: hasilDiv.offsetTop, behavior: 'smooth' });
    });

    // === Event Listeners & Inisialisasi Aplikasi ===
    searchProdukInput.addEventListener('input', handleSearch);
    kategoriSelect.addEventListener('change', () => { renderProduk(); resetVoucherAndPrice(); });
    produkSelect.addEventListener('change', () => {
        const kategori = kategoriSelect.value;
        const produk = produkSelect.value;
        resetVoucherAndPrice();
        if (!produk) { infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini.'; return; }
        const data = allProductsData[kategori][produk];
        currentProductPrice = data.harga;
        infoProduk.dataset.deskripsi = data.deskripsi || data.cara || '-';
        updatePriceDisplay();
    });
    applyVoucherBtn.addEventListener('click', applyVoucher);
    
    // Inisialisasi awal
    db.ref('produk').on('value', snapshot => {
        allProductsData = snapshot.val() || {};
        renderKategori();
        renderProduk();
    });

    // Kode untuk Testimoni, FAQ, dll tetap sama dan berfungsi
  </script>
</body>
</html>
