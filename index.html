<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asdar Store Digital</title>
    <link rel="icon" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Theme Variables */
        :root {
            /* Light Mode Colors (White & Blue) */
            --bg: #ffffff; /* Pure white background */
            --text: #333333; /* Dark gray for main text, almost black */
            --primary: #007bff; /* Bright blue for accents */
            --card: #ffffff; /* White card background */
            --border: #e0e0e0; /* Light gray border */
            --secondary-text: #6b7280; /* Medium gray for secondary text */
            --button-text-light: #ffffff; /* White text for primary buttons */
            --button-bg-light: #007bff; /* Primary blue for buttons */
            --button-hover-light: #0056b3; /* Darker blue on hover */
            --primary-rgb: 0, 123, 255; /* RGB for primary blue */
        }
        [data-theme="dark"] {
            /* Dark Mode Colors (Consistent with admin.html dark mode) */
            --bg: #1a202c; /* Consistent with admin.html dark body */
            --text: #e2e8f0; /* Consistent with admin.html dark text */
            --primary: #4fd1c5; /* Consistent with admin.html dark brand */
            --card: #2d3748; /* Consistent with admin.html dark card */
            --border: #4a5568; /* Consistent with admin.html dark border */
            --secondary-text: #a0aec0; /* Consistent with admin.html dark secondary text */
            --button-text-dark: #ffffff; /* White text for buttons */
            --button-bg-dark: #4fd1c5; /* Primary green for buttons (consistent with primary) */
            --button-hover-dark: #38b2ac; /* Darker green on hover */
            --primary-rgb: 79, 209, 197; /* RGB for primary green */
        }

        /* General Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            margin: 0;
            line-height: 1.6;
            padding: 1rem; /* Ensure padding on very small screens */
        }
        header {
            position: sticky;
            top: 0;
            background: var(--card);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow for header */
        }
        header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--primary);
            font-weight: bold;
        }
        .theme-btn {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--text);
            transition: color 0.3s ease, background-color 0.3s ease;
            padding: 8px; /* Added padding for better touch target */
            border-radius: 50%; /* Make it round */
        }
        .theme-btn:hover {
            background-color: rgba(0,0,0,0.05); /* Subtle hover effect */
            color: var(--primary);
        }
        [data-theme="dark"] .theme-btn:hover {
            background-color: rgba(255,255,255,0.1); /* Darker hover for light background in dark mode */
        }
        main {
            max-width: 700px;
            margin: 20px auto;
            padding: 0 20px;
        }
        @media (max-width: 640px) { /* Adjust main padding for smaller screens */
            main {
                padding: 0 10px;
            }
        }

        /* Form & Input Styles */
        label {
            font-weight: 600;
            margin-top: 15px;
            display: block;
            color: var(--text); /* Text color for labels */
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--card);
            color: var(--text); /* Text color inside input fields */
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }
        .btn-base { /* Base style for all custom buttons */
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            color: var(--button-text-light);
            background: var(--button-bg-light);
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        [data-theme="dark"] .btn-base {
            color: var(--button-text-dark);
            background: var(--button-bg-dark);
        }
        .btn-base:hover {
            background-color: var(--button-hover-light);
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* Slightly larger shadow on hover */
        }
        [data-theme="dark"] .btn-base:hover {
            background-color: var(--button-hover-dark);
        }
        .btn-base:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Smaller shadow on click */
        }

        /* Specific button overrides */
        .btn-auth {
            padding: 8px 16px; /* Adjusted padding */
            border-radius: 8px;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            color: var(--button-text-light);
            background: var(--button-bg-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.3s ease;
        }
        [data-theme="dark"] .btn-auth {
            color: var(--button-text-dark);
            background: var(--button-bg-dark);
        }
        .btn-auth:hover {
            background-color: var(--button-hover-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        [data-theme="dark"] .btn-auth:hover {
            background-color: var(--button-hover-dark);
        }

        .btn-logout {
            background-color: #dc3545; /* Red color */
            color: white !important; /* Ensure white text for red button */
        }
        .btn-logout:hover {
            background-color: #c82333; /* Darker red on hover */
        }
        .btn-order-form {
            background-color: var(--button-bg-light); /* Use primary button color */
            color: var(--button-text-light);
        }
        [data-theme="dark"] .btn-order-form {
            background-color: var(--button-bg-dark);
            color: var(--button-text-dark);
        }
        .btn-order-form:hover {
            background-color: var(--button-hover-light);
        }
        [data-theme="dark"] .btn-order-form:hover {
            background-color: var(--button-hover-dark);
        }

        .btn-check-status {
            background-color: #6c757d; /* Gray color */
            color: white;
        }
        .btn-check-status:hover {
            background-color: #5a6268; /* Darker gray on hover */
        }

        .qr-btn {
            display: block; /* Ensure it takes full width */
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: white; /* QR buttons always have white text */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .qr-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .qr-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .qr-btn.dana {
            background: #42b72a; /* Specific green for Dana */
        }
        .qr-btn.dana:hover { background-color: #3aa823; }
        .qr-btn.shopeepay {
            background: #ee4d2d; /* Specific orange for ShopeePay */
        }
        .qr-btn.shopeepay:hover { background-color: #d64126; }


        /* Info Box */
        .info {
            background: var(--card);
            padding: 15px;
            margin-top: 20px;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--text);
        }

        /* Testimonial Box */
        #testimoniBox {
            background: var(--card);
            padding: 15px;
            border-left: 5px solid var(--primary);
            border-radius: 8px;
            min-height: 100px;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-style: italic;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--text);
        }
        #animTestimoni {
            position: absolute;
            width: calc(100% - 30px);
            transition: opacity 0.7s ease-in-out;
            opacity: 0;
        }

        /* Result Section */
        #hasil {
            margin-top: 30px;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--text);
        }

        hr {
            margin: 40px 0;
            border: 0;
            border-top: 1px solid var(--border);
        }
        h2 {
            color: var(--primary);
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        h3 {
            color: var(--primary);
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        /* Dynamic content styles */
        .dynamic-content-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }

        /* Accordion Styles for Products */
        .accordion-item {
            margin-bottom: 12px; /* mb-3 equivalent */
            border-radius: 8px; /* rounded-lg equivalent */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* shadow-sm equivalent */
            overflow: hidden;
            border: 1px solid var(--border);
            background: var(--card); /* Use card color for accordion items */
        }
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px; /* p-4 equivalent */
            cursor: pointer;
            font-weight: 600; /* font-semibold equivalent */
            font-size: 1.125rem; /* text-lg equivalent */
            background: var(--card);
            color: var(--text);
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: var(--border); /* Use border color for subtle hover */
        }
        [data-theme="dark"] .accordion-header:hover {
            background-color: var(--border); /* Consistent hover for dark mode */
        }
        .accordion-header .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .fa-chevron-down {
            transform: rotate(180deg);
        }
        .accordion-content {
            padding: 16px; /* p-4 equivalent */
            border-top: 1px solid var(--border);
            display: none; /* hidden equivalent */
            background: var(--card);
            color: var(--text);
        }
        .product-item {
            padding: 12px; /* p-3 equivalent */
            display: flex;
            flex-direction: column; /* flex-col equivalent */
            justify-content: space-between;
            align-items: flex-start; /* items-start equivalent */
            border-bottom: 1px solid var(--border);
        }
        .product-item:last-child {
            border-bottom: none; /* last:border-b-0 equivalent */
        }
        @media (min-width: 640px) { /* sm:breakpoint */
            .product-item {
                flex-direction: row; /* sm:flex-row equivalent */
                align-items: center; /* sm:items-center equivalent */
            }
        }
        .product-item:hover {
            background-color: var(--border);
        }
        [data-theme="dark"] .product-item:hover {
            background-color: var(--border);
        }
        .product-item button {
            margin-top: 8px; /* mt-2 equivalent */
            padding: 8px 16px; /* px-4 py-2 equivalent */
            font-size: 0.875rem; /* text-sm equivalent */
            border-radius: 6px; /* rounded-md equivalent */
            width: auto;
            color: var(--button-text-light);
            background: var(--button-bg-light);
        }
        @media (min-width: 640px) { /* sm:breakpoint */
            .product-item button {
                margin-top: 0;
            }
        }
        [data-theme="dark"] .product-item button {
            color: var(--button-text-dark);
            background: var(--button-bg-dark);
        }
        .product-item button:hover {
            background-color: var(--button-hover-light);
        }
        [data-theme="dark"] .product-item button:hover {
            background-color: var(--button-hover-dark);
        }
        .product-item .price {
            font-weight: bold;
            color: var(--primary);
        }
        .product-item .description {
            font-size: 0.875rem;
            color: var(--secondary-text);
        }

        /* Product List Modal */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
            display: none; /* Changed from opacity/visibility to display */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            /* No opacity/visibility transitions here, use JS to toggle display */
        }
        .product-modal.show {
            display: flex; /* Show the modal */
        }
        .product-modal-content {
            background-color: var(--card);
            color: var(--text);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for content */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            /* No transform/opacity transitions here, manage directly with JS if needed for animation */
        }
        .product-modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }
        .product-modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .product-modal-content th, .product-modal-content td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
            color: var(--text);
        }
        .product-modal-content th {
            background-color: var(--border);
            font-weight: bold;
            color: var(--text);
        }
        [data-theme="dark"] .product-modal-content th {
            background-color: var(--border); /* Keep it light grey in dark mode */
        }
        .product-modal-content tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02); /* Subtle stripe effect */
        }
        [data-theme="dark"] .product-modal-content tr:nth-child(even) {
            background-color: rgba(0,0,0,0.05);
        }
        .product-modal-content .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            width: auto; /* Override btn-base width */
            box-shadow: none; /* Override btn-base shadow */
        }
        .product-modal-content .modal-close-btn:hover {
            background-color: rgba(0,0,0,0.1);
            transform: none; /* Override btn-base transform */
        }
        [data-theme="dark"] .product-modal-content .modal-close-btn:hover {
            background-color: rgba(0,0,0,0.15);
        }
        .product-modal-content .modal-select-btn {
            background-color: var(--primary);
            color: var(--button-text-light);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: bold;
            transition: background-color 0.2s ease;
            width: auto; /* Override btn-base width */
            box-shadow: none; /* Override btn-base shadow */
        }
        [data-theme="dark"] .product-modal-content .modal-select-btn {
            background-color: var(--primary);
            color: var(--button-text-dark);
        }
        .product-modal-content .modal-select-btn:hover {
            background-color: var(--button-hover-light);
        }
        [data-theme="dark"] .product-modal-content .modal-select-btn:hover {
            background-color: var(--button-hover-dark);
        }

        /* Custom Modal for Alerts */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Changed to display: none */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .custom-modal.show { /* Use .show class to display */
            display: flex;
        }
        .custom-modal-content {
            background: var(--card);
            color: var(--text);
            padding: 25px; /* Increased padding */
            border-radius: 12px; /* More rounded */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Deeper shadow */
            width: 90%;
            max-width: 400px; /* Max width for readability */
            text-align: center;
        }
        .custom-modal-content button {
            padding: 10px 20px; /* Adjusted button padding */
            border-radius: 8px; /* More rounded button */
            margin-top: 20px; /* More spacing */
            color: var(--button-text-light);
            background: var(--button-bg-light);
            transition: background-color 0.3s ease;
        }
        [data-theme="dark"] .custom-modal-content button {
            color: var(--button-text-dark);
            background: var(--button-bg-dark);
        }
        .custom-modal-content button:hover {
            background-color: var(--button-hover-light);
        }
        [data-theme="dark"] .custom-modal-content button:hover {
            background-color: var(--button-hover-dark);
        }
    </style>
</head>
<body data-theme="light">
    <header id="header">
        <h1>Asdar Store Digital</h1>
        <div class="flex items-center space-x-4">
            <span id="user-status" class="text-sm">Memuat...</span>
            <button class="theme-btn" onclick="toggleTheme()" id="themeToggle">ðŸŒ™</button>
            <button id="auth-btn" class="btn-auth">Login</button>
            <button id="logout-btn" class="btn-auth btn-logout hidden">Logout</button>
        </div>
    </header>
    <main id="main-content">
        <h2 class="text-2xl font-bold text-center mb-6">Pesan Produk Digital</h2>

        <h3 class="text-xl font-bold mt-8 mb-4 text-center">Daftar Produk Kami</h3>
        <div id="product-accordion" class="space-y-4">
            <p class="text-center text-gray-500" id="loading-products">Memuat daftar produk...</p>
        </div>
        <button id="showAllProductsBtn" class="btn-base mt-6">Lihat Semua Produk dalam Tabel</button>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Formulir Pesanan</h2>
        <form id="formPesanan" class="bg-white p-6 rounded-lg shadow-md">
            <label for="nama" class="block text-sm font-medium mb-1">Nama Lengkap</label>
            <input type="text" id="nama" placeholder="Cth: Budi Santoso" required aria-label="Nama Lengkap" class="input-field" />

            <label for="nomor" class="block text-sm font-medium mb-1">Nomor HP / ID SN (ID Game/Akun)</label>
            <input type="text" id="nomor" placeholder="Cth: 081234567890 atau ID Game Anda" required aria-label="Nomor HP atau ID SN" class="input-field" />

            <label for="waAktif" class="block text-sm font-medium mb-1">Nomor WhatsApp Aktif (untuk notifikasi)</label>
            <input type="tel" id="waAktif" placeholder="Cth: 081234567890" pattern="^(08|62)[0-9]{8,15}$" title="Format nomor WA: 08xxxxxxxxxx atau 62xxxxxxxxxx" required aria-label="Nomor WhatsApp Aktif" class="input-field" />

            <label for="kategori" class="block text-sm font-medium mb-1">Kategori Produk</label>
            <select id="kategori" required aria-label="Kategori Produk" class="input-field">
                <option value="">Pilih Kategori</option>
            </select>

            <label for="produk" class="block text-sm font-medium mb-1">Produk</label>
            <select id="produk" required aria-label="Pilih Produk" class="input-field">
                <option value="">Pilih Produk</option>
            </select>

            <div class="info" id="infoProduk">Harga dan deskripsi produk akan muncul di sini setelah Anda memilih produk.</div>

            <button type="submit" class="btn-order-form">Pesan Sekarang</button>
        </form>

        <div id="hasil" class="hidden"></div>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Cek Status Pesanan Anda</h2>
        <form onsubmit="event.preventDefault(); cekStatus();" class="bg-white p-6 rounded-lg shadow-md">
            <label for="idCek" class="block text-sm font-medium mb-1 visually-hidden">Masukkan ID Pesanan</label>
            <input type="text" id="idCek" placeholder="Masukkan ID Pesanan Anda (Cth: P16789...)" required aria-label="ID Pesanan" class="input-field" />
            <button type="submit" class="btn-check-status">Cek Status</button>
            <p class="text-sm text-gray-500 mt-2 text-center">Lupa ID Pesanan? Silakan cek notifikasi WhatsApp Anda atau hubungi admin.</p>
        </form>

        <hr>

        <h2 class="text-2xl font-bold text-center mb-6">Testimoni Pelanggan Kami</h2>
        <div id="testimoniBox" class="bg-white p-6 rounded-lg shadow-md"><div id="animTestimoni" class="text-gray-500">Memuat testimoni...</div></div>

        <div id="dynamic-content-area"></div>

    </main>

    <div id="productListModal" class="product-modal">
        <div class="product-modal-content">
            <button class="modal-close-btn" onclick="closeProductModal()">âœ–</button>
            <h3 class="text-2xl font-bold">Daftar Semua Produk</h3>
            <div class="overflow-x-auto"> <table id="allProductsTable">
                    <thead>
                        <tr>
                            <th>Kategori</th>
                            <th>Produk</th>
                            <th>Harga</th>
                            <th>Deskripsi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center">Klik tombol 'Pesan' untuk memilih produk ini di formulir utama.</p>
        </div>
    </div>

    <div id="custom-modal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="modal-message" class="text-lg font-medium mb-4"></p>
            <button id="modal-close-btn">OK</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- Theme Toggle ---
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggle');
            const currentTheme = body.getAttribute('data-theme');
            const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', nextTheme);
            btn.textContent = nextTheme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', nextTheme);
        }
        // Set initial theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                document.getElementById('themeToggle').textContent = savedTheme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
            } else {
                // Default to light mode if no theme is saved
                document.body.setAttribute('data-theme', 'light');
                document.getElementById('themeToggle').textContent = 'ðŸŒ™';
            }
            // Call other initial load functions
            loadProductsForAccordion();
            renderDynamicContent();
        });

        // --- Custom Alert Modal ---
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        function showCustomAlert(message) {
            modalMessage.textContent = message;
            customModal.classList.add('show'); // Use .show class
        }

        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.remove('show'); // Remove .show class
        });

        // --- Firebase Config & Init ---
        // PASTIKAN INI SAMA DENGAN DI ADMIN.HTML DAN FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", 
            authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
            databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
            projectId: "asdarstoredigitalll-d89c4",
            storageBucket: "asdarstoredigitalll.appspot.com",
            messagingSenderId: "220670500351",
            appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- DOM Elements ---
        const kategoriSelect = document.getElementById('kategori');
        const produkSelect = document.getElementById('produk');
        const infoProduk = document.getElementById('infoProduk');
        const hasilDiv = document.getElementById('hasil');
        const productAccordion = document.getElementById('product-accordion');
        const loadingProducts = document.getElementById('loading-products');
        const showAllProductsBtn = document.getElementById('showAllProductsBtn'); // New button

        const produkRef = db.ref('produk');
        const dinamisRef = db.ref('dinamis');
        const testimoniRef = db.ref('testimoni');

        const userStatusSpan = document.getElementById('user-status');
        const authBtn = document.getElementById('auth-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const productListModal = document.getElementById('productListModal'); // Product modal
        const allProductsTableBody = document.querySelector('#allProductsTable tbody'); // Table body

        // --- Firebase Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                userStatusSpan.textContent = `Hai, ${user.email || 'Pengguna'}!`;
                authBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                userStatusSpan.textContent = `Anda belum login.`;
                authBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        });

        authBtn.addEventListener('click', () => {
            window.location.replace('./auth_animated.html'); // Redirect to new animated auth page
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showCustomAlert('Anda telah logout.');
            } catch (error) {
                console.error("Logout Error:", error);
                showCustomAlert('Gagal logout. Silakan coba lagi.');
            }
        });

        // --- Helper Functions ---
        function formatRupiah(angka) {
            return parseFloat(angka).toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace('IDR', 'Rp');
        }

        function normalizePhoneNumber(number) {
            if (!number) return '';
            number = String(number).replace(/[^0-9]/g, '');
            if (number.startsWith('0')) {
                number = '62' + number.slice(1);
            }
            // Tambahkan "62" jika diawali dengan 8 dan panjangnya kurang dari 11 (asumsi nomor Indo)
            if (number.startsWith('8') && number.length > 7 && number.length < 13) {
                 number = '62' + number;
            }
            return number;
        }

        // --- Global array to store products with IDs and 'order' ---
        let flatProducts = []; 

        // --- Load & Display Products (Accordion) ---
        async function loadProductsForAccordion() {
            try {
                // Fetch products ordered by 'order' property
                const snapshot = await produkRef.orderByChild('order').once('value');
                const productsData = snapshot.val() || {};
                
                // Convert object of objects to array of objects with 'id' property
                flatProducts = Object.keys(productsData).map(key => ({
                    id: key,
                    ...productsData[key]
                }));

                // Group products by category for accordion display
                const groupedProducts = flatProducts.reduce((acc, product) => {
                    const category = product.kategori || 'Lain-lain'; // Use 'kategori' property
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(product);
                    return acc;
                }, {});

                let accordionHtml = '';
                loadingProducts.classList.add('hidden'); // Hide loading text

                if (flatProducts.length === 0) {
                    productAccordion.innerHTML = '<p class="text-center text-gray-500">Belum ada produk yang tersedia.</p>';
                    return;
                }

                for (let categoryName in groupedProducts) {
                    accordionHtml += `
                        <div class="accordion-item">
                            <div class="accordion-header" data-target="#collapse-${categoryName.replace(/\s/g, '-')}" aria-expanded="false">
                                <span>${categoryName}</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="collapse-${categoryName.replace(/\s/g, '-')}" class="accordion-content">
                                <ul class="list-none p-0 m-0">
                    `;
                    // Sort products within each category by their 'order' property for consistent display
                    groupedProducts[categoryName].sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(product => {
                        accordionHtml += `
                            <li class="product-item">
                                <div class="flex-grow">
                                    <span class="font-semibold">${product.nama}</span><br>
                                    <span class="price">Rp${formatRupiah(product.harga)}</span><br>
                                    <span class="description">${product.deskripsi || product.cara || 'Tidak ada deskripsi.'}</span>
                                </div>
                                <button class="btn-primary" onclick="selectProductFromList('${product.kategori}', '${product.nama}', '${product.id}')">Pesan</button>
                            </li>
                        `;
                    });
                    accordionHtml += `
                                </ul>
                            </div>
                        </div>
                    `;
                }
                productAccordion.innerHTML = accordionHtml;
                initAccordions(); // Initialize accordion functionality
            } catch (error) {
                console.error("Error loading products for accordion:", error);
                loadingProducts.classList.remove('hidden');
                loadingProducts.textContent = 'Gagal memuat daftar produk.';
                showCustomAlert("Gagal memuat daftar produk. Silakan coba lagi nanti.");
            }
        }

        function initAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.querySelector(targetId);
                    const icon = header.querySelector('.fa-chevron-down');

                    header.classList.toggle('active');
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        // For a smooth reveal, consider adding max-height transition in CSS
                        // content.style.maxHeight = content.scrollHeight + 'px'; 
                    } else {
                        // content.style.maxHeight = null;
                        content.style.display = 'none';
                    }
                });
            });
        }

        // Modified: Added productId param to identify the product uniquely
        function selectProductFromList(kategori, namaProduk, productId) {
            kategoriSelect.value = kategori;
            kategoriSelect.dispatchEvent(new Event('change')); // Trigger change to load products
            
            // Wait for products to populate in the 'produkSelect' dropdown
            const interval = setInterval(() => {
                // Find the option by its value (which is now productId)
                const option = Array.from(produkSelect.options).find(opt => opt.value === productId);
                if (option) {
                    clearInterval(interval); // Stop checking once found
                    produkSelect.value = productId; // Select the product by its ID
                    
                    const selectedProduct = flatProducts.find(p => p.id === productId);
                    updateProductInfoDisplay(selectedProduct); 
                    showCustomAlert(`Produk "${namaProduk}" dari kategori "${kategori}" telah dipilih di formulir pesanan.`);
                    document.getElementById('formPesanan').scrollIntoView({ behavior: 'smooth' }); // Scroll to form
                }
            }, 50); // Check every 50ms
        }

        // --- Product List Modal Functions ---
        showAllProductsBtn.addEventListener('click', openProductModal);

        async function openProductModal() {
            allProductsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Memuat semua produk...</td></tr>';
            productListModal.classList.add('show'); // Use .show class

            try {
                // Use flatProducts array which is already loaded and sorted by 'order'
                if (flatProducts.length === 0) {
                    allProductsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Belum ada produk yang tersedia.</td></tr>';
                    return;
                }

                let tableRowsHtml = '';
                flatProducts.forEach(product => { // Iterate through the flat (ordered) product list
                    tableRowsHtml += `
                        <tr>
                            <td>${product.kategori || 'N/A'}</td>
                            <td>${product.nama || 'N/A'}</td>
                            <td>Rp${formatRupiah(product.harga || 0)}</td>
                            <td>${product.deskripsi || product.cara || '-'}</td>
                            <td><button class="modal-select-btn" onclick="selectProductFromModal('${product.kategori}', '${product.nama}', '${product.id}')">Pesan</button></td>
                        </tr>
                    `;
                });
                allProductsTableBody.innerHTML = tableRowsHtml;
            } catch (error) {
                console.error("Error loading all products for modal:", error);
                allProductsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-500">Gagal memuat produk.</td></tr>';
                showCustomAlert("Gagal memuat daftar produk untuk modal. Silakan coba lagi nanti.");
            }
        }

        function closeProductModal() {
            productListModal.classList.remove('show'); // Remove .show class
        }

        // Modified: Added productId param
        function selectProductFromModal(kategori, namaProduk, productId) {
            selectProductFromList(kategori, namaProduk, productId); // Use existing function to fill form
            closeProductModal(); // Close modal after selection
        }


        // --- Load Data Produk for Form Selects ---
        // Modified: Now populates categories from the flatProducts data
        produkRef.orderByChild('order').once('value').then(snapshot => {
            const productsData = snapshot.val() || {};
            // Re-initialize flatProducts if this is the first load or data changed
            flatProducts = Object.keys(productsData).map(key => ({ id: key, ...productsData[key] }));
            
            const categories = new Set();
            flatProducts.forEach(p => {
                if (p.kategori) categories.add(p.kategori);
            });

            kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
            Array.from(categories).sort().forEach(category => {
                kategoriSelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }).catch(error => {
            console.error("Error loading categories:", error);
            showCustomAlert("Gagal memuat kategori produk untuk formulir. Silakan coba lagi nanti.");
        });

        // Modified: Now populates products based on the flatProducts data (using product.id as value)
        kategoriSelect.addEventListener('change', () => {
            produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
            infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
            const selectedCategory = kategoriSelect.value;
            if (!selectedCategory) return;

            const productsInSelectedCategory = flatProducts.filter(p => p.kategori === selectedCategory);
            // Sort by order property within the category
            productsInSelectedCategory.sort((a,b) => (a.order || 0) - (b.order || 0)).forEach(product => {
                produkSelect.innerHTML += `<option value="${product.id}">${product.nama}</option>`; // Use product ID as the value for the option
            });
        });

        // Modified: Now gets product details from flatProducts using the selected product ID
        produkSelect.addEventListener('change', () => {
            const selectedProductId = produkSelect.value; // This is now the product ID, not the product name
            if (!selectedProductId) {
                infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
                return;
            }

            const selectedProduct = flatProducts.find(p => p.id === selectedProductId); // Find the product object
            updateProductInfoDisplay(selectedProduct);
        });

        // Helper function to update product info display
        function updateProductInfoDisplay(product) {
            if (product) {
                infoProduk.innerHTML = `<b>Harga:</b> Rp${formatRupiah(product.harga)}<br><b>Deskripsi:</b> ${product.deskripsi || product.cara || '-'}`;
            } else {
                infoProduk.innerHTML = 'Informasi produk tidak ditemukan.';
            }
        }


        // --- Submit Pesanan ---
        document.getElementById('formPesanan').addEventListener('submit', async e => {
            e.preventDefault();

            const nama = document.getElementById('nama').value.trim();
            const nomor = document.getElementById('nomor').value.trim(); // ID SN / HP
            const waAktif = normalizePhoneNumber(document.getElementById('waAktif').value.trim());
            const selectedProductId = produkSelect.value; // This is now the product ID
            const waktu = new Date().toISOString();
            const id = "P" + Date.now();

            if (!nama || !nomor || !waAktif || !selectedProductId) {
                return showCustomAlert("Harap lengkapi semua field yang diperlukan!");
            }

            try {
                // Find product details from flatProducts array using selectedProductId
                const dataProduk = flatProducts.find(p => p.id === selectedProductId);

                if (!dataProduk || typeof dataProduk.harga === 'undefined') {
                    return showCustomAlert("Produk yang dipilih tidak valid atau harga tidak ditemukan.");
                }
                const harga = dataProduk.harga || 0;

                // Save order with consistent property names for admin panel
                await db.ref('pesanan/' + id).set({
                    nama_pembeli: nama, // Consistent with admin.html (nama_pembeli)
                    id_sn_atau_nomor: nomor, // Consistent with admin.html (id_sn_atau_nomor)
                    nomor_wa: waAktif, // Consistent with admin.html (nomor_wa)
                    kategori_produk: dataProduk.kategori, // Use data from the found product object
                    nama_produk: dataProduk.nama,     // Use data from the found product object
                    harga: harga,
                    waktu: waktu,
                    status: 'Belum Bayar',
                    // productId: selectedProductId // Optionally save product ID as well
                });

                hasilDiv.classList.remove('hidden');
                hasilDiv.innerHTML = `
                    <p class="text-green-600 font-semibold text-lg">âœ… Pesanan Anda berhasil dibuat!</p>
                    <p class="text-gray-700"><b>ID Pesanan Anda:</b> <code id="orderIdDisplay" class="bg-gray-200 p-1 rounded text-sm">${id}</code></p>
                    <button class="btn-base mt-4" onclick="copyOrderId()">Salin ID Pesanan</button>
                    <div class="info">
                        <p class="font-bold text-lg"><strong>Silakan lakukan pembayaran sejumlah Rp${formatRupiah(harga)}</strong> ke salah satu rekening/ewallet berikut:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li><strong>ShopeePay:</strong> 081803004607</li>
                            <li><strong>Dana:</strong> 087755432880</li>
                            <li><strong>OVO:</strong> 087755432880</li>
                            <li><strong>GoPay:</strong> 087755432880</li>
                        </ul>
                        <p class="mt-3">Mohon transfer sesuai nominal agar pesanan cepat diproses.</p>
                    </div>
                    <a class='qr-btn' href="./upload.html?id=${id}" style="background-color: var(--button-bg-light); color: var(--button-text-light);">ðŸ“¤ Upload Bukti Bayar Sekarang</a>
                    <a class='qr-btn' href="./status.html?id=${id}" style="background-color: #6c757d; color: white;">ðŸ“„ Cek Status Pesanan Anda</a>
                    <a class='qr-btn dana' href="https://link.dana.id/qr/d?c=${harga}&qr=EAE79493-21BC-4537-832F-C3D7EF3C1A1D" target="_blank" rel="noopener noreferrer">ðŸ’¸ Bayar via Dana (Klik Langsung)</a>
                    <a class='qr-btn shopeepay' href="https://link.shopeepay.co.id/?amount=${harga}&ref_id=${id}&callback=https://asdarcell.github.io/Asdarstoredigital/status.html?id=${id}" target="_blank" rel="noopener noreferrer">ðŸ›’ Bayar via ShopeePay (Klik Langsung)</a>
                `;

                document.getElementById('formPesanan').reset();
                infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini setelah Anda memilih produk.';
                kategoriSelect.value = '';
                produkSelect.innerHTML = '<option value="">Pilih Produk</option>';

                await kirimNotifWA(id, nama, dataProduk.nama, waAktif, harga); // Pass dataProduk.nama
                showCustomAlert("Pesanan berhasil dibuat! Silakan lakukan pembayaran. ID Pesanan Anda telah ditampilkan.");
                hasilDiv.scrollIntoView({ behavior: 'smooth' }); // Scroll to result

            } catch (error) {
                console.error("Error creating order:", error);
                showCustomAlert("Terjadi kesalahan saat membuat pesanan. Silakan coba lagi.");
            }
        });

        // --- Copy Order ID Function ---
        function copyOrderId() {
            const orderIdElement = document.getElementById('orderIdDisplay');
            if (orderIdElement) {
                const range = document.createRange();
                range.selectNode(orderIdElement);
                window.getSelection().removeAllRanges(); // Clear current selection
                window.getSelection().addRange(range); // Select the text
                try {
                    document.execCommand('copy');
                    showCustomAlert('ID Pesanan berhasil disalin!');
                } catch (err) {
                    console.error('Gagal menyalin ID pesanan:', err);
                    showCustomAlert('Gagal menyalin ID pesanan. Silakan salin manual.');
                }
                window.getSelection().removeAllRanges(); // Deselect after copying
            }
        }

        // --- Cek Status Pesanan ---
        function cekStatus() {
            const id = document.getElementById('idCek').value.trim();
            if (id) {
                window.location.replace(`./status.html?id=${id}`);
            } else {
                showCustomAlert("Mohon masukkan ID Pesanan Anda untuk cek status.");
            }
        }

        // --- Kirim Notifikasi WA ke Admin (NgirimWA API) ---
        // PASTIKAN API KEY DAN NOMOR WA INI BENAR
        const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
        const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
        const ADMIN_WA_NUMBER = "6281803004607"; // Nomor WA Admin

        async function kirimNotifWA(id, nama, produk, waAktif, harga) {
            const pesan = `ðŸ“¦ Pesanan Baru Asdar Store Digital!\n\n` +
                            `ðŸ†” *ID Pesanan:* ${id}\n` +
                            `ðŸ‘¤ *Nama Pembeli:* ${nama}\n` +
                            `ðŸ“ž *WA Aktif Pembeli:* ${waAktif}\n` +
                            `ðŸŽ® *Produk Dipesan:* ${produk}\n` +
                            `ðŸ’° *Total Harga:* Rp${formatRupiah(harga)}\n\n` +
                            `Segera cek dan proses di dashboard admin:\n` +
                            `https://asdarcell.github.io/Asdarstoredigital/admin.html`; // Pastikan URL admin ini benar

            const formData = new URLSearchParams();
            formData.append("appkey", NGIRIMWA_APPKEY);
            formData.append("authkey", NGIRIMWA_AUTHKEY);
            formData.append("to", ADMIN_WA_NUMBER);
            formData.append("message", pesan);

            try {
                const response = await fetch("https://api.ngirimwa.com/sendText", { // Pastikan endpoint ini benar
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData
                });
                const result = await response.json();
                if (result.status === "success") {
                    console.log("Notifikasi WA ke admin berhasil dikirim:", result);
                } else {
                    console.warn("Gagal mengirim notifikasi WA ke admin:", result);
                }
            } catch (error) {
                console.error("Error saat mengirim notifikasi WA ke admin:", error);
            }
        }

        // --- Testimoni Berjalan ---
        let dataTesti = [];
        let testiIndex = 0;
        const animTestimoniDiv = document.getElementById('animTestimoni');

        function tampilkanSatuTesti() {
            if (!dataTesti.length) {
                animTestimoniDiv.innerHTML = "Belum ada testimoni.";
                animTestimoniDiv.style.opacity = '1';
                return;
            }

            const t = dataTesti[testiIndex];
            animTestimoniDiv.style.opacity = '0';
            setTimeout(() => {
                animTestimoniDiv.innerHTML = `â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸<br/><b>${t.nama || 'Anonim'}</b>: ${t.pesan || ''}`;
                animTestimoniDiv.style.opacity = '1';
                testiIndex = (testiIndex + 1) % dataTesti.length;
                setTimeout(tampilkanSatuTesti, 5000);
            }, 700);
        }

        testimoniRef.on('value', snap => {
            const data = snap.val() || {};
            // Assuming testimoni nodes are direct children with 'nama' and 'pesan' properties
            dataTesti = Object.values(data).reverse(); // Reverse to show newest first
            tampilkanSatuTesti();
        }, error => {
            console.error("Error loading testimonials:", error);
            animTestimoniDiv.innerHTML = "Gagal memuat testimoni.";
            animTestimoniDiv.style.opacity = '1';
        });

        // --- Render Konten Dinamis dari Admin ---
        async function renderDynamicContent() {
            try {
                // Modified: dynamic content is now directly under 'dinamis' node (not 'dinamis/index')
                // and ordered by 'order' property
                const snapshot = await dinamisRef.orderByChild('order').once('value'); 
                const dynamicContentArea = document.getElementById('dynamic-content-area');
                dynamicContentArea.innerHTML = ''; // Clear previous content

                const blocks = snapshot.val() || {};
                const sortedBlocks = Object.keys(blocks).map(key => ({ id: key, ...blocks[key] }))
                                        .sort((a, b) => (a.order || 0) - (b.order || 0));

                let combinedCss = '';
                let combinedJs = '';

                sortedBlocks.forEach(block => {
                    if (block.html) { // Check for 'html' property
                        const section = document.createElement('div');
                        section.className = 'dynamic-content-section'; // Apply basic styling
                        section.innerHTML = block.html;
                        dynamicContentArea.appendChild(section);

                        // Re-execute scripts within dynamic HTML
                        section.querySelectorAll('script').forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, oldScript.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }
                    if (block.css) { // Check for 'css' property
                        combinedCss += block.css + '\n';
                    }
                    if (block.js) { // Check for 'js' property
                        combinedJs += block.js + '\n';
                    }
                });

                // Apply combined CSS
                let styleTag = document.getElementById('dynamic-css-index');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'dynamic-css-index';
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = combinedCss;

                // Execute combined JS
                let scriptTag = document.getElementById('dynamic-js-index');
                if (scriptTag) {
                    scriptTag.remove(); // Remove old script to re-execute
                }
                scriptTag = document.createElement('script');
                scriptTag.id = 'dynamic-js-index';
                scriptTag.textContent = combinedJs;
                document.body.appendChild(scriptTag);

                console.log("Konten dinamis untuk index.html berhasil dimuat.");
            } catch (error) {
                console.error("Gagal memuat konten dinamis untuk index.html:", error);
            }
        }
    </script>
</body>
</html>
