<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Admin - Asdar Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; background-color: #f5f5f5; font-family: 'Poppins', sans-serif; }
    h1 { margin-bottom: 20px; }
    .card { margin-bottom: 15px; }
    img { max-width: 100px; margin-top: 10px; border-radius: 5px; }
    #galeri img { max-width: 120px; margin: 5px; border-radius: 6px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Dashboard Admin - Asdar Store</h1>
  
  <!-- Statistik Pesanan -->
  <div class="row text-center mb-3">
    <div class="col"><div class="card p-2 bg-info text-white">Total Pesanan<br/><b id="statPesanan">0</b></div></div>
    <div class="col"><div class="card p-2 bg-success text-white">Selesai<br/><b id="statSelesai">0</b></div></div>
    <div class="col"><div class="card p-2 bg-warning text-white">Diproses<br/><b id="statProses">0</b></div></div>
  </div>
  
  <!-- Filter Pesanan -->
  <div class="row mb-3">
    <div class="col-md-4">
      <select id="filterStatus" class="form-select">
        <option value="">Filter Semua Status</option>
        <option value="Belum Bayar">Belum Bayar</option>
        <option value="Sudah Bayar">Sudah Bayar</option>
        <option value="Diproses">Diproses</option>
        <option value="Selesai">Selesai</option>
      </select>
    </div>
    <div class="col-md-4">
      <input type="text" id="searchId" class="form-control" placeholder="Cari ID Pesanan" />
    </div>
    <div class="col-md-4">
      <button class="btn btn-success w-100" id="exportCSVBtn">Export CSV</button>
    </div>
  </div>

  <!-- List Pesanan -->
  <div id="pesananList"></div>

  <!-- Upload Bukti Admin -->
  <h3>Upload Bukti Admin ke Pembeli</h3>
  <input type="file" id="buktiAdmin" class="form-control mb-2" accept="image/*" />
  <button id="uploadBuktiBtn" class="btn btn-primary mb-4">Kirim Bukti & Selesaikan</button>
  <hr>

  <!-- (Bagian lain seperti produk, galeri, fitur dinamis bisa ditambahkan di sini jika perlu) -->

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Konfigurasi Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
    authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
    databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
    projectId: "asdarstoredigitalll-d89c4",
    storageBucket: "asdarstoredigitalll.appspot.com",
    messagingSenderId: "220670500351",
    appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Nomor WA admin untuk notif
  const nomorAdmin = "6281803004607";

  let selectedId = null;  // Pesanan yg dipilih untuk upload bukti

  // Tampilkan pesanan dengan filter dan pencarian
  async function tampilkanPesanan() {
    const filter = document.getElementById('filterStatus').value;
    const search = document.getElementById('searchId').value.toLowerCase();
    const snap = await db.ref('pesanan').once('value');
    const data = snap.val() || {};

    let html = '';
    let total = 0, selesai = 0, diproses = 0;

    for (const id in data) {
      const p = data[id];
      // Statistik
      total++;
      if (p.status === 'Selesai') selesai++;
      if (p.status === 'Diproses') diproses++;

      // Filter
      if (filter && p.status !== filter) continue;
      if (search && !id.toLowerCase().includes(search)) continue;

      html += `<div class="card mb-2"><div class="card-body">
        <b>ID:</b> ${id}<br/>
        <b>Nama:</b> ${p.nama || '-'}<br/>
        <b>Nomor:</b> ${p.nomor || '-'}<br/>
        <b>Kategori:</b> ${p.kategori || '-'}<br/>
        <b>Produk:</b> ${p.produk || '-'}<br/>
        <b>Status:</b> ${p.status || '-'}<br/>
        <b>Waktu:</b> ${p.waktu || '-'}<br/>
        ${p.buktiBayar ? `<b>Bukti Pembeli:</b><br/><img src="${p.buktiBayar}" style="max-width:120px; border-radius:5px;" />` : ''}
        ${p.buktiAdmin ? `<br/><b>Bukti Admin:</b><br/><img src="${p.buktiAdmin}" style="max-width:120px; border-radius:5px;" />` : ''}
        <br/><br/>
        <button class="btn btn-warning btn-sm" onclick="setSelected('${id}')">Pilih Pesanan</button>
        <button class="btn btn-info btn-sm" onclick="updateStatus('${id}','Diproses')">Proses</button>
        <button class="btn btn-danger btn-sm" onclick="hapusPesanan('${id}')">Hapus</button>
      </div></div>`;
    }

    document.getElementById('pesananList').innerHTML = html;
    document.getElementById('statPesanan').innerText = total;
    document.getElementById('statSelesai').innerText = selesai;
    document.getElementById('statProses').innerText = diproses;
  }

  // Pilih pesanan
  function setSelected(id) {
    selectedId = id;
    alert("Pesanan " + id + " dipilih untuk upload bukti admin.");
  }

  // Update status pesanan
  function updateStatus(id, status) {
    db.ref('pesanan/' + id).update({ status })
      .then(() => {
        kirimNotifWA(`Pesanan ${id} status diubah ke ${status}`);
        tampilkanPesanan();
      });
  }

  // Hapus pesanan
  function hapusPesanan(id) {
    if (!confirm("Yakin hapus pesanan " + id + "?")) return;
    db.ref('pesanan/' + id).remove().then(() => {
      alert("Pesanan dihapus");
      tampilkanPesanan();
    });
  }

  // Kirim notifikasi WA pakai ngirimwa
  async function kirimNotifWA(pesan) {
    try {
      await fetch("https://ngirimwa.vercel.app/api/send-message", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ nomor: nomorAdmin, pesan })
      });
    } catch(e) {
      console.error("Gagal kirim WA:", e);
    }
  }

  // Upload bukti admin ke imgbb dan update Firebase
  async function uploadBukti() {
    const fileInput = document.getElementById('buktiAdmin');
    const file = fileInput.files[0];
    if (!file) return alert("Pilih gambar bukti admin dulu!");
    if (!selectedId) return alert("Pilih pesanan dulu!");

    const formData = new FormData();
    formData.append("image", file);

    const imgbbApiKey = "f71ccc1a662c9f8656766990018d3a33"; // API imgbb Anda

    try {
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      if (!json.success) throw new Error("Gagal upload gambar ke imgbb");

      const urlBukti = json.data.url;

      // Update Firebase: status jadi Selesai dan simpan url buktiAdmin
      await db.ref('pesanan/' + selectedId).update({
        buktiAdmin: urlBukti,
        status: "Selesai"
      });

      alert("Upload bukti admin berhasil dan status pesanan diubah ke Selesai.");
      kirimNotifWA(`Pesanan ${selectedId} sudah selesai.\nBukti Admin: ${urlBukti}`);

      // Reset input dan refresh
      fileInput.value = '';
      selectedId = null;
      tampilkanPesanan();
    } catch (error) {
      alert("Gagal upload bukti: " + error.message);
    }
  }

  // Event listener tombol upload bukti
  document.getElementById('uploadBuktiBtn').addEventListener('click', uploadBukti);

  // Event filter & search
  document.getElementById('filterStatus').addEventListener('change', tampilkanPesanan);
  document.getElementById('searchId').addEventListener('input', tampilkanPesanan);

  // Export CSV (optional, bisa dikembangkan)
  document.getElementById('exportCSVBtn').addEventListener('click', async () => {
    const snap = await db.ref('pesanan').once('value');
    const data = snap.val() || {};
    let csv = 'ID,Nama,Nomor,Kategori,Produk,Status,Waktu\n';
    for (const id in data) {
      const p = data[id];
      csv += `"${id}","${p.nama || ''}","${p.nomor || ''}","${p.kategori || ''}","${p.produk || ''}","${p.status || ''}","${p.waktu || ''}"\n`;
    }
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pesanan.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Load data awal
  tampilkanPesanan();
</script>
</body>
</html>
