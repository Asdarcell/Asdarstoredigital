<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Bukti Pembayaran</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
      --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
      --success: #28a745; --danger: #e74c3c;
    }
    [data-theme="dark"] {
      --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
      --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
    }
    body {
      font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
      transition: background-color 0.3s ease, color 0.3s ease; margin: 0; line-height: 1.6;
    }
    header {
      position: sticky; top: 0; background: var(--card); padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border); z-index: 999;
    }
    header h1 { margin: 0; font-size: 24px; color: var(--primary); }
    main { max-width: 700px; margin: 20px auto; padding: 0 20px; }
    .section-container {
      background: var(--card); padding: 25px; border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow); margin-top: 20px;
    }
    h2 { color: var(--primary); margin-top: 30px; margin-bottom: 20px; text-align: center; }
    input[type="file"] {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background-color: var(--card);
        color: var(--text);
    }
    button {
        width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px;
        border: none; background: var(--primary); color: white; cursor: pointer;
        font-weight: bold; font-size: 16px; transition: all 0.2s ease;
    }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .notification {
        padding: 15px; margin-bottom: 15px; border-radius: 8px;
        font-weight: 600; display: none; text-align: center;
    }
    .notification.info { background-color: #d1ecf1; color: #0c5460; }
    .notification.success { background-color: #d4edda; color: #155724; }
    .notification.error { background-color: #f8d7da; color: #721c24; }
  </style>
</head>

<body data-theme="dark">
  <header>
    <h1>Upload Bukti Pembayaran</h1>
  </header>

  <main>
    <div data-aos="fade-up" class="section-container">
      <div id="status-message" class="notification info" style="display: block;">
        Memuat...
      </div>
      <form id="uploadForm" style="display:none;">
        <p class="text-center">Unggah bukti transfer untuk pesanan dengan ID: <br><strong id="order-id-display"></strong></p>
        <div id="order-info-display" class="info mb-4"></div>
        <label for="proof">Pilih Bukti Pembayaran (JPG, PNG)</label>
        <input type="file" id="proof" accept="image/png, image/jpeg" required>
        <button type="submit" id="submit-btn"><i class="fas fa-upload me-2"></i>Kirim Bukti</button>
      </form>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({ duration: 800, once: true, offset: 50 });

    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    firebase.initializeApp(firebaseConfig);
    const dbFS = firebase.firestore();
    
    const ImgBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";

    const uploadForm = document.getElementById('uploadForm');
    const statusMessage = document.getElementById('status-message');
    const orderIdDisplay = document.getElementById('order-id-display');
    const orderInfoDisplay = document.getElementById('order-info-display');
    const submitBtn = document.getElementById('submit-btn');

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    const setButtonLoading = (isLoading) => {
        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading 
            ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Mengunggah...'
            : '<i class="fas fa-upload me-2"></i>Kirim Bukti';
    };

    async function uploadImageToImgBB(file) {
      try {
        const formData = new FormData();
        formData.append("key", ImgBB_API_KEY);
        formData.append("image", file);

        const response = await fetch("https://api.imgbb.com/1/upload", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();
        if (data.success) {
          return data.data.url;
        } else {
          throw new Error(data.error.message);
        }
      } catch (error) {
        console.error("Error saat mengunggah ke ImgBB:", error);
        throw new Error("Gagal mengunggah gambar. " + error.message);
      }
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      setButtonLoading(true);

      const proofFile = document.getElementById('proof').files[0];
      const orderId = orderIdDisplay.textContent;

      if (!proofFile || !orderId) {
        statusMessage.textContent = 'Data tidak lengkap.';
        statusMessage.className = 'notification error';
        setButtonLoading(false);
        return;
      }

      try {
        const orderRef = dbFS.collection('pesananUmum').doc(orderId);
        const orderDoc = await orderRef.get();
        if (!orderDoc.exists) {
            throw new Error('ID pesanan tidak valid.');
        }
        if (orderDoc.data().status !== 'Menunggu Pembayaran') {
            throw new Error('Bukti sudah pernah dikirim atau pesanan sudah diproses.');
        }
        
        statusMessage.textContent = 'Sedang memproses bukti, mohon tunggu sebentar...';
        statusMessage.className = 'notification info';

        const imageUrl = await uploadImageToImgBB(proofFile);
        await orderRef.update({
          status: 'Menunggu Verifikasi',
          bukti_url: imageUrl,
          waktu_upload_bukti: firebase.firestore.FieldValue.serverTimestamp()
        });

        statusMessage.textContent = 'Bukti pembayaran berhasil dikirim! Silakan tunggu admin memverifikasi pesanan Anda.';
        statusMessage.className = 'notification success';
        uploadForm.reset();
      } catch (error) {
        console.error("Error saat mengunggah bukti:", error);
        statusMessage.textContent = `Gagal mengirim bukti: ${error.message}`;
        statusMessage.className = 'notification error';
      } finally {
        setButtonLoading(false);
      }
    });

    async function fetchOrderDetails(orderId) {
        try {
            const orderRef = dbFS.collection('pesananUmum').doc(orderId);
            const orderDoc = await orderRef.get();
            if (orderDoc.exists) {
                const orderData = orderDoc.data();
                if (orderData.status !== 'Menunggu Pembayaran') {
                     statusMessage.textContent = `Pesanan ini sudah berstatus: ${orderData.status}. Bukti tidak bisa diunggah lagi.`;
                     statusMessage.className = 'notification info';
                     return false;
                }
                const produk = orderData.produk;
                const harga = formatRupiah(orderData.harga_final);
                orderInfoDisplay.innerHTML = `<strong>Produk:</strong> ${produk}<br><strong>Harga:</strong> ${harga}<br><strong>Status:</strong> ${orderData.status}`;
                return true;
            } else {
                statusMessage.textContent = 'ID pesanan tidak valid atau tidak ditemukan.';
                statusMessage.className = 'notification error';
                return false;
            }
        } catch (error) {
            console.error("Gagal memuat detail pesanan:", error);
            statusMessage.textContent = 'Gagal memuat detail pesanan. Pastikan ID benar dan koneksi internet stabil.';
            statusMessage.className = 'notification error';
            return false;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('id');

      if (orderId) {
        orderIdDisplay.textContent = orderId;
        const isValidOrder = await fetchOrderDetails(orderId);
        if (isValidOrder) {
          statusMessage.style.display = 'none';
          uploadForm.style.display = 'block';
        }
      } else {
        statusMessage.textContent = 'ID pesanan tidak ditemukan.';
        statusMessage.className = 'notification error';
      }
    });
  </script>
</body>
</html>
