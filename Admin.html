<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Admin - Asdar Store</title>
  <style>
    body {
      font-family: Poppins, sans-serif;
      background: #eef3ff;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      color: #007BFF;
    }
    button.logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      float: right;
      margin-top: -50px;
    }
    button.logout-btn:hover {
      background: #b02a37;
    }
    section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 {
      color: #007BFF;
      margin-bottom: 15px;
      border-bottom: 2px solid #007BFF;
      padding-bottom: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    th, td {
      padding: 12px 10px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #f0f7ff;
    }
    button.delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
    }
    button.delete-btn:hover {
      background: #b02a37;
    }
    img.bukti-img {
      max-width: 100px;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }
    .loading {
      text-align: center;
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard Admin Asdar Store Digital</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <section id="testimoniSection">
    <h2>Testimoni Pelanggan</h2>
    <div id="loadingTesti" class="loading">Memuat testimoni...</div>
    <table id="tableTestimoni" style="display:none;">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Isi Testimoni</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="pesananSection">
    <h2>Riwayat Pembayaran</h2>
    <div id="loadingPesanan" class="loading">Memuat pesanan...</div>
    <table id="tablePesanan" style="display:none;">
      <thead>
        <tr>
          <th>Produk</th>
          <th>Harga (Rp)</th>
          <th>Bukti Pembayaran</th>
          <th>Waktu</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
      storageBucket: "asdarstoredigitalll-d89c4.appspot.com",
      messagingSenderId: "220670500351",
      appId: "1:220670500351:web:5737ae5958a6f5a67d5bca"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Cek apakah user sudah login
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Jika belum login, redirect ke login
        window.location.href = "login.html";
      } else {
        // Jika sudah login, muat data
        loadTestimoni();
        loadPesanan();
      }
    });

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    // Load testimoni dari Firebase Realtime DB
    function loadTestimoni() {
      const testiTable = document.getElementById("tableTestimoni");
      const testiBody = testiTable.querySelector("tbody");
      const loading = document.getElementById("loadingTesti");

      db.ref("testimoni").on("value", snapshot => {
        testiBody.innerHTML = "";
        if (!snapshot.exists()) {
          testiBody.innerHTML = `<tr><td colspan="3" style="text-align:center">Belum ada testimoni</td></tr>`;
          loading.style.display = "none";
          testiTable.style.display = "table";
          return;
        }
        snapshot.forEach(child => {
          const key = child.key;
          const data = child.val();

          const tr = document.createElement("tr");

          const tdNama = document.createElement("td");
          tdNama.textContent = data.nama;

          const tdIsi = document.createElement("td");
          tdIsi.textContent = data.isi;

          const tdAksi = document.createElement("td");
          const btnHapus = document.createElement("button");
          btnHapus.textContent = "Hapus";
          btnHapus.className = "delete-btn";
          btnHapus.onclick = () => {
            if(confirm(`Hapus testimoni dari ${data.nama}?`)) {
              db.ref("testimoni/" + key).remove();
            }
          };
          tdAksi.appendChild(btnHapus);

          tr.appendChild(tdNama);
          tr.appendChild(tdIsi);
          tr.appendChild(tdAksi);

          testiBody.appendChild(tr);
        });
        loading.style.display = "none";
        testiTable.style.display = "table";
      });
    }

    // Load pesanan / pembayaran dari Firebase
    function loadPesanan() {
      const pesananTable = document.getElementById("tablePesanan");
      const pesananBody = pesananTable.querySelector("tbody");
      const loading = document.getElementById("loadingPesanan");

      db.ref("pesanan").on("value", snapshot => {
        pesananBody.innerHTML = "";
        if (!snapshot.exists()) {
          pesananBody.innerHTML = `<tr><td colspan="5" style="text-align:center">Belum ada data pembayaran</td></tr>`;
          loading.style.display = "none";
          pesananTable.style.display = "table";
          return;
        }
        snapshot.forEach(child => {
          const key = child.key;
          const data = child.val();

          const tr = document.createElement("tr");

          const tdProduk = document.createElement("td");
          tdProduk.textContent = data.produk || "-";

          const tdHarga = document.createElement("td");
          tdHarga.textContent = data.harga ? data.harga.toLocaleString() : "-";

          const tdGambar = document.createElement("td");
          if(data.gambar){
            const img = document.createElement("img");
            img.src = data.gambar;
            img.alt = "Bukti Bayar";
            img.className = "bukti-img";
            tdGambar.appendChild(img);
          } else {
            tdGambar.textContent = "-";
          }

          const tdWaktu = document.createElement("td");
          tdWaktu.textContent = data.waktu || "-";

          const tdAksi = document.createElement("td");
          const btnHapus = document.createElement("button");
          btnHapus.textContent = "Hapus";
          btnHapus.className = "delete-btn";
          btnHapus.onclick = () => {
            if(confirm(`Hapus data pembayaran untuk "${data.produk}"?`)) {
              db.ref("pesanan/" + key).remove();
            }
          };
          tdAksi.appendChild(btnHapus);

          tr.appendChild(tdProduk);
          tr.appendChild(tdHarga);
          tr.appendChild(tdGambar);
          tr.appendChild(tdWaktu);
          tr.appendChild(tdAksi);

          pesananBody.appendChild(tr);
        });
        loading.style.display = "none";
        pesananTable.style.display = "table";
      });
    }
  </script>
</body>
</html>
