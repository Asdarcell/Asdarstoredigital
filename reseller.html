<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Reseller - Asdar Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body {
            background-color: var(--light-gray);
            font-family: 'Poppins', sans-serif;
        }
        .container { max-width: 900px; }
        .card { border-radius: 12px; box-shadow: var(--shadow); border: none; }
        #loading, #login-form, #access-denied, #reseller-dashboard { padding: 40px; text-align: center; }
        .form-control { border-radius: 8px; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="card p-4">
        <div id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Memuat...</p>
        </div>

        <div id="login-form" style="display: none;">
            <h2 class="mb-4">Login Reseller</h2>
            <form id="resellerLoginForm">
                <div class="mb-3">
                    <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Masuk</button>
            </form>
            <p class="mt-3">Belum punya akun? <a href="register-reseller.html">Daftar di sini</a></p>
        </div>

        <div id="access-denied" style="display: none;">
            <i class="fas fa-exclamation-triangle text-warning fa-3x"></i>
            <h3 class="mt-3">Akses Ditolak</h3>
            <p>Akun Anda belum disetujui oleh admin. Silakan tunggu atau hubungi admin untuk informasi lebih lanjut.</p>
            <button onclick="logout()" class="btn btn-primary">Kembali ke Login</button>
        </div>

        <div id="reseller-dashboard" style="display: none;">
            <h2 class="mb-4">Dashboard Reseller</h2>
            <div class="row text-start mb-4">
                <div class="col-md-6">
                    <p><strong>Nama Toko:</strong> <span id="namaToko"></span></p>
                    <p><strong>Email:</strong> <span id="resellerEmail"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Tier:</strong> <span id="resellerTier"></span></p>
                    <p><strong>Saldo:</strong> <span id="resellerSaldo" class="fw-bold text-success"></span></p>
                </div>
            </div>
            <div id="rekening-topup" class="alert alert-info text-start" role="alert">
                <h5 class="alert-heading">Informasi Top Up</h5>
                <p>Silakan lakukan top up saldo ke salah satu rekening berikut:</p>
                <ul id="payment-list" class="list-unstyled"></ul>
            </div>
            <button onclick="logout()" class="btn btn-danger"><i class="fas fa-sign-out-alt me-2"></i>Keluar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const dbFirestore = firebase.firestore();
    const db = firebase.database();

    const loadingEl = document.getElementById('loading');
    const loginFormEl = document.getElementById('login-form');
    const accessDeniedEl = document.getElementById('access-denied');
    const dashboardEl = document.getElementById('reseller-dashboard');

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    function showSection(section) {
        loadingEl.style.display = 'none';
        loginFormEl.style.display = 'none';
        accessDeniedEl.style.display = 'none';
        dashboardEl.style.display = 'none';
        section.style.display = 'block';
    }

    async function loadPaymentMethods() {
        const paymentList = document.getElementById('payment-list');
        const snapshot = await db.ref('infoPembayaran').once('value');
        const payments = snapshot.val();
        if (payments) {
            paymentList.innerHTML = Object.entries(payments).map(([k, v]) => `<li><strong>${k}</strong>: ${v.nomor} a.n ${v.nama}</li>`).join('');
        } else {
            paymentList.innerHTML = '<li>Informasi pembayaran belum tersedia.</li>';
        }
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            try {
                const doc = await dbFirestore.collection('resellers').doc(user.uid).get();
                if (doc.exists) {
                    const resellerData = doc.data();
                    if (resellerData.isApproved) {
                        document.getElementById('namaToko').textContent = resellerData.namaToko;
                        document.getElementById('resellerEmail').textContent = resellerData.email;
                        document.getElementById('resellerTier').textContent = resellerData.tier;
                        document.getElementById('resellerSaldo').textContent = formatRupiah(resellerData.saldo);
                        showSection(dashboardEl);
                        loadPaymentMethods();
                    } else {
                        showSection(accessDeniedEl);
                    }
                } else {
                    showSection(loginFormEl);
                    auth.signOut(); // Jika data tidak ditemukan, log out pengguna
                }
            } catch (e) {
                console.error("Error checking reseller data:", e);
                showSection(loginFormEl);
            }
        } else {
            showSection(loginFormEl);
        }
    });

    document.getElementById('resellerLoginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
            // onAuthStateChanged akan otomatis mengelola tampilan
        } catch (error) {
            alert("Login Gagal: " + error.message);
        }
    });

    function logout() {
        auth.signOut();
    }
</script>

</body>
</html>
