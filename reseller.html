<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Reseller - Asdar Store Digital</title>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        :root {
            --primary: #5A67D8;
            --secondary: #2C3E50;
            --background: #1A202C;
            --surface: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #CBD5E0;
            --success: #38A169;
            --error: #E53E3E;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--surface);
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin: 0;
        }
        .btn-isi-saldo {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.3s;
        }
        .btn-isi-saldo:hover {
            background-color: #2F855A;
        }
        .btn-beranda {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.3s;
        }
        .btn-beranda:hover {
            background-color: #434190;
        }
        .card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: var(--text-primary);
            margin-top: 0;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            color: var(--text-secondary);
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background-color: var(--background);
            border: 1px solid #4A5568;
            color: var(--text-primary);
            border-radius: 8px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(90, 103, 216, 0.5);
        }
        .info-panel {
            background-color: #2D3748;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .notification {
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 20px;
            display: none;
        }
        .notification.error {
            background-color: var(--error);
            color: white;
        }
        .notification.success {
            background-color: var(--success);
            color: white;
        }
        .btn-submit {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        .btn-submit:disabled {
            background-color: #4A5568;
            cursor: not-allowed;
        }
        .btn-submit:hover:not(:disabled) {
            background-color: #434190;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--surface);
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            color: var(--primary);
            margin-top: 0;
        }
        .modal-content p {
            color: var(--text-secondary);
        }
        .modal-content .btn-close {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        .nominal-options button {
            background-color: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--primary);
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .nominal-options button:hover {
            background-color: #2C3E50;
        }
        .nominal-options input {
            margin-top: 10px;
        }
        .btn-copy {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .form-cek-status {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .form-cek-status input {
            flex-grow: 1;
        }
        .btn-cek {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .status-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #2D3748;
            border-radius: 8px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" data-aos="fade-down">
            <h1>Asdar Store Digital</h1>
            <div>
                <a href="index.html" class="btn-beranda">Beranda</a>
                <a href="#" class="btn-isi-saldo" onclick="showIsiSaldoModal()">Isi Saldo</a>
            </div>
        </div>

        <div class="card" data-aos="fade-up">
            <h2>Panel Reseller</h2>
            <div id="formNotification" class="notification error"></div>
            <div class="info-panel" id="saldoInfo">
                <p>Masukkan nomor WhatsApp Anda untuk melihat saldo.</p>
            </div>
            
            <form id="formPesanan">
                <label for="waAktif">Nomor WhatsApp Aktif</label>
                <input type="text" id="waAktif" placeholder="Cth: 081234567890 (awali 08...)" required>
                
                <label for="nomor">Nomor HP / ID Game</label>
                <input type="text" id="nomor" placeholder="Cth: 081234567890 atau ID Anda" required>
                
                <label for="kategori">Kategori Produk</label>
                <select id="kategori" required>
                    <option value="">Pilih Kategori</option>
                </select>

                <label for="produk">Produk</label>
                <select id="produk" required>
                    <option value="">Pilih Produk Dahulu</option>
                </select>
                
                <div class="info-panel" id="infoProduk">
                    Harga dan deskripsi akan muncul di sini.
                </div>
                
                <button type="submit" id="submitBtn" class="btn-submit" disabled>Pilih Produk Dahulu</button>
            </form>
        </div>

        <div class="card" data-aos="fade-up">
            <h2>Cek Status Pesanan</h2>
            <div class="form-cek-status">
                <input type="text" id="idCek" placeholder="Masukkan ID Pesanan">
                <button type="button" class="btn-cek" onclick="cekStatus()">Cek</button>
            </div>
            <div id="statusPesanan" class="status-container"></div>
        </div>
    </div>

    <div id="isiSaldoModal" class="modal">
        <div class="modal-content">
            <h3>Isi Saldo</h3>
            <p>Pilih nominal atau masukkan jumlah yang Anda transfer.</p>
            <div class="nominal-options">
                <button onclick="pilihNominal(50000)">50rb</button>
                <button onclick="pilihNominal(100000)">100rb</button>
                <button onclick="pilihNominal(200000)">200rb</button>
                <input type="number" id="nominalLainnya" placeholder="Nominal lainnya">
            </div>
            <button class="btn-submit" onclick="kirimBuktiTransfer()">Kirim Bukti Transfer</button>
            <button class="btn-close" onclick="hideIsiSaldoModal()">Tutup</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <h3>Pesanan Berhasil!</h3>
            <p>ID Pesanan Anda:</p>
            <h2 id="orderIdText" style="color:var(--primary);"></h2>
            <button class="btn-copy" onclick="copyIdPesanan()">Salin ID Pesanan</button>
            <p>Silakan tunggu pesanan Anda diproses oleh admin.</p>
            <button class="btn-close" onclick="hideSuccessModal()">Tutup</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 800, once: true, offset: 50 });

        const firebaseConfig = {
            apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
            authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
            databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
            projectId: "asdarstoredigitalll-d89c4",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let produkTerpilihData = null;
        const WA_ADMIN = "6281234567890"; // Ganti dengan nomor WhatsApp admin Anda

        const submitBtn = document.getElementById('submitBtn');
        const kategoriSelect = document.getElementById('kategori');
        const produkSelect = document.getElementById('produk');
        const infoProduk = document.getElementById('infoProduk');
        const formNotification = document.getElementById('formNotification');
        const waAktifInput = document.getElementById('waAktif');
        const saldoInfoDiv = document.getElementById('saldoInfo');
        const isiSaldoModal = document.getElementById('isiSaldoModal');
        const successModal = document.getElementById('successModal');
        const orderIdText = document.getElementById('orderIdText');
        const statusPesananDiv = document.getElementById('statusPesanan');
        let nominalIsiSaldo = 0;
        let saldoCheckTimeout = null;

        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
        
        // --- FUNGSI normalizePhone() YANG SUDAH DIPERBAIKI ---
        const normalizePhone = (num) => {
            const cleanNum = String(num).trim().replace(/[^0-9]/g, '');
            return cleanNum;
        };
        // --- AKHIR FUNGSI normalizePhone() YANG DIPERBAIKI ---
        
        const showNotification = (message, type = 'error') => {
            formNotification.textContent = message;
            formNotification.className = `notification ${type}`;
            formNotification.style.display = 'block';
        };
        const hideNotification = () => { formNotification.style.display = 'none'; };
        const resetFormState = () => {
            produkTerpilihData = null;
            infoProduk.innerHTML = 'Harga dan deskripsi akan muncul di sini.';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Pilih Produk Dahulu';
            hideNotification();
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            kategoriSelect.addEventListener('change', handleCategoryChange);
            produkSelect.addEventListener('change', handleProductSelection);
            document.getElementById('formPesanan').addEventListener('submit', handleOrderSubmit);
            waAktifInput.addEventListener('input', () => {
                clearTimeout(saldoCheckTimeout);
                saldoCheckTimeout = setTimeout(checkResellerSaldo, 500);
            });
        });
        
        async function loadInitialData() {
            try {
                const snapshot = await db.ref('produk').once('value');
                const data = snapshot.val() || {};
                kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
                for (const kategori in data) {
                    kategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
                }
            } catch (error) {
                console.error("Error loading categories:", error);
                showNotification("Gagal memuat kategori produk. Silakan refresh halaman.", "error");
            }
        }

        async function handleCategoryChange() {
            resetFormState();
            const kategori = kategoriSelect.value;
            if (!kategori) {
                produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
                return;
            }
            
            try {
                produkSelect.innerHTML = '<option value="">Memuat produk...</option>';
                const snapshot = await db.ref(`produk/${kategori}`).once('value');
                const data = snapshot.val() || {};
                const sortedVarian = Object.keys(data).sort((a, b) => (data[a].urutan || 0) - (data[b].urutan || 0));
                
                produkSelect.innerHTML = '<option value="">Pilih Produk</option>';
                sortedVarian.forEach(nama => {
                    produkSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
                });
            } catch (error) {
                console.error("Error loading products:", error);
                showNotification("Gagal memuat produk. Coba pilih kategori lain.", "error");
            }
        }

        async function handleProductSelection() {
            const kategori = kategoriSelect.value;
            const produk = produkSelect.value;
            if (!produk) {
                resetFormState();
                return;
            }
            
            infoProduk.innerHTML = 'Memuat detail produk...';
            submitBtn.disabled = true;
            submitBtn.textContent = '...';
            
            try {
                const snapshot = await db.ref(`produk/${kategori}/${produk}`).once('value');
                if (!snapshot.exists()) {
                    infoProduk.innerHTML = 'Produk tidak ditemukan.';
                    return;
                }
                
                produkTerpilihData = snapshot.val();
                const hargaReseller = parseFloat(produkTerpilihData.harga_reseller || produkTerpilihData.harga || 0);
                const stok = parseInt(produkTerpilihData.stok || 0);
                
                if (stok <= 0) {
                    submitBtn.textContent = 'Stok Habis';
                    infoProduk.innerHTML = `<b class="text-danger">Stok saat ini habis.</b><br><b>Harga Reseller:</b> ${formatRupiah(hargaReseller)}`;
                } else {
                    submitBtn.textContent = `Beli dengan Saldo`;
                    submitBtn.disabled = false;
                    infoProduk.innerHTML = `<b>Harga Reseller:</b> ${formatRupiah(hargaReseller)}<br><b>Deskripsi:</b> ${produkTerpilihData.cara || '-'}<br><b>Stok Tersedia:</b> ${stok}`;
                }
            } catch (error) {
                console.error("Error selecting product:", error);
                infoProduk.innerHTML = 'Gagal memuat detail produk.';
            }
        }
        
        async function checkResellerSaldo() {
            const waInput = waAktifInput.value.trim();
            if (!waInput) {
                saldoInfoDiv.innerHTML = `<p>Masukkan nomor WhatsApp Anda untuk melihat saldo.</p>`;
                return;
            }
            
            const nomorWA = normalizePhone(waInput);
            if (nomorWA.length < 10) {
                saldoInfoDiv.innerHTML = `<p>Nomor WhatsApp tidak valid.</p>`;
                return;
            }

            try {
                const snapshot = await db.ref('resellers/' + nomorWA).once('value');
                const data = snapshot.val();
                const saldo = parseInt(data && data.saldo) || 0;
                saldoInfoDiv.innerHTML = `<p><strong>Saldo Anda:</strong> <span style="color:var(--success); font-weight:700;">${formatRupiah(saldo)}</span></p>`;
            } catch (error) {
                console.error("Error checking saldo:", error);
                saldoInfoDiv.innerHTML = `<p class="text-danger">Gagal memuat saldo. Silakan coba lagi.</p>`;
            }
        }

        async function handleOrderSubmit(e) {
            e.preventDefault();
            hideNotification();
            
            if (submitBtn.disabled || !produkTerpilihData) return;
            
            const nomor = document.getElementById('nomor').value.trim();
            const waAktif = normalizePhone(waAktifInput.value.trim());
            const kategori = kategoriSelect.value;
            const produk = produkSelect.value;
            const hargaProduk = parseInt(produkTerpilihData.harga_reseller || produkTerpilihData.harga || 0);

            if (!waAktif || !nomor || !kategori || !produk) {
                showNotification("Harap lengkapi semua data.", "error");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Memproses...';

            try {
                const resellerRef = db.ref('resellers/' + waAktif);
                const produkRef = db.ref(`produk/${kategori}/${produk}`);

                const resellerResult = await resellerRef.transaction(currentData => {
                    const currentSaldo = parseInt(currentData && currentData.saldo) || 0;
                    
                    if (currentSaldo < hargaProduk) {
                        return;
                    }
                    
                    if (!currentData) {
                      currentData = { saldo: 0 };
                    }

                    currentData.saldo -= hargaProduk;
                    return currentData;
                });
                
                if (resellerResult.committed) {
                    const produkResult = await produkRef.transaction(currentData => {
                        const stok = parseInt(currentData && currentData.stok) || 0;
                        if (stok <= 0) {
                            return;
                        }
                        if (!currentData) currentData = {};
                        currentData.stok = stok - 1;
                        return currentData;
                    });

                    if (produkResult.committed) {
                        const orderId = "P" + Date.now();
                        await db.ref('pesanan/' + orderId).set({
                            id: orderId,
                            reseller: waAktif,
                            idGame: nomor,
                            kategori: kategori,
                            produk: produk,
                            waktu: new Date().toISOString(),
                            status: 'Menunggu diproses',
                            harga_bayar: hargaProduk,
                            tipe_pembayaran: 'Saldo Reseller'
                        });

                        orderIdText.textContent = orderId;
                        successModal.style.display = 'flex';
                        
                        const pesanWa = `Halo Admin, ada pesanan baru dari reseller:\n\n*ID Pesanan:* ${orderId}\n*Reseller:* ${waAktif}\n*Produk:* ${produk}\n*ID Game:* ${nomor}\n*Harga:* ${formatRupiah(hargaProduk)}\n\nLink Cepat untuk Memproses:\nhttps://sdarcell.github.io/adminpanelreseller.html?orderId=${orderId}`;
                        window.open(`https://wa.me/${WA_ADMIN}?text=${encodeURIComponent(pesanWa)}`, '_blank');
                        
                        document.getElementById('formPesanan').reset();
                        resetFormState();
                        checkResellerSaldo();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        await resellerRef.transaction(currentData => {
                            if (currentData) {
                                currentData.saldo += hargaProduk;
                            }
                            return currentData;
                        });
                        showNotification("Maaf, stok produk ini baru saja habis.", "error");
                    }
                } else {
                    const finalSnapshot = await resellerRef.once('value');
                    const finalSaldo = parseInt(finalSnapshot.val() && finalSnapshot.val().saldo) || 0;
                    if (finalSaldo < hargaProduk) {
                        showNotification("Maaf, saldo Anda tidak cukup.", "error");
                    } else {
                        showNotification("Terjadi kesalahan saat memproses saldo. Silakan coba lagi.", "error");
                    }
                }
            } catch (error) {
                console.error("Error saat memesan:", error);
                showNotification("Terjadi kesalahan yang tidak terduga. Silakan coba lagi.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Beli dengan Saldo';
            }
        }
        
        window.cekStatus = async () => {
            const id = document.getElementById('idCek').value.trim();
            if (!id) return;
            
            statusPesananDiv.style.display = 'none';
            statusPesananDiv.innerHTML = `<p class="text-center">Memuat status...</p>`;
            statusPesananDiv.style.display = 'block';

            try {
                const snapshot = await db.ref('pesanan/' + id).once('value');
                const data = snapshot.val();
                
                if (!data) {
                    statusPesananDiv.innerHTML = `<p class="text-center text-danger">ID Pesanan tidak ditemukan.</p>`;
                    return;
                }
                let statusHtml = `
                    <p><strong>ID Pesanan:</strong> ${data.id}</p>
                    <p><strong>Status:</strong> <span style="color:${data.status === 'Selesai' ? 'var(--success)' : 'orange'};font-weight:700;">${data.status}</span></p>
                    <p><strong>Produk:</strong> ${data.produk} (${data.kategori})</p>
                    <p><strong>Nomor/ID:</strong> ${data.idGame || data.nomor}</p>
                    <p><strong>Harga Bayar:</strong> ${formatRupiah(data.harga_bayar)}</p>
                `;
                if (data.status === 'Selesai' && data.bukti_url) {
                    statusHtml += `<p class="mt-3"><strong>Bukti Pengerjaan dari Admin:</strong></p>
                                <img src="${data.bukti_url}" alt="Bukti Pengerjaan" class="img-fluid">`;
                }
                statusPesananDiv.innerHTML = statusHtml;
                window.scrollTo({ top: statusPesananDiv.offsetTop - 80, behavior: 'smooth' });
            } catch (error) {
                console.error("Error saat cek status:", error);
                statusPesananDiv.innerHTML = `<p class="text-center text-danger">Gagal memuat status. Silakan coba lagi.</p>`;
            }
        };
        
        window.showIsiSaldoModal = () => {
            const wa = normalizePhone(waAktifInput.value);
            if (!wa || wa.length < 10) {
                alert('Harap masukkan nomor WhatsApp Anda di form utama terlebih dahulu.');
                return;
            }
            isiSaldoModal.style.display = 'flex';
            nominalIsiSaldo = 0;
            document.getElementById('nominalLainnya').value = '';
        };

        window.hideIsiSaldoModal = () => {
            isiSaldoModal.style.display = 'none';
        };

        window.pilihNominal = (nominal) => {
            nominalIsiSaldo = nominal;
            document.getElementById('nominalLainnya').value = nominal;
        };

        window.kirimBuktiTransfer = () => {
            const wa = normalizePhone(waAktifInput.value);
            const nominalLainnya = parseInt(document.getElementById('nominalLainnya').value);
            if (!wa || wa.length < 10) {
                alert('Harap masukkan nomor WhatsApp Anda.');
                return;
            }
            const jumlah = nominalIsiSaldo > 0 ? nominalIsiSaldo : nominalLainnya;
            if (isNaN(jumlah) || jumlah <= 0) {
                alert('Harap pilih nominal atau masukkan jumlah yang valid.');
                return;
            }
            const message = encodeURIComponent(`Halo admin, saya mau isi saldo reseller sebesar ${formatRupiah(jumlah)}. Nomor WA saya ${wa}.`);
            const url = `https://wa.me/${WA_ADMIN}?text=${message}`;
            window.open(url, '_blank');
            hideIsiSaldoModal();
        };

        window.copyIdPesanan = () => {
            const id = document.getElementById('orderIdText').textContent;
            navigator.clipboard.writeText(id).then(() => {
                alert('ID Pesanan berhasil disalin!');
            }).catch(err => {
                console.error('Gagal menyalin ID: ', err);
                alert('Gagal menyalin ID. Silakan salin manual.');
            });
        };
        
        window.hideSuccessModal = () => {
            successModal.style.display = 'none';
        };
    </script>
</body>
</html>
