<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Reseller</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db; --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05); --success: #28a745; --danger: #e74c3c;
    }
    [data-theme="dark"] {
      --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c; --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
    }
    body {
      font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); transition: background-color 0.3s ease, color 0.3s ease; margin: 0;
    }
    header {
      position: sticky; top: 0; background: var(--card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); z-index: 999;
    }
    header h1 { margin: 0; font-size: 24px; color: var(--primary); }
    .nav-buttons button, .nav-buttons a {
      margin-left: 10px; padding: 8px 16px; border-radius: 50px; font-weight: 600; border: none; cursor: pointer; transition: background-color 0.3s ease;
    }
    .nav-buttons a { text-decoration: none; display: inline-block; }
    #logoutBtn, #logoutBtn2 { background-color: var(--danger); color: white; }
    #logoutBtn:hover, #logoutBtn2:hover { background-color: #c0392b; }
    .top-up-btn { background-color: var(--success); color: white; }
    .top-up-btn:hover { background-color: #218838; }
    main { max-width: 700px; margin: 20px auto; padding: 0 20px; }
    .section-container {
      background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-top: 20px;
    }
    h2 { color: var(--primary); margin-top: 30px; margin-bottom: 20px; text-align: center; }
    label { font-weight: 600; margin-top: 15px; display: block; }
    input, select {
      width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); background-color: var(--card); color: var(--text);
    }
    button {
      width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; font-size: 16px; transition: background-color 0.2s ease;
    }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .message {
      padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600;
    }
    .error-message { background: var(--danger); color: white; }
    .info-message { background: var(--primary); color: white; }
    .success-message { background: var(--success); color: white; }
    #loadingPanel, #authPanel, #resellerPanel, #notResellerPanel { display: none; }
    #resellerPanel { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body data-theme="dark">

  <div id="loadingPanel" style="text-align: center; padding-top: 50px;">
    <h2>Memuat...</h2>
  </div>

  <div id="authPanel" class="section-container">
    <header>
      <h1>Reseller Login</h1>
    </header>
    <main>
      <h2>Selamat Datang, Reseller!</h2>
      <div id="authMessage" class="message" style="display:none;"></div>
      <form id="loginForm">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="Masukkan Email" required />
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Masukkan Password" required />
        <button type="submit">Login</button>
      </form>
      <div style="text-align:center; margin-top:15px;">
        <a href="#" id="showRegister">Belum punya akun? Daftar sekarang</a>
      </div>
      <form id="registerForm" style="display:none;">
        <hr>
        <h2>Daftar Akun Baru</h2>
        <label for="registerEmail">Email</label>
        <input type="email" id="registerEmail" placeholder="Masukkan Email" required />
        <label for="registerPassword">Password</label>
        <input type="password" id="registerPassword" placeholder="Masukkan Password" required />
        <button type="submit">Daftar</button>
        <div style="text-align:center; margin-top:15px;">
          <a href="#" id="showLogin">Sudah punya akun? Login di sini</a>
        </div>
      </form>
    </main>
  </div>

  <div id="notResellerPanel" class="section-container" style="padding: 50px 25px;">
    <header>
      <h1>Akses Ditolak</h1>
      <div class="nav-buttons">
        <button id="logoutBtn2">Keluar</button>
      </div>
    </header>
    <main style="text-align:center;">
        <h2 style="color: var(--danger); font-size: 2.5em;">â›”</h2>
        <p style="font-size: 1.1em; font-weight: 600;">Akun Anda belum terdaftar sebagai reseller atau permintaan Anda belum disetujui.</p>
        <div id="notResellerAction">
            <p>Silakan ajukan permintaan untuk menjadi reseller.</p>
            <button id="requestResellerBtn">Ajukan Permintaan Reseller</button>
        </div>
    </main>
  </div>

  <div id="resellerPanel">
    <header>
      <h1>Panel Reseller</h1>
      <div class="nav-buttons">
        <a href="topup.html" class="top-up-btn">Isi Saldo</a>
        <button id="logoutBtn">Keluar</button>
      </div>
    </header>
    <main>
      <div id="saldoPanel" class="section-container">
        <div id="saldoMessage" class="error-message" style="display:none;"></div>
        <h2>Saldo Anda</h2>
        <div class="saldo-info">
          Saldo Anda: <span class="saldo-value" id="saldoValue">Rp0</span>
        </div>
      </div>
      <div id="orderPanel" class="section-container">
        <div id="orderMessage" class="error-message" style="display:none;"></div>
        <h2>Pesan Produk</h2>
        <form id="orderForm">
          <label for="resellerWa">Nomor WhatsApp Aktif</label>
          <input type="tel" id="resellerWa" placeholder="Cth: 081234567890 (awali 08...)" pattern="^08[0-9]{8,15}$" required />
          <label for="resellerIdGame">Nomor HP / ID Game</label>
          <input type="text" id="resellerIdGame" placeholder="Cth: 081234567890 atau ID Anda" required />
          <label for="resellerKategori">Kategori Produk</label>
          <select id="resellerKategori" required>
            <option value="">Pilih Kategori</option>
          </select>
          <label for="resellerProduk">Produk</label>
          <select id="resellerProduk" required>
            <option value="">Pilih Produk</option>
          </select>
          <div class="info-message" id="infoProdukReseller"></div>
          <button type="submit" id="resellerSubmitBtn" disabled>Pilih Produk Dahulu</button>
        </form>
      </div>
      <div id="statusPesananReseller" class="section-container">
        <h2>Riwayat Pesanan</h2>
        <p>Anda bisa melihat riwayat pesanan Anda di sini setelah melakukan transaksi.</p>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // --- Bagian Inisialisasi dan Elemen ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    const loadingPanel = document.getElementById('loadingPanel');
    const authPanel = document.getElementById('authPanel');
    const resellerPanel = document.getElementById('resellerPanel');
    const notResellerPanel = document.getElementById('notResellerPanel');
    const notResellerAction = document.getElementById('notResellerAction');
    const authMessage = document.getElementById('authMessage');

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showRegisterLink = document.getElementById('showRegister');
    const showLoginLink = document.getElementById('showLogin');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutBtn2 = document.getElementById('logoutBtn2');
    const requestResellerBtn = document.getElementById('requestResellerBtn');
    const orderForm = document.getElementById('orderForm');
    const resellerKategoriSelect = document.getElementById('resellerKategori');
    const resellerProdukSelect = document.getElementById('resellerProduk');
    const infoProdukReseller = document.getElementById('infoProdukReseller');
    const resellerSubmitBtn = document.getElementById('resellerSubmitBtn');
    const saldoValue = document.getElementById('saldoValue');
    
    let produkResellerData = {};
    let produkTerpilihDataReseller = null;

    // --- Fungsi Bantuan ---
    const showPanel = (panel) => {
      loadingPanel.style.display = 'none';
      authPanel.style.display = 'none';
      resellerPanel.style.display = 'none';
      notResellerPanel.style.display = 'none';
      panel.style.display = 'block';
    };

    const showMessage = (element, message, type) => {
      element.textContent = message;
      element.className = `message ${type}-message`;
      element.style.display = 'block';
    };

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    // --- Fungsi Otentikasi dan Registrasi ---
    const handleAuth = async (isLogin) => {
      const form = isLogin ? loginForm : registerForm;
      const email = form.querySelector('input[type="email"]').value;
      const password = form.querySelector('input[type="password"]').value;

      try {
        if (isLogin) {
          await auth.signInWithEmailAndPassword(email, password);
        } else {
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          await firestore.collection('resellers').doc(userCredential.user.uid).set({
            email: userCredential.user.email,
            status: 'pending',
            registeredAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (error) {
        showMessage(authMessage, error.message, 'error');
      }
    };

    const requestResellerAccess = async (user) => {
      if (!user) return;
      const uid = user.uid;
      try {
        await firestore.collection('resellers').doc(uid).set({
          email: user.email,
          status: 'pending',
          requestedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        notResellerAction.innerHTML = '<p style="color:var(--success); font-weight:bold;">âœ… Permintaan Anda berhasil dikirim! Silakan tunggu persetujuan dari admin.</p>';
      } catch (error) {
        console.error("Gagal mengajukan permintaan:", error);
        notResellerAction.innerHTML = '<p style="color:var(--danger); font-weight:bold;">Terjadi kesalahan saat mengirim permintaan. Silakan coba lagi.</p>';
      }
    };

    // --- Fungsi untuk Panel Reseller ---
    function loadResellerData(uid) {
      // Load Saldo (Real-time listener)
      firestore.collection('resellers').doc(uid).onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          saldoValue.textContent = formatRupiah(data.saldo || 0);
        }
      });

      // Load Produk (Sekali muat)
      firestore.collection('produk').get().then(snapshot => {
        produkResellerData = {};
        const kategoriSet = new Set();
        snapshot.forEach(doc => {
          const data = doc.data();
          kategoriSet.add(data.kategori);
          if (!produkResellerData[data.kategori]) {
            produkResellerData[data.kategori] = {};
          }
          produkResellerData[data.kategori][data.nama] = { ...data, id: doc.id };
        });
        
        resellerKategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
        kategoriSet.forEach(kategori => {
          resellerKategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
        });
      });
    }

    // --- Event Listeners ---
    showPanel(loadingPanel);

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const uid = user.uid;
        const resellerDoc = await firestore.collection('resellers').doc(uid).get();
        if (resellerDoc.exists) {
          const data = resellerDoc.data();
          if (data.status === 'approved') {
            showPanel(resellerPanel);
            loadResellerData(uid);
            return;
          } else if (data.status === 'pending') {
            showPanel(notResellerPanel);
            notResellerAction.innerHTML = '<p style="color:var(--primary); font-weight:bold;">Permintaan Anda untuk menjadi reseller sedang dalam proses review.</p>';
            return;
          }
        }
        // Jika tidak ada dokumen atau statusnya tidak dikenal
        showPanel(notResellerPanel);
        requestResellerBtn.onclick = () => requestResellerAccess(user);
      } else {
        showPanel(authPanel);
      }
    });

    loginForm.onsubmit = (e) => { e.preventDefault(); handleAuth(true); };
    registerForm.onsubmit = (e) => { e.preventDefault(); handleAuth(false); };
    showRegisterLink.onclick = (e) => { e.preventDefault(); loginForm.style.display = 'none'; registerForm.style.display = 'block'; showMessage(authMessage, '', 'info'); };
    showLoginLink.onclick = (e) => { e.preventDefault(); registerForm.style.display = 'none'; loginForm.style.display = 'block'; showMessage(authMessage, '', 'info'); };
    logoutBtn.onclick = () => auth.signOut();
    logoutBtn2.onclick = () => auth.signOut();

    resellerKategoriSelect.addEventListener('change', () => {
      const kategori = resellerKategoriSelect.value;
      resellerProdukSelect.innerHTML = '<option value="">Pilih Produk</option>';
      if (kategori && produkResellerData[kategori]) {
        for (const produk in produkResellerData[kategori]) {
          resellerProdukSelect.innerHTML += `<option value="${produk}">${produk}</option>`;
        }
      }
      infoProdukReseller.textContent = '';
      resellerSubmitBtn.disabled = true;
      resellerSubmitBtn.textContent = 'Pilih Produk Dahulu';
    });

    resellerProdukSelect.addEventListener('change', () => {
      const kategori = resellerKategoriSelect.value;
      const produk = resellerProdukSelect.value;
      produkTerpilihDataReseller = null;
      if (kategori && produk && produkResellerData[kategori][produk]) {
        produkTerpilihDataReseller = produkResellerData[kategori][produk];
        const hargaReseller = produkTerpilihDataReseller.harga_reseller || produkTerpilihDataReseller.harga;
        infoProdukReseller.textContent = `Harga Reseller: ${formatRupiah(hargaReseller)}\nStok Tersedia: ${produkTerpilihDataReseller.stok}`;
        resellerSubmitBtn.disabled = false;
        resellerSubmitBtn.textContent = 'Beli dengan Saldo';
      } else {
        infoProdukReseller.textContent = '';
        resellerSubmitBtn.disabled = true;
        resellerSubmitBtn.textContent = 'Pilih Produk Dahulu';
      }
    });

    orderForm.onsubmit = async (e) => {
      e.preventDefault();
      resellerSubmitBtn.disabled = true;
      resellerSubmitBtn.textContent = 'Memproses...';
      const produkHarga = produkTerpilihDataReseller.harga_reseller || produkTerpilihDataReseller.harga;
      const uid = auth.currentUser.uid;
      
      try {
        await firestore.runTransaction(async (transaction) => {
          const resellerDocRef = firestore.collection('resellers').doc(uid);
          const produkDocRef = firestore.collection('produk').doc(produkTerpilihDataReseller.id);

          const resellerDoc = await transaction.get(resellerDocRef);
          const produkDoc = await transaction.get(produkDocRef);

          if (!resellerDoc.exists || !produkDoc.exists) {
            throw "Dokumen reseller atau produk tidak ditemukan!";
          }

          const currentSaldo = resellerDoc.data().saldo || 0;
          const currentStok = produkDoc.data().stok || 0;

          if (currentSaldo < produkHarga) {
            throw "Saldo tidak cukup!";
          }
          if (currentStok <= 0) {
            throw "Stok produk habis!";
          }

          transaction.update(resellerDocRef, { saldo: currentSaldo - produkHarga });
          transaction.update(produkDocRef, { stok: currentStok - 1 });
        });

        await firestore.collection('pesanan').add({
          nama: auth.currentUser.email,
          nomor: document.getElementById('resellerIdGame').value,
          wa_aktif: document.getElementById('resellerWa').value,
          kategori: resellerKategoriSelect.value,
          produk: resellerProdukSelect.value,
          harga_beli: produkHarga,
          waktu: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'Diproses'
        });

        showMessage(document.getElementById('orderMessage'), 'Pesanan berhasil dibuat!', 'success');
        orderForm.reset();
        resellerKategoriSelect.dispatchEvent(new Event('change'));

      } catch (error) {
        showMessage(document.getElementById('orderMessage'), 'Terjadi kesalahan saat memproses pesanan: ' + error, 'error');
        console.error(error);
      } finally {
        resellerSubmitBtn.disabled = false;
        resellerSubmitBtn.textContent = 'Beli dengan Saldo';
      }
    };
  </script>
</body>
</html>
