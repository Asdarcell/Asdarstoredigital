<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unggah Bukti Pembayaran</title>
    <link rel="icon" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --bg-body: #f7f9fc; --bg-card: #ffffff; --text-primary: #212529; --text-secondary: #6c757d; --color-brand: #007bff; --color-brand-hover: #0056b3; --border-color: #e0e0e0; --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); }
        [data-theme="dark"] { --bg-body: #1a202c; --bg-card: #2d3748; --text-primary: #e2e8f0; --text-secondary: #a0aec0; --color-brand: #4fd1c5; --color-brand-hover: #38b2ac; --border-color: #4a5568; --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.4); }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-primary); }
        main { max-width: 600px; margin: auto; width: 100%; padding: 1.5rem; }
        .section-card { background-color: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-light); padding: 1.5rem; }
        .section-card h2 { font-size: 1.6rem; font-weight: 600; color: var(--color-brand); margin-bottom: 1.5rem; text-align: center; }
        label { font-weight: 500; margin-top: 1rem; margin-bottom: 0.3rem; display: block; }
        input { width: 100%; padding: 0.8rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-card); color: var(--text-primary); }
        .btn { padding: 0.75rem 1.25rem; border-radius: 8px; border: none; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--color-brand); color: white; }
        .btn-primary:hover { background-color: var(--color-brand-hover); }
        .btn-gray { background-color: #6c757d; color: white; }
        .image-preview-container { margin-top: 1rem; border: 2px dashed var(--border-color); border-radius: 8px; padding: 1rem; text-align: center; display: none; }
        #image-preview { max-height: 200px; max-width: 100%; border-radius: 8px; margin: 0 auto 0.5rem auto; }
        .custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .custom-modal.show { opacity: 1; visibility: visible; }
        .custom-modal-content { background-color: var(--bg-card); color: var(--text-primary); padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; }
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 2001; display: none; justify-content: center; align-items: center; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body data-theme="light">
    <main>
        <div class="section-card">
            <button class="btn btn-gray mb-6" onclick="window.location.href='./'"><i class="fas fa-arrow-left"></i> Kembali</button>
            <h2>Konfirmasi Pembayaran</h2>
            <p class="text-sm text-text-secondary mb-4 text-center">Unggah bukti pembayaran Anda agar pesanan segera diproses.</p>
            <form id="uploadForm">
                <label for="orderId">ID Pesanan</label>
                <input type="text" id="orderId" placeholder="Masukkan ID Pesanan Anda" required />
                <label for="proofImage">Pilih Gambar Bukti Pembayaran</label>
                <input type="file" id="proofImage" accept="image/*" required />
                <div id="image-preview-container" class="image-preview-container">
                    <img id="image-preview" src="#" alt="Pratinjau" />
                    <p id="file-details" class="text-sm text-text-secondary"></p>
                </div>
                <button type="submit" class="btn btn-primary w-full mt-6">Unggah Bukti</button>
            </form>
        </div>
    </main>
    <div id="custom-modal" class="custom-modal"><div class="custom-modal-content"><p id="modal-message"></p><div id="modal-actions" class="mt-4"></div></div></div>
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
            authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
            databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
            projectId: "asdarstoredigitalll-d89c4",
            storageBucket: "asdarstoredigitalll-d89c4.firebasestorage.app",
            messagingSenderId: "220670500351",
            appId: "1:220670500351:web:5737ae5958a6f5a67d5bca",
            measurementId: "G-CMRW37J19G"
        };
        const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
        const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
        const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
        const ADMIN_WA_NUMBER = "6281803004607";

        // --- Init Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        const proofImageInput = document.getElementById('proofImage');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const fileDetails = document.getElementById('file-details');

        // --- Helpers ---
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';
        const showModal = (message, actionsHtml = '<button class="btn btn-primary" onclick="closeModal()">Oke</button>') => {
            modalMessage.innerHTML = message;
            modalActions.innerHTML = actionsHtml;
            modal.classList.add('show');
        };
        window.closeModal = () => modal.classList.remove('show');
        
        // --- Form & Preview Logic ---
        proofImageInput.addEventListener('change', () => {
            const file = proofImageInput.files[0];
            if (!file) { imagePreviewContainer.style.display = 'none'; return; }
            if (file.size > 5 * 1024 * 1024) {
                showModal('Ukuran file terlalu besar. Maksimal 5 MB.');
                proofImageInput.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                imagePreview.src = e.target.result;
                fileDetails.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                imagePreviewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('uploadForm').addEventListener('submit', async e => {
            e.preventDefault();
            const orderId = document.getElementById('orderId').value.trim();
            const imageFile = proofImageInput.files[0];
            if (!orderId || !imageFile) { showModal('Mohon lengkapi ID Pesanan dan pilih gambar bukti.'); return; }
            showLoading();

            try {
                const orderSnapshot = await db.ref(`pesanan/${orderId}`).once('value');
                if (!orderSnapshot.exists()) {
                    hideLoading();
                    showModal('ID Pesanan tidak ditemukan. Mohon periksa kembali.');
                    return;
                }
                const orderData = orderSnapshot.val();

                const formData = new FormData();
                formData.append('key', IMGBB_API_KEY);
                formData.append('image', imageFile);
                
                const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Gagal unggah gambar. Status: ${response.status}`);
                
                const result = await response.json();

                if (result.success) {
                    const imageUrl = result.data.url;
                    await db.ref(`pesanan/${orderId}`).update({
                        buktiBayarUrl: imageUrl,
                        status: 'Sudah Bayar'
                    });
                    
                    const adminMsg = `ðŸ”” Bukti Bayar Diterima! ðŸ””\n\nID Pesanan: *${orderId}*\nProduk: *${orderData.productName}*\nStatus: *Sudah Bayar*\nLink Bukti: ${imageUrl}\n\nSegera proses di Admin Panel.`;
                    const formDataWa = new FormData();
                    formDataWa.append('appkey', NGIRIMWA_APPKEY);
                    formDataWa.append('authkey', NGIRIMWA_AUTHKEY);
                    formDataWa.append('to', ADMIN_WA_NUMBER);
                    formDataWa.append('message', adminMsg);
                    await fetch('https://ngirimwa.com/api/send-message', { method: 'POST', body: formDataWa });

                    hideLoading();
                    const successActions = `<button class="btn btn-primary" onclick="window.location.href='./status.html?id=${orderId}'">Lihat Status Pesanan</button>`;
                    showModal(`Bukti berhasil diunggah untuk pesanan <b>${orderId}</b>.`, successActions);
                } else {
                    throw new Error(result.error.message || 'Error tidak diketahui dari ImgBB');
                }
            } catch (error) {
                hideLoading();
                console.error("Upload Process Error:", error);
                showModal(`Terjadi kesalahan: ${error.message}`);
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const orderIdFromUrl = new URLSearchParams(window.location.search).get('id');
            if (orderIdFromUrl) document.getElementById('orderId').value = orderIdFromUrl;
        });
    </script>
</body>
</html>
