<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unggah Bukti Pembayaran</title>
    <link rel="icon" href="https://placehold.co/32x32/007bff/ffffff?text=AS" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-body: #f7f9fc; --bg-card: #ffffff; --text-primary: #212529; --text-secondary: #6c757d;
            --color-brand: #007bff; --color-brand-hover: #0056b3; --border-color: #e0e0e0;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08); --focus-ring: rgba(0, 123, 255, 0.25);
        }
        [data-theme="dark"] {
            --bg-body: #1a202c; --bg-card: #2d3748; --text-primary: #e2e8f0; --text-secondary: #a0aec0;
            --color-brand: #4fd1c5; --color-brand-hover: #38b2ac; --border-color: #4a5568;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.4); --focus-ring: rgba(79, 209, 197, 0.35);
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-primary); }
        header { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-light); }
        header h1 { color: var(--color-brand); }
       .theme-toggle-btn:hover { color: var(--color-brand); }
        main { max-width: 600px; margin: auto; width: 100%; }
       .section-card { background-color: var(--bg-card); box-shadow: var(--shadow-light); }
       .section-card h2 { color: var(--color-brand); }
        input, select, textarea { border: 1px solid var(--border-color); background-color: var(--bg-card); color: var(--text-primary); }
        input:focus, select:focus, textarea:focus { border-color: var(--color-brand); box-shadow: 0 0 0 3px var(--focus-ring); }
       .btn-primary { background-color: var(--color-brand); }
       .btn-primary:not(:disabled):hover { background-color: var(--color-brand-hover); }
       .btn-gray { background-color: #6c757d; }
       .btn-gray:hover { background-color: #5a6268; }
       .image-preview-container { border: 2px dashed var(--border-color); display: none; }
    </style>
</head>
<body class="p-6">
    <header class="p-4 flex justify-between items-center sticky top-0 z-10 rounded-xl mb-6">
        <h1 class="text-2xl font-bold">Unggah Bukti</h1>
        <button class="theme-toggle-btn text-2xl" onclick="toggleTheme()" id="themeToggle">üåô</button>
    </header>

    <main>
        <div class="section-card p-6 rounded-xl">
            <button class="btn btn-gray mb-6" onclick="window.location.href='./'"><i class="fas fa-arrow-left"></i> Kembali</button>
            <h2 class="text-2xl font-bold text-center mb-2">Konfirmasi Pembayaran</h2>
            <p class="text-sm text-text-secondary mb-6 text-center">Unggah bukti pembayaran Anda agar pesanan segera diproses.</p>
            <form id="uploadForm">
                <label for="orderId" class="font-semibold">ID Pesanan</label>
                <input type="text" id="orderId" placeholder="Masukkan ID Pesanan Anda" class="w-full p-3 rounded-lg mt-1" required />
                <label for="proofImage" class="font-semibold mt-4">Pilih Gambar Bukti</label>
                <input type="file" id="proofImage" accept="image/png, image/jpeg, image/gif" class="w-full p-2 mt-1 border rounded-lg" required />
                <div id="image-preview-container" class="image-preview-container mt-4 p-4 rounded-lg text-center">
                    <img id="image-preview" src="#" alt="Pratinjau" class="max-h-48 rounded-lg mx-auto mb-2" />
                    <p id="file-details" class="text-sm text-text-secondary"></p>
                </div>
                <button type="submit" class="btn btn-primary w-full mt-6" id="uploadBtn"><i class="fas fa-upload"></i> Unggah Bukti</button>
            </form>
        </div>
    </main>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden"><div class="border-4 border-t-transparent border-white rounded-full w-10 h-10 animate-spin"></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
            authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
            databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
            projectId: "asdarstoredigitalll-d89c4",
            storageBucket: "asdarstoredigitalll-d89c4.firebasestorage.app",
            messagingSenderId: "220670500351",
            appId: "1:220670500351:web:5737ae5958a6f5a67d5bca",
            measurementId: "G-CMRW37J19G"
        };
        const IMGBB_API_KEY = "4bb65566f2b6bad0aef16ac5ae6b2fbc";
        const NGIRIMWA_APPKEY = "ab3727c5-e0be-40f9-bb3f-25d93b029f7a";
        const NGIRIMWA_AUTHKEY = "tbAWbiCwmK1H0IgWpkJFzwiv8yXMuenAyenek6rJBG8QEqyiqq";
        const ADMIN_WA_NUMBER = "6281803004607";

        // --- Init Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const uploadForm = document.getElementById('uploadForm');
        const orderIdInput = document.getElementById('orderId');
        const proofImageInput = document.getElementById('proofImage');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const fileDetails = document.getElementById('file-details');

        // --- Helpers ---
        const showLoading = () => loadingOverlay.style.display = 'flex';
        const hideLoading = () => loadingOverlay.style.display = 'none';

        // --- File Preview ---
        proofImageInput.addEventListener('change', () => {
            const file = proofImageInput.files;
            if (!file) { imagePreviewContainer.style.display = 'none'; return; }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Tipe file tidak valid. Harap pilih file gambar (JPG, PNG, GIF).');
                proofImageInput.value = ''; return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5 MB
                alert('Ukuran file terlalu besar. Maksimal 5 MB.');
                proofImageInput.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                fileDetails.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                imagePreviewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // --- Form Submission ---
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderId = orderIdInput.value.trim();
            const imageFile = proofImageInput.files;
            if (!orderId ||!imageFile) { alert('Mohon lengkapi semua data.'); return; }
            showLoading();
            try {
                const orderSnapshot = await db.ref(`pesanan/${orderId}`).once('value');
                if (!orderSnapshot.exists()) {
                    alert(`ID Pesanan ${orderId} tidak ditemukan.`);
                    hideLoading();
                    return;
                }
                const orderData = orderSnapshot.val();
                const formData = new FormData();
                formData.append('key', IMGBB_API_KEY);
                formData.append('image', imageFile);
                const imgbbResponse = await fetch("https://api.imgbb.com/1/upload", { method: 'POST', body: formData });
                const imgbbResult = await imgbbResponse.json();
                if (!imgbbResult.success) throw new Error('Gagal mengunggah gambar ke ImgBB.');
                const downloadURL = imgbbResult.data.url;
                await db.ref(`pesanan/${orderId}`).update({
                    buktiBayarUrl: downloadURL,
                    status: 'Sudah Bayar'
                });
                const waMessage = `üîî Bukti Bayar Diterima! üîî\n\nID Pesanan: *${orderId}*\nProduk: *${orderData.productName}*\nStatus: *Sudah Bayar*\nLink Bukti: ${downloadURL}`;
                await sendWhatsAppNotification(ADMIN_WA_NUMBER, waMessage);
                alert(`Bukti pembayaran untuk pesanan ID ${orderId} berhasil diunggah!`);
                window.location.href = `./status.html?id=${orderId}`;
            } catch (error) {
                console.error("Error:", error);
                alert('Terjadi kesalahan saat mengunggah bukti.');
            } finally {
                hideLoading();
            }
        });
        
        async function sendWhatsAppNotification(to, message) {
            const formData = new FormData();
            formData.append('appkey', NGIRIMWA_APPKEY);
            formData.append('authkey', NGIRIMWA_AUTHKEY);
            formData.append('to', to);
            formData.append('message', message);
            try {
                await fetch('https://ngirimwa.com/api/send-message', { method: 'POST', body: formData });
            } catch (error) { console.error('WA Error:', error); }
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme') |

| 'light';
            const next = current === 'light'? 'dark' : 'light';
            body.setAttribute('data-theme', next);
            document.getElementById('themeToggle').textContent = next === 'light'? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', next);
        }
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') |

| 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').textContent = savedTheme === 'light'? 'üåô' : '‚òÄÔ∏è';
            const orderIdFromUrl = new URLSearchParams(window.location.search).get('id');
            if (orderIdFromUrl) orderIdInput.value = orderIdFromUrl;
        });
    </script>
</body>
</html>
