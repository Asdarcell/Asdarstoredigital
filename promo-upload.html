<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klaim Hadiah Promo</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
      --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
      --success: #28a745; --danger: #e74c3c;
    }
    [data-theme="dark"] {
      --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
      --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 15px 20px; border-bottom: 1px solid var(--border); text-align: center; }
    header h1 { margin: 0; font-size: 24px; color: var(--primary); }
    main { max-width: 700px; margin: 20px auto; padding: 0 20px; }
    .section-container { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-top: 20px; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .success-card { text-align: center; padding: 2rem; }
    .success-card .fa-gift { font-size: 3rem; color: #f1c40f; }
    .success-card h3 { margin-top: 1rem; }
  </style>
</head>

<body data-theme="dark">
  <header>
    <h1>Klaim Hadiah Spesial Anda</h1>
  </header>

  <main>
    <div class="section-container">
      <div id="upload-container">
        <div id="welcome-message" class="text-center mb-4"></div>
        <form id="uploadForm">
          <label for="proof" class="form-label fw-bold">Pilih Screenshot Bukti Share</label>
          <input type="file" id="proof" class="form-control" accept="image/png, image/jpeg" required>
          <button type="submit" id="submit-btn" class="btn btn-primary w-100 mt-3"><i class="fas fa-upload me-2"></i>Kirim Bukti & Klaim Hadiah</button>
        </form>
        <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
      
      <div id="success-container" style="display: none;">
        <div class="success-card">
          <i class="fas fa-gift"></i>
          <h3>Terima Kasih!</h3>
          <p>Bukti Anda telah kami simpan. Admin akan segera memeriksanya. Diskon spesial akan menunggu Anda di pembelian berikutnya!</p>
          <a href="/" class="btn btn-success mt-3">Kembali ke Halaman Utama</a>
        </div>
      </div>

    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    firebase.initializeApp(firebaseConfig);
    const dbFS = firebase.firestore();
    
    // Pengaturan Cloudinary Anda
    const CLOUDINARY_CLOUD_NAME = "duki2bxqr";
    const CLOUDINARY_UPLOAD_PRESET = "hyvcqshq";

    const uploadContainer = document.getElementById('upload-container');
    const successContainer = document.getElementById('success-container');
    const uploadForm = document.getElementById('uploadForm');
    const welcomeMessage = document.getElementById('welcome-message');
    const errorMessage = document.getElementById('error-message');
    const submitBtn = document.getElementById('submit-btn');

    let userId = ''; // Variabel untuk menyimpan nomor WA

    const setButtonLoading = (isLoading) => {
        submitBtn.disabled = isLoading;
        submitBtn.innerHTML = isLoading 
            ? '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Mengunggah...'
            : '<i class="fas fa-upload me-2"></i>Kirim Bukti & Klaim Hadiah';
    };

    const showMessage = (message) => {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
    };
    
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData,
            });
            const data = await response.json();
            if (data.secure_url) {
                return data.secure_url;
            } else {
                throw new Error(data.error.message || "Error tidak diketahui dari Cloudinary");
            }
        } catch (error) {
            throw new Error("Gagal terhubung ke server Cloudinary. " + error.message);
        }
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setButtonLoading(true);
        errorMessage.style.display = 'none';

        const proofFile = document.getElementById('proof').files[0];
        if (!proofFile) {
            showMessage('Silakan pilih file screenshot terlebih dahulu.');
            setButtonLoading(false);
            return;
        }

        try {
            const imageUrl = await uploadToCloudinary(proofFile);
            
            // Menggunakan nomor WA (userId) sebagai nama dokumen
            await dbFS.collection('promoSubmissions').doc(userId).set({
                whatsapp_number: userId,
                screenshot_url: imageUrl,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending_review'
            }, { merge: true });

            uploadContainer.style.display = 'none';
            successContainer.style.display = 'block';

        } catch (error) {
            console.error("Error saat klaim promo:", error);
            showMessage(`Gagal mengirim bukti: ${error.message}`);
        } finally {
            setButtonLoading(false);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get('wa'); // Membaca parameter 'wa' dari URL

        if (userId) {
            welcomeMessage.innerHTML = `
                <p class="fs-5">Halo, Pemilik Nomor <strong class="text-primary">${userId}</strong>!</p>
                <p class="text-muted">Selangkah lagi untuk mendapatkan hadiahmu. Unggah screenshot bukti Anda telah membagikan info toko kami.</p>
            `;
        } else {
            uploadContainer.innerHTML = '<div class="alert alert-danger">Nomor WhatsApp tidak ditemukan. Silakan kembali melalui link di halaman status pesanan Anda.</div>';
        }
    });
  </script>
</body>
</html>
