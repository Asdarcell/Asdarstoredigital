<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=980">
    <title>Selamat Datang - Asdar Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #12172b; --card-bg: #1e294e; --primary-blue: #00aaff;
            --light-blue: #00d5ff; --text-light: #a7b2d3; --text-white: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif; background: var(--dark-bg); color: var(--text-light);
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
        }
        .Box-Pembungkus { position: relative; width: 800px; height: 500px; max-width: 100%; }
        .card-login, .card-regis {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg);
            border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); display: flex;
            transition: 0.7s ease-in-out; overflow: hidden;
        }
        .card-login { opacity: 1; transform: translateX(0); z-index: 2; }
        .card-regis { opacity: 0; transform: translateX(-100%); z-index: 1; }
        .Box-Pembungkus.active .card-login { transform: translateX(100%); opacity: 0; z-index: 1; }
        .Box-Pembungkus.active .card-regis { transform: translateX(0); opacity: 1; z-index: 2; }
        .quotes, .form { width: 50%; height: 100%; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .quotes { color: var(--text-white); background: linear-gradient(135deg, var(--light-blue), var(--primary-blue)); }
        .card-regis .quotes { order: 2; }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .form { align-items: center; }
        .form h2 { font-size: 2em; color: var(--primary-blue); margin-bottom: 20px; }
        .input-box { position: relative; width: 100%; margin-bottom: 35px; }
        .input-box input {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--text-light);
            color: var(--text-white); padding: 10px 0; font-size: 1em; outline: none;
        }
        .input-box label { position: absolute; top: 10px; left: 0; font-size: 1em; transition: 0.3s; pointer-events: none; }
        .input-box input:focus + label, .input-box input:valid + label { top: -15px; font-size: 0.8em; color: var(--primary-blue); }
        .input-box input:focus { border-bottom-color: var(--primary-blue); }
        .tombol { width: 100%; }
        .tombol button {
            width: 100%; background: var(--primary-blue); color: var(--text-white); border: none;
            padding: 12px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1.1em;
            transition: 0.3s; display: flex; justify-content: center; align-items: center;
        }
        .tombol button:hover { background: var(--light-blue); }
        .tombol button:disabled { background: #555; cursor: not-allowed; }
        .spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;
        }
        .link-switch { width: 100%; margin-top: 25px; text-align: center; }
        .link-switch a { color: var(--primary-blue); text-decoration: none; font-weight: 600; cursor: pointer; }
        .link-switch a:hover { text-decoration: underline; }
        .animasi { opacity: 0; animation: animasi 0.8s ease-in-out forwards; animation-delay: var(--anim-in); }
        .Box-Pembungkus.active .card-login .animasi { animation-delay: var(--anim-ex); }
        .Box-Pembungkus.active .card-regis .animasi { animation-delay: var(--anim-in); }
        @keyframes animasi {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* [BARU] Style untuk pesan notifikasi */
        .message-box { 
            width: 100%; text-align: center; padding: 10px; border-radius: 5px;
            font-size: 0.9em; margin-top: -15px; margin-bottom: 15px; display: none;
        }
        .message-box.success { background-color: #28a74520; color: #28a745; border: 1px solid #28a745; }
        .message-box.error { background-color: #e74c3c20; color: #e74c3c; border: 1px solid #e74c3c; }
    </style>

    <script src="https://www.google.com/recaptcha/api.js?render=GANTI_DENGAN_SITE_KEY_ANDA"></script>
</head>
<body>

<div class="Box-Pembungkus" id="Box-Pembungkus">
    <div class="card-login">
        <div class="form">
            <h2 class="animasi" style="--anim-in: 0.2s; --anim-ex: 0.9s;">LOGIN</h2>
            <div id="login-message" class="message-box"></div> <form id="formLogin">
                <div class="input-box animasi" style="--anim-in: 0.4s; --anim-ex: 0.7s;">
                    <input type="email" id="login-email" required>
                    <label for="login-email">Email Address</label>
                </div>
                <div class="input-box animasi" style="--anim-in: 0.6s; --anim-ex: 0.5s;">
                    <input type="password" id="login-pass" required>
                    <label for="login-pass">Password</label>
                </div>
                <div class="tombol animasi" style="--anim-in: 0.8s; --anim-ex: 0.3s;">
                    <button type="submit">LOGIN</button>
                </div>
                <div class="link-switch animasi" style="--anim-in: 1s; --anim-ex: 0.1s;">
                    <p>Belum Punya Akun? <a href="#" id="linkDaftar">Buat Akun.</a></p>
                </div>
            </form>
        </div>
        <div class="quotes">
            <h1 class="animasi" style="--anim-in: 0.1s; --anim-ex: 1s;">Selamat Datang Kembali!</h1>
            <p class="animasi" style="--anim-in: 0.3s; --anim-ex: 0.8s;">Masuk untuk mengakses semua fitur dan penawaran spesial untuk Anda.</p>
        </div>
    </div>
    <div class="card-regis">
        <div class="quotes">
             </div>
        <div class="form">
            <h2 class="animasi" style="--anim-in: 0.2s; --anim-ex: 0.9s;">DAFTAR</h2>
            <div id="regis-message" class="message-box"></div> <form id="formRegistrasi">
                <div class="input-box animasi" style="--anim-in: 0.4s; --anim-ex: 0.7s;">
                    <input type="text" id="regis-user" required>
                    <label for="regis-user">User Name</label>
                </div>
                <div class="input-box animasi" style="--anim-in: 0.6s; --anim-ex: 0.5s;">
                    <input type="email" id="regis-email" required>
                    <label for="regis-email">Email Address</label>
                </div>
                <div class="input-box animasi" style="--anim-in: 0.8s; --anim-ex: 0.3s;">
                    <input type="password" id="regis-pass" required minlength="6">
                    <label for="regis-pass">Password</label>
                </div>
                <div class="tombol animasi" style="--anim-in: 1s; --anim-ex: 0.1s;">
                    <button type="submit" id="regis-button">SUBMIT</button>
                </div>
                <div class="link-switch animasi" style="--anim-in: 1.2s; --anim-ex: 0.1s;">
                    <p>Sudah Punya Akun? <a href="#" id="linkLogin">Login.</a></p>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

<script>
    // Konfigurasi Firebase Anda
    const firebaseConfig = {
        apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210",
        authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
        projectId: "asdarstoredigitalll-d89c4",
    };

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); 
    const dbFS = firebase.firestore();
    const functions = firebase.functions(); // [BARU] Inisialisasi Functions

    // ==========================================================
    // KODE PENCATAT OTOMATIS (Tetap sama, tapi sekarang akan bekerja karena perbaikan Rules)
    // ==========================================================
    auth.onAuthStateChanged(user => {
        if (user) {
            const userRef = dbFS.collection('users').doc(user.uid);
            userRef.get().then(doc => {
                const now = firebase.firestore.FieldValue.serverTimestamp();
                if (!doc.exists) {
                    userRef.set({
                        email: user.email, uid: user.uid,
                        createdAt: now, lastLogin: now
                    }).catch(error => console.error("Gagal mencatat pengguna baru:", error));
                } else {
                    userRef.update({ lastLogin: now }).catch(error => console.error("Gagal memperbarui waktu login:", error));
                }
            });
        }
    });

    // Logika UI (Tampilan)
    const boxPembungkus = document.getElementById('Box-Pembungkus');
    const linkDaftar = document.getElementById('linkDaftar');
    const linkLogin = document.getElementById('linkLogin');
    linkDaftar.addEventListener('click', (e) => { e.preventDefault(); boxPembungkus.classList.add('active'); });
    linkLogin.addEventListener('click', (e) => { e.preventDefault(); boxPembungkus.classList.remove('active'); });

    // ==========================================================
    // [DIUBAH] Logika Form Registrasi dengan reCAPTCHA
    // ==========================================================
    const formRegistrasi = document.getElementById('formRegistrasi');
    const regisButton = document.getElementById('regis-button');
    const regisMessage = document.getElementById('regis-message');

    formRegistrasi.addEventListener('submit', (event) => {
        event.preventDefault();

        regisButton.disabled = true;
        regisButton.innerHTML = '<div class="spinner"></div><span>MEMPROSES...</span>';
        regisMessage.style.display = 'none';

        const email = document.getElementById('regis-email').value;
        const password = document.getElementById('regis-pass').value;

        grecaptcha.ready(function() {
            // PENTING: Ganti juga dengan Site Key Anda di sini
            grecaptcha.execute('6LfRVKErAAAAAGuz-J8R_GL5SolaAqASG2FWARGk', {action: 'register'}).then(function(token) {
                
                const registerUser = functions.httpsCallable('registerUser');
                registerUser({ email: email, password: password, token: token })
                    .then(result => {
                        regisMessage.textContent = 'Pendaftaran berhasil! Anda akan dipindahkan ke halaman login.';
                        regisMessage.className = 'message-box success';
                        regisMessage.style.display = 'block';
                        formRegistrasi.reset();
                        setTimeout(() => { linkLogin.click(); }, 2000); // Pindah ke login setelah 2 detik
                    })
                    .catch(error => {
                        regisMessage.textContent = 'Pendaftaran gagal: ' + error.message;
                        regisMessage.className = 'message-box error';
                        regisMessage.style.display = 'block';
                    })
                    .finally(() => {
                        regisButton.disabled = false;
                        regisButton.innerHTML = 'SUBMIT';
                    });
            });
        });
    });

    // ==========================================================
    // Logika Form Login (Sedikit dimodifikasi untuk pesan notifikasi)
    // ==========================================================
    const formLogin = document.getElementById('formLogin');
    const loginMessage = document.getElementById('login-message');

    formLogin.addEventListener('submit', (event) => {
        event.preventDefault();
        
        loginMessage.style.display = 'none';
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-pass').value;

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                loginMessage.textContent = 'Login berhasil! Mengalihkan...';
                loginMessage.className = 'message-box success';
                loginMessage.style.display = 'block';
                setTimeout(() => {
                     window.location.href = 'https://asdarcell.github.io/Asdarstoredigital/';
                }, 1000);
            })
            .catch((error) => {
                 let pesanErrorIndonesia;
                 switch (error.code) {
                    case 'auth/user-not-found': case 'auth/invalid-credential':
                         pesanErrorIndonesia = 'Email atau password yang Anda masukkan salah.'; break;
                    case 'auth/wrong-password':
                         pesanErrorIndonesia = 'Password yang Anda masukkan salah.'; break;
                    default:
                         pesanErrorIndonesia = 'Login gagal. Silakan coba lagi.';
                 }
                 loginMessage.textContent = pesanErrorIndonesia;
                 loginMessage.className = 'message-box error';
                 loginMessage.style.display = 'block';
            });
    });
</script>

</body>
</html>
