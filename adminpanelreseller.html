<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin - Asdar Store Digital</title>
  <link rel="icon" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; color: #333; }
    .container-fluid { max-width: 1200px; }
    .sidebar { background: #fff; padding: 20px; min-height: 100vh; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    .sidebar .nav-link { color: #555; font-weight: 600; margin-bottom: 10px; }
    .sidebar .nav-link.active { color: #3498db; background: #e9f5ff; border-radius: 8px; }
    .main-content { padding: 30px; }
    .card { border: none; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    .card-header { background: #3498db; color: white; font-weight: bold; border-radius: 15px 15px 0 0; }
    .status-badge { padding: 5px 10px; border-radius: 50px; font-weight: bold; }
    .status-pending { background-color: #ffc107; color: #333; }
    .status-selesai { background-color: #28a745; color: white; }
    .status-gagal { background-color: #dc3545; color: white; }
    .table-responsive { margin-top: 15px; }
    .table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .table th, .table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    .table th { background-color: #f8f9fa; font-weight: 600; color: #6c757d; }
    table img { max-height: 50px; cursor: pointer; }
    .photo-modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto;
        background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center;
    }
    .photo-modal img { max-width: 90%; max-height: 90%; }
    .photo-modal .close {
        position: absolute; top: 20px; right: 35px;
        color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s;
    }
    .photo-modal .close:hover, .photo-modal .close:focus { color: #bbb; text-decoration: none; cursor: pointer; }
    .form-manage { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .form-manage { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar">
            <div class="sidebar-sticky">
                <h5 class="my-3 text-center">Dashboard Admin</h5>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" href="#pesanan"><i class="fas fa-clipboard-list me-2"></i>Pesanan</a></li>
                    <li class="nav-item"><a class="nav-link" href="#kelola-reseller"><i class="fas fa-users-cog me-2"></i>Kelola Reseller</a></li>
                    <li class="nav-item"><a class="nav-link" href="#manajemen-saldo"><i class="fas fa-wallet me-2"></i>Manajemen Saldo</a></li>
                    <li class="nav-item"><a class="nav-link" href="#manajemen-produk"><i class="fas fa-box me-2"></i>Manajemen Produk</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
            </div>
        </nav>

        <main role="main" class="col-md-10 ml-sm-auto col-lg-10 px-4 main-content">
            <div id="pesanan" class="my-5">
                <div class="card">
                    <div class="card-header">Manajemen Pesanan</div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Reseller</th>
                                    <th>Produk</th>
                                    <th>Waktu</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                    <th>Bukti</th>
                                </tr>
                            </thead>
                            <tbody id="pesananTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="kelola-reseller" class="my-5" style="display: none;">
                <div class="card">
                    <div class="card-header">Kelola Reseller</div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Nomor WA</th>
                                    <th>Saldo</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="resellerTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="manajemen-saldo" class="my-5" style="display: none;">
                <div class="card">
                    <div class="card-header">Manajemen Saldo Reseller</div>
                    <div class="card-body">
                        <div class="form-manage">
                            <div>
                                <label for="waReseller">Nomor WhatsApp Reseller</label>
                                <input class="form-control" type="tel" id="waReseller" placeholder="Cth: 6281234567890" pattern="^62[0-9]{8,15}$" required>
                            </div>
                            <div>
                                <label for="jumlahSaldo">Jumlah Saldo (Rp)</label>
                                <input class="form-control" type="number" id="jumlahSaldo" placeholder="Jumlah" required>
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-success" id="tambahSaldoBtn">Tambah Saldo</button>
                            <button type="button" class="btn btn-danger" id="kurangiSaldoBtn">Kurangi Saldo</button>
                        </div>
                        <div class="table-responsive mt-4">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nomor WA</th>
                                        <th>Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelResellerSaldo"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="manajemen-produk" class="my-5" style="display: none;">
                <div class="card">
                    <div class="card-header">Manajemen Produk Reseller</div>
                    <div class="card-body">
                        <form id="formProduk">
                            <div class="form-manage">
                                <div>
                                    <label for="kategoriProduk">Kategori Produk</label>
                                    <select class="form-control" id="kategoriProduk" required></select>
                                </div>
                                <div>
                                    <label for="namaProduk">Nama Produk</label>
                                    <select class="form-control" id="namaProduk" required></select>
                                </div>
                                <div>
                                    <label for="hargaProduk">Harga Umum (Rp)</label>
                                    <input class="form-control" type="number" id="hargaProduk" placeholder="Harga Umum" disabled>
                                </div>
                                <div>
                                    <label for="hargaResellerProduk">Harga Reseller (Rp)</label>
                                    <input class="form-control" type="number" id="hargaResellerProduk" placeholder="Harga Reseller" required>
                                </div>
                                <div>
                                    <label for="stokProduk">Stok</label>
                                    <input class="form-control" type="number" id="stokProduk" placeholder="Stok" required>
                                </div>
                            </div>
                            <button type="button" id="updateProdukBtn" class="btn btn-primary mt-3">Perbarui Produk</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="photoModal" class="photo-modal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalPhoto">
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // GANTI dengan API Key Anda
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com", // GANTI dengan Auth Domain Anda
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com", // GANTI dengan Database URL Anda
      projectId: "asdarstoredigitalll-d89c4", // GANTI dengan Project ID Anda
      storageBucket: "asdarstoredigitalll-d89c4.appspot.com" // GANTI dengan Storage Bucket Anda
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;
    const normalizePhone = (num) => {
        let n = String(num).trim().replace(/[^0-9]/g, '');
        if (n.startsWith('0')) return '62' + n.slice(1);
        if (n.startsWith('62')) return n;
        return num;
    };
    
    const pesananTableBody = document.getElementById('pesananTableBody');
    const resellerTableBody = document.getElementById('resellerTableBody');
    const tabelResellerSaldo = document.getElementById('tabelResellerSaldo');

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "loginadmin.html";
        } else {
            loadData();
        }
    });

    const loadData = () => {
        loadPesanan();
        loadResellers(); 
        loadResellerSaldoData(); 
        loadProductManagementData(); 
    };

    const loadPesanan = () => {
        db.ref('pesanan').on('value', (snapshot) => {
            const pesananData = snapshot.val() || {};
            pesananTableBody.innerHTML = '';
            const pesananArray = Object.values(pesananData).sort((a,b) => new Date(b.waktu) - new Date(a.waktu));
            pesananArray.forEach(pesanan => {
                const row = document.createElement('tr');
                let statusClass = '';
                if (pesanan.status === 'Menunggu diproses') statusClass = 'status-pending';
                if (pesanan.status === 'Selesai') statusClass = 'status-selesai';
                if (pesanan.status === 'Gagal') statusClass = 'status-gagal';
                
                row.innerHTML = `
                    <td>${pesanan.id}</td>
                    <td>${pesanan.nama}</td>
                    <td>${pesanan.produk}</td>
                    <td>${new Date(pesanan.waktu).toLocaleString('id-ID')}</td>
                    <td><span class="status-badge ${statusClass}">${pesanan.status}</span></td>
                    <td>
                        <input type="file" id="file-${pesanan.id}" style="display:none;" onchange="uploadBukti(this, '${pesanan.id}')">
                        <button class="btn btn-sm btn-success" onclick="document.getElementById('file-${pesanan.id}').click();" ${pesanan.status === 'Selesai' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> Selesaikan & Unggah Bukti
                        </button>
                    </td>
                    <td>
                        ${pesanan.bukti_url ? `<img src="${pesanan.bukti_url}" alt="Bukti" style="max-width: 80px; max-height: 80px;" onclick="showModal('${pesanan.bukti_url}')">` : 'Tidak ada'}
                    </td>
                `;
                pesananTableBody.appendChild(row);
            });
        });
    };

    const loadResellers = () => {
        db.ref('resellers').on('value', (snapshot) => {
            const resellerData = snapshot.val() || {};
            resellerTableBody.innerHTML = '';
            for (const key in resellerData) {
                const reseller = resellerData[key];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${key}</td>
                    <td>${formatRupiah(reseller.saldo || 0)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="hapusReseller('${key}')"><i class="fas fa-trash"></i> Hapus</button></td>
                `;
                resellerTableBody.appendChild(row);
            }
        });
    };
    
    window.hapusReseller = (wa) => {
        if (confirm(`Apakah Anda yakin ingin menghapus reseller dengan nomor WA ${wa}?`)) {
            db.ref('resellers/' + wa).remove()
            .then(() => alert(`Reseller ${wa} berhasil dihapus.`))
            .catch(error => alert("Gagal menghapus reseller: " + error.message));
        }
    }

    const uploadBukti = (input, orderId) => {
        const file = input.files[0];
        if (!file) return;
        const storageRef = storage.ref(`bukti_transfer/${orderId}`);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed', () => {}, (error) => {
            console.error("Gagal mengunggah bukti:", error);
            alert("Gagal mengunggah bukti.");
        }, () => {
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                db.ref('pesanan/' + orderId).update({ status: 'Selesai', bukti_url: downloadURL })
                .then(() => { alert("Pesanan berhasil diselesaikan dan bukti diunggah!"); })
                .catch(error => { console.error("Gagal memperbarui database:", error); alert("Gagal memperbarui status pesanan."); });
            });
        });
    };

    const showModal = (src) => {
        const modal = document.getElementById("photoModal");
        const modalImg = document.getElementById("modalPhoto");
        modal.style.display = "flex";
        modalImg.src = src;
    };

    const closeModal = () => { 
        document.getElementById("photoModal").style.display = "none";
    };

    // Navigasi
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.main-content > div').forEach(section => section.style.display = 'none');
            const targetId = this.getAttribute('href').substring(1);
            document.getElementById(targetId).style.display = 'block';
        });
    });
    
    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut().then(() => {
            window.location.href = 'loginadmin.html';
        });
    });

    function loadResellerSaldoData() {
        db.ref('resellers').on('value', (snapshot) => {
            const resellers = snapshot.val() || {};
            const html = Object.keys(resellers).map(wa => `
                <tr>
                    <td>${wa}</td>
                    <td>${formatRupiah(resellers[wa].saldo)}</td>
                </tr>
            `).join('');
            tabelResellerSaldo.innerHTML = html || '<tr><td colspan="2" style="text-align: center;">Belum ada data reseller.</td></tr>';
        });
    }

    async function updateResellerSaldo(action) {
        const waInput = document.getElementById('waReseller');
        const jumlahInput = document.getElementById('jumlahSaldo');
        const wa = normalizePhone(waInput.value);
        const jumlah = parseInt(jumlahInput.value);
        if (!wa || isNaN(jumlah) || jumlah <= 0) {
            alert('Harap masukkan nomor WhatsApp dan jumlah saldo yang valid.');
            return;
        }
        const konfirmasi = confirm(`Apakah Anda yakin ingin ${action === 'tambah' ? 'menambah' : 'mengurangi'} saldo sebesar ${formatRupiah(jumlah)} untuk reseller ${wa}?`);
        if (!konfirmasi) return;
        try {
            const resellerRef = db.ref('resellers/' + wa);
            const result = await resellerRef.transaction(currentData => {
                let currentSaldo = (currentData && currentData.saldo) || 0;
                if (action === 'tambah') {
                    currentSaldo += jumlah;
                } else if (action === 'kurang') {
                    if (currentSaldo < jumlah) {
                        alert('Saldo tidak cukup untuk dikurangi!');
                        return;
                    }
                    currentSaldo -= jumlah;
                }
                if (!currentData) currentData = {};
                currentData.saldo = currentSaldo;
                return currentData;
            });
            if (result.committed) {
                alert('Saldo reseller berhasil diperbarui!');
                waInput.value = '';
                jumlahInput.value = '';
            } else {
                alert('Gagal memperbarui saldo.');
            }
        } catch (error) {
            console.error("Error memperbarui saldo:", error);
            alert('Terjadi kesalahan saat memperbarui saldo.');
        }
    }

    function loadProductManagementData() {
        db.ref('produk').once('value').then(snapshot => {
            const data = snapshot.val() || {};
            const kategoriSelect = document.getElementById('kategoriProduk');
            kategoriSelect.innerHTML = '<option value="">Pilih Kategori</option>';
            for (const kategori in data) {
                kategoriSelect.innerHTML += `<option value="${kategori}">${kategori}</option>`;
            }
        });
    }
    
    function handleProductCategoryChange() {
        const kategori = document.getElementById('kategoriProduk').value;
        const namaProdukSelect = document.getElementById('namaProduk');
        namaProdukSelect.innerHTML = '<option value="">Pilih Produk</option>';
        document.getElementById('hargaProduk').value = '';
        document.getElementById('hargaResellerProduk').value = '';
        document.getElementById('stokProduk').value = '';
        if (!kategori) return;
        db.ref(`produk/${kategori}`).once('value').then(snapshot => {
            const data = snapshot.val() || {};
            for (const produk in data) {
                namaProdukSelect.innerHTML += `<option value="${produk}">${produk}</option>`;
            }
        });
    }
    
    function handleProductNameChange() {
        const kategori = document.getElementById('kategoriProduk').value;
        const produk = document.getElementById('namaProduk').value;
        document.getElementById('hargaProduk').value = '';
        document.getElementById('hargaResellerProduk').value = '';
        document.getElementById('stokProduk').value = '';
        if (!kategori || !produk) return;
        db.ref(`produk/${kategori}/${produk}`).once('value').then(snapshot => {
            const data = snapshot.val() || {};
            document.getElementById('hargaProduk').value = data.harga || 0;
            document.getElementById('hargaResellerProduk').value = data.harga_reseller || 0;
            document.getElementById('stokProduk').value = data.stok || 0;
        });
    }
    
    async function updateProductData() {
        const kategori = document.getElementById('kategoriProduk').value;
        const produk = document.getElementById('namaProduk').value;
        const hargaReseller = parseInt(document.getElementById('hargaResellerProduk').value);
        const stok = parseInt(document.getElementById('stokProduk').value);
        if (!kategori || !produk || isNaN(hargaReseller) || isNaN(stok)) {
            alert('Harap lengkapi semua data produk dengan benar!');
            return;
        }
        if (!confirm(`Yakin ingin memperbarui harga reseller produk ${produk} menjadi ${formatRupiah(hargaReseller)} dan stok menjadi ${stok}?`)) {
            return;
        }
        try {
            await db.ref(`produk/${kategori}/${produk}`).update({
                harga_reseller: hargaReseller,
                stok: stok
            });
            alert('Data produk reseller berhasil diperbarui!');
        } catch (error) {
            console.error("Gagal memperbarui produk:", error);
            alert('Gagal memperbarui data produk.');
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('kategoriProduk').addEventListener('change', handleProductCategoryChange);
        document.getElementById('namaProduk').addEventListener('change', handleProductNameChange);
        document.getElementById('updateProdukBtn').addEventListener('click', updateProductData);
        document.getElementById('tambahSaldoBtn').addEventListener('click', () => updateResellerSaldo('tambah'));
        document.getElementById('kurangiSaldoBtn').addEventListener('click', () => updateResellerSaldo('kurang'));
    });
</script>
</body>
</html>
