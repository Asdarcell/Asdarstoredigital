<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Pesanan Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        /* Gaya dasar dari admin.html */
        :root {
            --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
            --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
            --success: #28a745; --danger: #e74c3c;
            --info: #17a2b8; /* Tambah warna info */
            --warning: #ffc107; /* Tambah warna warning */
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
            --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease; margin: 0; line-height: 1.6;
        }
        .container { max-width: 800px; padding: 20px; }
        .section {
            background: var(--card); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow); margin-bottom: 20px;
        }
        h1, h2, h4 { color: var(--primary); }
        .btn-primary { background-color: var(--primary); border-color: var(--primary); }
        .btn-success { background-color: var(--success); border-color: var(--success); }
        .btn-danger { background-color: var(--danger); border-color: var(--danger); }
        .btn-info { background-color: var(--info); border-color: var(--info); }
        .btn-warning { background-color: var(--warning); border-color: var(--warning); }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8em; }
        .status-pending, .status-menunggu-verifikasi, .status-pending-upload { background-color: #ffc107; color: #343a40; }
        .status-disetujui, .status-selesai { background-color: #28a745; color: white; }
        .status-ditolak, .status-dibatalkan { background-color: #dc3545; color: white; }
        .status-belum-bayar, .status-diproses, .status-notifikasi-terkirim-&-diproses { background-color: #007bff; color: white; }
        .status-gagal { background-color: #dc3545; color: white; } /* Tambahan untuk status gagal */

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
        }
        .detail-item:last-child { border-bottom: none; }
        .detail-item strong { color: var(--primary); }
        .detail-item span { text-align: right; }
        .action-buttons button { margin-right: 10px; margin-bottom: 10px;}
        #pesanError {
            color: var(--danger);
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header class="text-center mb-4">
            <h1 class="mb-3">Detail Pesanan</h1>
            <button class="btn btn-secondary" onclick="window.history.back()">Kembali ke Dashboard</button>
        </header>

        <div id="order-detail-section" class="section">
            <p class="text-center text-muted" id="loading-message">Memuat detail pesanan...</p>
            <div id="order-details-content" style="display: none;">
                <div class="detail-item"><strong>ID Pesanan:</strong> <span id="detail-id"></span></div>
                <div class="detail-item"><strong>Tipe Pesanan:</strong> <span id="detail-type"></span></div>
                <div class="detail-item"><strong>Waktu Pesanan:</strong> <span id="detail-waktu"></span></div>
                <div class="detail-item"><strong>Pelanggan:</strong> <span id="detail-pelanggan"></span></div>
                <div class="detail-item"><strong>Email Pelanggan:</strong> <span id="detail-email"></span></div>
                <div class="detail-item"><strong>No WhatsApp Aktif:</strong> <span id="detail-whatsapp"></span></div>
                <div class="detail-item"><strong>Produk:</strong> <span id="detail-produk"></span></div>
                <div class="detail-item"><strong>Service:</strong> <span id="detail-service"></span></div>
                <div class="detail-item"><strong>Target/ID Game:</strong> <span id="detail-target"></span></div>
                <div class="detail-item"><strong>Harga:</strong> <span id="detail-harga"></span></div>
                <div class="detail-item"><strong>Status:</strong> <span id="detail-status" class="status-badge"></span></div>
                <div class="detail-item"><strong>Metode Pembayaran:</strong> <span id="detail-pembayaran"></span></div>
                <div class="detail-item"><strong>Bukti Transfer:</strong> <span id="detail-bukti-transfer"></span></div>
                <div class="detail-item"><strong>Catatan:</strong> <span id="detail-catatan"></span></div>
                <div id="detail-tambahan-reseller" style="display: none;">
                    <hr>
                    <div class="detail-item"><strong>Harga Beli Reseller:</strong> <span id="detail-harga-beli-reseller"></span></div>
                    <div class="detail-item"><strong>Profit:</strong> <span id="detail-profit"></span></div>
                </div>

                <hr class="my-4">

                <h4>Aksi Admin</h4>
                <div class="action-buttons">
                    <button id="btnNotifWhatsApp" class="btn btn-success"><i class="fab fa-whatsapp"></i> Kirim Notif WA & Set Proses</button>
                    <button id="btnSetSelesai" class="btn btn-primary"><i class="fas fa-check-circle"></i> Tandai Selesai</button>
                    <button id="btnSetGagal" class="btn btn-warning"><i class="fas fa-times-circle"></i> Tandai Gagal</button>
                    <button id="btnSetBatal" class="btn btn-danger"><i class="fas fa-ban"></i> Batalkan Pesanan</button>
                    <button id="btnSetMenungguVerifikasi" class="btn btn-info"><i class="fas fa-sync-alt"></i> Set Menunggu Verifikasi</button>
                    </div>
                <div id="pesanError"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // ==========================================================
        //  KONFIGURASI FIREBASE DAN FUNGSI UMUM (Sama seperti admin.html)
        // ==========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // Ganti dengan API Key Firebase Anda
          authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
          databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
          projectId: "asdarstoredigitalll-d89c4",
          storageBucket: "asdarstoredigitalll-d89c4.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFS = firebase.firestore();
        const dbRT = firebase.database();
        const storage = firebase.storage();

        // Redirect jika belum login (opsional, tergantung alur aplikasi Anda)
        auth.onAuthStateChanged(user => { if (!user) { console.warn("Belum login, mungkin dialihkan ke loginadmin.html"); /* window.location.href = "loginadmin.html"; */ } });

        // Fungsi format Rupiah
        const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

        // Fungsi menampilkan Toast Notifikasi (jika Anda ingin toast di halaman detail juga)
        // Untuk saat ini, kita akan pakai showErrorMessage sederhana
        function showErrorMessage(message) {
            const pesanErrorDiv = document.getElementById('pesanError');
            if (pesanErrorDiv) {
                pesanErrorDiv.textContent = message;
                pesanErrorDiv.style.display = 'block';
                setTimeout(() => { pesanErrorDiv.style.display = 'none'; }, 5000); // Sembunyikan setelah 5 detik
            }
        }
        function clearErrorMessage() {
            const pesanErrorDiv = document.getElementById('pesanError');
            if (pesanErrorDiv) {
                pesanErrorDiv.textContent = '';
                pesanErrorDiv.style.display = 'none';
            }
        }

        // ==========================================================
        //  LOGIKA HALAMAN DETAIL PESANAN
        // ==========================================================
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            const orderType = urlParams.get('type'); // 'umum' atau 'reseller'

            if (!orderId || !orderType) {
                showErrorMessage("ID Pesanan atau Tipe Pesanan tidak ditemukan di URL.");
                document.getElementById('loading-message').textContent = "ID Pesanan atau Tipe Pesanan tidak valid.";
                return;
            }

            loadOrderDetail(orderId, orderType);

            // Event Listeners untuk tombol aksi
            document.getElementById('btnNotifWhatsApp').addEventListener('click', () => sendWhatsAppNotification(orderId, orderType));
            document.getElementById('btnSetSelesai').addEventListener('click', () => updateOrderStatus(orderId, orderType, 'Selesai'));
            document.getElementById('btnSetGagal').addEventListener('click', () => updateOrderStatus(orderId, orderType, 'Gagal'));
            document.getElementById('btnSetBatal').addEventListener('click', () => updateOrderStatus(orderId, orderType, 'Dibatalkan'));
            document.getElementById('btnSetMenungguVerifikasi').addEventListener('click', () => updateOrderStatus(orderId, orderType, 'Menunggu Verifikasi'));
        });

        let currentOrderData = null; // Variabel global untuk menyimpan data pesanan

        async function loadOrderDetail(orderId, orderType) {
            clearErrorMessage();
            const loadingMessage = document.getElementById('loading-message');
            const orderDetailsContent = document.getElementById('order-details-content');
            loadingMessage.style.display = 'block';
            orderDetailsContent.style.display = 'none';

            const collectionName = orderType === 'reseller' ? 'pesananReseller' : 'pesananUmum';

            try {
                const doc = await dbFS.collection(collectionName).doc(orderId).get();
                if (!doc.exists) {
                    throw new Error("Pesanan tidak ditemukan.");
                }

                currentOrderData = { id: doc.id, type: orderType, ...doc.data() };
                displayOrderDetail(currentOrderData);

                loadingMessage.style.display = 'none';
                orderDetailsContent.style.display = 'block';
            } catch (error) {
                console.error("Error loading order detail:", error);
                loadingMessage.textContent = `Gagal memuat detail pesanan: ${error.message}`;
                showErrorMessage(`Gagal memuat detail pesanan: ${error.message}`);
            }
        }

        function displayOrderDetail(order) {
            document.getElementById('detail-id').textContent = order.id;
            document.getElementById('detail-type').textContent = order.type === 'reseller' ? 'Reseller' : 'Umum';
            // Konversi Firebase Timestamp ke format waktu lokal yang mudah dibaca
            const waktuPesanan = order.waktu && order.waktu.toDate ? order.waktu.toDate().toLocaleString('id-ID') : 'N/A';
            document.getElementById('detail-waktu').textContent = waktuPesanan;

            // Nama Pelanggan (sesuaikan dengan field di Firestore Anda)
            const customerName = order.type === 'reseller' ? (order.nama_reseller || order.email_reseller || order.nama || 'N/A') : (order.nama_pelanggan || order.nama || 'N/A');
            document.getElementById('detail-pelanggan').textContent = customerName;

            // Email Pelanggan (sesuaikan dengan field di Firestore Anda)
            const customerEmail = order.type === 'reseller' ? (order.email_reseller || 'N/A') : (order.email_pelanggan || 'N/A');
            document.getElementById('detail-email').textContent = customerEmail;

            // No WhatsApp Aktif (ini yang paling penting!)
            // Ambil dari order.whatsapp_aktif atau order.no_whatsapp, sesuaikan dengan nama field Anda
            const whatsappNumber = order.whatsapp_aktif || order.no_whatsapp || order.nomor_hp || 'N/A';
            document.getElementById('detail-whatsapp').textContent = whatsappNumber;

            document.getElementById('detail-produk').textContent = order.produk || 'N/A';
            document.getElementById('detail-service').textContent = order.service || 'N/A';
            document.getElementById('detail-target').textContent = order.target || order.id_game || 'N/A'; // Bisa ID Game atau Nomor HP
            
            const displayPrice = order.type === 'reseller' ? (order.harga_beli || order.harga_final) : order.harga_final;
            document.getElementById('detail-harga').textContent = formatRupiah(displayPrice);

            // Status Badge
            const statusText = order.status || 'N/A';
            const statusClass = `status-${statusText.toLowerCase().replace(/ /g, '-')}`;
            const statusSpan = document.getElementById('detail-status');
            statusSpan.textContent = statusText;
            statusSpan.className = `status-badge ${statusClass}`; // Pastikan kelas status yang benar diterapkan

            document.getElementById('detail-pembayaran').textContent = order.metode_pembayaran || 'N/A';
            
            const buktiTransferSpan = document.getElementById('detail-bukti-transfer');
            if (order.bukti_transfer_url) {
                buktiTransferSpan.innerHTML = `<a href="${order.bukti_transfer_url}" target="_blank" class="btn btn-sm btn-info">Lihat Bukti</a>`;
            } else {
                buktiTransferSpan.textContent = 'Tidak ada';
            }

            document.getElementById('detail-catatan').textContent = order.catatan || 'Tidak ada';

            // Tampilkan detail tambahan untuk reseller jika tipe pesanan adalah reseller
            const detailTambahanReseller = document.getElementById('detail-tambahan-reseller');
            if (order.type === 'reseller') {
                detailTambahanReseller.style.display = 'block';
                document.getElementById('detail-harga-beli-reseller').textContent = formatRupiah(order.harga_beli);
                const profit = (order.harga_final || 0) - (order.harga_beli || 0); // Asumsi harga_final adalah harga jual ke buyer
                document.getElementById('detail-profit').textContent = formatRupiah(profit);
            } else {
                detailTambahanReseller.style.display = 'none';
            }
        }

        // ==========================================================
        //  FUNGSI KIRIM NOTIFIKASI WHATSAPP & UPDATE STATUS
        // ==========================================================
        // URL dasar untuk cek status pesanan (GANTI DENGAN URL ASLI WEBSITE ANDA!)
        const BASE_STATUS_CHECK_URL = 'https://yourwebsite.com/cek-status?id='; // HARUS DIGANTI!

        async function sendWhatsAppNotification(orderId, orderType) {
            clearErrorMessage();
            if (!currentOrderData) {
                showErrorMessage('Data pesanan belum dimuat. Mohon tunggu.');
                return;
            }

            // Normalisasi nomor WhatsApp
            let nomorWhatsApp = currentOrderData.whatsapp_aktif || currentOrderData.no_whatsapp || currentOrderData.nomor_hp;
            if (!nomorWhatsApp) {
                showErrorMessage('Nomor WhatsApp pelanggan tidak ditemukan.');
                return;
            }
            nomorWhatsApp = nomorWhatsApp.replace(/[^0-9]/g, '');
            if (nomorWhatsApp.startsWith('0')) {
                nomorWhatsApp = '62' + nomorWhatsApp.substring(1);
            } else if (!nomorWhatsApp.startsWith('62') && nomorWhatsApp.length > 5) {
                nomorWhatsApp = '62' + nomorWhatsApp;
            }
            if (nomorWhatsApp.length < 9) {
                showErrorMessage('Nomor WhatsApp tidak valid setelah diformat.');
                return;
            }

            // Dapatkan detail yang diperlukan untuk pesan
            const target = currentOrderData.target || currentOrderData.id_game || 'N/A';
            const service = currentOrderData.service || currentOrderData.produk || 'N/A'; // Jika tidak ada field service, pakai produk
            const harga = formatRupiah(currentOrderData.harga_final || currentOrderData.harga_beli || 0);
            const linkCekStatus = BASE_STATUS_CHECK_URL + currentOrderData.id;

            // Template pesan WhatsApp
            let pesanWhatsapp = `Halo kak! Admin Jagoanssh âœ¨\n\n`;
            pesanWhatsapp += `Pembelian Berhasil!\n`;
            pesanWhatsapp += `Target: ${target}\n`;
            pesanWhatsapp += `Service: ${service}\n`;
            pesanWhatsapp += `Harga: ${harga}\n`;
            pesanWhatsapp += `Status: Diproses\n\n`; // Set status awal di pesan sebagai "Diproses"
            pesanWhatsapp += `Terimakasih sudah menggunakan layanan di Jagoanssh\n\n`;
            pesanWhatsapp += `Silahkan cek status pesanan Anda secara otomatis melalui link berikut:\n`;
            pesanWhatsapp += `${linkCekStatus}`;

            const pesanTerencode = encodeURIComponent(pesanWhatsapp);
            const whatsappLink = `https://wa.me/${nomorWhatsApp}?text=${pesanTerencode}`;

            try {
                window.open(whatsappLink, '_blank');
                alert('Tautan WhatsApp berhasil dibuka. Silakan kirim pesan ke pembeli. Status pesanan akan diubah menjadi "Notifikasi Terkirim & Diproses".');

                // Setelah membuka link WA, langsung update status di database
                await updateOrderStatus(orderId, orderType, 'Notifikasi Terkirim & Diproses', true); // true untuk tanpa konfirmasi
            } catch (e) {
                console.error('Gagal membuka tautan WhatsApp:', e);
                showErrorMessage('Gagal membuka tautan WhatsApp. Pastikan browser Anda mengizinkan pop-up dan aplikasi WhatsApp terinstal.');
            }
        }

        async function updateOrderStatus(orderId, orderType, newStatus, skipConfirm = false) {
            clearErrorMessage();
            if (!skipConfirm && !confirm(`Yakin ingin mengubah status pesanan ini menjadi "${newStatus}"?`)) {
                return;
            }

            const collectionName = orderType === 'reseller' ? 'pesananReseller' : 'pesananUmum';
            const statusButton = document.querySelector(`#btnSet${newStatus.replace(/ /g, '')}, #btnNotifWhatsApp`); // Dapatkan tombol yang relevan
            if (statusButton) setButtonLoading(statusButton, true);

            try {
                await dbFS.collection(collectionName).doc(orderId).update({
                    status: newStatus,
                    last_updated: firebase.firestore.FieldValue.serverTimestamp() // Catat waktu update
                });
                showErrorMessage(`Status pesanan berhasil diubah menjadi "${newStatus}"!`, 'success');
                // Perbarui tampilan di UI
                document.getElementById('detail-status').textContent = newStatus;
                const statusClass = `status-${newStatus.toLowerCase().replace(/ /g, '-')}`;
                document.getElementById('detail-status').className = `status-badge ${statusClass}`;

                // Jika statusnya "Selesai", dan ini pesanan reseller, mungkin tambahkan profit ke saldo admin? (Opsional)
                // Atau, jika ini pesanan reseller, pastikan saldo reseller sudah dipotong sebelumnya
                if (newStatus === 'Selesai' && orderType === 'reseller' && currentOrderData) {
                    // Logika untuk menambah profit ke admin (jika ada) atau penyesuaian lain
                    // Pastikan logikanya aman dan tidak menggandakan keuntungan
                }

            } catch (error) {
                console.error("Error updating order status:", error);
                showErrorMessage(`Gagal mengubah status pesanan: ${error.message}`);
            } finally {
                if (statusButton) setButtonLoading(statusButton, false);
            }
        }
    </script>
</body>
</html>
