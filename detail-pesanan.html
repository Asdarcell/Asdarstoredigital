<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Pesanan</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db;
            --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05);
            --success: #28a745; --danger: #e74c3c;
            --info: #0c5460; --warning: #856404;
        }
        [data-theme="dark"] {
            --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c;
            --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15);
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); transition: background-color 0.3s ease, color 0.3s ease; }
        .container { margin-top: 30px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); }
        .list-group-item { background: transparent; border-color: var(--border); color: var(--text); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .status-pending, .status-menunggu-verifikasi { background-color: #ffc107; color: black; }
        .status-diproses { background-color: #3498db; color: white; }
        .status-selesai { background-color: #28a745; color: white; }
        .status-dibatalkan, .status-ditolak { background-color: #e74c3c; color: white; }
        .status-belum-bayar { background-color: #007bff; color: white; }
        .img-proof { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; }
        .btn-status { margin-right: 10px; }
        .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group .btn { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .wa-active-toggle { cursor: pointer; }
        .wa-active-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        .wa-active-dot.active { background-color: #28a745; } /* Green */
        .wa-active-dot.inactive { background-color: #6c757d; } /* Gray */
    </style>
</head>
<body data-theme="dark">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Kelola Pesanan</h2>
        <a href="admin.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Kembali</a>
    </div>

    <div class="row" id="order-details-row">
        <div class="col-md-12 text-center" id="loading-message">
            <p>Memuat detail pesanan...</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
    // Konfigurasi Firebase Anda (GANTI DENGAN DATA ASLI PROYEK ANDA)
    const firebaseConfig = {
        apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // GANTI INI
        authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com", // GANTI INI
        databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com", // GANTI INI
        projectId: "asdarstoredigitalll-d89c4", // GANTI INI
        storageBucket: "asdarstoredigitalll-d89c4.appspot.com", // GANTI INI
        appId: "1:842211995874:web:e000000000000000000000" // GANTI INI (jika ada)
    };
    firebase.initializeApp(firebaseConfig);
    const dbFS = firebase.firestore();
    const dbRT = firebase.database(); 
    const storage = firebase.storage();

    const orderDetailsRow = document.getElementById('order-details-row');
    const loadingMessage = document.getElementById('loading-message');
    
    // Simpan data pesanan saat dimuat
    let currentOrderDocRef; // Reference ke doc di Firestore atau path di RTDB
    let currentOrderData = {};
    let orderCollectionType; // 'pesananUmum', 'pesananReseller', atau 'pesananRTDB'

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    // Fungsi untuk membersihkan dan memformat nomor telepon ke 62xxxxxxxx
    function cleanPhoneNumber(phone) {
        if (!phone) return '';
        let cleaned = phone.toString().replace(/\D/g, '');
        if (cleaned.startsWith('08')) {
            cleaned = '62' + cleaned.substring(1);
        }
        if (cleaned.length > 0 && !cleaned.startsWith('62')) { // Hanya tambahkan 62 jika belum ada dan ada angka
            cleaned = '62' + cleaned;
        }
        return cleaned;
    }

    // Fungsi utama untuk memuat detail pesanan berdasarkan ID dari URL
    async function loadOrderDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        const collection = urlParams.get('collection'); 

        if (!orderId || !collection) {
            loadingMessage.innerHTML = '<h2>ID Pesanan atau Tipe Koleksi tidak ditemukan.</h2>';
            return;
        }

        orderCollectionType = collection;

        try {
            if (collection === 'pesananRTDB') {
                currentOrderDocRef = dbRT.ref(`pesanan/${orderId}`);
                const snapshot = await currentOrderDocRef.once('value');
                if (snapshot.exists()) {
                    currentOrderData = snapshot.val();
                    currentOrderData.id = orderId; 
                    loadingMessage.style.display = 'none';
                    renderOrderDetails(orderId, currentOrderData);
                } else {
                    loadingMessage.innerHTML = '<h2>Pesanan tidak ditemukan di Realtime Database.</h2>';
                }
            } else { 
                currentOrderDocRef = dbFS.collection(collection).doc(orderId);
                const doc = await currentOrderDocRef.get();
                if (doc.exists) {
                    currentOrderData = doc.data();
                    currentOrderData.id = orderId; 
                    loadingMessage.style.display = 'none';
                    renderOrderDetails(orderId, currentOrderData);
                } else {
                    loadingMessage.innerHTML = '<h2>Pesanan tidak ditemukan di Firestore.</h2>';
                }
            }
        } catch (error) {
            console.error("Error loading order details:", error);
            loadingMessage.innerHTML = '<h2>Terjadi kesalahan saat memuat data.</h2>';
        }
    }

    // Fungsi untuk menampilkan detail pesanan
    function renderOrderDetails(orderId, data) {
        // Logika fleksibel untuk mendapatkan data dari berbagai nama field
        const customerName = data.customer_name || data.nama_pelanggan || data.nama_reseller || 'N/A';
        const customerPhoneRaw = data.customer_phone || data.nomor_hp || data.nomor || 'N/A';
        const customerPhoneCleaned = cleanPhoneNumber(customerPhoneRaw);
        const gameId = data.game_id || data.id_game || data.id || data.username_game || 'N/A';
        const productName = data.produk || data.product_name || 'N/A';
        const finalPrice = formatRupiah(data.harga_final || data.harga_beli || data.price);
        const orderStatus = data.status || 'Belum Bayar';
        const orderTime = data.waktu ? (orderCollectionType !== 'pesananRTDB' ? new Date(data.waktu.toDate()) : new Date(data.waktu)) : 'N/A'; 

        const waActive = data.wa_aktif === true;
        const waActiveText = waActive ? 'Aktif' : 'Belum Aktif';
        const waActiveDotClass = waActive ? 'active' : 'inactive';

        const customerInfo = data.nama_reseller ? `<strong>Reseller:</strong> ${data.nama_reseller}<br><strong>Pelanggan:</strong> ${customerName}` : `<strong>Pelanggan:</strong> ${customerName}`;
        let statusClass = `status-${orderStatus.toLowerCase().replace(/ /g, '-')}`;

        orderDetailsRow.innerHTML = `
            <div class="col-md-6 mb-4">
                <div class="card p-4 h-100">
                    <h4 class="card-title">Detail Pesanan</h4>
                    <hr>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>ID Pesanan:</strong> <code>${orderId}</code></li>
                        <li class="list-group-item">
                            <label for="editCustomerName" class="form-label"><strong>Nama Pelanggan:</strong></label>
                            <input type="text" class="form-control" id="editCustomerName" value="${customerName}" placeholder="Nama Pelanggan">
                        </li>
                        <li class="list-group-item">
                            <label for="editCustomerPhone" class="form-label"><strong>No. HP (WhatsApp):</strong></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="editCustomerPhone" value="${customerPhoneRaw}" placeholder="Nomor HP Pelanggan">
                                <a href="https://wa.me/${customerPhoneCleaned}" target="_blank" class="btn btn-success" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a>
                            </div>
                            <small class="text-muted mt-2">Nomor ini akan diformat otomatis ke 62xxxxxxxx saat disimpan.</small>
                            <div class="mt-2">
                                <span class="wa-active-dot ${waActiveDotClass}"></span>
                                <span class="wa-active-text">${waActiveText}</span>
                                <button class="btn btn-sm btn-link wa-active-toggle" data-current-status="${waActive}" onclick="toggleWaActive(this)"><i class="fas fa-edit"></i> Ubah</button>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <label for="editGameId" class="form-label"><strong>ID Game / Username:</strong></label>
                            <input type="text" class="form-control" id="editGameId" value="${gameId}" placeholder="ID Game / Username">
                        </li>
                        <li class="list-group-item"><strong>Produk:</strong> ${productName}</li>
                        <li class="list-group-item"><strong>Harga:</strong> ${finalPrice}</li>
                        <li class="list-group-item"><strong>Status:</strong> <span class="status-badge ${statusClass}">${orderStatus}</span></li>
                        <li class="list-group-item"><strong>Waktu Pesanan:</strong> ${orderTime !== 'N/A' ? orderTime.toLocaleString() : 'N/A'}</li>
                        <li class="list-group-item">
                            <label for="editAdminNotes" class="form-label"><strong>Catatan Admin:</strong></label>
                            <textarea class="form-control" id="editAdminNotes" rows="3" placeholder="Catatan internal admin">${data.catatan_admin || ''}</textarea>
                        </li>
                        <li class="list-group-item text-end">
                            <button class="btn btn-primary" onclick="saveEditedDetails()">Simpan Perubahan</button>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card p-4 h-100">
                    <h4 class="card-title">Aksi Admin</h4>
                    <hr>
                    <div class="mb-3">
                        <p class="mb-2"><strong>Ubah Status Pesanan:</strong></p>
                        <button class="btn btn-warning btn-sm btn-status" onclick="updateStatus('Menunggu Verifikasi')">Verifikasi</button>
                        <button class="btn btn-primary btn-sm btn-status" onclick="updateStatus('Diproses')">Diproses</button>
                        <button class="btn btn-success btn-sm btn-status" onclick="updateStatus('Selesai')">Selesai</button>
                        <button class="btn btn-danger btn-sm btn-status" onclick="updateStatus('Dibatalkan')">Dibatalkan</button>
                        <button class="btn btn-info btn-sm btn-status" id="btnKirimWaNotif" disabled onclick="generateWhatsappMessage()">Kirim Notif WA Selesai</button>
                    </div>

                    <div class="mb-3">
                        <p class="mb-2"><strong>Unggah Bukti Selesai (Admin):</strong></p>
                        <input type="file" class="form-control" id="buktiPengirimanFile" accept="image/*">
                        <button class="btn btn-info btn-sm mt-2" onclick="uploadAdminProof()">Unggah & Simpan Bukti</button>
                        <div id="bukti-pengiriman-container" class="mt-3">
                            ${data.bukti_pengiriman_url ? `<p>Preview:</p><a href="${data.bukti_pengiriman_url}" target="_blank"><img id="bukti-pengiriman-img" src="${data.bukti_pengiriman_url}" alt="Bukti Pengiriman" class="img-fluid img-proof"></a>` : `<p>Belum ada bukti selesai dari admin.</p>`}
                        </div>
                    </div>

                    <div class="mt-4">
                        <p class="mb-2"><strong>Hapus Pesanan:</strong></p>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder()">Hapus Pesanan</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-12 mb-4">
                <div class="card p-4">
                    <h4 class="card-title">Bukti Pembayaran (Pelanggan)</h4>
                    <hr>
                    <div id="bukti-pembayaran-container">
                        ${data.bukti_pembayaran_url ? `<a href="${data.bukti_pembayaran_url}" target="_blank"><img id="bukti-pembayaran-img" src="${data.bukti_pembayaran_url}" alt="Bukti Pembayaran" class="img-fluid img-proof"></a>` : `<p>Belum ada bukti pembayaran diunggah oleh pelanggan.</p>`}
                    </div>
                </div>
            </div>
        `;
        // Panggil fungsi untuk mengaktifkan tombol WA jika kondisi terpenuhi
        checkWhatsappButtonStatus();
    }

    // Fungsi untuk menyimpan detail yang diedit
    async function saveEditedDetails() {
        const editedCustomerName = document.getElementById('editCustomerName').value;
        const customerPhoneInput = document.getElementById('editCustomerPhone').value;
        const editedGameId = document.getElementById('editGameId').value;
        const editedAdminNotes = document.getElementById('editAdminNotes').value;

        const cleanedFormattedPhone = cleanPhoneNumber(customerPhoneInput);

        const updates = {
            // Field standar untuk Firestore (pesananUmum, pesananReseller)
            customer_name: editedCustomerName,
            customer_phone: cleanedFormattedPhone, 
            game_id: editedGameId, 
            catatan_admin: editedAdminNotes
        };

        try {
            if (orderCollectionType !== 'pesananRTDB') { // Firestore (pesananUmum, pesananReseller)
                await currentOrderDocRef.update(updates);
                alert("Detail pesanan berhasil diperbarui di Firestore!");
            } else { // Realtime Database (pesanan)
                // Untuk RTDB, kita mencoba memperbarui field asli yang mungkin berbeda namanya
                // dan juga menambahkan field baru jika tidak ada untuk konsistensi di masa depan
                const rtdbUpdates = {
                    catatan_admin: editedAdminNotes,
                    // Prioritaskan field asli jika ada, kalau tidak pakai field standar
                    nama_pelanggan: currentOrderData.hasOwnProperty('nama_pelanggan') ? editedCustomerName : (currentOrderData.hasOwnProperty('nama') ? editedCustomerName : editedCustomerName),
                    nomor_hp: currentOrderData.hasOwnProperty('nomor_hp') ? cleanedFormattedPhone : (currentOrderData.hasOwnProperty('nomor') ? cleanedFormattedPhone : cleanedFormattedPhone),
                    id_game: currentOrderData.hasOwnProperty('id_game') ? editedGameId : (currentOrderData.hasOwnProperty('id') ? editedGameId : (currentOrderData.hasOwnProperty('username_game') ? editedGameId : editedGameId)),
                    // Tambahkan juga field standar jika belum ada di RTDB untuk konsistensi
                    customer_name: editedCustomerName,
                    customer_phone: cleanedFormattedPhone,
                    game_id: editedGameId
                };
                
                await currentOrderDocRef.update(rtdbUpdates);
                alert("Detail pesanan berhasil diperbarui di Realtime Database!");
            }
            location.reload(); 
        } catch (error) {
            console.error("Error updating details:", error);
            alert("Gagal memperbarui detail. Silakan coba lagi.");
        }
    }

    // Fungsi untuk mengubah status pesanan
    async function updateStatus(newStatus) {
        if (!confirm(`Apakah Anda yakin ingin mengubah status pesanan ini menjadi "${newStatus}"?`)) {
            return;
        }

        const updates = {
            status: newStatus,
            waktu_perubahan_status: (orderCollectionType !== 'pesananRTDB' ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString())
        };

        try {
            if (orderCollectionType !== 'pesananRTDB') { // Firestore
                await currentOrderDocRef.update(updates);
            } else { // Realtime Database
                await currentOrderDocRef.update(updates);
            }
            alert(`Status pesanan berhasil diubah menjadi "${newStatus}"!`);
            location.reload(); 
        } catch (error) {
            console.error("Error updating status:", error);
            alert("Gagal mengubah status. Silakan coba lagi.");
        }
    }

    // Fungsi untuk mengunggah bukti pengiriman dari admin
    async function uploadAdminProof() {
        const fileInput = document.getElementById('buktiPengirimanFile');
        const file = fileInput.files[0];

        if (!file) {
            alert("Pilih file gambar untuk diunggah.");
            return;
        }

        const orderId = currentOrderData.id; 
        const storageRef = storage.ref(`bukti_pengiriman/${orderId}-${Date.now()}-${file.name}`);
        
        try {
            const uploadTask = await storageRef.put(file);
            const downloadURL = await uploadTask.ref.getDownloadURL();

            const updates = {
                bukti_pengiriman_url: downloadURL,
                waktu_pengiriman_bukti: (orderCollectionType !== 'pesananRTDB' ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString())
            };

            if (orderCollectionType !== 'pesananRTDB') { // Firestore
                await currentOrderDocRef.update(updates);
            } else { // Realtime Database
                await currentOrderDocRef.update(updates);
            }

            alert("Bukti pengiriman berhasil diunggah dan disimpan!");
            location.reload(); 
        } catch (error) {
            console.error("Error uploading proof:", error);
            alert("Gagal mengunggah bukti pengiriman. Silakan coba lagi.");
        }
    }

    // Fungsi untuk menghapus pesanan
    async function deleteOrder() {
        if (!confirm("PERINGATAN: Apakah Anda yakin ingin menghapus pesanan ini secara permanen? Aksi ini tidak bisa dibatalkan.")) {
            return;
        }

        try {
            // Jika ada bukti pengiriman yang diunggah admin, coba hapus juga dari storage
            if (currentOrderData.bukti_pengiriman_url) {
                const imageRef = storage.refFromURL(currentOrderData.bukti_pengiriman_url);
                await imageRef.delete().catch(e => console.warn("Could not delete admin proof from storage, might not exist:", e));
            }
            // Jika ada bukti pembayaran dari pelanggan, coba hapus juga dari storage
            if (currentOrderData.bukti_pembayaran_url) {
                const imageRef = storage.refFromURL(currentOrderData.bukti_pembayaran_url);
                await imageRef.delete().catch(e => console.warn("Could not delete customer payment proof from storage, might not exist:", e));
            }

            if (orderCollectionType !== 'pesananRTDB') { // Firestore
                await currentOrderDocRef.delete();
            } else { // Realtime Database
                await currentOrderDocRef.remove();
            }
            alert("Pesanan berhasil dihapus.");
            window.location.href = 'admin.html';
        } catch (error) {
            console.error("Error deleting order:", error);
            alert("Gagal menghapus pesanan. Silakan coba lagi.");
        }
    }

    // Fungsi untuk membuat dan membuka pesan WhatsApp
    function generateWhatsappMessage() {
        // Ambil data terbaru dari DOM yang sudah diedit
        const namaPelanggan = document.getElementById('editCustomerName').value || 'Pelanggan';
        const customerPhone = cleanPhoneNumber(document.getElementById('editCustomerPhone').value);
        
        if (!customerPhone || customerPhone === '62') {
            alert("Nomor HP pelanggan belum valid. Mohon isi atau perbaiki terlebih dahulu.");
            return;
        }

        const buktiPengirimanUrl = currentOrderData.bukti_pengiriman_url;
        if (!buktiPengirimanUrl) {
            alert("Bukti selesai dari admin belum diunggah. Silakan unggah terlebih dahulu.");
            return;
        }

        const orderId = currentOrderData.id;
        const productName = currentOrderData.produk || currentOrderData.product_name || 'Produk';
        const orderStatus = currentOrderData.status || 'Selesai';

        // Tentukan nama koleksi yang tepat untuk link status
        let statusCollectionForLink = orderCollectionType;
        if (orderCollectionType === 'pesananUmum' || orderCollectionType === 'pesananReseller') {
             // Biarkan saja nama koleksinya karena sudah benar
        } else if (orderCollectionType === 'pesananRTDB') {
             statusCollectionForLink = 'pesananRTDB'; 
        }

        // Link ke halaman status pesanan (asumsi ada halaman status.html)
        const statusLink = `${window.location.origin}/status.html?id=${orderId}&collection=${statusCollectionForLink}`;
        
        const message = `Halo ${namaPelanggan},
Pesananmu dengan ID *${orderId}* sudah *${orderStatus}*!

Detail Pesanan:
- Produk: *${productName}*
- Status: *${orderStatus}*

Silakan cek bukti pengiriman/proses di sini:
${buktiPengirimanUrl}

Atau pantau status pesananmu melalui link ini:
${statusLink}

Terima kasih atas pesanannya! ðŸ˜Š`;
        
        const whatsappUrl = `https://wa.me/${customerPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    // Fungsi untuk mengaktifkan/menonaktifkan tombol "Kirim Notif WA Selesai"
    function checkWhatsappButtonStatus() {
        const btnKirimWaNotif = document.getElementById('btnKirimWaNotif');
        // Ambil nomor telepon dari input field, bukan hanya dari currentOrderData
        const currentPhoneValue = document.getElementById('editCustomerPhone').value;
        const customerPhone = cleanPhoneNumber(currentPhoneValue);
        
        // Bukti pengiriman masih dari currentOrderData, karena update bukti akan reload halaman
        const buktiPengirimanUrl = currentOrderData.bukti_pengiriman_url; 

        if (customerPhone && customerPhone.length > 2 && buktiPengirimanUrl) { // Minimal 62 + 1 digit
            btnKirimWaNotif.disabled = false;
        } else {
            btnKirimWaNotif.disabled = true;
        }
    }

    // Fungsi untuk mengubah status WA aktif
    async function toggleWaActive(buttonElement) {
        const currentStatus = buttonElement.dataset.currentStatus === 'true';
        const newStatus = !currentStatus;

        const updates = {
            wa_aktif: newStatus
        };

        try {
            if (orderCollectionType !== 'pesananRTDB') { // Firestore
                await currentOrderDocRef.update(updates);
            } else { // Realtime Database
                await currentOrderDocRef.update(updates);
            }
            
            alert(`Status WA Aktif berhasil diubah menjadi ${newStatus ? 'Aktif' : 'Belum Aktif'}.`);
            location.reload(); 
        } catch (error) {
            console.error("Error updating WA active status:", error);
            alert("Gagal mengubah status WA Aktif. Silakan coba lagi.");
        }
    }

    document.addEventListener('DOMContentLoaded', loadOrderDetails);
</script>

</body>
</html>
