<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Pesanan</title>
    <link rel="icon" href="favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f9f9f9; --text: #2c3e50; --primary: #3498db; --card: #ffffff; --border: #ddd; --shadow: rgba(0, 0, 0, 0.05); --success: #28a745; --danger: #e74c3c; --info: #17a2b8; }
        [data-theme="dark"] { --bg: #1a1a2e; --text: #e0e0e0; --primary: #1abc9c; --card: #2c2c40; --border: #444; --shadow: rgba(0, 0, 0, 0.15); }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); }
        .container { margin-top: 30px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); }
        .list-group-item { background: transparent; border-color: var(--border); color: var(--text); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .status-menunggu-verifikasi { background-color: #ffc107; color: black; }
        .status-diproses { background-color: #3498db; color: white; }
        .status-selesai { background-color: #28a745; color: white; }
        .status-dibatalkan, .status-ditolak, .status-gagal { background-color: #e74c3c; color: white; }
        .status-notifikasi-terkirim-dan-diproses { background-color: #007bff; color: white; }
        .img-proof { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body data-theme="dark">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Kelola Pesanan</h2>
        <a href="admin.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Kembali</a>
    </div>
    <div class="row" id="order-details-row">
        <div class="col-md-12 text-center" id="loading-message"><div class="spinner-border"></div><p>Memuat detail pesanan...</p></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_L6U3HKM1DnKuq_Q1zKFH4bk8GMAz210", // Ganti dengan API Key Firebase Anda
      authDomain: "asdarstoredigitalll-d89c4.firebaseapp.com",
      databaseURL: "https://asdarstoredigitalll-d89c4-default-rtdb.firebaseio.com",
      projectId: "asdarstoredigitalll-d89c4",
    };
    firebase.initializeApp(firebaseConfig);
    const dbFS = firebase.firestore();

    // === PENGATURAN CLOUDINARY ===
    const CLOUDINARY_CLOUD_NAME = "duki2bxqr"; // Ganti dengan Cloud Name Anda
    const CLOUDINARY_UPLOAD_PRESET = "hyvcqshq"; // Ganti dengan Upload Preset Anda
    
    const NAMA_KOLOM_WHATSAPP = 'no_whatsap_aktif'; // Sesuai dengan nama field di Firestore Anda
    const orderDetailsRow = document.getElementById('order-details-row');
    const loadingMessage = document.getElementById('loading-message');
    let currentOrderDoc; // Untuk menyimpan referensi dan data pesanan yang sedang dilihat

    const formatRupiah = (angka) => `Rp${(angka || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")}`;

    // === FUNGSI UNTUK UPLOAD KE CLOUDINARY ===
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData,
            });
            const data = await response.json();
            if (data.secure_url) {
                return data.secure_url;
            } else {
                throw new Error(data.error.message || "Error tidak diketahui dari Cloudinary");
            }
        } catch (error) {
            throw new Error("Gagal terhubung ke server Cloudinary. " + error.message);
        }
    }

    async function loadOrderDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        if (!orderId) { 
            loadingMessage.innerHTML = '<h2>ID Pesanan tidak ditemukan di URL.</h2>'; 
            return; 
        }

        try {
            // Mencoba di koleksi pesananUmum terlebih dahulu
            let docRef = dbFS.collection('pesananUmum').doc(orderId);
            let doc = await docRef.get();
            let orderType = 'umum';

            // Jika tidak ditemukan di pesananUmum, coba di pesananReseller
            if (!doc.exists) {
                docRef = dbFS.collection('pesananReseller').doc(orderId);
                doc = await docRef.get();
                orderType = 'reseller';
            }
            
            // Jika tetap tidak ditemukan
            if (!doc.exists) { 
                loadingMessage.innerHTML = '<h2>Pesanan tidak ditemukan di database.</h2>'; 
                return; 
            }

            // Simpan data mentah dari Firestore di currentOrderDoc.data agar selalu up-to-date
            currentOrderDoc = { ref: docRef, data: doc.data(), id: doc.id, type: orderType }; 
            loadingMessage.style.display = 'none';
            renderOrderDetails(doc.id, doc.data());

            // Tambahkan listener untuk perubahan realtime pada dokumen pesanan
            docRef.onSnapshot((docSnapshot) => {
                if (docSnapshot.exists) {
                    currentOrderDoc.data = docSnapshot.data(); // Perbarui data secara realtime
                    renderOrderDetails(docSnapshot.id, docSnapshot.data()); // Render ulang tampilan
                } else {
                    // Jika dokumen tidak ada lagi (mungkin dihapus), tampilkan pesan
                    orderDetailsRow.innerHTML = '<div class="col-md-12 text-center"><h2>Pesanan ini telah dihapus.</h2></div>';
                }
            });

        } catch (error) {
            console.error("Error loading order details:", error);
            loadingMessage.innerHTML = `<h2>Terjadi kesalahan saat memuat data.</h2><p>Error: ${error.message}</p>`;
        }
    }

    function renderOrderDetails(orderId, data) {
        let statusClass = `status-${(data.status || '').toLowerCase().replace(/ /g, '-')}`;
        const isResellerOrder = currentOrderDoc.type === 'reseller';
        const customerName = isResellerOrder ? (data.nama_reseller || data.email_reseller || data.nama_pelanggan || 'N/A') : (data.nama_pelanggan || 'N/A');
        const customerInfo = isResellerOrder ? `<strong>Reseller:</strong> ${customerName}<br><strong>Pelanggan:</strong> ${data.nama_pelanggan || 'N/A'}` : `<strong>Pelanggan:</strong> ${customerName}`;
        
        const price = formatRupiah(data.harga_final || data.harga_beli || 0);
        
        let targetId = data.nomor_pelanggan || data.id_game || data.target || 'N/A';
        let contactWhatsapp = data[NAMA_KOLOM_WHATSAPP] || data.no_whatsapp || data.whatsapp_aktif || data.nomor_hp || 'N/A'; 

        // Tentukan metode pembayaran
        let paymentMethod;
        if (isResellerOrder) {
            paymentMethod = 'Saldo';
        } else {
            paymentMethod = data.metode_pembayaran || 'N/A';
        }

        // Hitung profit reseller (harga_final - harga_beli)
        const profitReseller = (data.harga_final || 0) - (data.harga_beli || 0);

        orderDetailsRow.innerHTML = `
            <div class="col-md-8 mb-4">
                <div class="card p-4 h-100">
                    <h4 class="card-title">Detail Pesanan</h4><hr>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>ID Pesanan:</strong> <code>${orderId}</code></li>
                        <li class="list-group-item">${customerInfo}</li>
                        <li class="list-group-item"><strong>Target / ID Game:</strong> ${targetId}</li>
                        <li class="list-group-item"><strong>No WhatsApp Aktif:</strong> ${contactWhatsapp}</li>
                        <li class="list-group-item"><strong>Produk:</strong> ${data.produk || 'N/A'}</li>
                        
                        <li class="list-group-item"><strong>Harga:</strong> ${price}</li>
                        <li class="list-group-item"><strong>Status:</strong> <span class="status-badge ${statusClass}">${data.status || 'N/A'}</span></li>
                        <li class="list-group-item"><strong>Waktu Pesanan:</strong> ${data.waktu ? new Date(data.waktu.toDate()).toLocaleString('id-ID') : 'N/A'}</li>
                        <li class="list-group-item"><strong>Metode Pembayaran:</strong> ${paymentMethod}</li>
                        
                        ${isResellerOrder ? `
                            <li class="list-group-item"><strong>Harga Beli Reseller:</strong> ${formatRupiah(data.harga_beli || 0)}</li>
                            <li class="list-group-item"><strong>Profit Reseller:</strong> ${formatRupiah(profitReseller)}</li>
                        ` : ''}
                    </ul>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card p-4 h-100">
                    <h4 class="card-title">Aksi Admin</h4><hr>
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning btn-sm" onclick="updateStatus('Menunggu Verifikasi')">Set Menunggu Verifikasi</button>
                        <button class="btn btn-primary btn-sm" onclick="updateStatus('Diproses')">Set Diproses</button>
                        <button class="btn btn-success btn-sm" onclick="updateStatus('Selesai')">Set Selesai</button>
                        <button class="btn btn-danger btn-sm" onclick="updateStatus('Gagal')">Set Gagal</button>
                        <button class="btn btn-danger btn-sm" onclick="updateStatus('Dibatalkan')">Set Dibatalkan</button>
                        <hr>
                        <button class="btn btn-info btn-sm" onclick="sendWhatsAppNotification()"><i class="fab fa-whatsapp"></i> Kirim Notifikasi WA</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card p-4">
                    <h4 class="card-title">Bukti Pembayaran (Pelanggan)</h4><hr>
                    <div id="bukti-pembayaran-container">${data.bukti_pembayaran_url ? `<a href="${data.bukti_pembayaran_url}" target="_blank"><img src="${data.bukti_pembayaran_url}" alt="Bukti Pembayaran" class="img-fluid img-proof"></a>` : `<p>Belum ada bukti.</p>`}</div>
                </div>
            </div>
             <div class="col-md-6 mb-4">
                <div class="card p-4">
                    <h4 class="card-title">Bukti Pengiriman (Admin)</h4><hr>
                     <div class="input-group">
                         <input type="file" class="form-control form-control-sm" id="buktiPengirimanFile" accept="image/*">
                         <button class="btn btn-info btn-sm" onclick="uploadAdminProof(event)">Unggah</button>
                     </div>
                    <div id="bukti-pengiriman-container" class="mt-2">${data.bukti_pengiriman_url ? `<a href="${data.bukti_pengiriman_url}" target="_blank"><img src="${data.bukti_pengiriman_url}" alt="Bukti Pengiriman" class="img-fluid img-proof"></a>` : `<p>Belum ada bukti.</p>`}</div>
                </div>
            </div>`;
    }

    async function updateStatus(newStatus) {
        if (!currentOrderDoc) {
            alert("Data pesanan belum dimuat. Mohon refresh halaman.");
            return;
        }
        if (!confirm(`Yakin ingin mengubah status menjadi "${newStatus}"?`)) return;
        
        const button = event.target; 
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

        try {
            await currentOrderDoc.ref.update({ status: newStatus, waktu_perubahan_status: firebase.firestore.FieldValue.serverTimestamp() });
            alert(`Status berhasil diubah menjadi "${newStatus}"!`);
            // UI akan diperbarui secara otomatis oleh onSnapshot di loadOrderDetails
        } catch (error) {
            console.error("Error updating status:", error);
            alert("Gagal mengubah status: " + error.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // === FUNGSI UPLOAD ADMIN SUDAH DIPERBAIKI MENGGUNAKAN CLOUDINARY ===
    async function uploadAdminProof(event) {
        const fileInput = document.getElementById('buktiPengirimanFile');
        const file = fileInput.files[0];
        if (!file) { alert("Pilih file untuk diunggah."); return; }
        const uploadButton = event.target;
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Unggah...';
        try {
            const downloadURL = await uploadToCloudinary(file); 
            await currentOrderDoc.ref.update({
                bukti_pengiriman_url: downloadURL,
                waktu_pengiriman_bukti: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Bukti pengiriman berhasil diunggah!");
            // UI akan diperbarui secara otomatis oleh onSnapshot di loadOrderDetails
        } catch (error) {
            console.error("Error uploading proof:", error);
            alert("Gagal mengunggah bukti: " + error.message);
        } finally {
            uploadButton.disabled = false;
            uploadButton.innerHTML = 'Unggah';
            fileInput.value = '';
        }
    }

    // === FUNGSI UNTUK MENGIRIM NOTIFIKASI WHATSAPP SESUAI STATUS TERKINI ===
    async function sendWhatsAppNotification() {
        if (!currentOrderDoc || !currentOrderDoc.data) {
            alert("Data pesanan belum dimuat. Mohon refresh halaman.");
            return;
        }

        const orderData = currentOrderDoc.data;
        let nomorTujuanWA = orderData[NAMA_KOLOM_WHATSAPP] || orderData.no_whatsapp || orderData.whatsapp_aktif || orderData.nomor_hp;

        if (!nomorTujuanWA || nomorTujuanWA === 'N/A') {
            alert("Nomor WhatsApp aktif pelanggan tidak ditemukan. Tidak dapat mengirim notifikasi.");
            return;
        }

        // Normalisasi nomor WhatsApp: ubah 08x menjadi 628x
        nomorTujuanWA = String(nomorTujuanWA).replace(/[^0-9]/g, ''); 
        if (nomorTujuanWA.startsWith('08')) {
            nomorTujuanWA = '62' + nomorTujuanWA.substring(1);
        } else if (!nomorTujuanWA.startsWith('62')) {
            // Jika tidak diawali 08 atau 62, asumsikan itu adalah nomor lokal yang perlu 62
            nomorTujuanWA = '62' + nomorTujuanWA; 
        }
        
        // Pastikan nomor WhatsApp valid setelah normalisasi
        if (nomorTujuanWA.length < 10) { 
            alert(`Nomor WhatsApp (${orderData[NAMA_KOLOM_WHATSAPP] || orderData.nomor_hp}) tidak valid setelah diformat. Pastikan format nomor benar (misal: 08xxxxxxxxxx).`);
            return;
        }
        
        const customerName = orderData.nama_reseller ? orderData.nama_pelanggan : orderData.nama_pelanggan;
        const target = orderData.target || orderData.id_game || orderData.nomor_pelanggan || 'N/A';
        const service = orderData.service || orderData.produk || 'N/A'; // Tetap gunakan service/produk untuk pesan WA
        const harga = formatRupiah(orderData.harga_final || orderData.harga_beli || 0);
        const currentStatus = orderData.status || 'N/A'; // Ambil status terkini dari data pesanan

        const BASE_STATUS_CHECK_URL = `https://asdarcell.github.io/Asdarstoredigital/status.html?id=`; // Sesuaikan dengan domain Anda
        const linkCekStatus = BASE_STATUS_CHECK_URL + currentOrderDoc.id;

        let pesanWhatsapp = `Halo kak! ${customerName} âœ¨\n\n`;
        pesanWhatsapp += `Pembelian Berhasil!\n`;
        pesanWhatsapp += `Target: ${target}\n`;
        pesanWhatsapp += `Service: ${service}\n`; // Service tetap dipertahankan di pesan WA
        pesanWhatsapp += `Harga: ${harga}\n`;
        pesanWhatsapp += `Status: ${currentStatus}\n\n`; // GUNAKAN STATUS TERKINI
        pesanWhatsapp += `Terimakasih sudah menggunakan layanan di Asdar Store Digital\n\n`;
        pesanWhatsapp += `Silahkan cek status pesanan Anda secara otomatis melalui link berikut:\n`;
        pesanWhatsapp += `${linkCekStatus}`;

        const pesanTerencode = encodeURIComponent(pesanWhatsapp);
        const whatsappLink = `https://wa.me/${nomorTujuanWA}?text=${pesanTerencode}`;

        if (!confirm('Anda akan diarahkan ke WhatsApp untuk mengirim notifikasi. Lanjutkan?')) {
            return;
        }

        const button = event.target;
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

        try {
            window.open(whatsappLink, '_blank');
            alert('Tautan WhatsApp berhasil dibuka.');
        } catch (e) {
            console.error('Gagal membuka tautan WhatsApp:', e);
            alert('Gagal membuka tautan WhatsApp. Pastikan browser Anda mengizinkan pop-up dan aplikasi WhatsApp terinstal. Error: ' + e.message);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    document.addEventListener('DOMContentLoaded', loadOrderDetails);
</script>
</body>
</html>
